<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²¨æ«ƒç®¡ç†ç³»çµ± (v25.0 æ—…è²»èˆ‡UIå®Œç¾ç‰ˆ)</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg && msg.toLowerCase().indexOf("script error") > -1) return false;
            var div = document.createElement("div");
            div.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); color:#333; padding:20px; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;";
            div.innerHTML = `<h2 style="color:#dc2626;font-size:20px;font-weight:bold;margin-bottom:10px">âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h2><p style="color:#666">è«‹æˆªåœ–æ­¤ç•«é¢ï¼šLine ${line}</p><pre style="background:#f3f4f6;padding:15px;margin-top:15px;border:1px solid #ddd;border-radius:8px;font-size:12px;text-align:left;max-width:90%;overflow:auto">${msg}</pre><button onclick="window.location.reload()" style="margin-top:20px;padding:12px 30px;background:#2563eb;color:white;border:none;border-radius:50px;font-weight:bold;box-shadow:0 4px 6px rgba(37,99,235,0.2)">é‡æ–°æ•´ç†</button>`;
            document.body.appendChild(div);
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        body { background-color: #F3F4F6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #1f2937; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        .ios-card { background: #ffffff; border-radius: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid #e5e7eb; transition: transform 0.1s; }
        .ios-card:active { transform: scale(0.995); }
        
        /* è²¡å‹™è¡¨æ ¼æ¨£å¼ */
        .reconcile-table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
        .reconcile-table th { background: #f9fafb; color: #6b7280; font-weight: 600; padding: 10px 6px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .reconcile-table td { padding: 10px 6px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; }
        .reconcile-table tr:hover { background-color: #f9fafb; cursor: pointer; }
        
        /* é‡‘é¡ç‹€æ…‹æ¨£å¼ (V23.0) */
        .amt-paid { color: #111827; font-weight: 800; font-family: monospace; font-size: 13px; } /* ç´”é»‘ç²—é«” */
        .amt-unpaid { background-color: white; color: #dc2626; border: 1px solid #ef4444; border-radius: 4px; padding: 1px 6px; font-weight: 700; font-family: monospace; font-size: 13px; white-space: nowrap; display: inline-block; }

        .tag-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; white-space: nowrap; }
        .input-bg-style { background-color: #f3f4f6; border: 1px solid #d1d5db; color: #111827; transition: all 0.2s; }
        .input-bg-style:focus { background-color: white; border-color: #3b82f6; outline: 2px solid #bfdbfe; }
        .product-grid-cols { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; }
        
        .bell-shake { animation: shake 0.5s ease-in-out infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. éŒ¯èª¤é‚Šç•Œ ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("React Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center"><h1 className="text-xl font-bold text-red-600">âš ï¸ æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤</h1><p className="text-sm text-gray-500 mt-2 mb-4">{this.state.error && this.state.error.toString()}</p><button onClick={()=>window.location.reload()} className="px-6 py-2 bg-blue-600 text-white rounded-full font-bold shadow-lg">é‡æ•´é é¢</button></div>;
                return this.props.children;
            }
        }

        // --- 1. å¸¸æ•¸ ---
        const DOMESTIC_FLAG = 'åœ‹å…§æ¡è³¼';
        const IMPORT_COMPANIES = ['å´‡æ–‡å†·å‡', 'å…«æ–¹ç’°çƒ'];
        const CUSTOMS_BROKERS = ['åŸç¢©', 'å°šé´»', DOMESTIC_FLAG];
        const DEFAULT_ORIGINS = ['å„ç“œå¤š', 'å·´æ‹¿é¦¬', 'ç“œåœ°é¦¬æ‹‰', 'å®éƒ½æ‹‰æ–¯', 'æ³°åœ‹', 'å°å°¼', 'å°åº¦', 'ä¸­åœ‹', 'æ™ºåˆ©', 'æŒªå¨'];
        const PAYMENT_TERMS_DOMESTIC = ['ç¾é‡‘', 'æœˆçµ 30 å¤©', 'æœˆçµ 45 å¤©', 'æœˆçµ 60 å¤©', 'å…¶ä»–'];
        const ADMIN_EMAILS = ["pto2.tw@gmail.com", "bapbts0901@gmail.com", "4onlymerich@gmail.com"];

        const firebaseConfig = {
            apiKey: "AIzaSyDvMBng2Zhbk6sVaZLSuER2KT6qqeoCdnw",
            authDomain: "containersystem-6342f.firebaseapp.com",
            projectId: "containersystem-6342f",
            storageBucket: "containersystem-6342f.firebasestorage.app",
            messagingSenderId: "27658303054",
            appId: "1:27658303054:web:d7a3710054ede268cdf51f"
        };

        let db, auth, storage;
        try {
            if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
        } catch (ex) { console.error("Firebase Init Error:", ex); }

        const { useState, useEffect, useMemo } = React;

        // --- 2. è¼”åŠ©å‡½å¼ (Global Scope) ---
        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0);
            try {
                const parts = dateStr.split('-');
                if (parts.length !== 3) return new Date(0);
                return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])); 
            } catch (e) { return new Date(0); }
        };
        
        const getStatusStyle = (date) => { 
            if (!date) return { bg: 'bg-gray-100', text: 'æœªå®š', color: 'text-gray-400' };
            const today = parseDate(new Date().toISOString().split('T')[0]);
            const arrival = parseDate(date);
            const diff = Math.round((arrival.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
            if (diff < 0) return { text: 'å·²åˆ°æ¸¯', color: 'bg-gray-100 text-gray-500' };
            if (diff === 0) return { text: 'ä»Šæ—¥åˆ°æ¸¯', color: 'bg-red-100 text-red-600 animate-pulse' };
            if (diff === 1) return { text: 'æ˜å¤©åˆ°æ¸¯', color: 'bg-orange-100 text-orange-600' };
            return { text: diff + ' å¤©å¾Œ', color: 'bg-blue-100 text-blue-600' };
        };

        const getCompanyColor = (name) => name === 'å´‡æ–‡å†·å‡' ? 'bg-blue-100 text-blue-700' : name === 'å…«æ–¹ç’°çƒ' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-200 text-gray-700';
        const isDomestic = (data) => data && data.customsBroker === DOMESTIC_FLAG;
        const isForeign = (data) => !isDomestic(data);

        // åˆ—è¡¨éæ¿¾ (å…¨åŸŸ)
        const getFilteredAndSortedList = (shipments, filterFn, currentTab, todayStr, searchTerm) => {
            const t = (searchTerm || '').toLowerCase();
            let filteredBySearch = shipments.filter(s => (
                (s.containerNumber && s.containerNumber.toLowerCase().includes(t)) || 
                (s.supplier || "").toLowerCase().includes(t) || 
                (s.shippingCompany || "").toLowerCase().includes(t) || 
                (s.products || []).some(p => (p.name || "").toLowerCase().includes(t))
            ));
            
            let list = filterFn ? filteredBySearch.filter(filterFn) : filteredBySearch;
            
            if (currentTab === 'DEVANED') {
                list.sort((a, b) => new Date(b.devanningDate || '1970-01-01').getTime() - new Date(a.devanningDate || '1970-01-01').getTime());
            } else {
                list.sort((a, b) => new Date(a.arrivalDate || '1970-01-01').getTime() - new Date(b.arrivalDate || '1970-01-01').getTime());
            }
            return list;
        };

        // --- 3. Icons ---
        const Icons = {
            Ship: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.8 8"/><path d="M10 10 4.72 7.28a1 1 0 0 1 .11-1.79l9-4a1 1 0 0 1 .9 0l8.26 3.67a1 1 0 0 1 .13 1.77L14 10"/><path d="m14 10-4 4-4-3.7"/></svg>,
            Anchor: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Search: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Copy: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            FileCheck: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            Globe: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Factory: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>,
            Paperclip: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Download: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-3-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            LogOut: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Google: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"></path></svg>,
            X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Check: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Bell: () => <svg width="22" height="22" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            MessageCircle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            User: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Barcode: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-full h-full"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Calendar: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Chart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            List: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Grid: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        };

        // 5. Dashboard (Safe Version)
        const Dashboard = ({ shipments, canSeePrice }) => {
            const [tf, setTf] = useState('YEAR');
            const [search, setSearch] = useState('');
            
            // V23.0 é˜²ç™½å±ï¼šç¢ºä¿ window.Recharts å­˜åœ¨ï¼Œå¦å‰‡é¡¯ç¤ºæ›¿ä»£æ–‡å­—
            if (!window.Recharts) return <div className="p-8 text-center text-gray-400">åœ–è¡¨æ¨¡çµ„è¼‰å…¥ä¸­...</div>;
            const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend } = window.Recharts;
            
            const stats = useMemo(() => {
                const now = new Date();
                let filteredList = Array.isArray(shipments) ? shipments.filter(s => s.arrivalDate) : [];

                if (search) {
                    const t = search.toLowerCase();
                    filteredList = filteredList.filter(s => 
                        (s.supplier || '').toLowerCase().includes(t) ||
                        (s.products || []).some(p => p.name.toLowerCase().includes(t))
                    );
                }

                try {
                    if (tf === 'MONTH') {
                        filteredList = filteredList.filter(s => {
                            const d = parseDate(s.arrivalDate);
                            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                        });
                    } else if (tf === 'YEAR') {
                        filteredList = filteredList.filter(s => {
                            const d = parseDate(s.arrivalDate);
                            return d.getFullYear() === now.getFullYear();
                        });
                    }
                } catch (e) { console.warn("Date filter error", e); }

                const count = filteredList.length;
                const items = filteredList.reduce((sum, s) => sum + (Number(s.totalQuantity) || 0), 0);
                const w = filteredList.reduce((sum, s) => sum + (Number(s.totalWeight) || 0), 0);
                
                const moneyUSD = filteredList.reduce((sum, s) => s.currency === 'USD' ? sum + ((s.products||[]).reduce((a, p) => a + (Number(p.amount)||0), 0)) : sum, 0);
                const moneyTWD = filteredList.reduce((sum, s) => s.currency === 'TWD' ? sum + ((s.products||[]).reduce((a, p) => a + (Number(p.amount)||0), 0)) : sum, 0);
                
                const supps = {}; 
                filteredList.forEach(s => { const n = s.supplier || 'æœªå¡«'; supps[n] = (supps[n] || 0) + 1; });
                const top = Object.entries(supps).sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                const chartMap = {};
                filteredList.forEach(s => {
                    if(!s.arrivalDate) return;
                    const d = parseDate(s.arrivalDate);
                    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    if (!chartMap[key]) chartMap[key] = { name: key, TWD: 0, USD: 0 };
                    
                    const amt = (s.products||[]).reduce((a, p) => a + (Number(p.amount)||0), 0);
                    if(s.currency === 'USD') chartMap[key].USD += amt;
                    else chartMap[key].TWD += amt;
                });
                
                const chartData = Object.values(chartMap).sort((a,b) => a.name.localeCompare(b.name)).slice(-6);
                const maxVal = (top.length > 0 && top[0][1] > 0) ? top[0][1] : 1;

                return { count, items, w, moneyUSD, moneyTWD, top, chartData, maxVal };
            }, [shipments, tf, search]);
            
            return (
                <div className="space-y-6 animate-[fade-in_0.3s_ease-out] pb-20">
                     <div className="flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">çµ±è¨ˆå„€è¡¨æ¿</h2>
                            <div className="flex bg-white rounded-lg p-1 border shadow-sm">{['MONTH','YEAR','ALL'].map(k=><button key={k} onClick={()=>setTf(k)} className={'px-3 py-1 text-xs font-bold rounded-md transition-colors ' + (tf===k?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-50')}>{k==='MONTH'?'æœ¬æœˆ':k==='YEAR'?'æœ¬å¹´':'å…¨éƒ¨'}</button>)}</div>
                        </div>
                        <input placeholder="æœå°‹ç”¢å“ã€å» å•†..." value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-white text-gray-900 rounded-xl py-2 px-4 outline-none shadow-sm text-sm border border-gray-100" />
                     </div>
                     
                     <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½ç­†æ•¸</div><div className="text-2xl font-black text-gray-800">{stats.count}</div></div>
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½ä»¶æ•¸</div><div className="text-2xl font-black text-blue-600">{stats.items.toLocaleString()}</div></div>
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm col-span-2"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½é‡é‡ (kg)</div><div className="text-2xl font-black text-orange-500">{parseInt(stats.w).toLocaleString()}</div></div>
                        {canSeePrice() && (
                            <>
                                <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¾é‡‘ç¸½é¡ (USD)</div><div className="text-xl font-black text-emerald-600">${stats.moneyUSD.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div></div>
                                <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">å°å¹£ç¸½é¡ (TWD)</div><div className="text-xl font-black text-emerald-600">${stats.moneyTWD.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div></div>
                            </>
                        )}
                     </div>

                     {canSeePrice() && (
                     <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <h3 className="text-sm font-bold text-gray-800 mb-4">ğŸ“ˆ æœˆåº¦æ¡è³¼é‡‘é¡è¶¨å‹¢</h3>
                        <div className="h-64 w-full">
                             <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={stats.chartData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" tick={{fontSize: 10}} />
                                    <YAxis yAxisId="left" orientation="left" stroke="#10B981" tick={{fontSize: 10}} tickFormatter={(val)=>`$${val/1000}k`} />
                                    <YAxis yAxisId="right" orientation="right" stroke="#3B82F6" tick={{fontSize: 10}} tickFormatter={(val)=>`$${val/1000}k`} />
                                    <Tooltip />
                                    <Legend />
                                    <Bar yAxisId="left" dataKey="USD" name="ç¾é‡‘" fill="#10B981" radius={[4, 4, 0, 0]} />
                                    <Bar yAxisId="right" dataKey="TWD" name="å°å¹£" fill="#3B82F6" radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                     </div>
                     )}

                     <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">ğŸ† å‰äº”å¤§å» å•†</h3><div className="space-y-3">{stats.top.map(([n,c],i)=><div key={n} className="flex items-center gap-3"><div className="w-6 text-xs font-bold text-gray-400">#{i+1}</div><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-gray-700">{n}</span><span className="text-gray-500">{c} ç­†</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width:`${(c/stats.maxVal)*100}%`}}></div></div></div></div>)}</div></div>
                </div>
            );
        };

        // 6. ä¸»ç¨‹å¼
        function ContainerApp() {
            const [user, setUser] = useState(null);
            const [shipments, setShipments] = useState([]);
            const [view, setView] = useState('list'); 
            const [displayMode, setDisplayMode] = useState('card');
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            const [currentTab, setCurrentTab] = useState('NOT_DEVANED'); 
            const [userRole, setUserRole] = useState('GUEST');

            useEffect(() => {
                if (!auth) { setLoading(false); return; }
                const authUnsub = auth.onAuthStateChanged((u) => { setUser(u); if (!u) setLoading(false); });
                return () => authUnsub();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                
                const unsubscribeDB = db.collection('shipments').onSnapshot(
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        data.sort((a, b) => {
                            const dateA = a.arrivalDate ? new Date(a.arrivalDate).getTime() : 0;
                            const dateB = b.arrivalDate ? new Date(b.arrivalDate).getTime() : 0;
                            return dateB - dateA;
                        });
                        setShipments(data);
                        setLoading(false);
                    },
                    (error) => { console.error(error); setLoading(false); }
                );

                const unsubscribeSettings = db.collection('settings').doc('config').onSnapshot(
                    (doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            if (data.user_roles && user && user.email) {
                                setUserRole(data.user_roles[user.email]);
                            } else if (data.admin_emails && user && data.admin_emails.includes(user.email)) {
                                setUserRole('MANAGER');
                            } else {
                                setUserRole('GUEST');
                            }
                        } else {
                             if (user && ADMIN_EMAILS.includes(user.email)) {
                                 setUserRole('MANAGER');
                             } else {
                                 setUserRole('GUEST');
                             }
                        }
                    },
                    (error) => console.log("Settings fetch error:", error)
                );

                return () => { unsubscribeDB(); unsubscribeSettings(); };
            }, [user]);

            const handleAdminLogin = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (error) { alert("ç™»å…¥å¤±æ•—: " + error.message); } };
            const handleGuestLogin = async () => { try { await auth.signInAnonymously(); } catch (error) { alert("è¨ªå®¢ç™»å…¥å¤±æ•—"); } };
            const handleLogout = () => auth.signOut();

            // æ¬Šé™å®šç¾©
            const canManage = () => userRole === 'MANAGER'; 
            const canEdit = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole); 
            const canCreate = () => ['MANAGER', 'PURCHASING'].includes(userRole); 
            const canDelete = () => ['MANAGER', 'PURCHASING'].includes(userRole); 
            const canUpload = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole); 
            const canSeePrice = () => ['MANAGER', 'PURCHASING', 'ACCOUNTING'].includes(userRole); 
            const canEditFlightFee = () => userRole === 'MANAGER' || userRole === 'ACCOUNTING';
            const canEditDomesticFull = () => ['MANAGER', 'PURCHASING'].includes(userRole);
            const canEditForeignFinance = () => ['MANAGER', 'ACCOUNTING'].includes(userRole);
            const canEditWarehouseFields = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole);
            const isWarehouse = () => userRole === 'WAREHOUSE';

            const initialFormState = { 
                importCompany: IMPORT_COMPANIES[0], 
                customsBroker: CUSTOMS_BROKERS[0], 
                origin: '', 
                supplier: '', 
                arrivalDate: new Date().toISOString().split('T')[0], 
                containerNumber: '', 
                shippingCompany: '', 
                products: [{ id: Date.now(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'quantity' }], 
                totalQuantity: 0, 
                totalWeight: 0, 
                docUrl: '', 
                docName: '', 
                docRefPath: '', 
                devanningLocation: '', 
                devanningDate: '', 
                warehouseConfirmed: false,
                attachments: [],
                isPaid: false,
                currency: 'USD',
                paymentTerm: 'åˆ°æ¸¯å‰ä»˜æ¬¾',
                prepayment: 0,
                flightFee: 0,         
                flightFeePaid: false 
            };
            const [formData, setFormData] = useState(initialFormState);

            const handleInputChange = (evt) => { 
                const target = evt.target;
                const name = target.name;
                const value = target.value;
                const type = target.type;
                const checked = target.checked;
                const val = type === 'checkbox' ? checked : value;
                
                setFormData(prev => {
                    const newData = { ...prev, [name]: name === 'containerNumber' ? val.toUpperCase() : val };
                    
                    if (name === 'customsBroker') {
                        if (val === DOMESTIC_FLAG) {
                            newData.currency = 'TWD';
                            newData.paymentTerm = PAYMENT_TERMS_DOMESTIC[0];
                            newData.prepayment = 0;
                        } else {
                            newData.currency = 'USD';
                            newData.paymentTerm = 'åˆ°æ¸¯å‰ä»˜æ¬¾';
                        }
                    }
                    return newData;
                }); 
            };

            const handleProductChange = (idx, field, value) => { 
                const np = [...formData.products]; 
                np[idx] = { ...np[idx], [field]: value }; 
                
                const p = np[idx];
                const q = parseFloat(p.quantity) || 0;
                const b = parseFloat(p.boxCapacity) || 1;
                const w = parseFloat(p.weight) || 0;
                const u = parseFloat(p.unitPrice) || 0;
                
                if (p.pricingMode === 'weight') {
                    p.amount = Math.round(w * u); 
                } else {
                    p.amount = Math.round(q * b * u); 
                }

                setFormData(prev => ({ 
                    ...prev, 
                    products: np, 
                    totalQuantity: np.reduce((s, i) => s + (Number(i.quantity)||0), 0),
                    totalWeight: np.reduce((s, i) => s + (Number(i.weight)||0), 0)
                })); 
            };

            const addProductRow = () => setFormData(prev => ({ ...prev, products: [...prev.products, { id: Date.now() + Math.random(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'quantity' }] }));
            const duplicateProductRow = (idx) => { const p = formData.products[idx]; const np = [...formData.products]; np.splice(idx + 1, 0, { ...p, id: Date.now() + Math.random() }); setFormData(prev => ({ ...prev, products: np, totalQuantity: np.reduce((s, i) => s + Number(i.quantity||0), 0), totalWeight: np.reduce((s, i) => s + Number(i.weight||0), 0) })); };
            const removeProductRow = (idx) => { const np = formData.products.filter((_, i) => i !== idx); setFormData(prev => ({ ...prev, products: np, totalQuantity: np.reduce((s, i) => s + Number(i.quantity||0), 0), totalWeight: np.reduce((s, i) => s + Number(i.weight||0), 0) })); };

            const handleFileUpload = async (evt) => {
                const file = evt.target.files[0]; if (!file) return; setUploading(true);
                if (!canUpload()) return alert("æ¬Šé™ä¸è¶³");
                try { 
                    const ref = storage.ref('docs/' + Date.now() + '_' + file.name); 
                    await ref.put(file); 
                    const url = await ref.getDownloadURL(); 
                    const newFile = { name: file.name, url: url, path: ref.fullPath };
                    setFormData(prev => ({ ...prev, attachments: [...(prev.attachments||[]), newFile] }));
                } catch (error) { alert("ä¸Šå‚³å¤±æ•—: " + error.message); } finally { setUploading(false); }
            };
            
            const handleDeleteFile = async (index) => { 
                if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é™„ä»¶å—ï¼Ÿ")) return;
                if (!canUpload()) return alert("æ¬Šé™ä¸è¶³");
                const target = formData.attachments[index];
                if (target.path && storage) {
                    try { await storage.ref(target.path).delete(); } catch (error) { console.warn(error); }
                }
                const newAttachments = formData.attachments.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, attachments: newAttachments }));
            };

            const handleSubmit = async (evt) => {
                evt.preventDefault();
                if (!canEdit()) return alert("æ¬Šé™ä¸è¶³");
                if (formData.customsBroker !== DOMESTIC_FLAG && !formData.containerNumber) return alert('è«‹è¼¸å…¥æ«ƒè™Ÿ');
                
                const currentData = editingId ? shipments.find(s => s.id === editingId) : {};
                
                let finalData = { ...formData };
                if (userRole === 'PURCHASING' && !isDomestic(formData) && !canManage()) {
                    const fieldsToKeepOld = ['products', 'totalQuantity', 'totalWeight', 'currency', 'paymentTerm', 'prepayment', 'isPaid', 'shippingCompany', 'importCompany', 'customsBroker', 'origin', 'supplier', 'containerNumber', 'arrivalDate'];
                    fieldsToKeepOld.forEach(field => {
                        finalData[field] = currentData[field] !== undefined ? currentData[field] : finalData[field];
                    });
                } else if (userRole === 'WAREHOUSE' && !canManage()) {
                    const fieldsToKeepOld = ['importCompany', 'customsBroker', 'origin', 'supplier', 'shippingCompany', 'containerNumber', 'arrivalDate', 'currency', 'paymentTerm', 'prepayment', 'isPaid'];
                     fieldsToKeepOld.forEach(field => {
                        finalData[field] = currentData[field] !== undefined ? currentData[field] : finalData[field];
                    });
                }
                
                const mergedData = { ...currentData, ...finalData, updatedAt: new Date().toISOString() };
                
                setIsSubmitting(true);
                try {
                    if (editingId) await db.collection('shipments').doc(editingId).update(mergedData);
                    else await db.collection('shipments').add({ ...mergedData, createdAt: new Date().toISOString() });
                    setFormData(initialFormState); setEditingId(null); setView('list'); window.scrollTo(0,0);
                } catch (error) { alert("éŒ¯èª¤ï¼š" + error.message); } finally { setIsSubmitting(false); }
            };
            
            const handleEdit = (item) => {
                if(!canEdit() && !canUpload()) return alert("æ¬Šé™ä¸è¶³"); 
                let atts = item.attachments || [];
                if (item.docUrl && atts.length === 0) { atts.push({ name: item.docName || 'é™„ä»¶', url: item.docUrl, path: item.docRefPath }); }
                
                setFormData({ 
                    ...initialFormState, 
                    ...item, 
                    attachments: atts,
                    currency: item.currency || (item.customsBroker === DOMESTIC_FLAG ? 'TWD' : 'USD'),
                    paymentTerm: item.paymentTerm || (item.customsBroker === DOMESTIC_FLAG ? PAYMENT_TERMS_DOMESTIC[0] : 'åˆ°æ¸¯å‰ä»˜æ¬¾'),
                    prepayment: item.prepayment || 0,
                    flightFee: item.flightFee || 0,
                    flightFeePaid: item.flightFeePaid || false
                }); 
                setEditingId(item.id);
                setView('form'); 
                window.scrollTo(0,0);
            };

            const handleDuplicateShipment = (s) => { 
                if(!canCreate()) return alert("æ¬Šé™ä¸è¶³");
                const {id, ...d} = s; 
                const merged = { ...initialFormState, ...d };
                const np = (merged.products || []).map(p=>({...p,id:Date.now()+Math.random()})); 
                setFormData({...merged, containerNumber:'', products:np, attachments:[], isPaid: false, prepayment: 0, flightFee: 0, flightFeePaid: false}); 
                setEditingId(null); setView('form'); window.scrollTo(0,0); 
            };

            const handleDelete = async (id) => { 
                if(!canDelete() || !confirm('ç¢ºå®šåˆªé™¤æ­¤è²¨æ«ƒè³‡æ–™ï¼Ÿ')) return; 
                await db.collection('shipments').doc(id).delete(); 
            };

            const handleExport = () => { 
                if (userRole === 'GUEST') return alert("æ¬Šé™ä¸è¶³"); 
                const showPrice = canSeePrice();
                let header = "é€²å£å…¬å¸,å ±é—œè¡Œ,æ«ƒè™Ÿ,åˆ°æ¸¯æ—¥,ç”¢åœ°,å» å•†,èˆ¹å…¬å¸,å“å,æ‰¹è™Ÿ,æ•ˆæœŸ,è¦æ ¼,ç®±å®¹,æ•¸é‡,é‡é‡,è¨ˆåƒ¹æ¨¡å¼,ç¸½æ•¸,æ–‡ä»¶,æ‹†æ«ƒåœ°é»,æ‹†æ«ƒæ—¥æœŸ,æ˜¯å¦åŒ¯æ¬¾,å¹£åˆ¥,ä»˜æ¬¾æ¢ä»¶,é ä»˜æ¬¾,æ—…è²»,æ—…è²»å·²ä»˜"; // V23.0 ä¿®æ”¹æ¨™é¡Œ
                if (showPrice) header += ",å–®åƒ¹,é‡‘é¡";
                header += "\n";

                const rows = filteredShipments.flatMap(s => (s.products || []).map(p => {
                    let row = [s.importCompany,s.customsBroker,s.containerNumber,s.arrivalDate,s.origin,s.supplier,s.shippingCompany,p.name,p.batchNumber,p.expiryDate,p.spec,p.boxCapacity || 1,p.quantity,p.weight || 0, p.pricingMode === 'weight' ? 'é‡é‡' : 'æ•¸é‡', s.totalQuantity,(s.attachments||[]).map(a=>a.url).join('; '),s.devanningLocation,s.devanningDate, s.isPaid ? 'å·²åŒ¯æ¬¾' : 'æœªåŒ¯æ¬¾', s.currency || 'USD', s.paymentTerm || '', s.prepayment || 0, s.flightFee || 0, s.flightFeePaid ? 'å·²ä»˜' : 'æœªä»˜']; // V23.0
                    if (showPrice) row.push(p.unitPrice || 0, p.amount || 0);
                    return row.map(f => '"' + String(f||'').replace(/"/g,'""') + '"').join(",");
                })).join("\n");
                
                const link = document.createElement("a"); 
                link.href=URL.createObjectURL(new Blob(["\uFEFF"+header+rows], {type:"text/csv;charset=utf-8;"})); 
                link.download='è²¨æ«ƒ_' + new Date().toISOString().slice(0,10) + '.csv'; 
                link.click(); 
            };
            
            const handleShareToLine = (s) => {
                const isDomestic = s.customsBroker === DOMESTIC_FLAG;
                const quantityUnit = ' ä»¶'; 

                const productDetails = (s.products || []).map((p, i) => 
                    (i+1) + ". " + p.name + (p.spec ? " " + p.spec : "") + " - " + p.quantity.toLocaleString() + quantityUnit + (p.weight ? " / " + p.weight + "kg" : "") + (p.batchNumber ? " [æ‰¹:" + p.batchNumber + "]" : "")
                ).join('\n');
                
                const locationInfo = s.devanningLocation ? ("\nğŸ“ " + (isDomestic ? 'äº¤è²¨åœ°' : 'æ‹†æ«ƒåœ°') + "ï¼š" + s.devanningLocation) : '';
                const devanningDateInfo = (!isDomestic && s.devanningDate) ? ("\nğŸ•’ æ‹†æ«ƒæ—¥ï¼š" + s.devanningDate) : '';
                const totalWeightInfo = s.totalWeight ? (" / " + s.totalWeight.toLocaleString() + " kg") : '';

                let text = '';
                if (isDomestic) {
                    text = "ğŸšš åˆ°è²¨é€šçŸ¥(åœ‹å…§æ¡è³¼)\nğŸ“… æ—¥æœŸï¼š" + s.arrivalDate + "\nğŸ¢ å…¬å¸ï¼š" + s.importCompany + "\nğŸ­ å» å•†ï¼š" + (s.supplier || 'æœªå¡«') + "\nğŸŒ ç”¢åœ°ï¼š" + (s.origin || 'æœªå¡«') + locationInfo + "\n\nğŸ“‹ æ˜ç´°ï¼š\n" + productDetails + "\n\nğŸ”¢ ç¸½æ•¸ï¼š" + s.totalQuantity.toLocaleString() + quantityUnit + totalWeightInfo;
                } else {
                    text = "ğŸš¢ åˆ°æ¸¯é€šçŸ¥\nğŸ“¦ æ«ƒè™Ÿï¼š" + s.containerNumber + "\nğŸ“… æ—¥æœŸï¼š" + s.arrivalDate + "\nğŸ¢ å…¬å¸ï¼š" + s.importCompany + "\nğŸ­ å» å•†ï¼š" + (s.supplier || 'æœªå¡«') + "\nğŸŒ ç”¢åœ°ï¼š" + (s.origin || 'æœªå¡«') + locationInfo + devanningDateInfo + "\n\nğŸ“‹ æ˜ç´°ï¼š\n" + productDetails + "\n\nğŸ”¢ ç¸½æ•¸ï¼š" + s.totalQuantity.toLocaleString() + quantityUnit + totalWeightInfo;
                }

                window.open("https://line.me/R/msg/text/?" + encodeURIComponent(text), '_blank');
            };

            const handleWarehouseConfirm = async (evt, item) => {
                evt.stopPropagation(); 
                if (!canEditWarehouseFields()) return alert("æ¬Šé™ä¸è¶³"); 
                try {
                    await db.collection('shipments').doc(item.id).update({ warehouseConfirmed: !item.warehouseConfirmed });
                } catch (error) { alert("æ›´æ–°ç‹€æ…‹å¤±æ•—"); }
            };

            const urgentShipments = useMemo(() => { 
                const todayStr = new Date().toISOString().split('T')[0];
                const today = parseDate(todayStr);
                return shipments.filter(s => { 
                    if (!s.arrivalDate) return false;
                    const arrival = parseDate(s.arrivalDate);
                    const diffDays = Math.round((arrival.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                    return diffDays >= 0 && diffDays <= 3;
                }); 
            }, [shipments]);
            
            const urgentCount = urgentShipments.length;

            // V23.0 ä¿®æ­£: å®‰å…¨çš„åˆ—è¡¨éæ¿¾å’Œæ’åºé‚è¼¯ (æå‡åˆ°å¤–éƒ¨)
            const getFilteredAndSortedList = (shipments, filterFn, currentTab, todayStr, searchTerm) => {
                const t = (searchTerm || '').toLowerCase();
                let filteredBySearch = shipments.filter(s => (
                    (s.containerNumber && s.containerNumber.toLowerCase().includes(t)) || 
                    (s.supplier || "").toLowerCase().includes(t) || 
                    (s.shippingCompany || "").toLowerCase().includes(t) || 
                    (s.origin || "").toLowerCase().includes(t) || 
                    (s.devanningLocation || "").toLowerCase().includes(t) || 
                    (s.products || []).some(p => (p.name || "").toLowerCase().includes(t) || (p.spec || "").toLowerCase().includes(t) || (p.batchNumber || "").toLowerCase().includes(t))
                ));
                
                let list = filterFn ? filteredBySearch.filter(filterFn) : filteredBySearch;
                
                // æ’åºé‚è¼¯
                if (currentTab === 'DEVANED') {
                    list.sort((a, b) => new Date(b.devanningDate || '1970-01-01').getTime() - new Date(a.devanningDate || '1970-01-01').getTime());
                } else {
                    list.sort((a, b) => new Date(a.arrivalDate || '1970-01-01').getTime() - new Date(b.arrivalDate || '1970-01-01').getTime());
                }
                return list;
            };
            
            // ç¢ºä¿ filteredShipments å§‹çµ‚å­˜åœ¨ï¼Œé¿å… undefined éŒ¯èª¤
            const filteredShipments = useMemo(() => {
                const t = searchTerm.toLowerCase(); 
                return shipments.filter(s => (
                    (s.containerNumber && s.containerNumber.toLowerCase().includes(t)) || 
                    (s.importCompany || "").toLowerCase().includes(t) || 
                    (s.supplier || "").toLowerCase().includes(t) || 
                    (s.shippingCompany || "").toLowerCase().includes(t) || 
                    (s.origin || "").toLowerCase().includes(t) || 
                    (s.devanningLocation || "").toLowerCase().includes(t) || 
                    (s.products || []).some(p => 
                        (p.name || "").toLowerCase().includes(t) || 
                        (p.spec || "").toLowerCase().includes(t) ||
                        (p.batchNumber || "").toLowerCase().includes(t) 
                    )
                )); 
            }, [shipments, searchTerm]);

            const todayStr = new Date().toISOString().split('T')[0];

            const domesticShipments = useMemo(() => 
                getFilteredAndSortedList(filteredShipments, isDomestic, currentTab, todayStr), 
                [filteredShipments, currentTab, todayStr]
            );

            const notDevannedForeign = useMemo(() => 
                getFilteredAndSortedList(filteredShipments, s => isForeign(s) && (!s.devanningDate || s.devanningDate > todayStr), currentTab, todayStr), 
                [filteredShipments, currentTab, todayStr]
            );

            const devannedForeign = useMemo(() => 
                getFilteredAndSortedList(filteredShipments, s => isForeign(s) && (s.devanningDate && s.devanningDate <= todayStr), currentTab, todayStr), 
                [filteredShipments, currentTab, todayStr]
            );

            const unpaidList = useMemo(() => 
                getFilteredAndSortedList(filteredShipments, s => !s.isPaid, currentTab, todayStr),
                [filteredShipments, currentTab, todayStr]
            );

            const currentList = useMemo(() => {
                if (currentTab === 'UNPAID') return unpaidList;
                if (currentTab === 'DOMESTIC') return domesticShipments;
                if (currentTab === 'DEVANED') return devannedForeign;
                return notDevannedForeign; 
            }, [currentTab, unpaidList, domesticShipments, devannedForeign, notDevannedForeign]);

            const currentTotalTWD = useMemo(() => currentList.filter(s => s.currency === 'TWD').reduce((acc, item) => acc + (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0), 0), [currentList]);
            const currentTotalUSD = useMemo(() => currentList.filter(s => s.currency === 'USD').reduce((acc, item) => acc + (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0), 0), [currentList]);

            const availableOrigins = useMemo(() => Array.from(new Set([...DEFAULT_ORIGINS, ...shipments.map(s => s.origin).filter(Boolean), DOMESTIC_FLAG])).sort(), [shipments]);
            
            // V23.0: æ¥µç°¡è¡¨æ ¼æ¨¡å¼ (8æ¬„ï¼Œæ•´åˆç‹€æ…‹ï¼Œæ—…è²»)
            const renderTableView = () => (
                <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                    <table className="reconcile-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ«ƒè™Ÿ/å–®è™Ÿ</th>
                                <th>å» å•†</th>
                                <th>å“åæ‘˜è¦</th>
                                <th className="text-right">ç¸½æ•¸</th>
                                <th className="text-right">ç¸½é‡</th>
                                {canSeePrice() && <th className="text-right">è²¨æ¬¾é‡‘é¡</th>}
                                {canEditFlightFee() && <th className="text-right">æ—…è²»</th>}
                            </tr>
                        </thead>
                        <tbody>
                            {currentList.map(item => {
                                const totalAmt = (item.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                                const prodSummary = (item.products || []).map(p => p.name).join(', ');
                                const curr = item.currency === 'USD' ? 'US$' : 'NT$';
                                const showFlightFee = isForeign(item) || canManage(); 

                                return (
                                    <tr key={item.id} onClick={() => handleEdit(item)} className="cursor-pointer hover:bg-gray-50">
                                        <td className="whitespace-nowrap">{item.arrivalDate}</td>
                                        <td className="font-bold">{item.containerNumber}</td>
                                        <td className="truncate max-w-[100px]" title={item.supplier}>{item.supplier}</td>
                                        <td className="truncate max-w-[120px]" title={prodSummary}>{prodSummary}</td>
                                        <td className="text-right text-blue-600 font-bold">{(item.totalQuantity||0).toLocaleString()}</td>
                                        <td className="text-right text-orange-500 font-bold">{(item.totalWeight||0).toLocaleString()}</td>
                                        
                                        {/* è²¨æ¬¾é‡‘é¡ + ç‹€æ…‹èåˆ */}
                                        {canSeePrice() && (
                                            <td className="text-right whitespace-nowrap">
                                                <span className={item.isPaid ? "amt-paid" : "amt-unpaid"}>
                                                    {curr} {totalAmt.toLocaleString()}
                                                </span>
                                            </td>
                                        )}
                                        
                                        {/* æ—…è²» + ç‹€æ…‹èåˆ */}
                                        {canEditFlightFee() && (
                                            <td className="text-right whitespace-nowrap">
                                                {showFlightFee ? (
                                                    <span className={item.flightFeePaid ? "amt-paid" : "amt-unpaid"}>
                                                        {(item.flightFee || 0).toLocaleString()}
                                                    </span>
                                                ) : '-'}
                                            </td>
                                        )}
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );

            // V23.0: å¡ç‰‡ç”¢å“ä½ˆå±€å„ªåŒ– (ä¿®æ­£ï¼šåŠ å…¥è¤‡è£½æŒ‰éˆ•)
            const renderShipmentCard = (item) => {
                const isDevanned = item.devanningDate && item.devanningDate <= todayStr;
                const mainDate = item.arrivalDate ? new Date(item.arrivalDate) : null; 
                const mainDateStatus = isDevanned ? { text: 'å·²æ‹†æ«ƒ', color: 'text-green-600', bg: 'bg-green-100' } : getStatusStyle(item.arrivalDate);
                const hasAttachments = (item.attachments && item.attachments.length > 0) || item.docUrl;
                const totalAmount = (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                const currSymbol = item.currency === 'USD' ? 'US$' : 'NT$'
                const paidStyle = item.isPaid ? 'bg-gray-600 text-white' : 'bg-white border border-red-500 text-red-600';
                const flightPaidStyle = item.flightFeePaid ? 'bg-gray-600 text-white' : 'bg-white border border-red-500 text-red-600';

                return (
                    <div key={item.id} className="ios-card" onClick={() => handleEdit(item)}>
                        <div className="p-4 border-b border-gray-50 flex gap-4">
                            <div className={`flex-shrink-0 w-14 flex flex-col items-center justify-center rounded-xl border ${mainDateStatus.bg} h-16`}>
                                <span className="text-[10px] font-bold uppercase text-gray-500">{mainDate && mainDate.toLocaleString('default', { month: 'short' })}</span>
                                <span className="text-xl font-bold text-gray-800 leading-none my-0.5">{mainDate && mainDate.getDate()}</span>
                                <span className={`text-[9px] font-bold ${mainDateStatus.color}`}>{mainDateStatus.text}</span>
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex justify-between items-start mb-1">
                                    <div className="flex-1 min-w-0">
                                        <span className={`inline-block px-2 py-1 rounded text-base font-bold mb-1 ${getCompanyColor(item.importCompany)}`}>{item.importCompany}</span>
                                        
                                        <div className="flex items-center gap-2">
                                            <span className="text-lg font-bold text-gray-900 font-mono tracking-tight whitespace-nowrap">{item.containerNumber}</span>
                                            {item.shippingCompany && (
                                                <span className="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-blue-50 text-blue-600 text-[10px] font-medium whitespace-nowrap">
                                                    <div className="w-3 h-3"><Icons.Anchor /></div>{item.shippingCompany}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex gap-3 ml-2 flex-shrink-0">
                                        {hasAttachments && <div className="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-blue-600"><Icons.Paperclip /></div>}
                                        <button onClick={(e) => { e.stopPropagation(); handleShareToLine(item); }} className="w-8 h-8 bg-green-50 rounded-full flex items-center justify-center text-green-600"><Icons.MessageCircle /></button>
                                        {canEdit() && <button onClick={(e) => { e.stopPropagation(); handleEdit(item); }} className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600"><Icons.Edit /></button>}
                                    </div>
                                </div>
                                
                                <div className="flex flex-wrap gap-2 mt-2 items-center">
                                    <div className="tag-badge bg-gray-100 text-gray-600"><div className="w-3 h-3 text-indigo-500"><Icons.FileCheck /></div>{item.customsBroker || 'æœªæŒ‡å®š'}</div>
                                    {item.supplier && <div className="tag-badge bg-gray-100 text-gray-600"><div className="w-3 h-3 text-gray-500"><Icons.Factory /></div>{item.supplier}</div>}
                                    {item.origin && <div className="tag-badge bg-gray-100 text-gray-600"><div className="w-3 h-3 text-emerald-500"><Icons.Globe /></div>{item.origin}</div>}
                                    
                                    <label 
                                        className={`tag-badge cursor-pointer border ${item.warehouseConfirmed ? 'bg-green-100 border-green-200 text-green-700' : 'bg-white border-gray-200 text-gray-400 hover:border-gray-300'}`}
                                        onClick={e => e.stopPropagation()}
                                    >
                                        <input 
                                            type="checkbox"
                                            className="w-3 h-3 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-1 cursor-pointer"
                                            checked={item.warehouseConfirmed || false}
                                            onChange={(e) => handleWarehouseConfirm(e, item)}
                                            disabled={!canEditWarehouseFields()}
                                        />
                                        <span className={item.warehouseConfirmed ? 'font-bold' : ''}>{item.warehouseConfirmed ? 'å·²æ”¶è²¨' : 'ç¢ºèªæ”¶è²¨'}</span>
                                    </label>

                                    <span className={`tag-badge ${paidStyle}`}>
                                        è²¨æ¬¾: {item.isPaid ? 'å·²ä»˜' : 'æœªä»˜'}
                                    </span>
                                    
                                    {canSeePrice() && (
                                        <span className={`tag-badge ${flightPaidStyle}`}>
                                            æ—…è²»: {item.flightFeePaid ? 'å·²ä»˜' : 'æœªä»˜'}
                                        </span>
                                    )}

                                    {canSeePrice() && item.prepayment > 0 && <span className="tag-badge bg-yellow-100 text-yellow-700">é ä»˜ {item.prepayment.toLocaleString()} {item.currency === 'USD' ? 'USD' : 'TWD'}</span>}

                                    {isDomestic(item) ? (
                                        <>
                                            {item.devanningLocation && <div className="tag-badge bg-red-100 text-red-600"><div className="w-3 h-3 text-red-500"><Icons.Briefcase /></div>äº¤è²¨åœ°: {item.devanningLocation}</div>}
                                        </>
                                    ) : (
                                        <>
                                            {item.devanningLocation && <div className="tag-badge bg-red-100 text-red-600"><div className="w-3 h-3 text-red-500"><Icons.Briefcase /></div>{item.devanningLocation}</div>}
                                            {item.devanningDate && <div className="tag-badge bg-red-100 text-red-600"><div className="w-3 h-3 text-red-500"><Icons.Calendar /></div>æ‹†æ«ƒæ—¥: {item.devanningDate}</div>}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="p-4">
                            <div className="space-y-3">
                                {(item.products || []).map((p, idx) => (
                                    <div key={idx} className="flex flex-col border-b border-gray-50 pb-2 last:border-0 last:pb-0">
                                        {/* V23.0: è¡Œ1 - å“å + è¦æ ¼ + è²¡å‹™/é‡é‡è³‡è¨Š */}
                                        <div className="flex flex-wrap items-baseline gap-x-3 gap-y-1">
                                            <span className="font-bold text-gray-900 text-base">{p.name}</span>
                                            {p.spec && <span className="text-sm text-gray-500 font-medium">{p.spec}</span>}
                                            <div className="flex items-center gap-2 text-xs ml-auto sm:ml-0">
                                                {p.pricingMode === 'weight' ? <span className="text-orange-500 font-bold">[é‡]</span> : <span className="text-blue-500 font-bold">[æ•¸]</span>}
                                                <span className="text-gray-600 font-mono">{p.quantity.toLocaleString()}ä»¶</span>
                                                <span className="text-gray-400">/</span>
                                                <span className="text-gray-600 font-mono">{p.weight}kg</span>
                                                {canSeePrice() && (
                                                    <>
                                                        <span className="text-gray-400">/</span>
                                                        <span className="text-gray-600 font-mono">${p.unitPrice}</span>
                                                        <span className="text-gray-400">/</span>
                                                        <span className="text-emerald-600 font-bold font-mono">${p.amount.toLocaleString()}</span>
                                                    </>
                                                )}
                                            </div>
                                            {/* æ•¸é‡æ”¾åˆ°æœ€å¾Œï¼Œå¤§å­— */}
                                            <span className="ml-auto text-base font-bold text-blue-600">{p.quantity.toLocaleString()}</span>
                                        </div>
                                        
                                        {/* V23.0: è¡Œ2 - æ‰¹è™Ÿ + æ•ˆæœŸ */}
                                        {(p.batchNumber || p.expiryDate) && (
                                            <div className="flex gap-3 mt-1 text-xs text-gray-400 font-mono">
                                                {p.batchNumber && <span className="bg-gray-100 px-1.5 rounded">æ‰¹:{p.batchNumber}</span>}
                                                {p.expiryDate && <span className="bg-gray-100 px-1.5 rounded">æ•ˆ:{p.expiryDate}</span>}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            
                            <div className={`mt-3 pt-3 border-t border-gray-100 grid gap-2 ${canSeePrice() ? 'grid-cols-3' : 'grid-cols-2'}`}>
                                <div className="text-center">
                                    <div className="text-[10px] text-gray-400 font-bold">ç¸½æ•¸é‡</div>
                                    <div className="text-lg font-black text-blue-600">{(item.totalQuantity || 0).toLocaleString()} <span className="text-xs">ä»¶</span></div>
                                </div>
                                <div className="text-center border-l border-gray-100">
                                    <div className="text-[10px] text-gray-400 font-bold">ç¸½é‡é‡</div>
                                    <div className="text-lg font-black text-orange-500">{(item.totalWeight || 0).toLocaleString()} <span className="text-xs">kg</span></div>
                                </div>
                                {canSeePrice() && (
                                    <div className="text-center border-l border-gray-100">
                                        <div className="text-[10px] text-gray-400 font-bold">ç¸½é‡‘é¡ ({currSymbol})</div>
                                        <div className="text-lg font-black text-emerald-600">{currSymbol}{totalAmount.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="mt-2 flex justify-start gap-3 border-t border-gray-100 pt-2">
                                {canCreate() && <button onClick={(e)=>{e.stopPropagation(); handleDuplicateShipment(item)}} className="text-xs text-gray-400 hover:text-blue-500 flex items-center gap-1"><Icons.Copy /> è¤‡è£½</button>}
                                {canDelete() && <button onClick={(e)=>{e.stopPropagation(); handleDelete(item.id)}} className="text-xs text-gray-400 hover:text-red-500 flex items-center gap-1"><Icons.Trash2 /> åˆªé™¤</button>}
                            </div>
                        </div>
                    </div>
                );
            };

            if (loading && !user) return <div className="flex h-screen items-center justify-center text-gray-400">Loading...</div>;

            if (!user) {
                return (
                    <div className="login-screen">
                        <div className="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm mx-4">
                            <div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200"><Icons.Ship /></div>
                            <h1 className="text-2xl font-bold text-gray-900 mb-2">è²¨æ«ƒç®¡ç†ç³»çµ±</h1>
                            <p className="text-gray-500 mb-8 text-sm">è«‹é¸æ“‡ç™»å…¥èº«åˆ†</p>
                            <div className="space-y-3">
                                <button onClick={handleAdminLogin} className="w-full py-3.5 px-4 bg-blue-600 text-white rounded-xl flex items-center justify-center gap-3 hover:bg-blue-700 transition-all shadow-md font-bold ios-btn"><div className="w-5 h-5"><Icons.Google /></div> å“¡å·¥ç™»å…¥</button>
                                <button onClick={handleGuestLogin} className="w-full py-3.5 px-4 bg-gray-100 text-gray-600 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-200 transition-all font-bold ios-btn"><div className="w-5 h-5"><Icons.User /></div> è¨ªå®¢ç™»å…¥</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <ErrorBoundary>
                <div className="min-h-screen bg-slate-100 pb-20 md:pb-0 md:pl-64">
                    {/* Desktop Sidebar */}
                    <aside className="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 fixed h-full z-20 left-0 top-0">
                        <div className="p-6 flex items-center gap-3 font-bold text-xl text-gray-800">
                            <div className="w-8 h-8 text-blue-600"><Icons.Ship /></div>è²¨æ«ƒç®¡ç† <span className="text-xs text-gray-400">v25.0</span>
                        </div>
                        <nav className="flex-1 px-4 space-y-2">
                            <button onClick={() => setView('list')} className={`sidebar-link w-full ${view === 'list' ? 'active' : ''}`}>
                                <div className="nav-icon"><Icons.List /></div> è²¨æ«ƒåˆ—è¡¨
                            </button>
                            <button onClick={() => setView('stats')} className={`sidebar-link w-full ${view === 'stats' ? 'active' : ''}`}>
                                <div className="nav-icon"><Icons.Chart /></div> çµ±è¨ˆåˆ†æ
                            </button>
                        </nav>
                        <div className="p-4 border-t border-gray-100">
                            <div className="flex items-center gap-3 px-4 py-2">
                                <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500"><Icons.User /></div>
                                <div className="flex-1 min-w-0">
                                    <div className="text-sm font-bold text-gray-800 truncate">{user.displayName || 'è¨ªå®¢'}</div>
                                    <div className="text-xs text-gray-400">{userRole}</div>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="w-full mt-2 py-2 text-xs text-gray-400 hover:text-red-500 flex items-center justify-center gap-1"><Icons.LogOut /> ç™»å‡º</button>
                        </div>
                    </aside>

                    {/* Mobile Content Wrapper */}
                    <div className="flex-1">
                        {showNotifications && (
                            <div className="mobile-modal-overlay" onClick={() => setShowNotifications(false)}>
                                <div className="mobile-modal-content" onClick={e => e.stopPropagation()}>
                                    <div className="bg-gray-50 px-5 py-4 border-b border-gray-100 flex justify-between items-center">
                                        <span className="font-bold text-gray-700">è¿‘æœŸåˆ°æ¸¯æ€¥ä»¶ ({urgentCount})</span>
                                        <button onClick={() => setShowNotifications(false)}><Icons.X /></button>
                                    </div>
                                    <div className="max-h-[60vh] overflow-y-auto p-2">
                                        {urgentShipments.length === 0 ? <div className="p-8 text-center text-gray-400 text-sm">ç„¡æ€¥ä»¶</div> : urgentShipments.map(s => (
                                            <div key={s.id} className="p-3 mb-2 bg-white rounded-xl border border-gray-100 shadow-sm">
                                                <div className="flex justify-between mb-1"><span className="font-bold text-blue-600">{s.containerNumber}</span><span className="text-xs font-bold text-red-500">{Math.ceil(((parseDate(s.arrivalDate) - new Date())/86400000))}å¤©å¾Œ</span></div>
                                                <div className="text-xs text-gray-500 mb-3">{s.importCompany} / {s.supplier}</div>
                                                <button onClick={() => handleShareToLine(s)} className="w-full py-2 bg-[#06C755] text-white rounded-lg text-xs font-bold ios-btn"><Icons.MessageCircle /> é€šçŸ¥ LINE ç¾¤çµ„</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <header className="md:hidden sticky-header-group border-b border-gray-200 px-4 h-14 flex items-center justify-between shadow-sm">
                            <div className="flex items-center gap-2 font-bold text-gray-900">
                                <div className="w-6 h-6 text-blue-600"><Icons.Ship /></div> {view === 'list' ? 'è²¨æ«ƒåˆ—è¡¨' : 'çµ±è¨ˆåˆ†æ'}
                            </div>
                            <div className="flex gap-3 items-center">
                                <div className="relative cursor-pointer" onClick={() => setShowNotifications(!showNotifications)}>
                                    <div className={`p-2 rounded-full hover:bg-gray-100 text-gray-500 ${urgentCount>0?'text-red-500 bell-shake':''}`}><Icons.Bell /></div>
                                    {urgentCount > 0 && <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>}
                                </div>
                                <button onClick={handleLogout} className="text-red-400"><div className="w-6"><Icons.LogOut /></div></button>
                                {canCreate() && view === 'list' && <button onClick={() => { setFormData(initialFormState); setEditingId(null); setView('form'); }} className="text-blue-600"><div className="w-6"><Icons.Plus /></div></button>}
                            </div>
                        </header>

                        <main className="max-w-3xl mx-auto p-4">
                            {view === 'list' ? (
                                <div className="space-y-4">
                                    <div className="sticky top-0 z-20 bg-[#F3F4F6] pt-2 pb-2 -mt-4">
                                        <div className="flex justify-between bg-white rounded-xl p-1 shadow-sm border border-gray-200 overflow-x-auto mb-3">
                                            {canSeePrice() && userRole !== 'GUEST' && (
                                            <button key="UNPAID" onClick={() => setCurrentTab('UNPAID')} className={`flex-1 py-2 px-2 text-sm font-bold rounded-lg transition-colors whitespace-nowrap ${currentTab === 'UNPAID' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                                                <div className="flex items-center justify-center gap-1">
                                                    <span>å¾…ä»˜æ¬¾</span>
                                                    {unpaidList.length > 0 && <span className={`text-xs px-1.5 py-0.5 rounded-full ${currentTab === 'UNPAID' ? 'bg-white/30 text-red-500' : 'bg-red-500 text-white'}`}>({unpaidList.length})</span>}
                                                </div>
                                            </button>
                                            )}
                                            {['NOT_DEVANED', 'DEVANED', 'DOMESTIC'].map(tab => {
                                                let list = [];
                                                if (tab === 'DOMESTIC') list = domesticShipments;
                                                else if (tab === 'DEVANED') list = devannedForeign;
                                                else list = notDevannedForeign;
                                                
                                                const un = list.filter(i => !i.warehouseConfirmed).length;
                                                const tabName = tab === 'NOT_DEVANED' ? 'æœªæ‹†æ«ƒ' : tab === 'DEVANED' ? 'å·²æ‹†æ«ƒ' : 'åœ‹å…§æ¡è³¼';
                                                
                                                return (
                                                    <button key={tab} onClick={() => setCurrentTab(tab)} className={`flex-1 py-2 px-2 text-sm font-bold rounded-lg transition-colors whitespace-nowrap ${currentTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                                                        <div className="flex items-center justify-center gap-1">
                                                            <span>{tabName}</span>
                                                            {un > 0 && <span className={`text-xs px-1.5 py-0.5 rounded-full ${currentTab === tab ? 'bg-white/30 text-red-500' : 'bg-red-500 text-white'}`}>({un})</span>}
                                                        </div>
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        
                                        {currentTab === 'UNPAID' && canSeePrice() && (
                                            <div className="grid grid-cols-2 gap-3 mb-3">
                                                <div className="bg-red-50 border border-red-100 rounded-xl p-3 text-center shadow-sm">
                                                    <div className="text-xs text-red-400 font-bold mb-1">å¾…ä»˜ç¸½é¡ (NT$)</div>
                                                    <div className="text-2xl font-black text-red-600">${currentTotalTWD.toLocaleString()}</div>
                                                </div>
                                                <div className="bg-green-50 border border-green-100 rounded-xl p-3 text-center shadow-sm">
                                                    <div className="text-xs text-green-400 font-bold mb-1">å¾…ä»˜ç¸½é¡ (US$)</div>
                                                    <div className="text-2xl font-black text-green-600">${currentTotalUSD.toLocaleString()}</div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="relative">
                                            <div className="absolute left-3 top-2.5 text-gray-400 w-4"><Icons.Search /></div>
                                            <div className="flex gap-2 items-center">
                                                <input placeholder="æœå°‹æ«ƒè™Ÿã€å» å•†ã€è²¨å“ã€æ‰¹è™Ÿ..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full bg-white text-gray-900 placeholder-gray-400 rounded-xl py-3 pl-10 pr-4 shadow-sm outline-none focus:ring-2 focus:ring-blue-500/50 transition-all" />
                                                <button onClick={() => setDisplayMode(displayMode === 'card' ? 'table' : 'card')} className={`p-2 rounded-xl shadow-sm flex-shrink-0 ${displayMode === 'table' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-500'}`}>
                                                    {displayMode === 'card' ? <Icons.List /> : <Icons.Grid />}
                                                </button>
                                                {!['GUEST'].includes(userRole) && (
                                                <button onClick={handleExport} className="p-2 bg-white rounded-xl shadow-sm text-gray-500 flex-shrink-0 hidden md:block"><Icons.Download /></button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid gap-4">
                                        {displayMode === 'card' ? (
                                            <>
                                                {currentList.map(item => renderShipmentCard(item))}
                                                {currentList.length === 0 && <div className="text-center py-12 text-gray-400 text-sm">æŸ¥ç„¡è³‡æ–™</div>}
                                            </>
                                        ) : (
                                            renderTableView()
                                        )}
                                    </div>
                                </div>
                            ) : view === 'stats' ? <Dashboard shipments={shipments} canSeePrice={canSeePrice} /> : (
                                <div className="ios-card p-5 animate-[fade-in_0.3s_ease-out]">
                                    <div className="flex justify-between mb-4 border-b pb-2"><h2 className="font-bold text-lg text-gray-900">{editingId?'ç·¨è¼¯':'æ–°å¢'}è²¨æ«ƒ</h2><button onClick={()=>setView('list')} className="text-gray-400"><div className="w-6"><Icons.X /></div></button></div>
                                    <form onSubmit={handleSubmit} className="space-y-5">
                                        <div className="grid grid-cols-1 gap-4">
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="block text-sm font-bold text-gray-400 mb-1">é€²å£å…¬å¸</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">{IMPORT_COMPANIES.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                                <div><label className="block text-sm font-bold text-gray-400 mb-1">æ«ƒè™Ÿ</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm font-mono uppercase outline-none focus:ring-2 focus:ring-blue-500" placeholder={formData.customsBroker === 'åœ‹å…§æ¡è³¼' ? "å…å¡«" : "TEMU..."} required={formData.customsBroker !== 'åœ‹å…§æ¡è³¼'} /></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="block text-sm font-bold text-gray-400 mb-1">{formData.customsBroker === 'åœ‹å…§æ¡è³¼' ? 'åˆ°è²¨æ—¥' : 'åˆ°æ¸¯æ—¥'}</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                                <div><label className="block text-sm font-bold text-gray-400 mb-1">å ±é—œè¡Œ <span className="text-xs text-blue-500 font-normal">(åœ‹å…§é¸æ­¤)</span></label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">{CUSTOMS_BROKERS.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                            </div>
                                            <div><label className="block text-sm font-bold text-gray-400 mb-1">èˆ¹å…¬å¸</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="block text-sm font-bold text-gray-400 mb-1">ç”¢åœ°</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /><datalist id="origins">{availableOrigins.map(o => <option key={o} value={o} />)}</datalist></div>
                                                <div><label className="block text-sm font-bold text-gray-400 mb-1">å» å•†</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                            </div>
                                            
                                            <div className="pt-3 border-t border-gray-100 relative">
                                                <h3 className="font-bold text-gray-900 text-base mb-3">{formData.customsBroker === 'åœ‹å…§æ¡è³¼' ? 'äº¤è²¨è³‡è¨Š (é¸å¡«)' : 'æ‹†æ«ƒè³‡è¨Š (é¸å¡«)'}</h3>
                                                <div className="absolute top-3 right-0 flex items-center gap-4">
                                                    {canSeePrice() && (
                                                    <div className="flex items-center gap-2">
                                                        <input type="checkbox" name="isPaid" checked={formData.isPaid || false} onChange={handleInputChange} id="isPaid" className="custom-checkbox" disabled={!canEditForeignFinance()} />
                                                        <label htmlFor="isPaid" className="text-sm font-bold text-green-600 cursor-pointer select-none">å·²åŒ¯æ¬¾</label>
                                                    </div>
                                                    )}
                                                    <div className="flex items-center gap-2">
                                                        <input type="checkbox" name="warehouseConfirmed" checked={formData.warehouseConfirmed || false} onChange={handleInputChange} id="warehouseConfirmed" className="custom-checkbox" disabled={!canEditWarehouseFields()}/>
                                                        <label htmlFor="warehouseConfirmed" className="text-sm font-bold text-blue-600 cursor-pointer select-none">å€‰åº«å·²ç¢ºèªæ”¶è²¨</label>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div><label className="block text-sm font-bold text-gray-400 mb-1">åœ°é»</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                                    <div><label className="block text-sm font-bold text-gray-400 mb-1">æ—¥æœŸ</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                                </div>
                                                {canSeePrice() && (
                                                    <div className="grid grid-cols-2 gap-3 mt-3">
                                                        <div>
                                                            <label className="block text-sm font-bold text-gray-400 mb-1">ä»˜æ¬¾æ¢ä»¶</label>
                                                            {formData.currency === 'TWD' ? (
                                                                <select name="paymentTerm" value={formData.paymentTerm} onChange={handleInputChange} disabled={!canEditDomesticFull()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none" >
                                                                    {PAYMENT_TERMS_DOMESTIC.map(t => <option key={t} value={t}>{t}</option>)}
                                                                </select>
                                                            ) : (
                                                                <input value="åˆ°æ¸¯å‰ä»˜æ¬¾" disabled={!canEditForeignFinance()} className="w-full bg-gray-100 text-gray-500 border border-gray-300 rounded-lg px-3 py-2.5 text-sm" />
                                                            )}
                                                        </div>
                                                        {formData.currency !== 'TWD' && (
                                                            <div>
                                                                <label className="block text-sm font-bold text-gray-400 mb-1">é ä»˜æ¬¾ ({formData.currency})</label>
                                                                <input type="number" name="prepayment" step="0.01" value={formData.prepayment} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            {canEditFlightFee() && isForeign(formData) && (
                                            <div className="pt-3 border-t border-gray-100">
                                                <h3 className="font-bold text-lg text-red-600 mb-3">âœˆï¸ æ—…è²» (TWD)</h3>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="block text-sm font-bold text-gray-400 mb-1">è²»ç”¨é‡‘é¡ (TWD)</label>
                                                        <input type="number" name="flightFee" step="0.01" value={formData.flightFee} onChange={handleInputChange} disabled={!canEditFlightFee()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-red-500" placeholder="0.00" />
                                                    </div>
                                                    <div className="flex items-end pb-1">
                                                        <div className="flex items-center gap-2">
                                                            <input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid || false} onChange={handleInputChange} id="flightFeePaid" className="custom-checkbox" disabled={!canEditFlightFee()} />
                                                            <label htmlFor="flightFeePaid" className="text-sm font-bold text-red-600 cursor-pointer select-none">å·²çµæ¸…</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            )}

                                            <div>
                                                <label className="block text-sm font-bold text-gray-400 mb-1">é™„ä»¶ (å¤šæª”)</label>
                                                <div className="relative w-full input-bg-style rounded-lg px-3 py-2.5 flex items-center justify-between hover:bg-gray-300 transition">
                                                    {formData.docUrl ? (
                                                        <><span className="text-sm text-gray-900 truncate"><a href={formData.docUrl} target="_blank" className="text-blue-600 underline">{formData.docName}</a></span>{canUpload() && <button type="button" onClick={handleDeleteFile} className="ml-2 text-red-500 w-5 h-5"><Icons.Trash2 /></button>}</>
                                                    ) : (
                                                        <><input type="file" onChange={handleFileUpload} disabled={!canUpload() || uploading} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><span className="text-sm text-gray-600 font-medium">{uploading ? 'ä¸Šå‚³ä¸­...' : 'ä¸Šå‚³æ–‡ä»¶'}</span><div className="text-blue-500 w-4 h-4"><Icons.Paperclip /></div></>
                                                    )}
                                                </div>
                                                <div className="mt-2 space-y-2">
                                                    {(formData.attachments || []).map((file, idx) => (
                                                        <div key={idx} className="flex items-center justify-between bg-white border rounded p-2 text-xs">
                                                            <a href={file.url} target="_blank" className="text-blue-600 truncate w-4/5">{file.name}</a>
                                                            {canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500"><Icons.Trash2 /></button>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="pt-3 border-t border-gray-100">
                                            <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-lg text-gray-900">ç”¢å“æ˜ç´°</h3><button type="button" onClick={addProductRow} className="text-blue-600 font-bold text-sm">+ æ–°å¢ç”¢å“</button></div>
                                            <div className="space-y-4">
                                                {formData.products.map((p, idx) => (
                                                    <div key={idx} className="bg-white border border-gray-200 rounded-xl p-4 relative shadow-sm">
                                                        <div className="space-y-3">
                                                            <div><label className="block text-xs font-bold text-gray-400 mb-1">å“å</label><input value={p.name} onChange={e => handleProductChange(idx, 'name', e.target.value)} disabled={!canEditDomesticFull()} className="w-full input-bg-style rounded px-3 py-2 text-sm font-bold outline-none" required /></div>
                                                            
                                                            <div className="flex items-center justify-end gap-2 mb-1">
                                                                <label className="text-xs text-gray-400 font-bold">è¨ˆåƒ¹æ¨¡å¼:</label>
                                                                <select value={p.pricingMode} onChange={e => handleProductChange(idx, 'pricingMode', e.target.value)} disabled={!canEditDomesticFull()} className="text-xs bg-gray-100 rounded px-2 py-1 outline-none text-blue-600 font-bold">
                                                                    <option value="quantity">ğŸ“¦ ä¾æ•¸é‡ (ä»¶ x ç®±å®¹)</option>
                                                                    <option value="weight">âš–ï¸ ä¾é‡é‡ (KG)</option>
                                                                </select>
                                                            </div>

                                                            <div className="grid product-grid-cols gap-2">
                                                                <div className="col-span-4"><label className="block text-xs font-bold text-gray-400 mb-1">è¦æ ¼</label><input value={p.spec} onChange={e => handleProductChange(idx, 'spec', e.target.value)} disabled={!canEditDomesticFull()} className="w-full input-bg-style rounded px-3 py-2 text-sm outline-none" /></div>
                                                                <div className="col-span-2"><label className="block text-xs font-bold text-gray-400 mb-1">ç®±å®¹</label><input type="number" step="0.01" value={p.boxCapacity} onChange={e => handleProductChange(idx, 'boxCapacity', e.target.value)} disabled={!canEditDomesticFull()} className="w-full input-bg-style rounded px-2 py-2 text-sm outline-none text-center" /></div>
                                                                <div className="col-span-3"><label className="block text-xs font-bold text-gray-400 mb-1">ä»¶æ•¸</label><input type="number" value={p.quantity} onChange={e => handleProductChange(idx, 'quantity', e.target.value)} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded px-3 py-2 text-sm font-bold text-right outline-none text-blue-600" /></div>
                                                                <div className="col-span-3"><label className="block text-xs font-bold text-gray-400 mb-1">é‡é‡</label><input type="number" step="0.01" value={p.weight} onChange={e => handleProductChange(idx, 'weight', e.target.value)} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded px-3 py-2 text-sm font-bold text-right outline-none text-orange-500" /></div>
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <input placeholder="æ‰¹è™Ÿ" value={p.batchNumber} onChange={e => handleProductChange(idx, 'batchNumber', e.target.value)} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded px-3 py-2 text-sm outline-none" />
                                                                <input type="date" value={p.expiryDate} onChange={e => handleProductChange(idx, 'expiryDate', e.target.value)} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded px-3 py-2 text-sm outline-none" />
                                                            </div>
                                                            {canSeePrice() && (
                                                                <div className="grid grid-cols-2 gap-2 pt-2 border-t mt-2">
                                                                    <div><label className="block text-xs font-bold text-gray-400 mb-1">å–®åƒ¹</label><input type="number" step="0.01" value={p.unitPrice} onChange={e => handleProductChange(idx, 'unitPrice', e.target.value)} disabled={!canEditForeignFinance()} className="w-full input-bg-style rounded px-3 py-2 text-sm outline-none text-right" /></div>
                                                                    <div><label className="block text-xs font-bold text-gray-400 mb-1">é‡‘é¡</label><div className="w-full bg-gray-100 rounded px-3 py-2 text-sm text-right font-bold">{formData.currency === 'USD' ? 'US$' : 'NT$'}{(p.amount||0).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div></div>
                                                                </div>
                                                            )}
                                                        </div>
                                                        {!canEditDomesticFull() && (
                                                            <div className="absolute top-2 right-2 flex gap-2">
                                                                <button type="button" onClick={()=>duplicateProductRow(idx)} className="text-gray-400 p-1.5 hover:text-blue-500"><Icons.Copy /></button>
                                                                {formData.products.length > 1 && <button type="button" onClick={() => removeProductRow(idx)} className="text-gray-400 p-1.5 hover:text-red-500"><Icons.Trash2 /></button>}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            <div className="mt-4 pt-3 border-t-2 border-gray-200 grid gap-2" style={{gridTemplateColumns: canSeePrice() ? '1fr 1fr 1fr' : '1fr 1fr'}}>
                                                <div className="text-center">
                                                    <div className="text-[10px] text-gray-400 font-bold">ç¸½æ•¸é‡</div>
                                                    <div className="text-lg font-black text-blue-600">{(formData.totalQuantity || 0).toLocaleString()} <span className="text-xs">ä»¶</span></div>
                                                </div>
                                                <div className="text-center border-l border-gray-100">
                                                    <div className="text-[10px] text-gray-400 font-bold">ç¸½é‡é‡</div>
                                                    <div className="text-lg font-black text-orange-500">{(formData.totalWeight || 0).toLocaleString()} <span className="text-xs">kg</span></div>
                                                </div>
                                                {canSeePrice() && (
                                                    <div className="text-center border-l border-gray-100">
                                                        <div className="text-[10px] text-gray-400 font-bold">ç¸½é‡‘é¡ ({formData.currency})</div>
                                                        <div className="text-lg font-black text-emerald-600">{formData.currency === 'USD' ? 'US$' : 'NT$'}{(formData.products.reduce((acc, p) => acc + (Number(p.amount) || 0), 0)).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="flex gap-3 pt-2">
                                            <button type="button" onClick={() => setView('list')} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold ios-btn">å–æ¶ˆ</button>
                                            <button type="submit" disabled={isSubmitting} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold ios-btn shadow-lg shadow-blue-200">{isSubmitting ? '...' : 'å„²å­˜'}</button>
                                        </div>
                                    </form>
                                </div>
                            )}
                        </main>

                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-2 flex justify-between z-40 pb-safe">
                            <button onClick={() => setView('list')} className={`bottom-nav-item ${view === 'list' ? 'active' : ''}`}><div className="nav-icon"><Icons.List /></div><span>åˆ—è¡¨</span></button>
                            <button onClick={() => setView('stats')} className={`bottom-nav-item ${view === 'stats' ? 'active' : ''}`}><div className="nav-icon"><Icons.Chart /></div><span>çµ±è¨ˆ</span></button>
                        </div>
                    </div>
                </div>
                </ErrorBoundary>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerApp />);
    </script>
</body>
</html>