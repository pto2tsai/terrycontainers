<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²¨æ«ƒç®¡ç†ç³»çµ± (v77.0 ç”¢å“å…§å»ºç‰ˆ)</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg && msg.toLowerCase().indexOf("script error") > -1) return false;
            setTimeout(function() {
                var root = document.getElementById('root');
                if (root && root.innerHTML.trim().length > 0 && root.innerHTML.indexOf('ç³»çµ±å•Ÿå‹•ä¸­') === -1) return;
                var div = document.createElement("div");
                div.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:white; color:#333; padding:20px; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;";
                div.innerHTML = `<h2 style="color:#dc2626;font-size:20px;font-weight:bold;margin-bottom:10px">âš ï¸ ç³»çµ±è¼‰å…¥ç•°å¸¸</h2><div style="background:#f3f4f6;padding:15px;border:1px solid #ddd;border-radius:8px;font-size:12px;text-align:left;max-width:90%;overflow:auto;margin-bottom:20px">Line: ${line}<br>${msg}</div><button onclick="window.location.reload()" style="padding:12px 30px;background:#2563eb;color:white;border:none;border-radius:50px;font-weight:bold;cursor:pointer;">é‡æ–°æ•´ç†</button>`;
                document.body.appendChild(div);
                var loader = document.getElementById('loading-screen');
                if(loader) loader.style.display = 'none';
            }, 3000);
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- V74.0: SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        body { background-color: #F3F4F6; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; color: #1f2937; margin: 0; }
        
        /* Loading */
        #loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI */
        .ios-card { background: #ffffff; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid #e5e7eb; overflow: hidden; }
        .ios-card:active { transform: scale(0.995); transition: transform 0.1s; }
        
        .reconcile-table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
        .reconcile-table th { background: #f9fafb; color: #6b7280; font-weight: 600; padding: 10px 6px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .reconcile-table td { padding: 10px 6px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; }
        .reconcile-table tr:hover { background-color: #f9fafb; cursor: pointer; }
        
        .amt-paid { color: #111827; font-weight: 800; font-family: monospace; font-size: 16px; }
        .amt-unpaid { background-color: white; color: #dc2626; border: 1px solid #ef4444; border-radius: 4px; padding: 0 6px; font-weight: 700; font-family: monospace; font-size: 16px; white-space: nowrap; display: inline-block; }

        .tag-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; white-space: nowrap; }
        .company-tag { font-size: 16px; font-weight: 800; padding: 4px 10px; border-radius: 6px; display: inline-block; }
        
        .input-bg-style { background-color: #ffffff; border: 1px solid #d1d5db; color: #111827; transition: all 0.2s; height: 42px; padding: 0 12px; font-size: 16px; border-radius: 8px; width: 100%; }
        .input-bg-style:focus { border-color: #3b82f6; outline: 2px solid #bfdbfe; }
        .input-bg-style::placeholder { color: #9ca3af; font-weight: 700; font-size: 16px; }
        label { font-size: 12px; font-weight: 800; color: #6b7280; margin-bottom: 2px; display: block; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .product-grid-cols { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 2px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 400px; max-height: 80vh; border-radius: 20px; padding: 20px; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { opacity: 1; transform: translateY(0); } }
        
        /* çµ±è¨ˆè¡¨æ ¼æ¨£å¼ */
        .stats-table { width: 100%; text-align: right; border-collapse: collapse; }
        .stats-table th { text-align: right; padding: 8px; background: #f9fafb; color: #6b7280; font-size: 11px; }
        .stats-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; font-family: monospace; font-size: 13px; }
        .stats-table tr:last-child td { border-bottom: none; }
        
        /* V70.0: è¡¨å–®é©—è­‰æ¨£å¼ */
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .input-error:focus { outline: 2px solid #fecaca !important; }
        .label-required::after { content: ' *'; color: #ef4444; }
        .validation-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; z-index: 9999; animation: toastIn 0.3s ease-out; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        /* V77.0: å´é‚Šæ¬„å°èˆªæ¨£å¼ */
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; font-weight: 600; font-size: 14px; color: #6b7280; background: transparent; border: none; text-align: left; cursor: pointer; transition: all 0.2s; }
        .sidebar-link:hover { background: #f3f4f6; color: #374151; }
        .sidebar-link.active { background: #eff6ff; color: #2563eb; }
    </style>
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div><div style="margin-top:15px;color:#666;font-weight:bold">ç³»çµ±å•Ÿå‹•ä¸­...</div></div>
    <div id="root"></div>

    <script>
        setTimeout(function() {
            var loader = document.getElementById('loading-screen');
            if(loader) loader.remove();
        }, 3500);
    </script>

    <script type="text/babel">
        // --- 0. Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center"><h1 className="text-xl font-bold text-red-600">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h1><button onClick={()=>window.location.reload()} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded">é‡æ•´</button></div>;
                return this.props.children;
            }
        }

        // --- 1. Config ---
        const DOMESTIC_FLAG = 'åœ‹å…§æ¡è³¼';
        const IMPORT_COMPANIES = ['å´‡æ–‡å†·å‡', 'å…«æ–¹ç’°çƒ'];
        const CUSTOMS_BROKERS = ['åŸç¢©', 'å°šé´»', DOMESTIC_FLAG];
        const DEFAULT_ORIGINS = ['å„ç“œå¤š', 'å·´æ‹¿é¦¬', 'ç“œåœ°é¦¬æ‹‰', 'å®éƒ½æ‹‰æ–¯', 'æ³°åœ‹', 'å°å°¼', 'å°åº¦', 'ä¸­åœ‹', 'æ™ºåˆ©', 'æŒªå¨'];
        const PAYMENT_TERMS_DOMESTIC = ['ç¾é‡‘', 'æœˆçµ 30 å¤©', 'æœˆçµ 45 å¤©', 'æœˆçµ 60 å¤©', 'å…¶ä»–'];
        
        // V73.0: ç§»é™¤ç¡¬ç·¨ç¢¼çš„ ADMIN_EMAILSï¼Œæ”¹ç‚ºå®Œå…¨å¾ Firestore settings/config è®€å–
        // ç®¡ç†å“¡å’Œè§’è‰²è¨­å®šç¾åœ¨çµ±ä¸€åœ¨ Firestore ä¸­ç®¡ç†ï¼Œæå‡å®‰å…¨æ€§

        // V72.0: çµ±ä¸€ç®¡ç†æ–‡å­—å­—ä¸²ï¼Œä¾¿æ–¼ç¶­è­·å’Œæœªä¾†å¤šèªè¨€æ”¯æ´
        const TEXT = {
            // ç³»çµ±
            APP_NAME: 'è²¨æ«ƒç®¡ç†ç³»çµ±',
            LOADING: 'ç³»çµ±å•Ÿå‹•ä¸­...',
            LOADING_DATA: 'Loading...',
            
            // ç™»å…¥
            LOGIN_TITLE: 'è²¨æ«ƒç®¡ç†ç³»çµ±',
            LOGIN_STAFF: 'å“¡å·¥ç™»å…¥',
            LOGIN_GUEST: 'è¨ªå®¢ç™»å…¥',
            LOGIN_FAILED: 'ç™»å…¥å¤±æ•—',
            GUEST_LOGIN_FAILED: 'è¨ªå®¢ç™»å…¥å¤±æ•—',
            LOGOUT: 'ç™»å‡º',
            
            // æ¬Šé™èˆ‡éŒ¯èª¤
            PERMISSION_DENIED: 'æ¬Šé™ä¸è¶³',
            SAVE_FAILED: 'å„²å­˜å¤±æ•—',
            UPLOAD_FAILED: 'ä¸Šå‚³å¤±æ•—',
            
            // ç¢ºèªå°è©±æ¡†
            CONFIRM_DELETE: 'ç¢ºå®šåˆªé™¤?',
            CONFIRM_DELETE_FILE: 'ç¢ºå®šè¦åˆªé™¤æ­¤é™„ä»¶å—ï¼Ÿ',
            
            // è¡¨å–®é©—è­‰
            REQUIRED_FIELDS: 'è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼š',
            FIELD_CONTAINER: 'æ«ƒè™Ÿ',
            FIELD_ARRIVAL_DATE: 'åˆ°æ¸¯æ—¥',
            FIELD_SUPPLIER: 'å» å•†',
            FIELD_PRODUCT_NAME: 'è‡³å°‘ä¸€é …ç”¢å“åç¨±',
            
            // ç‹€æ…‹æ–‡å­—
            STATUS_ARRIVED: 'å·²åˆ°æ¸¯',
            STATUS_TODAY: 'ä»Šæ—¥åˆ°æ¸¯',
            STATUS_PENDING: 'æœªå®š',
            STATUS_DAYS_LATER: ' å¤©å¾Œ',
            
            // ä»˜æ¬¾ç‹€æ…‹
            PAYMENT_PAID: 'è²¨æ¬¾å·²ä»˜',
            PAYMENT_UNPAID: 'è²¨æ¬¾æœªä»˜',
            FLIGHT_FEE_PAID: 'æ—…è²»å·²ä»˜',
            FLIGHT_FEE_UNPAID: 'æ—…è²»æœªä»˜',
            
            // æŒ‰éˆ•èˆ‡æ“ä½œ
            BTN_SAVE: 'å„²å­˜',
            BTN_CANCEL: 'å–æ¶ˆ',
            BTN_ADD_PRODUCT: '+ æ–°å¢ç”¢å“',
            BTN_SELECT_FILE: 'é¸æ“‡æª”æ¡ˆ (å¯å¤šé¸)',
            BTN_UPLOADING: 'ä¸Šå‚³ä¸­...',
            
            // é ç±¤
            TAB_NOT_DEVANED: 'æœªæ‹†æ«ƒ',
            TAB_DEVANED: 'å·²æ‹†æ«ƒ',
            TAB_DOMESTIC: 'åœ‹å…§æ¡è³¼',
            
            // åˆ—è¡¨
            LIST_TITLE: 'è²¨æ«ƒåˆ—è¡¨',
            STATS_TITLE: 'çµ±è¨ˆåˆ†æ',
            NO_URGENT: 'ç›®å‰ç„¡æ€¥ä»¶',
            URGENT_TITLE: 'è¿‘æœŸåˆ°æ¸¯æ€¥ä»¶',
            FILE_LIST_TITLE: 'é™„ä»¶åˆ—è¡¨',
            
            // è¡¨å–®æ¨™ç±¤
            LABEL_IMPORT_COMPANY: 'é€²å£å…¬å¸',
            LABEL_CONTAINER_NO: 'æ«ƒè™Ÿ',
            LABEL_SHIPPING_COMPANY: 'èˆ¹å…¬å¸',
            LABEL_ARRIVAL_DATE: 'åˆ°æ¸¯æ—¥',
            LABEL_CUSTOMS_BROKER: 'å ±é—œè¡Œ',
            LABEL_DECLARATION_NO: 'å ±é—œå–®è™Ÿ',
            LABEL_PERMIT_NO: 'è¼¸å…¥è¨±å¯è­‰',
            LABEL_SUPPLIER: 'å» å•†',
            LABEL_ORIGIN: 'ç”¢åœ°',
            LABEL_DEVANNING_LOCATION: 'æ‹†æ«ƒåœ°',
            LABEL_DEVANNING_DATE: 'æ‹†æ«ƒæ—¥',
            LABEL_PAYMENT_TERM: 'ä»˜æ¬¾æ¢ä»¶',
            LABEL_FLIGHT_FEE: 'æ—…è²»',
            LABEL_ATTACHMENTS: 'é™„ä»¶',
            
            // ç”¢å“æ˜ç´°
            PRODUCT_SECTION: 'ç”¢å“æ˜ç´°',
            PRODUCT_NAME: 'å“å',
            PRODUCT_SPEC: 'è¦æ ¼',
            PRODUCT_QUANTITY: 'ä»¶æ•¸',
            PRODUCT_WEIGHT: 'é‡é‡',
            PRODUCT_UNIT_PRICE: 'å–®åƒ¹',
            PRODUCT_BATCH: 'æ‰¹è™Ÿ',
            PRODUCT_PRICING_QTY: 'è¨ˆä»¶',
            PRODUCT_PRICING_WEIGHT: 'è¨ˆé‡',
            PRODUCT_HINT: '(è«‹è‡³å°‘å¡«å¯«ä¸€é …å“å)',
            
            // å€‰åº«ç¢ºèª
            WAREHOUSE_CONFIRMED: 'å·²æ”¶è²¨',
            WAREHOUSE_CONFIRM: 'ç¢ºèªæ”¶è²¨',
            
            // çµ±è¨ˆ
            STATS_DASHBOARD: 'çµ±è¨ˆå„€è¡¨æ¿',
            STATS_ALL_MONTHS: 'å…¨éƒ¨æœˆä»½',
            STATS_TOTAL_COUNT: 'ç¸½ç­†æ•¸',
            STATS_TOTAL_ITEMS: 'ç¸½ä»¶æ•¸',
            STATS_TOTAL_WEIGHT: 'ç¸½é‡é‡ (kg)',
            STATS_USD_TOTAL: 'ç¾é‡‘ç¸½é¡ (USD)',
            STATS_TWD_TOTAL: 'å°å¹£ç¸½é¡ (TWD)',
            STATS_MONTHLY_TABLE: 'ğŸ“… æœˆåº¦æ¡è³¼çµ±è¨ˆè¡¨',
            STATS_TOP_SUPPLIERS: 'ğŸ† å‰äº”å¤§å» å•†',
            STATS_NO_DATA: 'ç„¡è¶³å¤ æ•¸æ“šå¯é¡¯ç¤º',
            
            // LINE åˆ†äº«
            LINE_NOTIFY_DOMESTIC: 'ğŸšš åˆ°è²¨é€šçŸ¥',
            LINE_NOTIFY_FOREIGN: 'ğŸš¢ åˆ°æ¸¯é€šçŸ¥',
            
            // V74.0: Excel åŒ¯å…¥
            IMPORT_EXCEL: 'ğŸ“¥ åŒ¯å…¥åœ‹å…§æ¡è³¼',
            IMPORT_TITLE: 'åŒ¯å…¥åœ‹å…§æ¡è³¼è³‡æ–™',
            IMPORT_SELECT_FILE: 'é¸æ“‡ Excel æª”æ¡ˆ',
            IMPORT_PREVIEW: 'è³‡æ–™é è¦½',
            IMPORT_CONFIRM: 'ç¢ºèªåŒ¯å…¥',
            IMPORT_CANCEL: 'å–æ¶ˆ',
            IMPORT_PROCESSING: 'åŒ¯å…¥ä¸­...',
            IMPORT_SUCCESS: 'åŒ¯å…¥æˆåŠŸ',
            IMPORT_FAILED: 'åŒ¯å…¥å¤±æ•—',
            IMPORT_NO_DATA: 'ç„¡æœ‰æ•ˆè³‡æ–™å¯åŒ¯å…¥',
            IMPORT_ROW_COUNT: 'å…± {count} ç­†è³‡æ–™',
            IMPORT_UPDATE_HINT: 'ï¼ˆç›¸åŒå» å•†+æ—¥æœŸ+å“åå°‡è¦†è“‹æ›´æ–°ï¼‰',
            IMPORT_COLUMN_MAPPING: 'æ¬„ä½å°æ‡‰',
            
            // V75.0: ç”¢å“ä¸»æª”
            PRODUCTS_TITLE: 'ç”¢å“ä¸»æª”',
            PRODUCTS_IMPORT: 'ğŸ“¥ åŒ¯å…¥åº«å­˜è¡¨',
            PRODUCTS_ADD: '+ æ–°å¢ç”¢å“',
            PRODUCTS_SEARCH_HINT: 'æœå°‹å“è™Ÿã€å“åã€è¦æ ¼...',
            PRODUCTS_EMPTY: 'å°šç„¡ç”¢å“è³‡æ–™',
            PRODUCTS_IMPORT_TITLE: 'åŒ¯å…¥ç”¢å“ä¸»æª”',
            PRODUCTS_IMPORT_HINT: 'ï¼ˆç›¸åŒå“è™Ÿå°‡è¦†è“‹æ›´æ–°ï¼‰',
            PRODUCTS_EDIT_TITLE: 'ç·¨è¼¯ç”¢å“',
            PRODUCTS_ADD_TITLE: 'æ–°å¢ç”¢å“',
            PRODUCT_ID: 'å“è™Ÿ',
            PRODUCT_DEFAULT_PRICE: 'é è¨­å–®åƒ¹',
            PRODUCT_DEFAULT_SUPPLIER: 'é è¨­ä¾›æ‡‰å•†',
            PRODUCT_UNIT: 'å–®ä½',
            PRODUCT_IS_ACTIVE: 'å•Ÿç”¨',
            PRODUCT_INACTIVE: 'å·²åœç”¨',
        };

        const initialFormState = { 
            importCompany: IMPORT_COMPANIES[0], 
            customsBroker: CUSTOMS_BROKERS[0], 
            origin: '', 
            supplier: '', 
            arrivalDate: new Date().toISOString().split('T')[0], 
            containerNumber: '', 
            shippingCompany: '', 
            products: [{ id: Date.now(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'weight' }], 
            totalQuantity: 0, 
            totalWeight: 0, 
            docUrl: '', 
            docName: '', 
            docRefPath: '', 
            devanningLocation: '', 
            devanningDate: '', 
            customsDeclarationNo: '', 
            importPermitNo: '', 
            warehouseConfirmed: false,
            attachments: [],
            isPaid: false,
            currency: 'USD',
            paymentTerm: 'åˆ°æ¸¯å‰ä»˜æ¬¾',
            prepayment: 0,
            flightFee: 0,         
            flightFeePaid: false 
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDvMBng2Zhbk6sVaZLSuER2KT6qqeoCdnw",
            authDomain: "containersystem-6342f.firebaseapp.com",
            projectId: "containersystem-6342f",
            storageBucket: "containersystem-6342f.firebasestorage.app",
            messagingSenderId: "27658303054",
            appId: "1:27658303054:web:d7a3710054ede268cdf51f"
        };

        let db, auth, storage;
        try {
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); }
            if (typeof firebase !== 'undefined') { db = firebase.firestore(); auth = firebase.auth(); storage = firebase.storage(); }
        } catch (e) { console.error("Firebase Init Failed:", e); }

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 2. Helpers ---
        const safeNum = (val) => { const n = parseFloat(val); return isNaN(n) ? 0 : n; };
        const round2 = (num) => Math.round(safeNum(num) * 100) / 100;
        const format2 = (num) => safeNum(num).toFixed(2);

        // V72.0: ä¿®æ­£æ—¥æœŸè™•ç†ï¼Œä½¿ç”¨ UTC é¿å…æ™‚å€å•é¡Œ
        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0);
            try {
                const p = dateStr.split('-');
                if (p.length !== 3) return new Date(0);
                const year = parseInt(p[0], 10);
                const month = parseInt(p[1], 10) - 1;
                const day = parseInt(p[2], 10);
                if (isNaN(year) || isNaN(month) || isNaN(day)) return new Date(0);
                return new Date(Date.UTC(year, month, day));
            } catch (e) {
                return new Date(0);
            }
        };
        
        // V72.0: è¨ˆç®—å…©å€‹æ—¥æœŸå­—ä¸²ä¹‹é–“çš„å¤©æ•¸å·®ï¼ˆæ­£æ•¸è¡¨ç¤º date1 åœ¨ date2 ä¹‹å¾Œï¼‰
        const dateDiffDays = (dateStr1, dateStr2) => {
            return Math.round((parseDate(dateStr1) - parseDate(dateStr2)) / 86400000);
        };
        
        const getStatusStyle = (date) => { 
            if (!date) return { bg: 'bg-gray-100', text: 'æœªå®š', color: 'text-gray-400' };
            const todayStr = new Date().toISOString().split('T')[0];
            const diff = dateDiffDays(date, todayStr);
            if (diff < 0) return { text: 'å·²åˆ°æ¸¯', color: 'bg-gray-100 text-gray-500' };
            if (diff === 0) return { text: 'ä»Šæ—¥åˆ°æ¸¯', color: 'bg-red-100 text-red-600 animate-pulse' };
            return { text: diff + ' å¤©å¾Œ', color: 'bg-blue-100 text-blue-600' };
        };
        const getCompanyColor = (n) => n === 'å´‡æ–‡å†·å‡' ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700';
        const isDomestic = (d) => d && d.customsBroker === DOMESTIC_FLAG;
        const isForeign = (d) => !isDomestic(d);

        // --- 3. Icons ---
        const Icons = {
            Ship: ()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.8 8"/><path d="M10 10 4.72 7.28a1 1 0 0 1 .11-1.79l9-4a1 1 0 0 1 .9 0l8.26 3.67a1 1 0 0 1 .13 1.77L14 10"/><path d="m14 10-4 4-4-3.7"/></svg>,
            Anchor: ()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>,
            Plus: ()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Search: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Copy: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            FileCheck: ()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            Globe: ()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Factory: ()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>,
            Paperclip: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            ArrowRight: ()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Download: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-3-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            LogOut: ()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Google: ()=><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"></path></svg>,
            X: ()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Check: ()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
            Bell: ()=><svg width="22" height="22" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            MessageCircle: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            User: ()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: ()=><svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            List: ()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Chart: ()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Grid: ()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Dollar: ()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Calendar: ()=><svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Line: ()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9Z"/><path d="M8 12h8"/></svg>,
            Package: ()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m16.5 9.4-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/></svg>
        };
        
        const I = Icons;

        // 4. MonthlySummaryTable (V68.0: Replace Chart with Table)
        const MonthlySummaryTable = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-gray-400 text-center py-4">ç„¡è¶³å¤ æ•¸æ“šå¯é¡¯ç¤º</div>;
            return (
                <div className="overflow-x-auto">
                    <table className="stats-table">
                        <thead>
                            <tr>
                                <th className="text-left">æœˆä»½</th>
                                <th>æ«ƒæ•¸</th>
                                <th>ç¸½é‡(kg)</th>
                                <th>ç¾é‡‘(USD)</th>
                                <th>å°å¹£(TWD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map(d => (
                                <tr key={d.name}>
                                    <td className="text-left font-bold text-gray-700">{d.name}</td>
                                    <td>{d.count}</td>
                                    <td className="text-orange-500">{format2(d.weight)}</td>
                                    <td className="text-emerald-600 font-bold">{d.USD > 0 ? `$${format2(d.USD)}` : '-'}</td>
                                    <td className="text-blue-600 font-bold">{d.TWD > 0 ? `$${format2(d.TWD)}` : '-'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // 5. Dashboard
        const Dashboard = ({ shipments, canSeePrice }) => {
            const availableMonths = useMemo(() => {
                const months = new Set();
                shipments.forEach(s => {
                    if(s.arrivalDate) months.add(s.arrivalDate.substring(0, 7));
                });
                return Array.from(months).sort().reverse();
            }, [shipments]);

            const [tf, setTf] = useState('YEAR');
            const [filterMonth, setFilterMonth] = useState('ALL');
            const [search, setSearch] = useState('');
            
            const stats = useMemo(() => {
                let list = Array.isArray(shipments) ? shipments : [];
                if (search) {
                    const t = search.toLowerCase();
                    list = list.filter(s => (s.supplier||'').toLowerCase().includes(t) || (s.products||[]).some(p=>p.name.toLowerCase().includes(t)));
                }
                
                if (filterMonth !== 'ALL') {
                     list = list.filter(s => s.arrivalDate && s.arrivalDate.startsWith(filterMonth));
                }

                const count = list.length;
                const items = list.reduce((s,i) => s + safeNum(i.totalQuantity), 0);
                const w = list.reduce((s,i) => s + safeNum(i.totalWeight), 0);
                const moneyUSD = list.reduce((s,i) => i.currency==='USD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                const moneyTWD = list.reduce((s,i) => i.currency==='TWD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                
                const supps = {}; list.forEach(s=>{ const n=s.supplier||'æœªå¡«'; supps[n]=(supps[n]||0)+1; });
                const top = Object.entries(supps).sort((a,b)=>b[1]-a[1]).slice(0,5);
                const maxVal = (top.length>0 && top[0][1]>0) ? top[0][1] : 1;

                // V68.0: Table Data Logic
                const chartMap = {};
                // Sort list by date for table
                const chartList = [...list].sort((a,b) => (b.arrivalDate||'').localeCompare(a.arrivalDate||'')); // Descending
                chartList.forEach(s => {
                    if(!s.arrivalDate) return;
                    const k = s.arrivalDate.substring(0, 7); // YYYY-MM
                    if(!chartMap[k]) chartMap[k] = {name:k, count:0, weight:0, TWD:0, USD:0};
                    
                    chartMap[k].count += 1;
                    chartMap[k].weight += safeNum(s.totalWeight);

                    const amt = (s.products||[]).reduce((a,p)=>a+safeNum(p.amount),0);
                    if(s.currency==='USD') chartMap[k].USD += amt; else chartMap[k].TWD += amt;
                });
                const chartData = Object.values(chartMap);

                return { count, items, w, moneyUSD, moneyTWD, top, chartData, maxVal };
            }, [shipments, filterMonth, search]);
            
            return (
                <div className="space-y-6 animate-[fade-in_0.3s_ease-out] pb-20">
                    <div className="flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">çµ±è¨ˆå„€è¡¨æ¿</h2>
                            <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="bg-white border border-gray-300 rounded-lg px-3 py-1 text-sm outline-none font-bold text-gray-700">
                                <option value="ALL">å…¨éƒ¨æœˆä»½</option>
                                {availableMonths.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                        <input placeholder="æœå°‹ç”¢å“ã€å» å•†..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full bg-white text-gray-900 rounded-xl py-2 px-4 outline-none shadow-sm text-sm border border-gray-100" />
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½ç­†æ•¸</div><div className="text-2xl font-black text-gray-800">{stats.count}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½ä»¶æ•¸</div><div className="text-2xl font-black text-blue-600">{stats.items.toLocaleString()}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm col-span-2"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½é‡é‡ (kg)</div><div className="text-2xl font-black text-orange-500">{format2(stats.w)}</div></div>
                        {canSeePrice() && (
                            <>
                                <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¾é‡‘ç¸½é¡ (USD)</div><div className="text-xl font-black text-emerald-600">${format2(stats.moneyUSD)}</div></div>
                                <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">å°å¹£ç¸½é¡ (TWD)</div><div className="text-xl font-black text-emerald-600">${format2(stats.moneyTWD)}</div></div>
                            </>
                        )}
                    </div>
                    {canSeePrice() && <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">ğŸ“… æœˆåº¦æ¡è³¼çµ±è¨ˆè¡¨</h3><MonthlySummaryTable data={stats.chartData} /></div>}
                     <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">ğŸ† å‰äº”å¤§å» å•†</h3><div className="space-y-3">{stats.top.map(([n,c],i)=><div key={n} className="flex items-center gap-3"><div className="w-6 text-xs font-bold text-gray-400">#{i+1}</div><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-gray-700">{n}</span><span className="text-gray-500">{c} ç­†</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width:`${(c/stats.maxVal)*100}%`}}></div></div></div></div>)}</div></div>
                </div>
            );
        };

        // 6. Main App
        function ContainerApp() {
            const [user, setUser] = useState(null);
            const [shipments, setShipments] = useState([]);
            const [view, setView] = useState('list'); 
            const [displayMode, setDisplayMode] = useState('card');
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [currentTab, setCurrentTab] = useState('NOT_DEVANED'); 
            const [userRole, setUserRole] = useState('GUEST');
            const [formData, setFormData] = useState(initialFormState);
            const [showNotifications, setShowNotifications] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [showFileModal, setShowFileModal] = useState(false);
            const [fileList, setFileList] = useState([]);
            const [validationErrors, setValidationErrors] = useState({});
            const [showValidationToast, setShowValidationToast] = useState(false);
            const [validationMessage, setValidationMessage] = useState('');
            
            // V74.0: Excel åŒ¯å…¥ç›¸é—œç‹€æ…‹
            const [showImportModal, setShowImportModal] = useState(false);
            const [importData, setImportData] = useState([]);
            const [importProcessing, setImportProcessing] = useState(false);
            const [importProgress, setImportProgress] = useState({ current: 0, total: 0 });
            
            // V75.0: ç”¢å“ä¸»æª”ç›¸é—œç‹€æ…‹
            const [products, setProducts] = useState([]);
            const [productSearchTerm, setProductSearchTerm] = useState('');
            const [showProductModal, setShowProductModal] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [showProductImportModal, setShowProductImportModal] = useState(false);
            const [productImportData, setProductImportData] = useState([]);
            
            // V76.0: ç”¢å“é¸æ“‡å™¨ç‹€æ…‹
            const [activeProductPicker, setActiveProductPicker] = useState(null); // ç›®å‰é–‹å•Ÿé¸æ“‡å™¨çš„ç”¢å“ç´¢å¼•
            const [productPickerSearch, setProductPickerSearch] = useState('');

            // V72.0: ç§»é™¤é‡è¤‡çš„ Icons è³¦å€¼ï¼Œä½¿ç”¨å…¨åŸŸå®šç¾©çš„ I

            // Actions
            const handleLogout = useCallback(() => { if(auth) auth.signOut(); else window.location.reload(); }, []);
            const handleAdminLogin = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (error) { alert(TEXT.LOGIN_FAILED + ": " + error.message); } };
            const handleGuestLogin = async () => { try { await auth.signInAnonymously(); } catch (error) { alert(TEXT.GUEST_LOGIN_FAILED); } };
            const handleDelete = async (id) => { if(confirm(TEXT.CONFIRM_DELETE)) await db.collection('shipments').doc(id).delete(); };
            const handleWarehouseConfirm = async (e, item) => { e.stopPropagation(); if (!canEditWarehouseFields()) return alert(TEXT.PERMISSION_DENIED); try { await db.collection('shipments').doc(item.id).update({ warehouseConfirmed: !item.warehouseConfirmed }); } catch (err) { alert(err.message); } };
            
            const handleExport = () => { 
                if (userRole === 'GUEST') return alert(TEXT.PERMISSION_DENIED); 
                const showPrice = canSeePrice();
                let header = "é€²å£å…¬å¸,å ±é—œè¡Œ,æ«ƒè™Ÿ,åˆ°æ¸¯æ—¥,ç”¢åœ°,å» å•†,èˆ¹å…¬å¸,å“å,æ‰¹è™Ÿ,æ•ˆæœŸ,è¦æ ¼,ç®±å®¹,æ•¸é‡,é‡é‡,è¨ˆåƒ¹æ¨¡å¼,ç¸½æ•¸,æ–‡ä»¶,æ‹†æ«ƒåœ°é»,æ‹†æ«ƒæ—¥æœŸ,æ˜¯å¦åŒ¯æ¬¾,å¹£åˆ¥,ä»˜æ¬¾æ¢ä»¶,é ä»˜æ¬¾,æ—…è²»,æ—…è²»å·²ä»˜,å ±é—œå–®è™Ÿ,è¼¸å…¥è¨±å¯è­‰è™Ÿ,èˆ¹å…¬å¸";
                if (showPrice) header += ",å–®åƒ¹,é‡‘é¡";
                header += "\n";
                const rows = filteredList.flatMap(s => (s.products || []).map(p => {
                    let row = [s.importCompany,s.customsBroker,s.containerNumber,s.arrivalDate,s.origin,s.supplier,s.shippingCompany,p.name,p.batchNumber,p.expiryDate,p.spec,p.boxCapacity || 1,p.quantity,p.weight || 0, p.pricingMode === 'weight' ? 'é‡é‡' : 'æ•¸é‡', s.totalQuantity,(s.attachments||[]).map(a=>a.url).join('; '),s.devanningLocation,s.devanningDate, s.isPaid ? 'å·²åŒ¯æ¬¾' : 'æœªåŒ¯æ¬¾', s.currency || 'USD', s.paymentTerm || '', s.prepayment || 0, s.flightFee || 0, s.flightFeePaid ? 'å·²ä»˜' : 'æœªä»˜', s.customsDeclarationNo || '', s.importPermitNo || '', s.shippingCompany || ''];
                    if (showPrice) row.push(p.unitPrice || 0, p.amount || 0);
                    return row.map(f => '"' + String(f||'').replace(/"/g,'""') + '"').join(",");
                })).join("\n");
                const link = document.createElement("a"); 
                link.href=URL.createObjectURL(new Blob(["\uFEFF"+header+rows], {type:"text/csv;charset=utf-8;"})); 
                link.download='è²¨æ«ƒ_'+new Date().toISOString().slice(0,10)+'.csv'; link.click(); 
            };

            // V74.0: Excel åŒ¯å…¥åŠŸèƒ½
            const EXCEL_COLUMN_MAP = {
                'å» å•†': 'supplier',
                'ä¾›æ‡‰å•†': 'supplier',
                'å“å': 'productName',
                'ç”¢å“åç¨±': 'productName',
                'è¦æ ¼': 'spec',
                'å–®åƒ¹': 'unitPrice',
                'åƒ¹æ ¼': 'unitPrice',
                'æ•¸é‡': 'quantity',
                'ä»¶æ•¸': 'quantity',
                'é‡é‡': 'weight',
                'æ‰¹è™Ÿ': 'batchNumber',
                'æ•ˆæœŸ': 'expiryDate',
                'æœ‰æ•ˆæœŸé™': 'expiryDate',
                'æ¡è³¼æ—¥æœŸ': 'arrivalDate',
                'æ—¥æœŸ': 'arrivalDate',
                'é€²è²¨æ—¥æœŸ': 'arrivalDate',
            };

            const parseExcelDate = (value) => {
                if (!value) return '';
                // Excel æ—¥æœŸåºåˆ—å€¼
                if (typeof value === 'number') {
                    const date = XLSX.SSF.parse_date_code(value);
                    if (date) {
                        const y = date.y;
                        const m = String(date.m).padStart(2, '0');
                        const d = String(date.d).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    }
                }
                // å­—ä¸²æ—¥æœŸæ ¼å¼
                if (typeof value === 'string') {
                    // è™•ç† YYYY/MM/DD æˆ– YYYY-MM-DD
                    const match = value.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (match) {
                        return `${match[1]}-${match[2].padStart(2,'0')}-${match[3].padStart(2,'0')}`;
                    }
                    // è™•ç†æ°‘åœ‹å¹´ (113/01/15)
                    const rocMatch = value.match(/(\d{2,3})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (rocMatch && parseInt(rocMatch[1]) < 200) {
                        const year = parseInt(rocMatch[1]) + 1911;
                        return `${year}-${rocMatch[2].padStart(2,'0')}-${rocMatch[3].padStart(2,'0')}`;
                    }
                }
                return '';
            };

            const handleExcelImport = async (evt) => {
                const file = evt.target.files[0];
                if (!file) return;
                evt.target.value = '';
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    
                    if (jsonData.length === 0) {
                        alert(TEXT.IMPORT_NO_DATA);
                        return;
                    }
                    
                    // è§£æä¸¦è½‰æ›è³‡æ–™
                    const headers = Object.keys(jsonData[0]);
                    const columnMapping = {};
                    headers.forEach(h => {
                        const key = h.trim();
                        if (EXCEL_COLUMN_MAP[key]) {
                            columnMapping[key] = EXCEL_COLUMN_MAP[key];
                        }
                    });
                    
                    const parsedData = jsonData.map((row, idx) => {
                        const item = { _rowIndex: idx + 2 }; // Excel è¡Œè™Ÿï¼ˆå«æ¨™é¡Œåˆ—ï¼‰
                        
                        Object.entries(row).forEach(([key, value]) => {
                            const mappedKey = columnMapping[key.trim()];
                            if (mappedKey) {
                                if (mappedKey === 'arrivalDate' || mappedKey === 'expiryDate') {
                                    item[mappedKey] = parseExcelDate(value);
                                } else if (mappedKey === 'unitPrice' || mappedKey === 'quantity' || mappedKey === 'weight') {
                                    item[mappedKey] = safeNum(value);
                                } else {
                                    item[mappedKey] = String(value || '').trim();
                                }
                            }
                        });
                        
                        // ç”¢ç”Ÿå”¯ä¸€è­˜åˆ¥ç¢¼ç”¨æ–¼é‡è¤‡æª¢æŸ¥
                        item._uniqueKey = `${item.supplier || ''}_${item.arrivalDate || ''}_${item.productName || ''}`;
                        
                        return item;
                    }).filter(item => item.supplier || item.productName); // éæ¿¾ç©ºç™½åˆ—
                    
                    setImportData(parsedData);
                    setShowImportModal(true);
                    
                } catch (error) {
                    console.error('Excel è§£æéŒ¯èª¤:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                }
            };

            const handleConfirmImport = async () => {
                if (importData.length === 0) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                setImportProcessing(true);
                setImportProgress({ current: 0, total: importData.length });
                
                let successCount = 0;
                let errorCount = 0;
                
                try {
                    for (let i = 0; i < importData.length; i++) {
                        const item = importData[i];
                        setImportProgress({ current: i + 1, total: importData.length });
                        
                        // å»ºç«‹æ¡è³¼å–®è³‡æ–™çµæ§‹
                        const shipmentData = {
                            importCompany: IMPORT_COMPANIES[0],
                            customsBroker: DOMESTIC_FLAG, // åœ‹å…§æ¡è³¼
                            containerNumber: `DOM-${item.arrivalDate?.replace(/-/g, '') || Date.now()}`,
                            arrivalDate: item.arrivalDate || new Date().toISOString().split('T')[0],
                            supplier: item.supplier || '',
                            origin: 'å°ç£',
                            currency: 'TWD',
                            paymentTerm: PAYMENT_TERMS_DOMESTIC[0],
                            products: [{
                                id: Date.now() + i,
                                name: item.productName || '',
                                spec: item.spec || '',
                                unitPrice: item.unitPrice || 0,
                                quantity: item.quantity || 0,
                                weight: item.weight || 0,
                                batchNumber: item.batchNumber || '',
                                expiryDate: item.expiryDate || '',
                                pricingMode: 'weight',
                                boxCapacity: 1,
                                amount: round2((item.weight || 0) * (item.unitPrice || 0))
                            }],
                            totalQuantity: item.quantity || 0,
                            totalWeight: item.weight || 0,
                            isPaid: false,
                            warehouseConfirmed: false,
                            attachments: [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                        };
                        
                        try {
                            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡è³‡æ–™ï¼ˆç›¸åŒå» å•† + æ—¥æœŸ + å“åï¼‰
                            const existingQuery = await db.collection('shipments')
                                .where('customsBroker', '==', DOMESTIC_FLAG)
                                .where('supplier', '==', shipmentData.supplier)
                                .where('arrivalDate', '==', shipmentData.arrivalDate)
                                .get();
                            
                            let existingDoc = null;
                            existingQuery.forEach(doc => {
                                const data = doc.data();
                                const hasProduct = (data.products || []).some(p => p.name === item.productName);
                                if (hasProduct) existingDoc = doc;
                            });
                            
                            if (existingDoc) {
                                // è¦†è“‹æ›´æ–°
                                await db.collection('shipments').doc(existingDoc.id).update({
                                    ...shipmentData,
                                    createdAt: existingDoc.data().createdAt, // ä¿ç•™åŸå»ºç«‹æ™‚é–“
                                });
                            } else {
                                // æ–°å¢
                                await db.collection('shipments').add(shipmentData);
                            }
                            successCount++;
                        } catch (err) {
                            console.error('åŒ¯å…¥å–®ç­†å¤±æ•—:', err);
                            errorCount++;
                        }
                    }
                    
                    setShowImportModal(false);
                    setImportData([]);
                    showToast(`${TEXT.IMPORT_SUCCESS}ï¼š${successCount} ç­†æˆåŠŸ${errorCount > 0 ? `ï¼Œ${errorCount} ç­†å¤±æ•—` : ''}`);
                    
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                } finally {
                    setImportProcessing(false);
                }
            };

            // V75.0: ç”¢å“ä¸»æª”ç›¸é—œå‡½æ•¸
            const initialProductState = {
                productId: '',
                name: '',
                spec: '',
                unit: 'åŒ…',
                defaultPrice: 0,
                defaultSupplier: '',
                isActive: true
            };

            const PRODUCT_UNITS = ['åŒ…', 'ä»¶', 'KG', 'ç›’', 'ç‰‡', 'å°¾', 'æ–¤', 'æ¡¶', 'ç®±', 'å¡Š'];

            // V77.0: å…§å»ºç”¢å“ä¸»æª”åˆå§‹è³‡æ–™ (351ç­†)
            const INITIAL_PRODUCTS_DATA = [{"productId":"A09134S20P","name":"ç„¡è†¨ç™¼è¦ä»PD","spec":"36/40S*420G*20åŒ…(IQ10%)","unit":"ä»¶"},{"productId":"A0914510","name":"å–®å‡ç™½ä»åŸæ–™","spec":"40/50*10KG(IQ)","unit":"ä»¶"},{"productId":"A0915610","name":"å–®å‡ç™½ä»åŸæ–™","spec":"50/60*10KG(IQ)","unit":"ä»¶"},{"productId":"A0916710","name":"å–®å‡ç™½ä»åŸæ–™","spec":"60/70*10KG(IQ)","unit":"ä»¶"},{"productId":"A0916712","name":"å–®å‡ç™½ä»åŸæ–™","spec":"60/70*1K*12åŒ…(IQ20%)","unit":"ä»¶"},{"productId":"A0917910","name":"å–®å‡ç™½ä»åŸæ–™","spec":"70/90*10KG(IQ)","unit":"ä»¶"},{"productId":"A504BK16","name":"504ç™½ä»","spec":"BKNç¢è‚‰*2KG*8åŒ…","unit":"ä»¶"},{"productId":"AWE161010","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"16/20T(å–®å‡,IQ10%)*1K*10åŒ…","unit":"ä»¶"},{"productId":"AWE161012","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"16/20T(å–®å‡,IQ15%)*1K*15åŒ…","unit":"ä»¶"},{"productId":"AWE211010","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"21/25T(å–®å‡,IQ10%)*1K*10åŒ…","unit":"ä»¶"},{"productId":"AWE211012_1","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"21/25T(å–®å‡,IQ20%)*1K*12åŒ…","unit":"ä»¶"},{"productId":"AWE261012_1","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"26/30T(å–®å‡,IQ20%)*1K*12åŒ…","unit":"ä»¶"},{"productId":"AWE311012_1","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"31/35T(å–®å‡,IQ20%)*1K*12åŒ…","unit":"ä»¶"},{"productId":"AWE340012","name":"ç”Ÿç•™å°¾è¦(ä¸é–‹èƒŒ)","spec":"30/40(å–®å‡,IQ20%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"AWE450010_1","name":"ç”Ÿç•™å°¾è¦(ä¸é–‹èƒŒ)","spec":"40/50(å–®å‡,IQ15%)*1.15KG*10åŒ…","unit":"ä»¶"},{"productId":"AWE450010_3","name":"ç”Ÿç•™å°¾è¦(ä¸é–‹èƒŒ)","spec":"40/50(å–®å‡,IQ20%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"BC16118T","name":"ç†Ÿç™½è¦","spec":"16/20*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC21118T","name":"ç†Ÿç™½è¦","spec":"21/25*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC34118T","name":"ç†Ÿç™½è¦","spec":"30/40*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC45118T","name":"ç†Ÿç™½è¦","spec":"40/50*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC56118T","name":"ç†Ÿç™½è¦","spec":"50/60*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC67118T","name":"ç†Ÿç™½è¦","spec":"60/70*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC78118T","name":"ç†Ÿç™½è¦","spec":"70/80*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC91118T","name":"ç†Ÿç™½è¦","spec":"90/110*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU16118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"16/20*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU21118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"21/25*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU34118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"30/40*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU45118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"40/50*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU56118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"50/60*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU67118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"60/70*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU78118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"70/80*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU91118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"90/110*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BMA101008_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"8/12(æœ‰åµ,IQ10%)*700G*10ç›’","unit":"ä»¶"},{"productId":"BMA21100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(ç„¡åµ,IQ20%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMA26100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(ç„¡åµ,IQ20%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMA31100812_2","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(ç„¡åµ,IQ15%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMA31100812_3","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(ç„¡åµ,IQ20%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMC21100612_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(ç„¡åµ,IQ20%)*600G*12ç›’","unit":"ä»¶"},{"productId":"BMC26100612_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(ç„¡åµ,IQ20%)*600G*12ç›’","unit":"ä»¶"},{"productId":"BMC31100612_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(ç„¡åµ,IQ20%)*600G*12ç›’","unit":"ä»¶"},{"productId":"BMW14100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"13/15(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW21100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW21100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW26100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW26100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW31100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW31100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW41100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"41/50(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW41100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"41/50(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW51100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"51/60(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW61100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"61/70(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW71100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"71/90(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BS21110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"21/25*10KG(IQ)","unit":"ä»¶"},{"productId":"BS26110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"26/30*10KG(IQ)","unit":"ä»¶"},{"productId":"BS31110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"31/35*10KG(IQ)","unit":"ä»¶"},{"productId":"BS36110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"36/40*10KG(IQ)","unit":"ä»¶"},{"productId":"BS41110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"41/50*10KG(IQ)","unit":"ä»¶"},{"productId":"BS51110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"51/60*10KG(IQ)","unit":"ä»¶"},{"productId":"BS61110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"61/70*10KG(IQ)","unit":"ä»¶"},{"productId":"BS71110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"71/90*10KG(IQ)","unit":"ä»¶"},{"productId":"C14DG1008","name":"è‰è¦-é ‚ç´š","spec":"14(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C18DG1008","name":"è‰è¦-é ‚ç´š","spec":"18(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C22DG1008","name":"è‰è¦-é ‚ç´š","spec":"22(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C27DG1008","name":"è‰è¦-é ‚ç´š","spec":"27(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C32DG1008","name":"è‰è¦-é ‚ç´š","spec":"32(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C37DG1008","name":"è‰è¦-é ‚ç´š","spec":"37(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"CBI05FI06","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"500G*6åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CBI05FI12","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"500G*12åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CBI05SA12","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"500G*12åŒ…(æ²™æ‹‰)","unit":"ä»¶"},{"productId":"CBI27FI10","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"270G*10åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CBK05CH12","name":"èŸ¹å‘³æ£’(éŸ“åœ‹)","spec":"500G*12åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CF05120808","name":"ç†Ÿé³³å°¾è¦ä»","spec":"50/70*800G*8åŒ…","unit":"ä»¶"},{"productId":"CF07120806","name":"ç†Ÿé³³å°¾è¦ä»","spec":"70/90*800G*6åŒ…","unit":"ä»¶"},{"productId":"CF07120808","name":"ç†Ÿé³³å°¾è¦ä»","spec":"70/90*800G*8åŒ…","unit":"ä»¶"},{"productId":"EL8001206","name":"å‰æ®¼é³³èº(å»è†)","spec":"800G*6åŒ…","unit":"ä»¶"},{"productId":"EM04500310","name":"ä¸­æ²(æ°´ç…®)","spec":"4/6(å»ç›®)450G*10åŒ…","unit":"ä»¶"},{"productId":"EM04550310","name":"ä¸­æ²(æ°´ç…®)","spec":"4/6(ç•™ç›®)550G*10åŒ…","unit":"ä»¶"},{"productId":"EM06450310","name":"ä¸­æ²(æ°´ç…®)","spec":"6/8(å»ç›®)450G*10åŒ…","unit":"ä»¶"},{"productId":"EM08450306","name":"ä¸­æ²(æ°´ç…®)","spec":"8/10(å»ç›®)450G*6åŒ…","unit":"ä»¶"},{"productId":"EP04100010","name":"è»Ÿçµ²","spec":"4/6*1KG*10åŒ…","unit":"ä»¶"},{"productId":"EP06100010","name":"è»Ÿçµ²","spec":"6/8*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FC0010","name":"é­·é­šè†˜","spec":"*10KG","unit":"ä»¶"},{"productId":"FCP101010","name":"é­·é­šæ¸…è‚‰(åŒ…)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FCP201010","name":"é­·é­šæ¸…è‚‰(åŒ…)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FCS102010","name":"é­·é­šæ¸…è‚‰(æ•£)","spec":"10/20*20KG","unit":"ä»¶"},{"productId":"FCS201810","name":"é­·é­šæ¸…è‚‰(æ•£)","spec":"20/40*18KG","unit":"ä»¶"},{"productId":"FEG101010","name":"é­·é­šè€³(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FEG201010","name":"é­·é­šè€³(åˆ»èŠ±)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FH0020","name":"é­·é­šé ­","spec":"*20KG","unit":"ä»¶"},{"productId":"FH0508","name":"é­·é­šé ­","spec":"500G*8åŒ…","unit":"ä»¶"},{"productId":"FM101010","name":"ç†Ÿé­·é­šè‚‰(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FM201010","name":"ç†Ÿé­·é­šè‚‰(åˆ»èŠ±)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FR061010","name":"é­·é­šåœˆ(åˆ»èŠ±)","spec":"6UP*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FR101010","name":"é­·é­šåœˆ(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FR201010","name":"é­·é­šåœˆ(åˆ»èŠ±)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FT0320","name":"é­·é­šé¬š","spec":"*20KG","unit":"ä»¶"},{"productId":"FT031010","name":"é­·é­šé¬š","spec":"300G*10åŒ…","unit":"ä»¶"},{"productId":"FT0420","name":"é­·é­šé¬š","spec":"*20KG(å°åº¦)","unit":"ä»¶"},{"productId":"FT1010","name":"é­·é­šé¬š","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"FT101010","name":"é­·é­šé¬š(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FTC051010","name":"é­·é­šé¬š(åˆ»èŠ±åˆ‡æ®µ)","spec":"500G*10åŒ…(ç‰›)","unit":"ä»¶"},{"productId":"FW0320","name":"é­·é­šç¿…","spec":"*20KG(åˆ»èŠ±)","unit":"ä»¶"},{"productId":"FW1010","name":"é­·é­šç¿…","spec":"1KG*10åŒ…(åˆ»èŠ±)","unit":"ä»¶"},{"productId":"GJ61100012","name":"è´è¶è¦","spec":"61/70(IQ10%)*1KG*12åŒ…(éŸ“å¼)","unit":"ä»¶"},{"productId":"GLB1010","name":"è´è¶è¦","spec":"*1KG*10åŒ…(éŸ“å¼)","unit":"ä»¶"},{"productId":"H9091008","name":"è‰è¦(SG)","spec":"90/110*1KG*8åŒ…","unit":"ä»¶"},{"productId":"H9101008","name":"è‰è¦(SG)","spec":"100/120*1KG*8åŒ…","unit":"ä»¶"},{"productId":"H9111008","name":"è‰è¦(SG)","spec":"110/130*1KG*8åŒ…","unit":"ä»¶"},{"productId":"HCG1010","name":"æ¯”ç›®é­šé°­é‚Šè‚‰(ç…®)","spec":"*1KG*10åŒ…(æ ¼é™µè˜­)","unit":"ä»¶"},{"productId":"JC04100010","name":"(å†°å·)é­·é­š","spec":"4/6*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC06100010","name":"(å†°å·)é­·é­š","spec":"6/8*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC08100010","name":"(å†°å·)é­·é­š","spec":"8/10*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC10100010","name":"(å†°å·)é­·é­š","spec":"10/15*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC15100010","name":"(å†°å·)é­·é­š","spec":"15/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JF04100010","name":"é­·é­š4/6","spec":"4/6*1KG*10åŒ…(æ—¥)","unit":"ä»¶"},{"productId":"JGFH020304T","name":"äººè”˜çƒéª¨é›","spec":"2~3KG/éš»*4åŒ…*å‚³é®®","unit":"ä»¶"},{"productId":"JQ04027010","name":"å°å·","spec":"4/6*270G*10åŒ…","unit":"ä»¶"},{"productId":"JQ04030010","name":"å°å·","spec":"4/6*300G*10åŒ…","unit":"ä»¶"},{"productId":"JQ06027010","name":"å°å·","spec":"6/8*270G*10åŒ…","unit":"ä»¶"},{"productId":"JQ06030010","name":"å°å·","spec":"6/8*300G*10åŒ…","unit":"ä»¶"},{"productId":"JQ08027010","name":"å°å·","spec":"8/12*270G*10åŒ…","unit":"ä»¶"},{"productId":"JQ08030010","name":"å°å·","spec":"8/12*300G*10åŒ…","unit":"ä»¶"},{"productId":"JQF08030010","name":"å°å·(åŒ…)","spec":"8/12*300G*10åŒ…","unit":"ä»¶"},{"productId":"K06500320","name":"èšµè‚‰","spec":"6/9*500G*20åŒ…","unit":"ä»¶"},{"productId":"K69150010","name":"ç‰¡è £è‚‰","spec":"6/9*1.5KG*10åŒ…","unit":"ä»¶"},{"productId":"M9L150008","name":"æ·¡èœ(åŠæ®¼)","spec":"9L(å¤§)*1.5KG*8åŒ…","unit":"ä»¶"},{"productId":"M9L200010","name":"æ·¡èœ(åŠæ®¼)","spec":"9L(å¤§)*2KG*10åŒ…","unit":"ä»¶"},{"productId":"ML150008","name":"æ·¡èœ(åŠæ®¼)","spec":"L(ä¸­)*1.5KG*8åŒ…","unit":"ä»¶"},{"productId":"ML200010","name":"æ·¡èœ(åŠæ®¼)","spec":"L(ä¸­)*2KG*10åŒ…","unit":"ä»¶"},{"productId":"MM200010","name":"æ·¡èœ(åŠæ®¼)","spec":"M(å°)*2KG*10åŒ…","unit":"ä»¶"},{"productId":"MN100010","name":"æ·¡èœè‚‰","spec":"100/200*1KG*10åŒ…","unit":"ä»¶"},{"productId":"MN200010","name":"æ·¡èœè‚‰","spec":"200/300*1KG*10åŒ…","unit":"ä»¶"},{"productId":"MSFL100010","name":"ç‡»é®­é­š(é•·ç‰‡)","spec":"1KG*10åŒ…(æ³•åœ‹æ´›æ–¯)","unit":"ä»¶"},{"productId":"MSFL050010_1","name":"ç‡»é®­é­š(é•·ç‰‡)","spec":"500G*10åŒ…(æ³•åœ‹æ´›æ–¯)","unit":"ä»¶"},{"productId":"MSFL050010_2","name":"ç‡»é®­é­š(é•·ç‰‡)","spec":"500G*10åŒ…(æ³•åœ‹é‡ç”Ÿ)","unit":"ä»¶"},{"productId":"MSS050005","name":"ç‡»é®­é­š(ç‰‡)","spec":"500G*5åŒ…(è˜‡æ ¼è˜­)","unit":"ä»¶"},{"productId":"MSS050010","name":"ç‡»é®­é­š(ç‰‡)","spec":"500G*10åŒ…(è˜‡æ ¼è˜­)","unit":"ä»¶"},{"productId":"MST100010","name":"ç‡»é®­é­š(ç¢)","spec":"1KG*10åŒ…(ç¾)","unit":"ä»¶"},{"productId":"N91090010_1","name":"ç”Ÿç™½è¦(åŸæ–™Block)","spec":"90/110*10KG(BLK)","unit":"ä»¶"},{"productId":"N91110","name":"ç”Ÿç™½è¦(åŸæ–™Block)","spec":"90/110*10KG(BLK)","unit":"ä»¶"},{"productId":"OA0318","name":"èµ¤å˜´è›¤(çœŸç©º)","spec":"300G*18åŒ…","unit":"ä»¶"},{"productId":"OA0510","name":"èµ¤å˜´è›¤(çœŸç©º)","spec":"500G*10åŒ…","unit":"ä»¶"},{"productId":"OB0320","name":"ç™½è›¤(çœŸç©º)","spec":"300G*20åŒ…","unit":"ä»¶"},{"productId":"OCA1010","name":"è›¤èœŠè‚‰(ç”Ÿ)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"OCC1010","name":"è›¤èœŠè‚‰(ç†Ÿ)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"OCD60201010","name":"å°è›¤èœŠ(çœŸç©º,ç†Ÿ,å»æ²™)","spec":"60/100*1KG*10åŒ…","unit":"ä»¶"},{"productId":"OW0510","name":"å¤§è›¤(çœŸç©º)","spec":"500G*10åŒ…","unit":"ä»¶"},{"productId":"OW0610","name":"å¤§è›¤(çœŸç©º)","spec":"600G*10åŒ…","unit":"ä»¶"},{"productId":"P01FI100110","name":"é­šæ¿(æ¾è‘‰)","spec":"10ç‰‡*1KG*10åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"P02SA100112","name":"é­šæ¿(æ¾è‘‰)","spec":"20ç‰‡*1KG*12æ¢(æ²™æ‹‰)","unit":"ä»¶"},{"productId":"P03GR100110","name":"é­šæ¿(æ¾è‘‰)","spec":"36ç‰‡*1KG*10åŒ…(ç‡’çƒ¤)","unit":"ä»¶"},{"productId":"R21W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"21/25(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R21W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"21/25(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R26W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"26/30(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R26W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"26/30(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R31W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"31/35(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R31W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"31/40(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R36W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"36/40(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R36W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"36/40(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R41W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"41/50(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R41W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"41/50(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R51W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"51/60(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R51W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"51/60(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R61W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"61/70(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R61W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"61/70(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R71W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"71/90(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R71W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"71/90(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R91W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"90/110(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R91W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"90/110(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"S08M100010","name":"å¹²è²(æ—¥)","spec":"S(8M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S10M100010","name":"å¹²è²(æ—¥)","spec":"M(10M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S20M100010","name":"å¹²è²(æ—¥)","spec":"L(20M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S30M100010","name":"å¹²è²(æ—¥)","spec":"2L(30M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S40M100010","name":"å¹²è²(æ—¥)","spec":"3L(40M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S50M100010","name":"å¹²è²(æ—¥)","spec":"4L(50M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S60M100010","name":"å¹²è²(æ—¥)","spec":"5L(60M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SA02100010","name":"å¹²è²(æ¾³æ´²)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SA04100010","name":"å¹²è²(æ¾³æ´²)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SA06100010","name":"å¹²è²(æ¾³æ´²)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SAB1008","name":"ç†Ÿé®‘é­š(æ¾³æ´²)","spec":"12P*1KG*8åŒ…(å¸¶æ®¼)","unit":"ä»¶"},{"productId":"SC02100010","name":"å¹²è²(åŠ æ‹¿å¤§)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SC04100010","name":"å¹²è²(åŠ æ‹¿å¤§)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SC06100010","name":"å¹²è²(åŠ æ‹¿å¤§)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SCA06100010","name":"å¹²è²(åŠ æ‹¿å¤§é‡ç”Ÿ)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SCM100010","name":"é®­é­šä¸","spec":"1KG*10åŒ…(å°)","unit":"ä»¶"},{"productId":"SCM500020","name":"é®­é­šè…¹é°­","spec":"5KG*20KG","unit":"ä»¶"},{"productId":"SCS100010","name":"é®­é­šä¸(å¤§)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"SD02100010","name":"å¹²è²(ç¥•é­¯)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SD04100010","name":"å¹²è²(ç¥•é­¯)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SD06100010","name":"å¹²è²(ç¥•é­¯)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SFN015006","name":"åŠæ®¼æ‰‡è²","spec":"1#*500G*6åŒ…(ç´)","unit":"ä»¶"},{"productId":"SFN030006","name":"åŠæ®¼æ‰‡è²","spec":"3#*300G*6åŒ…(ç´)","unit":"ä»¶"},{"productId":"SGE0810","name":"ç¦æ°£é­šåµ(åŒ…)","spec":"800G*10åŒ…(å†°)","unit":"ä»¶"},{"productId":"SJ02100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"21/25*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJ03100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"26/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJ04100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"36/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJ06100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"51/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJB02100010","name":"å¹²è²(æ—¥ç¢)","spec":"Sç¢*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJB04100010","name":"å¹²è²(æ—¥ç¢)","spec":"Mç¢*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJB04100810","name":"å¹²è²(æ—¥ç¢)","spec":"Mç¢(100ç²’)800G*10åŒ…","unit":"ä»¶"},{"productId":"SN02100010","name":"å¹²è²(è¶Šå—)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SN04100010","name":"å¹²è²(è¶Šå—)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SN06100010","name":"å¹²è²(è¶Šå—)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SRTC1010","name":"é®­é­šç¢è‚‰","spec":"1KG*10åŒ…*å‚³é®®","unit":"ä»¶"},{"productId":"SS02100010","name":"å¹²è²(ç¾)","spec":"U-10*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS04100010","name":"å¹²è²(ç¾)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS06100010","name":"å¹²è²(ç¾)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS10100010","name":"å¹²è²(ç¾)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS20100010","name":"å¹²è²(ç¾)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SSF100010","name":"å¹²è²(å¢¨)","spec":"100/150*1KG*10åŒ…","unit":"ä»¶"},{"productId":"ST05100010","name":"å¹²è²(å°)","spec":"50/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"STCC1010","name":"é®­é­šè‚šæ¢*å‚³é®®","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"SU02100010","name":"å¹²è²(ç¾è²)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SU04100010","name":"å¹²è²(ç¾è²)","spec":"40/50*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SU06100010","name":"å¹²è²(ç¾è²)","spec":"50/70*1KG*10åŒ…","unit":"ä»¶"},{"productId":"T05030008","name":"é¯›é­šç‰‡(å°)","spec":"5/7oz*300G*8åŒ…","unit":"ä»¶"},{"productId":"T07030008","name":"é¯›é­šç‰‡(å°)","spec":"7/9oz*300G*8åŒ…","unit":"ä»¶"},{"productId":"TF0018","name":"è’²ç‡’é¯›(ç‰‡)","spec":"140G*18ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TF0112","name":"è’²ç‡’é¯›(ç‰‡)","spec":"1KG*12ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TO220018T","name":"é¯–é­šä¸€å¤œå¹²","spec":"220G*18ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TO260018T","name":"é¯–é­šä¸€å¤œå¹²","spec":"260G*18ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TP100008","name":"è–„é¹½åœŸé­ é­š","spec":"285G*8ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TP100010","name":"è–„é¹½åœŸé­ é­š","spec":"285G*10ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TT05100010","name":"ç« é­šè…³(ç†Ÿ)","spec":"T5*1KG*10åŒ…","unit":"ä»¶"},{"productId":"U11000010","name":"å‰æ®¼è¦ä»(ä»£å·¥)","spec":"1KG*10åŒ…(IQ)","unit":"ä»¶"},{"productId":"UA3611008","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ10%)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"UA41090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ10%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UA4111008","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ10%)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"UA5111008","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ10%)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"UA5111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UA6111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UA7111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UA9111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UB21040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"21/25(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB26040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"26/30(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB31040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"31/40(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB36040010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*400G*10åŒ…","unit":"ä»¶"},{"productId":"UB36040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB41040010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*400G*10åŒ…","unit":"ä»¶"},{"productId":"UB41040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB51040010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*400G*10åŒ…","unit":"ä»¶"},{"productId":"UB51040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB61040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB71040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB91040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UC31050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"31/40(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC36050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC41050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC51050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC61050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC71050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC91050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UD36100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD41100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD51100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD61100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD71100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD91100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UF21100010","name":"ç™½è¦ä»(å»è…¸)","spec":"21/25(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF26100010","name":"ç™½è¦ä»(å»è…¸)","spec":"26/30(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF31100010","name":"ç™½è¦ä»(å»è…¸)","spec":"31/40(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF41100010","name":"ç™½è¦ä»(å»è…¸)","spec":"41/50(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF51100010","name":"ç™½è¦ä»(å»è…¸)","spec":"51/60(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF61100010","name":"ç™½è¦ä»(å»è…¸)","spec":"61/70(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF71100010","name":"ç™½è¦ä»(å»è…¸)","spec":"71/90(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UK41045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK51045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK61045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK71045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK91045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UL41090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL51090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL61090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL71090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL91090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UM36042020","name":"è¦ä»PD(å°è£)","spec":"36/40(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM41042020","name":"è¦ä»PD(å°è£)","spec":"41/50(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM51042020","name":"è¦ä»PD(å°è£)","spec":"51/60(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM61042020","name":"è¦ä»PD(å°è£)","spec":"61/70(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM71042020","name":"è¦ä»PD(å°è£)","spec":"71/90(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM91042020","name":"è¦ä»PD(å°è£)","spec":"91/110(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN36042020","name":"è¦ä»PD(å°è£)","spec":"36/40(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN41042020","name":"è¦ä»PD(å°è£)","spec":"41/50(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN51042020","name":"è¦ä»PD(å°è£)","spec":"51/60(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN61042020","name":"è¦ä»PD(å°è£)","spec":"61/70(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN71042020","name":"è¦ä»PD(å°è£)","spec":"71/90(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN91042020","name":"è¦ä»PD(å°è£)","spec":"91/110(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"W0206","name":"æ›¼æ³¢é­š(çš®)","spec":"200G*6åŒ…","unit":"ä»¶"},{"productId":"W0510","name":"æ›¼æ³¢é­š(çš®)","spec":"500G*10åŒ…","unit":"ä»¶"},{"productId":"WD41100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"41/50(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD41100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"41/50(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD51100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"51/60(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD51100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"51/60(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD61100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"61/70(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD61100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"61/70(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD71100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"71/90(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD71100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"71/90(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD91100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"91/110(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD91100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"91/110(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"X100010","name":"æµ·è†½(å†·)","spec":"100G*10ç›’(æ—¥)","unit":"ä»¶"},{"productId":"Y01050012","name":"èŸ¹ç®¡è‚‰","spec":"ç‰¹A(230G)*12ç“¶","unit":"ä»¶"},{"productId":"Y02050012","name":"èŸ¹ç®¡è‚‰","spec":"A(200G)*12ç“¶","unit":"ä»¶"},{"productId":"Y03050012","name":"èŸ¹ç®¡è‚‰","spec":"B(170G)*12ç“¶","unit":"ä»¶"},{"productId":"YT100006","name":"é›ªèŸ¹è…³(ç†Ÿ)","spec":"1KG*6åŒ…","unit":"ä»¶"},{"productId":"YT100010","name":"é›ªèŸ¹è…³(ç†Ÿ)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"Z021004","name":"é¾è¦(æ´»å‡)","spec":"200/250*10KG*4ç›’","unit":"ä»¶"},{"productId":"Z023510","name":"é¾è¦(ç”Ÿ)","spec":"200/300*3.5KG*10ç›’","unit":"ä»¶"},{"productId":"Z043510","name":"é¾è¦(ç”Ÿ)","spec":"300/400*3.5KG*10ç›’","unit":"ä»¶"},{"productId":"Z101","name":"101","spec":"","unit":"åŒ…"}];

            const handleProductExcelImport = async (evt) => {
                const file = evt.target.files[0];
                if (!file) return;
                evt.target.value = '';
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '', header: 1 });
                    
                    // æ‰¾åˆ°æ¨™é¡Œåˆ—ï¼ˆå“è™Ÿã€å“åã€è¦æ ¼ï¼‰
                    let headerRowIndex = -1;
                    for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (row && row.some(cell => cell === 'å“è™Ÿ' || cell === 'å“å')) {
                            headerRowIndex = i;
                            break;
                        }
                    }
                    
                    if (headerRowIndex === -1) {
                        alert('æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—ï¼ˆå“è™Ÿã€å“åã€è¦æ ¼ï¼‰');
                        return;
                    }
                    
                    const headers = jsonData[headerRowIndex];
                    const colIndex = {
                        productId: headers.findIndex(h => h === 'å“è™Ÿ'),
                        name: headers.findIndex(h => h === 'å“å'),
                        spec: headers.findIndex(h => h === 'è¦æ ¼'),
                        unit: headers.findIndex(h => h === 'å–®ä½')
                    };
                    
                    // è§£æè³‡æ–™åˆ—
                    const parsedProducts = {};
                    for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const productId = row[colIndex.productId];
                        const name = row[colIndex.name];
                        const spec = row[colIndex.spec];
                        const unit = colIndex.unit >= 0 ? row[colIndex.unit] : '';
                        
                        // è·³éç©ºç™½åˆ—æˆ–å°è¨ˆåˆ—
                        if (!productId || !name || productId === 'å“è™Ÿ') continue;
                        
                        // ä½¿ç”¨å“è™Ÿ+è¦æ ¼ä½œç‚ºå”¯ä¸€éµ
                        const key = `${productId}_${spec || ''}`;
                        if (!parsedProducts[key]) {
                            parsedProducts[key] = {
                                productId: String(productId).trim(),
                                name: String(name).trim(),
                                spec: String(spec || '').trim(),
                                unit: PRODUCT_UNITS.includes(unit) ? unit : 'åŒ…',
                                defaultPrice: 0,
                                defaultSupplier: '',
                                isActive: true
                            };
                        }
                    }
                    
                    const productList = Object.values(parsedProducts);
                    if (productList.length === 0) {
                        alert(TEXT.IMPORT_NO_DATA);
                        return;
                    }
                    
                    setProductImportData(productList);
                    setShowProductImportModal(true);
                    
                } catch (error) {
                    console.error('Excel è§£æéŒ¯èª¤:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                }
            };

            const handleConfirmProductImport = async () => {
                if (productImportData.length === 0) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                setImportProcessing(true);
                setImportProgress({ current: 0, total: productImportData.length });
                
                let successCount = 0;
                let errorCount = 0;
                
                try {
                    // æ‰¹æ¬¡å¯«å…¥ï¼Œæ¯æ‰¹ 500 ç­†
                    const batchSize = 500;
                    for (let i = 0; i < productImportData.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = productImportData.slice(i, i + batchSize);
                        
                        for (const item of chunk) {
                            // ä½¿ç”¨å“è™Ÿ+è¦æ ¼ä½œç‚ºæ–‡ä»¶ ID
                            const docId = `${item.productId}_${item.spec}`.replace(/[\/\\*?\"<>|]/g, '_');
                            const docRef = db.collection('products').doc(docId);
                            batch.set(docRef, {
                                ...item,
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                        }
                        
                        await batch.commit();
                        successCount += chunk.length;
                        setImportProgress({ current: Math.min(i + batchSize, productImportData.length), total: productImportData.length });
                    }
                    
                    setShowProductImportModal(false);
                    setProductImportData([]);
                    showToast(`${TEXT.IMPORT_SUCCESS}ï¼š${successCount} ç­†ç”¢å“`);
                    
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                } finally {
                    setImportProcessing(false);
                }
            };

            const handleSaveProduct = async () => {
                if (!editingProduct) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                if (!editingProduct.productId || !editingProduct.name) {
                    alert('è«‹å¡«å¯«å“è™Ÿå’Œå“å');
                    return;
                }
                
                try {
                    const docId = `${editingProduct.productId}_${editingProduct.spec || ''}`.replace(/[\/\\*?\"<>|]/g, '_');
                    await db.collection('products').doc(docId).set({
                        ...editingProduct,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    setShowProductModal(false);
                    setEditingProduct(null);
                    showToast('å„²å­˜æˆåŠŸ');
                } catch (error) {
                    alert(TEXT.SAVE_FAILED + ': ' + error.message);
                }
            };

            const handleDeleteProduct = async (product) => {
                if (!canDelete()) return alert(TEXT.PERMISSION_DENIED);
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${product.name} (${product.spec}) å—ï¼Ÿ`)) return;
                
                try {
                    const docId = `${product.productId}_${product.spec || ''}`.replace(/[\/\\*?\"<>|]/g, '_');
                    await db.collection('products').doc(docId).delete();
                    showToast('å·²åˆªé™¤');
                } catch (error) {
                    alert(TEXT.SAVE_FAILED + ': ' + error.message);
                }
            };

            const filteredProducts = useMemo(() => {
                if (!productSearchTerm.trim()) return products;
                const term = productSearchTerm.toLowerCase();
                return products.filter(p => 
                    (p.productId || '').toLowerCase().includes(term) ||
                    (p.name || '').toLowerCase().includes(term) ||
                    (p.spec || '').toLowerCase().includes(term) ||
                    (p.defaultSupplier || '').toLowerCase().includes(term)
                );
            }, [products, productSearchTerm]);

            // V76.0: ç”¢å“é¸æ“‡å™¨ç¯©é¸çµæœ
            const pickerFilteredProducts = useMemo(() => {
                if (!productPickerSearch.trim()) return products.filter(p => p.isActive !== false).slice(0, 50);
                const term = productPickerSearch.toLowerCase();
                return products.filter(p => 
                    p.isActive !== false && (
                        (p.productId || '').toLowerCase().includes(term) ||
                        (p.name || '').toLowerCase().includes(term) ||
                        (p.spec || '').toLowerCase().includes(term)
                    )
                ).slice(0, 50);
            }, [products, productPickerSearch]);

            // V76.0: é¸æ“‡ç”¢å“å¾Œè‡ªå‹•å¸¶å…¥è¦æ ¼
            const handleSelectProduct = (idx, selectedProduct) => {
                const np = [...formData.products];
                np[idx] = {
                    ...np[idx],
                    name: selectedProduct.name || '',
                    spec: selectedProduct.spec || '',
                    // å¯é¸ï¼šå¸¶å…¥é è¨­å–®åƒ¹
                    // unitPrice: selectedProduct.defaultPrice || np[idx].unitPrice || 0,
                };
                setFormData(prev => ({ ...prev, products: np }));
                setActiveProductPicker(null);
                setProductPickerSearch('');
                
                // æ¸…é™¤é©—è­‰éŒ¯èª¤
                if (validationErrors.products) {
                    setValidationErrors(prev => ({...prev, products: false}));
                }
            };

            // V69.0 Update: Line message content
            const handleShareToLine = (s) => {
                const isDom = isDomestic(s);
                let text = `${isDom ? TEXT.LINE_NOTIFY_DOMESTIC : TEXT.LINE_NOTIFY_FOREIGN}\n`;
                text += `æ—¥æœŸï¼š${s.arrivalDate}\n`;
                text += `æ«ƒè™Ÿï¼š${s.containerNumber}\n`;
                text += `å» å•†ï¼š${s.supplier}\n`;
                // V69.0 Additions:
                text += `æ‹†æ«ƒæ—¥ï¼š${s.devanningDate || 'æœªå®š'}\n`;
                text += `æ‹†æ«ƒåœ°ï¼š${s.devanningLocation || 'æœªå®š'}\n\n`;
                
                (s.products || []).forEach((p, i) => {
                    // V69.0 Additions: Batch Number
                    text += `${i+1}. ${p.name} ${p.spec ? p.spec : ''} (æ‰¹:${p.batchNumber||'ç„¡'}) - ${p.quantity}ä»¶\n`; 
                });
                window.open("https://line.me/R/msg/text/?" + encodeURIComponent(text), '_blank');
            };

            const handleAttachmentClick = (e, item) => {
                e.stopPropagation();
                const files = item.attachments || [];
                if (files.length === 0 && item.docUrl) { window.open(item.docUrl, '_blank'); return; }
                if (files.length === 1) { window.open(files[0].url, '_blank'); return; }
                if (files.length > 1) { setFileList(files); setShowFileModal(true); }
            };

            const handleEdit = (item) => {
                if(!canEdit() && !canUpload()) return alert(TEXT.PERMISSION_DENIED); 
                let atts = item.attachments || [];
                if (item.docUrl && atts.length === 0) { atts.push({ name: item.docName || TEXT.LABEL_ATTACHMENTS, url: item.docUrl, path: item.docRefPath }); }
                setFormData({ 
                    ...initialFormState, ...item, attachments: atts,
                    currency: item.currency || (item.customsBroker === DOMESTIC_FLAG ? 'TWD' : 'USD'),
                    paymentTerm: item.paymentTerm || (item.customsBroker === DOMESTIC_FLAG ? PAYMENT_TERMS_DOMESTIC[0] : 'åˆ°æ¸¯å‰ä»˜æ¬¾'),
                    prepayment: item.prepayment || 0, flightFee: item.flightFee || 0, flightFeePaid: item.flightFeePaid || false,
                    customsDeclarationNo: item.customsDeclarationNo || '', importPermitNo: item.importPermitNo || '',
                    shippingCompany: item.shippingCompany || ''
                }); 
                setEditingId(item.id); setView('form'); 
            };

            const handleDuplicateShipment = (s) => { 
                if(!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                const {id, ...d} = s; const merged = { ...initialFormState, ...d };
                const np = (merged.products || []).map(p=>({...p,id:Date.now()+Math.random()})); 
                setFormData({...merged, containerNumber:'', products:np, attachments:[], isPaid: false, prepayment: 0, flightFee: 0, flightFeePaid: false}); 
                setEditingId(null); setView('form'); 
            };

            // V70.0: è¡¨å–®é©—è­‰å‡½æ•¸
            const validateForm = () => {
                const errors = {};
                const isDom = isDomestic(formData);
                
                // æ–°å¢æ™‚çš„å¿…å¡«é©—è­‰
                if (!editingId) {
                    if (!formData.containerNumber?.trim()) errors.containerNumber = true;
                    if (!formData.arrivalDate) errors.arrivalDate = true;
                    if (!formData.supplier?.trim()) errors.supplier = true;
                    
                    // ç”¢å“æ˜ç´°é©—è­‰ï¼šè‡³å°‘è¦æœ‰ä¸€å€‹ç”¢å“åç¨±
                    const hasValidProduct = (formData.products || []).some(p => p.name?.trim());
                    if (!hasValidProduct) errors.products = true;
                }
                
                return errors;
            };

            const showToast = (message) => {
                setValidationMessage(message);
                setShowValidationToast(true);
                setTimeout(() => setShowValidationToast(false), 3000);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!canEdit()) return alert(TEXT.PERMISSION_DENIED);
                
                // V70.0: åŸ·è¡Œè¡¨å–®é©—è­‰
                const errors = validateForm();
                setValidationErrors(errors);
                
                if (Object.keys(errors).length > 0) {
                    const errorMessages = [];
                    if (errors.containerNumber) errorMessages.push(TEXT.FIELD_CONTAINER);
                    if (errors.arrivalDate) errorMessages.push(TEXT.FIELD_ARRIVAL_DATE);
                    if (errors.supplier) errorMessages.push(TEXT.FIELD_SUPPLIER);
                    if (errors.products) errorMessages.push(TEXT.FIELD_PRODUCT_NAME);
                    showToast(TEXT.REQUIRED_FIELDS + errorMessages.join('ã€'));
                    return;
                }
                
                setIsSubmitting(true);
                try {
                    const d = {...formData, updatedAt: new Date().toISOString()};
                    
                    let dataToSend = d;
                    
                    if(editingId) {
                        if (userRole === 'QC') {
                            dataToSend = {
                                customsDeclarationNo: d.customsDeclarationNo,
                                importPermitNo: d.importPermitNo,
                                attachments: d.attachments,
                                docUrl: d.docUrl || '',
                                docName: d.docName || '',
                                docRefPath: d.docRefPath || '',
                                updatedAt: d.updatedAt
                            };
                        } else if (userRole === 'WAREHOUSE') {
                             dataToSend = {
                                warehouseConfirmed: d.warehouseConfirmed,
                                devanningLocation: d.devanningLocation,
                                devanningDate: d.devanningDate,
                                products: d.products, 
                                totalQuantity: d.totalQuantity,
                                totalWeight: d.totalWeight,
                                updatedAt: d.updatedAt
                             };
                        } 
                        
                        await db.collection('shipments').doc(editingId).update(dataToSend);
                    } else {
                        await db.collection('shipments').add({...d, createdAt: new Date().toISOString()});
                    }
                    setValidationErrors({});
                    setEditingId(null); setView('list');
                } catch(err){ 
                    console.error(err);
                    alert(TEXT.SAVE_FAILED + ": " + err.message); 
                } finally { 
                    setIsSubmitting(false); 
                }
            };

            const handleInputChange = (e) => {
                const {name,value,type,checked}=e.target;
                setFormData(p => ({...p, [name]: type==='checkbox'?checked:value}));
                // V70.0: æ¸…é™¤è©²æ¬„ä½çš„é©—è­‰éŒ¯èª¤
                if (validationErrors[name]) {
                    setValidationErrors(prev => ({...prev, [name]: false}));
                }
            };
            
            // V71.0: éœ€è¦é‡æ–°è¨ˆç®—é‡‘é¡çš„æ¬„ä½
            const AMOUNT_FIELDS = ['quantity', 'weight', 'unitPrice', 'pricingMode', 'boxCapacity'];
            // V71.0: éœ€è¦é‡æ–°è¨ˆç®—ç¸½å’Œçš„æ¬„ä½
            const TOTAL_FIELDS = ['quantity', 'weight'];

            const handleProductChange = (idx, f, v) => {
                const np = [...formData.products]; np[idx] = {...np[idx], [f]:v};
                const p = np[idx];

                if (f === 'spec') {
                    const match = v.match(/(\d+)\s*(?:ç›’|åŒ…|å¡Š|ç‰‡)/);
                    if (match) { p.boxCapacity = parseFloat(match[1]); }
                }

                // V71.0: åªåœ¨é‡‘é¡ç›¸é—œæ¬„ä½è®Šæ›´æ™‚æ‰é‡æ–°è¨ˆç®—
                if (AMOUNT_FIELDS.includes(f) || f === 'spec') {
                    const q = safeNum(p.quantity);
                    const b = safeNum(p.boxCapacity) || 1;
                    const w = safeNum(p.weight);
                    const u = safeNum(p.unitPrice);

                    if(p.pricingMode==='weight') { p.amount = round2(w * u); } 
                    else { p.amount = round2(q * b * u); }
                }

                // V71.0: åªåœ¨æ•¸é‡/é‡é‡æ¬„ä½è®Šæ›´æ™‚æ‰é‡æ–°è¨ˆç®—ç¸½å’Œ
                if (TOTAL_FIELDS.includes(f)) {
                    setFormData(prev => ({
                        ...prev, 
                        products: np, 
                        totalQuantity: np.reduce((s,i) => s + safeNum(i.quantity), 0), 
                        totalWeight: round2(np.reduce((s,i) => s + safeNum(i.weight), 0))
                    }));
                } else {
                    setFormData(prev => ({...prev, products: np}));
                }
                
                // V70.0: è‹¥ä¿®æ”¹å“åï¼Œæ¸…é™¤ç”¢å“é©—è­‰éŒ¯èª¤
                if (f === 'name' && v?.trim() && validationErrors.products) {
                    setValidationErrors(prev => ({...prev, products: false}));
                }
            };

            const addProductRow = (e) => {
                if(e) e.preventDefault();
                // V68.0: é è¨­ weight, boxCapacity=1
                setFormData(p => ({...p, products:[...(p.products||[]), {id:Date.now(), name:'', quantity:0, weight:0, unitPrice:0, amount:0, pricingMode:'weight', boxCapacity: 1}]}));
            };
            const duplicateProductRow = (idx) => { const p=formData.products[idx]; setFormData(prev=>({...prev, products:[...prev.products.slice(0,idx+1), {...p, id:Date.now()}, ...prev.products.slice(idx+1)]})); };
            const removeProductRow = (idx) => { const np=formData.products.filter((_,i)=>i!==idx); setFormData(prev=>({...prev, products:np})); };
            const handleFileUpload = async (evt) => {
                const files = Array.from(evt.target.files);
                if (files.length === 0) return;
                setUploading(true);
                if (!canUpload()) { alert(TEXT.PERMISSION_DENIED); setUploading(false); return; }

                try {
                    const newAttachments = [];
                    for (const file of files) {
                        const ref = storage.ref('docs/' + Date.now() + '_' + file.name);
                        await ref.put(file);
                        const url = await ref.getDownloadURL();
                        newAttachments.push({ name: file.name, url: url, path: ref.fullPath });
                    }
                    setFormData(prev => ({ ...prev, attachments: [...(prev.attachments||[]), ...newAttachments] }));
                } catch (error) { alert(TEXT.UPLOAD_FAILED + ": " + error.message); } finally { setUploading(false); evt.target.value = ''; }
            };
            const handleDeleteFile = async (index) => { 
                if(!confirm(TEXT.CONFIRM_DELETE_FILE)) return;
                if (!canUpload()) return alert(TEXT.PERMISSION_DENIED);
                const target = formData.attachments[index];
                if (target.path && storage) { try { await storage.ref(target.path).delete(); } catch (error) { console.warn(error); } }
                const newAttachments = formData.attachments.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, attachments: newAttachments }));
            };

            // Auth & DB Effects
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none', 300); }
                if (!auth) return;
                const unsub = auth.onAuthStateChanged(u => { setUser(u); if(!u) setLoading(false); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('shipments').onSnapshot(s => {
                    const cleanData = s.docs.map(d => {
                        const dat = d.data();
                        return { id:d.id, ...dat, products: Array.isArray(dat.products) ? dat.products : [] };
                    }).sort((a,b)=>b.arrivalDate>a.arrivalDate?1:-1);
                    setShipments(cleanData);
                    setLoading(false);
                });
                
                // V73.0: å®Œå…¨å¾ Firestore è®€å–è§’è‰²è¨­å®šï¼Œä¸å†ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ ADMIN_EMAILS
                db.collection('settings').doc('config').get().then(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        const email = user.email;
                        
                        // å„ªå…ˆæª¢æŸ¥ user_roles å°æ‡‰
                        if(d.user_roles && d.user_roles[email]) {
                            setUserRole(d.user_roles[email]);
                        }
                        // å…¶æ¬¡æª¢æŸ¥ admin_emails æ¸…å–®
                        else if(d.admin_emails && d.admin_emails.includes(email)) {
                            setUserRole('MANAGER');
                        }
                        // è‹¥éƒ½æ²’æœ‰è¨­å®šï¼Œä¿æŒ GUEST
                    }
                    // è‹¥ config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¿æŒ GUESTï¼ˆæ›´å®‰å…¨çš„é è¨­å€¼ï¼‰
                }).catch(err => {
                    console.warn('ç„¡æ³•è®€å–è¨­å®š:', err);
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¿æŒ GUEST è§’è‰²
                });
                
                return () => unsub();
            }, [user]);

            // V77.0: ç”¢å“ä¸»æª”ç›£è½ + è‡ªå‹•åˆå§‹åŒ–
            useEffect(() => {
                if (!user || !db) return;
                
                // V77.0: é¦–æ¬¡è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–
                const initializeIfEmpty = async () => {
                    try {
                        const snapshot = await db.collection('products').limit(1).get();
                        if (snapshot.empty && INITIAL_PRODUCTS_DATA.length > 0) {
                            console.log('ç”¢å“ä¸»æª”ç‚ºç©ºï¼Œé–‹å§‹åˆå§‹åŒ– ' + INITIAL_PRODUCTS_DATA.length + ' ç­†ç”¢å“...');
                            const batchSize = 500;
                            for (let i = 0; i < INITIAL_PRODUCTS_DATA.length; i += batchSize) {
                                const batch = db.batch();
                                const chunk = INITIAL_PRODUCTS_DATA.slice(i, i + batchSize);
                                for (const p of chunk) {
                                    const docId = (p.productId + '_' + (p.spec || '')).replace(/[\/\\*?"<>|]/g, '_');
                                    batch.set(db.collection('products').doc(docId), { 
                                        ...p, 
                                        defaultPrice: 0,
                                        defaultSupplier: '',
                                        isActive: true,
                                        updatedAt: new Date().toISOString() 
                                    });
                                }
                                await batch.commit();
                            }
                            console.log('ç”¢å“ä¸»æª”åˆå§‹åŒ–å®Œæˆï¼');
                        }
                    } catch (e) { 
                        console.warn('ç”¢å“ä¸»æª”åˆå§‹åŒ–æª¢æŸ¥å¤±æ•—:', e); 
                    }
                };
                
                initializeIfEmpty();
                
                const unsub = db.collection('products').orderBy('name').onSnapshot(s => {
                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    setProducts(data);
                }, err => {
                    console.warn('ç”¢å“ä¸»æª”è¼‰å…¥å¤±æ•—:', err);
                });
                return () => unsub();
            }, [user]);

            // Permissions
            const canManage = () => userRole === 'MANAGER';
            const canEdit = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole);
            const canCreate = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canDelete = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canUpload = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole); 
            const canSeePrice = () => ['MANAGER','PURCHASING','ACCOUNTING'].includes(userRole);
            const canEditFlightFee = () => userRole === 'MANAGER' || userRole === 'ACCOUNTING';
            const canEditDomesticFull = () => ['MANAGER','PURCHASING'].includes(userRole);
            const canEditForeignFinance = () => ['MANAGER', 'ACCOUNTING'].includes(userRole);
            const canEditWarehouseFields = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole);
            const canEditQCFields = () => ['MANAGER', 'QC'].includes(userRole);

            // Filter
            const todayStr = new Date().toISOString().split('T')[0];
            
            // V71.0: å„ªåŒ–æœå°‹æ•ˆèƒ½ - å»ºç«‹æœå°‹ç´¢å¼•
            const searchableShipments = useMemo(() => {
                return shipments.map(s => ({
                    ...s,
                    _searchText: [
                        s.containerNumber,
                        s.supplier,
                        s.importCompany,
                        s.customsBroker,
                        s.origin,
                        s.customsDeclarationNo,
                        s.importPermitNo,
                        ...(s.products || []).flatMap(p => [p.name, p.spec, p.batchNumber])
                    ].filter(Boolean).join(' ').toLowerCase()
                }));
            }, [shipments]);

            const filteredList = useMemo(() => {
                let list = Array.isArray(searchableShipments) ? searchableShipments : [];
                
                // V71.0: å„ªåŒ–æœå°‹ - ä½¿ç”¨é å»ºçš„æœå°‹ç´¢å¼•
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    list = list.filter(s => s._searchText.includes(term));
                }
                
                if(currentTab==='UNPAID') list=list.filter(s=>!s.isPaid);
                else if(currentTab==='DOMESTIC') list=list.filter(s=>isDomestic(s));
                else if(currentTab==='DEVANED') list=list.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr);
                else list=list.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr));
                
                return list.sort((a,b) => (currentTab==='DEVANED' ? (b.devanningDate>a.devanningDate?1:-1) : (a.arrivalDate>b.arrivalDate?1:-1)));
            }, [searchableShipments, searchTerm, currentTab]);
            
            // V71.0: å„ªåŒ–æ€¥ä»¶è¨ˆç®— - åˆä½µ urgentCount å’Œ urgentListï¼Œé¿å…é‡è¤‡éæ­·
            const { urgentCount, urgentList } = useMemo(() => {
                const todayParsed = parseDate(todayStr);
                const list = shipments.filter(s => {
                    if (!s.arrivalDate) return false;
                    const diff = Math.round((parseDate(s.arrivalDate) - todayParsed) / 86400000);
                    return diff >= 0 && diff <= 3;
                }).sort((a, b) => a.arrivalDate > b.arrivalDate ? 1 : -1);
                return { urgentCount: list.length, urgentList: list };
            }, [shipments]);
            
            const unpaidCount = useMemo(() => shipments.filter(s => !s.isPaid).length, [shipments]);

            if(loading) return <div className="flex h-screen items-center justify-center text-gray-500">Loading...</div>;
            if(!user) return <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4"><div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full"><div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl"><I.Ship /></div><h1 className="text-2xl font-bold mb-8">{TEXT.LOGIN_TITLE}</h1><button onClick={handleAdminLogin} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow mb-3 flex justify-center gap-2"><I.Google /> {TEXT.LOGIN_STAFF}</button><button onClick={handleGuestLogin} className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold flex justify-center gap-2"><I.User /> {TEXT.LOGIN_GUEST}</button></div></div>;

            return (
                <ErrorBoundary>
                <div className="min-h-screen bg-slate-100 pb-20 md:pb-0 md:pl-64">
                    {/* V70.0: Validation Toast */}
                    {showValidationToast && <div className="validation-toast">{validationMessage}</div>}
                    
                    {/* Notification Modal */}
                    {showNotifications && (
                        <div className="modal-overlay" onClick={()=>setShowNotifications(false)}>
                            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">{TEXT.URGENT_TITLE} ({urgentCount})</h3><button onClick={()=>setShowNotifications(false)}><I.X /></button></div>
                                {urgentList.length===0 ? <div className="text-center text-gray-400 py-4">{TEXT.NO_URGENT}</div> : urgentList.map(s=>(
                                    <div key={s.id} className="mb-3 p-3 bg-red-50 rounded-lg border border-red-100 cursor-pointer" onClick={()=>{setShowNotifications(false); setFormData({...initialFormState, ...s}); setEditingId(s.id); setView('form');}}>
                                        <div className="flex justify-between font-bold text-sm text-gray-800"><span>{s.containerNumber}</span><span className="text-red-600">{s.arrivalDate}</span></div>
                                        <div className="text-xs text-gray-500 mt-1">{s.supplier}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* File List Modal */}
                    {showFileModal && (
                        <div className="modal-overlay" onClick={()=>setShowFileModal(false)}>
                            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">{TEXT.FILE_LIST_TITLE} ({fileList.length})</h3><button onClick={()=>setShowFileModal(false)}><I.X /></button></div>
                                <div className="space-y-2">
                                    {fileList.map((f, i) => (
                                        <a key={i} href={f.url} target="_blank" className="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-blue-50 border border-gray-200 text-blue-600 group">
                                            <span className="truncate font-bold text-sm mr-2">{f.name}</span>
                                            <span className="text-gray-400 group-hover:text-blue-600"><I.Download /></span>
                                        </a>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V74.0: Excel Import Modal */}
                    {showImportModal && (
                        <div className="modal-overlay" onClick={() => !importProcessing && setShowImportModal(false)}>
                            <div className="modal-content" style={{maxWidth: '600px', maxHeight: '85vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">{TEXT.IMPORT_TITLE}</h3>
                                    {!importProcessing && <button onClick={() => setShowImportModal(false)}><I.X /></button>}
                                </div>
                                
                                <div className="text-sm text-gray-500 mb-3">
                                    {TEXT.IMPORT_ROW_COUNT.replace('{count}', importData.length)}
                                    <span className="ml-2 text-orange-500">{TEXT.IMPORT_UPDATE_HINT}</span>
                                </div>
                                
                                {/* é è¦½è¡¨æ ¼ */}
                                <div className="overflow-x-auto mb-4 border rounded-lg" style={{maxHeight: '300px'}}>
                                    <table className="w-full text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-2 py-2 text-left">#</th>
                                                <th className="px-2 py-2 text-left">å» å•†</th>
                                                <th className="px-2 py-2 text-left">å“å</th>
                                                <th className="px-2 py-2 text-left">è¦æ ¼</th>
                                                <th className="px-2 py-2 text-right">å–®åƒ¹</th>
                                                <th className="px-2 py-2 text-right">æ•¸é‡</th>
                                                <th className="px-2 py-2 text-right">é‡é‡</th>
                                                <th className="px-2 py-2 text-left">æ—¥æœŸ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {importData.slice(0, 50).map((item, idx) => (
                                                <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="px-2 py-1.5 text-gray-400">{item._rowIndex}</td>
                                                    <td className="px-2 py-1.5 font-medium">{item.supplier || '-'}</td>
                                                    <td className="px-2 py-1.5">{item.productName || '-'}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.spec || '-'}</td>
                                                    <td className="px-2 py-1.5 text-right text-emerald-600">{item.unitPrice || 0}</td>
                                                    <td className="px-2 py-1.5 text-right text-blue-600">{item.quantity || 0}</td>
                                                    <td className="px-2 py-1.5 text-right text-orange-500">{item.weight || 0}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.arrivalDate || '-'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {importData.length > 50 && (
                                        <div className="text-center py-2 text-gray-400 text-xs bg-gray-50">
                                            ... é‚„æœ‰ {importData.length - 50} ç­†è³‡æ–™æœªé¡¯ç¤º
                                        </div>
                                    )}
                                </div>
                                
                                {/* é€²åº¦æ¢ */}
                                {importProcessing && (
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{TEXT.IMPORT_PROCESSING}</span>
                                            <span>{importProgress.current} / {importProgress.total}</span>
                                        </div>
                                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-300"
                                                style={{width: `${(importProgress.current / importProgress.total) * 100}%`}}
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {/* æŒ‰éˆ• */}
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowImportModal(false)} 
                                        disabled={importProcessing}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {TEXT.IMPORT_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleConfirmImport} 
                                        disabled={importProcessing || importData.length === 0}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {importProcessing ? TEXT.IMPORT_PROCESSING : TEXT.IMPORT_CONFIRM}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V75.0: ç”¢å“ç·¨è¼¯/æ–°å¢ Modal */}
                    {showProductModal && editingProduct && (
                        <div className="modal-overlay" onClick={() => setShowProductModal(false)}>
                            <div className="modal-content" style={{maxWidth: '500px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">
                                        {editingProduct.id ? TEXT.PRODUCTS_EDIT_TITLE : TEXT.PRODUCTS_ADD_TITLE}
                                    </h3>
                                    <button onClick={() => setShowProductModal(false)}><I.X /></button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_ID} *</label>
                                            <input 
                                                type="text"
                                                value={editingProduct.productId || ''}
                                                onChange={e => setEditingProduct(p => ({...p, productId: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5 font-mono"
                                                placeholder="A09134S20P"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_NAME} *</label>
                                            <input 
                                                type="text"
                                                value={editingProduct.name || ''}
                                                onChange={e => setEditingProduct(p => ({...p, name: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5"
                                                placeholder="å“å"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_SPEC}</label>
                                        <input 
                                            type="text"
                                            value={editingProduct.spec || ''}
                                            onChange={e => setEditingProduct(p => ({...p, spec: e.target.value}))}
                                            className="w-full border rounded-lg p-2.5"
                                            placeholder="36/40S*420G*20åŒ…(IQ10%)"
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_UNIT}</label>
                                            <select 
                                                value={editingProduct.unit || 'åŒ…'}
                                                onChange={e => setEditingProduct(p => ({...p, unit: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5"
                                            >
                                                {PRODUCT_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_DEFAULT_PRICE}</label>
                                            <input 
                                                type="number"
                                                value={editingProduct.defaultPrice || ''}
                                                onChange={e => setEditingProduct(p => ({...p, defaultPrice: safeNum(e.target.value)}))}
                                                className="w-full border rounded-lg p-2.5 text-right"
                                                placeholder="0"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_DEFAULT_SUPPLIER}</label>
                                        <input 
                                            type="text"
                                            value={editingProduct.defaultSupplier || ''}
                                            onChange={e => setEditingProduct(p => ({...p, defaultSupplier: e.target.value}))}
                                            className="w-full border rounded-lg p-2.5"
                                            placeholder="é è¨­ä¾›æ‡‰å•†"
                                        />
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                        <input 
                                            type="checkbox"
                                            id="productIsActive"
                                            checked={editingProduct.isActive !== false}
                                            onChange={e => setEditingProduct(p => ({...p, isActive: e.target.checked}))}
                                            className="w-4 h-4"
                                        />
                                        <label htmlFor="productIsActive" className="text-sm text-gray-600">{TEXT.PRODUCT_IS_ACTIVE}</label>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => setShowProductModal(false)}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold"
                                    >
                                        {TEXT.BTN_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleSaveProduct}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        {TEXT.BTN_SAVE}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V75.0: ç”¢å“åŒ¯å…¥ Modal */}
                    {showProductImportModal && (
                        <div className="modal-overlay" onClick={() => !importProcessing && setShowProductImportModal(false)}>
                            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '85vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">{TEXT.PRODUCTS_IMPORT_TITLE}</h3>
                                    {!importProcessing && <button onClick={() => setShowProductImportModal(false)}><I.X /></button>}
                                </div>
                                
                                <div className="text-sm text-gray-500 mb-3">
                                    {TEXT.IMPORT_ROW_COUNT.replace('{count}', productImportData.length)}
                                    <span className="ml-2 text-orange-500">{TEXT.PRODUCTS_IMPORT_HINT}</span>
                                </div>
                                
                                {/* é è¦½è¡¨æ ¼ */}
                                <div className="overflow-x-auto mb-4 border rounded-lg" style={{maxHeight: '350px'}}>
                                    <table className="w-full text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-2 py-2 text-left">å“è™Ÿ</th>
                                                <th className="px-2 py-2 text-left">å“å</th>
                                                <th className="px-2 py-2 text-left">è¦æ ¼</th>
                                                <th className="px-2 py-2 text-left">å–®ä½</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {productImportData.slice(0, 100).map((item, idx) => (
                                                <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="px-2 py-1.5 font-mono text-gray-500">{item.productId}</td>
                                                    <td className="px-2 py-1.5 font-medium">{item.name}</td>
                                                    <td className="px-2 py-1.5 text-gray-600">{item.spec || '-'}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.unit}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {productImportData.length > 100 && (
                                        <div className="text-center py-2 text-gray-400 text-xs bg-gray-50">
                                            ... é‚„æœ‰ {productImportData.length - 100} ç­†è³‡æ–™æœªé¡¯ç¤º
                                        </div>
                                    )}
                                </div>
                                
                                {/* é€²åº¦æ¢ */}
                                {importProcessing && (
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{TEXT.IMPORT_PROCESSING}</span>
                                            <span>{importProgress.current} / {importProgress.total}</span>
                                        </div>
                                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-300"
                                                style={{width: `${(importProgress.current / importProgress.total) * 100}%`}}
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {/* æŒ‰éˆ• */}
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowProductImportModal(false)} 
                                        disabled={importProcessing}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {TEXT.IMPORT_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleConfirmProductImport} 
                                        disabled={importProcessing || productImportData.length === 0}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {importProcessing ? TEXT.IMPORT_PROCESSING : TEXT.IMPORT_CONFIRM}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V76.0: ç”¢å“é¸æ“‡ Modal */}
                    {activeProductPicker !== null && products.length > 0 && (
                        <div className="modal-overlay" onClick={() => setActiveProductPicker(null)}>
                            <div className="modal-content" style={{maxWidth: '500px', maxHeight: '80vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-3 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">é¸æ“‡ç”¢å“</h3>
                                    <button onClick={() => setActiveProductPicker(null)}><I.X /></button>
                                </div>
                                
                                {/* æœå°‹æ¡† */}
                                <div className="mb-3">
                                    <input 
                                        type="text"
                                        value={productPickerSearch}
                                        onChange={e => setProductPickerSearch(e.target.value)}
                                        placeholder="æœå°‹å“è™Ÿã€å“åã€è¦æ ¼..."
                                        className="w-full px-3 py-2.5 border rounded-xl text-sm"
                                        autoFocus
                                    />
                                </div>
                                
                                {/* ç”¢å“åˆ—è¡¨ */}
                                <div className="overflow-y-auto border rounded-xl" style={{maxHeight: '50vh'}}>
                                    {pickerFilteredProducts.length === 0 ? (
                                        <div className="p-6 text-center text-gray-400">ç„¡ç¬¦åˆçš„ç”¢å“</div>
                                    ) : (
                                        pickerFilteredProducts.map(prod => (
                                            <div 
                                                key={prod.id}
                                                onClick={() => handleSelectProduct(activeProductPicker, prod)}
                                                className="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 active:bg-blue-100"
                                            >
                                                <div className="font-bold text-gray-800">{prod.name}</div>
                                                <div className="text-sm text-gray-500 flex justify-between mt-1">
                                                    <span className="text-blue-600">{prod.spec || 'ç„¡è¦æ ¼'}</span>
                                                    <span className="text-gray-400 font-mono text-xs">{prod.productId}</span>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                                
                                {/* åº•éƒ¨è³‡è¨Š */}
                                <div className="mt-3 text-xs text-gray-400 text-center">
                                    é¡¯ç¤º {pickerFilteredProducts.length} ç­† / å…± {products.filter(p => p.isActive !== false).length} ç­†ç”¢å“
                                </div>
                            </div>
                        </div>
                    )}

                    <aside className="hidden md:flex flex-col w-64 bg-white border-r fixed inset-y-0 left-0 z-20"><div className="p-6 flex items-center gap-3 font-bold text-xl text-gray-800"><span className="text-blue-600"><I.Ship /></span>è²¨æ«ƒç®¡ç† v77.0</div><nav className="flex-1 px-4 space-y-2"><button onClick={()=>setView('list')} className={`sidebar-link w-full ${view==='list'?'active':''}`}><div className="w-8 text-center"><I.List /></div> {TEXT.LIST_TITLE}</button>{userRole !== 'GUEST' && <><button onClick={()=>setView('products')} className={`sidebar-link w-full ${view==='products'?'active':''}`}><div className="w-8 text-center"><I.Package /></div> {TEXT.PRODUCTS_TITLE}</button><button onClick={()=>setView('stats')} className={`sidebar-link w-full ${view==='stats'?'active':''}`}><div className="w-8 text-center"><I.Chart /></div> {TEXT.STATS_TITLE}</button></>}</nav><div className="p-4 border-t"><button onClick={handleLogout} className="w-full py-2 text-xs text-gray-400 hover:text-red-500 flex items-center justify-center gap-1"><I.LogOut /> {TEXT.LOGOUT}</button></div></aside>

                    <div className="md:hidden sticky top-0 z-30 bg-white border-b px-4 h-14 flex items-center justify-between shadow-sm"><div className="flex items-center gap-2 font-bold text-gray-900"><span className="text-blue-600"><I.Ship /></span> {view==='list'?TEXT.LIST_TITLE:(view==='products'?TEXT.PRODUCTS_TITLE:TEXT.STATS_TITLE)}</div><div className="flex gap-3 items-center"><div className="relative" onClick={()=>setShowNotifications(true)}><span className="text-gray-500"><I.Bell /></span>{urgentCount>0&&<span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></span>}</div><button onClick={handleExport} className="text-gray-500"><I.Download /></button>{canCreate()&&view==='list'&&<button onClick={()=>{setFormData(initialFormState);setEditingId(null);setView('form')}} className="text-blue-600"><I.Plus /></button>}<button onClick={handleLogout} className="text-red-400"><I.LogOut /></button></div></div>

                    <main className="p-4 max-w-4xl mx-auto">
                        {view === 'list' && (
                            <div className="space-y-4">
                                <div className="sticky top-0 z-20 bg-[#F3F4F6] -mt-4 pt-4 pb-2 space-y-3">
                                    <div className="flex gap-2 items-center">
                                        <div className="relative flex-1"><span className="absolute left-3 top-3 text-gray-400"><I.Search /></span><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="æœå°‹..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border-none shadow-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                        {canSeePrice() && (
                                            <button onClick={()=>setCurrentTab(currentTab==='UNPAID'?'NOT_DEVANED':'UNPAID')} className={`relative p-2.5 rounded-xl shadow-sm transition-colors ${currentTab==='UNPAID'?'bg-red-500 text-white':'bg-white text-gray-600'}`}>
                                                <div className="flex items-center gap-1 font-bold"><I.Dollar />{unpaidCount > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}</div>
                                            </button>
                                        )}
                                        <button onClick={()=>setDisplayMode(displayMode==='card'?'table':'card')} className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600"><I.List /></button>
                                        
                                        {/* é›»è…¦ç‰ˆå››å¤§å¤©ç‹ */}
                                        <div className="hidden md:flex gap-2">
                                            <div onClick={()=>setShowNotifications(true)} className="relative p-2.5 bg-white rounded-xl shadow-sm text-gray-600 cursor-pointer hover:bg-gray-50"><I.Bell />{urgentCount>0&&<span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>}</div>
                                            <button onClick={handleExport} className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600 hover:bg-gray-50"><I.Download /></button>
                                            {canCreate() && <button onClick={()=>{setFormData(initialFormState);setEditingId(null);setView('form')}} className="p-2.5 bg-white rounded-xl shadow-sm text-blue-600 hover:bg-blue-50"><I.Plus /></button>}
                                        </div>
                                    </div>
                                    <div className="flex overflow-x-auto gap-2 pb-1">
                                        <button onClick={()=>setCurrentTab('NOT_DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='NOT_DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>æœªæ‹†æ«ƒ <span className={`ml-1 text-xs ${currentTab==='NOT_DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr)).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>å·²æ‹†æ«ƒ <span className={`ml-1 text-xs ${currentTab==='DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DOMESTIC')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DOMESTIC'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>åœ‹å…§æ¡è³¼ <span className={`ml-1 text-xs ${currentTab==='DOMESTIC'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isDomestic(s)).length}</span></button>
                                        
                                        {/* V74.0: Excel åŒ¯å…¥æŒ‰éˆ• */}
                                        {canCreate() && currentTab === 'DOMESTIC' && (
                                            <label className="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap bg-emerald-500 text-white shadow cursor-pointer hover:bg-emerald-600 transition-colors">
                                                {TEXT.IMPORT_EXCEL}
                                                <input type="file" accept=".xlsx,.xls" onChange={handleExcelImport} className="hidden" />
                                            </label>
                                        )}
                                    </div>
                                </div>

                                {displayMode === 'table' ? (
                                    <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                                        <table className="reconcile-table">
                                            <thead><tr><th>æ—¥æœŸ</th><th>æ«ƒè™Ÿ</th><th>å» å•†</th><th>å“åæ‘˜è¦</th><th className="text-right">ç¸½æ•¸</th><th className="text-right">ç¸½é‡</th>{canSeePrice()&&<th className="text-right">è²¨æ¬¾é‡‘é¡</th>}{canEditFlightFee()&&<th className="text-right">æ—…è²»</th>}</tr></thead>
                                            <tbody>
                                                {filteredList.map(item => {
                                                    const totalAmt = (item.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                                                    const curr = item.currency === 'USD' ? 'US$' : 'NT$';
                                                    const showFlightFee = isForeign(item) || canManage();
                                                    return (
                                                    <tr key={item.id} onClick={()=>{setFormData({...initialFormState, ...item}); setEditingId(item.id); setView('form');}}>
                                                        <td className="whitespace-nowrap">{item.arrivalDate}</td><td className="font-bold">{item.containerNumber}</td><td className="truncate max-w-[80px]">{item.supplier}</td><td className="truncate max-w-[100px]">{(item.products||[]).map(p=>p.name).join(',')}</td><td className="text-right font-bold text-blue-600">{safeNum(item.totalQuantity).toLocaleString()}</td><td className="text-right text-orange-500">{format2(safeNum(item.totalWeight))}</td>
                                                        {canSeePrice()&&<td className="text-right whitespace-nowrap"><span className={item.isPaid?"amt-paid":"amt-unpaid"}>{curr} {format2(totalAmt)}</span></td>}
                                                        {canEditFlightFee()&&<td className="text-right whitespace-nowrap">{showFlightFee?<span className={item.flightFeePaid?"amt-paid":"amt-unpaid"}>{format2(safeNum(item.flightFee))}</span>:'-'}</td>}
                                                    </tr>
                                                )})}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {filteredList.map(item => {
                                            const totalAmount = (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                                            const totalWeight = (item.products || []).reduce((sum, p) => sum + (Number(p.weight) || 0), 0);
                                            const totalQty = (item.products || []).reduce((sum, p) => sum + (Number(p.quantity) || 0), 0);
                                            const currSymbol = item.currency === 'USD' ? 'US$' : 'NT$';
                                            
                                            const isDevanned = item.devanningDate && item.devanningDate <= todayStr;
                                            const mainDate = parseDate(item.arrivalDate);
                                            
                                            const hasAttachments = (item.attachments && item.attachments.length > 0) || item.docUrl;
                                            const attCount = item.attachments ? item.attachments.length : (item.docUrl ? 1 : 0);

                                            return (
                                            <div key={item.id} className="ios-card p-4" onClick={()=>{setFormData({...initialFormState, ...item}); setEditingId(item.id); setView('form');}}>
                                                {/* V63.0: å¡ç‰‡é ­éƒ¨ - å®Œæ•´è³‡è¨Š (å«èˆ¹å…¬å¸) */}
                                                <div className="flex justify-between items-start mb-3 border-b border-gray-100 pb-2">
                                                    <div className="flex-1 min-w-0">
                                                        <div className="mb-1"><span className={`company-tag ${getCompanyColor(item.importCompany)} text-xs`}>{item.importCompany}</span></div>
                                                        <div className="text-2xl font-black text-gray-900 tracking-tight mb-2">{item.containerNumber}</div>
                                                        
                                                        <div className="flex flex-wrap gap-1 mb-2">
                                                            {item.customsBroker && <span className="tag-badge bg-gray-100 text-gray-600"><I.FileCheck />{item.customsBroker}</span>}
                                                            <span className="tag-badge bg-gray-100 text-gray-600"><I.Factory />{item.supplier}</span>
                                                            {item.origin && <span className="tag-badge bg-gray-100 text-gray-600"><I.Globe />{item.origin}</span>}
                                                            {/* èˆ¹å…¬å¸é¡¯ç¤º */}
                                                            {item.shippingCompany && <span className="tag-badge bg-gray-100 text-gray-600"><I.Ship />{item.shippingCompany}</span>}
                                                            
                                                            {/* ç´«è‰²å®˜æ–¹å–®è™Ÿå€ */}
                                                            {item.customsDeclarationNo && <span className="tag-badge bg-purple-50 text-purple-700 border border-purple-100"><I.FileCheck />å ±é—œå–®:{item.customsDeclarationNo}</span>}
                                                            {item.importPermitNo && <span className="tag-badge bg-purple-50 text-purple-700 border border-purple-100"><I.FileCheck />è¨±å¯è­‰:{item.importPermitNo}</span>}
                                                        </div>

                                                        <div className="flex flex-wrap gap-1">
                                                            {item.devanningLocation && <span className="tag-badge bg-blue-50 text-blue-600"><I.Briefcase />{item.devanningLocation}</span>}
                                                            {item.devanningDate && <span className="tag-badge bg-blue-50 text-blue-600"><I.Calendar />{item.devanningDate}</span>}
                                                        </div>
                                                    </div>
                                                    {/* å³å´æ“ä½œå€ */}
                                                    <div className="flex flex-col items-end gap-2">
                                                         <div className="flex gap-1 relative z-10">
                                                            {/* V47.0: æ™ºæ…§é™„ä»¶æŒ‰éˆ• */}
                                                            {((item.attachments && item.attachments.length > 0) || item.docUrl) && (
                                                                <button onClick={(e)=>handleAttachmentClick(e, item)} className="text-blue-500 hover:bg-blue-50 p-1.5 rounded-full relative">
                                                                    <I.Paperclip />
                                                                    {(item.attachments?.length || (item.docUrl ? 1 : 0)) > 1 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-3.5 h-3.5 flex items-center justify-center rounded-full">{(item.attachments?.length || (item.docUrl ? 1 : 0))}</span>}
                                                                </button>
                                                            )}
                                                            
                                                            {canEdit() && <button onClick={(e)=>{e.stopPropagation(); handleEdit(item)}} className="text-gray-400 hover:text-blue-600 p-1.5"><I.Edit /></button>}
                                                            <button onClick={(e)=>{e.stopPropagation(); handleShareToLine(item)}} className="text-green-500 hover:text-green-600 p-1.5"><I.MessageCircle /></button>
                                                            {canCreate() && <button onClick={(e)=>{e.stopPropagation(); handleDuplicateShipment(item)}} className="text-gray-400 hover:text-blue-600 p-1.5"><I.Copy /></button>}
                                                            {canDelete() && <button onClick={(e)=>{e.stopPropagation(); handleDelete(item.id)}} className="text-gray-400 hover:text-red-600 p-1.5"><I.Trash2 /></button>}
                                                        </div>
                                                        <div className={`flex flex-col items-center justify-center w-14 h-14 rounded-xl border ${isDevanned?'bg-green-50 border-green-200 text-green-700':'bg-white border-gray-200 text-gray-700'}`}><span className="text-[10px] font-bold uppercase">{mainDate.toLocaleString('default',{month:'short'})}</span><span className="text-xl font-bold leading-none">{mainDate.getDate()}</span></div>
                                                    </div>
                                                </div>

                                                {/* ç”¢å“æ˜ç´° */}
                                                <div className="space-y-3">
                                                    {(item.products || []).map((p,i)=>(
                                                        <div key={i} className="flex flex-col border-b border-gray-50 pb-2 last:border-0 last:pb-0">
                                                            <div className="flex flex-wrap items-baseline gap-x-2 gap-y-1 text-sm">
                                                                <span className="font-bold text-gray-900 text-base">{p.name}</span>
                                                                {p.spec&&<span className="text-gray-500">{p.spec}</span>}
                                                                <div className="flex items-center gap-2 mr-auto sm:ml-0 flex-wrap justify-start text-gray-600">
                                                                    <span className="text-xs text-gray-400">{p.pricingMode==='weight'?'[é‡]':'[æ•¸]'}</span>
                                                                    <span className="font-mono text-base">{format2(safeNum(p.weight))}kg</span>
                                                                    {/* V69.0: éš±è—è¨ªå®¢é‡‘é¡ (åˆ—è¡¨æ˜ç´°) */}
                                                                    {canSeePrice()&&<><span className="text-gray-300">|</span><span className="font-mono text-base">${format2(safeNum(p.unitPrice))}</span><span className="text-gray-300">|</span><span className="font-bold text-emerald-600 font-mono text-base">${format2(safeNum(p.amount))}</span></>}
                                                                </div>
                                                                <span className="ml-auto text-base font-bold text-blue-600 font-mono">{safeNum(p.quantity).toLocaleString()} ä»¶</span>
                                                            </div>
                                                            {(p.batchNumber||p.expiryDate)&&<div className="flex gap-2 mt-1 text-xs text-gray-400 font-mono">{p.batchNumber&&<span className="bg-gray-100 px-1.5 rounded">æ‰¹:{p.batchNumber}</span>}{p.expiryDate&&<span className="bg-gray-100 px-1.5 rounded">æ•ˆ:{p.expiryDate}</span>}</div>}
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                {/* å¡ç‰‡åº•éƒ¨åˆè¨ˆèˆ‡ç‹€æ…‹ */}
                                                <div className="mt-3 pt-2 bg-gray-50 -mx-4 -mb-4 p-3 border-t border-gray-200">
                                                    <div className="grid grid-cols-3 gap-2 text-lg mb-2 font-mono font-bold text-gray-700 border-b border-gray-300 pb-2">
                                                        <div className="text-left">{format2(totalWeight)}kg</div>
                                                        {/* V69.0: è¨ªå®¢éš±è—ç¸½é‡‘é¡ */}
                                                        <div className="text-center text-emerald-700">
                                                            {canSeePrice() ? `${currSymbol}${format2(totalAmount)}` : '***'}
                                                        </div>
                                                        <div className="text-right text-blue-700">{totalQty.toLocaleString()}ä»¶</div>
                                                    </div>
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex gap-3 items-center">
                                                            {/* V69.0: è¨ªå®¢éš±è—ä»˜æ¬¾ç‹€æ…‹ */}
                                                            {canSeePrice() && (
                                                                <>
                                                                    <span className={item.isPaid?"amt-paid":"amt-unpaid"}>{item.isPaid?'è²¨æ¬¾å·²ä»˜':'è²¨æ¬¾æœªä»˜'}</span>
                                                                    {item.flightFee > 0 && <span className={item.flightFeePaid?"amt-paid":"amt-unpaid"}>{item.flightFeePaid?'æ—…è²»å·²ä»˜':'æ—…è²»æœªä»˜'}</span>}
                                                                </>
                                                            )}
                                                        </div>
                                                        <label className={`tag-badge cursor-pointer border ${item.warehouseConfirmed ? 'bg-green-100 border-green-200 text-green-700' : 'bg-white border-gray-200 text-gray-400 hover:border-gray-400'}`} onClick={e => e.stopPropagation()}>
                                                            <input type="checkbox" className="w-4 h-4 rounded mr-1 cursor-pointer accent-green-600" checked={item.warehouseConfirmed || false} onChange={(e) => handleWarehouseConfirm(e, item)} disabled={!canEditWarehouseFields()} />
                                                            <span className={item.warehouseConfirmed ? 'font-bold' : ''}>{item.warehouseConfirmed ? 'å·²æ”¶è²¨' : 'ç¢ºèªæ”¶è²¨'}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {view === 'stats' && <Dashboard shipments={shipments} canSeePrice={canSeePrice} />}

                        {/* V75.0: ç”¢å“ä¸»æª”é é¢ */}
                        {view === 'products' && (
                            <div className="space-y-4">
                                {/* é ‚éƒ¨æ“ä½œåˆ— */}
                                <div className="flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-between">
                                    <div className="relative flex-1">
                                        <input 
                                            type="text" 
                                            placeholder={TEXT.PRODUCTS_SEARCH_HINT}
                                            value={productSearchTerm}
                                            onChange={e => setProductSearchTerm(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2.5 bg-white border rounded-xl text-sm"
                                        />
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><I.Search /></span>
                                    </div>
                                    {canCreate() && (
                                        <div className="flex gap-2">
                                            <label className="px-4 py-2.5 bg-emerald-500 text-white rounded-xl font-bold text-sm cursor-pointer hover:bg-emerald-600 transition-colors flex items-center gap-2">
                                                {TEXT.PRODUCTS_IMPORT}
                                                <input type="file" accept=".xlsx,.xls" onChange={handleProductExcelImport} className="hidden" />
                                            </label>
                                            <button 
                                                onClick={() => { setEditingProduct({...initialProductState}); setShowProductModal(true); }}
                                                className="px-4 py-2.5 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition-colors"
                                            >
                                                {TEXT.PRODUCTS_ADD}
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* çµ±è¨ˆè³‡è¨Š */}
                                <div className="bg-white rounded-xl p-4 border shadow-sm">
                                    <div className="flex gap-6 text-sm">
                                        <div><span className="text-gray-500">ç¸½ç”¢å“æ•¸ï¼š</span><span className="font-bold text-blue-600">{products.length}</span></div>
                                        <div><span className="text-gray-500">å•Ÿç”¨ä¸­ï¼š</span><span className="font-bold text-emerald-600">{products.filter(p => p.isActive !== false).length}</span></div>
                                        <div><span className="text-gray-500">æœå°‹çµæœï¼š</span><span className="font-bold">{filteredProducts.length}</span></div>
                                    </div>
                                </div>

                                {/* ç”¢å“åˆ—è¡¨ */}
                                {filteredProducts.length === 0 ? (
                                    <div className="bg-white rounded-xl p-8 border shadow-sm text-center text-gray-400">
                                        {products.length === 0 ? TEXT.PRODUCTS_EMPTY : 'ç„¡ç¬¦åˆæœå°‹æ¢ä»¶çš„ç”¢å“'}
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-50 border-b">
                                                    <tr>
                                                        <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_ID}</th>
                                                        <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_NAME}</th>
                                                        <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_SPEC}</th>
                                                        <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_UNIT}</th>
                                                        <th className="px-3 py-3 text-right font-bold text-gray-600">{TEXT.PRODUCT_DEFAULT_PRICE}</th>
                                                        <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_DEFAULT_SUPPLIER}</th>
                                                        <th className="px-3 py-3 text-center font-bold text-gray-600">æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredProducts.slice(0, 100).map((p, idx) => (
                                                        <tr key={p.id} className={`border-b hover:bg-blue-50 cursor-pointer ${p.isActive === false ? 'opacity-50 bg-gray-50' : ''} ${idx % 2 === 0 ? '' : 'bg-gray-50/50'}`}
                                                            onClick={() => { setEditingProduct({...p}); setShowProductModal(true); }}>
                                                            <td className="px-3 py-2.5 font-mono text-xs text-gray-500">{p.productId}</td>
                                                            <td className="px-3 py-2.5 font-bold">{p.name} {p.isActive === false && <span className="text-xs text-red-500 ml-1">({TEXT.PRODUCT_INACTIVE})</span>}</td>
                                                            <td className="px-3 py-2.5 text-gray-600">{p.spec || '-'}</td>
                                                            <td className="px-3 py-2.5 text-gray-500">{p.unit || '-'}</td>
                                                            <td className="px-3 py-2.5 text-right text-emerald-600 font-bold">{p.defaultPrice > 0 ? p.defaultPrice.toLocaleString() : '-'}</td>
                                                            <td className="px-3 py-2.5 text-gray-500">{p.defaultSupplier || '-'}</td>
                                                            <td className="px-3 py-2.5 text-center">
                                                                <button onClick={(e) => { e.stopPropagation(); setEditingProduct({...p}); setShowProductModal(true); }} className="text-blue-500 hover:text-blue-700 p-1"><I.Edit /></button>
                                                                {canDelete() && <button onClick={(e) => { e.stopPropagation(); handleDeleteProduct(p); }} className="text-red-400 hover:text-red-600 p-1 ml-1"><I.Trash2 /></button>}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        {filteredProducts.length > 100 && (
                                            <div className="text-center py-3 text-gray-400 text-sm border-t">
                                                é¡¯ç¤ºå‰ 100 ç­†ï¼Œå…± {filteredProducts.length} ç­†ï¼ˆè«‹ä½¿ç”¨æœå°‹ç¸®å°ç¯„åœï¼‰
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'form' && (
                            <div className="ios-card p-5 animate-[fade-in_0.3s_ease-out]">
                                <div className="flex justify-between mb-4 border-b pb-2"><h2 className="font-bold text-lg">{editingId?'ç·¨è¼¯':'æ–°å¢'}</h2><button onClick={()=>setView('list')} className="text-gray-400"><I.X /></button></div>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    {/* V52.0: 1. åŸºç¤è³‡è¨Š (11æ¬„ä½ 4x2 ä½ˆå±€) */}
                                    <div className="bg-white rounded-xl p-3 border border-gray-200 shadow-sm mb-3">
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            <div><label>é€²å£å…¬å¸</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                            <div><label className={!editingId ? 'label-required' : ''}>æ«ƒè™Ÿ</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={!canCreate()} className={`w-full input-bg-style rounded-lg p-2 font-mono uppercase ${validationErrors.containerNumber ? 'input-error' : ''}`} placeholder="æ«ƒè™Ÿ" /></div>
                                            
                                            {/* V63.0 æ–°å¢èˆ¹å…¬å¸ */}
                                            <div><label>èˆ¹å…¬å¸</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="èˆ¹å…¬å¸" /></div>

                                            <div><label className={!editingId ? 'label-required' : ''}>åˆ°æ¸¯æ—¥</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={!canCreate()} className={`w-full input-bg-style rounded-lg p-2 ${validationErrors.arrivalDate ? 'input-error' : ''}`} /></div>
                                            <div><label>å ±é—œè¡Œ</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                            
                                            <div><label>å ±é—œå–®è™Ÿ</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="å ±é—œå–®è™Ÿ" /></div>
                                            <div><label>è¼¸å…¥è¨±å¯è­‰</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="è¨±å¯è­‰è™Ÿ" /></div>
                                            
                                            <div><label className={!editingId ? 'label-required' : ''}>å» å•†</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={!canCreate()} className={`w-full input-bg-style rounded-lg p-2 ${validationErrors.supplier ? 'input-error' : ''}`} placeholder="å» å•†" /></div>
                                            <div><label>ç”¢åœ°</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="ç”¢åœ°" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                            <div><label>æ‹†æ«ƒåœ°</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="åœ°é»" /></div>
                                            <div><label>æ‹†æ«ƒæ—¥</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" /></div>
                                        </div>
                                    </div>
                                    
                                    {/* 2. è²¡å‹™å°ˆå€ (æ©«å‘) */}
                                    {canSeePrice() && (
                                        <div className="bg-blue-50 rounded-xl p-3 border border-blue-100 mb-3 flex flex-wrap items-end gap-3">
                                             <div className="flex-1 min-w-[140px]">
                                                <label>ä»˜æ¬¾æ¢ä»¶</label>
                                                <input value={formData.paymentTerm} disabled className="w-full bg-white border rounded input-bg-style text-xs" />
                                             </div>
                                             {canEditFlightFee() && isForeign(formData) && (
                                                <div className="w-24">
                                                   <label>æ—…è²»</label>
                                                   <input type="number" name="flightFee" value={formData.flightFee} onWheel={e=>e.target.blur()} onChange={handleInputChange} className="w-full bg-white border rounded input-bg-style" placeholder="0" />
                                                </div>
                                             )}
                                             <div className="flex items-center gap-3 pb-2 ml-auto">
                                                <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-5 h-5 accent-green-600"/><span className="font-bold text-green-700 text-xs">è²¨æ¬¾å·²ä»˜</span></label>
                                                {canEditFlightFee() && isForeign(formData) && <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-5 h-5 accent-red-600"/><span className="font-bold text-red-700 text-xs">æ—…è²»å·²ä»˜</span></label>}
                                             </div>
                                        </div>
                                    )}

                                    {/* 3. ç”¢å“æ˜ç´° (ä¹å®®æ ¼ 3x3) */}
                                    <div className="pt-2">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className={`font-bold text-lg ${validationErrors.products ? 'text-red-600' : 'text-gray-700'}`}>
                                                ç”¢å“æ˜ç´° {!editingId && <span className="text-red-500 text-sm">*</span>}
                                                {validationErrors.products && <span className="text-red-500 text-xs ml-2">(è«‹è‡³å°‘å¡«å¯«ä¸€é …å“å)</span>}
                                            </h3>
                                            {(canEditDomesticFull() || canManage()) && <button type="button" onClick={addProductRow} className="text-blue-600 font-bold text-sm hover:underline cursor-pointer">+ æ–°å¢ç”¢å“</button>}
                                        </div>
                                        <div className="space-y-3">{formData.products.map((p, idx) => (
                                            <div key={p.id} className={`bg-white border rounded-xl p-3 relative shadow-sm ${validationErrors.products && idx === 0 ? 'border-red-300' : ''}`}>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {/* V76.0: å“åæ”¹ç‚ºæŒ‰éˆ•è§¸ç™¼é¸æ“‡è¦–çª— */}
                                                    <div className="relative">
                                                        <div 
                                                            onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }}
                                                            className={`input-bg-style rounded p-1 font-bold w-full cursor-pointer flex items-center justify-between ${validationErrors.products && idx === 0 && !p.name?.trim() ? 'input-error' : ''} ${products.length > 0 ? 'hover:bg-blue-50' : ''}`}
                                                        >
                                                            <span className={p.name ? 'text-gray-800' : 'text-gray-400'}>{p.name || 'é»æ“Šé¸æ“‡å“å'}</span>
                                                            {products.length > 0 && <span className="text-blue-500 text-xs">â–¼</span>}
                                                        </div>
                                                    </div>
                                                    <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="è¦æ ¼" />
                                                    <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="input-bg-style rounded p-1 text-sm"><option value="quantity">è¨ˆä»¶</option><option value="weight">è¨ˆé‡</option></select>
                                                    <input type="number" value={p.quantity} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'quantity',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-blue-600" placeholder="ä»¶æ•¸" />
                                                    <input type="number" value={p.weight} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'weight',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-orange-500" placeholder="é‡é‡" />
                                                    
                                                    {/* V69.0: è¨ªå®¢ç·¨è¼¯é éš±è—å–®åƒ¹ */}
                                                    {canSeePrice() ? (
                                                        <input type="number" value={p.unitPrice} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value)} className="input-bg-style rounded p-1 text-right" placeholder="å–®åƒ¹" />
                                                    ) : (
                                                        <div className="input-bg-style rounded p-1 text-right flex items-center justify-end text-gray-300">***</div>
                                                    )}
                                                    
                                                    <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="æ‰¹è™Ÿ" />
                                                    <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="input-bg-style rounded p-1 text-xs" />
                                                    <div className="flex items-center justify-between bg-gray-50 rounded px-2 border border-gray-200">
                                                        {/* V69.0: è¨ªå®¢ç·¨è¼¯é éš±è—å°è¨ˆ */}
                                                        {canSeePrice() ? <span className="font-bold text-emerald-600 text-sm">${format2(safeNum(p.amount))}</span> : <span>***</span>}
                                                        {(canEditDomesticFull() || canManage()) && (
                                                            <div className="flex gap-1">
                                                                <button type="button" onClick={()=>duplicateProductRow(idx)} className="text-gray-400 hover:text-blue-600 p-1"><I.Copy /></button>
                                                                {formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="text-gray-400 hover:text-red-600 p-1"><I.Trash2 /></button>}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}</div>
                                    </div>
                                    
                                    {/* å¤šæª”æ¡ˆä¸Šå‚³ - V51.0 æ¬Šé™é©—è­‰ */}
                                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                        <label className="block text-xs font-bold text-gray-500 mb-2">é™„ä»¶ ({formData.attachments?.length || 0})</label>
                                        <div className="space-y-2">
                                            {(formData.attachments || []).map((file, idx) => (
                                                <div key={idx} className="flex items-center justify-between bg-white p-2 rounded border">
                                                    <a href={file.url} target="_blank" className="text-blue-600 text-xs underline truncate flex-1 mr-2">{file.name}</a>
                                                    {canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}
                                                </div>
                                            ))}
                                        </div>
                                        {canUpload() && (
                                            <div className="mt-2 relative">
                                                <input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                                <button type="button" className="w-full py-2 bg-white border border-dashed border-gray-400 rounded text-gray-500 text-sm font-bold flex items-center justify-center gap-2">
                                                    {uploading ? 'ä¸Šå‚³ä¸­...' : <><I.Paperclip /> é¸æ“‡æª”æ¡ˆ (å¯å¤šé¸)</>}
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex gap-3 pt-2"><button type="button" onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button><button type="submit" disabled={isSubmitting} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">{isSubmitting?'...':'å„²å­˜'}</button></div>
                                </form>
                            </div>
                        )}
                    </main>
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex z-40 pb-safe h-14"><button onClick={()=>setView('list')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='list'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.List /></div><span className="text-xs font-bold">åˆ—è¡¨</span></button>{userRole !== 'GUEST' && <><button onClick={()=>setView('products')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='products'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.Package /></div><span className="text-xs font-bold">ç”¢å“</span></button><button onClick={()=>setView('stats')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='stats'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.Chart /></div><span className="text-xs font-bold">çµ±è¨ˆ</span></button></>}</div>
                </div>
                </ErrorBoundary>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerApp />);
    </script>
</body>
</html>