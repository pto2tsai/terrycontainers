<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>貨櫃管理 (v9.8 終極相容版)</title>
    
    <script>
        // 🚨 全局錯誤捕捉器：如果白畫面，會顯示錯誤原因 🚨
        window.onerror = function(msg, url, line, col, error) {
            var div = document.createElement("div");
            div.style.color = "red";
            div.style.padding = "20px";
            div.style.backgroundColor = "#ffeeee";
            div.style.border = "2px solid red";
            div.style.margin = "20px";
            div.style.zIndex = "9999";
            div.style.position = "relative";
            div.innerHTML = "<h3>⚠️ 系統發生錯誤 (請截圖給工程師)</h3>" +
                            "<b>錯誤訊息:</b> " + msg + "<br>" +
                            "<b>行數:</b> " + line + ":" + col + "<br>" +
                            "<b>網址:</b> " + url;
            document.body.prepend(div);
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        body { background-color: #F3F4F6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #1f2937; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        .ios-card { background: #ffffff; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 16px; overflow: hidden; border: 1px solid #f3f4f6; transition: all 0.2s ease; }
        .ios-card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .tag-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; white-space: nowrap; }
        .btn-icon { display: flex; align-items: center; justify-content: center; border-radius: 9999px; transition: background-color 0.2s; }
        
        .mobile-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 50; display: flex; align-items: flex-start; justify-content: center; padding-top: 60px; backdrop-filter: blur(4px); }
        .mobile-modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); overflow: hidden; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        input:focus, select:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); outline: none; border-color: #3b82f6; }
        input:disabled, select:disabled { background-color: #f9fafb; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb; }
        .custom-checkbox { width: 1.25rem; height: 1.25rem; border-radius: 0.25rem; border: 2px solid #d1d5db; cursor: pointer; accent-color: #2563eb; }
        
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; font-weight: 600; color: #6b7280; transition: all 0.2s; cursor: pointer; }
        .sidebar-link:hover { background-color: #f3f4f6; color: #1f2937; }
        .sidebar-link.active { background-color: #eff6ff; color: #2563eb; }
        
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 8px 0; color: #9ca3af; font-size: 10px; font-weight: 600; cursor: pointer; }
        .bottom-nav-item.active { color: #2563eb; }
        .nav-icon { width: 24px; height: 24px; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const Icons = {
            Ship: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.8 8"/><path d="M10 10 4.72 7.28a1 1 0 0 1 .11-1.79l9-4a1 1 0 0 1 .9 0l8.26 3.67a1 1 0 0 1 .13 1.77L14 10"/><path d="m14 10-4 4-4-3.7"/></svg>,
            Anchor: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Search: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Copy: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            FileCheck: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            Globe: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Factory: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>,
            Paperclip: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Download: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-3-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            LogOut: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Google: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"></path></svg>,
            X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Check: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Bell: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            MessageCircle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            User: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Barcode: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-full h-full"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Calendar: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            BoxCheck: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 8l-2-2H5L3 8h18z"/><path d="M3 8v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>,
            Chart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            List: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
        };

        const { useState, useEffect, useMemo } = React;
        const IMPORT_COMPANIES=['崇文冷凍','八方環球'], CUSTOMS_BROKERS=['原碩','尚鴻','國內採購'], DEFAULT_ORIGINS=['厄瓜多','巴拿馬','瓜地馬拉','宏都拉斯','泰國','印尼','印度','中國','智利','挪威'];
        const ADMIN_EMAILS=["pto2.tw@gmail.com","bapbts0901@gmail.com","4onlymerich@gmail.com"];

        const firebaseConfig = {apiKey:"AIzaSyDvMBng2Zhbk6sVaZLSuER2KT6qqeoCdnw",authDomain:"containersystem-6342f.firebaseapp.com",projectId:"containersystem-6342f",storageBucket:"containersystem-6342f.firebasestorage.app",messagingSenderId:"27658303054",appId:"1:27658303054:web:d7a3710054ede268cdf51f"};
        
        let db, auth, storage;
        try { firebase.initializeApp(firebaseConfig); db=firebase.firestore(); auth=firebase.auth(); storage=firebase.storage(); } catch(e){console.error(e);}

        const parseDate = (d) => { if(!d)return new Date(0); const p=d.split('-'); if(p.length!==3)return new Date(0); return new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2]),0,0,0,0); };
        
        const getStatusStyle = (d) => {
            if(!d) return { bg:'bg-gray-100', text:'未定', color:'text-gray-400' };
            const now = parseDate(new Date().toISOString().split('T')[0]);
            const arr = parseDate(d);
            const diff = Math.round((arr-now)/86400000);
            if(diff<0) return { text:'已到港', color:'bg-gray-100 text-gray-500' };
            if(diff===0) return { text:'今日到港', color:'bg-red-100 text-red-600 animate-pulse' };
            if(diff===1) return { text:'明天到港', color:'bg-orange-100 text-orange-600' };
            return { text:`${diff} 天後`, color:'bg-blue-100 text-blue-600' };
        };

        const getCompanyColor = (n) => n==='崇文冷凍'?'bg-blue-100 text-blue-700':(n==='八方環球'?'bg-emerald-100 text-emerald-700':'bg-gray-200 text-gray-700');

        // Dashboard 獨立元件
        const Dashboard = ({ shipments, canSeePrice }) => {
            const [tf, setTf] = useState('MONTH');
            const stats = useMemo(() => {
                const now = new Date();
                const list = shipments.filter(s => {
                    if(!s.arrivalDate) return false;
                    const d = new Date(s.arrivalDate);
                    if(tf==='MONTH') return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
                    if(tf==='YEAR') return d.getFullYear()===now.getFullYear();
                    return true;
                });
                const count = list.length;
                const items = list.reduce((s, i) => s + (Number(i.totalQuantity)||0), 0);
                const w = list.reduce((s, i) => s + (Number(i.totalWeight)||0), 0);
                const money = list.reduce((s, i) => s + ((i.products||[]).reduce((a, p) => a + (Number(p.amount)||0), 0)||0), 0);
                const supps = {}; list.forEach(s => { const n = s.supplier || '未填'; supps[n] = (supps[n] || 0) + 1; });
                const top = Object.entries(supps).sort((a, b) => b[1] - a[1]).slice(0, 5);
                return { count, items, w, money, top };
            }, [shipments, tf]);
            const maxVal = (stats.top.length > 0 && stats.top[0][1] > 0) ? stats.top[0][1] : 1;
            return (
                <div className="space-y-4 animate-[fade-in_0.3s_ease-out]">
                     <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-gray-800">統計儀表板</h2><div className="flex bg-white rounded-lg p-1 border shadow-sm">{['MONTH','YEAR','ALL'].map(k=><button key={k} onClick={()=>setTf(k)} className={`px-3 py-1 text-xs font-bold rounded-md transition-colors ${tf===k?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-50'}`}>{k==='MONTH'?'本月':k==='YEAR'?'本年':'全部'}</button>)}</div></div>
                     <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">總筆數</div><div className="text-2xl font-black text-gray-800">{stats.count}</div></div>
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">總件數</div><div className="text-2xl font-black text-blue-600">{stats.items.toLocaleString()}</div></div>
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">總重量 (kg)</div><div className="text-2xl font-black text-orange-500">{parseInt(stats.w).toLocaleString()}</div></div>
                        {canSeePrice && <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">採購金額</div><div className="text-2xl font-black text-emerald-600">${stats.money.toLocaleString()}</div></div>}
                     </div>
                     <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">🏆 前五大廠商</h3><div className="space-y-3">{stats.top.map(([n,c],i)=><div key={n} className="flex items-center gap-3"><div className="w-6 text-xs font-bold text-gray-400">#{i+1}</div><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-gray-700">{n}</span><span className="text-gray-500">{c} 筆</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width:`${(c/maxVal)*100}%`}}></div></div></div></div>)}</div></div>
                </div>
            );
        };

        function ContainerApp() {
            const [user, setUser] = useState(null);
            const [shipments, setShipments] = useState([]);
            const [view, setView] = useState('list');
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            const [currentTab, setCurrentTab] = useState('NOT_DEVANED'); 
            const [userRole, setUserRole] = useState('GUEST');

            useEffect(() => { auth.onAuthStateChanged(u=>{setUser(u); if(!u)setLoading(false);}); }, []);
            useEffect(() => {
                if(!user || !db) return;
                const unsubDB = db.collection('shipments').onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({id:doc.id, ...doc.data()}));
                    data.sort((a,b) => {
                        const da = a.arrivalDate ? new Date(a.arrivalDate).getTime() : 0;
                        const db = b.arrivalDate ? new Date(b.arrivalDate).getTime() : 0;
                        return db - da;
                    });
                    setShipments(data); setLoading(false);
                });
                const unsubSet = db.collection('settings').doc('config').onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        if(d.user_roles && d.user_roles[user.email]) setUserRole(d.user_roles[user.email]);
                        else if(d.admin_emails && d.admin_emails.includes(user.email)) setUserRole('PURCHASING');
                        else setUserRole('GUEST');
                    } else if(ADMIN_EMAILS.includes(user.email)) setUserRole('PURCHASING');
                }, err=>console.log(err));
                return () => { unsubDB(); unsubSet(); };
            }, [user]);

            const handleAdminLogin = async () => { try{await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}catch(e){alert(e.message);} };
            const handleGuestLogin = async () => { try{await auth.signInAnonymously();}catch(e){alert("Error");} };
            const handleLogout = () => auth.signOut();

            const canEdit=()=>['PURCHASING','WAREHOUSE'].includes(userRole);
            const canCreate=()=>['PURCHASING'].includes(userRole);
            const canDelete=()=>['PURCHASING'].includes(userRole);
            const canUpload=()=>['PURCHASING','QC'].includes(userRole);
            const canSeePrice=()=>['PURCHASING','ACCOUNTING'].includes(userRole);
            const isWarehouse=()=>userRole==='WAREHOUSE';

            const initialFormState = { importCompany: IMPORT_COMPANIES[0], customsBroker: CUSTOMS_BROKERS[0], origin:'', supplier:'', arrivalDate: new Date().toISOString().split('T')[0], containerNumber:'', shippingCompany:'', products:[{id:Date.now(), name:'', batchNumber:'', expiryDate:'', spec:'', boxCapacity:1, quantity:0, weight:0, unitPrice:0, amount:0, pricingMode:'quantity'}], totalQuantity:0, totalWeight:0, docUrl:'', docName:'', docRefPath:'', devanningLocation:'', devanningDate:'', warehouseConfirmed:false };
            const [formData, setFormData] = useState(initialFormState);

            const handleInputChange = (e) => { const {name,value,type,checked} = e.target; setFormData(p => ({...p, [name]: name==='containerNumber' ? value.toUpperCase() : (type==='checkbox'?checked:value)})); };
            const handleProductChange = (idx, f, v) => {
                const np = [...formData.products]; np[idx] = { ...np[idx], [f]: v };
                const p = np[idx];
                const q=Number(p.quantity)||0, b=Number(p.boxCapacity)||1, w=Number(p.weight)||0, u=Number(p.unitPrice)||0;
                p.amount = Math.round(p.pricingMode==='weight' ? w*u : q*b*u);
                setFormData(prev => ({...prev, products:np, totalQuantity: np.reduce((s,i)=>s+(Number(i.quantity)||0),0), totalWeight: np.reduce((s,i)=>s+(Number(i.weight)||0),0)}));
            };

            const addRow = () => setFormData(p => ({...p, products:[...p.products, {id:Date.now(), name:'', batchNumber:'', expiryDate:'', spec:'', boxCapacity:1, quantity:0, weight:0, unitPrice:0, amount:0, pricingMode:'quantity'}]}));
            const dupRow = (i) => { const np=[...formData.products]; np.splice(i+1,0,{...formData.products[i], id:Date.now()}); setFormData(p=>({...p, products:np})); };
            const rmRow = (i) => { const np=formData.products.filter((_,x)=>x!==i); setFormData(p=>({...p, products:np, totalQuantity: np.reduce((s,x)=>s+(Number(x.quantity)||0),0), totalWeight: np.reduce((s,x)=>s+(Number(x.weight)||0),0)})); };
            
            const handleFile = async(e) => {
                const f = e.target.files[0]; if(!f) return; setUploading(true);
                try { const r = storage.ref(`docs/${Date.now()}_${f.name}`); await r.put(f); const u = await r.getDownloadURL(); setFormData(p=>({...p, docUrl:u, docName:f.name, docRefPath:r.fullPath})); } catch(e){alert(e.message);} finally{setUploading(false);}
            };
            const delFile = async() => { if(formData.docRefPath) try{await storage.ref(formData.docRefPath).delete();}catch(e){console.warn(e);} setFormData(p=>({...p, docUrl:'', docName:'', docRefPath:''})); };

            const submit = async(e) => {
                e.preventDefault(); if(!canEdit()) return alert('權限不足');
                if(formData.customsBroker!=='國內採購' && !formData.containerNumber) return alert('請輸入櫃號');
                setIsSubmitting(true);
                try {
                    const pl = {...formData, updatedAt: new Date().toISOString()};
                    if(editingId) await db.collection('shipments').doc(editingId).update(pl);
                    else await db.collection('shipments').add({...pl, createdAt: new Date().toISOString()});
                    setFormData(initialFormState); setEditingId(null); setView('list');
                } catch(e){alert(e.message);} finally{setIsSubmitting(false);}
            };

            const share = (s) => {
                const isDom = s.customsBroker === '國內採購';
                const unit = ' 件';
                const dets = (s.products||[]).map((p,i) => `${i+1}. ${p.name}${p.spec?` ${p.spec}`:''} - ${p.quantity.toLocaleString()}${unit}${p.weight?` / ${p.weight}kg`:''}${p.batchNumber?` [批:${p.batchNumber}]`:''}`).join('\n');
                const loc = s.devanningLocation ? `\n📍 ${isDom?'交貨地':'拆櫃地'}：${s.devanningLocation}` : '';
                const date = (!isDom && s.devanningDate) ? `\n🕒 拆櫃日：${s.devanningDate}` : '';
                const txt = isDom ? `🚚 到貨通知(國內採購)\n📅 日期：${s.arrivalDate}\n🏢 公司：${s.importCompany}\n🏭 廠商：${s.supplier||'未填'}\n🌎 產地：${s.origin||'未填'}${loc}\n\n📋 明細：\n${dets}\n\n🔢 總數：${(s.totalQuantity||0).toLocaleString()}${unit}` 
                                  : `🚢 到港通知\n📦 櫃號：${s.containerNumber}\n📅 日期：${s.arrivalDate}\n🏢 公司：${s.importCompany}\n🏭 廠商：${s.supplier||'未填'}\n🌎 產地：${s.origin||'未填'}${loc}${date}\n\n📋 明細：\n${dets}\n\n🔢 總數：${(s.totalQuantity||0).toLocaleString()}${unit}`;
                window.open(`https://line.me/R/msg/text/?${encodeURIComponent(txt)}`, '_blank');
            };

            const confirmWH = async(e, item) => { e.stopPropagation(); if(!canEdit()) return alert('權限不足'); await db.collection('shipments').doc(item.id).update({warehouseConfirmed: !item.warehouseConfirmed}); };

            const filtered = useMemo(() => {
                const t = searchTerm.toLowerCase();
                return shipments.filter(s => s.containerNumber?.toLowerCase().includes(t) || s.supplier?.toLowerCase().includes(t) || (s.products||[]).some(p=>p.name.toLowerCase().includes(t) || p.batchNumber?.toLowerCase().includes(t)));
            }, [shipments, searchTerm]);
            
            const todayStr = new Date().toISOString().split('T')[0];
            const isDom = s => (s.customsBroker||'').includes('國內採購');
            const curList = useMemo(() => {
                if(currentTab==='DOMESTIC') return filtered.filter(s=>isDom(s));
                const foreign = filtered.filter(s=>!isDom(s));
                if(currentTab==='DEVANED') return foreign.filter(s=>s.devanningDate && s.devanningDate <= todayStr);
                return foreign.filter(s=>!s.devanningDate || s.devanningDate > todayStr);
            }, [currentTab, filtered, todayStr]);

            const urgentShipments = useMemo(() => { const today=new Date(); today.setHours(0,0,0,0); return shipments.filter(s => { if(!s.arrivalDate)return false; const d = Math.ceil((new Date(s.arrivalDate)-today)/86400000); return d>=0 && d<=3; }); }, [shipments]);
            const urgentCount = urgentShipments.length;

            if(!user) return (
                <div className="flex h-screen items-center justify-center bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                        <div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200"><Icons.Ship /></div>
                        <h1 className="text-2xl font-bold mb-6">貨櫃管理</h1>
                        <button onClick={handleAdminLogin} className="w-full py-3 mb-3 bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center gap-2"><Icons.Google /> 員工登入</button>
                        <button onClick={handleGuestLogin} className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold flex items-center justify-center gap-2"><Icons.User /> 訪客登入</button>
                    </div>
                </div>
            );

            return (
                <div className="flex min-h-screen bg-slate-100 text-slate-800 pb-20 md:pb-0">
                    <aside className="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 fixed h-full z-20">
                        <div className="p-6 flex items-center gap-3 font-bold text-xl text-gray-800"><div className="w-8 text-blue-600"><Icons.Ship /></div>貨櫃管理</div>
                        <nav className="flex-1 px-4 space-y-2">
                            <button onClick={()=>setView('list')} className={`sidebar-link w-full ${view==='list'?'active':''}`}><div className="nav-icon"><Icons.List /></div>貨櫃列表</button>
                            <button onClick={()=>setView('stats')} className={`sidebar-link w-full ${view==='stats'?'active':''}`}><div className="nav-icon"><Icons.Chart /></div>統計分析</button>
                        </nav>
                        <div className="p-4 border-t border-gray-100"><div className="text-sm font-bold truncate">{user.displayName||'訪客'}</div><div className="text-xs text-gray-400 mb-2">{userRole}</div><button onClick={handleLogout} className="text-red-500 text-sm flex items-center gap-2"><Icons.LogOut />登出</button></div>
                    </aside>

                    <div className="flex-1 md:ml-64">
                        <header className="md:hidden sticky top-0 z-30 bg-white/90 backdrop-blur border-b px-4 h-14 flex items-center justify-between">
                            <div className="flex items-center gap-2 font-bold text-gray-900"><div className="w-6 text-blue-600"><Icons.Ship /></div>{view==='list'?'列表':'統計'}</div>
                            <div className="flex gap-3 items-center">
                                {urgentCount>0 && <div className="relative text-red-500 animate-pulse"><Icons.Bell /><span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></span></div>}
                                {canCreate() && view==='list' && <button onClick={()=>{setFormData(initialFormState); setEditingId(null); setView('form');}} className="text-blue-600"><div className="w-6"><Icons.Plus /></div></button>}
                            </div>
                        </header>

                        <main className="max-w-3xl mx-auto p-4">
                            {view === 'list' ? (
                                <div className="space-y-4">
                                    <div className="flex justify-between bg-white rounded-xl p-1 shadow-sm border border-gray-200 overflow-x-auto">
                                        {['NOT_DEVANED','DEVANED','DOMESTIC'].map(t=>{
                                            let list = [];
                                            if(t==='DOMESTIC') list = filtered.filter(x=>isDom(x));
                                            else if(t==='DEVANED') list = filtered.filter(x=>!isDom(x)&&x.devanningDate&&x.devanningDate<=todayStr);
                                            else list = filtered.filter(x=>!isDom(x)&&(!x.devanningDate||x.devanningDate>todayStr));
                                            const un = list.filter(i => !i.warehouseConfirmed).length;
                                            return <button key={t} onClick={()=>setCurrentTab(t)} className={`flex-1 py-2 px-2 text-sm font-bold rounded-lg whitespace-nowrap ${currentTab===t?'bg-blue-600 text-white':'text-gray-500 hover:bg-gray-100'}`}><div className="flex items-center justify-center gap-1"><span>{t==='NOT_DEVANED'?'未拆櫃':t==='DEVANED'?'已拆櫃':'國內'} ({list.length})</span>{un>0&&<span className={`text-xs ml-1 ${currentTab===t?'text-yellow-200':'text-red-500'}`}>({un})</span>}</div></button>
                                        })}
                                    </div>
                                    <div className="relative"><div className="absolute left-3 top-2.5 text-gray-400 w-4"><Icons.Search /></div><input placeholder="搜尋櫃號、廠商、貨品、批號..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full bg-white text-gray-900 placeholder-gray-400 rounded-xl py-2 pl-10 pr-4 outline-none shadow-sm" /></div>
                                    <div className="grid gap-4">
                                        {curList.map(item => {
                                            const isDev = item.devanningDate && item.devanningDate <= todayStr;
                                            const st = getStatusStyle(item.arrivalDate);
                                            const dateShow = new Date(item.arrivalDate);
                                            const isL = isDom(item);
                                            return (
                                                <div key={item.id} className="ios-card" onClick={()=>{if(canEdit()){setFormData(item); setEditingId(item.id); setView('form');}}}>
                                                    <div className="p-4 border-b flex gap-4">
                                                        <div className={`w-14 flex flex-col items-center justify-center rounded-xl border ${isDev?'bg-green-50 text-green-600':st.bg} h-16`}>
                                                            <span className="text-[10px] font-bold uppercase">{dateShow ? dateShow.toLocaleString('default',{month:'short'}) : '-'}</span>
                                                            <span className="text-xl font-bold leading-none">{dateShow ? dateShow.getDate() : '-'}</span>
                                                            <span className={`text-[9px] font-bold ${isDev?'text-green-600':st.color}`}>{isDev?'已拆櫃':st.text}</span>
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex justify-between mb-1">
                                                                <div className="flex-1 min-w-0">
                                                                    <span className={`inline-block px-2 py-0.5 rounded text-xs font-bold bg-blue-50 text-blue-700 mb-1 ${getCompanyColor(item.importCompany)}`}>{item.importCompany}</span>
                                                                    <div className="font-mono font-bold text-lg truncate">{item.containerNumber}</div>
                                                                </div>
                                                                <div className="flex gap-3 ml-2 shrink-0">
                                                                    {item.docUrl && <a href={item.docUrl} target="_blank" onClick={e=>e.stopPropagation()} className="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-blue-600"><Icons.Paperclip /></a>}
                                                                    <button onClick={e=>{e.stopPropagation(); share(item);}} className="w-8 h-8 bg-green-50 rounded-full flex items-center justify-center text-green-600"><Icons.MessageCircle /></button>
                                                                    {canEdit() && <button onClick={e=>{e.stopPropagation(); setFormData(item); setEditingId(item.id); setView('form');}} className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600"><Icons.Edit /></button>}
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-wrap gap-2 items-center">
                                                                <div className="tag-badge bg-gray-100 text-gray-600"><div className="w-3"><Icons.FileCheck /></div>{item.customsBroker}</div>
                                                                {item.origin && <div className="tag-badge bg-gray-100 text-gray-600"><div className="w-3"><Icons.Globe /></div>{item.origin}</div>}
                                                                <div onClick={e=>confirmWH(e,item)} className={`tag-badge cursor-pointer border ${item.warehouseConfirmed?'bg-green-100 text-green-700 border-green-200':'bg-white border-gray-200 text-gray-400'}`}><div className="w-3"><Icons.BoxCheck /></div>{item.warehouseConfirmed?'已收貨':'確認'}</div>
                                                                {isL?(item.devanningLocation && <div className="tag-badge bg-red-100 text-red-600"><div className="w-3"><Icons.Briefcase /></div>交貨:{item.devanningLocation}</div>):(<>{item.devanningLocation && <div className="tag-badge bg-red-100 text-red-600"><div className="w-3"><Icons.Briefcase /></div>{item.devanningLocation}</div>}{item.devanningDate && <div className="tag-badge bg-red-100 text-red-600"><div className="w-3"><Icons.Calendar /></div>拆:{item.devanningDate}</div>}</>)}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="p-4 space-y-3">
                                                        {(item.products||[]).map((p,x)=>(<div key={x} className="flex justify-between border-b last:border-0 pb-2 last:pb-0"><div><div className="font-bold text-sm">{p.name} <span className="text-gray-400 text-xs font-normal">{p.spec}</span></div><div className="flex gap-2 mt-1">{p.batchNumber&&<span className="text-[11px] font-mono bg-gray-100 px-1.5 rounded">批:{p.batchNumber}</span>}{p.expiryDate&&<span className="text-[11px] font-mono bg-gray-100 px-1.5 rounded">效:{p.expiryDate}</span>}</div><div className="mt-1 text-xs text-gray-400">{p.pricingMode==='weight'?<span className="text-orange-500 font-bold">[重]</span>:<span className="text-blue-500 font-bold">[數]</span>}{p.weight>0&&<span className="ml-1">重:{p.weight}kg</span>}{canSeePrice()&&<span className="ml-2">${(p.amount||0).toLocaleString()}</span>}</div></div><div className="text-right font-mono font-bold text-base text-gray-700">{p.quantity.toLocaleString()} 件</div></div>))}</div><div className="px-4 pb-3 border-t flex justify-between text-xs text-gray-500 pt-2">{item.totalWeight>0&&<span>總重: {parseInt(item.totalWeight||0).toLocaleString()} kg</span>}<div className="ml-auto font-bold text-blue-600 text-sm">{(item.totalQuantity||0).toLocaleString()} 件</div></div></div>)})}
                                        {curList.length===0 && <div className="text-center py-12 text-gray-400 text-sm">查無資料</div>}
                                    </div>
                                </div>
                            ) : view === 'stats' ? <Dashboard shipments={shipments} canSeePrice={canSeePrice()} /> : (
                                <div className="max-w-2xl mx-auto ios-card p-5 animate-[fade-in_0.3s_ease-out]">
                                    <div className="flex justify-between mb-4 border-b pb-2"><h2 className="font-bold text-lg">{editingId?'編輯':'新增'}貨櫃</h2><button onClick={()=>setView('list')} className="text-gray-400"><div className="w-6"><Icons.X /></div></button></div>
                                    <form onSubmit={submit} className="space-y-4">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="text-xs font-bold text-gray-400">公司</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={isWarehouse()} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                            <div><label className="text-xs font-bold text-gray-400">櫃號</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={isWarehouse()} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none uppercase" placeholder={formData.customsBroker==='國內採購'?'免填':'TEMU...'} /></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="text-xs font-bold text-gray-400">{formData.customsBroker==='國內採購'?'到貨日':'到港日'}</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={isWarehouse()} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none" /></div>
                                            <div><label className="text-xs font-bold text-gray-400">報關行</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={isWarehouse()} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                        </div>
                                        <div><label className="text-xs font-bold text-gray-400">船公司</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} disabled={isWarehouse()} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none" /></div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="text-xs font-bold text-gray-400">產地</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} disabled={isWarehouse()} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o}/>)}</datalist></div>
                                            <div><label className="text-xs font-bold text-gray-400">廠商</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={isWarehouse()} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none" /></div>
                                        </div>
                                        
                                        <div className="pt-3 border-t border-gray-100">
                                            <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-sm text-gray-900">{formData.customsBroker==='國內採購'?'交貨資訊':'拆櫃資訊'}</h3><div className="flex items-center gap-2"><input type="checkbox" name="warehouseConfirmed" checked={formData.warehouseConfirmed} onChange={handleInputChange} className="custom-checkbox" id="wc" /><label htmlFor="wc" className="text-xs font-bold text-blue-600">已收貨</label></div></div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none" placeholder="地點" />
                                                <input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} className="w-full bg-gray-50 rounded px-3 py-2 text-sm outline-none" />
                                            </div>
                                        </div>

                                        <div className="space-y-3 pt-3 border-t border-gray-100">
                                            <div className="flex justify-between"><h3 className="font-bold text-sm">產品明細</h3>{!isWarehouse() && <button type="button" onClick={addProductRow} className="text-blue-600 text-xs font-bold">+ 新增</button>}</div>
                                            {formData.products.map((p,i)=>(
                                                <div key={i} className="bg-white border rounded-xl p-3 shadow-sm space-y-2 relative">
                                                    <div><label className="text-xs text-gray-400">品名</label><input value={p.name} onChange={e=>handleProductChange(i,'name',e.target.value)} disabled={isWarehouse()} className="w-full border-b outline-none text-sm font-bold" /></div>
                                                    <div className="grid grid-cols-12 gap-2">
                                                        <div className="col-span-4"><label className="text-xs text-gray-400">規格</label><input value={p.spec} onChange={e=>handleProductChange(i,'spec',e.target.value)} disabled={isWarehouse()} className="w-full border-b outline-none text-sm" /></div>
                                                        {p.pricingMode==='quantity' && <div className="col-span-2"><label className="text-xs text-gray-400">箱容</label><input type="number" value={p.boxCapacity} onChange={e=>handleProductChange(i,'boxCapacity',e.target.value)} disabled={isWarehouse()} className="w-full border-b outline-none text-sm text-center" /></div>}
                                                        <div className={p.pricingMode==='quantity'?"col-span-3":"col-span-4"}><label className="text-xs text-gray-400">件數</label><input type="number" value={p.quantity} onChange={e=>handleProductChange(i,'quantity',Number(e.target.value))} className="w-full border-b outline-none text-sm text-center text-blue-600 font-bold" /></div>
                                                        <div className={p.pricingMode==='quantity'?"col-span-3":"col-span-4"}><label className="text-xs text-gray-400">重量</label><input type="number" value={p.weight} onChange={e=>handleProductChange(i,'weight',Number(e.target.value))} className="w-full border-b outline-none text-sm text-center text-orange-500" /></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <input placeholder="批號" value={p.batchNumber} onChange={e=>handleProductChange(i,'batchNumber',e.target.value)} className="w-full bg-gray-50 rounded px-2 py-1 text-xs outline-none" />
                                                        <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(i,'expiryDate',e.target.value)} className="w-full bg-gray-50 rounded px-2 py-1 text-xs outline-none" />
                                                    </div>
                                                    <div className="flex justify-between items-center mt-1">
                                                        <select value={p.pricingMode} onChange={e=>handleProductChange(i,'pricingMode',e.target.value)} disabled={isWarehouse()} className="text-[10px] bg-gray-100 rounded px-1"><option value="quantity">依數量</option><option value="weight">依重量</option></select>
                                                        {canSeePrice() && <span className="text-xs font-mono text-gray-500">${(p.amount||0).toLocaleString()}</span>}
                                                    </div>
                                                    {!isWarehouse() && <div className="absolute top-2 right-2 flex gap-2"><button type="button" onClick={()=>duplicateProductRow(i)} className="text-gray-400"><Icons.Copy /></button><button type="button" onClick={()=>removeProductRow(i)} className="text-red-400"><Icons.X /></button></div>}
                                                </div>
                                            ))}
                                            <div className="text-right text-sm font-bold text-gray-500">Total: {formData.totalQuantity} 件 / {formData.totalWeight} kg</div>
                                        </div>

                                        <div className="pt-3 border-t">
                                            <label className="text-xs font-bold text-gray-400">附件</label>
                                            <div className="flex items-center justify-between bg-gray-50 rounded p-2 mt-1">
                                                {formData.docUrl ? <a href={formData.docUrl} target="_blank" className="text-blue-600 text-xs underline truncate">{formData.docName}</a> : <span className="text-xs text-gray-400">無附件</span>}
                                                {canUpload() && (formData.docUrl ? <button type="button" onClick={handleDeleteFile} className="text-red-500"><Icons.Trash2 /></button> : <div className="relative"><input type="file" onChange={handleFileUpload} className="absolute inset-0 opacity-0" /><Icons.Paperclip /></div>)}
                                            </div>
                                        </div>

                                        <div className="flex gap-3 pt-2">
                                            <button type="button" onClick={()=>setView('list')} className="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-600">取消</button>
                                            <button type="submit" disabled={isSubmitting} className="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white shadow-lg">{isSubmitting?'...':'儲存'}</button>
                                        </div>
                                    </form>
                                </div>
                            )}
                        </main>

                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-2 flex justify-between z-40 pb-safe">
                            <button onClick={()=>setView('list')} className={`bottom-nav-item ${view==='list'?'active':''}`}><div className="bottom-nav-icon"><Icons.List /></div><span>列表</span></button>
                            <button onClick={()=>setView('stats')} className={`bottom-nav-item ${view==='stats'?'active':''}`}><div className="bottom-nav-icon"><Icons.Chart /></div><span>統計</span></button>
                            <button onClick={handleLogout} className="bottom-nav-item text-red-400"><div className="bottom-nav-icon"><Icons.LogOut /></div><span>登出</span></button>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerApp />);
    </script>
</body>
</html>