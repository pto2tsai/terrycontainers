<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>貨櫃管理系統 (v45.0 穩定與優化版)</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg && msg.toLowerCase().indexOf("script error") > -1) return false;
            setTimeout(function() {
                var root = document.getElementById('root');
                if (root && root.innerHTML.trim().length > 0 && root.innerHTML.indexOf('系統啟動中') === -1) return;
                
                var div = document.createElement("div");
                div.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:white; color:#333; padding:20px; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;";
                div.innerHTML = `<h2 style="color:#dc2626;font-size:20px;font-weight:bold;margin-bottom:10px">⚠️ 系統載入異常</h2><div style="background:#f3f4f6;padding:15px;border:1px solid #ddd;border-radius:8px;font-size:12px;text-align:left;max-width:90%;overflow:auto;margin-bottom:20px">Line: ${line}<br>${msg}</div><button onclick="window.location.reload()" style="padding:12px 30px;background:#2563eb;color:white;border:none;border-radius:50px;font-weight:bold;cursor:pointer;">重新整理</button>`;
                document.body.appendChild(div);
                var loader = document.getElementById('loading-screen');
                if(loader) loader.style.display = 'none';
            }, 3000);
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        body { background-color: #F3F4F6; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; color: #1f2937; margin: 0; }
        
        /* Loading */
        #loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI */
        .ios-card { background: #ffffff; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid #e5e7eb; overflow: hidden; }
        .ios-card:active { transform: scale(0.995); transition: transform 0.1s; }
        
        .reconcile-table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
        .reconcile-table th { background: #f9fafb; color: #6b7280; font-weight: 600; padding: 10px 6px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .reconcile-table td { padding: 10px 6px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; }
        .reconcile-table tr:hover { background-color: #f9fafb; cursor: pointer; }
        
        .amt-paid { color: #111827; font-weight: 800; font-family: monospace; font-size: 16px; }
        .amt-unpaid { background-color: white; color: #dc2626; border: 1px solid #ef4444; border-radius: 4px; padding: 0 6px; font-weight: 700; font-family: monospace; font-size: 16px; white-space: nowrap; display: inline-block; }

        .tag-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; white-space: nowrap; }
        .company-tag { font-size: 16px; font-weight: 800; padding: 4px 10px; border-radius: 6px; display: inline-block; }
        
        /* V44.0: 輸入框樣式 (白底) */
        .input-bg-style { background-color: #ffffff; border: 1px solid #d1d5db; color: #111827; transition: all 0.2s; }
        .input-bg-style:focus { border-color: #3b82f6; outline: 2px solid #bfdbfe; }
        
        /* V44.0: 隱藏數字框箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .product-grid-cols { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 2px; }

        /* 彈窗 */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 400px; max-height: 80vh; border-radius: 20px; padding: 20px; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div><div style="margin-top:15px;color:#666;font-weight:bold">系統啟動中...</div></div>
    <div id="root"></div>

    <script>
        setTimeout(function() {
            var loader = document.getElementById('loading-screen');
            if(loader) loader.remove();
        }, 3500);
    </script>

    <script type="text/babel">
        // --- 0. Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center"><h1 className="text-xl font-bold text-red-600">⚠️ 發生錯誤</h1><button onClick={()=>window.location.reload()} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded">重整</button></div>;
                return this.props.children;
            }
        }

        // --- 1. Config ---
        const DOMESTIC_FLAG = '國內採購';
        const IMPORT_COMPANIES = ['崇文冷凍', '八方環球'];
        const CUSTOMS_BROKERS = ['原碩', '尚鴻', DOMESTIC_FLAG];
        const DEFAULT_ORIGINS = ['厄瓜多', '巴拿馬', '瓜地馬拉', '宏都拉斯', '泰國', '印尼', '印度', '中國', '智利', '挪威'];
        const PAYMENT_TERMS_DOMESTIC = ['現金', '月結 30 天', '月結 45 天', '月結 60 天', '其他'];
        const ADMIN_EMAILS = ["pto2.tw@gmail.com", "bapbts0901@gmail.com", "4onlymerich@gmail.com"];

        const initialFormState = { 
            importCompany: IMPORT_COMPANIES[0], 
            customsBroker: CUSTOMS_BROKERS[0], 
            origin: '', 
            supplier: '', 
            arrivalDate: new Date().toISOString().split('T')[0], 
            containerNumber: '', 
            shippingCompany: '', 
            products: [{ id: Date.now(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'quantity' }], 
            totalQuantity: 0, 
            totalWeight: 0, 
            docUrl: '', 
            docName: '', 
            docRefPath: '', 
            devanningLocation: '', 
            devanningDate: '', 
            warehouseConfirmed: false,
            attachments: [],
            isPaid: false,
            currency: 'USD',
            paymentTerm: '到港前付款',
            prepayment: 0,
            flightFee: 0,         
            flightFeePaid: false 
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDvMBng2Zhbk6sVaZLSuER2KT6qqeoCdnw",
            authDomain: "containersystem-6342f.firebaseapp.com",
            projectId: "containersystem-6342f",
            storageBucket: "containersystem-6342f.firebasestorage.app",
            messagingSenderId: "27658303054",
            appId: "1:27658303054:web:d7a3710054ede268cdf51f"
        };

        let db, auth, storage;
        try {
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); }
            if (typeof firebase !== 'undefined') { db = firebase.firestore(); auth = firebase.auth(); storage = firebase.storage(); }
        } catch (e) { console.error("Firebase Init Failed:", e); }

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 2. Helpers ---
        const safeNum = (val) => { const n = parseFloat(val); return isNaN(n) ? 0 : n; };
        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0);
            try { const p = dateStr.split('-'); if (p.length !== 3) return new Date(0); return new Date(parseInt(p[0]), parseInt(p[1]) - 1, parseInt(p[2])); } catch (e) { return new Date(0); }
        };
        const getStatusStyle = (date) => { 
            if (!date) return { bg: 'bg-gray-100', text: '未定', color: 'text-gray-400' };
            const diff = Math.round((parseDate(date) - parseDate(new Date().toISOString().split('T')[0])) / 86400000);
            if (diff < 0) return { text: '已到港', color: 'bg-gray-100 text-gray-500' };
            if (diff === 0) return { text: '今日到港', color: 'bg-red-100 text-red-600 animate-pulse' };
            return { text: diff + ' 天後', color: 'bg-blue-100 text-blue-600' };
        };
        const getCompanyColor = (n) => n === '崇文冷凍' ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700';
        const isDomestic = (d) => d && d.customsBroker === DOMESTIC_FLAG;
        const isForeign = (d) => !isDomestic(d);

        // --- 3. Icons (V45.0 安全分散定義) ---
        const Icons = {};
        Icons.Ship=()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.8 8"/><path d="M10 10 4.72 7.28a1 1 0 0 1 .11-1.79l9-4a1 1 0 0 1 .9 0l8.26 3.67a1 1 0 0 1 .13 1.77L14 10"/><path d="m14 10-4 4-4-3.7"/></svg>;
        Icons.Anchor=()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>;
        Icons.Plus=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        Icons.Search=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
        Icons.Trash2=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        Icons.Edit=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
        Icons.Copy=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        Icons.FileCheck=()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>;
        Icons.Globe=()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>;
        Icons.Factory=()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>;
        Icons.Paperclip=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>;
        Icons.ArrowRight=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>;
        Icons.Download=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-3-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        Icons.LogOut=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        Icons.Google=()=><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"></path></svg>;
        Icons.X=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>;
        Icons.Check=()=><svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>;
        Icons.Bell=()=><svg width="22" height="22" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        Icons.MessageCircle=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>;
        Icons.User=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        Icons.Briefcase=()=><svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        Icons.List=()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>;
        Icons.Chart=()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>;
        Icons.Grid=()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>;
        Icons.Dollar=()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        Icons.Calendar=()=><svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        Icons.Line=()=><svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9Z"/><path d="M8 12h8"/></svg>;

        // 4. SafeChart
        const SafeChart = ({ data }) => {
            const [loaded, setLoaded] = useState(false);
            useEffect(() => {
                if(window.Recharts) { setLoaded(true); return; }
                const t = setInterval(() => { if(window.Recharts) { setLoaded(true); clearInterval(t); } }, 500);
                return () => clearInterval(t);
            }, []);
            if(!loaded) return <div className="p-12 text-center text-gray-400 text-sm">圖表載入中...</div>;
            const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend } = window.Recharts;
            return (
                <div className="h-64 w-full">
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={data}>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                            <XAxis dataKey="name" tick={{fontSize:10}} />
                            <YAxis yAxisId="left" orientation="left" stroke="#10B981" tick={{fontSize:10}} tickFormatter={v=>`$${v/1000}k`} />
                            <YAxis yAxisId="right" orientation="right" stroke="#3B82F6" tick={{fontSize:10}} tickFormatter={v=>`$${v/1000}k`} />
                            <Tooltip />
                            <Legend />
                            <Bar yAxisId="left" dataKey="USD" name="美金" fill="#10B981" radius={[4,4,0,0]} />
                            <Bar yAxisId="right" dataKey="TWD" name="台幣" fill="#3B82F6" radius={[4,4,0,0]} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // 5. Dashboard
        const Dashboard = ({ shipments, canSeePrice }) => {
            const availableMonths = useMemo(() => {
                const months = new Set();
                shipments.forEach(s => {
                    if(s.arrivalDate) months.add(s.arrivalDate.substring(0, 7));
                });
                return Array.from(months).sort().reverse();
            }, [shipments]);

            const [filterMonth, setFilterMonth] = useState('ALL');
            const [search, setSearch] = useState('');
            
            const stats = useMemo(() => {
                let list = Array.isArray(shipments) ? shipments : [];
                if (search) {
                    const t = search.toLowerCase();
                    list = list.filter(s => (s.supplier||'').toLowerCase().includes(t) || (s.products||[]).some(p=>p.name.toLowerCase().includes(t)));
                }
                
                if (filterMonth !== 'ALL') {
                     list = list.filter(s => s.arrivalDate && s.arrivalDate.startsWith(filterMonth));
                }

                const count = list.length;
                const items = list.reduce((s,i) => s + safeNum(i.totalQuantity), 0);
                const w = list.reduce((s,i) => s + safeNum(i.totalWeight), 0);
                const moneyUSD = list.reduce((s,i) => i.currency==='USD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                const moneyTWD = list.reduce((s,i) => i.currency==='TWD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                
                const supps = {}; list.forEach(s=>{ const n=s.supplier||'未填'; supps[n]=(supps[n]||0)+1; });
                const top = Object.entries(supps).sort((a,b)=>b[1]-a[1]).slice(0,5);
                
                const chartMap = {};
                list.forEach(s => {
                    const d = parseDate(s.arrivalDate);
                    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    if(!chartMap[k]) chartMap[k] = {name:k, TWD:0, USD:0};
                    const amt = (s.products||[]).reduce((a,p)=>a+safeNum(p.amount),0);
                    if(s.currency==='USD') chartMap[k].USD += amt; else chartMap[k].TWD += amt;
                });
                const chartData = Object.values(chartMap).sort((a,b)=>a.name.localeCompare(b.name)).slice(-6);

                return { count, items, w, moneyUSD, moneyTWD, top, chartData };
            }, [shipments, filterMonth, search]);
            
            return (
                <div className="space-y-6 animate-[fade-in_0.3s_ease-out] pb-20">
                    <div className="flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">統計儀表板</h2>
                            <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="bg-white border border-gray-300 rounded-lg px-3 py-1 text-sm outline-none font-bold text-gray-700">
                                <option value="ALL">全部月份</option>
                                {availableMonths.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                        <input placeholder="搜尋產品、廠商..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full bg-white text-gray-900 rounded-xl py-2 px-4 outline-none shadow-sm text-sm border border-gray-100" />
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">總筆數</div><div className="text-2xl font-black text-gray-800">{stats.count}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">總件數</div><div className="text-2xl font-black text-blue-600">{stats.items.toLocaleString()}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm col-span-2"><div className="text-gray-400 text-xs font-bold mb-1">總重量 (kg)</div><div className="text-2xl font-black text-orange-500">{parseInt(stats.w).toLocaleString()}</div></div>
                        {canSeePrice() && (
                            <>
                                <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">美金總額 (USD)</div><div className="text-xl font-black text-emerald-600">${stats.moneyUSD.toLocaleString()}</div></div>
                                <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">台幣總額 (TWD)</div><div className="text-xl font-black text-emerald-600">${stats.moneyTWD.toLocaleString()}</div></div>
                            </>
                        )}
                    </div>
                    {canSeePrice() && <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">📈 月度採購金額趨勢</h3><SafeChart data={stats.chartData} /></div>}
                     <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">🏆 前五大廠商</h3><div className="space-y-3">{stats.top.map(([n,c],i)=><div key={n} className="flex items-center gap-3"><div className="w-6 text-xs font-bold text-gray-400">#{i+1}</div><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-gray-700">{n}</span><span className="text-gray-500">{c} 筆</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width:`${(c/5)*100}%`}}></div></div></div></div>)}</div></div>
                </div>
            );
        };

        // 6. Main App
        function ContainerApp() {
            const [user, setUser] = useState(null);
            const [shipments, setShipments] = useState([]);
            const [view, setView] = useState('list'); 
            const [displayMode, setDisplayMode] = useState('card');
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [currentTab, setCurrentTab] = useState('NOT_DEVANED'); 
            const [userRole, setUserRole] = useState('GUEST');
            const [formData, setFormData] = useState(initialFormState);
            const [showNotifications, setShowNotifications] = useState(false);
            const [uploading, setUploading] = useState(false);

            // Actions
            const handleLogout = useCallback(() => { if(auth) auth.signOut(); else window.location.reload(); }, []);
            const handleAdminLogin = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (error) { alert("登入失敗: " + error.message); } };
            const handleGuestLogin = async () => { try { await auth.signInAnonymously(); } catch (error) { alert("訪客登入失敗"); } };
            const handleDelete = async (id) => { if(confirm("確定刪除?")) await db.collection('shipments').doc(id).delete(); };
            const handleWarehouseConfirm = async (e, item) => { e.stopPropagation(); if (!canEditWarehouseFields()) return alert("權限不足"); try { await db.collection('shipments').doc(item.id).update({ warehouseConfirmed: !item.warehouseConfirmed }); } catch (err) { alert(err.message); } };
            
            const handleExport = () => { 
                if (userRole === 'GUEST') return alert("權限不足"); 
                const showPrice = canSeePrice();
                let header = "進口公司,報關行,櫃號,到港日,產地,廠商,船公司,品名,批號,效期,規格,箱容,數量,重量,計價模式,總數,文件,拆櫃地點,拆櫃日期,是否匯款,幣別,付款條件,預付款,旅費,旅費已付"; 
                if (showPrice) header += ",單價,金額";
                header += "\n";
                const rows = filteredList.flatMap(s => (s.products || []).map(p => {
                    let row = [s.importCompany,s.customsBroker,s.containerNumber,s.arrivalDate,s.origin,s.supplier,s.shippingCompany,p.name,p.batchNumber,p.expiryDate,p.spec,p.boxCapacity || 1,p.quantity,p.weight || 0, p.pricingMode === 'weight' ? '重量' : '數量', s.totalQuantity,(s.attachments||[]).map(a=>a.url).join('; '),s.devanningLocation,s.devanningDate, s.isPaid ? '已匯款' : '未匯款', s.currency || 'USD', s.paymentTerm || '', s.prepayment || 0, s.flightFee || 0, s.flightFeePaid ? '已付' : '未付'];
                    if (showPrice) row.push(p.unitPrice || 0, p.amount || 0);
                    return row.map(f => '"' + String(f||'').replace(/"/g,'""') + '"').join(",");
                })).join("\n");
                const link = document.createElement("a"); 
                link.href=URL.createObjectURL(new Blob(["\uFEFF"+header+rows], {type:"text/csv;charset=utf-8;"})); 
                link.download='貨櫃_'+new Date().toISOString().slice(0,10)+'.csv'; link.click(); 
            };

            const handleShareToLine = (s) => {
                const isDom = isDomestic(s);
                let text = `${isDom ? "🚚 到貨通知" : "🚢 到港通知"}\n日期：${s.arrivalDate}\n櫃號：${s.containerNumber}\n廠商：${s.supplier}\n\n`;
                (s.products || []).forEach((p, i) => { text += `${i+1}. ${p.name} ${p.spec ? p.spec : ''} - ${p.quantity}件\n`; });
                window.open("https://line.me/R/msg/text/?" + encodeURIComponent(text), '_blank');
            };

            const handleEdit = (item) => {
                if(!canEdit() && !canUpload()) return alert("權限不足"); 
                let atts = item.attachments || [];
                if (item.docUrl && atts.length === 0) { atts.push({ name: item.docName || '附件', url: item.docUrl, path: item.docRefPath }); }
                setFormData({ 
                    ...initialFormState, ...item, attachments: atts,
                    currency: item.currency || (item.customsBroker === DOMESTIC_FLAG ? 'TWD' : 'USD'),
                    paymentTerm: item.paymentTerm || (item.customsBroker === DOMESTIC_FLAG ? PAYMENT_TERMS_DOMESTIC[0] : '到港前付款'),
                    prepayment: item.prepayment || 0, flightFee: item.flightFee || 0, flightFeePaid: item.flightFeePaid || false
                }); 
                setEditingId(item.id); setView('form'); 
            };

            const handleDuplicateShipment = (s) => { 
                if(!canCreate()) return alert("權限不足");
                const {id, ...d} = s; const merged = { ...initialFormState, ...d };
                const np = (merged.products || []).map(p=>({...p,id:Date.now()+Math.random()})); 
                setFormData({...merged, containerNumber:'', products:np, attachments:[], isPaid: false, prepayment: 0, flightFee: 0, flightFeePaid: false}); 
                setEditingId(null); setView('form'); 
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!canEdit()) return alert("權限不足");
                setIsSubmitting(true);
                try {
                    const d = {...formData, updatedAt: new Date().toISOString()};
                    if(editingId) await db.collection('shipments').doc(editingId).update(d);
                    else await db.collection('shipments').add({...d, createdAt: new Date().toISOString()});
                    setEditingId(null); setView('list');
                } catch(err){ alert(err.message); } finally { setIsSubmitting(false); }
            };

            // --- Form Handlers ---
            const handleInputChange = (e) => {
                const {name,value,type,checked}=e.target;
                setFormData(p => ({...p, [name]: type==='checkbox'?checked:value}));
            };
            
            const handleProductChange = (idx, f, v) => {
                const np = [...formData.products]; np[idx] = {...np[idx], [f]:v};
                const p = np[idx];
                if(p.pricingMode==='weight') p.amount = Math.round(safeNum(p.weight)*safeNum(p.unitPrice));
                else p.amount = Math.round(safeNum(p.quantity)*safeNum(p.boxCapacity)*safeNum(p.unitPrice));
                setFormData(prev => ({...prev, products:np, totalQuantity:np.reduce((s,i)=>s+safeNum(i.quantity),0), totalWeight:np.reduce((s,i)=>s+safeNum(i.weight),0)}));
            };

            const addProductRow = (e) => {
                if(e) e.preventDefault();
                setFormData(p => ({...p, products:[...(p.products||[]), {id:Date.now(), name:'', quantity:0, weight:0, unitPrice:0, amount:0, pricingMode:'quantity'}]}));
            };
            const duplicateProductRow = (idx) => { const p=formData.products[idx]; setFormData(prev=>({...prev, products:[...prev.products.slice(0,idx+1), {...p, id:Date.now()}, ...prev.products.slice(idx+1)]})); };
            const removeProductRow = (idx) => { const np=formData.products.filter((_,i)=>i!==idx); setFormData(prev=>({...prev, products:np})); };
            
            // V42.0: 多檔案上傳
            const handleFileUpload = async (evt) => {
                const files = Array.from(evt.target.files);
                if (files.length === 0) return;
                setUploading(true);
                if (!canUpload()) { alert("權限不足"); setUploading(false); return; }

                try {
                    const newAttachments = [];
                    for (const file of files) {
                        const ref = storage.ref('docs/' + Date.now() + '_' + file.name);
                        await ref.put(file);
                        const url = await ref.getDownloadURL();
                        newAttachments.push({ name: file.name, url: url, path: ref.fullPath });
                    }
                    setFormData(prev => ({ ...prev, attachments: [...(prev.attachments||[]), ...newAttachments] }));
                } catch (error) { alert("上傳失敗: " + error.message); } finally { setUploading(false); evt.target.value = ''; }
            };
            
            const handleDeleteFile = async (index) => { 
                if(!confirm("確定要刪除此附件嗎？")) return;
                if (!canUpload()) return alert("權限不足");
                const target = formData.attachments[index];
                if (target.path && storage) { try { await storage.ref(target.path).delete(); } catch (error) { console.warn(error); } }
                const newAttachments = formData.attachments.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, attachments: newAttachments }));
            };

            // Auth & DB Effects
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none', 300); }
                if (!auth) return;
                const unsub = auth.onAuthStateChanged(u => { setUser(u); if(!u) setLoading(false); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('shipments').onSnapshot(s => {
                    const cleanData = s.docs.map(d => {
                        const dat = d.data();
                        return { id:d.id, ...dat, products: Array.isArray(dat.products) ? dat.products : [] };
                    }).sort((a,b)=>b.arrivalDate>a.arrivalDate?1:-1);
                    setShipments(cleanData);
                    setLoading(false);
                });
                db.collection('settings').doc('config').get().then(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        if(d.user_roles && d.user_roles[user.email]) setUserRole(d.user_roles[user.email]);
                        else if(d.admin_emails && d.admin_emails.includes(user.email)) setUserRole('MANAGER');
                    } else if(ADMIN_EMAILS.includes(user.email)) setUserRole('MANAGER');
                });
                return () => unsub();
            }, [user]);

            // Permissions
            const canManage = () => userRole === 'MANAGER';
            const canEdit = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole);
            const canCreate = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canDelete = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canUpload = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole); 
            const canSeePrice = () => ['MANAGER','PURCHASING','ACCOUNTING'].includes(userRole);
            const canEditFlightFee = () => userRole === 'MANAGER' || userRole === 'ACCOUNTING';
            const canEditDomesticFull = () => ['MANAGER','PURCHASING'].includes(userRole);
            const canEditForeignFinance = () => ['MANAGER', 'ACCOUNTING'].includes(userRole);
            const canEditWarehouseFields = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole);

            // Filter
            const todayStr = new Date().toISOString().split('T')[0];
            const filteredList = useMemo(() => {
                let list = Array.isArray(shipments) ? shipments : [];
                if(searchTerm) { const t=searchTerm.toLowerCase(); list=list.filter(s=>(s.containerNumber||'').toLowerCase().includes(t)||(s.supplier||'').toLowerCase().includes(t)||(s.products||[]).some(p=>(p.name||'').toLowerCase().includes(t)||(p.spec||'').toLowerCase().includes(t)||(p.batchNumber||'').toLowerCase().includes(t)||(s.importCompany||'').toLowerCase().includes(t)||(s.customsBroker||'').toLowerCase().includes(t)||(s.origin||'').toLowerCase().includes(t))); }
                
                if(currentTab==='UNPAID') list=list.filter(s=>!s.isPaid);
                else if(currentTab==='DOMESTIC') list=list.filter(s=>isDomestic(s));
                else if(currentTab==='DEVANED') list=list.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr);
                else list=list.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr));
                
                return list.sort((a,b) => (currentTab==='DEVANED' ? (b.devanningDate>a.devanningDate?1:-1) : (a.arrivalDate>b.arrivalDate?1:-1)));
            }, [shipments, searchTerm, currentTab]);
            
            const urgentCount = useMemo(() => shipments.filter(s => !s.arrivalDate ? false : (Math.round((parseDate(s.arrivalDate)-parseDate(todayStr))/86400000) >= 0 && Math.round((parseDate(s.arrivalDate)-parseDate(todayStr))/86400000) <= 3)).length, [shipments]);
            const urgentList = useMemo(() => shipments.filter(s => !s.arrivalDate ? false : (Math.round((parseDate(s.arrivalDate)-parseDate(todayStr))/86400000) >= 0 && Math.round((parseDate(s.arrivalDate)-parseDate(todayStr))/86400000) <= 3)).sort((a,b)=>a.arrivalDate>b.arrivalDate?1:-1), [shipments]);
            const unpaidCount = useMemo(() => shipments.filter(s => !s.isPaid).length, [shipments]);

            if(loading) return <div className="flex h-screen items-center justify-center text-gray-500">Loading...</div>;
            if(!user) return <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4"><div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full"><div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl"><Icons.Ship /></div><h1 className="text-2xl font-bold mb-8">貨櫃管理系統</h1><button onClick={handleAdminLogin} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow mb-3 flex justify-center gap-2"><Icons.Google /> 員工登入</button><button onClick={handleGuestLogin} className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold flex justify-center gap-2"><Icons.User /> 訪客登入</button></div></div>;

            return (
                <ErrorBoundary>
                <div className="min-h-screen bg-slate-100 pb-20 md:pb-0 md:pl-64">
                    {/* Notification Modal */}
                    {showNotifications && (
                        <div className="modal-overlay" onClick={()=>setShowNotifications(false)}>
                            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">近期到港急件 ({urgentCount})</h3><button onClick={()=>setShowNotifications(false)}><Icons.X /></button></div>
                                {urgentList.length===0 ? <div className="text-center text-gray-400 py-4">目前無急件</div> : urgentList.map(s=>(
                                    <div key={s.id} className="mb-3 p-3 bg-red-50 rounded-lg border border-red-100 cursor-pointer" onClick={()=>{setShowNotifications(false); setFormData({...initialFormState, ...s}); setEditingId(s.id); setView('form');}}>
                                        <div className="flex justify-between font-bold text-sm text-gray-800"><span>{s.containerNumber}</span><span className="text-red-600">{s.arrivalDate}</span></div>
                                        <div className="text-xs text-gray-500 mt-1">{s.supplier}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <aside className="hidden md:flex flex-col w-64 bg-white border-r fixed inset-y-0 left-0 z-20"><div className="p-6 flex items-center gap-3 font-bold text-xl text-gray-800"><span className="text-blue-600"><Icons.Ship /></span>貨櫃管理 v45.0</div><nav className="flex-1 px-4 space-y-2"><button onClick={()=>setView('list')} className={`sidebar-link w-full ${view==='list'?'active':''}`}><div className="w-8 text-center"><Icons.List /></div> 貨櫃列表</button><button onClick={()=>setView('stats')} className={`sidebar-link w-full ${view==='stats'?'active':''}`}><div className="w-8 text-center"><Icons.Chart /></div> 統計分析</button></nav><div className="p-4 border-t"><button onClick={handleLogout} className="w-full py-2 text-xs text-gray-400 hover:text-red-500 flex items-center justify-center gap-1"><Icons.LogOut /> 登出</button></div></aside>

                    <div className="md:hidden sticky top-0 z-30 bg-white border-b px-4 h-14 flex items-center justify-between shadow-sm"><div className="flex items-center gap-2 font-bold text-gray-900"><span className="text-blue-600"><Icons.Ship /></span> {view==='list'?'貨櫃列表':'統計分析'}</div><div className="flex gap-3 items-center"><div className="relative" onClick={()=>setShowNotifications(true)}><span className="text-gray-500"><Icons.Bell /></span>{urgentCount>0&&<span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></span>}</div><button onClick={handleExport} className="text-gray-500"><Icons.Download /></button>{canCreate()&&view==='list'&&<button onClick={()=>{setFormData(initialFormState);setEditingId(null);setView('form')}} className="text-blue-600"><Icons.Plus /></button>}<button onClick={handleLogout} className="text-red-400"><Icons.LogOut /></button></div></div>

                    <main className="p-4 max-w-4xl mx-auto">
                        {view === 'list' && (
                            <div className="space-y-4">
                                <div className="sticky top-0 z-20 bg-[#F3F4F6] -mt-4 pt-4 pb-2 space-y-3">
                                    <div className="flex gap-2 items-center">
                                        <div className="relative flex-1"><span className="absolute left-3 top-3 text-gray-400"><Icons.Search /></span><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="搜尋..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border-none shadow-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                        {canSeePrice() && (
                                            <button onClick={()=>setCurrentTab(currentTab==='UNPAID'?'NOT_DEVANED':'UNPAID')} className={`relative p-2.5 rounded-xl shadow-sm transition-colors ${currentTab==='UNPAID'?'bg-red-500 text-white':'bg-white text-gray-600'}`}>
                                                <div className="flex items-center gap-1 font-bold"><Icons.Dollar />{unpaidCount > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}</div>
                                            </button>
                                        )}
                                        <button onClick={()=>setDisplayMode(displayMode==='card'?'table':'card')} className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600"><Icons.List /></button>
                                        
                                        {/* 電腦版四大天王 */}
                                        <div className="hidden md:flex gap-2">
                                            <div onClick={()=>setShowNotifications(true)} className="relative p-2.5 bg-white rounded-xl shadow-sm text-gray-600 cursor-pointer hover:bg-gray-50"><Icons.Bell />{urgentCount>0&&<span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>}</div>
                                            <button onClick={handleExport} className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600 hover:bg-gray-50"><Icons.Download /></button>
                                            {canCreate() && <button onClick={()=>{setFormData(initialFormState);setEditingId(null);setView('form')}} className="p-2.5 bg-white rounded-xl shadow-sm text-blue-600 hover:bg-blue-50"><Icons.Plus /></button>}
                                        </div>
                                    </div>
                                    <div className="flex overflow-x-auto gap-2 pb-1">
                                        <button onClick={()=>setCurrentTab('NOT_DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='NOT_DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>未拆櫃 <span className={`ml-1 text-xs ${currentTab==='NOT_DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr)).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>已拆櫃 <span className={`ml-1 text-xs ${currentTab==='DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DOMESTIC')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DOMESTIC'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>國內採購 <span className={`ml-1 text-xs ${currentTab==='DOMESTIC'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isDomestic(s)).length}</span></button>
                                    </div>
                                </div>

                                {displayMode === 'table' ? (
                                    <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                                        <table className="reconcile-table">
                                            <thead><tr><th>日期</th><th>櫃號</th><th>廠商</th><th>品名摘要</th><th className="text-right">總數</th><th className="text-right">總重</th>{canSeePrice()&&<th className="text-right">貨款金額</th>}{canEditFlightFee()&&<th className="text-right">旅費</th>}</tr></thead>
                                            <tbody>
                                                {filteredList.map(item => {
                                                    const totalAmt = (item.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                                                    const curr = item.currency === 'USD' ? 'US$' : 'NT$';
                                                    const showFlightFee = isForeign(item) || canManage();
                                                    return (
                                                    <tr key={item.id} onClick={()=>{setFormData({...initialFormState, ...item}); setEditingId(item.id); setView('form');}}>
                                                        <td className="whitespace-nowrap">{item.arrivalDate}</td><td className="font-bold">{item.containerNumber}</td><td className="truncate max-w-[80px]">{item.supplier}</td><td className="truncate max-w-[100px]">{(item.products||[]).map(p=>p.name).join(',')}</td><td className="text-right font-bold text-blue-600">{safeNum(item.totalQuantity).toLocaleString()}</td><td className="text-right text-orange-500">{safeNum(item.totalWeight).toLocaleString()}</td>
                                                        {canSeePrice()&&<td className="text-right whitespace-nowrap"><span className={item.isPaid?"amt-paid":"amt-unpaid"}>{curr} {totalAmt.toLocaleString()}</span></td>}
                                                        {canEditFlightFee()&&<td className="text-right whitespace-nowrap">{showFlightFee?<span className={item.flightFeePaid?"amt-paid":"amt-unpaid"}>{safeNum(item.flightFee).toLocaleString()}</span>:'-'}</td>}
                                                    </tr>
                                                )})}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {filteredList.map(item => {
                                            const totalAmount = (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                                            const totalWeight = (item.products || []).reduce((sum, p) => sum + (Number(p.weight) || 0), 0);
                                            const totalQty = (item.products || []).reduce((sum, p) => sum + (Number(p.quantity) || 0), 0);
                                            const currSymbol = item.currency === 'USD' ? 'US$' : 'NT$';
                                            
                                            const isDevanned = item.devanningDate && item.devanningDate <= todayStr;
                                            const mainDate = parseDate(item.arrivalDate);
                                            
                                            // V43.0: 迴紋針圖示 (a 標籤 + z-index)
                                            const hasAttachments = (item.attachments && item.attachments.length > 0) || item.docUrl;
                                            const firstAtt = (item.attachments && item.attachments.length > 0) ? item.attachments[0].url : item.docUrl;

                                            return (
                                            <div key={item.id} className="ios-card p-4" onClick={()=>{setFormData({...initialFormState, ...item}); setEditingId(item.id); setView('form');}}>
                                                {/* V40.0: 卡片排版 */}
                                                <div className="flex justify-between items-start mb-3 border-b border-gray-100 pb-2">
                                                    <div className="flex-1 min-w-0">
                                                        <div className="mb-1"><span className={`company-tag ${getCompanyColor(item.importCompany)} text-xs`}>{item.importCompany}</span></div>
                                                        <div className="text-2xl font-black text-gray-900 tracking-tight mb-2">{item.containerNumber}</div>
                                                        <div className="flex flex-wrap gap-1 mb-2">
                                                            {item.customsBroker && <span className="tag-badge bg-gray-100 text-gray-600"><Icons.FileCheck />{item.customsBroker}</span>}
                                                            <span className="tag-badge bg-gray-100 text-gray-600"><Icons.Factory />{item.supplier}</span>
                                                            {item.origin && <span className="tag-badge bg-gray-100 text-gray-600"><Icons.Globe />{item.origin}</span>}
                                                        </div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {item.devanningLocation && <span className="tag-badge bg-blue-50 text-blue-600"><Icons.Briefcase />{item.devanningLocation}</span>}
                                                            {item.devanningDate && <span className="tag-badge bg-blue-50 text-blue-600"><Icons.Calendar />{item.devanningDate}</span>}
                                                        </div>
                                                    </div>
                                                    {/* 右側操作區 */}
                                                    <div className="flex flex-col items-end gap-2">
                                                         <div className="flex gap-1 relative z-20">
                                                            {hasAttachments && <a href={firstAtt} target="_blank" onClick={(e)=>e.stopPropagation()} className="text-blue-500 hover:bg-blue-50 p-1.5 rounded-full"><Icons.Paperclip /></a>}
                                                            {canEdit() && <button onClick={(e)=>{e.stopPropagation(); handleEdit(item)}} className="text-gray-400 hover:text-blue-600 p-1.5"><Icons.Edit /></button>}
                                                            <button onClick={(e)=>{e.stopPropagation(); handleShareToLine(item)}} className="text-green-500 hover:text-green-600 p-1.5"><Icons.MessageCircle /></button>
                                                            {canCreate() && <button onClick={(e)=>{e.stopPropagation(); handleDuplicateShipment(item)}} className="text-gray-400 hover:text-blue-600 p-1.5"><Icons.Copy /></button>}
                                                            {canDelete() && <button onClick={(e)=>{e.stopPropagation(); handleDelete(item.id)}} className="text-gray-400 hover:text-red-600 p-1.5"><Icons.Trash2 /></button>}
                                                        </div>
                                                        <div className={`flex flex-col items-center justify-center w-14 h-14 rounded-xl border ${isDevanned?'bg-green-50 border-green-200 text-green-700':'bg-white border-gray-200 text-gray-700'}`}><span className="text-[10px] font-bold uppercase">{mainDate.toLocaleString('default',{month:'short'})}</span><span className="text-xl font-bold leading-none">{mainDate.getDate()}</span></div>
                                                    </div>
                                                </div>

                                                {/* 產品明細 */}
                                                <div className="space-y-3">
                                                    {(item.products || []).map((p,i)=>(
                                                        <div key={i} className="flex flex-col border-b border-gray-50 pb-2 last:border-0 last:pb-0">
                                                            <div className="flex flex-wrap items-baseline gap-x-2 gap-y-1 text-sm">
                                                                <span className="font-bold text-gray-900 text-base">{p.name}</span>
                                                                {p.spec&&<span className="text-gray-500">{p.spec}</span>}
                                                                <div className="flex items-center gap-2 mr-auto sm:ml-0 flex-wrap justify-start text-gray-600">
                                                                    <span className="text-xs text-gray-400">{p.pricingMode==='weight'?'[重]':'[數]'}</span>
                                                                    <span className="font-mono text-base">{safeNum(p.weight).toLocaleString()}kg</span>
                                                                    {canSeePrice()&&<><span className="text-gray-300">|</span><span className="font-mono text-base">${safeNum(p.unitPrice)}</span><span className="text-gray-300">|</span><span className="font-bold text-emerald-600 font-mono text-base">${safeNum(p.amount).toLocaleString()}</span></>}
                                                                </div>
                                                                <span className="ml-auto text-base font-bold text-blue-600 font-mono">{safeNum(p.quantity).toLocaleString()} 件</span>
                                                            </div>
                                                            {(p.batchNumber||p.expiryDate)&&<div className="flex gap-2 mt-1 text-xs text-gray-400 font-mono">{p.batchNumber&&<span className="bg-gray-100 px-1.5 rounded">批:{p.batchNumber}</span>}{p.expiryDate&&<span className="bg-gray-100 px-1.5 rounded">效:{p.expiryDate}</span>}</div>}
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                {/* 卡片底部合計與狀態 */}
                                                <div className="mt-3 pt-2 bg-gray-50 -mx-4 -mb-4 p-3 border-t border-gray-200">
                                                    <div className="grid grid-cols-3 gap-2 text-lg mb-2 font-mono font-bold text-gray-700 border-b border-gray-300 pb-2">
                                                        <div className="text-left">{totalWeight.toLocaleString()}kg</div>
                                                        <div className="text-center text-emerald-700">{currSymbol}{totalAmount.toLocaleString()}</div>
                                                        <div className="text-right text-blue-700">{totalQty.toLocaleString()}件</div>
                                                    </div>
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex gap-3 items-center">
                                                            <span className={item.isPaid?"amt-paid":"amt-unpaid"}>{item.isPaid?'':'未付款'}</span>
                                                            {canSeePrice() && item.flightFee > 0 && <span className={item.flightFeePaid?"amt-paid":"amt-unpaid"}>{item.flightFeePaid?'':'未付旅費'}</span>}
                                                        </div>
                                                        <label className={`tag-badge cursor-pointer border ${item.warehouseConfirmed ? 'bg-green-100 border-green-200 text-green-700' : 'bg-white border-gray-200 text-gray-400 hover:border-gray-400'}`} onClick={e => e.stopPropagation()}>
                                                            <input type="checkbox" className="w-4 h-4 rounded mr-1 cursor-pointer accent-green-600" checked={item.warehouseConfirmed || false} onChange={(e) => handleWarehouseConfirm(e, item)} disabled={!canEditWarehouseFields()} />
                                                            <span className={item.warehouseConfirmed ? 'font-bold' : ''}>{item.warehouseConfirmed ? '已收貨' : '確認收貨'}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {view === 'stats' && <Dashboard shipments={shipments} canSeePrice={canSeePrice} />}

                        {view === 'form' && (
                            <div className="ios-card p-5 animate-[fade-in_0.3s_ease-out]">
                                <div className="flex justify-between mb-4 border-b pb-2"><h2 className="font-bold text-lg">{editingId?'編輯':'新增'}</h2><button onClick={()=>setView('list')} className="text-gray-400"><Icons.X /></button></div>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    {/* V44.0 編輯頁面：純白底色輸入框 */}
                                    <div className="grid grid-cols-2 gap-3"><div><label className="block text-xs font-bold text-gray-500 mb-1">進口公司</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div><div><label className="block text-xs font-bold text-gray-500 mb-1">櫃號</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2 font-mono uppercase" /></div></div>
                                    <div className="grid grid-cols-2 gap-3"><div><label className="block text-xs font-bold text-gray-500 mb-1">日期</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" /></div><div><label className="block text-xs font-bold text-gray-500 mb-1">報關行</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div></div>
                                    <div className="grid grid-cols-2 gap-3"><div><label className="block text-xs font-bold text-gray-500 mb-1">廠商</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" /></div><div><label className="block text-xs font-bold text-gray-500 mb-1">產地</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div></div>
                                    <div className="grid grid-cols-2 gap-3"><div><label className="block text-xs font-bold text-gray-500 mb-1">地點</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" /></div><div><label className="block text-xs font-bold text-gray-500 mb-1">拆櫃日</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" /></div></div>
                                    
                                    {canSeePrice() && <div className="bg-gray-50 p-3 rounded-xl border border-gray-200 grid grid-cols-2 gap-3"><div><label className="block text-xs font-bold text-gray-500 mb-1">付款條件</label><input value={formData.paymentTerm} disabled className="w-full bg-white border rounded p-2 text-xs" /></div><label className="flex items-center gap-2 pt-4 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-5 h-5 accent-green-600"/><span className="font-bold text-green-700">貨款已付</span></label>{canEditFlightFee() && isForeign(formData) && <><div className="col-span-2 border-t my-1"></div><div><label className="block text-xs font-bold text-gray-500 mb-1">旅費 (TWD)</label><input type="number" name="flightFee" value={formData.flightFee} onWheel={e=>e.target.blur()} onChange={handleInputChange} className="w-full bg-white border rounded p-2" /></div><label className="flex items-center gap-2 pt-4 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} className="w-5 h-5 accent-red-600"/><span className="font-bold text-red-700">旅費已付</span></label></>}</div>}
                                    
                                    <div className="pt-2">
                                        <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-lg text-gray-700">產品明細</h3>{(canEditDomesticFull() || canManage()) && <button type="button" onClick={addProductRow} className="text-blue-600 font-bold text-sm hover:underline cursor-pointer">+ 新增產品</button>}</div>
                                        {/* V45.0: 深色欄位說明列 */}
                                        <div className="grid gap-2 mb-2 px-3 py-1 bg-gray-700 text-white text-xs font-bold rounded-lg" style={{gridTemplateColumns: "2fr 1fr 1fr 1fr 1fr"}}>
                                            <div className="col-span-5">品名 / 規格 / 計價</div>
                                            <div>數量</div><div>重量</div><div>單價</div><div>批號</div><div>效期</div>
                                        </div>
                                        <div className="space-y-3">{formData.products.map((p, idx) => (<div key={p.id} className="bg-white border rounded-xl p-3 relative shadow-sm"><div className="grid gap-2"><input value={p.name} onChange={e=>handleProductChange(idx,'name',e.target.value)} className="font-bold border-b pb-1 w-full outline-none input-bg-style rounded p-1" placeholder="品名" /><div className="grid grid-cols-2 gap-2"><input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="input-bg-style rounded p-1 text-xs" placeholder="規格" /><select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="input-bg-style rounded p-1 text-xs"><option value="quantity">計件</option><option value="weight">計重</option></select></div><div className="grid grid-cols-3 gap-2"><input type="number" value={p.quantity} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'quantity',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-blue-600" placeholder="數量" /><input type="number" value={p.weight} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'weight',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-orange-500" placeholder="重量" /><input type="number" value={p.unitPrice} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value)} className="input-bg-style rounded p-1 text-right" placeholder="單價" /></div><div className="grid grid-cols-2 gap-2"><input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="input-bg-style rounded p-1 text-xs" placeholder="批號" /><input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="input-bg-style rounded p-1 text-xs" /></div></div>{(canEditDomesticFull() || canManage()) && (<div className="absolute top-2 right-2 flex gap-1"><button type="button" onClick={()=>duplicateProductRow(idx)} className="p-1 text-gray-400 hover:text-blue-600"><Icons.Copy /></button>{formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="p-1 text-gray-400 hover:text-red-600"><Icons.Trash2 /></button>}</div>)}</div>))}</div>
                                    </div>
                                    
                                    {/* V42.0: 多檔案上傳 */}
                                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                        <label className="block text-xs font-bold text-gray-500 mb-2">附件 ({formData.attachments?.length || 0})</label>
                                        <div className="space-y-2">
                                            {(formData.attachments || []).map((file, idx) => (
                                                <div key={idx} className="flex items-center justify-between bg-white p-2 rounded border">
                                                    <a href={file.url} target="_blank" className="text-blue-600 text-xs underline truncate flex-1 mr-2">{file.name}</a>
                                                    {canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><Icons.Trash2 /></button>}
                                                </div>
                                            ))}
                                        </div>
                                        {canUpload() && (
                                            <div className="mt-2 relative">
                                                <input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                                <button type="button" className="w-full py-2 bg-white border border-dashed border-gray-400 rounded text-gray-500 text-sm font-bold flex items-center justify-center gap-2">
                                                    {uploading ? '上傳中...' : <><Icons.Paperclip /> 選擇檔案 (可多選)</>}
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex gap-3 pt-2"><button type="button" onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">取消</button><button type="submit" disabled={isSubmitting} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">{isSubmitting?'...':'儲存'}</button></div>
                                </form>
                            </div>
                        )}
                    </main>
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex z-40 pb-safe h-14"><button onClick={()=>setView('list')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='list'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><Icons.List /></div><span className="text-xs font-bold">列表</span></button><button onClick={()=>setView('stats')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='stats'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><Icons.Chart /></div><span className="text-xs font-bold">統計</span></button></div>
                </div>
                </ErrorBoundary>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerApp />);
    </script>
</body>
</html>