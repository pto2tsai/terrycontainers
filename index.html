<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>貨櫃管理系統 V17.1</title>
    
    <script>
        window.onerror = function(globalMsg, globalUrl, globalLine) {
            // 忽略常見的無害錯誤
            if (globalMsg && globalMsg.toLowerCase().indexOf("script error") > -1) return false;
            if (globalMsg && globalMsg.indexOf("ResizeObserver") > -1) return false;
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        body { background-color: #F3F4F6; font-family: system-ui, -apple-system, sans-serif; color: #1f2937; overscroll-behavior-y: none; }
        
        /* iOS Card Style */
        .ios-card { background: #ffffff; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 16px; overflow: hidden; border: 1px solid #f3f4f6; transition: transform 0.1s ease; }
        .ios-card:active { transform: scale(0.995); }
        
        /* Table View Styles */
        .reconcile-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; background: white; }
        .reconcile-table th { position: sticky; top: 0; z-index: 10; background: #f9fafb; color: #6b7280; font-weight: 600; padding: 10px 8px; text-align: left; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        .reconcile-table td { padding: 8px 8px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; white-space: nowrap; }
        .reconcile-table tr:hover td { background-color: #f8fafc; }
        
        /* Badges & Inputs */
        .tag-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        
        /* 輸入框優化: 底色加深 bg-gray-200, 移除箭頭 */
        .input-bg-style { background-color: #E5E7EB; border: 1px solid #D1D5DB; color: #1F2937; transition: all 0.2s; }
        .input-bg-style:focus { background-color: white; border-color: #3b82f6; ring: 2px; }
        .input-bg-style:disabled { background-color: #F3F4F6; color: #9CA3AF; cursor: not-allowed; opacity: 0.7; }
        
        /* Remove Number Input Arrows */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Animations */
        .bell-shake { animation: shake 0.5s ease-in-out infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Sticky Layout Helpers */
        .sticky-header-container { position: sticky; top: 0; z-index: 50; background-color: #F3F4F6; }
        
        /* Mobile Modal */
        .mobile-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 60; display: flex; justify-content: center; padding-top: 60px; backdrop-filter: blur(2px); }
        .mobile-modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // 1. 絕對全域常數 & Config
        // ==========================================
        const APP_VERSION = "V17.1";
        const DOMESTIC_FLAG = '國內採購';
        const IMPORT_COMPANIES = ['崇文冷凍', '八方環球'];
        const CUSTOMS_BROKERS = ['原碩', '尚鴻', DOMESTIC_FLAG];
        const DEFAULT_ORIGINS = ['厄瓜多', '巴拿馬', '瓜地馬拉', '宏都拉斯', '泰國', '印尼', '印度', '中國', '智利', '挪威'];
        const PAYMENT_TERMS_DOMESTIC = ['現金', '月結 30 天', '月結 45 天', '月結 60 天', '其他'];
        
        // 管理員清單 (Manager)
        const ADMIN_EMAILS = ["pto2.tw@gmail.com", "bapbts0901@gmail.com", "4onlymerich@gmail.com"];

        const firebaseConfig = {
            apiKey: "AIzaSyDvMBng2Zhbk6sVaZLSuER2KT6qqeoCdnw",
            authDomain: "containersystem-6342f.firebaseapp.com",
            projectId: "containersystem-6342f",
            storageBucket: "containersystem-6342f.firebasestorage.app",
            messagingSenderId: "27658303054",
            appId: "1:27658303054:web:d7a3710054ede268cdf51f"
        };

        let db = null, auth = null, storage = null;
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            if (typeof firebase !== 'undefined') {
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
            }
        } catch (error) {
            console.error("Firebase Init Error", error);
        }

        // ==========================================
        // 2. Icons & Helpers
        // ==========================================
        const Icons = {
            Ship: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.8 8"/><path d="M10 10 4.72 7.28a1 1 0 0 1 .11-1.79l9-4a1 1 0 0 1 .9 0l8.26 3.67a1 1 0 0 1 .13 1.77L14 10"/><path d="m14 10-4 4-4-3.7"/></svg>,
            Anchor: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Search: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Copy: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            FileCheck: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            Globe: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Factory: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>,
            Paperclip: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            Download: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-3-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            LogOut: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Google: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"></path></svg>,
            X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Check: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Bell: () => <svg width="22" height="22" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            MessageCircle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            User: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Calendar: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Chart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            List: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Grid: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        };

        const { useState, useEffect, useMemo } = React;

        const parseDate = (dateStr) => {
            if (!dateStr) return new Date(0);
            const parts = dateStr.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        };

        const getStatusStyle = (date) => {
            if (!date) return { bg: 'bg-gray-100', text: '未定', color: 'text-gray-400' };
            const today = new Date(); today.setHours(0,0,0,0);
            const arrival = parseDate(date);
            const diff = Math.round((arrival - today) / (1000 * 60 * 60 * 24));
            if (diff < 0) return { text: '已到港', color: 'bg-gray-100 text-gray-500' };
            if (diff === 0) return { text: '今日到港', color: 'bg-red-100 text-red-600 animate-pulse' };
            if (diff === 1) return { text: '明天到港', color: 'bg-orange-100 text-orange-600' };
            return { text: diff + ' 天後', color: 'bg-blue-100 text-blue-600' };
        };
        
        // 四捨五入到小數點第一位
        const roundAmount = (num) => Math.round((Number(num) || 0) * 10) / 10;
        const getCompanyColor = (name) => name === '崇文冷凍' ? 'bg-blue-100 text-blue-700' : name === '八方環球' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-200 text-gray-700';

        // ==========================================
        // 3. Components
        // ==========================================

        // 簡單的長條圖元件 (For Trend)
        const SimpleBarChart = ({ data, currency }) => {
            if (!data || data.length === 0) return <div className="text-center text-gray-400 py-10">無數據</div>;
            const maxVal = Math.max(...data.map(d => d.amount));
            return (
                <div className="flex items-end gap-2 h-40 pt-4 pb-2 px-2 overflow-x-auto">
                    {data.map((d, i) => (
                        <div key={i} className="flex flex-col items-center flex-shrink-0 group w-12">
                            <div className="relative w-full flex justify-center items-end h-32 bg-gray-50 rounded-t-md overflow-hidden">
                                <div className={`w-8 rounded-t-md transition-all duration-500 ${currency === 'USD' ? 'bg-emerald-400 group-hover:bg-emerald-500' : 'bg-blue-400 group-hover:bg-blue-500'}`} style={{ height: maxVal > 0 ? `${(d.amount / maxVal) * 100}%` : '0%' }}></div>
                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 font-mono">
                                    ${d.amount.toLocaleString()}
                                </div>
                            </div>
                            <div className="text-[10px] text-gray-500 mt-1 font-bold">{d.month}</div>
                        </div>
                    ))}
                </div>
            );
        };

        const Dashboard = ({ shipments, canSeePrice }) => {
            const [yearFilter, setYearFilter] = useState(new Date().getFullYear());
            
            const stats = useMemo(() => {
                const filtered = shipments.filter(s => {
                    if (!s.arrivalDate) return false;
                    const d = new Date(s.arrivalDate);
                    return d.getFullYear() === yearFilter;
                });

                const count = filtered.length;
                const items = filtered.reduce((sum, s) => sum + (Number(s.totalQuantity) || 0), 0);
                const w = filtered.reduce((sum, s) => sum + (Number(s.totalWeight) || 0), 0);
                
                // Monthly Trends Logic
                const monthlyUSD = {};
                const monthlyTWD = {};
                
                filtered.forEach(s => {
                    const m = s.arrivalDate.substring(5, 7); // "YYYY-MM-DD" -> "MM"
                    const amt = (s.products||[]).reduce((a, p) => a + (Number(p.amount)||0), 0);
                    if (s.currency === 'USD') monthlyUSD[m] = (monthlyUSD[m] || 0) + amt;
                    else if (s.currency === 'TWD') monthlyTWD[m] = (monthlyTWD[m] || 0) + amt;
                });

                const chartDataUSD = Object.keys(monthlyUSD).sort().map(m => ({ month: `${m}月`, amount: Math.round(monthlyUSD[m]) }));
                const chartDataTWD = Object.keys(monthlyTWD).sort().map(m => ({ month: `${m}月`, amount: Math.round(monthlyTWD[m]) }));

                return { count, items, w, chartDataUSD, chartDataTWD };
            }, [shipments, yearFilter]);

            return (
                <div className="space-y-4 animate-fade-in pb-20">
                     <div className="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm sticky top-[110px] z-30">
                        <h2 className="text-lg font-bold text-gray-800">📊 {yearFilter} 年度統計</h2>
                        <select value={yearFilter} onChange={e => setYearFilter(Number(e.target.value))} className="bg-gray-100 text-gray-700 font-bold text-sm py-1 px-3 rounded-lg outline-none">
                            {[2023, 2024, 2025, 2026].map(y => <option key={y} value={y}>{y} 年</option>)}
                        </select>
                     </div>

                     <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">年度總筆數</div><div className="text-2xl font-black text-gray-800">{stats.count}</div></div>
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">年度總件數</div><div className="text-2xl font-black text-blue-600">{stats.items.toLocaleString()}</div></div>
                     </div>

                     {canSeePrice && (
                         <>
                            <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                                <h3 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2"><div className="w-2 h-4 bg-emerald-400 rounded-sm"></div>美金採購趨勢 (USD)</h3>
                                <SimpleBarChart data={stats.chartDataUSD} currency="USD" />
                            </div>
                            <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                                <h3 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2"><div className="w-2 h-4 bg-blue-400 rounded-sm"></div>台幣採購趨勢 (TWD)</h3>
                                <SimpleBarChart data={stats.chartDataTWD} currency="TWD" />
                            </div>
                         </>
                     )}
                </div>
            );
        };

        // ==========================================
        // 4. Main App Container
        // ==========================================
        function ContainerApp() {
            const [user, setUser] = useState(null);
            const [shipments, setShipments] = useState([]);
            const [view, setView] = useState('list'); 
            const [displayMode, setDisplayMode] = useState('card');
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            const [currentTab, setCurrentTab] = useState('NOT_DEVANED'); 
            const [userRole, setUserRole] = useState('GUEST');

            // --- Authentication & Permission Logic ---
            useEffect(() => {
                if (!auth) { setLoading(false); return; }
                const authUnsub = auth.onAuthStateChanged((u) => { setUser(u); if (!u) setLoading(false); });
                
                let dbUnsub = () => {};

                if (user) {
                    dbUnsub = db.collection('shipments').onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        data.sort((a, b) => {
                            const dateA = a.arrivalDate ? new Date(a.arrivalDate).getTime() : 0;
                            const dateB = b.arrivalDate ? new Date(b.arrivalDate).getTime() : 0;
                            return dateB - dateA;
                        });
                        setShipments(data);
                        setLoading(false);
                    });

                    // Role determination (Simplified)
                    // In a real app, you would fetch this from a 'users' or 'settings' collection
                    if (ADMIN_EMAILS.includes(user.email)) {
                        setUserRole('MANAGER');
                    } else if (user.isAnonymous) {
                        setUserRole('GUEST');
                    } else {
                         // Default fallback for other logged in users
                         // You can modify this to query firestore for specific roles
                         setUserRole('PURCHASING'); 
                    }
                }
                return () => { authUnsub(); dbUnsub(); };
            }, [user]);

            const handleLogin = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (ex) { alert("登入失敗"); } };
            const handleGuestLogin = async () => { try { await auth.signInAnonymously(); } catch (ex) { alert("訪客登入失敗"); } };
            const handleLogout = () => auth.signOut();

            // Permissions Matrix
            const canManage = () => userRole === 'MANAGER';
            const canEdit = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC', 'ACCOUNTING'].includes(userRole);
            const canCreate = () => ['MANAGER', 'PURCHASING'].includes(userRole); 
            const canDelete = () => ['MANAGER', 'PURCHASING'].includes(userRole); 
            const canUpload = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole);
            const canSeePrice = () => ['MANAGER', 'PURCHASING', 'ACCOUNTING'].includes(userRole); 
            const canEditForeignFinance = () => ['MANAGER', 'ACCOUNTING'].includes(userRole); 
            const canEditDomesticFull = () => ['MANAGER', 'PURCHASING'].includes(userRole); 
            const canEditWarehouseFields = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE'].includes(userRole); 
            const isWarehouse = () => userRole === 'WAREHOUSE';

            // --- Form State ---
            const initialFormState = { 
                importCompany: IMPORT_COMPANIES[0], 
                customsBroker: CUSTOMS_BROKERS[0], 
                origin: '', supplier: '', 
                arrivalDate: new Date().toISOString().split('T')[0], 
                containerNumber: '', shippingCompany: '', 
                products: [{ id: Date.now(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'quantity' }], 
                totalQuantity: 0, totalWeight: 0, 
                docUrl: '', docName: '', docRefPath: '', 
                devanningLocation: '', devanningDate: '', 
                warehouseConfirmed: false, attachments: [], 
                isPaid: false, currency: 'USD', paymentTerm: '到港前付款', prepayment: 0
            };
            const [formData, setFormData] = useState(initialFormState);

            const handleInputChange = (e) => { 
                const { name, value, type, checked } = e.target;
                const val = type === 'checkbox' ? checked : value;
                
                setFormData(prev => {
                    const newData = { ...prev, [name]: name === 'containerNumber' ? val.toUpperCase() : val };
                    // Currency & Payment Term Logic Switch
                    if (name === 'customsBroker') {
                        if (val === DOMESTIC_FLAG) {
                            newData.currency = 'TWD';
                            newData.paymentTerm = PAYMENT_TERMS_DOMESTIC[0];
                            newData.prepayment = 0;
                        } else {
                            newData.currency = 'USD';
                            newData.paymentTerm = '到港前付款';
                        }
                    }
                    return newData;
                });
            };

            const handleProductChange = (idx, field, value) => { 
                const np = [...formData.products];
                np[idx] = { ...np[idx], [field]: value };
                
                const p = np[idx];
                const q = parseFloat(p.quantity) || 0;
                const b = parseFloat(p.boxCapacity) || 1;
                const w = parseFloat(p.weight) || 0;
                const u = parseFloat(p.unitPrice) || 0;
                
                // Calculate Amount
                if (p.pricingMode === 'weight') p.amount = roundAmount(w * u); 
                else p.amount = roundAmount(q * b * u); 

                setFormData(prev => ({ 
                    ...prev, 
                    products: np, 
                    totalQuantity: np.reduce((s, i) => s + (Number(i.quantity)||0), 0),
                    totalWeight: roundAmount(np.reduce((s, i) => s + (Number(i.weight)||0), 0))
                })); 
            };

            // CRUD Operations
            const addProductRow = () => setFormData(prev => ({ ...prev, products: [...prev.products, { id: Date.now() + Math.random(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'quantity' }] }));
            
            const removeProductRow = (idx) => {
                const np = formData.products.filter((_, i) => i !== idx);
                setFormData(prev => ({ ...prev, products: np, totalQuantity: np.reduce((s, i) => s + Number(i.quantity||0), 0), totalWeight: prev.totalWeight })); 
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!canEdit()) return alert("權限不足");
                
                setIsSubmitting(true);
                try {
                    const payload = { ...formData, updatedAt: new Date().toISOString() };
                    if (editingId) await db.collection('shipments').doc(editingId).update(payload);
                    else await db.collection('shipments').add({ ...payload, createdAt: new Date().toISOString() });
                    setFormData(initialFormState); setEditingId(null); setView('list');
                } catch (ex) { alert("Error: " + ex.message); } finally { setIsSubmitting(false); }
            };

            const handleEdit = (item) => {
                if (!canEdit()) return;
                setFormData({ 
                    ...initialFormState, ...item,
                    // Ensure currency defaults correctly if missing in old data
                    currency: item.currency || (item.customsBroker === DOMESTIC_FLAG ? 'TWD' : 'USD') 
                });
                setEditingId(item.id); setView('form');
            };

            const handleDelete = async (id) => {
                if (!canDelete() || !confirm('確定刪除?')) return;
                await db.collection('shipments').doc(id).delete();
            };

            const handleExport = () => {
                if (userRole === 'GUEST') return alert("權限不足");
                let header = "進口公司,報關行,櫃號,到港日,產地,廠商,品名,規格,數量,重量,計價模式,總數,文件,拆櫃地點,拆櫃日期,匯款狀態,幣別,付款條件,預付款";
                if (canSeePrice()) header += ",單價,金額";
                header += "\n";

                const rows = filteredShipments.flatMap(s => (s.products || []).map(p => {
                    let row = [s.importCompany, s.customsBroker, s.containerNumber, s.arrivalDate, s.origin, s.supplier, p.name, p.spec, p.quantity, p.weight, p.pricingMode, s.totalQuantity, (s.attachments||[]).map(a=>a.url).join(';'), s.devanningLocation, s.devanningDate, s.isPaid?'已匯':'未匯', s.currency, s.paymentTerm, s.prepayment];
                    if (canSeePrice()) row.push(p.unitPrice, p.amount);
                    return row.map(f => `"${String(f||'').replace(/"/g,'""')}"`).join(",");
                })).join("\n");
                
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob(["\uFEFF"+header+rows], {type:"text/csv;charset=utf-8;"}));
                link.download = `Shipments_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };
            
            // --- File Upload Helpers ---
             const handleFileUpload = async (e) => {
                if(!canUpload()) return alert("權限不足");
                const file = e.target.files[0]; if (!file) return; setUploading(true);
                try { 
                    const ref = storage.ref('docs/' + Date.now() + '_' + file.name); 
                    await ref.put(file); 
                    const url = await ref.getDownloadURL(); 
                    setFormData(prev => ({ ...prev, attachments: [...(prev.attachments||[]), { name: file.name, url: url, path: ref.fullPath }] }));
                } catch (ex) { alert("Upload Failed"); } finally { setUploading(false); }
            };
            const handleDeleteFile = async (idx) => {
                const att = formData.attachments[idx];
                if(att.path) await storage.ref(att.path).delete().catch(e=>console.log(e));
                setFormData(prev => ({ ...prev, attachments: prev.attachments.filter((_, i) => i !== idx) }));
            };

            // --- Filtering Logic ---
            const filteredShipments = useMemo(() => {
                const t = searchTerm.toLowerCase();
                return shipments.filter(s => (
                    (s.containerNumber || "").toLowerCase().includes(t) || 
                    (s.supplier || "").toLowerCase().includes(t) ||
                    (s.products || []).some(p => (p.name || "").toLowerCase().includes(t))
                ));
            }, [shipments, searchTerm]);

            const isDomestic = (s) => (s.customsBroker || '').includes(DOMESTIC_FLAG);
            const todayStr = new Date().toISOString().split('T')[0];
            
            const listData = useMemo(() => {
                const unpaid = filteredShipments.filter(s => !s.isPaid).sort((a,b) => new Date(a.arrivalDate) - new Date(b.arrivalDate));
                const domestic = filteredShipments.filter(s => isDomestic(s)).sort((a,b) => new Date(b.arrivalDate) - new Date(a.arrivalDate));
                const foreign = filteredShipments.filter(s => !isDomestic(s));
                
                const notDevanned = foreign.filter(s => !s.devanningDate || s.devanningDate > todayStr).sort((a,b) => new Date(a.arrivalDate) - new Date(b.arrivalDate));
                const devanned = foreign.filter(s => s.devanningDate && s.devanningDate <= todayStr).sort((a,b) => new Date(b.devanningDate) - new Date(a.devanningDate));
                
                return { unpaid, domestic, notDevanned, devanned };
            }, [filteredShipments, todayStr]);

            const currentList = useMemo(() => {
                if (currentTab === 'UNPAID') return listData.unpaid;
                if (currentTab === 'DOMESTIC') return listData.domestic;
                if (currentTab === 'DEVANED') return listData.devanned;
                return listData.notDevanned;
            }, [currentTab, listData]);

            const urgentCount = useMemo(() => {
                return shipments.filter(s => {
                    if (!s.arrivalDate) return false;
                    const diff = Math.ceil((new Date(s.arrivalDate) - new Date()) / (86400000));
                    return diff >= 0 && diff <= 3;
                }).length;
            }, [shipments]);


            // --- Renderers ---
            const renderTableView = () => (
                <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200 mt-2">
                    <table className="reconcile-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>櫃號/單號</th>
                                <th>廠商</th>
                                <th>品名</th>
                                <th className="text-right">總數量</th>
                                <th className="text-right">總重量</th>
                                {canSeePrice() && <th className="text-right">總金額</th>}
                                <th className="text-center">狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                            {currentList.map(item => {
                                const totalAmt = (item.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                                return (
                                    <tr key={item.id} onClick={() => handleEdit(item)} className="cursor-pointer">
                                        <td>{item.arrivalDate}</td>
                                        <td className="font-bold">{item.containerNumber}</td>
                                        <td>{item.supplier}</td>
                                        <td className="truncate max-w-[150px]">{item.products[0]?.name}{item.products.length>1?`...(+${item.products.length-1})`:''}</td>
                                        <td className="text-right text-blue-600 font-bold">{item.totalQuantity.toLocaleString()}</td>
                                        <td className="text-right text-orange-500">{item.totalWeight.toLocaleString()}</td>
                                        {canSeePrice() && <td className="text-right text-emerald-600 font-bold">{item.currency} {totalAmt.toLocaleString()}</td>}
                                        <td className="text-center">{item.isPaid ? '✅' : '❌'}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );

            const renderCardFooter = (item) => {
                const totalAmt = (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                return (
                    <div className={`mt-3 pt-3 border-t border-gray-100 grid gap-2 ${canSeePrice() ? 'grid-cols-3' : 'grid-cols-2'}`}>
                        <div className="text-center">
                            <div className="text-[10px] text-gray-400 font-bold">總數量</div>
                            <div className="text-lg font-black text-blue-600">{(item.totalQuantity||0).toLocaleString()} <span className="text-xs">件</span></div>
                        </div>
                        <div className="text-center border-l border-gray-100">
                            <div className="text-[10px] text-gray-400 font-bold">總重量</div>
                            <div className="text-lg font-black text-orange-500">{(item.totalWeight||0).toLocaleString()} <span className="text-xs">kg</span></div>
                        </div>
                        {canSeePrice() && (
                            <div className="text-center border-l border-gray-100">
                                <div className="text-[10px] text-gray-400 font-bold">總金額 ({item.currency})</div>
                                <div className="text-lg font-black text-emerald-600">${totalAmt.toLocaleString()}</div>
                            </div>
                        )}
                    </div>
                );
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-gray-400">Loading {APP_VERSION}...</div>;

            if (!user) {
                return (
                    <div className="h-screen flex items-center justify-center bg-gray-50 p-4">
                        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                            <div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200"><Icons.Ship /></div>
                            <h1 className="text-2xl font-bold text-gray-900 mb-2">貨櫃管理系統</h1>
                            <div className="text-xs text-blue-400 font-mono mb-8">{APP_VERSION}</div>
                            <div className="space-y-3">
                                <button onClick={handleLogin} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2"><Icons.Google /> 員工登入</button>
                                <button onClick={handleGuestLogin} className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition flex items-center justify-center gap-2"><Icons.User /> 訪客登入</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* 1. Sticky Header Group (Absolute Top) */}
                    <div className="sticky-header-container shadow-sm border-b border-gray-200">
                        <div className="bg-white px-4 h-14 flex items-center justify-between">
                            <div className="flex items-center gap-2 font-bold text-gray-900">
                                <div className="w-6 h-6 text-blue-600"><Icons.Ship /></div>
                                <span>{view === 'list' ? '貨櫃列表' : '統計分析'}</span>
                                <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{APP_VERSION}</span>
                            </div>
                            <div className="flex gap-3 items-center">
                                <div className="relative cursor-pointer" onClick={() => setShowNotifications(!showNotifications)}>
                                    <div className={`text-gray-500 ${urgentCount > 0 ? 'text-red-500 bell-shake' : ''}`}><Icons.Bell /></div>
                                    {urgentCount > 0 && <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border border-white"></span>}
                                </div>
                                {canCreate() && <button onClick={() => { setFormData(initialFormState); setEditingId(null); setView('form'); }} className="text-blue-600"><Icons.Plus /></button>}
                                <button onClick={handleExport} className="text-gray-500"><Icons.Download /></button>
                                <button onClick={handleLogout} className="text-red-400"><Icons.LogOut /></button>
                            </div>
                        </div>

                        {/* 2. Sticky Tabs & Search Bar (Only in List View) */}
                        {view === 'list' && (
                            <div className="px-4 py-2 bg-gray-100/95 backdrop-blur-sm">
                                {/* Tabs */}
                                <div className="flex bg-white rounded-xl p-1 shadow-sm border border-gray-200 mb-2 overflow-x-auto">
                                    {canSeePrice() && (
                                        <button onClick={() => setCurrentTab('UNPAID')} className={`flex-1 py-1.5 px-3 text-xs font-bold rounded-lg whitespace-nowrap transition-colors ${currentTab === 'UNPAID' ? 'bg-blue-600 text-white shadow' : 'text-gray-500 hover:bg-gray-50'}`}>
                                            待付款 ({listData.unpaid.length})
                                        </button>
                                    )}
                                    {[
                                        { id: 'NOT_DEVANED', label: '未拆櫃', list: listData.notDevanned },
                                        { id: 'DEVANED', label: '已拆櫃', list: listData.devanned },
                                        { id: 'DOMESTIC', label: '國內', list: listData.domestic }
                                    ].map(tab => {
                                        const unconfirmed = tab.list.filter(i => !i.warehouseConfirmed).length;
                                        return (
                                            <button key={tab.id} onClick={() => setCurrentTab(tab.id)} className={`flex-1 py-1.5 px-3 text-xs font-bold rounded-lg whitespace-nowrap transition-colors flex items-center justify-center gap-1 ${currentTab === tab.id ? 'bg-blue-600 text-white shadow' : 'text-gray-500 hover:bg-gray-50'}`}>
                                                {tab.label}
                                                {unconfirmed > 0 && <span className="w-2 h-2 bg-red-500 rounded-full ml-1" title={`${unconfirmed} 筆未確認`}></span>}
                                            </button>
                                        );
                                    })}
                                </div>
                                
                                {/* Search & View Toggle */}
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <div className="absolute left-3 top-2.5 text-gray-400 w-4"><Icons.Search /></div>
                                        <input 
                                            placeholder="搜尋櫃號、廠商、貨品..." 
                                            value={searchTerm} 
                                            onChange={e => setSearchTerm(e.target.value)} 
                                            className="w-full bg-white text-gray-900 rounded-xl py-2 pl-9 pr-4 text-sm shadow-sm outline-none focus:ring-2 focus:ring-blue-500/50" 
                                        />
                                    </div>
                                    <button onClick={() => setDisplayMode(displayMode === 'card' ? 'table' : 'card')} className={`p-2 rounded-xl shadow-sm ${displayMode === 'table' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-500'}`}>
                                        {displayMode === 'card' ? <Icons.List /> : <Icons.Grid />}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 3. Scrollable Content Area */}
                    <main className="flex-1 overflow-y-auto px-4 py-4 scroll-smooth">
                        {view === 'list' ? (
                            <div className="max-w-3xl mx-auto pb-20">
                                {displayMode === 'card' ? (
                                    <div className="grid gap-4">
                                        {currentList.map(item => {
                                             const status = getStatusStyle(item.arrivalDate);
                                             const isDom = isDomestic(item);
                                             return (
                                                <div key={item.id} className="ios-card" onClick={() => handleEdit(item)}>
                                                    <div className="p-4 border-b border-gray-50 flex gap-4">
                                                        {/* Date Badge */}
                                                        <div className={`flex-shrink-0 w-14 flex flex-col items-center justify-center rounded-xl border ${status.bg} h-16`}>
                                                            <span className="text-[10px] font-bold uppercase text-gray-500">{new Date(item.arrivalDate).toLocaleString('default', { month: 'short' })}</span>
                                                            <span className="text-xl font-bold text-gray-800 leading-none my-0.5">{new Date(item.arrivalDate).getDate()}</span>
                                                            <span className={`text-[9px] font-bold ${status.color}`}>{status.text}</span>
                                                        </div>
                                                        {/* Info */}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex justify-between items-start mb-1">
                                                                <div className="flex-1 min-w-0">
                                                                    <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold mb-1 ${getCompanyColor(item.importCompany)}`}>{item.importCompany}</span>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-lg font-bold text-gray-900 font-mono tracking-tight">{item.containerNumber}</span>
                                                                    </div>
                                                                </div>
                                                                <div className="flex gap-2 ml-2">
                                                                    {item.attachments?.length > 0 && <div className="text-blue-500"><Icons.Paperclip /></div>}
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-wrap gap-2 mt-1 items-center">
                                                                <div className="tag-badge bg-gray-100 text-gray-600"><Icons.Factory /> {item.supplier}</div>
                                                                {isDom ? (
                                                                    <div className="tag-badge bg-red-50 text-red-600"><Icons.Briefcase /> {item.devanningLocation || '未填交貨地'}</div>
                                                                ) : (
                                                                    <>
                                                                        <div className="tag-badge bg-gray-100 text-gray-600"><Icons.Globe /> {item.origin}</div>
                                                                        {item.devanningDate && <div className="tag-badge bg-green-50 text-green-700">拆: {item.devanningDate}</div>}
                                                                    </>
                                                                )}
                                                                <span className={`tag-badge ${item.warehouseConfirmed ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}`}>{item.warehouseConfirmed ? '已收' : '未收'}</span>
                                                                <span className={`tag-badge ${item.isPaid ? 'bg-green-100 text-green-700' : 'bg-red-50 text-red-600'}`}>{item.isPaid ? '已匯' : '未匯'}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {/* Product Preview */}
                                                    <div className="p-3 bg-gray-50/50">
                                                        {(item.products||[]).slice(0, 2).map((p, idx) => (
                                                            <div key={idx} className="flex justify-between text-xs mb-1 last:mb-0">
                                                                <span className="text-gray-700 font-bold truncate pr-2">{p.name}</span>
                                                                <span className="text-gray-500 whitespace-nowrap">{p.quantity.toLocaleString()} 件</span>
                                                            </div>
                                                        ))}
                                                        {item.products.length > 2 && <div className="text-[10px] text-gray-400 mt-1">還有 {item.products.length - 2} 項...</div>}
                                                    </div>
                                                    {renderCardFooter(item)}
                                                </div>
                                             );
                                        })}
                                        {currentList.length === 0 && <div className="text-center py-12 text-gray-400">尚無資料</div>}
                                    </div>
                                ) : (
                                    renderTableView()
                                )}
                            </div>
                        ) : view === 'stats' ? (
                            <div className="max-w-3xl mx-auto">
                                <Dashboard shipments={shipments} canSeePrice={canSeePrice()} />
                            </div>
                        ) : (
                            /* ================= Form View ================= */
                            <div className="max-w-2xl mx-auto ios-card p-5 animate-fade-in pb-20">
                                <div className="flex justify-between items-center mb-5 pb-3 border-b border-gray-100">
                                    <h2 className="text-lg font-bold text-gray-900">{editingId ? '編輯' : '新增'}貨櫃</h2>
                                    <button onClick={() => setView('list')} className="text-gray-400"><Icons.X /></button>
                                </div>
                                <form onSubmit={handleSubmit} className="space-y-5">
                                    {/* Top Section */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-400 mb-1">進口公司</label>
                                            <select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={isWarehouse()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none">
                                                {IMPORT_COMPANIES.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-400 mb-1">櫃號</label>
                                            <input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={isWarehouse()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm font-mono uppercase outline-none" placeholder={formData.customsBroker === DOMESTIC_FLAG ? '免填' : 'TEMU...'} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="block text-xs font-bold text-gray-400 mb-1">日期</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={isWarehouse()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none" /></div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-400 mb-1">報關行</label>
                                            <select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={isWarehouse()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none">
                                                {CUSTOMS_BROKERS.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    {/* Logistics Info */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="block text-xs font-bold text-gray-400 mb-1">產地</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} disabled={isWarehouse()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o}/>)}</datalist></div>
                                        <div><label className="block text-xs font-bold text-gray-400 mb-1">廠商</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={isWarehouse()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none" /></div>
                                    </div>

                                    {/* Finance Section (Conditional) */}
                                    <div className="pt-3 border-t border-gray-100">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="font-bold text-gray-900 text-sm">財務與物流</h3>
                                            <div className="flex gap-3">
                                                {canSeePrice() && (
                                                    <label className="flex items-center gap-1 cursor-pointer">
                                                        <input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-4 h-4 text-green-600 rounded" />
                                                        <span className="text-xs font-bold text-green-700">已匯款</span>
                                                    </label>
                                                )}
                                                <label className="flex items-center gap-1 cursor-pointer">
                                                    <input type="checkbox" name="warehouseConfirmed" checked={formData.warehouseConfirmed} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-4 h-4 text-blue-600 rounded" />
                                                    <span className="text-xs font-bold text-blue-700">已收貨</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="block text-xs font-bold text-gray-400 mb-1">拆櫃/交貨地</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none" /></div>
                                            <div><label className="block text-xs font-bold text-gray-400 mb-1">拆櫃/交貨日</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none" /></div>
                                        </div>
                                        {canSeePrice() && (
                                            <div className="grid grid-cols-2 gap-3 mt-3">
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-400 mb-1">付款條件</label>
                                                    {formData.currency === 'TWD' ? (
                                                        <select name="paymentTerm" value={formData.paymentTerm} onChange={handleInputChange} disabled={!canEditDomesticFull()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none">
                                                            {PAYMENT_TERMS_DOMESTIC.map(t => <option key={t} value={t}>{t}</option>)}
                                                        </select>
                                                    ) : (
                                                        <input value="到港前付款" disabled className="w-full bg-gray-100 border border-gray-200 rounded-lg px-3 py-2.5 text-sm text-gray-500" />
                                                    )}
                                                </div>
                                                {formData.currency !== 'TWD' && (
                                                    <div>
                                                        <label className="block text-xs font-bold text-gray-400 mb-1">預付款 ({formData.currency})</label>
                                                        <input type="number" step="0.01" name="prepayment" value={formData.prepayment} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-full input-bg-style rounded-lg px-3 py-2.5 text-sm outline-none" />
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* Products Section */}
                                    <div className="pt-3 border-t border-gray-100">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="font-bold text-gray-900 text-sm">產品明細</h3>
                                            {!canEditDomesticFull() && <button type="button" onClick={addProductRow} className="text-blue-600 text-sm font-bold">+ 新增</button>}
                                        </div>
                                        <div className="space-y-4">
                                            {formData.products.map((p, idx) => (
                                                <div key={idx} className="bg-white border border-gray-200 rounded-xl p-4 relative shadow-sm">
                                                    <div className="grid grid-cols-12 gap-2 mb-2">
                                                        <div className="col-span-8"><label className="block text-[10px] font-bold text-gray-400">品名</label><input value={p.name} onChange={e => handleProductChange(idx, 'name', e.target.value)} disabled={!canEditDomesticFull()} className="w-full input-bg-style rounded px-2 py-1.5 text-sm font-bold" /></div>
                                                        <div className="col-span-4"><label className="block text-[10px] font-bold text-gray-400">計價</label><select value={p.pricingMode} onChange={e => handleProductChange(idx, 'pricingMode', e.target.value)} disabled={!canEditDomesticFull()} className="w-full bg-gray-100 rounded px-1 py-1.5 text-xs font-bold text-blue-600 outline-none"><option value="quantity">數量</option><option value="weight">重量</option></select></div>
                                                    </div>
                                                    <div className="grid grid-cols-12 gap-2 mb-2">
                                                         <div className="col-span-4"><label className="block text-[10px] font-bold text-gray-400">規格</label><input value={p.spec} onChange={e => handleProductChange(idx, 'spec', e.target.value)} disabled={!canEditDomesticFull()} className="w-full input-bg-style rounded px-2 py-1.5 text-sm" /></div>
                                                         <div className="col-span-4"><label className="block text-[10px] font-bold text-gray-400">件數</label><input type="number" value={p.quantity} onChange={e => handleProductChange(idx, 'quantity', e.target.value)} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded px-2 py-1.5 text-sm text-right font-bold text-blue-600" /></div>
                                                         <div className="col-span-4"><label className="block text-[10px] font-bold text-gray-400">重量</label><input type="number" step="0.01" value={p.weight} onChange={e => handleProductChange(idx, 'weight', e.target.value)} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded px-2 py-1.5 text-sm text-right font-bold text-orange-500" /></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 mb-2">
                                                        <input placeholder="批號" value={p.batchNumber} onChange={e => handleProductChange(idx, 'batchNumber', e.target.value)} disabled={!canEditWarehouseFields()} className="input-bg-style rounded px-2 py-1.5 text-xs" />
                                                        <input type="date" value={p.expiryDate} onChange={e => handleProductChange(idx, 'expiryDate', e.target.value)} disabled={!canEditWarehouseFields()} className="input-bg-style rounded px-2 py-1.5 text-xs" />
                                                    </div>
                                                    {canSeePrice() && (
                                                        <div className="grid grid-cols-2 gap-2 pt-2 border-t border-gray-100 mt-2">
                                                            <div><label className="block text-[10px] font-bold text-gray-400">單價</label><input type="number" step="0.01" value={p.unitPrice} onChange={e => handleProductChange(idx, 'unitPrice', e.target.value)} disabled={!canEditForeignFinance()} className="w-full input-bg-style rounded px-2 py-1.5 text-sm text-right" /></div>
                                                            <div><label className="block text-[10px] font-bold text-gray-400">金額</label><div className="w-full bg-gray-50 rounded px-2 py-1.5 text-sm text-right font-bold text-emerald-600">${(p.amount||0).toLocaleString()}</div></div>
                                                        </div>
                                                    )}
                                                    {(!canEditWarehouseFields() || canEditDomesticFull()) && formData.products.length > 1 && (
                                                        <button type="button" onClick={() => removeProductRow(idx)} className="absolute top-2 right-2 text-gray-300 hover:text-red-500"><Icons.X /></button>
                                                    )}
                                                </div>
                                            ))}
                                            <div className="flex justify-end gap-4 text-sm font-bold text-gray-600 mt-2">
                                                <span>Total: <span className="text-blue-600">{formData.totalQuantity.toLocaleString()} 件</span></span>
                                                {canSeePrice() && <span>Amt: <span className="text-emerald-600">${formData.products.reduce((a,p)=>a+(p.amount||0),0).toLocaleString()}</span></span>}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* File Upload */}
                                    <div className="pt-3 border-t border-gray-100">
                                         <label className="block text-xs font-bold text-gray-400 mb-1">附件</label>
                                         <div className="flex items-center gap-2">
                                            <label className="flex-1 cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm font-bold py-2 rounded-lg flex items-center justify-center gap-2 transition">
                                                <input type="file" className="hidden" onChange={handleFileUpload} disabled={uploading || !canUpload()} />
                                                <Icons.Paperclip /> {uploading ? '上傳中...' : '選擇檔案'}
                                            </label>
                                         </div>
                                         <div className="mt-2 space-y-1">
                                             {(formData.attachments || []).map((f, i) => (
                                                 <div key={i} className="flex justify-between items-center bg-gray-50 px-2 py-1.5 rounded border border-gray-100 text-xs">
                                                     <a href={f.url} target="_blank" className="text-blue-600 truncate flex-1">{f.name}</a>
                                                     {canUpload() && <button type="button" onClick={() => handleDeleteFile(i)} className="text-red-400 ml-2"><Icons.Trash2 /></button>}
                                                 </div>
                                             ))}
                                         </div>
                                    </div>

                                    {/* Actions */}
                                    <div className="flex gap-3 pt-4 sticky bottom-0 bg-white pb-4 z-10 border-t border-gray-100">
                                        <button type="button" onClick={() => setView('list')} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                                        <button type="submit" disabled={isSubmitting} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200">{isSubmitting ? '儲存中...' : '儲存'}</button>
                                    </div>
                                </form>
                            </div>
                        )}
                    </main>

                    {/* 4. Bottom Nav for Mobile */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 flex justify-between z-40 pb-safe">
                        <button onClick={() => setView('list')} className={`flex flex-col items-center gap-1 ${view === 'list' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <div className="w-6 h-6"><Icons.List /></div>
                            <span className="text-[10px] font-bold">列表</span>
                        </button>
                        <button onClick={() => setView('stats')} className={`flex flex-col items-center gap-1 ${view === 'stats' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <div className="w-6 h-6"><Icons.Chart /></div>
                            <span className="text-[10px] font-bold">統計</span>
                        </button>
                    </div>

                     {/* Notification Modal */}
                    {showNotifications && (
                        <div className="mobile-modal-overlay" onClick={() => setShowNotifications(false)}>
                            <div className="mobile-modal-content" onClick={e => e.stopPropagation()}>
                                <div className="bg-gray-50 px-5 py-4 border-b border-gray-100 flex justify-between items-center">
                                    <span className="font-bold text-gray-700">近期到港急件</span>
                                    <button onClick={() => setShowNotifications(false)}><Icons.X /></button>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto p-2">
                                    {shipments.filter(s => {
                                        if (!s.arrivalDate) return false;
                                        const diff = Math.ceil((new Date(s.arrivalDate) - new Date()) / 86400000);
                                        return diff >= 0 && diff <= 3;
                                    }).map(s => (
                                        <div key={s.id} className="p-3 mb-2 bg-white rounded-xl border border-gray-100 shadow-sm">
                                            <div className="flex justify-between mb-1">
                                                <span className="font-bold text-blue-600">{s.containerNumber}</span>
                                                <span className="text-xs font-bold text-red-500">即將到港</span>
                                            </div>
                                            <div className="text-xs text-gray-500 mb-2">{s.importCompany} / {s.supplier}</div>
                                        </div>
                                    ))}
                                    {shipments.every(s => Math.ceil((new Date(s.arrivalDate) - new Date()) / 86400000) < 0 || Math.ceil((new Date(s.arrivalDate) - new Date()) / 86400000) > 3) && <div className="text-center text-gray-400 py-4 text-sm">無急件</div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerApp />);
    </script>
</body>
</html>