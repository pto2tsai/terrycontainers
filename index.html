<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å…«æ–¹ç’°çƒ ERP V17.2 - ç¾ä»£åŒ–è³¼ç‰©è»Šå ±åƒ¹ç³»çµ± ğŸ›’</title>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    window.firebaseModules = { initializeApp, getDatabase, ref, set, get, update, onValue, remove, getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged };
  </script>

  <style>
    /* ğŸ¨ V14.0 ç¾ä»£åŒ–æ¨£å¼ - å…¨æ–°è¨­è¨ˆï¼ */
    body { 
      -webkit-tap-highlight-color: transparent; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      min-height: 100vh;
      font-size: 16px; /* åŸºæº–å­—é«” */
    }
    
    /* ğŸ“ çµ±ä¸€å­—é«”å±¤ç´šç³»çµ± */
    .text-l1 { font-size: 26px; font-weight: 900; } /* é é¢æ¨™é¡Œ */
    .text-l2 { font-size: 20px; font-weight: 700; } /* å€å¡Šæ¨™é¡Œ */
    .text-l3 { font-size: 18px; font-weight: 700; } /* å¡ç‰‡æ¨™é¡Œ/æŒ‰éˆ• */
    .text-l4 { font-size: 18px; } /* ä¸»è¦å…§æ–‡ */
    .text-l5 { font-size: 16px; color: #6b7280; } /* æ¬¡è¦å…§æ–‡ */
    .text-l6 { font-size: 16px; color: #9ca3af; } /* è¼”åŠ©èªªæ˜ */
    
    /* ğŸŒŠ ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .glass-dark {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    
    /* ğŸ’ ç¾ä»£åŒ–å¡ç‰‡é™°å½± */
    .card-shadow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12),
                  0 1px 8px rgba(0, 0, 0, 0.08);
    }
    
    .card-shadow-lg {
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
                  0 10px 30px rgba(0, 0, 0, 0.12);
    }
    
    /* ğŸ¨ æ¼¸è®ŠæŒ‰éˆ• */
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
    }
    
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .btn-gradient:active {
      transform: translateY(0);
    }
    
    /* ğŸŒˆ æ¼¸è®Šæ–‡å­— */
    .text-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* âœ¨ æµæš¢å‹•ç•« */
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .animate-slide-up { animation: slideUp 0.4s ease-out; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    
    /* ğŸ¯ è³¼ç‰©è»Šå¾½ç«  */
    .cart-badge {
      animation: pulse 2s ease-in-out infinite;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    
    /* ğŸ¯ åº«å­˜ç‹€æ…‹å¾½ç«  */
    .badge-green {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .badge-yellow {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .badge-red {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    /* ğŸª è¼‰å…¥å‹•ç•« */
    .loader { 
      border: 3px solid rgba(255, 255, 255, 0.3); 
      border-top: 3px solid #fff; 
      border-radius: 50%; 
      width: 20px; 
      height: 20px; 
      animation: spin 1s linear infinite; 
    }
    
    /* SVG åœ–ç¤º */
    .icon-svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .icon-svg-sm { width: 16px; height: 16px; }
    .icon-svg-lg { width: 24px; height: 24px; }
    
    /* ğŸ“œ éš±è—æ»¾å‹•æ¢ */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* ğŸ–¨ï¸ åˆ—å°æ¨£å¼ */
    @media print {
      body { background: white !important; }
      .no-print { display: none !important; }
      .glass { background: white !important; backdrop-filter: none !important; }
      @page { size: A4; margin: 15mm; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // SVG åœ–ç¤º
    const Icons = {
      Star: ({filled, className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"}>
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
      ),
      Camera: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
      ),
      Copy: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
        </svg>
      ),
      Trash: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
      ),
      Plus: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      ),
      Eye: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      ),
      Send: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      ),
      Clock: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      ),
      Save: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
      ),
      Sparkles: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
        </svg>
      ),
      DollarSign: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="12" y1="1" x2="12" y2="23"/>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
      ),
      Package: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
          <line x1="12" y1="22.08" x2="12" y2="12"/>
        </svg>
      ),
      User: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      ),
      Users: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      ),
      Upload: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      ),
      Settings: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.2 4.2l4.2 4.2M1 12h6m6 0h6M5.6 18.4l4.2-4.2m4.2-4.2l4.2-4.2"/>
        </svg>
      ),
      Search: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      ),
      FileText: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
          <polyline points="10 9 9 9 8 9"/>
        </svg>
      ),
      // ğŸ†• åº•éƒ¨å°èˆªå°ˆç”¨åœ–ç¤º
      Home: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
      ),
      ShoppingCart: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
      ),
      History: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      ),
      Settings: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
        </svg>
      ),
      // ğŸ†• éˆ´éºåœ–ç¤º
      Bell: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
      ),
      // ğŸ†• å·¦ç®­é ­åœ–ç¤º
      ArrowLeft: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="19" y1="12" x2="5" y2="12"/>
          <polyline points="12 19 5 12 12 5"/>
        </svg>
      ),
      // ğŸ†• Chevron åœ–ç¤º
      ChevronLeft: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
      ),
      ChevronRight: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      ),
    };

    // CONFIG
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyD59OwEnbcLZShhTTJJMu1VjJxrvzIcG_g",
            authDomain: "seafoodq-11b9d.firebaseapp.com",
            databaseURL: "https://seafoodq-11b9d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "seafoodq-11b9d",
            storageBucket: "seafoodq-11b9d.firebasestorage.app",
            messagingSenderId: "454420146806",
            appId: "1:454420146806:web:802e6bd5e8e90aab21cd57"
        },
        // ğŸ” Firebase Auth å¸³è™Ÿï¼ˆéœ€å…ˆåœ¨ Firebase Console å»ºç«‹ï¼‰
        accounts: {
            ADMIN: { email: "admin@seafood.erp", password: "admin8888" },
            SALES: { email: "sales@seafood.erp", password: "sales1688" },
            STORE: { email: "store@seafood.erp", password: "store6666" }
        },
        // æœ¬åœ°å¯†ç¢¼é©—è­‰
        pwd: { ADMIN: "8888", SALES: "1688", STORE: "6666" }
    };
    
    let auth = null;

    // å·¥å…·å‡½å¼
    const cleanStr = (s) => s ? String(s).trim() : '';
    const sanitizeKey = (s) => s ? String(s).replace(/[.#$/\[\]]/g, '_').trim() : '';
    const parseNum = (v) => {
        if (!v) return 0;
        if (typeof v === 'number') return v;
        const n = String(v).replace(/,/g, '').match(/-?\d+(\.\d+)?/);
        return n ? parseFloat(n[0]) : 0;
    };

    let db = null;

    // ä¸»æ‡‰ç”¨
    const App = () => {
      const [page, setPage] = useState('login');
      const [currentTab, setCurrentTab] = useState('home'); // ğŸ†• åº•éƒ¨å°èˆªåˆ†é 
      const [role, setRole] = useState('');
      const [status, setStatus] = useState('æœªé€£ç·š');
      const [data, setData] = useState({ 
        products: {}, 
        inventory: {}, 
        tiers: ['é–€å¸‚å”®åƒ¹', 'æœƒå“¡95%', 'é¤å»³90%', 'ç”Ÿæ„åƒ¹', 'æ•´ä»¶åƒ¹', 'VIPåƒ¹', 'æ¥­å‹™åº•åƒ¹', 'èŠ±æ±åƒ¹'], 
        meta: {} 
      });
      const [inputPwd, setInputPwd] = useState('');
      
      // å ±åƒ¹ç‹€æ…‹
      const [cart, setCart] = useState([]);
      const [custInfo, setCustInfo] = useState({ 
        name: '', phone: '', mobile: '', address: '', 
        date: new Date().toISOString().split('T')[0], 
        tier: 'æ•´ä»¶åƒ¹',
        paymentMethod: 'æœˆçµ30å¤©'
      });
      
      // å½ˆçª—ç‹€æ…‹
      const [showProductSearch, setShowProductSearch] = useState(false);
      const [showPriceModal, setShowPriceModal] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [showCustomerDetail, setShowCustomerDetail] = useState(false);
      const [showLowStockAlert, setShowLowStockAlert] = useState(false); // ä½åº«å­˜æé†’å½ˆçª—
      const [lowStockItems, setLowStockItems] = useState([]); // ä½åº«å­˜ç”¢å“æ¸…å–®
      const [showSafetyStockModal, setShowSafetyStockModal] = useState(false); // å®‰å…¨åº«å­˜è¨­å®šå½ˆçª—
      const [safetyStockSearch, setSafetyStockSearch] = useState(''); // å®‰å…¨åº«å­˜æœå°‹
      const [safetyStockFilter, setSafetyStockFilter] = useState('all'); // å®‰å…¨åº«å­˜ç¯©é¸: all, low, out, ok, custom
      const [search, setSearch] = useState('');
      const [expandedStockId, setExpandedStockId] = useState(null); // å±•é–‹çš„å¤–å€‰æ˜ç´°
      const [currentPriceItem, setCurrentPriceItem] = useState(null);
      const [reSelectCartId, setReSelectCartId] = useState(null); // é‡æ–°é¸æ“‡ç”¢å“çš„ cartId
      
      // ğŸ†• V14.0 è¨­å®šé ç‹€æ…‹
      const [settingsTab, setSettingsTab] = useState('import'); // è¨­å®šé  Tab: import, safety, price, account
      const [priceSubTab, setPriceSubTab] = useState('edit'); // æ”¹åƒ¹å­ Tab: edit, publish
      const [priceSearch, setPriceSearch] = useState(''); // æ”¹åƒ¹æœå°‹
      const [expandedPriceProducts, setExpandedPriceProducts] = useState({}); // å±•é–‹çš„ç”¢å“
      const [editedPrices, setEditedPrices] = useState({}); // ç·¨è¼¯ä¸­çš„åƒ¹æ ¼
      const [productStatusEdits, setProductStatusEdits] = useState({}); // ç”¢å“ç‹€æ…‹ç·¨è¼¯ï¼ˆæ–°å“ã€ä¿ƒéŠ·ï¼‰
      const [publishCategory, setPublishCategory] = useState('all'); // ç™¼å¸ƒåˆ†é¡ç¯©é¸
      const [editingProduct, setEditingProduct] = useState(null); // æ­£åœ¨ç·¨è¼¯çš„ç”¢å“
      const [editingPrices, setEditingPrices] = useState({}); // ç·¨è¼¯ä¸­çš„åƒ¹æ ¼ï¼ˆå½ˆçª—ç”¨ï¼‰
      const [editingStatus, setEditingStatus] = useState({ isNew: false, isPromo: false }); // ç·¨è¼¯ä¸­çš„ç‹€æ…‹
      const [editingRemark, setEditingRemark] = useState(''); // ç·¨è¼¯ä¸­çš„å‚™è¨»
      const [productRemarks, setProductRemarks] = useState({}); // ç”¢å“å‚™è¨»ï¼ˆid -> remarkï¼‰
      const [editingGroup, setEditingGroup] = useState(null); // æ­£åœ¨ç·¨è¼¯çš„åˆ†çµ„
      const [groupEditData, setGroupEditData] = useState({}); // åˆ†çµ„ç·¨è¼¯è³‡æ–™ { productId: { prices, status, remark } }
      
      // å®‰å…¨åº«å­˜è¨­å®šï¼ˆé è¨­ 40 ä»¶ï¼‰
      const DEFAULT_SAFETY_STOCK = 40;
      
      // ğŸ†• CRM ç‹€æ…‹
      const [customerDB, setCustomerDB] = useState({}); // å®¢æˆ¶è³‡æ–™åº«
      const [showCRM, setShowCRM] = useState(false); // CRM é é¢
      const [crmSearch, setCrmSearch] = useState(''); // CRM æœå°‹
      const [crmFilter, setCrmFilter] = useState('all'); // CRM ç¯©é¸: all, A, B, C, D, warning, danger
      const [crmSalesRep, setCrmSalesRep] = useState(''); // æ¥­å‹™å“¡éæ¿¾
      const [showCustomerPicker, setShowCustomerPicker] = useState(false); // å®¢æˆ¶é¸æ“‡å™¨
      const [editingCustomer, setEditingCustomer] = useState(null); // ç·¨è¼¯ä¸­çš„å®¢æˆ¶
      const [crmSort, setCrmSort] = useState('amount'); // æ’åº: amount, name, lastOrder
      const [expandedCustomer, setExpandedCustomer] = useState(null); // å±•é–‹çš„å®¢æˆ¶ key
      const [crmPage, setCrmPage] = useState(1); // å®¢æˆ¶åˆ—è¡¨åˆ†é 
      const CRM_PAGE_SIZE = 20; // æ¯é é¡¯ç¤ºç­†æ•¸
      
      // å€‰åº«è¨­å®šï¼ˆä¾è§’è‰²å€åˆ†ï¼‰
      const FACTORY_WAREHOUSES = ['å´‡æ–‡_ç™½è¦', 'å…«æ–¹_ç™½è¦', 'å´‡æ–‡_æˆå“', 'å…«æ–¹_æˆå“', 'å´‡æ–‡_åŸæ–™', 'å…«æ–¹_åŸæ–™', 'å´‡æ–‡_åŠæˆå“åº«'];
      const STORE_WAREHOUSES = ['é–€å¸‚åº«'];
      
      // æ ¹æ“šè§’è‰²å–å¾—ä¸»è¦å€‰åº«ï¼ˆåœ¨å…ƒä»¶å…§ä½¿ç”¨ï¼‰
      const getMainWarehouses = (currentRole) => {
        return currentRole === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
      };
      
      // é è¨­ä¸»è¦å‡ºè²¨å€‰åº«åˆ—è¡¨ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
      const MAIN_WAREHOUSES = FACTORY_WAREHOUSES;
      
      // æœ¬åœ°å„²å­˜
      const [quotes, setQuotes] = useState([]);

      // è¼‰å…¥æœ¬åœ°è³‡æ–™
      useEffect(() => {
        const saved = localStorage.getItem('erpQuotesV11');
        if (saved) {
          try {
            setQuotes(JSON.parse(saved));
          } catch (e) {}
        }
      }, []);

      const saveLocal = () => {
        localStorage.setItem('erpQuotesV11', JSON.stringify(quotes));
      };

      // Firebase åˆå§‹åŒ–
      const initDB = () => {
        if (db) return true;
        if (!window.firebaseModules) return false;
        try {
            const { initializeApp, getDatabase, getAuth } = window.firebaseModules;
            const app = initializeApp(CONFIG.firebase);
            db = getDatabase(app);
            auth = getAuth(app);
            return true;
        } catch (e) {
            alert("Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message);
            return false;
        }
      };

      // ç›£è¯è³‡æ–™
      const listenDB = () => {
          if (!initDB()) return;
          const { ref, onValue } = window.firebaseModules;
          setStatus('é€£ç·šä¸­...');
          onValue(ref(db, 'seafoodData'), (snap) => {
              const val = snap.val();
              if (val) {
                  setData({
                      products: val.productDB || {},
                      inventory: val.inventoryDB || {},
                      tiers: val.priceTiers || ['ç”Ÿæ„åƒ¹'],
                      meta: val.dbMeta || {},
                      safetyStock: val.safetyStock || {}, // å·¥å» å®‰å…¨åº«å­˜è¨­å®š
                      storeSafetyStock: val.storeSafetyStock || {}, // é–€å¸‚å®‰å…¨åº«å­˜è¨­å®š
                      discontinuedProducts: val.discontinuedProducts || {}, // åœå”®å“æ¸…å–®
                      storeOnlyProducts: val.storeOnlyProducts || {}, // é–€å¸‚å°ˆè³£å“æ¸…å–®
                      syncLogs: val.syncLogs || [] // åŒæ­¥æ—¥èªŒ
                  });
                  // ğŸ†• è¼‰å…¥å®¢æˆ¶è³‡æ–™åº«
                  if (val.customerDB) {
                      setCustomerDB(val.customerDB);
                  }
                  setStatus('â— å·²é€£ç·š');
              } else {
                  setStatus('â— è³‡æ–™åº«ç‚ºç©º');
              }
          }, (err) => {
              console.error('Firebase éŒ¯èª¤:', err.code, err.message);
              if (err.code === 'PERMISSION_DENIED') {
                  setStatus('âš ï¸ æ¬Šé™ä¸è¶³ï¼Œè«‹é‡æ–°ç™»å…¥');
              } else {
                  setStatus('é€£ç·šéŒ¯èª¤: ' + (err.code || err.message));
              }
          });
      };
      
      // æª¢æŸ¥ä½åº«å­˜ï¼ˆä»¥ç”¢å“ç‚ºä¸»ï¼ŒåŠ ç¸½æ‰€æœ‰å€‰åº«åº«å­˜ï¼‰
      const checkLowStock = (debug = false) => {
        const lowItems = [];
        const inventory = data.inventory || {};
        const products = data.products || {};
        
        // æ ¹æ“šè§’è‰²é¸æ“‡å€‰åº«å’Œå®‰å…¨åº«å­˜
        const currentWarehouses = role === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
        const currentSafetyStock = role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
        
        // é™¤éŒ¯ï¼šæ”¶é›†æ‰€æœ‰å€‰åº«åç¨±
        const allWarehouses = new Set();
        
        // å»ºç«‹å“è™Ÿåˆ°ç”¢å“è³‡è¨Šçš„å°ç…§è¡¨ï¼ˆåŒ…å«é¡å‹ï¼‰
        const pidToInfo = {};
        Object.entries(products).forEach(([name, specs]) => {
          if (Array.isArray(specs)) {
            specs.forEach(spec => {
              if (spec.id) {
                pidToInfo[spec.id] = { 
                  name, 
                  specDetail: spec.specDetail || '',
                  prodType: spec.prodType || 'è‡ªè£½å“' // é è¨­ç‚ºè‡ªè£½å“
                };
              }
            });
          }
        });
        
        // æª¢æŸ¥æ¯å€‹å“è™Ÿçš„åº«å­˜ï¼ˆä»¥ç”¢å“ç‚ºä¸»ï¼ŒåŠ ç¸½æ‰€æœ‰ä¸»è¦å€‰åº«ï¼‰
        Object.entries(inventory).forEach(([pid, stocks]) => {
          if (!Array.isArray(stocks)) return;
          
          // ğŸ†• å·¥å» è§’è‰²ä¸é¡¯ç¤ºé–€å¸‚å°ˆè³£å“çš„åº«å­˜è­¦å ±
          const isStoreOnly = data.storeOnlyProducts?.[pid];
          if (role !== 'store' && isStoreOnly) return;
          
          // æ”¶é›†æ‰€æœ‰å€‰åº«åç¨±
          stocks.forEach(s => {
            if (s.warehouse) allWarehouses.add(s.warehouse);
          });
          
          // å–å¾—è©²ç”¢å“çš„å®‰å…¨åº«å­˜é‡ï¼ˆå€‹åˆ¥è¨­å®š > é è¨­å€¼ï¼‰
          // æ³¨æ„ï¼š0 ä¹Ÿæ˜¯æœ‰æ•ˆå€¼ï¼Œè¡¨ç¤ºä¸éœ€è¦è­¦å ±
          const safeLine = currentSafetyStock[pid] !== undefined ? currentSafetyStock[pid] : DEFAULT_SAFETY_STOCK;
          const productInfo = pidToInfo[pid] || { name: 'æœªçŸ¥ç”¢å“', specDetail: '', prodType: 'è‡ªè£½å“' };
          
          // å¦‚æœå®‰å…¨åº«å­˜è¨­ç‚º 0ï¼Œè¡¨ç¤ºä¸éœ€è¦è­¦å ±ï¼Œè·³éæ­¤å“é …
          if (safeLine === 0) return;
          
          // ç¯©é¸ä¸»è¦å‡ºè²¨å€‰åº«çš„åº«å­˜ä¸¦åŠ ç¸½
          const mainStocks = stocks.filter(s => currentWarehouses.includes(s.warehouse));
          const totalStock = mainStocks.reduce((sum, s) => sum + Math.floor(s.stock || 0), 0);
          
          // ğŸ†• è¨ˆç®—å…¶ä»–å€‰åº«çš„åº«å­˜ï¼ˆéä¸»è¦å€‰åº«ï¼‰
          const otherStocks = stocks.filter(s => !currentWarehouses.includes(s.warehouse) && s.stock > 0);
          const otherTotalStock = otherStocks.reduce((sum, s) => sum + Math.floor(s.stock || 0), 0);
          
          // é™¤éŒ¯ï¼šå¦‚æœæœ‰åº«å­˜ä½† mainStocks ç‚ºç©º
          if (debug && stocks.length > 0 && mainStocks.length === 0) {
            console.log(`âš ï¸ å“è™Ÿ ${pid} æœ‰ ${stocks.length} ç­†åº«å­˜ï¼Œä½†æ²’æœ‰åŒ¹é…åˆ°ä¸»è¦å€‰åº«:`, stocks.map(s => s.warehouse));
          }
          
          // å¦‚æœç¸½åº«å­˜ä½æ–¼å®‰å…¨æ°´ä½ï¼ŒåŠ å…¥è­¦å ±æ¸…å–®
          if (totalStock < safeLine) {
            // ğŸ†• åˆ¤æ–·è™•ç†æ–¹å¼
            let action = '';
            if (otherTotalStock > 0) {
              action = 'éœ€èª¿æ’¥';
            } else {
              action = productInfo.prodType === 'æ¡è³¼å“' ? 'éœ€æ¡è³¼' : 'éœ€ç”Ÿç”¢';
            }
            
            lowItems.push({
              pid,
              name: productInfo.name,
              specDetail: productInfo.specDetail,
              prodType: productInfo.prodType, // ğŸ†• ç”¢å“é¡å‹
              totalStock,
              safetyStock: safeLine,
              shortage: safeLine - totalStock,
              otherTotalStock, // ğŸ†• å…¶ä»–å€‰åº«åº«å­˜
              action, // ğŸ†• è™•ç†æ–¹å¼
              // å„å€‰åº«æ˜ç´°ï¼ˆé¡¯ç¤ºæ‰€æœ‰æœ‰åº«å­˜çš„å€‰åº«ï¼Œä¸åªä¸»è¦å€‰åº«ï¼‰
              warehouseDetails: stocks.filter(s => s.stock > 0).map(s => ({
                warehouse: s.warehouse,
                stock: Math.floor(s.stock || 0),
                isMain: currentWarehouses.includes(s.warehouse)
              })).sort((a, b) => a.warehouse.localeCompare(b.warehouse)),
              // ğŸ†• å…¶ä»–å€‰åº«æ˜ç´°
              otherWarehouseDetails: otherStocks.map(s => ({
                warehouse: s.warehouse,
                stock: Math.floor(s.stock || 0)
              })).sort((a, b) => b.stock - a.stock)
            });
          }
        });
        
        // é™¤éŒ¯ï¼šé¡¯ç¤ºæ‰€æœ‰å€‰åº«åç¨±
        if (debug) {
          console.log('ğŸ“¦ è³‡æ–™åº«ä¸­çš„æ‰€æœ‰å€‰åº«:', Array.from(allWarehouses).sort());
          console.log('ğŸ“ è¨­å®šçš„ä¸»è¦å€‰åº«:', currentWarehouses);
          console.log('ğŸ‘¤ ç›®å‰è§’è‰²:', role);
        }
        
        // æŒ‰ç¼ºè²¨é‡æ’åºï¼ˆç¼ºè²¨é‡å¤§çš„æ’å‰é¢ï¼‰
        lowItems.sort((a, b) => b.shortage - a.shortage);
        
        return lowItems;
      };
      
      // ç™»å…¥å¾Œæª¢æŸ¥åº«å­˜ï¼ˆå»¶é²åŸ·è¡Œï¼Œç­‰è³‡æ–™è¼‰å…¥ï¼‰
      useEffect(() => {
        if (page === 'main' && Object.keys(data.inventory).length > 0) {
          // ğŸ†• æ¯æ¬¡é€²å…¥éƒ½æª¢æŸ¥ä½åº«å­˜ï¼ˆè®“ç´…é»éˆ´éºèƒ½é¡¯ç¤ºï¼‰
          const items = checkLowStock();
          setLowStockItems(items);
          // ä¸è‡ªå‹•å½ˆçª—ï¼Œä½¿ç”¨è€…éœ€è¦æ™‚è‡ªå·±é»éˆ´éº
        }
      }, [page, data.inventory]);

      // ç™»å…¥ç‹€æ…‹
      const [loginEmail, setLoginEmail] = useState('');
      const [loginLoading, setLoginLoading] = useState(false);

      // ğŸ” Firebase Auth ç™»å…¥
      const handleLogin = async () => {
          if (!initDB()) {
            alert('ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™å†è©¦');
            return;
          }
          
          setLoginLoading(true);
          
          // åˆ¤æ–·æ˜¯ç®¡ç†å“¡ã€æ¥­å‹™é‚„æ˜¯é–€å¸‚
          let email = '';
          let firebasePassword = '';
          let userRole = '';
          
          if (inputPwd === CONFIG.pwd.ADMIN) {
            email = CONFIG.accounts.ADMIN.email;
            firebasePassword = CONFIG.accounts.ADMIN.password;
            userRole = 'admin';
          } else if (inputPwd === CONFIG.pwd.SALES) {
            email = CONFIG.accounts.SALES.email;
            firebasePassword = CONFIG.accounts.SALES.password;
            userRole = 'sales';
          } else if (inputPwd === CONFIG.pwd.STORE) {
            email = CONFIG.accounts.STORE.email;
            firebasePassword = CONFIG.accounts.STORE.password;
            userRole = 'store';
          } else {
            setLoginLoading(false);
            alert("å¯†ç¢¼éŒ¯èª¤");
            return;
          }
          
          try {
            const { signInWithEmailAndPassword } = window.firebaseModules;
            // ä½¿ç”¨ Firebase Auth å¯†ç¢¼ç™»å…¥
            await signInWithEmailAndPassword(auth, email, firebasePassword);
            
            setRole(userRole);
            setPage('main');
            setCurrentTab('quote');
            localStorage.setItem('erpRole', userRole);
            localStorage.setItem('erpLoginTime', Date.now().toString());
            listenDB();
          } catch (error) {
            console.error('Firebase Auth éŒ¯èª¤:', error.code, error.message);
            
            // å¦‚æœ Firebase Auth å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°é©—è­‰ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
            if (inputPwd === CONFIG.pwd.ADMIN || inputPwd === CONFIG.pwd.SALES || inputPwd === CONFIG.pwd.STORE) {
              console.log('ä½¿ç”¨æœ¬åœ°é©—è­‰ï¼ˆFirebase Auth æœªè¨­å®šï¼‰');
              setRole(userRole);
              setPage('main');
              setCurrentTab('quote');
              localStorage.setItem('erpRole', userRole);
              localStorage.setItem('erpLoginTime', Date.now().toString());
              listenDB();
            } else {
              alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
            }
          }
          
          setLoginLoading(false);
      };

      // ğŸ” ç™»å‡º
      const handleLogout = async () => {
        try {
          if (auth) {
            const { signOut } = window.firebaseModules;
            await signOut(auth);
          }
        } catch (e) {
          console.log('ç™»å‡ºéŒ¯èª¤:', e);
        }
        localStorage.removeItem('erpRole');
        localStorage.removeItem('erpLoginTime');
        setRole('');
        setPage('login');
        setCart([]);
      };

      // è‡ªå‹•ç™»å…¥ï¼šé é¢è¼‰å…¥æ™‚æª¢æŸ¥
      useEffect(() => {
        const savedRole = localStorage.getItem('erpRole');
        const loginTime = localStorage.getItem('erpLoginTime');
        
        if (savedRole && loginTime) {
          // æª¢æŸ¥ç™»å…¥æ˜¯å¦éæœŸï¼ˆ7å¤©ï¼‰
          const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;
          const isExpired = Date.now() - parseInt(loginTime) > sevenDaysInMs;
          
          if (!isExpired) {
            // è‡ªå‹•ç™»å…¥ï¼Œç›´æ¥é€²å…¥å ±åƒ¹é 
            setRole(savedRole);
            setPage('main');
            setCurrentTab('quote');
            listenDB();
          } else {
            // ç™»å…¥å·²éæœŸï¼Œæ¸…é™¤è¨˜éŒ„
            localStorage.removeItem('erpRole');
            localStorage.removeItem('erpLoginTime');
          }
        }
      }, []);

      // ğŸ†• å®¢æˆ¶è³‡æ–™ä¸Šå‚³è™•ç†ï¼ˆæ”¯æ´ XLSXï¼‰
      const handleCustomerUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const fileName = file.name.toLowerCase();
        const reader = new FileReader();
        
        reader.onload = (evt) => {
          try {
            let customerData = {};
            
            // åˆ¤æ–·æª”æ¡ˆé¡å‹
            if (fileName.endsWith('.json')) {
              // JSON æ ¼å¼
              customerData = JSON.parse(evt.target.result);
            } else {
              // Excel æ ¼å¼
              const data = new Uint8Array(evt.target.result);
              const wb = XLSX.read(data, { type: 'array' });
              const ws = wb.Sheets[wb.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
              
              console.log('=== å®¢æˆ¶è³‡æ–™åŒ¯å…¥ ===');
              console.log('ç¸½è¡Œæ•¸:', rows.length);
              
              // æ‰¾æ¨™é¡Œåˆ—
              let headerIdx = -1;
              for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const rowStr = (rows[i] || []).join('');
                if (rowStr.includes('å®¢æˆ¶') && (rowStr.includes('ç°¡ç¨±') || rowStr.includes('ä»£è™Ÿ'))) {
                  headerIdx = i;
                  break;
                }
              }
              
              if (headerIdx === -1) {
                alert('âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel åŒ…å«ã€Œå®¢æˆ¶ä»£è™Ÿã€æˆ–ã€Œå®¢æˆ¶ç°¡ç¨±ã€æ¬„ä½');
                return;
              }
              
              const headers = rows[headerIdx].map(h => String(h || '').trim());
              console.log('æ¨™é¡Œåˆ—:', headers.slice(0, 15));
              
              // æ‰¾æ¬„ä½ç´¢å¼•
              const findCol = (keywords) => {
                return headers.findIndex(h => keywords.some(k => h.includes(k)));
              };
              
              const idxId = findCol(['å®¢æˆ¶ä»£è™Ÿ', 'ä»£è™Ÿ']);
              const idxName = findCol(['å®¢æˆ¶ç°¡ç¨±', 'ç°¡ç¨±']);
              const idxFullName = findCol(['å®¢æˆ¶å…¨å', 'å…¨å']);
              const idxContact = findCol(['é€£çµ¡äºº', 'è¯çµ¡äºº']);
              const idxTel1 = findCol(['TEL', 'é›»è©±', 'TEL_NO']);
              const idxTel2 = headers.findIndex((h, i) => i > idxTel1 && (h.includes('TEL') || h.includes('é›»è©±')));
              const idxAddress = findCol(['é€è²¨åœ°å€', 'åœ°å€']);
              const idxTaxId = findCol(['çµ±ä¸€ç·¨è™Ÿ', 'çµ±ç·¨']);
              const idxCredit = findCol(['ä¿¡ç”¨é¡åº¦']);
              const idxPayment = findCol(['ä»˜æ¬¾æ¢ä»¶åç¨±', 'ä»˜æ¬¾æ¢ä»¶']);
              const idxPayMethod = findCol(['æ”¶æ¬¾æ–¹å¼']);
              
              console.log('æ¬„ä½ç´¢å¼•:', { idxId, idxName, idxTel1, idxAddress });
              
              // è™•ç†è³‡æ–™
              const dataRows = rows.slice(headerIdx + 1);
              let count = 0;
              
              dataRows.forEach(row => {
                if (!row || row.length === 0) return;
                
                const name = String(row[idxName] || row[idxId] || '').trim();
                if (!name || name.includes('åˆè¨ˆ') || name.includes('å°è¨ˆ')) return;
                
                // æ¸…ç†å®¢æˆ¶åç¨±ä½œç‚º keyï¼ˆFirebase ä¸å…è¨± . # $ / [ ]ï¼‰
                const safeKey = sanitizeKey(name);
                if (!safeKey) return;
                
                customerData[safeKey] = {
                  name: name,  // ä¿ç•™åŸå§‹åç¨±é¡¯ç¤ºç”¨
                  fullName: String(row[idxFullName] || name).trim(),
                  contact: idxContact >= 0 ? String(row[idxContact] || '').trim() : '',
                  tel1: idxTel1 >= 0 ? String(row[idxTel1] || '').trim() : '',
                  tel2: idxTel2 >= 0 ? String(row[idxTel2] || '').trim() : '',
                  address: idxAddress >= 0 ? String(row[idxAddress] || '').trim() : '',
                  taxId: idxTaxId >= 0 ? String(row[idxTaxId] || '').trim() : '',
                  creditLimit: idxCredit >= 0 ? (parseFloat(row[idxCredit]) || 0) : 0,
                  paymentDays: 30,  // é è¨­æœˆçµ30å¤©
                  paymentTerm: idxPayment >= 0 ? String(row[idxPayment] || '').trim() : 'æœˆçµ30å¤©',
                  paymentMethod: idxPayMethod >= 0 ? String(row[idxPayMethod] || '').trim() : '',
                  // é è¨­å€¼
                  priceTier: 'ç”Ÿæ„åƒ¹',
                  grade: 'D',
                  salesRep: '',
                  note: '',
                  totalAmount: 0,
                  orderCount: 0,
                  visitCount: 0,
                  productCount: 0,
                  avgCycle: null,
                  firstOrder: '',
                  lastOrder: '',
                  topProducts: [],
                  arBalance: 0,
                  arOverdue: 0,
                  arStatus: 'normal',
                };
                count++;
              });
              
              console.log('åŒ¯å…¥å®¢æˆ¶æ•¸:', count);
            }
            
            const customerCount = Object.keys(customerData).length;
            
            if (customerCount === 0) {
              alert('âŒ æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„å®¢æˆ¶è³‡æ–™');
              return;
            }
            
            // åˆä½µç¾æœ‰è³‡æ–™ï¼ˆä¿ç•™éŠ·å”®çµ±è¨ˆï¼‰
            const mergedData = { ...customerDB };
            Object.entries(customerData).forEach(([name, newData]) => {
              if (mergedData[name]) {
                // ä¿ç•™ç¾æœ‰çš„éŠ·å”®çµ±è¨ˆï¼Œæ›´æ–°åŸºæœ¬è³‡æ–™
                mergedData[name] = {
                  ...mergedData[name],
                  ...newData,
                  // ä¿ç•™é€™äº›æ¬„ä½
                  totalAmount: mergedData[name].totalAmount || 0,
                  orderCount: mergedData[name].orderCount || 0,
                  visitCount: mergedData[name].visitCount || 0,
                  productCount: mergedData[name].productCount || 0,
                  avgCycle: mergedData[name].avgCycle,
                  firstOrder: mergedData[name].firstOrder || '',
                  lastOrder: mergedData[name].lastOrder || '',
                  topProducts: mergedData[name].topProducts || [],
                  grade: mergedData[name].grade || 'D',
                  priceTier: mergedData[name].priceTier || 'ç”Ÿæ„åƒ¹',
                };
              } else {
                mergedData[name] = newData;
              }
            });
            
            // ç¢ºèªä¸Šå‚³
            const existingCount = Object.keys(customerDB).length;
            const newCount = customerCount - Object.keys(customerDB).filter(k => customerData[k]).length;
            
            if (confirm(`ğŸ“¥ å®¢æˆ¶ä¸»æª”è¼‰å…¥å®Œæˆï¼\n\nâœï¸ æ›´æ–°: ${customerCount - newCount} ä½\nâ• æ–°å¢: ${newCount} ä½\nğŸ“Š ç¸½è¨ˆ: ${Object.keys(mergedData).length} ä½å®¢æˆ¶\n\nè¦ä¸Šå‚³åˆ°é›²ç«¯å—ï¼Ÿ`)) {
              // æ›´æ–°æœ¬åœ°ç‹€æ…‹
              setCustomerDB(mergedData);
              
              // ä¸Šå‚³åˆ° Firebaseï¼ˆå«åŒæ­¥æ—¥èªŒï¼‰
              if (db) {
                const { ref, update, get } = window.firebaseModules;
                
                // å…ˆè®€å–ç¾æœ‰æ—¥èªŒ
                get(ref(db, 'seafoodData/syncLogs')).then(snap => {
                  let syncLogs = snap.val() || [];
                  if (syncLogs.length >= 100) syncLogs = syncLogs.slice(-99);
                  syncLogs.push({
                    timestamp: new Date().toISOString(),
                    status: 'success',
                    source: 'å®¢æˆ¶ä¸»æª”',
                    filename: file.name,
                    itemCount: Object.keys(mergedData).length
                  });
                  
                  update(ref(db, 'seafoodData'), { 
                    customerDB: mergedData,
                    syncLogs: syncLogs,
                    'dbMeta/customerDate': new Date().toLocaleString('zh-TW')
                  })
                  .then(() => {
                    alert(`âœ… å®¢æˆ¶è³‡æ–™ä¸Šå‚³æˆåŠŸï¼\n\nå…± ${Object.keys(mergedData).length} ä½å®¢æˆ¶`);
                  })
                  .catch(err => {
                    console.error('ä¸Šå‚³å®¢æˆ¶è³‡æ–™å¤±æ•—:', err);
                    alert('âŒ ä¸Šå‚³å¤±æ•—: ' + err.message);
                  });
                });
              }
            }
          } catch (err) {
            console.error('è§£æå®¢æˆ¶è³‡æ–™å¤±æ•—:', err);
            alert('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤\n\n' + err.message);
          }
        };
        
        // æ ¹æ“šæª”æ¡ˆé¡å‹é¸æ“‡è®€å–æ–¹å¼
        if (fileName.endsWith('.json')) {
          reader.readAsText(file);
        } else {
          reader.readAsArrayBuffer(file);
        }
        e.target.value = ''; // é‡ç½® input
      };

      // ğŸ†• éŠ·è²¨æ˜ç´°ä¸Šå‚³è™•ç†ï¼ˆæ›´æ–°å®¢æˆ¶äº¤æ˜“çµ±è¨ˆï¼‰
      const handleSalesUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data_arr = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data_arr, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            
            console.log('=== éŠ·è²¨æ˜ç´°åŒ¯å…¥ ===');
            console.log('ç¸½è¡Œæ•¸:', rows.length);
            
            // æ‰¾æ¨™é¡Œåˆ—
            let headerIdx = -1;
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
              const rowStr = (rows[i] || []).join('');
              if (rowStr.includes('å®¢æˆ¶') && rowStr.includes('æ—¥æœŸ') && rowStr.includes('é‡‘é¡')) {
                headerIdx = i;
                break;
              }
            }
            
            if (headerIdx === -1) {
              alert('âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel åŒ…å«ã€Œå®¢æˆ¶ç°¡ç¨±ã€ã€Œæ—¥æœŸã€ã€ŒéŠ·è²¨é‡‘é¡ã€æ¬„ä½');
              return;
            }
            
            const headers = rows[headerIdx].map(h => String(h || '').trim());
            
            // æ‰¾æ¬„ä½ç´¢å¼•
            const idxCustomer = headers.findIndex(h => h.includes('å®¢æˆ¶'));
            const idxDate = headers.findIndex(h => h.includes('æ—¥æœŸ'));
            const idxProduct = headers.findIndex(h => h.includes('å“å'));
            const idxAmount = headers.findIndex(h => h.includes('æœ¬å¹£éŠ·è²¨é‡‘é¡') || h.includes('éŠ·è²¨é‡‘é¡'));
            const idxUnit = headers.findIndex(h => h === 'å–®ä½');
            
            console.log('æ¬„ä½ç´¢å¼•:', { idxCustomer, idxDate, idxProduct, idxAmount });
            
            // è™•ç†è³‡æ–™ï¼ŒæŒ‰å®¢æˆ¶åˆ†çµ„
            const customerStats = {};
            let lastCustomer = '';
            let totalRecords = 0;
            
            const dataRows = rows.slice(headerIdx + 1);
            dataRows.forEach(row => {
              if (!row || row.length === 0) return;
              
              // éæ¿¾çµ±è¨ˆåˆ—
              const unitVal = idxUnit >= 0 ? String(row[idxUnit] || '') : '';
              if (unitVal.includes('éŠ·è²¨:') || unitVal.includes('éŠ·é€€:') || unitVal.includes('æ·¨é¡:')) return;
              
              // å®¢æˆ¶åç¨±ï¼ˆè™•ç†åˆä½µå„²å­˜æ ¼ï¼‰
              let customer = String(row[idxCustomer] || '').trim();
              if (!customer && lastCustomer) {
                customer = lastCustomer;
              } else if (customer) {
                lastCustomer = customer;
              }
              
              if (!customer) return;
              
              // æ’é™¤å…§éƒ¨å®¢æˆ¶
              if (['é–€å¸‚', 'å·¥å» ', 'å¡å•¦è¦', 'å®¢æˆ¶ç°¡ç¨±'].includes(customer)) return;
              
              // æ¸…ç†å®¢æˆ¶åç¨±ä½œç‚º keyï¼ˆFirebase ä¸å…è¨± . # $ / [ ]ï¼‰
              const safeCustomer = sanitizeKey(customer);
              if (!safeCustomer) return;
              
              const product = String(row[idxProduct] || '').trim();
              const amount = parseFloat(String(row[idxAmount] || '0').replace(/,/g, '')) || 0;
              const dateVal = row[idxDate];
              
              if (!product || amount === 0) return;
              
              // è§£ææ—¥æœŸ
              let orderDate = null;
              if (dateVal) {
                if (typeof dateVal === 'number') {
                  // Excel æ—¥æœŸåºè™Ÿ
                  orderDate = new Date((dateVal - 25569) * 86400 * 1000);
                } else {
                  orderDate = new Date(dateVal);
                }
              }
              
              // åˆå§‹åŒ–å®¢æˆ¶çµ±è¨ˆï¼ˆä½¿ç”¨æ¸…ç†å¾Œçš„ keyï¼Œä½†ä¿ç•™åŸå§‹åç¨±ï¼‰
              if (!customerStats[safeCustomer]) {
                customerStats[safeCustomer] = {
                  originalName: customer,  // ä¿ç•™åŸå§‹åç¨±
                  totalAmount: 0,
                  orders: [],
                  products: {},
                  dates: new Set(),
                };
              }
              
              customerStats[safeCustomer].totalAmount += amount;
              customerStats[safeCustomer].orders.push({ date: orderDate, amount, product });
              customerStats[safeCustomer].products[product] = (customerStats[safeCustomer].products[product] || 0) + amount;
              if (orderDate && !isNaN(orderDate.getTime())) {
                customerStats[safeCustomer].dates.add(orderDate.toISOString().split('T')[0]);
              }
              totalRecords++;
            });
            
            console.log('è™•ç†å®¢æˆ¶æ•¸:', Object.keys(customerStats).length);
            console.log('æœ‰æ•ˆè¨˜éŒ„æ•¸:', totalRecords);
            
            // æ›´æ–° customerDB
            const updatedDB = { ...customerDB };
            let updateCount = 0;
            let newCount = 0;
            
            Object.entries(customerStats).forEach(([safeKey, stats]) => {
              const sortedDates = Array.from(stats.dates).sort();
              const firstOrder = sortedDates[0] || '';
              const lastOrder = sortedDates[sortedDates.length - 1] || '';
              
              // è¨ˆç®—å¹³å‡é€±æœŸ
              let avgCycle = null;
              if (sortedDates.length >= 2) {
                const first = new Date(sortedDates[0]);
                const last = new Date(sortedDates[sortedDates.length - 1]);
                const days = (last - first) / (1000 * 60 * 60 * 24);
                avgCycle = Math.round(days / (sortedDates.length - 1));
              }
              
              // è¨ˆç®—æœˆå¹³å‡äº¤æ˜“é¡å’Œå»ºè­°ä¿¡ç”¨é¡åº¦
              let monthlyAvg = 0;
              let suggestedCredit = 0;
              if (sortedDates.length >= 1) {
                const first = new Date(sortedDates[0]);
                const last = new Date(sortedDates[sortedDates.length - 1] || sortedDates[0]);
                const daysDiff = (last - first) / (1000 * 60 * 60 * 24);
                const months = Math.max(1, daysDiff / 30); // å¤©æ•¸é™¤ä»¥30ï¼Œè‡³å°‘1å€‹æœˆ
                monthlyAvg = Math.round(stats.totalAmount / months);
                suggestedCredit = Math.round(monthlyAvg * 1.5); // æœˆå¹³å‡ Ã— 1.5
              }
              
              // TOP 10 å¸¸è²·å“é …
              const topProducts = Object.entries(stats.products)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([name]) => name);
              
              // å®¢æˆ¶ç­‰ç´š
              let grade = 'D';
              if (stats.totalAmount >= 500000) grade = 'A';
              else if (stats.totalAmount >= 200000) grade = 'B';
              else if (stats.totalAmount >= 50000) grade = 'C';
              
              if (updatedDB[safeKey]) {
                // æ›´æ–°ç¾æœ‰å®¢æˆ¶
                updatedDB[safeKey] = {
                  ...updatedDB[safeKey],
                  totalAmount: stats.totalAmount,
                  orderCount: stats.orders.length,
                  visitCount: stats.dates.size,
                  productCount: Object.keys(stats.products).length,
                  avgCycle,
                  firstOrder,
                  lastOrder,
                  topProducts,
                  grade,
                  monthlyAvg,
                  suggestedCredit,
                  // è‡ªå‹•å¥—ç”¨1.5å€é¡åº¦ï¼ˆé™¤éå·²æ‰‹å‹•è¨­å®šï¼‰
                  creditLimit: suggestedCredit,
                };
                updateCount++;
              } else {
                // æ–°å¢å®¢æˆ¶ï¼ˆåªæœ‰äº¤æ˜“çµ±è¨ˆï¼‰
                updatedDB[safeKey] = {
                  name: stats.originalName,  // ä½¿ç”¨åŸå§‹åç¨±é¡¯ç¤º
                  fullName: stats.originalName,
                  contact: '',
                  tel1: '',
                  tel2: '',
                  address: '',
                  taxId: '',
                  creditLimit: suggestedCredit,  // ä½¿ç”¨å»ºè­°é¡åº¦
                  paymentDays: 30,  // é è¨­æœˆçµ30å¤©
                  paymentTerm: 'æœˆçµ30å¤©',
                  paymentMethod: '',
                  priceTier: 'ç”Ÿæ„åƒ¹',
                  grade,
                  salesRep: '',
                  note: '',
                  totalAmount: stats.totalAmount,
                  orderCount: stats.orders.length,
                  visitCount: stats.dates.size,
                  productCount: Object.keys(stats.products).length,
                  avgCycle,
                  firstOrder,
                  lastOrder,
                  topProducts,
                  monthlyAvg,
                  suggestedCredit,
                  arBalance: 0,
                  arOverdue: 0,
                  arStatus: 'normal',
                };
                newCount++;
              }
            });
            
            // ç¢ºèªä¸Šå‚³
            if (confirm(`ğŸ“Š éŠ·è²¨æ˜ç´°åˆ†æå®Œæˆï¼\n\nğŸ“ æœ‰æ•ˆè¨˜éŒ„: ${totalRecords.toLocaleString()} ç­†\nâœï¸ æ›´æ–°å®¢æˆ¶: ${updateCount} ä½\nâ• æ–°å¢å®¢æˆ¶: ${newCount} ä½\nğŸ“Š ç¸½è¨ˆ: ${Object.keys(updatedDB).length} ä½å®¢æˆ¶\n\nè¦ä¸Šå‚³åˆ°é›²ç«¯å—ï¼Ÿ`)) {
              setCustomerDB(updatedDB);
              
              if (db) {
                const { ref, update, get } = window.firebaseModules;
                
                // å…ˆè®€å–ç¾æœ‰æ—¥èªŒ
                get(ref(db, 'seafoodData/syncLogs')).then(snap => {
                  let syncLogs = snap.val() || [];
                  if (syncLogs.length >= 100) syncLogs = syncLogs.slice(-99);
                  syncLogs.push({
                    timestamp: new Date().toISOString(),
                    status: 'success',
                    source: 'éŠ·è²¨æ˜ç´°',
                    filename: file.name,
                    itemCount: totalRecords
                  });
                  
                  update(ref(db, 'seafoodData'), { 
                    customerDB: updatedDB,
                    syncLogs: syncLogs,
                    'dbMeta/salesDate': new Date().toLocaleString('zh-TW')
                  })
                  .then(() => {
                    alert(`âœ… å®¢æˆ¶äº¤æ˜“çµ±è¨ˆæ›´æ–°æˆåŠŸï¼\n\næ›´æ–°: ${updateCount} ä½\næ–°å¢: ${newCount} ä½`);
                  })
                  .catch(err => {
                    console.error('ä¸Šå‚³å¤±æ•—:', err);
                    alert('âŒ ä¸Šå‚³å¤±æ•—: ' + err.message);
                  });
                });
              }
            }
          } catch (err) {
            console.error('è§£æéŠ·è²¨æ˜ç´°å¤±æ•—:', err);
            alert('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤\n\n' + err.message);
          }
        };
        
        reader.readAsArrayBuffer(file);
        e.target.value = '';
      };

      // ğŸ†• å¸³é½¡åˆ†æè¡¨ä¸Šå‚³è™•ç†ï¼ˆæ‡‰æ”¶å¸³æ¬¾/ä¿¡ç”¨ç®¡ç†ï¼‰
      const handleARUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data_arr = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data_arr, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            
            console.log('=== å¸³é½¡åˆ†æè¡¨åŒ¯å…¥ ===');
            console.log('ç¸½è¡Œæ•¸:', rows.length);
            
            // æ‰¾æ¨™é¡Œåˆ—
            let headerIdx = -1;
            for (let i = 0; i < Math.min(rows.length, 15); i++) {
              const rowStr = (rows[i] || []).join('');
              if (rowStr.includes('å®¢æˆ¶') && (rowStr.includes('å¸³æ¬¾') || rowStr.includes('é¤˜é¡') || rowStr.includes('æ‡‰æ”¶') || rowStr.includes('æœªæ”¶'))) {
                headerIdx = i;
                break;
              }
            }
            
            if (headerIdx === -1) {
              alert('âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel åŒ…å«ã€Œå®¢æˆ¶ã€å’Œã€Œå¸³æ¬¾/æœªæ”¶/æ‡‰æ”¶ã€ç›¸é—œæ¬„ä½');
              return;
            }
            
            const headers = rows[headerIdx].map(h => String(h || '').trim());
            console.log('=== å¸³é½¡åˆ†æè¡¨æ¬„ä½è­˜åˆ¥ ===');
            console.log('æ¨™é¡Œåˆ—:', headers);
            
            // æ‰¾æ¬„ä½ç´¢å¼• - æ ¹æ“šå¯¦éš›å¸³é½¡è¡¨æ¬„ä½
            const findCol = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));
            
            // å®¢æˆ¶æ¬„ä½
            const idxCustomer = findCol(['å®¢æˆ¶ç°¡ç¨±', 'å®¢æˆ¶åç¨±']);
            
            // å¸³é½¡å€é–“æ¬„ä½ï¼ˆæ”¯æ´å¤šç¨®å‘½åæ ¼å¼ï¼‰
            const idx30 = findCol(['30å¤©ä»¥å…§', '0-30å¤©', '30å¤©å…§']);
            const idx3060 = findCol(['30è‡³60å¤©', '31-60å¤©', '30-60å¤©']);
            const idx6090 = findCol(['60è‡³90å¤©', '61-90å¤©', '60-90å¤©']);
            const idx90120 = findCol(['90è‡³120å¤©', '91-120å¤©', '90-120å¤©']);
            const idx120150 = findCol(['120è‡³150å¤©', '121-150å¤©', '120-150å¤©']);
            const idx150plus = findCol(['150å¤©ä»¥ä¸Š', '150å¤©+', 'é€¾150å¤©']);
            
            // åˆè¨ˆæ¬„ä½
            const idxBalance = findCol(['åˆè¨ˆæœªæ”¶å¸³æ¬¾', 'æ‡‰æ”¶åˆè¨ˆ', 'å¸³æ¬¾é¤˜é¡', 'é¤˜é¡']);
            const idxCreditLimit = findCol(['ä¿¡ç”¨é¡åº¦', 'é¡åº¦']);
            
            console.log('æ¬„ä½ç´¢å¼•:', { 
              å®¢æˆ¶: idxCustomer, 
              '30å¤©å…§': idx30, 
              '30-60å¤©': idx3060, 
              '60-90å¤©': idx6090, 
              '90-120å¤©': idx90120,
              '120-150å¤©': idx120150,
              '150å¤©+': idx150plus,
              åˆè¨ˆ: idxBalance 
            });
            
            // é¡¯ç¤ºæ¬„ä½å°æ‡‰çµæœ
            const colMapping = [];
            if (idxCustomer >= 0) colMapping.push(`å®¢æˆ¶=${headers[idxCustomer]}`);
            if (idx30 >= 0) colMapping.push(`30å¤©=${headers[idx30]}`);
            if (idx3060 >= 0) colMapping.push(`30-60å¤©=${headers[idx3060]}`);
            if (idx6090 >= 0) colMapping.push(`60-90å¤©=${headers[idx6090]}`);
            if (idx90120 >= 0) colMapping.push(`90-120å¤©=${headers[idx90120]}`);
            if (idx120150 >= 0) colMapping.push(`120-150å¤©=${headers[idx120150]}`);
            if (idx150plus >= 0) colMapping.push(`150å¤©+=${headers[idx150plus]}`);
            if (idxBalance >= 0) colMapping.push(`åˆè¨ˆ=${headers[idxBalance]}`);
            console.log('æ¬„ä½å°æ‡‰:', colMapping.join(', '));
            
            // è™•ç†è³‡æ–™
            const arData = {};
            let totalAR = 0;
            let customerCount = 0;
            let sampleData = []; // è¨˜éŒ„å‰5ç­†è³‡æ–™ä¾›èª¿è©¦
            
            const dataRows = rows.slice(headerIdx + 1);
            dataRows.forEach((row, rowIdx) => {
              if (!row || row.length === 0) return;
              
              const customerName = String(row[idxCustomer] || '').trim();
              if (!customerName || customerName.includes('åˆè¨ˆ') || customerName.includes('å°è¨ˆ') || customerName.includes('ç¸½è¨ˆ')) return;
              
              // æ¸…ç†å®¢æˆ¶åç¨±
              const safeKey = sanitizeKey(customerName);
              if (!safeKey) return;
              
              const parseAmount = (val) => {
                if (!val) return 0;
                if (typeof val === 'number') return val;
                return parseFloat(String(val).replace(/,/g, '')) || 0;
              };
              
              // è®€å–å„å€é–“é‡‘é¡
              const day30 = idx30 >= 0 ? parseAmount(row[idx30]) : 0;           // 30å¤©ä»¥å…§
              const day3060 = idx3060 >= 0 ? parseAmount(row[idx3060]) : 0;     // 30è‡³60å¤©
              const day6090 = idx6090 >= 0 ? parseAmount(row[idx6090]) : 0;     // 60è‡³90å¤©
              const day90120 = idx90120 >= 0 ? parseAmount(row[idx90120]) : 0;  // 90è‡³120å¤©
              const day120150 = idx120150 >= 0 ? parseAmount(row[idx120150]) : 0; // 120è‡³150å¤©
              const day150plus = idx150plus >= 0 ? parseAmount(row[idx150plus]) : 0; // 150å¤©ä»¥ä¸Š
              
              // åˆè¨ˆé‡‘é¡
              const balance = idxBalance >= 0 ? parseAmount(row[idxBalance]) : 
                              (day30 + day3060 + day6090 + day90120 + day120150 + day150plus);
              
              const creditLimit = idxCreditLimit >= 0 ? parseAmount(row[idxCreditLimit]) : 0;
              
              // è¨ˆç®—é€¾æœŸé‡‘é¡
              const overdue35 = day3060 + day6090 + day90120 + day120150 + day150plus;  // 35å¤©ä»¥ä¸Š
              const overdue50 = day6090 + day90120 + day120150 + day150plus;            // 50å¤©ä»¥ä¸Š
              
              // åˆ¤æ–·å¸³æ¬¾ç‹€æ…‹ - è¦å‰‡ï¼š35å¤©æ³¨æ„ã€50å¤©å±éšª
              let arStatus = 'normal';
              if (overdue50 > 0) {
                arStatus = 'danger';  // ğŸ”´ 60å¤©ä»¥ä¸Šæœ‰é‡‘é¡ï¼ˆè¶…é50å¤©ï¼‰
              } else if (day3060 > 0) {
                arStatus = 'warning'; // ğŸŸ¡ 30-60å¤©æœ‰é‡‘é¡ï¼ˆè¶…é35å¤©ï¼‰
              }
              
              // è¨˜éŒ„å‰5ç­†è³‡æ–™ä¾›èª¿è©¦
              if (sampleData.length < 5) {
                sampleData.push({
                  name: customerName,
                  balance,
                  day3060,
                  overdue50,
                  status: arStatus
                });
              }
              
              // è¨ˆç®—é¡åº¦ä½¿ç”¨ç‡
              const creditUsage = creditLimit > 0 ? (balance / creditLimit * 100) : 0;
              
              arData[safeKey] = {
                name: customerName,
                arBalance: balance,
                ar30: day30,
                ar3060: day3060,
                ar6090: day6090,
                ar90plus: day90120 + day120150 + day150plus,
                arOverdue: overdue35,
                arStatus,
                creditLimit,
                creditUsage: Math.round(creditUsage),
              };
              
              totalAR += balance;
              customerCount++;
            });
            
            console.log('è™•ç†å®¢æˆ¶æ•¸:', customerCount);
            console.log('ç¸½æ‡‰æ”¶å¸³æ¬¾:', totalAR);
            
            // æ›´æ–° customerDB
            const updatedDB = { ...customerDB };
            let updateCount = 0;
            let newCount = 0;
            let warningCount = 0;
            let dangerCount = 0;
            
            Object.entries(arData).forEach(([safeKey, arInfo]) => {
              if (updatedDB[safeKey]) {
                // ä½¿ç”¨ç¾æœ‰çš„ä¿¡ç”¨é¡åº¦ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                const effectiveLimit = updatedDB[safeKey].creditLimit || updatedDB[safeKey].suggestedCredit || arInfo.creditLimit || 0;
                const effectiveUsage = effectiveLimit > 0 ? Math.round(arInfo.arBalance / effectiveLimit * 100) : 0;
                
                // æ›´æ–°ç¾æœ‰å®¢æˆ¶
                updatedDB[safeKey] = {
                  ...updatedDB[safeKey],
                  arBalance: arInfo.arBalance,
                  ar30: arInfo.ar30,
                  ar3060: arInfo.ar3060,
                  ar6090: arInfo.ar6090,
                  ar90plus: arInfo.ar90plus,
                  arOverdue: arInfo.arOverdue,
                  arStatus: arInfo.arStatus,
                  creditLimit: effectiveLimit,
                  creditUsage: effectiveUsage,
                };
                updateCount++;
              } else {
                // æ–°å¢å®¢æˆ¶ï¼ˆåªæœ‰å¸³å‹™è³‡æ–™ï¼‰
                updatedDB[safeKey] = {
                  name: arInfo.name,
                  fullName: arInfo.name,
                  contact: '',
                  tel1: '',
                  tel2: '',
                  address: '',
                  taxId: '',
                  creditLimit: arInfo.creditLimit,
                  paymentDays: 30,  // é è¨­æœˆçµ30å¤©
                  paymentTerm: 'æœˆçµ30å¤©',
                  paymentMethod: '',
                  priceTier: 'ç”Ÿæ„åƒ¹',
                  grade: 'D',
                  salesRep: '',
                  note: '',
                  totalAmount: 0,
                  orderCount: 0,
                  visitCount: 0,
                  productCount: 0,
                  avgCycle: null,
                  firstOrder: '',
                  lastOrder: '',
                  topProducts: [],
                  arBalance: arInfo.arBalance,
                  ar30: arInfo.ar30,
                  ar3060: arInfo.ar3060,
                  ar6090: arInfo.ar6090,
                  ar90plus: arInfo.ar90plus,
                  arOverdue: arInfo.arOverdue,
                  arStatus: arInfo.arStatus,
                  creditUsage: arInfo.creditUsage,
                };
                newCount++;
              }
              
              if (arInfo.arStatus === 'warning') warningCount++;
              if (arInfo.arStatus === 'danger') dangerCount++;
            });
            
            // è¼¸å‡ºèª¿è©¦è³‡è¨Š
            console.log('=== å¸³é½¡åˆ†æçµæœ ===');
            console.log('ç¸½å®¢æˆ¶æ•¸:', customerCount);
            console.log('æ³¨æ„(35å¤©+):', warningCount);
            console.log('å±éšª(50å¤©+):', dangerCount);
            console.log('å‰5ç­†è³‡æ–™æ¨£æœ¬:', sampleData);
            
            // ç¢ºèªä¸Šå‚³ - é¡¯ç¤ºè­˜åˆ¥çµæœ
            const colInfo = [];
            if (idx30 >= 0) colInfo.push('30å¤©å…§âœ“');
            if (idx3060 >= 0) colInfo.push('30-60å¤©âœ“');
            if (idx6090 >= 0) colInfo.push('60-90å¤©âœ“');
            if (idx90120 >= 0) colInfo.push('90-120å¤©âœ“');
            if (idx120150 >= 0) colInfo.push('120-150å¤©âœ“');
            if (idx150plus >= 0) colInfo.push('150å¤©+âœ“');
            
            if (confirm(`ğŸ’° å¸³é½¡åˆ†æè¡¨åŒ¯å…¥å®Œæˆï¼\n\nğŸ“Š ç¸½æ‡‰æ”¶å¸³æ¬¾: $${totalAR.toLocaleString()}\nâœï¸ æ›´æ–°å®¢æˆ¶: ${updateCount} ä½\nâ• æ–°å¢å®¢æˆ¶: ${newCount} ä½\nğŸŸ¡ æ³¨æ„(35å¤©+): ${warningCount} ä½\nğŸ”´ å±éšª(50å¤©+): ${dangerCount} ä½\n\nğŸ“‹ è­˜åˆ¥æ¬„ä½: ${colInfo.join(' ')}\n\nè¦ä¸Šå‚³åˆ°é›²ç«¯å—ï¼Ÿ`)) {
              setCustomerDB(updatedDB);
              
              if (db) {
                const { ref, update, get } = window.firebaseModules;
                
                // å…ˆè®€å–ç¾æœ‰æ—¥èªŒ
                get(ref(db, 'seafoodData/syncLogs')).then(snap => {
                  let syncLogs = snap.val() || [];
                  if (syncLogs.length >= 100) syncLogs = syncLogs.slice(-99);
                  syncLogs.push({
                    timestamp: new Date().toISOString(),
                    status: 'success',
                    source: 'å¸³é½¡åˆ†æè¡¨',
                    filename: file.name,
                    itemCount: customerCount
                  });
                  
                  update(ref(db, 'seafoodData'), { 
                    customerDB: updatedDB,
                    syncLogs: syncLogs,
                    'dbMeta/arDate': new Date().toLocaleString('zh-TW'),
                    'dbMeta/totalAR': totalAR,
                  })
                  .then(() => {
                    alert(`âœ… å¸³é½¡åˆ†æè¡¨ä¸Šå‚³æˆåŠŸï¼\n\nğŸŸ¡ æ³¨æ„: ${warningCount} ä½\nğŸ”´ å±éšª: ${dangerCount} ä½`);
                  })
                  .catch(err => {
                    console.error('ä¸Šå‚³å¤±æ•—:', err);
                    alert('âŒ ä¸Šå‚³å¤±æ•—: ' + err.message);
                  });
                });
              }
            }
          } catch (err) {
            console.error('è§£æå¸³é½¡åˆ†æè¡¨å¤±æ•—:', err);
            alert('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤\n\n' + err.message);
          }
        };
        
        reader.readAsArrayBuffer(file);
        e.target.value = '';
      };

      // Excel ä¸Šå‚³
      const handleUpload = (e, type) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const fileName = file.name.toLowerCase();
          const reader = new FileReader();
          
          reader.onload = (evt) => {
              try {
                  let wb;
                  
                  // CSV æª”æ¡ˆéœ€è¦ Big5 è§£ç¢¼
                  if (fileName.endsWith('.csv')) {
                      const decoder = new TextDecoder("big5");
                      const csvText = decoder.decode(new Uint8Array(evt.target.result));
                      wb = XLSX.read(csvText, { type: 'string' });
                  } 
                  // Excel æª”æ¡ˆç›´æ¥è®€å–äºŒé€²ä½
                  else {
                      const data = new Uint8Array(evt.target.result);
                      wb = XLSX.read(data, { type: 'array' });
                  }
                  
                  const ws = wb.Sheets[wb.SheetNames[0]];
                  const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                  
                  console.log('è®€å–åˆ°', rows.length, 'è¡Œè³‡æ–™');
                  
                  if (type === 'stock') processStock(rows);
                  else if (type === 'quote') processQuote(rows);

              } catch (err) {
                  console.error('è®€å–éŒ¯èª¤:', err);
                  alert("è®€å–å¤±æ•—ï¼š" + err.message + "\n\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º");
              }
          };
          
          reader.onerror = () => {
              alert("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹é‡è©¦");
          };
          
          reader.readAsArrayBuffer(file);
          e.target.value = null;
      };

      // ğŸ”„ åº«å­˜è™•ç† - V17.2 åˆä½µæ¨¡å¼ï¼ˆä¸åˆªé™¤ç¾æœ‰è³‡æ–™ï¼‰
      const processStock = (rows) => {
          console.log('=== é–‹å§‹è™•ç†åº«å­˜è³‡æ–™ï¼ˆåˆä½µæ¨¡å¼ï¼‰===');
          console.log('ç¸½è¡Œæ•¸:', rows.length);
          
          let headerIdx = -1;
          for(let i=0; i<Math.min(rows.length, 20); i++) {
              const str = rows[i].join('');
              if (str.includes('å“è™Ÿ') && (str.includes('åº«åˆ¥') || str.includes('å€‰åº«'))) {
                  headerIdx = i; 
                  console.log('æ‰¾åˆ°æ¨™é¡Œåˆ—æ–¼ç¬¬', i+1, 'è¡Œ:', rows[i]);
                  break;
              }
          }
          if (headerIdx === -1) { 
              alert("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel æª”æ¡ˆåŒ…å«ã€Œå“è™Ÿã€å’Œã€Œåº«åˆ¥ã€æ¬„ä½");
              console.error('å‰20è¡Œå…§å®¹:', rows.slice(0, 20));
              return; 
          }

          const headers = rows[headerIdx].map(h => cleanStr(h || ''));
          const rawData = rows.slice(headerIdx + 1);
          const idxPid = headers.findIndex(h => h && h.includes('å“è™Ÿ'));
          const idxName = headers.findIndex(h => h && h.includes('å“å'));
          const idxSpec = headers.findIndex(h => h && h.includes('è¦æ ¼'));
          const idxWh = headers.findIndex(h => h && (h.includes('åº«åˆ¥') || h.includes('å€‰åº«')));
          const idxQty = headers.findIndex(h => h && (h.includes('åº«å­˜') || h.includes('æ•¸é‡')));

          console.log('æ¬„ä½ç´¢å¼• - å“è™Ÿ:', idxPid, 'å“å:', idxName, 'è¦æ ¼:', idxSpec, 'åº«åˆ¥:', idxWh, 'æ•¸é‡:', idxQty);

          if (idxPid === -1 || idxWh === -1 || idxQty === -1) {
              alert("âŒ ç¼ºå°‘å¿…è¦æ¬„ä½\n\néœ€è¦ï¼šå“è™Ÿã€åº«åˆ¥ã€åº«å­˜æ•¸é‡");
              return;
          }

          // ğŸ”‘ é—œéµæ”¹å‹•ï¼šå¾ç¾æœ‰è³‡æ–™é–‹å§‹åˆä½µï¼Œè€Œéç©ºç‰©ä»¶
          const mergedInv = JSON.parse(JSON.stringify(data.inventory || {}));
          const mergedProds = JSON.parse(JSON.stringify(data.products || {}));
          let lastPid = null;
          let updateCount = 0, newCount = 0, newProdCount = 0;

          // è¨˜éŒ„é€™æ¬¡ä¸Šå‚³çš„å“è™Ÿï¼ˆç”¨æ–¼æ›´æ–°åº«å­˜ï¼‰
          const uploadedPids = new Set();

          rawData.forEach((row, index) => {
              if (!row || !Array.isArray(row)) return;
              
              let pid = sanitizeKey(cleanStr(row[idxPid] || ''));
              const wh = cleanStr(row[idxWh] || '');
              const qty = parseNum(row[idxQty]);
              if (!wh) return;
              if (!pid && lastPid) pid = lastPid;
              else if (pid) lastPid = pid;
              if (!pid) return;

              uploadedPids.add(pid);

              // ğŸ”„ åˆä½µåº«å­˜ï¼šæ›´æ–°æˆ–æ–°å¢
              if (!mergedInv[pid]) {
                  mergedInv[pid] = [];
                  newCount++;
              }
              
              // æ‰¾æ˜¯å¦å·²æœ‰æ­¤å€‰åº«çš„åº«å­˜
              const existingWhIdx = mergedInv[pid].findIndex(x => x.warehouse === wh);
              if (existingWhIdx >= 0) {
                  // æ›´æ–°ç¾æœ‰å€‰åº«åº«å­˜
                  mergedInv[pid][existingWhIdx].stock = qty;
                  updateCount++;
              } else {
                  // æ–°å¢å€‰åº«åº«å­˜
                  mergedInv[pid].push({ warehouse: wh, stock: qty });
                  updateCount++;
              }

              // å¦‚æœ productDB æ²’æœ‰æ­¤ç”¢å“ï¼Œæ–°å¢åŸºæœ¬è³‡æ–™
              const name = cleanStr(row[idxName] || '');
              if (name) {
                  const safeName = sanitizeKey(name);
                  if (!mergedProds[safeName]) mergedProds[safeName] = [];
                  if (!mergedProds[safeName].find(s => s.id === pid)) {
                      mergedProds[safeName].push({
                          id: pid, name: name, specDetail: cleanStr(row[idxSpec] || ''),
                          prices: {"é–€å¸‚å”®åƒ¹":0, "æœƒå“¡95%":0, "é¤å»³90%":0, "ç”Ÿæ„åƒ¹":0, "æ•´ä»¶åƒ¹":0, "VIPåƒ¹":0, "æ¥­å‹™åº•åƒ¹":0, "èŠ±æ±åƒ¹":0}, 
                          note: '(åº«å­˜è£œå…¥)', pack: 1, smallUnit:'ä»¶', bigUnit:'ä»¶'
                      });
                      newProdCount++;
                  }
              }
          });

          console.log('=== åº«å­˜è™•ç†å®Œæˆï¼ˆåˆä½µæ¨¡å¼ï¼‰===');
          console.log('åº«å­˜æ›´æ–°:', updateCount, 'ç­†');
          console.log('æ–°å¢å“è™Ÿ:', newCount, 'å€‹');
          console.log('æ–°å¢ç”¢å“:', newProdCount, 'ç­†');
          console.log('ç¾æœ‰åº«å­˜å“é …:', Object.keys(mergedInv).length);

          if (updateCount === 0 && newCount === 0) {
              alert("âŒ ç„¡æœ‰æ•ˆè³‡æ–™\n\nè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹æ˜¯å¦æ­£ç¢º");
              return;
          }

          // ä½¿ç”¨ setTimeout ç¢ºä¿å½ˆçª—åœ¨ä¸»åŸ·è¡Œç·’
          setTimeout(() => {
              const msg = `ğŸ“¦ åº«å­˜è¡¨è§£ææˆåŠŸï¼ï¼ˆåˆä½µæ¨¡å¼ï¼‰\n\n` +
                          `âœï¸ åº«å­˜æ›´æ–°ï¼š${updateCount} ç­†\n` +
                          `â• æ–°å¢å“è™Ÿï¼š${newCount} å€‹\n` +
                          `ğŸ†• æ–°å¢ç”¢å“ï¼š${newProdCount} ç­†\n\n` +
                          `ğŸ“Š ç¸½åº«å­˜å“é …ï¼š${Object.keys(mergedInv).length}\n\n` +
                          `âš ï¸ æ­¤æ“ä½œä¸æœƒåˆªé™¤ä»»ä½•ç¾æœ‰è³‡æ–™`;
              
              const confirmed = window.confirm(msg + "\n\nç¢ºèªä¸Šå‚³åˆ° Firebaseï¼Ÿ");
              if (confirmed) {
                  uploadDB({ 
                      inventoryDB: mergedInv, 
                      productDB: mergedProds, 
                      dbMeta: { 
                          ...(data.meta || {}), 
                          stockDate: new Date().toLocaleString('zh-TW'),
                          lastUpdate: new Date().toISOString(),
                          syncSource: 'æ‰‹å‹•ä¸Šå‚³ï¼ˆåˆä½µæ¨¡å¼ï¼‰'
                      } 
                  }, { filename: 'æ‰‹å‹•ä¸Šå‚³åº«å­˜ï¼ˆåˆä½µï¼‰' });
              }
          }, 100);
      };

      // ğŸ”„ å ±åƒ¹å–®è™•ç† - V17.2 åˆä½µæ¨¡å¼ï¼ˆåªæ›´æ–°åƒ¹æ ¼ï¼Œä¸åˆªé™¤ç”¢å“ï¼‰
      const processQuote = (rows) => {
          console.log('=== é–‹å§‹è™•ç†å ±åƒ¹è³‡æ–™ï¼ˆåˆä½µæ¨¡å¼ï¼‰===');
          console.log('ç¸½è¡Œæ•¸:', rows.length);
          
          let headerIdx = -1;
          // å°‹æ‰¾çœŸæ­£çš„æ¨™é¡Œåˆ—ï¼šå¿…é ˆåŒæ™‚åŒ…å«ã€Œå“è™Ÿã€å’Œã€Œå“åã€
          for(let i=0; i<Math.min(rows.length, 20); i++) {
              const row = rows[i];
              if (!row || row.length === 0) continue;
              
              // å°‡æ•´è¡Œè½‰æˆå­—ä¸²æª¢æŸ¥
              const rowStr = row.join('|');
              
              // å¿…é ˆåŒæ™‚åŒ…å«ã€Œå“è™Ÿã€å’Œã€Œå“åã€æ‰ç®—æ˜¯çœŸæ­£çš„æ¨™é¡Œåˆ—
              if (rowStr.includes('å“è™Ÿ') && rowStr.includes('å“å')) {
                  headerIdx = i; 
                  console.log('æ‰¾åˆ°æ¨™é¡Œåˆ—æ–¼ç¬¬', i+1, 'è¡Œ:', row);
                  break;
              }
          }
          
          if (headerIdx === -1) { 
              alert("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel æª”æ¡ˆåŒ…å«ã€Œå“è™Ÿã€å’Œã€Œå“åã€æ¬„ä½\n\næ¨™é¡Œè¡Œæ‡‰è©²åŒæ™‚åŒ…å«é€™å…©å€‹æ¬„ä½");
              console.error('å‰20è¡Œå…§å®¹:', rows.slice(0, 20));
              return; 
          }
          
          const headers = rows[headerIdx].map(cleanStr);
          const rawData = rows.slice(headerIdx + 1);
          const idxPid = headers.findIndex(h => h && h.includes('å“è™Ÿ'));
          const idxName = headers.findIndex(h => h && h.includes('å“å'));
          const idxSpec = headers.findIndex(h => h && h.includes('è¦æ ¼'));
          // ğŸ†• ç”¢å“é¡å‹æ¬„ä½ï¼šæ¡è³¼å“ / è‡ªè£½å“
          const idxType = headers.findIndex(h => h && (h.includes('é¡å‹') || h.includes('ä¾†æº') || h.includes('æ¡è³¼') || h.includes('è‡ªè£½')));

          console.log('æ¬„ä½ç´¢å¼• - å“è™Ÿ:', idxPid, 'å“å:', idxName, 'è¦æ ¼:', idxSpec, 'é¡å‹:', idxType);
          console.log('æ‰€æœ‰æ¨™é¡Œ:', headers);
          // ğŸ” åˆ—å‡ºæ‰€æœ‰è¢«è­˜åˆ¥ç‚ºåƒ¹æ ¼çš„æ¬„ä½
          const priceHeaders = headers.filter(h => h && (h.includes('åƒ¹') || h.includes('+') || h.includes('%')) && !h.includes('è™Ÿ') && !h.includes('å'));
          console.log('è­˜åˆ¥åˆ°çš„åƒ¹æ ¼æ¬„ä½:', priceHeaders);

          if (idxPid === -1 || idxName === -1) {
              alert("âŒ ç¼ºå°‘å¿…è¦æ¬„ä½\n\néœ€è¦ï¼šå“è™Ÿã€å“å");
              return;
          }

          // ğŸ”‘ é—œéµæ”¹å‹•ï¼šå¾ç¾æœ‰è³‡æ–™é–‹å§‹åˆä½µï¼Œè€Œéç©ºç‰©ä»¶
          const mergedProds = JSON.parse(JSON.stringify(data.products || {}));
          const tiers = new Set();
          let updateCount = 0, newCount = 0;

          rawData.forEach((row, index) => {
              if (!row || !Array.isArray(row)) return;
              
              const pid = sanitizeKey(cleanStr(row[idxPid] || ''));
              const name = cleanStr(row[idxName] || '');
              if (!pid || !name) return;

              const prices = {};
              headers.forEach((h, i) => {
                  if (!h || typeof h !== 'string') return;
                  // åƒ¹æ ¼æ¬„ä½ï¼šåŒ…å«ã€Œåƒ¹ã€ã€Œ+ã€ã€Œ%ã€ã€Œé¤å»³ã€ã€Œæœƒå“¡ã€ï¼Œä½†ä¸åŒ…å«ã€Œè™Ÿã€ã€Œåã€ã€Œè³‡æ–™ã€ã€Œå»ºç«‹ã€ã€Œä½œæ¥­ã€
                  if ((h.includes('åƒ¹') || h.includes('+') || h.includes('%') || h.includes('é¤å»³') || h.includes('æœƒå“¡')) && 
                      !h.includes('è™Ÿ') && 
                      !h.includes('å') &&
                      !h.includes('è³‡æ–™') &&
                      !h.includes('å»ºç«‹') &&
                      !h.includes('ä½œæ¥­')) {
                      const cellValue = row[i];
                      // å¦‚æœå„²å­˜æ ¼æ˜¯ç©ºç™½ã€undefinedã€nullï¼Œå°±è·³é
                      if (cellValue === undefined || cellValue === null || cellValue === '') return;
                      
                      const v = parseNum(cellValue);
                      // åªè¦èƒ½è§£ææˆæ•¸å­—ï¼ˆåŒ…æ‹¬ 0ï¼‰ï¼Œå°±åŠ å…¥
                      if (!isNaN(v)) {
                          // æ¸…ç†åƒ¹æ ¼ç­‰ç´šåç¨±
                          let tierName = h.replace('åƒ¹æ ¼','').replace('_','').replace(/\(.*\)/g, '').replace(/\s+/g, '').trim();
                          // ç‰¹æ®Šè™•ç†ï¼šæ¨™æº–åŒ–åƒ¹æ ¼æ¬„ä½åç¨±
                          if (tierName.includes('æ•´ä»¶')) tierName = 'æ•´ä»¶åƒ¹';
                          else if (tierName.includes('VIP') || tierName.includes('vip')) tierName = 'VIPåƒ¹';
                          else if (tierName.includes('é¤å»³') || (tierName.includes('90') && tierName.includes('%'))) tierName = 'é¤å»³90%';
                          else if (tierName.includes('æœƒå“¡') || (tierName.includes('95') && tierName.includes('%'))) tierName = 'æœƒå“¡95%';
                          else if (tierName.includes('é–€å¸‚') || tierName.includes('é›¶å”®') || tierName.includes('å”®åƒ¹')) tierName = 'é–€å¸‚å”®åƒ¹';
                          else if (tierName.includes('ç”Ÿæ„')) tierName = 'ç”Ÿæ„åƒ¹';
                          else if (tierName.includes('åº•') || tierName.includes('æ¥­å‹™')) tierName = 'æ¥­å‹™åº•åƒ¹';
                          else if (tierName.includes('èŠ±æ±')) tierName = 'èŠ±æ±åƒ¹';
                          prices[tierName] = v;
                          tiers.add(tierName);
                      }
                  }
              });

              // åªæœ‰ç•¶æœ‰åƒ¹æ ¼è³‡æ–™æ™‚æ‰è™•ç†
              if (Object.keys(prices).length > 0) {
                  const safeName = sanitizeKey(name);
                  if (!mergedProds[safeName]) mergedProds[safeName] = [];
                  
                  // ğŸ†• åˆ¤æ–·ç”¢å“é¡å‹ï¼šæ¡è³¼å“ / è‡ªè£½å“
                  let prodType = 'è‡ªè£½å“'; // é è¨­ç‚ºè‡ªè£½å“
                  if (idxType !== -1) {
                      const typeVal = cleanStr(row[idxType] || '').toLowerCase();
                      if (typeVal.includes('æ¡è³¼') || typeVal.includes('purchase') || typeVal === 'æ¡è³¼å“') {
                          prodType = 'æ¡è³¼å“';
                      } else if (typeVal.includes('è‡ªè£½') || typeVal.includes('è£½é€ ') || typeVal === 'è‡ªè£½å“') {
                          prodType = 'è‡ªè£½å“';
                      }
                  }
                  
                  // ğŸ”„ æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤ç”¢å“
                  const existingIdx = mergedProds[safeName].findIndex(s => s.id === pid);
                  
                  if (existingIdx >= 0) {
                      // âœ… ç”¢å“å·²å­˜åœ¨ â†’ åªæ›´æ–°åƒ¹æ ¼ï¼Œä¿ç•™å…¶ä»–è³‡æ–™
                      const existing = mergedProds[safeName][existingIdx];
                      mergedProds[safeName][existingIdx] = {
                          ...existing,
                          prices: { ...existing.prices, ...prices },  // åˆä½µåƒ¹æ ¼ï¼ˆæ–°çš„è¦†è“‹èˆŠçš„ï¼‰
                          prodType,
                          // å¦‚æœå ±åƒ¹è¡¨æœ‰è¦æ ¼è³‡è¨Šï¼Œä¹Ÿæ›´æ–°
                          ...(cleanStr(row[idxSpec] || '') && { specDetail: cleanStr(row[idxSpec] || '') })
                      };
                      updateCount++;
                  } else {
                      // âœ… æ–°ç”¢å“ â†’ æ–°å¢ï¼ˆå¯èƒ½æ˜¯å¾…è²¨ä¸­ï¼‰
                      mergedProds[safeName].push({
                          id: pid, 
                          name, 
                          specDetail: cleanStr(row[idxSpec] || '') || '', 
                          prices,
                          prodType,
                          pack: 1, 
                          smallUnit: 'ä»¶', 
                          bigUnit: 'ä»¶',
                          note: '(å ±åƒ¹è£œå…¥)'
                      });
                      newCount++;
                  }
              }
          });

          console.log('=== å ±åƒ¹è™•ç†å®Œæˆï¼ˆåˆä½µæ¨¡å¼ï¼‰===');
          console.log('æ›´æ–°åƒ¹æ ¼:', updateCount, 'ç­†');
          console.log('æ–°å¢ç”¢å“:', newCount, 'ç­†');
          console.log('åƒ¹æ ¼ç­‰ç´š:', Array.from(tiers));
          console.log('ç¾æœ‰ç”¢å“é¡åˆ¥:', Object.keys(mergedProds).length);

          if (updateCount === 0 && newCount === 0) {
              alert("âŒ ç„¡æœ‰æ•ˆè³‡æ–™\n\nå¯èƒ½åŸå› ï¼š\n1. æ‰€æœ‰ç”¢å“çš„åƒ¹æ ¼éƒ½æ˜¯ 0 æˆ–ç©ºç™½\n2. åƒ¹æ ¼æ¬„ä½åç¨±ç„¡æ³•è­˜åˆ¥\n3. å“è™Ÿæˆ–å“åç‚ºç©º\n\nè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹");
              console.log('åƒ¹æ ¼æ¬„ä½æª¢æŸ¥:', headers.filter(h => h && h.includes('åƒ¹')));
              return;
          }

          // ä½¿ç”¨ setTimeout ç¢ºä¿å½ˆçª—åœ¨ä¸»åŸ·è¡Œç·’
          setTimeout(() => {
              const msg = `ğŸ“‹ å ±åƒ¹è¡¨è§£ææˆåŠŸï¼ï¼ˆåˆä½µæ¨¡å¼ï¼‰\n\n` +
                          `âœï¸ æ›´æ–°åƒ¹æ ¼ï¼š${updateCount} ç­†\n` +
                          `â• æ–°å¢ç”¢å“ï¼š${newCount} ç­†\n` +
                          `ğŸ’° åƒ¹æ ¼å±¤ç´šï¼š${Array.from(tiers).join(', ')}\n\n` +
                          `ğŸ“Š ç¸½ç”¢å“é¡åˆ¥ï¼š${Object.keys(mergedProds).length}\n\n` +
                          `âš ï¸ æ­¤æ“ä½œä¸æœƒåˆªé™¤ä»»ä½•ç¾æœ‰ç”¢å“`;
              
              const confirmed = window.confirm(msg + "\n\nç¢ºèªä¸Šå‚³åˆ° Firebaseï¼Ÿ");
              if (confirmed) {
                  uploadDB({ 
                      productDB: mergedProds, 
                      priceTiers: Array.from(tiers), 
                      dbMeta: { 
                          ...(data.meta || {}), 
                          quoteDate: new Date().toLocaleString('zh-TW'),
                          lastUpdate: new Date().toISOString()
                      } 
                  });
              }
          }, 100);
      };

      const uploadDB = (updates, logEntry = null) => {
          if (!initDB()) {
              alert("âŒ Firebase æœªé€£ç·š\n\nè«‹ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸");
              return;
          }
          
          const { ref, update, get } = window.firebaseModules;
          
          // é¡¯ç¤ºä¸Šå‚³ä¸­æç¤º
          const originalStatus = status;
          setStatus('ğŸ“¤ ä¸Šå‚³ä¸­...');
          
          // å…ˆè®€å– Firebase æœ€æ–°è³‡æ–™ï¼Œç¢ºä¿ä¸æœƒè¦†è“‹ safetyStock
          get(ref(db, 'seafoodData')).then((snap) => {
              const currentData = snap.val() || {};
              
              // åªæ›´æ–°æŒ‡å®šçš„æ¬„ä½ï¼Œä¿ç•™æœªæŒ‡å®šçš„æ¬„ä½ï¼ˆå¦‚ safetyStockï¼‰
              const updateData = {};
              
              if (updates.productDB !== undefined) {
                  updateData.productDB = updates.productDB;
              }
              if (updates.inventoryDB !== undefined) {
                  updateData.inventoryDB = updates.inventoryDB;
                  
                  // å¦‚æœæ˜¯åº«å­˜æ›´æ–°ï¼Œè¨˜éŒ„åŒæ­¥æ—¥èªŒ
                  if (logEntry) {
                      let syncLogs = currentData.syncLogs || [];
                      if (syncLogs.length >= 100) {
                          syncLogs = syncLogs.slice(-99);
                      }
                      syncLogs.push({
                          timestamp: new Date().toISOString(),
                          status: 'success',
                          source: 'manual',
                          filename: logEntry.filename || 'æ‰‹å‹•ä¸Šå‚³',
                          itemCount: Object.keys(updates.inventoryDB).length
                      });
                      updateData.syncLogs = syncLogs;
                  }
              }
              if (updates.priceTiers !== undefined) {
                  updateData.priceTiers = updates.priceTiers;
              }
              if (updates.dbMeta !== undefined) {
                  // åˆä½µ meta è³‡æ–™ï¼Œè€Œéè¦†è“‹
                  updateData.dbMeta = { ...(currentData.dbMeta || {}), ...updates.dbMeta };
              }
              if (updates.safetyStock !== undefined) {
                  updateData.safetyStock = updates.safetyStock;
              }
              if (updates.storeSafetyStock !== undefined) {
                  updateData.storeSafetyStock = updates.storeSafetyStock;
              }
              if (updates.discontinuedProducts !== undefined) {
                  updateData.discontinuedProducts = updates.discontinuedProducts;
              }
              if (updates.storeOnlyProducts !== undefined) {
                  updateData.storeOnlyProducts = updates.storeOnlyProducts;
              }
              
              console.log('=== uploadDB é–‹å§‹ ===');
              console.log('æ›´æ–°é …ç›®:', Object.keys(updateData));
              console.log('å·¥å»  safetyStock:', currentData.safetyStock ? Object.keys(currentData.safetyStock).length + ' é …' : 'ç„¡');
              console.log('é–€å¸‚ storeSafetyStock:', updateData.storeSafetyStock ? Object.keys(updateData.storeSafetyStock).length + ' é …' : 'ç„¡');
              console.log('åœå”®å“:', updateData.discontinuedProducts ? Object.keys(updateData.discontinuedProducts).length + ' é …' : 'ç„¡');
              console.log('é–€å¸‚å°ˆè³£:', updateData.storeOnlyProducts ? Object.keys(updateData.storeOnlyProducts).length + ' é …' : 'ç„¡');
              
              return update(ref(db, 'seafoodData'), updateData);
          })
          .then(() => {
              setStatus('â— å·²é€£ç·š');
              console.log('âœ… uploadDB æˆåŠŸ');
              alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
          })
          .catch(e => {
              setStatus(originalStatus);
              console.error('ä¸Šå‚³éŒ¯èª¤:', e);
              alert("âŒ ä¸Šå‚³å¤±æ•—\n\néŒ¯èª¤è¨Šæ¯ï¼š" + e.message + "\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡è©¦");
          });
      };

      // è³¼ç‰©è»Šæ“ä½œ
      const addProductFromDB = (spec) => {
        if (reSelectCartId) {
          // é‡æ–°é¸æ“‡ç”¢å“ - æ›´æ–°ç¾æœ‰ç”¢å“
          setCart(cart.map(item => {
            if (item.cartId === reSelectCartId) {
              return {
                ...spec,
                cartId: item.cartId, // ä¿æŒåŸæœ‰çš„ cartId
                qty: item.qty, // ä¿æŒåŸæœ‰çš„æ•¸é‡
                price: spec.prices[custInfo.tier] || 0,
                selectedTier: custInfo.tier, // è¨˜éŒ„é¸æ“‡çš„åƒ¹æ ¼ç­‰ç´š
                note: item.note, // ä¿æŒåŸæœ‰çš„å‚™è¨»
                image: item.image // ä¿æŒåŸæœ‰çš„åœ–ç‰‡
              };
            }
            return item;
          }));
          setReSelectCartId(null);
          setShowProductSearch(false);
          setSearch('');
        } else {
          // æª¢æŸ¥æ˜¯å¦å·²åœ¨è³¼ç‰©è»Š
          const existingIndex = cart.findIndex(item => item.id === spec.id && item.specDetail === spec.specDetail);
          
          if (existingIndex !== -1) {
            // å·²å­˜åœ¨ â†’ ç§»é™¤ï¼ˆå–æ¶ˆé¸æ“‡ï¼‰
            setCart(cart.filter((_, idx) => idx !== existingIndex));
          } else {
            // ä¸å­˜åœ¨ â†’ æ–°å¢
            const newItem = {
              ...spec,
              cartId: Date.now(),
              qty: 1,
              price: spec.prices[custInfo.tier] || 0,
              selectedTier: custInfo.tier, // è¨˜éŒ„é¸æ“‡çš„åƒ¹æ ¼ç­‰ç´š
              note: '',
              image: ''
            };
            setCart([...cart, newItem]);
          }
          // ä¸é—œé–‰å½ˆçª—ï¼Œä¸æ¸…é™¤æœå°‹
        }
      };

      const reSelectProduct = (cartId) => {
        setReSelectCartId(cartId);
        setShowProductSearch(true);
      };

      const updateCart = (cartId, field, value) => {
        setCart(cart.map(item => item.cartId === cartId ? {...item, [field]: value} : item));
      };

      const deleteFromCart = (cartId) => {
        setCart(cart.filter(item => item.cartId !== cartId));
      };

      const copyCartItem = (cartId) => {
        const item = cart.find(i => i.cartId === cartId);
        if (item) {
          setCart([...cart, {...item, cartId: Date.now()}]);
        }
      };

      const showPriceSelector = (cartId) => {
        setCurrentPriceItem(cartId);
        setShowPriceModal(true);
      };

      const selectPrice = (tier, price) => {
        if (currentPriceItem) {
          // åŒæ™‚æ›´æ–°åƒ¹æ ¼å’Œé¸æ“‡çš„åƒ¹æ ¼ç­‰ç´š
          setCart(cart.map(item => 
            item.cartId === currentPriceItem 
              ? {...item, price: price, selectedTier: tier}
              : item
          ));
          setShowPriceModal(false);
          setCurrentPriceItem(null);
        }
      };

      const uploadImage = (cartId) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              updateCart(cartId, 'image', event.target.result);
            };
            reader.readAsDataURL(file);
          }
        };
        input.click();
      };

      // è¨ˆç®—å°è¨ˆï¼šå¦‚æœæœ‰ç®±å®¹ï¼Œå‰‡ ä»¶æ•¸ Ã— ç®±å®¹ Ã— å–®åƒ¹ï¼›å¦å‰‡ æ•¸é‡ Ã— å–®åƒ¹
      const calculateSubtotal = (item) => {
        const packInfo = extractPackInfo(item.specDetail);
        if (packInfo) {
          // æœ‰ç®±å®¹ï¼šä»¶æ•¸ï¼ˆç®±æ•¸ï¼‰ Ã— ç®±å®¹ Ã— å–®åƒ¹
          return item.qty * packInfo.qty * item.price;
        }
        // ç„¡ç®±å®¹ï¼šæ•¸é‡ Ã— å–®åƒ¹
        return item.qty * item.price;
      };
      
      const calculateTotal = () => cart.reduce((sum, item) => sum + calculateSubtotal(item), 0);

      // å¾è¦æ ¼ä¸­æå–ç®±å®¹è³‡è¨Š
      const extractPackInfo = (specDetail) => {
        if (!specDetail) return null;
        
        // æ¨™æº–åŒ…è£å–®ä½ï¼ˆä¸åŒ…å«é‡é‡å–®ä½ï¼‰
        const packUnits = 'ç›’|ç®±|åŒ…|ç‰‡|å¡Š|æ”¯|å°¾|æ¢|ç½|ç“¶|è¢‹|æ‰“|å…¥';
        
        // å„ªå…ˆåŒ¹é…æœ€å¾Œçš„ *æ•¸å­—+åŒ…è£å–®ä½ æ ¼å¼ï¼ˆå¦‚ *12åŒ…ã€*20ç›’ï¼‰
        const allMatches = [];
        const packPattern = new RegExp('\\*\\s*(\\d+)\\s*(' + packUnits + ')', 'gi');
        let match;
        while ((match = packPattern.exec(specDetail)) !== null) {
          allMatches.push({ qty: parseInt(match[1]), unit: match[2] });
        }
        
        // å¦‚æœæœ‰åŒ¹é…ï¼Œå–æœ€å¾Œä¸€å€‹
        if (allMatches.length > 0) {
          return allMatches[allMatches.length - 1];
        }
        
        // å…¶æ¬¡åŒ¹é… xæ•¸å­—+å–®ä½ æ ¼å¼
        const xPattern = new RegExp('[xX]\\s*(\\d+)\\s*(' + packUnits + ')?', 'gi');
        while ((match = xPattern.exec(specDetail)) !== null) {
          allMatches.push({ qty: parseInt(match[1]), unit: match[2] || 'å…¥' });
        }
        if (allMatches.length > 0) {
          return allMatches[allMatches.length - 1];
        }
        
        // æœ€å¾Œå˜—è©¦åŒ¹é…ç¨ç«‹çš„ æ•¸å­—+åŒ…è£å–®ä½
        const unitPattern = new RegExp('(\\d+)\\s*(' + packUnits + ')(?![\\w])', 'gi');
        while ((match = unitPattern.exec(specDetail)) !== null) {
          allMatches.push({ qty: parseInt(match[1]), unit: match[2] });
        }
        if (allMatches.length > 0) {
          return allMatches[allMatches.length - 1];
        }
        
        return null;
      };

      // é¡¯ç¤ºç®±å®¹è³‡è¨Šï¼ˆç”¨æ–¼ç•Œé¢é¡¯ç¤ºï¼‰
      const getPackDisplayInfo = (item) => {
        const packInfo = extractPackInfo(item.specDetail);
        if (!packInfo) return null;
        
        return {
          packQty: packInfo.qty,
          packUnit: packInfo.unit,
          caseCount: item.qty, // ä»¶æ•¸å°±æ˜¯ç®±æ•¸
          totalUnits: item.qty * packInfo.qty // ç¸½å°å–®ä½æ•¸
        };
      };

      // æª¢æŸ¥è³¼ç‰©è»Šä¸­çš„ä½åº«å­˜ç”¢å“ï¼ˆæ ¹æ“šè§’è‰²é¸æ“‡å€‰åº«å’Œå®‰å…¨åº«å­˜ï¼‰
      const checkCartLowStock = () => {
        const lowStockItems = [];
        const currentWarehouses = role === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
        const currentSafetyStockData = role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
        
        cart.forEach(item => {
          const stocks = data.inventory[item.id] || [];
          const mainStocks = stocks.filter(s => currentWarehouses.includes(s.warehouse));
          const mainTotal = mainStocks.reduce((s, x) => s + (x.stock || 0), 0);
          const otherStocks = stocks.filter(s => !currentWarehouses.includes(s.warehouse) && s.stock > 0);
          const otherTotal = otherStocks.reduce((s, x) => s + (x.stock || 0), 0);
          const safetyLine = currentSafetyStockData?.[item.id] ?? DEFAULT_SAFETY_STOCK;
          
          if (mainTotal === 0) {
            lowStockItems.push({ ...item, mainStock: 0, otherStock: otherTotal, safetyLine, status: role === 'store' ? 'é–€å¸‚ç¼ºè²¨' : 'ä¸»å€‰ç¼ºè²¨' });
          } else if (mainTotal < safetyLine) {
            lowStockItems.push({ ...item, mainStock: mainTotal, otherStock: otherTotal, safetyLine, status: role === 'store' ? 'é–€å¸‚ä½åº«å­˜' : 'ä¸»å€‰ä½åº«å­˜' });
          }
        });
        return lowStockItems;
      };

      const saveQuote = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        // æª¢æŸ¥ä½åº«å­˜ç”¢å“
        const lowStockItems = checkCartLowStock();
        
        if (lowStockItems.length > 0) {
          // çµ„åˆè­¦å‘Šè¨Šæ¯
          const warningList = lowStockItems.map(item => {
            const mainInfo = item.status === 'ä¸»å€‰ç¼ºè²¨' 
              ? 'ä¸»å€‰ç¼ºè²¨' 
              : `ä¸»å€‰ ${Math.floor(item.mainStock)} (å®‰å…¨å€¼ ${item.safetyLine})`;
            const otherInfo = item.otherStock > 0 
              ? `\n   å¤–å€‰æœ‰ ${Math.floor(item.otherStock)} å¯èª¿è²¨` 
              : '';
            return `â€¢ ${item.name} ${item.specDetail || ''}\n   ${mainInfo}${otherInfo}`;
          }).join('\n');
          
          const stockDate = data.meta?.stockDate || 'æœªçŸ¥';
          
          // åˆ¤æ–·æ˜¯å¦æœ‰å¤–å€‰å¯èª¿
          const hasOtherStock = lowStockItems.some(item => item.otherStock > 0);
          
          const confirmed = window.confirm(
            `æ³¨æ„ï¼ä»¥ä¸‹ç”¢å“ä¸»å€‰åº«å­˜è¼ƒä½ï¼š\n\n${warningList}\n\n` +
            `åº«å­˜æ›´æ–°æ™‚é–“ï¼š${stockDate}\n\n` +
            (hasOtherStock 
              ? `ğŸ’¡ éƒ¨åˆ†ç”¢å“å¤–å€‰æœ‰åº«å­˜å¯èª¿è²¨\n\n` 
              : ``) +
            `å»ºè­°å ±åƒ¹å‰å…ˆé›»è©±ç¢ºèªåº«å­˜ï¼\n\n` +
            `ç¢ºå®šè¦å„²å­˜æ­¤å ±åƒ¹å—ï¼Ÿ`
          );
          
          if (!confirmed) {
            return;
          }
        }
        
        const quote = {
          id: Date.now(),
          date: new Date().toISOString(),
          customer: {...custInfo},
          products: cart.map(p => ({...p})),
          total: calculateTotal()
        };
        const newQuotes = [...quotes, quote];
        setQuotes(newQuotes);
        setTimeout(() => {
          localStorage.setItem('erpQuotesV11', JSON.stringify(newQuotes));
        }, 100);
        alert('å ±åƒ¹å·²å„²å­˜ï¼');
      };

      const loadQuote = (quoteId) => {
        const quote = quotes.find(q => q.id === quoteId);
        if (quote) {
          setCustInfo({...quote.customer});
          setCart(quote.products.map(p => ({...p, cartId: Date.now() + Math.random()})));
          setCurrentTab('quote'); // åˆ‡æ›åˆ°å ±åƒ¹é 
          setShowHistory(false);
        }
      };

      const deleteQuote = (quoteId) => {
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤å ±åƒ¹ï¼Ÿ')) {
          const newQuotes = quotes.filter(q => q.id !== quoteId);
          setQuotes(newQuotes);
          localStorage.setItem('erpQuotesV11', JSON.stringify(newQuotes));
        }
      };

      const printQuote = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let html = `
          <html>
          <head>
            <meta charset="UTF-8">
            <title>å ±åƒ¹å–®</title>
            <style>
              @media print {
                @page { 
                  size: A4;
                  margin: 10mm; 
                }
                body { 
                  background: white !important;
                  padding: 0 !important;
                }
                .page {
                  box-shadow: none !important;
                  margin: 0 !important;
                  padding: 10mm !important;
                  width: 100% !important;
                  min-height: auto !important;
                }
                .back-button, .print-button { display: none !important; }
              }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Microsoft JhengHei', Arial, sans-serif;
                background: #6b7280;
                color: #333;
                padding: 20px;
                min-height: 100vh;
              }
              /* A4 ç´™å¼µå®¹å™¨ï¼š210mm x 297mm */
              .page {
                width: 210mm;
                min-height: 297mm;
                background: white;
                margin: 0 auto;
                padding: 12mm 15mm;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
              }
              .header {
                text-align: center;
                margin-bottom: 5mm;
                border-bottom: 0.5mm solid #2563eb;
                padding-bottom: 3mm;
              }
              h1 { 
                font-size: 24pt;
                color: #1e40af;
                margin-bottom: 1mm;
                font-weight: bold;
                letter-spacing: 4mm;
              }
              .company-info {
                font-size: 10pt;
                color: #6b7280;
                letter-spacing: 1mm;
              }
              .info-section {
                background: #f8fafc;
                padding: 3mm 4mm;
                border-radius: 1.5mm;
                margin-bottom: 4mm;
                border-left: 0.8mm solid #2563eb;
              }
              .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5mm 8mm;
              }
              .info-item {
                display: flex;
                align-items: baseline;
                font-size: 10pt;
              }
              .info-label {
                font-weight: bold;
                color: #374151;
                min-width: 18mm;
                flex-shrink: 0;
              }
              .info-value {
                color: #1f2937;
              }
              .info-address {
                margin-top: 2mm;
                padding-top: 2mm;
                border-top: 0.3mm solid #e5e7eb;
                font-size: 10pt;
              }
              table { 
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 4mm;
                font-size: 9pt;
              }
              thead {
                background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                color: white;
              }
              th { 
                padding: 2mm 1.5mm;
                text-align: left;
                font-weight: bold;
                font-size: 9pt;
                border: none;
                white-space: nowrap;
              }
              th:first-child { border-radius: 1mm 0 0 0; }
              th:last-child { border-radius: 0 1mm 0 0; }
              tbody tr {
                border-bottom: 0.2mm solid #e5e7eb;
              }
              tbody tr:last-child {
                border-bottom: 0.4mm solid #2563eb;
              }
              td { 
                padding: 1.8mm 1.5mm;
                font-size: 9pt;
                vertical-align: middle;
              }
              /* æ¬„ä½å¯¬åº¦ */
              .col-no { width: 6%; text-align: center; }
              .col-name { width: 16%; }
              .col-spec { width: 26%; }
              .col-qty { width: 7%; text-align: center; }
              .col-pack { width: 10%; text-align: center; }
              .col-price { width: 10%; text-align: right; }
              .col-subtotal { width: 11%; text-align: right; }
              .col-note { width: 14%; }
              
              td:first-child {
                font-weight: bold;
                color: #2563eb;
                text-align: center;
              }
              .product-name {
                font-weight: bold;
                color: #1f2937;
              }
              .spec-detail {
                color: #4b5563;
                font-size: 8.5pt;
              }
              .pack-info {
                color: #6b7280;
                font-size: 8.5pt;
              }
              .price-cell {
                text-align: right;
                font-weight: bold;
                color: #059669;
              }
              .price-zero {
                text-align: right;
                color: #9ca3af;
              }
              .note-cell {
                color: #6b7280;
                font-size: 8.5pt;
              }
              .total-section {
                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                padding: 3mm 4mm;
                border-radius: 1.5mm;
                border: 0.4mm solid #2563eb;
                margin-top: 3mm;
              }
              .total-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .total-label {
                font-size: 12pt;
                font-weight: bold;
                color: #1e40af;
              }
              .total-amount {
                font-size: 18pt;
                font-weight: bold;
                color: #2563eb;
              }
              .footer {
                margin-top: 5mm;
                padding-top: 2mm;
                border-top: 0.2mm solid #e5e7eb;
                text-align: center;
                color: #9ca3af;
                font-size: 8pt;
              }
              .back-button {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 10px 20px;
                border-radius: 10px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                z-index: 1000;
                border: none;
                font-size: 14px;
              }
              .back-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
              }
              .print-button {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 10px 20px;
                border-radius: 10px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                z-index: 1000;
                border: none;
                font-size: 14px;
              }
              .print-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
              }
            </style>
          </head>
          <body>
            <button class="back-button" onclick="window.close()">â† è¿”å›</button>
            <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            
            <div class="page">
              <div class="header">
                <h1>å ± åƒ¹ å–®</h1>
                <div class="company-info">Quotation</div>
              </div>

              <div class="info-section">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="info-label">å®¢æˆ¶åç¨±ï¼š</span>
                    <span class="info-value">${custInfo.name || '-'}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">åƒ¹æ ¼ç­‰ç´šï¼š</span>
                    <span class="info-value">${custInfo.tier || '-'}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">çµå¸³æ–¹å¼ï¼š</span>
                    <span class="info-value">${custInfo.paymentMethod || '-'}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">æ—¥æœŸï¼š</span>
                    <span class="info-value">${custInfo.date || '-'}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">é›»è©±ï¼š</span>
                    <span class="info-value">${custInfo.phone || '-'}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">æ‰‹æ©Ÿï¼š</span>
                    <span class="info-value">${custInfo.mobile || '-'}</span>
                  </div>
                </div>
                <div class="info-address">
                  <span class="info-label">åœ°å€ï¼š</span>
                  <span class="info-value">${custInfo.address || '-'}</span>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th class="col-no">é …æ¬¡</th>
                    <th class="col-name">ç”¢å“åç¨±</th>
                    <th class="col-spec">è¦æ ¼</th>
                    <th class="col-qty">æ•¸é‡</th>
                    <th class="col-pack">ç®±å®¹æ•¸</th>
                    <th class="col-price">å–®åƒ¹</th>
                    <th class="col-subtotal">å°è¨ˆ</th>
                    <th class="col-note">å‚™è¨»</th>
                  </tr>
                </thead>
                <tbody>
                  ${cart.map((p, i) => {
                    const packInfo = extractPackInfo(p.specDetail);
                    const packDisplay = packInfo ? packInfo.qty + packInfo.unit + '/ä»¶' : '-';
                    const priceDisplay = p.price > 0 ? '$' + p.price.toLocaleString() : '-';
                    const subtotal = calculateSubtotal(p);
                    const subtotalDisplay = subtotal > 0 ? '$' + subtotal.toLocaleString() : '-';
                    const noteDisplay = (p.note && p.note.trim() !== '' && !p.note.includes('é»æ“Š')) ? p.note : '-';
                    return '<tr>' +
                      '<td class="col-no">' + (i + 1) + '</td>' +
                      '<td class="col-name product-name">' + (p.name || '-') + '</td>' +
                      '<td class="col-spec spec-detail">' + (p.specDetail || '-') + '</td>' +
                      '<td class="col-qty">' + p.qty + ' ' + p.smallUnit + '</td>' +
                      '<td class="col-pack pack-info">' + packDisplay + '</td>' +
                      '<td class="' + (p.price > 0 ? 'price-cell' : 'price-zero') + '">' + priceDisplay + '</td>' +
                      '<td class="' + (subtotal > 0 ? 'price-cell' : 'price-zero') + '">' + subtotalDisplay + '</td>' +
                      '<td class="col-note note-cell">' + noteDisplay + '</td>' +
                    '</tr>';
                  }).join('')}
                </tbody>
              </table>

              <div class="total-section">
                <div class="total-row">
                  <span class="total-label">ç¸½é‡‘é¡</span>
                  <span class="total-amount">NT$ ${calculateTotal().toLocaleString()}</span>
                </div>
              </div>

              <div class="footer">
                åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')} | æ„Ÿè¬æ‚¨çš„æ”¯æŒ
              </div>
            </div>
          </body>
          </html>
        `;
        
        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
      };

      const printQuoteNoPrice = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let html = `
          <html>
          <head>
            <meta charset="UTF-8">
            <title>ç”¢å“æ¸…å–®</title>
            <style>
              @media print {
                @page { margin: 1.5cm; }
              }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Microsoft JhengHei', Arial, sans-serif;
                padding: 40px;
                background: #fff;
                color: #333;
              }
              .header {
                text-align: center;
                margin-bottom: 40px;
                border-bottom: 3px solid #10b981;
                padding-bottom: 20px;
              }
              h1 { 
                font-size: 32px;
                color: #059669;
                margin-bottom: 10px;
                font-weight: bold;
              }
              .subtitle {
                font-size: 14px;
                color: #6b7280;
              }
              .info-section {
                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 30px;
                border-left: 4px solid #10b981;
              }
              .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
              }
              .info-item {
                display: flex;
                align-items: center;
              }
              .info-label {
                font-weight: bold;
                color: #374151;
                min-width: 90px;
              }
              .info-value {
                color: #1f2937;
              }
              table { 
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 30px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
              }
              thead {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
              }
              th { 
                padding: 15px 12px;
                text-align: left;
                font-weight: bold;
                font-size: 14px;
                border: none;
              }
              th:first-child { border-radius: 8px 0 0 0; }
              th:last-child { border-radius: 0 8px 0 0; }
              tbody tr {
                border-bottom: 1px solid #e5e7eb;
                transition: background 0.2s;
              }
              tbody tr:hover {
                background: #f9fafb;
              }
              tbody tr:last-child {
                border-bottom: 2px solid #10b981;
              }
              td { 
                padding: 12px;
                font-size: 14px;
              }
              td:first-child {
                font-weight: bold;
                color: #10b981;
                text-align: center;
                width: 50px;
              }
              .product-name {
                font-weight: bold;
                color: #1f2937;
              }
              .spec-detail {
                color: #6b7280;
                font-size: 13px;
              }
              .note-cell {
                color: #6b7280;
                font-style: italic;
                font-size: 13px;
              }
              .footer {
                margin-top: 50px;
                padding-top: 20px;
                border-top: 2px solid #e5e7eb;
                text-align: center;
                color: #6b7280;
                font-size: 12px;
              }
              .watermark {
                text-align: center;
                color: #10b981;
                font-weight: bold;
                font-size: 16px;
                margin-top: 20px;
                padding: 15px;
                background: #f0fdf4;
                border-radius: 8px;
              }
              .back-button {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                z-index: 1000;
                transition: all 0.3s ease;
                border: none;
                font-size: 14px;
              }
              .back-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
              }
              .print-button {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                z-index: 1000;
                transition: all 0.3s ease;
                border: none;
                font-size: 14px;
              }
              .print-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
              }
              @media print {
                body { padding: 20px; }
                .info-section { break-inside: avoid; }
                table { break-inside: avoid; }
                tbody tr { break-inside: avoid; }
                .back-button, .print-button { display: none !important; }
              }
            </style>
          </head>
          <body>
            <button class="back-button" onclick="window.close()">â† è¿”å›</button>
            <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            
            <div class="header">
              <h1>ç”¢å“æ¸…å–®</h1>
              <div class="subtitle">Product List (å«å–®åƒ¹ä¸å«ç¸½é¡)</div>
            </div>

            <div class="info-section">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">å®¢æˆ¶åç¨±ï¼š</span>
                  <span class="info-value">${custInfo.name}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">æ—¥æœŸï¼š</span>
                  <span class="info-value">${custInfo.date}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">é›»è©±ï¼š</span>
                  <span class="info-value">${custInfo.phone}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">æ‰‹æ©Ÿï¼š</span>
                  <span class="info-value">${custInfo.mobile}</span>
                </div>
              </div>
              <div style="margin-top: 15px;">
                <span class="info-label">åœ°å€ï¼š</span>
                <span class="info-value">${custInfo.address}</span>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>é …æ¬¡</th>
                  <th>ç”¢å“åç¨±</th>
                  <th>è¦æ ¼</th>
                  <th style="text-align: center;">æ•¸é‡</th>
                  <th style="text-align: right;">å–®åƒ¹</th>
                  <th>å‚™è¨»</th>
                </tr>
              </thead>
              <tbody>
                ${cart.map((p, i) => `
                  <tr>
                    <td>${i + 1}</td>
                    <td class="product-name">${p.name}</td>
                    <td class="spec-detail">${p.specDetail}</td>
                    <td style="text-align: center;">${p.qty} ${p.smallUnit}</td>
                    <td class="price-cell">$${p.price.toLocaleString()}</td>
                    <td class="note-cell">${p.note || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="watermark">
              âœ“ æœ¬æ¸…å–®å«å–®åƒ¹è³‡è¨Šï¼Œä¸å«å°è¨ˆèˆ‡ç¸½é‡‘é¡
            </div>

            <div class="footer">
              åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
            </div>
          </body>
          </html>
        `;
        
        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
      };

      const shareToLine = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let message = `ã€${custInfo.date} å ±åƒ¹å–®ã€‘\n${custInfo.name}ï½œ${custInfo.paymentMethod}\n\n`;
        cart.forEach((p, i) => {
          message += `${i + 1}. ${p.name}\n   ${p.specDetail}\n   $${p.price}/${p.smallUnit}\n`;
          if (p.note) message += `   å‚™è¨»ï¼š${p.note}\n`;
          message += `\n`;
        });
        
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message.trim())}`, '_blank');
      };

      // æœå°‹çµæœ - åŒæ™‚æœå°‹ç”¢å“åç¨±å’Œè¦æ ¼
      const filteredProds = Object.keys(data.products || {}).filter(key => {
        if (!key) return false;
        // æœå°‹ç”¢å“åç¨±
        if (key.includes(search || '')) return true;
        // æœå°‹è¦æ ¼å…§å®¹
        const group = data.products[key];
        if (!group || !Array.isArray(group)) return false;
        return group.some(spec => {
          if (!spec || !spec.specDetail) return false;
          return spec.specDetail.includes(search || '');
        });
      });

      // ==================== åº•éƒ¨å°èˆªçµ„ä»¶ ====================
      const BottomNav = () => {
        const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
        
        // é›»è…¦ç‰ˆä¸é¡¯ç¤ºåº•éƒ¨å°èˆª
        if (!isMobile) return null;
        
        return (
          <div className="no-print fixed bottom-0 left-0 right-0 glass border-t border-white/30 z-50 card-shadow">
            <div className="flex justify-around items-center h-16 max-w-2xl mx-auto">
              {/* é¦–é  */}
              <button 
                onClick={() => setCurrentTab('home')}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                  currentTab === 'home' ? 'text-indigo-600 relative' : 'text-gray-500 hover:text-indigo-600'
                }`}>
                {currentTab === 'home' && (
                  <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-10 h-1 bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-b-full"></div>
                )}
                <div className="relative">
                  <Icons.Home className="w-6 h-6" />
                </div>
                <span className={`text-xs mt-1 ${currentTab === 'home' ? 'font-bold' : ''}`}>é¦–é </span>
              </button>
              
              {/* é è¦½ */}
              <button 
                onClick={printQuote}
                className="flex flex-col items-center justify-center flex-1 h-full transition-colors text-gray-500 hover:text-indigo-600 active:text-indigo-700"
              >
                <div className="relative">
                  <Icons.Eye className="w-6 h-6" />
                </div>
                <span className="text-xs mt-1">é è¦½</span>
              </button>
              
              {/* å„²å­˜ */}
              <button 
                onClick={saveQuote}
                className="flex flex-col items-center justify-center flex-1 h-full transition-colors text-gray-500 hover:text-indigo-600 active:text-indigo-700"
              >
                <div className="relative">
                  <Icons.Save className="w-6 h-6" />
                  {cart.length > 0 && (
                    <span className="absolute -top-2 -right-2 bg-indigo-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                      {cart.length}
                    </span>
                  )}
                </div>
                <span className="text-xs mt-1">å„²å­˜</span>
              </button>
              
              {/* æ­·å² */}
              <button 
                onClick={() => setCurrentTab('history')}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                  currentTab === 'history' ? 'text-indigo-600 relative' : 'text-gray-500 hover:text-indigo-600'
                }`}>
                {currentTab === 'history' && (
                  <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-10 h-1 bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-b-full"></div>
                )}
                <div className="relative">
                  <Icons.History className="w-6 h-6" />
                  {quotes.length > 0 && (
                    <span className="absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center" style={{fontSize: '10px'}}>
                      {quotes.length}
                    </span>
                  )}
                </div>
                <span className={`text-xs mt-1 ${currentTab === 'history' ? 'font-bold' : ''}`}>æ­·å²</span>
              </button>
              
              {/* LINE */}
              <button 
                onClick={shareToLine}
                className="flex flex-col items-center justify-center flex-1 h-full text-gray-500 hover:text-green-600 active:text-green-700 transition-colors"
              >
                <div className="relative">
                  <Icons.Send className="w-6 h-6" />
                </div>
                <span className="text-xs mt-1">LINE</span>
              </button>
              
              {/* ç¸½é‡‘é¡ - åƒ…é›»è…¦ç‰ˆ */}
              {!isMobile && (
                <div className="flex flex-col items-center justify-center px-4 h-full border-l border-gray-200">
                  <span className="text-xs text-gray-500">ç¸½é‡‘é¡</span>
                  <span className="text-lg font-black text-indigo-600">${cart.reduce((sum, item) => sum + calculateSubtotal(item), 0).toLocaleString()}</span>
                </div>
              )}
            </div>
          </div>
        );
      };

      // ==================== å…¨å±€å½ˆçª—çµ„ä»¶ ====================
      const GlobalModals = () => {
        // ğŸ†• æŠ˜ç–Šç‹€æ…‹ç®¡ç†
        const [expandedItems, setExpandedItems] = useState({});
        const toggleExpand = (idx) => {
          setExpandedItems(prev => ({ ...prev, [idx]: !prev[idx] }));
        };
        
        const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
        
        return (
          <>
            {/* ä½åº«å­˜æé†’å½ˆçª— - éŸ¿æ‡‰å¼å¡ç‰‡è¨­è¨ˆ */}
            {showLowStockAlert && (
              <div className="fixed inset-0 bg-black/60 z-[100] flex items-end md:items-center justify-center">
                <div className="bg-gray-100 w-full md:max-w-2xl md:rounded-2xl flex flex-col overflow-hidden shadow-2xl" style={{maxHeight: isMobile ? '90vh' : '85vh', borderRadius: isMobile ? '24px 24px 0 0' : ''}}>
                  
                  {/* æ¨™é¡Œåˆ— */}
                  <div className="px-5 py-4 bg-gradient-to-r from-orange-500 to-red-500 text-white flex-shrink-0">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-11 h-11 bg-white/20 rounded-xl flex items-center justify-center text-2xl">
                          âš ï¸
                        </div>
                        <div>
                          <h3 className="font-bold text-lg">ä½åº«å­˜è­¦å ±</h3>
                          <p className="text-sm opacity-90">{lowStockItems.length} é …ç”¢å“éœ€è¦è£œè²¨</p>
                        </div>
                      </div>
                      <button 
                        onClick={() => setShowLowStockAlert(false)} 
                        className="bg-white/20 hover:bg-white/30 active:bg-white/40 w-10 h-10 rounded-xl font-bold text-xl flex items-center justify-center transition-colors"
                      >âœ•</button>
                    </div>
                  </div>

                  {/* ç”¢å“å¡ç‰‡åˆ—è¡¨ */}
                  <div className="flex-1 overflow-auto p-3 md:p-4 space-y-3">
                    {lowStockItems.map((item, idx) => {
                      const isExpanded = expandedItems[idx];
                      const isCritical = item.totalStock <= 10;
                      
                      return (
                        <div 
                          key={idx} 
                          className={`bg-white rounded-xl shadow-sm overflow-hidden border-l-4 transition-all ${
                            isCritical ? 'border-l-red-500' : 'border-l-orange-400'
                          }`}
                        >
                          {/* å¡ç‰‡ä¸»é«” */}
                          <div className="p-4">
                            {/* ç¬¬ä¸€è¡Œï¼šç”¢å“åç¨± + é¡å‹æ¨™ç±¤ + è™•ç†å»ºè­° */}
                            <div className="flex items-start justify-between gap-2 mb-1">
                              <div className="flex-1 min-w-0">
                                <h4 className="text-lg font-bold text-gray-900 leading-tight truncate">{item.name}</h4>
                                <p className="text-lg text-gray-500 mt-0.5 truncate">{item.specDetail || 'â€”'}</p>
                              </div>
                              {/* è™•ç†å»ºè­°æ¨™ç±¤ */}
                              <div className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-bold ${
                                item.action === 'éœ€èª¿æ’¥' 
                                  ? 'bg-blue-500 text-white' 
                                  : item.action === 'éœ€æ¡è³¼'
                                    ? 'bg-purple-500 text-white'
                                    : 'bg-purple-500 text-white'
                              }`}>
                                {item.action}
                              </div>
                            </div>
                            
                            {/* ç¬¬äºŒè¡Œï¼šå“è™Ÿ + é¡å‹ */}
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-xs text-gray-400 font-mono">{item.pid}</span>
                              <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${
                                item.prodType === 'æ¡è³¼å“' 
                                  ? 'bg-blue-100 text-blue-600' 
                                  : 'bg-purple-100 text-purple-600'
                              }`}>
                                {item.prodType || 'è‡ªè£½å“'}
                              </span>
                            </div>
                            
                            {/* ğŸ†• å„€è¡¨æ¿æ•¸å­—å€ - ä¸‰æ¬„ä¸¦æ’ */}
                            <div className="grid grid-cols-3 gap-2 mb-3">
                              {/* ç¼ºè²¨æ•¸ - æœ€é‡è¦ */}
                              <div className={`rounded-xl p-3 text-center ${isCritical ? 'bg-red-500' : 'bg-red-100'}`}>
                                <div className={`text-2xl font-black ${isCritical ? 'text-white' : 'text-red-600'}`}>
                                  {item.shortage}
                                </div>
                                <div className={`text-xs font-medium ${isCritical ? 'text-red-100' : 'text-red-500'}`}>
                                  ç¼ºè²¨æ•¸
                                </div>
                              </div>
                              
                              {/* å®‰å…¨åº«å­˜ */}
                              <div className="bg-gray-100 rounded-xl p-3 text-center">
                                <div className="text-2xl font-black text-gray-600">
                                  {item.safetyStock}
                                </div>
                                <div className="text-xs font-medium text-gray-400">
                                  å®‰å…¨åº«å­˜
                                </div>
                              </div>
                              
                              {/* ç›®å‰ç¸½é‡ */}
                              <div className="bg-gray-100 rounded-xl p-3 text-center">
                                <div className={`text-2xl font-black ${item.totalStock === 0 ? 'text-red-500' : 'text-gray-800'}`}>
                                  {item.totalStock}
                                </div>
                                <div className="text-xs font-medium text-gray-400">
                                  ç›®å‰ç¸½é‡
                                </div>
                              </div>
                            </div>
                            
                            {/* ğŸ†• å…¶ä»–å€‰åº«æç¤ºï¼ˆå¦‚æœæœ‰å¯èª¿æ’¥åº«å­˜ï¼‰*/}
                            {item.otherTotalStock > 0 && (
                              <div className="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 mb-3 flex items-center gap-2">
                                <span className="text-blue-500">ğŸ“¦</span>
                                <span className="text-sm text-blue-700 font-medium">
                                  å…¶ä»–å€‰åº«æœ‰ <span className="font-bold">{item.otherTotalStock}</span> ä»¶å¯èª¿æ’¥
                                </span>
                              </div>
                            )}
                            
                            {/* ğŸ†• æŠ˜ç–ŠæŒ‰éˆ• - æŸ¥çœ‹å€‰åº«åˆ†ä½ˆ */}
                            <button
                              onClick={() => toggleExpand(idx)}
                              className="w-full flex items-center justify-center gap-2 py-2 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition-colors"
                            >
                              <span>{isExpanded ? 'æ”¶èµ·å€‰åº«åˆ†ä½ˆ' : 'æŸ¥çœ‹å€‰åº«åˆ†ä½ˆ'}</span>
                              <svg 
                                className={`w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''}`} 
                                fill="none" stroke="currentColor" viewBox="0 0 24 24"
                              >
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                              </svg>
                            </button>
                          </div>
                          
                          {/* ğŸ†• æŠ˜ç–Šå…§å®¹ - å€‰åº«åˆ†ä½ˆæ˜ç´° */}
                          {isExpanded && (
                            <div className="px-4 pb-4 pt-0 border-t border-gray-100">
                              {/* ä¸»è¦å€‰åº« */}
                              <div className="pt-3">
                                <div className="text-xs font-medium text-gray-500 mb-2">ä¸»è¦å‡ºè²¨å€‰åº«</div>
                                <div className="grid grid-cols-2 gap-2">
                                  {item.warehouseDetails && item.warehouseDetails.filter(wh => wh.isMain).map((wh, i) => (
                                    <div 
                                      key={i}
                                      className={`flex items-center justify-between px-3 py-2 rounded-lg text-sm ${
                                        wh.stock === 0 
                                          ? 'bg-red-50 text-red-600' 
                                          : wh.stock < 20 
                                            ? 'bg-orange-50 text-orange-600'
                                            : 'bg-purple-50 text-green-600'
                                      }`}
                                    >
                                      <span className="truncate text-xs">{wh.warehouse.replace('_', ' ')}</span>
                                      <span className="font-bold">{wh.stock}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                              
                              {/* å…¶ä»–å€‰åº«ï¼ˆå¦‚æœæœ‰ï¼‰*/}
                              {item.otherWarehouseDetails && item.otherWarehouseDetails.length > 0 && (
                                <div className="pt-3 mt-3 border-t border-gray-100">
                                  <div className="text-xs font-medium text-blue-500 mb-2">å…¶ä»–å€‰åº«ï¼ˆå¯èª¿æ’¥ï¼‰</div>
                                  <div className="grid grid-cols-2 gap-2">
                                    {item.otherWarehouseDetails.map((wh, i) => (
                                      <div 
                                        key={i}
                                        className="flex items-center justify-between px-3 py-2 rounded-lg text-sm bg-blue-50 text-blue-600"
                                      >
                                        <span className="truncate text-xs">{wh.warehouse}</span>
                                        <span className="font-bold">{wh.stock}</span>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>

                  {/* åº•éƒ¨æ“ä½œåˆ— */}
                  <div className="px-4 py-3 border-t bg-white flex-shrink-0">
                    <div className="flex gap-2">
                      <button 
                        onClick={() => {
                          // åŒ¯å‡º Excel
                          if (lowStockItems.length === 0) {
                            alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                            return;
                          }
                          
                          const exportData = lowStockItems.map(item => {
                            const whStocks = {};
                            MAIN_WAREHOUSES.forEach(wh => {
                              const found = item.warehouseDetails ? item.warehouseDetails.find(d => d.warehouse === wh) : null;
                              whStocks[wh] = found ? found.stock : 0;
                            });
                            
                            const otherWhStr = item.otherWarehouseDetails 
                              ? item.otherWarehouseDetails.map(w => `${w.warehouse}:${w.stock}`).join(', ')
                              : '';
                            
                            return {
                              'å“è™Ÿ': item.pid,
                              'ç”¢å“åç¨±': item.name,
                              'è¦æ ¼': item.specDetail,
                              'é¡å‹': item.prodType || 'è‡ªè£½å“',
                              ...whStocks,
                              'ç¸½åº«å­˜': item.totalStock,
                              'å®‰å…¨åº«å­˜': item.safetyStock,
                              'ç¼ºè²¨é‡': item.shortage,
                              'å…¶ä»–å€‰åº«': otherWhStr,
                              'è™•ç†å»ºè­°': item.action
                            };
                          });
                          
                          const ws = XLSX.utils.json_to_sheet(exportData);
                          ws['!cols'] = [
                            { wch: 15 }, { wch: 20 }, { wch: 25 }, { wch: 8 },
                            { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                            { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 25 }, { wch: 10 }
                          ];
                          
                          const wb = XLSX.utils.book_new();
                          XLSX.utils.book_append_sheet(wb, ws, 'ä½åº«å­˜å ±è¡¨');
                          
                          const today = new Date();
                          const dateStr = `${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}`;
                          XLSX.writeFile(wb, `ä½åº«å­˜å ±è¡¨_${dateStr}.xlsx`);
                        }}
                        className="flex-1 py-3 bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white rounded-xl font-bold transition-colors flex items-center justify-center gap-2"
                      >
                        <span>ğŸ“Š</span>
                        <span>åŒ¯å‡º Excel</span>
                      </button>
                      <button 
                        onClick={() => setShowLowStockAlert(false)} 
                        className="flex-1 py-3 bg-gray-800 hover:bg-gray-900 active:bg-black text-white rounded-xl font-bold transition-colors"
                      >
                        æˆ‘çŸ¥é“äº†
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}


            {/* å®‰å…¨åº«å­˜è¨­å®šå½ˆçª— - éŸ¿æ‡‰å¼è¨­è¨ˆ */}
            {showSafetyStockModal && (
              <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-0 lg:p-4">
                <div className="bg-white w-full h-full lg:h-auto lg:max-w-4xl lg:rounded-2xl flex flex-col overflow-hidden shadow-2xl lg:max-h-[90vh]">
                  {/* é ­éƒ¨ */}
                  <div className={`px-4 lg:px-6 py-3 lg:py-4 border-b bg-gradient-to-r ${role === 'store' ? 'from-cyan-500 to-teal-600' : 'from-blue-500 to-indigo-600'} text-white flex-shrink-0`}>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2 lg:gap-3">
                        <div className="w-10 h-10 lg:w-12 lg:h-12 bg-white/20 rounded-xl flex items-center justify-center text-xl lg:text-2xl">
                          {role === 'store' ? 'ğŸª' : 'ğŸ­'}
                        </div>
                        <div>
                          <h3 className="font-bold text-base lg:text-xl">{role === 'store' ? 'é–€å¸‚' : 'å·¥å» '}å®‰å…¨åº«å­˜è¨­å®š</h3>
                          <p className="text-xs lg:text-sm opacity-90">é è¨­ {DEFAULT_SAFETY_STOCK} ä»¶</p>
                        </div>
                      </div>
                      <button 
                        onClick={() => {
                          setShowSafetyStockModal(false);
                          setSafetyStockSearch('');
                          setSafetyStockFilter('all');
                        }} 
                        className="bg-white/20 hover:bg-white/30 w-10 h-10 rounded-lg font-bold text-xl flex items-center justify-center"
                      >âœ•</button>
                    </div>
                  </div>
                  
                  {/* æœå°‹æ¬„ + å¿«æ·ç¯©é¸ */}
                  <div className="px-3 lg:px-6 py-3 border-b bg-gray-50 flex-shrink-0">
                    <form className="relative mb-2" onSubmit={e => { e.preventDefault(); setSafetyStockSearch(document.getElementById('safetyStockSearchInput')?.value || ''); }}>
                      <input
                        id="safetyStockSearchInput"
                        type="search"
                        inputMode="search"
                        enterKeyHint="search"
                        autoComplete="off"
                        autoCorrect="off"
                        autoCapitalize="off"
                        spellCheck="false"
                        placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter æœå°‹..."
                        className="w-full pl-10 pr-20 py-2.5 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none text-base"
                      />
                      <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                      <div className="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                        <button 
                          type="submit"
                          className="px-2 py-1 bg-blue-500 text-white text-xs font-bold rounded-lg"
                        >æœå°‹</button>
                        <button 
                          type="button"
                          onClick={() => {
                            const input = document.getElementById('safetyStockSearchInput');
                            if (input) input.value = '';
                            setSafetyStockSearch('');
                          }}
                          className="px-2 py-1 bg-gray-300 text-gray-600 text-xs font-bold rounded-lg"
                        >æ¸…é™¤</button>
                      </div>
                    </form>
                    {/* å¿«æ·ç¯©é¸ - å¯æ©«å‘æ»¾å‹• */}
                    <div className="flex gap-2 overflow-x-auto pb-1 -mx-1 px-1" style={{scrollbarWidth: 'none', msOverflowStyle: 'none'}}>
                      {(() => {
                        const products = data.products || {};
                        const inventory = data.inventory || {};
                        const currentWarehouses = role === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
                        const currentSafetyStock = role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
                        const discontinuedProducts = data.discontinuedProducts || {};
                        const storeOnlyProducts = data.storeOnlyProducts || {};
                        let lowCount = 0, outCount = 0, okCount = 0, customCount = 0, discontinuedCount = 0, storeOnlyCount = 0;
                        
                        Object.entries(products).forEach(([name, specs]) => {
                          if (!Array.isArray(specs)) return;
                          specs.forEach(spec => {
                            if (!spec.id) return;
                            if (discontinuedProducts[spec.id]) { discontinuedCount++; return; }
                            if (storeOnlyProducts[spec.id]) storeOnlyCount++;
                            const stocks = inventory[spec.id] || [];
                            const mainStocks = stocks.filter(s => currentWarehouses.includes(s.warehouse));
                            const total = mainStocks.reduce((sum, s) => sum + Math.floor(s.stock), 0);
                            const safety = currentSafetyStock[spec.id] !== undefined ? currentSafetyStock[spec.id] : DEFAULT_SAFETY_STOCK;
                            if (total === 0) outCount++;
                            else if (total < safety) lowCount++;
                            else okCount++;
                            if (currentSafetyStock[spec.id] !== undefined) customCount++;
                          });
                        });
                        
                        return (
                          <>
                            <button onClick={() => setSafetyStockFilter('all')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap flex-shrink-0 ${safetyStockFilter === 'all' ? 'bg-purple-500 text-white shadow' : 'bg-white border border-purple-300 text-purple-600'}`}>å…¨éƒ¨</button>
                            <button onClick={() => setSafetyStockFilter('out')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap flex-shrink-0 ${safetyStockFilter === 'out' ? 'bg-red-500 text-white shadow' : 'bg-white border border-red-300 text-red-600'}`}>ç¼ºè²¨ ({outCount})</button>
                            <button onClick={() => setSafetyStockFilter('low')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap flex-shrink-0 ${safetyStockFilter === 'low' ? 'bg-orange-500 text-white shadow' : 'bg-white border border-orange-300 text-orange-600'}`}>ä½åº«å­˜ ({lowCount})</button>
                            <button onClick={() => setSafetyStockFilter('ok')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap flex-shrink-0 ${safetyStockFilter === 'ok' ? 'bg-green-500 text-white shadow' : 'bg-white border border-green-300 text-green-600'}`}>æ­£å¸¸ ({okCount})</button>
                            <button onClick={() => setSafetyStockFilter('custom')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap flex-shrink-0 ${safetyStockFilter === 'custom' ? 'bg-blue-500 text-white shadow' : 'bg-white border border-blue-300 text-blue-600'}`}>å·²è‡ªè¨‚ ({customCount})</button>
                            <button onClick={() => setSafetyStockFilter('discontinued')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap flex-shrink-0 ${safetyStockFilter === 'discontinued' ? 'bg-gray-500 text-white shadow' : 'bg-white border border-gray-400 text-gray-600'}`}>åœå”® ({discontinuedCount})</button>
                            <button onClick={() => setSafetyStockFilter('storeOnly')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap flex-shrink-0 ${safetyStockFilter === 'storeOnly' ? 'bg-cyan-500 text-white shadow' : 'bg-white border border-cyan-400 text-cyan-600'}`}>ğŸªé–€å¸‚ ({storeOnlyCount})</button>
                          </>
                        );
                      })()}
                    </div>
                  </div>

                  {/* ç”¢å“åˆ—è¡¨ */}
                  <div className="flex-1 overflow-auto">
                    {(() => {
                      let productList = [];
                      const products = data.products || {};
                      const inventory = data.inventory || {};
                      const currentWarehouses = role === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
                      const currentSafetyStockData = role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
                      const discontinuedProducts = data.discontinuedProducts || {};
                      
                      Object.entries(products).forEach(([name, specs]) => {
                        if (!Array.isArray(specs)) return;
                        specs.forEach(spec => {
                          if (!spec.id) return;
                          const searchLower = safetyStockSearch.toLowerCase();
                          if (searchLower && !name.toLowerCase().includes(searchLower) && !spec.id.toLowerCase().includes(searchLower) && !(spec.specDetail || '').toLowerCase().includes(searchLower)) return;
                          
                          const stocks = inventory[spec.id] || [];
                          const mainStocks = stocks.filter(s => currentWarehouses.includes(s.warehouse));
                          const totalStock = mainStocks.reduce((sum, s) => sum + Math.floor(s.stock), 0);
                          const otherStocks = stocks.filter(s => !currentWarehouses.includes(s.warehouse) && s.stock > 0);
                          const otherTotalStock = otherStocks.reduce((sum, s) => sum + Math.floor(s.stock), 0);
                          const currentSafety = currentSafetyStockData[spec.id] !== undefined ? currentSafetyStockData[spec.id] : DEFAULT_SAFETY_STOCK;
                          const isCustom = currentSafetyStockData[spec.id] !== undefined;
                          const isLowStock = totalStock > 0 && totalStock < currentSafety;
                          const isOutOfStock = totalStock === 0;
                          const isOk = totalStock >= currentSafety;
                          const isDiscontinued = !!discontinuedProducts[spec.id];
                          const isStoreOnly = !!(data.storeOnlyProducts || {})[spec.id];
                          
                          productList.push({ pid: spec.id, name, specDetail: spec.specDetail || '', currentSafety, isCustom, isLowStock, isOutOfStock, isOk, isDiscontinued, isStoreOnly, stocks: mainStocks, totalStock, otherStocks, otherTotalStock });
                        });
                      });
                      
                      if (safetyStockFilter === 'discontinued') productList = productList.filter(item => item.isDiscontinued);
                      else if (safetyStockFilter === 'storeOnly') productList = productList.filter(item => item.isStoreOnly);
                      else if (safetyStockFilter === 'low') productList = productList.filter(item => !item.isDiscontinued && item.isLowStock);
                      else if (safetyStockFilter === 'out') productList = productList.filter(item => !item.isDiscontinued && item.isOutOfStock);
                      else if (safetyStockFilter === 'ok') productList = productList.filter(item => !item.isDiscontinued && item.isOk);
                      else if (safetyStockFilter === 'custom') productList = productList.filter(item => !item.isDiscontinued && item.isCustom);
                      else productList = productList.filter(item => !item.isDiscontinued);
                      
                      productList.sort((a, b) => {
                        if (a.isOutOfStock !== b.isOutOfStock) return a.isOutOfStock ? -1 : 1;
                        if (a.isLowStock !== b.isLowStock) return a.isLowStock ? -1 : 1;
                        return a.name.localeCompare(b.name, 'zh-TW');
                      });
                      
                      if (productList.length === 0) {
                        return (
                          <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                            <Icons.Package className="w-16 h-16 mx-auto mb-4 opacity-30" />
                            <p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¢å“</p>
                          </div>
                        );
                      }
                      
                      return (
                        <div className="p-3 space-y-3">
                          {productList.map((item, idx) => (
                            <div 
                              key={idx} 
                              className={`rounded-2xl border-2 overflow-hidden shadow-sm ${
                                item.isDiscontinued ? 'border-gray-300 bg-gray-50 opacity-60' : 
                                item.isStoreOnly ? 'border-cyan-400 bg-cyan-50/30' :
                                item.isOutOfStock ? 'border-red-300 bg-red-50/30' : 
                                item.isLowStock ? 'border-orange-300 bg-orange-50/30' : 
                                'border-gray-200 bg-white'
                              }`}
                            >
                              {/* ç”¢å“è³‡è¨Šå€ */}
                              <div className="px-4 py-3 border-b border-gray-100">
                                <div className="flex items-start justify-between gap-2 mb-2">
                                  <div className="flex-1 min-w-0">
                                    <div className={`font-bold text-base ${item.isDiscontinued ? 'text-gray-400 line-through' : 'text-gray-800'}`}>{item.name}</div>
                                    <div className={`text-sm ${item.isDiscontinued ? 'text-gray-400' : 'text-gray-500'}`}>{item.specDetail}</div>
                                  </div>
                                  <div className="flex gap-1 flex-shrink-0 flex-wrap justify-end">
                                    {item.isDiscontinued && <span className="text-xs px-2 py-1 rounded-lg bg-gray-500 text-white font-bold">åœå”®</span>}
                                    {item.isStoreOnly && <span className="text-xs px-2 py-1 rounded-lg bg-cyan-500 text-white font-bold">é–€å¸‚å°ˆè³£</span>}
                                    {!item.isDiscontinued && item.isOutOfStock && <span className="text-xs px-2 py-1 rounded-lg bg-red-500 text-white font-bold">ç¼ºè²¨</span>}
                                    {!item.isDiscontinued && item.isLowStock && <span className="text-xs px-2 py-1 rounded-lg bg-orange-500 text-white font-bold">ä½åº«å­˜</span>}
                                  </div>
                                </div>
                                {/* åº«å­˜è³‡è¨Š */}
                                <div className="flex items-center gap-2">
                                  <span className={`text-sm px-3 py-1.5 rounded-lg font-bold ${
                                    item.isOutOfStock ? 'bg-red-100 text-red-600' : 
                                    item.isLowStock ? 'bg-orange-100 text-orange-600' : 
                                    'bg-green-100 text-green-700'
                                  }`}>
                                    ğŸ“¦ åº«å­˜ {item.totalStock}
                                  </span>
                                  {item.otherTotalStock > 0 && (
                                    <span className="text-sm px-3 py-1.5 rounded-lg font-bold bg-cyan-100 text-cyan-700">
                                      ğŸ­ å¤–å€‰ {item.otherTotalStock}
                                    </span>
                                  )}
                                </div>
                              </div>
                              
                              {/* å®‰å…¨å€¼è¨­å®šå€ - å¤§å‹è¼¸å…¥æ¡†é… +/- æŒ‰éˆ• */}
                              <div className="px-4 py-3 bg-gray-50/50">
                                <div className="flex items-center justify-between gap-3">
                                  {/* å·¦ï¼šå®‰å…¨å€¼æ¨™ç±¤èˆ‡è¼¸å…¥ */}
                                  <div className="flex items-center gap-2">
                                    <span className="text-sm font-bold text-gray-600 whitespace-nowrap">å®‰å…¨å€¼</span>
                                    <div className="flex items-center">
                                      {/* æ¸›è™ŸæŒ‰éˆ• */}
                                      <button
                                        type="button"
                                        disabled={item.isDiscontinued}
                                        onClick={(e) => {
                                          const input = e.target.closest('.flex').querySelector('input');
                                          if (input) {
                                            const current = parseInt(input.value) || 0;
                                            const newVal = Math.max(0, current - 10);
                                            input.value = newVal;
                                            input.dispatchEvent(new Event('change', { bubbles: true }));
                                          }
                                        }}
                                        className={`w-11 h-11 rounded-l-xl text-xl font-bold flex items-center justify-center transition-colors ${
                                          item.isDiscontinued 
                                            ? 'bg-gray-200 text-gray-400' 
                                            : 'bg-purple-100 text-purple-600 active:bg-purple-200'
                                        }`}
                                      >âˆ’</button>
                                      {/* è¼¸å…¥æ¡† */}
                                      <input
                                        type="text"
                                        inputMode="numeric"
                                        pattern="[0-9]*"
                                        defaultValue={item.currentSafety}
                                        data-pid={item.pid}
                                        data-original={item.currentSafety}
                                        disabled={item.isDiscontinued}
                                        onFocus={e => e.target.select()}
                                        onChange={e => {
                                          e.target.value = e.target.value.replace(/[^0-9]/g, '');
                                          const isChanged = e.target.value !== String(e.target.dataset.original);
                                          e.target.className = `w-16 h-11 text-center font-bold text-lg border-y-2 outline-none ${
                                            isChanged ? 'border-orange-500 bg-orange-50 text-orange-600' :
                                            item.isCustom ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-200 bg-white text-gray-700'
                                          }`;
                                        }}
                                        className={`w-16 h-11 text-center font-bold text-lg border-y-2 outline-none ${
                                          item.isDiscontinued ? 'border-gray-200 bg-gray-100 text-gray-400' :
                                          item.isCustom ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-200 bg-white text-gray-700'
                                        }`}
                                      />
                                      {/* åŠ è™ŸæŒ‰éˆ• */}
                                      <button
                                        type="button"
                                        disabled={item.isDiscontinued}
                                        onClick={(e) => {
                                          const input = e.target.closest('.flex').querySelector('input');
                                          if (input) {
                                            const current = parseInt(input.value) || 0;
                                            const newVal = current + 10;
                                            input.value = newVal;
                                            input.dispatchEvent(new Event('change', { bubbles: true }));
                                          }
                                        }}
                                        className={`w-11 h-11 rounded-r-xl text-xl font-bold flex items-center justify-center transition-colors ${
                                          item.isDiscontinued 
                                            ? 'bg-gray-200 text-gray-400' 
                                            : 'bg-purple-100 text-purple-600 active:bg-purple-200'
                                        }`}
                                      >+</button>
                                    </div>
                                  </div>
                                  
                                  {/* å³ï¼šé–‹é—œæŒ‰éˆ•çµ„ - æ”¹ç‚ºå¤§å‹æŒ‰éˆ• */}
                                  <div className="flex items-center gap-2">
                                    {/* é–€å¸‚å°ˆè³£æŒ‰éˆ• */}
                                    <label className="cursor-pointer">
                                      <input type="checkbox" className="sr-only peer" data-pid={item.pid} data-type="storeOnly" defaultChecked={item.isStoreOnly} />
                                      <div className={`px-3 py-2 rounded-xl text-sm font-bold transition-all border-2 ${
                                        item.isStoreOnly 
                                          ? 'bg-cyan-500 text-white border-cyan-500' 
                                          : 'bg-white text-cyan-600 border-cyan-300 peer-checked:bg-cyan-500 peer-checked:text-white peer-checked:border-cyan-500'
                                      }`}>
                                        ğŸª é–€å¸‚
                                      </div>
                                    </label>
                                    {/* åœå”®æŒ‰éˆ• */}
                                    <label className="cursor-pointer">
                                      <input type="checkbox" className="sr-only peer" data-pid={item.pid} data-type="discontinued" defaultChecked={item.isDiscontinued} />
                                      <div className={`px-3 py-2 rounded-xl text-sm font-bold transition-all border-2 ${
                                        item.isDiscontinued 
                                          ? 'bg-gray-500 text-white border-gray-500' 
                                          : 'bg-white text-gray-500 border-gray-300 peer-checked:bg-gray-500 peer-checked:text-white peer-checked:border-gray-500'
                                      }`}>
                                        â›” åœå”®
                                      </div>
                                    </label>
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </div>

                  {/* åº•éƒ¨æŒ‰éˆ• */}
                  <div className="px-4 py-3 border-t bg-gray-50 flex-shrink-0 flex gap-3">
                    <button 
                      onClick={() => {
                        setShowSafetyStockModal(false);
                        setSafetyStockSearch('');
                        setSafetyStockFilter('all');
                      }} 
                      className="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold"
                    >
                      å–æ¶ˆ
                    </button>
                    <button 
                      onClick={() => {
                        const isStoreMode = role === 'store';
                        const currentSafetyStockKey = isStoreMode ? 'storeSafetyStock' : 'safetyStock';
                        const currentDateKey = isStoreMode ? 'storeSafetyStockDate' : 'safetyStockDate';
                        
                        const inputs = document.querySelectorAll('input[data-pid][data-original]');
                        const currentSafetyStockData = isStoreMode ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
                        const newSafetyStock = { ...currentSafetyStockData };
                        let safetyChangeCount = 0;
                        
                        inputs.forEach(input => {
                          const pid = input.dataset.pid;
                          const originalStr = input.dataset.original;
                          const newStr = input.value.trim();
                          if (newStr !== originalStr && newStr !== '') {
                            safetyChangeCount++;
                            const parsed = parseInt(newStr);
                            const newVal = isNaN(parsed) ? DEFAULT_SAFETY_STOCK : parsed;
                            if (newVal === DEFAULT_SAFETY_STOCK) delete newSafetyStock[pid];
                            else newSafetyStock[pid] = newVal;
                          }
                        });
                        
                        const discontinuedInputs = document.querySelectorAll('input[data-pid][data-type="discontinued"]');
                        const newDiscontinuedProducts = { ...(data.discontinuedProducts || {}) };
                        let discontinuedChangeCount = 0;
                        discontinuedInputs.forEach(input => {
                          const pid = input.dataset.pid;
                          const wasDiscontinued = !!data.discontinuedProducts?.[pid];
                          if (wasDiscontinued !== input.checked) {
                            discontinuedChangeCount++;
                            if (input.checked) newDiscontinuedProducts[pid] = true;
                            else delete newDiscontinuedProducts[pid];
                          }
                        });
                        
                        const storeOnlyInputs = document.querySelectorAll('input[data-pid][data-type="storeOnly"]');
                        const newStoreOnlyProducts = { ...(data.storeOnlyProducts || {}) };
                        let storeOnlyChangeCount = 0;
                        storeOnlyInputs.forEach(input => {
                          const pid = input.dataset.pid;
                          const wasStoreOnly = !!data.storeOnlyProducts?.[pid];
                          if (wasStoreOnly !== input.checked) {
                            storeOnlyChangeCount++;
                            if (input.checked) newStoreOnlyProducts[pid] = true;
                            else delete newStoreOnlyProducts[pid];
                          }
                        });
                        
                        const totalChanges = safetyChangeCount + discontinuedChangeCount + storeOnlyChangeCount;
                        if (totalChanges > 0) {
                          uploadDB({
                            [currentSafetyStockKey]: newSafetyStock,
                            discontinuedProducts: newDiscontinuedProducts,
                            storeOnlyProducts: newStoreOnlyProducts,
                            dbMeta: { ...(data.meta || {}), [currentDateKey]: new Date().toLocaleString('zh-TW'), lastUpdate: new Date().toISOString() }
                          });
                          let msg = `å·²å„²å­˜ï¼š`;
                          if (safetyChangeCount > 0) msg += `${safetyChangeCount}ç­†å®‰å…¨å€¼ã€`;
                          if (discontinuedChangeCount > 0) msg += `${discontinuedChangeCount}ç­†åœå”®ã€`;
                          if (storeOnlyChangeCount > 0) msg += `${storeOnlyChangeCount}ç­†é–€å¸‚å°ˆè³£ã€`;
                          alert(msg.slice(0, -1));
                        } else {
                          alert('æ²’æœ‰åµæ¸¬åˆ°è®Šæ›´');
                        }
                        setShowSafetyStockModal(false);
                        setSafetyStockSearch('');
                      }} 
                      className={`flex-1 py-3 bg-gradient-to-r ${role === 'store' ? 'from-cyan-500 to-teal-600' : 'from-blue-500 to-indigo-600'} text-white rounded-xl font-bold`}
                    >
                      å„²å­˜è®Šæ›´
                    </button>
                  </div>
                </div>
              </div>
            )}
          </>
        );
      };

      // ==================== ğŸ  é¦–é å…ƒä»¶ ====================

      const HomePage = () => {
        // è¨ˆç®—ä½åº«å­˜æ•¸é‡
        const lowStockCount = lowStockItems.length;
        
        return (
          <div className="p-4 pb-24 animate-fade-in max-w-2xl mx-auto">
            {/* æ­¡è¿æ©«å¹… */}
            <div className="bg-gradient-to-br from-purple-500 to-indigo-600 text-white rounded-3xl p-6 mb-6 card-shadow-lg animate-slide-up">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h1 className="text-3xl font-bold mb-2">ğŸ‘‹ æ­¡è¿å›ä¾†ï¼</h1>
                  <p className="text-purple-100 text-sm">
                    {role === 'admin' ? 'ç®¡ç†å“¡' : role === 'store' ? 'é–€å¸‚' : 'æ¥­å‹™å“¡'} â€¢ {new Date().toLocaleDateString('zh-TW')}
                  </p>
                </div>
                <div className="flex items-center gap-3">
                  {/* ğŸ†• ä½åº«å­˜éˆ´éºæŒ‰éˆ• */}
                  <button
                    onClick={() => {
                      const items = checkLowStock();
                      setLowStockItems(items);
                      if (items.length > 0) {
                        setShowLowStockAlert(true);
                      } else {
                        alert('âœ… ç›®å‰æ²’æœ‰ä½åº«å­˜ç”¢å“ï¼');
                      }
                    }}
                    className="relative w-12 h-12 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center transition-colors"
                    title="ä½åº«å­˜æé†’"
                  >
                    <svg className="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    {lowStockCount > 0 && (
                      <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 animate-pulse">
                        {lowStockCount > 99 ? '99+' : lowStockCount}
                      </span>
                    )}
                  </button>
                  <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <Icons.Sparkles className="w-8 h-8" />
                  </div>
                </div>
              </div>
              
              <button
                onClick={() => {
                  setCart([]);
                  setCustInfo({
                    ...custInfo,
                    name: '',
                    date: new Date().toISOString().split('T')[0]
                  });
                  setCurrentTab('quote');
                  setShowProductSearch(true);
                }}
                className="w-full bg-white text-purple-600 py-4 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2"
              >
                <Icons.Plus className="w-6 h-6" />
                æ–°å»ºå ±åƒ¹å–®
              </button>
            </div>
            
            {/* å¿«é€Ÿæ“ä½œ */}
            <div className="glass card-shadow rounded-3xl p-5 mb-6 animate-slide-up" style={{animationDelay: '0.3s'}}>
              <h2 className="text-lg font-bold flex items-center gap-2 mb-4">
                <Icons.Sparkles className="w-5 h-5 text-purple-600" />
                å¿«é€Ÿæ“ä½œ
              </h2>
              
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => {
                    setCurrentTab('quote');
                    setShowProductSearch(true);
                  }}
                  className="btn-gradient text-white py-4 rounded-xl font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform"
                >
                  <Icons.Search className="w-6 h-6" />
                  <span>æœå°‹ç”¢å“</span>
                </button>
                
                <button
                  onClick={() => setCurrentTab('history')}
                  className="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform"
                >
                  <Icons.History className="w-6 h-6" />
                  <span>æ­·å²è¨˜éŒ„</span>
                </button>
                
                <button
                  onClick={() => {
                    const items = checkLowStock();
                    setLowStockItems(items);
                    if (items.length > 0) {
                      setShowLowStockAlert(true);
                    } else {
                      alert('âœ… å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰ä½åº«å­˜çš„ç”¢å“');
                    }
                  }}
                  className="bg-gradient-to-r from-orange-500 to-red-500 text-white py-4 rounded-xl font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform relative"
                >
                  <Icons.Package className="w-6 h-6" />
                  <span>åº«å­˜æª¢æŸ¥</span>
                  {(() => {
                    const count = checkLowStock().length;
                    if (count > 0) {
                      return (
                        <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold animate-pulse">
                          {count > 99 ? '99+' : count}
                        </span>
                      );
                    }
                    return null;
                  })()}
                </button>
                
                <button
                  onClick={() => setCurrentTab('quote')}
                  className="bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform"
                >
                  <Icons.ShoppingCart className="w-6 h-6" />
                  <span>ç·¨è¼¯å ±åƒ¹</span>
                </button>
                
                {/* ğŸ†• CRM å®¢æˆ¶ç®¡ç†å…¥å£ */}
                <button
                  onClick={() => { setPage('admin'); setSettingsTab('crm'); }}
                  className="bg-gradient-to-r from-cyan-500 to-teal-500 text-white py-4 rounded-xl font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform"
                >
                  <Icons.Users className="w-6 h-6" />
                  <span>å®¢æˆ¶ç®¡ç†</span>
                </button>
                
                {(role === 'admin' || role === 'store') && (
                  <button
                    onClick={() => setPage('admin')}
                    className="bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4 rounded-xl font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform"
                  >
                    <Icons.Settings className="w-6 h-6" />
                    <span>ç³»çµ±ç®¡ç†</span>
                  </button>
                )}
              </div>
            </div>
            
            {/* æœ€è¿‘å ±åƒ¹ */}
            {quotes.length > 0 && (
              <div className="glass card-shadow rounded-3xl p-5 animate-slide-up" style={{animationDelay: '0.4s'}}>
                <h2 className="text-lg font-bold flex items-center gap-2 mb-4">
                  <Icons.History className="w-5 h-5 text-purple-600" />
                  æœ€è¿‘å ±åƒ¹
                </h2>
                
                <div className="space-y-3">
                  {quotes.slice(-3).reverse().map(quote => {
                    const date = new Date(quote.date);
                    const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                    
                    return (
                      <div 
                        key={quote.id}
                        onClick={() => {
                          loadQuote(quote.id);
                          setCurrentTab('quote');
                        }}
                        className="p-4 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:shadow-lg transition-all cursor-pointer"
                      >
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <div className="font-bold text-gray-800">{quote.customer.name || 'æœªå‘½åå®¢æˆ¶'}</div>
                            <div className="text-xs text-gray-500">{dateStr} â€¢ {quote.customer.tier}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-xl font-bold text-purple-600">${quote.total.toLocaleString()}</div>
                            <div className="text-xs text-gray-500">{quote.products.length} é …</div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                {quotes.length > 3 && (
                  <button 
                    onClick={() => setCurrentTab('history')}
                    className="w-full mt-3 py-2 text-purple-600 font-bold hover:bg-purple-50 rounded-lg transition-colors"
                  >
                    æŸ¥çœ‹å…¨éƒ¨ ({quotes.length})
                  </button>
                )}
              </div>
            )}
          </div>
        );
      };
      // ==================== ğŸ” ç”¢å“é å…ƒä»¶ ====================
      const ProductsPage = () => {
        const [searchLocal, setSearchLocal] = useState('');
        
        const localFilteredSpecs = filteredSpecs.filter(spec => {
          if (!searchLocal) return true;
          const s = searchLocal.toLowerCase();
          return (
            spec.name?.toLowerCase().includes(s) ||
            spec.id?.toLowerCase().includes(s) ||
            spec.specDetail?.toLowerCase().includes(s)
          );
        });
        
        return (
          <div className="pb-24 animate-fade-in">
            {/* æœå°‹æ¬„ */}
            <div className="glass border-b border-white/30 p-4 sticky top-0 z-40">
              <div className="max-w-2xl mx-auto">
                <div className="flex items-center gap-2">
                  <div className="flex-1 relative">
                    <input
                      type="text"
                      value={searchLocal}
                      onChange={(e) => setSearchLocal(e.target.value)}
                      placeholder="æœå°‹ç”¢å“åç¨±ã€å“è™Ÿã€è¦æ ¼..."
                      className="w-full pl-10 pr-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-purple-500 outline-none transition-all"
                    />
                    <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                    {searchLocal && (
                      <button 
                        onClick={() => setSearchLocal('')}
                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                      >
                        âœ•
                      </button>
                    )}
                  </div>
                  
                  <button 
                    onClick={() => setCurrentTab('quote')}
                    className="relative p-3 bg-purple-100 rounded-2xl text-purple-600"
                  >
                    <Icons.ShoppingCart className="w-6 h-6" />
                    {cart.length > 0 && (
                      <span className="absolute -top-1 -right-1 cart-badge text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                        {cart.length}
                      </span>
                    )}
                  </button>
                </div>
                
                <div className="text-sm text-gray-600 mt-2 flex items-center justify-between">
                  <span>æ‰¾åˆ° {localFilteredSpecs.length} é …ç”¢å“</span>
                  {cart.length > 0 && (
                    <span className="text-purple-600 font-bold">è³¼ç‰©è»Š: {cart.length} é …</span>
                  )}
                </div>
              </div>
            </div>
            
            {/* ç”¢å“åˆ—è¡¨ */}
            <div className="max-w-2xl mx-auto p-4 space-y-4">
              {localFilteredSpecs.length === 0 ? (
                <div className="text-center py-20">
                  <Icons.Package className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                  <div className="text-gray-400 text-lg font-bold">æ‰¾ä¸åˆ°ç”¢å“</div>
                  <div className="text-sm text-gray-400 mt-2">è©¦è©¦å…¶ä»–é—œéµå­—</div>
                </div>
              ) : (
                localFilteredSpecs.map(spec => {
                  const stocks = data.inventory[spec.id] || [];
                  const total = stocks.reduce((s, x) => s + (x.stock || 0), 0);
                  const price = (spec.prices && spec.prices[custInfo.tier]) || 0;
                  
                  return (
                    <div 
                      key={spec.id}
                      className="glass card-shadow rounded-3xl p-5 animate-slide-up hover:shadow-lg transition-all"
                    >
                      {/* ç”¢å“ä¿¡æ¯ */}
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                          <h3 className="text-xl font-bold text-gray-800 mb-1">{spec.name}</h3>
                          <div className="text-sm text-gray-500 mb-1">å“è™Ÿï¼š{spec.id}</div>
                          <div className="text-sm text-gray-600">{spec.specDetail}</div>
                        </div>
                      </div>
                      
                      {/* åƒ¹æ ¼å€åŸŸ */}
                      <div className="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl p-4 mb-3">
                        <div className="grid grid-cols-2 gap-3">
                          {spec.prices && Object.entries(spec.prices).slice(0, 4).map(([tier, p]) => (
                            <div key={tier} className={`${tier === custInfo.tier ? 'bg-white shadow-sm rounded-xl p-2' : ''}`}>
                              <div className="text-xs text-gray-500">{tier}</div>
                              <div className={`text-lg font-bold ${tier === custInfo.tier ? 'text-purple-600' : 'text-gray-700'}`}>
                                ${p.toLocaleString()}
                              </div>
                            </div>
                          ))}
                        </div>
                        {spec.prices && Object.keys(spec.prices).length > 4 && (
                          <div className="text-xs text-gray-500 mt-2 text-center">
                            é‚„æœ‰ {Object.keys(spec.prices).length - 4} å€‹åƒ¹æ ¼ç­‰ç´š
                          </div>
                        )}
                      </div>
                      
                      {/* åº«å­˜ä¿¡æ¯ */}
                      {stocks.length > 0 && (
                        <div className="mb-3">
                          <div className="text-xs text-gray-500 mb-2">åº«å­˜ç‹€æ³</div>
                          <div className="flex gap-2 flex-wrap">
                            {stocks.map((s, k) => (
                              <span key={k} className={`text-xs px-3 py-1.5 rounded-lg font-bold ${
                                s.stock > 20 ? 'badge-green' : s.stock > 0 ? 'badge-yellow' : 'badge-red'
                              }`}>
                                {s.warehouse}: {Math.floor(s.stock)}
                              </span>
                            ))}
                          </div>
                          <div className="text-sm text-gray-600 mt-2">
                            ç¸½åº«å­˜: <span className="font-bold text-purple-600">{Math.floor(total)}</span> ä»¶
                          </div>
                        </div>
                      )}
                      
                      {/* åŠ å…¥æŒ‰éˆ• */}
                      <button 
                        onClick={() => {
                          addProductFromDB(spec);
                          // åŠ å…¥å¾Œæç¤º
                          const btn = event.target.closest('button');
                          const originalText = btn.innerHTML;
                          btn.innerHTML = 'âœ“ å·²åŠ å…¥';
                          btn.classList.add('bg-purple-500');
                          setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('bg-purple-500');
                          }, 1000);
                        }}
                        className="w-full btn-gradient text-white py-3 rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all"
                      >
                        <Icons.ShoppingCart className="w-5 h-5" />
                        åŠ å…¥å ±åƒ¹ (${price.toLocaleString()})
                      </button>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        );
      };

      // ==================== ğŸ“š æ­·å²é å…ƒä»¶ ====================
      const HistoryPage = () => {
        const [searchQuery, setSearchQuery] = useState('');
        const [sortBy, setSortBy] = useState('date'); // 'date' | 'amount' | 'customer'
        
        let filteredQuotes = quotes.filter(q => {
          if (!searchQuery) return true;
          const s = searchQuery.toLowerCase();
          return (
            q.customer.name?.toLowerCase().includes(s) ||
            q.customer.phone?.includes(s) ||
            q.customer.mobile?.includes(s) ||
            q.customer.tier?.toLowerCase().includes(s)
          );
        });
        
        // æ’åº
        if (sortBy === 'date') {
          filteredQuotes = [...filteredQuotes].sort((a, b) => new Date(b.date) - new Date(a.date));
        } else if (sortBy === 'amount') {
          filteredQuotes = [...filteredQuotes].sort((a, b) => b.total - a.total);
        } else if (sortBy === 'customer') {
          filteredQuotes = [...filteredQuotes].sort((a, b) => (a.customer.name || '').localeCompare(b.customer.name || ''));
        }
        
        // æŒ‰æ—¥æœŸåˆ†çµ„
        const groupedByDate = {};
        filteredQuotes.forEach(quote => {
          const date = new Date(quote.date);
          const dateKey = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
          if (!groupedByDate[dateKey]) {
            groupedByDate[dateKey] = [];
          }
          groupedByDate[dateKey].push(quote);
        });
        
        return (
          <div className="pb-24 animate-fade-in">
            {/* æœå°‹å’Œæ’åºæ¬„ */}
            <div className="glass border-b border-white/30 p-4 sticky top-0 md:top-24 z-40">
              <div className="max-w-2xl mx-auto">
                <div className="relative mb-3">
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="æœå°‹å®¢æˆ¶ã€é›»è©±ã€åƒ¹æ ¼ç­‰ç´š..."
                    className="w-full pl-10 pr-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-purple-500 outline-none transition-all"
                  />
                  <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                  {searchQuery && (
                    <button 
                      onClick={() => setSearchQuery('')}
                      className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                    >
                      âœ•
                    </button>
                  )}
                </div>
                
                <div className="flex items-center justify-between">
                  <div className="text-sm text-gray-600">
                    å…± <span className="font-bold text-purple-600">{filteredQuotes.length}</span> ç­†å ±åƒ¹
                  </div>
                  
                  <select 
                    value={sortBy}
                    onChange={(e) => setSortBy(e.target.value)}
                    className="text-sm px-3 py-1.5 rounded-lg border-2 border-gray-200 focus:border-purple-500 outline-none"
                  >
                    <option value="date">ä¾æ—¥æœŸ</option>
                    <option value="amount">ä¾é‡‘é¡</option>
                    <option value="customer">ä¾å®¢æˆ¶</option>
                  </select>
                </div>
              </div>
            </div>
            
            {/* å ±åƒ¹åˆ—è¡¨ */}
            <div className="max-w-2xl mx-auto p-4">
              {filteredQuotes.length === 0 ? (
                <div className="text-center py-20">
                  <Icons.History className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                  <div className="text-gray-400 text-lg font-bold">
                    {searchQuery ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„è¨˜éŒ„' : 'å°šç„¡æ­·å²å ±åƒ¹'}
                  </div>
                  {!searchQuery && (
                    <button
                      onClick={() => setCurrentTab('quote')}
                      className="mt-4 btn-gradient text-white px-6 py-3 rounded-xl font-bold"
                    >
                      ç«‹å³å»ºç«‹å ±åƒ¹
                    </button>
                  )}
                </div>
              ) : (
                <div className="space-y-4">
                  {Object.entries(groupedByDate).map(([dateKey, dayQuotes]) => {
                    const [year, month, day] = dateKey.split('-');
                    const isToday = dateKey === `${new Date().getFullYear()}-${new Date().getMonth()+1}-${new Date().getDate()}`;
                    const isYesterday = (() => {
                      const yesterday = new Date();
                      yesterday.setDate(yesterday.getDate() - 1);
                      return dateKey === `${yesterday.getFullYear()}-${yesterday.getMonth()+1}-${yesterday.getDate()}`;
                    })();
                    
                    return (
                      <div key={dateKey} className="animate-slide-up">
                        {/* æ—¥æœŸæ¨™é¡Œ */}
                        <div className="sticky top-20 md:top-44 glass rounded-2xl px-4 py-2 mb-3 text-sm font-bold text-gray-700 flex items-center gap-2">
                          <Icons.History className="w-4 h-4" />
                          {isToday ? 'ä»Šå¤©' : isYesterday ? 'æ˜¨å¤©' : `${month}æœˆ${day}æ—¥`}
                          <span className="text-gray-400 ml-auto">{dayQuotes.length} ç­†</span>
                        </div>
                        
                        {/* è©²æ—¥æœŸçš„å ±åƒ¹ */}
                        <div className="space-y-3">
                          {dayQuotes.map(quote => {
                            const date = new Date(quote.date);
                            const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                            
                            return (
                              <div 
                                key={quote.id}
                                className="glass card-shadow rounded-3xl p-4"
                              >
                                <div className="flex justify-between items-start mb-3">
                                  <div className="flex-1">
                                    <div className="font-bold text-lg text-gray-800">{quote.customer.name || 'æœªå‘½åå®¢æˆ¶'}</div>
                                    <div className="text-xs text-gray-500 mt-1">{timeStr} â€¢ {quote.customer.tier}</div>
                                    {quote.customer.phone && (
                                      <div className="text-xs text-gray-500 mt-1">ğŸ“ {quote.customer.phone}</div>
                                    )}
                                    {quote.customer.paymentMethod && (
                                      <div className="text-xs text-gray-500 mt-1">ğŸ’³ {quote.customer.paymentMethod}</div>
                                    )}
                                  </div>
                                  <div className="text-right">
                                    <div className="text-2xl font-bold text-purple-600">${quote.total.toLocaleString()}</div>
                                    <div className="text-xs text-gray-500 mt-1">{quote.products.length} é …ç”¢å“</div>
                                  </div>
                                </div>
                                
                                {/* ç”¢å“é è¦½ï¼ˆé¡¯ç¤ºå‰2é …ï¼‰*/}
                                {quote.products && quote.products.length > 0 && (
                                  <div className="bg-gray-50 rounded-xl p-3 mb-3 text-xs text-gray-600 space-y-1">
                                    {quote.products.slice(0, 2).map((p, i) => (
                                      <div key={i} className="flex justify-between">
                                        <span>{p.name}</span>
                                        <span className="font-bold">${(p.price * p.qty).toLocaleString()}</span>
                                      </div>
                                    ))}
                                    {quote.products.length > 2 && (
                                      <div className="text-center text-gray-400 pt-1">
                                        é‚„æœ‰ {quote.products.length - 2} é …...
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                <div className="flex gap-2">
                                  <button 
                                    onClick={() => {
                                      loadQuote(quote.id);
                                      setCurrentTab('quote');
                                    }}
                                    className="flex-1 bg-purple-500 text-white py-2.5 rounded-xl font-bold hover:bg-purple-600 transition-colors flex items-center justify-center gap-2"
                                  >
                                    <Icons.FileText className="w-4 h-4" />
                                    è¼‰å…¥ç·¨è¼¯
                                  </button>
                                  <button 
                                    onClick={() => {
                                      if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${quote.customer.name || 'æœªå‘½åå®¢æˆ¶'}ã€çš„å ±åƒ¹å—ï¼Ÿ`)) {
                                        deleteQuote(quote.id);
                                      }
                                    }}
                                    className="px-4 bg-red-100 text-red-600 py-2.5 rounded-xl font-bold hover:bg-red-200 transition-colors"
                                  >
                                    <Icons.Trash className="w-4 h-4" />
                                  </button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      };

      // ç™»å…¥é 
      if (page === 'login') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
            <div className="glass card-shadow-lg p-8 rounded-3xl w-full max-w-sm animate-slide-up">
              <div className="text-center mb-8">
                <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                  <Icons.Package className="icon-svg-lg text-white" />
                </div>
                <h1 className="text-3xl font-black text-gray-800">å…«æ–¹ç’°çƒ</h1>
                <p className="text-sm text-gray-500 mt-2">ERP å ±åƒ¹ç³»çµ± V14.0 ğŸ”</p>
              </div>
              
              <input 
                type="password" 
                placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
                className="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 text-center text-xl focus:border-purple-500 focus:outline-none transition-colors" 
                value={inputPwd} 
                onChange={e => setInputPwd(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && !loginLoading && handleLogin()}
                disabled={loginLoading}
              />
              
              <button 
                onClick={handleLogin} 
                disabled={loginLoading}
                className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all ${
                  loginLoading 
                    ? 'bg-gray-400 cursor-not-allowed' 
                    : 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white hover:shadow-xl hover:scale-[1.02]'
                }`}
              >
                {loginLoading ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥ç³»çµ±'}
              </button>
              
              <div className="mt-8 pt-6 border-t border-gray-200 text-center">
                <p className="text-xs text-gray-400 mb-2">ğŸ” ç³»çµ±å·²å•Ÿç”¨ Firebase å®‰å…¨é©—è­‰</p>
                <p className="text-xs text-gray-400">æ¸¬è©¦å¯†ç¢¼ï¼šAdmin(8888) / Sales(1688)</p>
              </div>
            </div>
          </div>
        );
      }

      // ç®¡ç†å“¡é  - V14.0 Tab å¼è¨­è¨ˆ
      if (page === 'admin') {
        // å–å¾—è¨­å®šé  Tabï¼ˆä¾è§’è‰²ï¼‰- ç§»é™¤å¸³æˆ¶ Tab
        const getSettingsTabs = () => {
          // Admin å’Œ Store æœ‰å®Œæ•´åŠŸèƒ½
          if (role === 'admin' || role === 'store') {
            return [
              { key: 'import', icon: 'ğŸ“¦', label: 'è³‡æ–™ç®¡ç†' },
              { key: 'crm', icon: 'ğŸ‘¥', label: 'å®¢æˆ¶ç®¡ç†' },
              { key: 'safety', icon: 'âš ï¸', label: 'åº«å­˜ç®¡ç†' },
              { key: 'publish', icon: 'ğŸ’°', label: 'æ”¹åƒ¹ç™¼å¸ƒ' },
            ];
          }
          // Sales åªçœ‹åˆ°è³‡æ–™ç®¡ç†ã€å®¢æˆ¶ç®¡ç†å’Œåº«å­˜ç®¡ç†
          return [
            { key: 'import', icon: 'ğŸ“¦', label: 'è³‡æ–™ç®¡ç†' },
            { key: 'crm', icon: 'ğŸ‘¥', label: 'å®¢æˆ¶ç®¡ç†' },
            { key: 'safety', icon: 'âš ï¸', label: 'åº«å­˜ç®¡ç†' },
          ];
        };
        
        // å–å¾—æ‰€æœ‰ç”¢å“åˆ—è¡¨ï¼ˆç”¨æ–¼æ”¹åƒ¹ï¼‰- å¾ Firebase è®€å–
        const getAllProducts = () => {
          const products = [];
          Object.entries(data.products).forEach(([name, specs]) => {
            if (Array.isArray(specs)) {
              specs.forEach(spec => {
                const stocks = data.inventory[spec.id] || [];
                const totalStock = stocks.reduce((s, x) => s + (x.stock || 0), 0);
                products.push({
                  ...spec,
                  name: name,
                  displayName: spec.name || name,
                  totalStock: totalStock
                });
              });
            }
          });
          return products;
        };
        
        // éæ¿¾æ”¹åƒ¹ç”¢å“
        const filteredPriceProducts = getAllProducts().filter(p => {
          if (!priceSearch) return true;
          const s = priceSearch.toLowerCase();
          return (
            (p.name && p.name.toLowerCase().includes(s)) ||
            (p.id && p.id.toLowerCase().includes(s)) ||
            (p.specDetail && p.specDetail.toLowerCase().includes(s))
          );
        });
        
        // æŒ‰åˆ†é¡éæ¿¾ï¼ˆç”¨æ–¼å°å…§ç™¼å¸ƒï¼‰
        // ğŸ†• V14.40 æ–°åˆ†é¡æ¶æ§‹ï¼šæ ¹æ“šå“è™Ÿé–‹é ­ + å“åé—œéµå­—
        const CATEGORY_CONFIG = {
          // ä¸»åˆ†é¡ï¼ˆæ ¹æ“šå“è™Ÿé–‹é ­ï¼‰
          'A': { name: 'è¦ä»', subs: ['502ç™½ä»', 'ç™½ä»æˆå“', 'ç„¡è†¨ç™¼è¦ä»PD', 'å–®å‡ç™½ä»æˆå“', 'ç”Ÿç•™å°¾è¦', 'å…¶å®ƒè¦ä»'] },
          'B': { name: 'å¸¶é ­è¦', subs: ['ç†Ÿç™½è¦', 'ç”Ÿç™½è¦', 'å»é ­ç™½è¦', 'ç†Ÿé³³å°¾æ³°è¦', 'å…¶å®ƒè¦é¡'] },
          'C': { name: 'é­šé¡', subs: ['é®­é­š', 'åœŸé­ é­š', 'å¤§æ¯”ç›®é­š', 'å°ç£é¯›é­š', 'é±¸é­š', 'è™±ç›®é­š', 'åˆä»”é­š', 'é¯–é­š', 'å…¶å®ƒé­šé¡'] },
          'D': { name: 'è»Ÿé«”é¡', subs: ['é­·é­š', 'å°å·', 'èˆ¹å‡é€æŠ½', 'è»Ÿçµ²', 'äºŒå»èŠ±æ'] },
          'E': { name: 'èŸ¹é¡', subs: [] },
          'F': { name: 'è²é¡', subs: [] },
          'G': { name: 'èª¿ç†é¡', subs: [] },
        };
        
        // å–å¾—ç”¢å“çš„ä¸»åˆ†é¡ï¼ˆæ ¹æ“šå“è™Ÿé–‹é ­ï¼‰
        const getMainCategory = (productId) => {
          if (!productId) return null;
          const firstChar = productId.charAt(0).toUpperCase();
          return CATEGORY_CONFIG[firstChar] ? firstChar : null;
        };
        
        // å–å¾—ç”¢å“çš„ç´°åˆ†é¡ï¼ˆæ ¹æ“šå“åé—œéµå­—ï¼‰
        const getSubCategory = (productId, productName) => {
          const mainCat = getMainCategory(productId);
          if (!mainCat) return 'å…¶å®ƒ';
          const name = (productName || '').toLowerCase();
          
          if (mainCat === 'A') { // è¦ä»
            if (name.includes('502')) return '502ç™½ä»';
            if (name.includes('å–®å‡') && name.includes('ç™½ä»')) return 'å–®å‡ç™½ä»æˆå“';
            if (name.includes('ç™½ä»') && name.includes('æˆå“')) return 'ç™½ä»æˆå“';
            if (name.includes('ç„¡è†¨ç™¼') || name.includes('pd')) return 'ç„¡è†¨ç™¼è¦ä»PD';
            if (name.includes('ç•™å°¾')) return 'ç”Ÿç•™å°¾è¦';
            return 'å…¶å®ƒè¦ä»';
          }
          
          if (mainCat === 'B') { // å¸¶é ­è¦
            if (name.includes('é³³å°¾') || name.includes('æ³°è¦')) return 'ç†Ÿé³³å°¾æ³°è¦';
            if (name.includes('å»é ­')) return 'å»é ­ç™½è¦';
            if (name.includes('ç†Ÿ') && name.includes('ç™½è¦')) return 'ç†Ÿç™½è¦';
            if (name.includes('ç”Ÿ') && name.includes('ç™½è¦')) return 'ç”Ÿç™½è¦';
            if (name.includes('ç™½è¦')) return 'ç”Ÿç™½è¦'; // é è¨­ç‚ºç”Ÿç™½è¦
            return 'å…¶å®ƒè¦é¡';
          }
          
          if (mainCat === 'C') { // é­šé¡
            if (name.includes('é®­')) return 'é®­é­š';
            if (name.includes('åœŸé­ ')) return 'åœŸé­ é­š';
            if (name.includes('æ¯”ç›®')) return 'å¤§æ¯”ç›®é­š';
            if (name.includes('é¯›')) return 'å°ç£é¯›é­š';
            if (name.includes('é±¸')) return 'é±¸é­š';
            if (name.includes('è™±ç›®')) return 'è™±ç›®é­š';
            if (name.includes('åˆä»”')) return 'åˆä»”é­š';
            if (name.includes('é¯–')) return 'é¯–é­š';
            return 'å…¶å®ƒé­šé¡';
          }
          
          if (mainCat === 'D') { // è»Ÿé«”é¡
            if (name.includes('é­·')) return 'é­·é­š';
            if (name.includes('å°å·')) return 'å°å·';
            if (name.includes('é€æŠ½')) return 'èˆ¹å‡é€æŠ½';
            if (name.includes('è»Ÿçµ²')) return 'è»Ÿçµ²';
            if (name.includes('èŠ±æ')) return 'äºŒå»èŠ±æ';
            return 'é­·é­š'; // é è¨­
          }
          
          return null; // E, F, G æš«ä¸ç´°åˆ†
        };
        
        const getProductsByCategory = () => {
          const products = getAllProducts();
          
          // ç‚ºæ¯å€‹ç”¢å“è¨ˆç®—æ¼²è·Œåƒ¹ï¼ˆä»¥ VIPåƒ¹ ç‚ºåŸºæº–ï¼‰
          const productsWithPriceChange = products.map(p => {
            // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜çš„ç·¨è¼¯åƒ¹æ ¼
            const editedPrice = editedPrices[p.id]?.['VIPåƒ¹'] ?? editedPrices[p.id]?.['VIP åƒ¹'];
            
            if (editedPrice !== undefined) {
              // æœ‰æš«å­˜ç·¨è¼¯ï¼šæ¯”è¼ƒç·¨è¼¯åƒ¹æ ¼å’ŒåŸå§‹åƒ¹æ ¼
              const originalPrice = p.prices?.['VIPåƒ¹'] || p.prices?.['VIP åƒ¹'] || 0;
              let priceChange = 0;
              if (editedPrice > originalPrice) priceChange = 1;
              if (editedPrice < originalPrice) priceChange = -1;
              return { ...p, priceChange };
            } else {
              // æ²’æœ‰æš«å­˜ç·¨è¼¯ï¼šä½¿ç”¨ç”¢å“è³‡æ–™ä¸­å·²ä¿å­˜çš„ priceChangeï¼ˆå¾ Firebaseï¼‰
              return { ...p, priceChange: p.priceChange || 0 };
            }
          });
          
          if (publishCategory === 'all') return productsWithPriceChange;
          
          // è§£æé¸æ“‡çš„åˆ†é¡
          const [mainCat, subCat] = publishCategory.split(':');
          
          return productsWithPriceChange.filter(p => {
            const pMainCat = getMainCategory(p.id);
            if (!pMainCat) return false;
            
            // ä¸»åˆ†é¡éæ¿¾
            if (pMainCat !== mainCat) return false;
            
            // å¦‚æœæ²’æœ‰é¸æ“‡ç´°åˆ†é¡ï¼Œé¡¯ç¤ºè©²ä¸»åˆ†é¡æ‰€æœ‰ç”¢å“
            if (!subCat) return true;
            
            // ç´°åˆ†é¡éæ¿¾
            const pSubCat = getSubCategory(p.id, p.displayName || p.name);
            return pSubCat === subCat;
          });
        };
        
        // å°‡ç”¢å“æŒ‰å“å+åŒ…è£è¦æ ¼åˆ†çµ„
        const getGroupedProducts = () => {
          const products = getProductsByCategory();
          const groups = {};
          
          products.forEach(p => {
            // ç›´æ¥ä½¿ç”¨å“åä½œç‚ºåˆ†çµ„ä¾æ“š
            const brandName = (p.displayName || p.name || 'æœªå‘½å').trim();
            
            if (!groups[brandName]) {
              groups[brandName] = {
                brandName: brandName,
                items: []
              };
            }
            
            groups[brandName].items.push(p);
          });
          
          // è½‰ç‚ºé™£åˆ—ä¸¦æŒ‰å“åæ’åº
          return Object.values(groups).sort((a, b) => a.brandName.localeCompare(b.brandName, 'zh-TW'));
        };
        
        // åƒ¹æ ¼ç­‰ç´šé †åºï¼šç”±ä½åˆ°é«˜ï¼ˆå¯ç·¨è¼¯çš„åœ¨ä¸Šé¢ï¼‰
        const priceTiersOrder = [
          { key: 'æ¥­å‹™åº•åƒ¹', editable: true },
          { key: 'VIPåƒ¹', editable: true },
          { key: 'æ•´ä»¶åƒ¹', editable: true },
          { key: 'ç”Ÿæ„åƒ¹', editable: true },
          { key: 'é¤å»³90%', editable: false },
          { key: 'æœƒå“¡95%', editable: false },
          { key: 'é–€å¸‚å”®åƒ¹', editable: false },
          { key: 'èŠ±æ±åƒ¹', editable: true },
        ];
        
        // ä¸»åˆ†é¡åˆ—è¡¨
        const mainCategories = [
          { key: 'all', label: 'å…¨éƒ¨ç”¢å“', icon: 'ğŸ“¦' },
          { key: 'A', label: 'è¦ä»', icon: 'ğŸ¦' },
          { key: 'B', label: 'å¸¶é ­è¦', icon: 'ğŸ¦' },
          { key: 'C', label: 'é­šé¡', icon: 'ğŸŸ' },
          { key: 'D', label: 'è»Ÿé«”é¡', icon: 'ğŸ¦‘' },
          { key: 'E', label: 'èŸ¹é¡', icon: 'ğŸ¦€' },
          { key: 'F', label: 'è²é¡', icon: 'ğŸš' },
          { key: 'G', label: 'èª¿ç†é¡', icon: 'ğŸ³' },
        ];
        
        // å–å¾—ç•¶å‰é¸æ“‡çš„ä¸»åˆ†é¡
        const getCurrentMainCat = () => {
          if (publishCategory === 'all') return 'all';
          return publishCategory.split(':')[0];
        };
        
        // å–å¾—ç•¶å‰é¸æ“‡çš„ç´°åˆ†é¡
        const getCurrentSubCat = () => {
          if (publishCategory === 'all' || !publishCategory.includes(':')) return null;
          return publishCategory.split(':')[1];
        };
        
        // å–å¾—åˆ†é¡çš„é¡¯ç¤ºåç¨±
        const getCategoryDisplayName = () => {
          if (publishCategory === 'all') return 'å…¨éƒ¨ç”¢å“';
          const mainCat = getCurrentMainCat();
          const subCat = getCurrentSubCat();
          const mainName = CATEGORY_CONFIG[mainCat]?.name || mainCat;
          if (subCat) return mainName + '-' + subCat;
          return mainName;
        };
        
        const tabBtnStyle = (active) => `py-3 px-5 rounded-xl text-l4 font-bold transition-all ${active ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg' : 'bg-white text-gray-600 hover:bg-gray-100'}`;
        const subTabStyle = (active) => `py-2 px-3 rounded-lg text-sm font-medium transition-all ${active ? 'bg-purple-100 text-purple-700 border border-purple-300' : 'text-gray-500 hover:bg-gray-50 border border-transparent'}`;
        
        // é–‹å•Ÿåƒ¹æ ¼ç·¨è¼¯å½ˆçª—
        const openPriceEditor = (product, index) => {
          setEditingProduct({ ...product, _index: index });
          setEditingPrices({ ...(product.prices || {}) });
          setEditingStatus({
            isNew: product.isNew || productStatusEdits[product.id]?.isNew || false,
            isPromo: product.isPromo || productStatusEdits[product.id]?.isPromo || false
          });
          setEditingRemark(productRemarks[product.id] || product.remark || '');
        };
        
        // é–‹å•Ÿåˆ†çµ„ç·¨è¼¯å½ˆçª—
        const openGroupEditor = (group, groupIndex) => {
          // åˆå§‹åŒ–åˆ†çµ„ç·¨è¼¯è³‡æ–™
          const editData = {};
          group.items.forEach(item => {
            editData[item.id] = {
              prices: { ...(editedPrices[item.id] || item.prices || {}) },
              status: {
                isNew: item.isNew || productStatusEdits[item.id]?.isNew || false,
                isPromo: item.isPromo || productStatusEdits[item.id]?.isPromo || false
              },
              remark: productRemarks[item.id] || item.remark || ''
            };
          });
          setGroupEditData(editData);
          setEditingGroup({ ...group, _index: groupIndex });
        };
        
        const closeGroupEditor = () => {
          setEditingGroup(null);
          setGroupEditData({});
        };
        
        // å„²å­˜åˆ†çµ„ç·¨è¼¯
        const saveGroupEdit = () => {
          if (!editingGroup) return;
          
          // æ‰¹æ¬¡å„²å­˜æ‰€æœ‰ç”¢å“çš„ä¿®æ”¹
          const newPrices = { ...editedPrices };
          const newStatus = { ...productStatusEdits };
          const newRemarks = { ...productRemarks };
          
          Object.entries(groupEditData).forEach(([productId, data]) => {
            newPrices[productId] = data.prices;
            newStatus[productId] = data.status;
            newRemarks[productId] = data.remark;
          });
          
          setEditedPrices(newPrices);
          setProductStatusEdits(newStatus);
          setProductRemarks(newRemarks);
          
          // é¡¯ç¤ºå·²å„²å­˜æç¤º
          const btn = document.getElementById('saveGroupBtn');
          if (btn) {
            btn.innerText = 'âœ“ å·²æš«å­˜';
            setTimeout(() => closeGroupEditor(), 300);
          } else {
            closeGroupEditor();
          }
        };
        
        const closePriceEditor = () => {
          setEditingProduct(null);
          setEditingPrices({});
          setEditingStatus({ isNew: false, isPromo: false });
          setEditingRemark('');
        };
        
        // å„²å­˜ä¸¦åˆ‡æ›åˆ°æŒ‡å®šç”¢å“
        const saveAndGoToProduct = (nextIndex) => {
          if (!editingProduct) return;
          
          // å…ˆå„²å­˜ç•¶å‰ä¿®æ”¹
          setEditedPrices(prev => ({
            ...prev,
            [editingProduct.id]: editingPrices
          }));
          setProductStatusEdits(prev => ({
            ...prev,
            [editingProduct.id]: editingStatus
          }));
          
          // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹ç”¢å“
          const products = filteredPriceProducts;
          if (nextIndex >= 0 && nextIndex < products.length) {
            const nextProduct = products[nextIndex];
            setEditingProduct({ ...nextProduct, _index: nextIndex });
            setEditingPrices({ ...(nextProduct.prices || {}) });
            setEditingStatus({
              isNew: nextProduct.isNew || productStatusEdits[nextProduct.id]?.isNew || false,
              isPromo: nextProduct.isPromo || productStatusEdits[nextProduct.id]?.isPromo || false
            });
          }
        };
        
        const savePriceEdit = () => {
          if (!editingProduct) return;
          
          // å„²å­˜åˆ°ç·¨è¼¯ç‹€æ…‹
          setEditedPrices(prev => ({
            ...prev,
            [editingProduct.id]: editingPrices
          }));
          setProductStatusEdits(prev => ({
            ...prev,
            [editingProduct.id]: editingStatus
          }));
          // å„²å­˜å‚™è¨»
          setProductRemarks(prev => ({
            ...prev,
            [editingProduct.id]: editingRemark
          }));
          
          // é¡¯ç¤ºå·²å„²å­˜æç¤º
          const btn = document.getElementById('savePriceBtn');
          if (btn) {
            btn.innerText = 'âœ“ å·²æš«å­˜';
            btn.classList.add('bg-purple-500');
            setTimeout(() => {
              closePriceEditor();
            }, 300);
          } else {
            closePriceEditor();
          }
        };
        
        // ä¿å­˜ä¸¦å°èˆªåˆ°ä¸‹ä¸€å€‹ç”¢å“ï¼ˆä¸é—œé–‰å½ˆçª—ï¼‰
        const saveAndNavigate = (direction) => {
          if (!editingProduct) return;
          
          // å„²å­˜ç•¶å‰ç·¨è¼¯
          setEditedPrices(prev => ({
            ...prev,
            [editingProduct.id]: editingPrices
          }));
          setProductStatusEdits(prev => ({
            ...prev,
            [editingProduct.id]: editingStatus
          }));
          setProductRemarks(prev => ({
            ...prev,
            [editingProduct.id]: editingRemark
          }));
          
          // å–å¾—ç•¶å‰åˆ†é¡çš„ç”¢å“åˆ—è¡¨
          const products = getProductsByCategory();
          const currentIdx = products.findIndex(p => p.id === editingProduct.id);
          const newIdx = currentIdx + direction;
          
          if (newIdx >= 0 && newIdx < products.length) {
            const nextProduct = products[newIdx];
            // ç›´æ¥é–‹å•Ÿä¸‹ä¸€å€‹ç”¢å“çš„ç·¨è¼¯å™¨
            openPriceEditor(nextProduct, newIdx);
          }
        };
        
        return (
          <>
          <div className="min-h-screen bg-gray-50">
            {/* é ‚éƒ¨å°èˆªï¼ˆå« Tabï¼‰ */}
            <div className="glass px-4 py-3 border-b border-white/30 sticky top-0 z-20 card-shadow">
              {/* é›»è…¦ç‰ˆï¼šå–®è¡Œé¡¯ç¤º */}
              <div className="hidden md:flex items-center justify-between gap-4">
                {/* å·¦å´ï¼šæ¨™é¡Œ */}
                <div className="flex-shrink-0">
                  <h1 className="text-l1">{role === 'admin' ? 'ç®¡ç†å“¡è¨­å®š' : role === 'store' ? 'é–€å¸‚è¨­å®š' : 'è¨­å®š'}</h1>
                  <span className={`text-l6 ${status.includes('å·²é€£ç·š')?'text-green-600':''}`}>{status}</span>
                </div>
                
                {/* ä¸­é–“ï¼šTab å°èˆª */}
                <div className="flex-1 flex justify-center">
                  <div className="flex gap-2 overflow-x-auto hide-scrollbar">
                    {getSettingsTabs().map(tab => (
                      <button
                        key={tab.key}
                        onClick={() => setSettingsTab(tab.key)}
                        className={`px-4 py-2 rounded-xl font-bold text-base whitespace-nowrap transition-all ${
                          settingsTab === tab.key 
                            ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg' 
                            : 'bg-white/50 text-gray-600 hover:bg-white/80'
                        }`}
                      >
                        {tab.icon} {tab.label}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* å³å´ï¼šè¿”å›æŒ‰éˆ• */}
                <button onClick={() => { setPage('main'); setCurrentTab('quote'); }} className="flex-shrink-0 bg-purple-500 text-white px-5 py-2.5 rounded-xl font-bold text-base flex items-center gap-2">
                  <Icons.ArrowLeft className="w-5 h-5" />
                  è¿”å›å ±åƒ¹
                </button>
              </div>
              
              {/* æ‰‹æ©Ÿç‰ˆï¼šå…©è¡Œé¡¯ç¤º */}
              <div className="md:hidden">
                {/* ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œ + è¿”å›æŒ‰éˆ• */}
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <h1 className="text-lg font-bold">{role === 'admin' ? 'ç®¡ç†å“¡è¨­å®š' : role === 'store' ? 'é–€å¸‚è¨­å®š' : 'è¨­å®š'}</h1>
                    <span className={`text-xs ${status.includes('å·²é€£ç·š')?'text-green-600':''}`}>{status}</span>
                  </div>
                  <button onClick={() => { setPage('main'); setCurrentTab('quote'); }} className="bg-purple-500 text-white px-3 py-2 rounded-xl font-bold text-sm flex items-center gap-1">
                    <Icons.ArrowLeft className="w-4 h-4" />
                    è¿”å›
                  </button>
                </div>
                
                {/* ç¬¬äºŒè¡Œï¼šTab å°èˆªï¼ˆå¯æ»¾å‹•ï¼‰ */}
                <div className="flex gap-2 overflow-x-auto pb-1 -mx-4 px-4" style={{scrollbarWidth: 'none', msOverflowStyle: 'none', WebkitOverflowScrolling: 'touch'}}>
                  {getSettingsTabs().map(tab => (
                    <button
                      key={tab.key}
                      onClick={() => setSettingsTab(tab.key)}
                      className={`px-3 py-1.5 rounded-lg font-bold text-sm whitespace-nowrap transition-all flex-shrink-0 ${
                        settingsTab === tab.key 
                          ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-md' 
                          : 'bg-white/70 text-gray-600'
                      }`}
                    >
                      {tab.icon} {tab.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className={`p-4 pb-8 ${settingsTab === 'publish' ? 'px-6' : 'max-w-4xl mx-auto'}`}>
              
              {/* ==================== åŒ¯å…¥ Tab ==================== */}
              {settingsTab === 'import' && (
                <div className="animate-slide-up space-y-4">
                  {/* ç¬¬ä¸€è¡Œï¼šä¸Šå‚³å€ + åŒæ­¥ç‹€æ…‹ */}
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    {/* ä¸Šå‚³åº«å­˜è¡¨ */}
                    <label className="glass card-shadow p-5 rounded-2xl cursor-pointer hover:shadow-lg transition-all group">
                      <div className="flex items-center gap-4">
                        <div className="w-14 h-14 rounded-xl bg-purple-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">
                          ğŸ“¦
                        </div>
                        <div className="flex-1">
                          <div className="font-bold text-lg text-purple-700">ä¸Šå‚³åº«å­˜è¡¨</div>
                          <div className="text-sm text-gray-500">XLSX / XLS / CSV</div>
                          <div className="text-xs text-purple-500 mt-1">
                            {data.meta?.stockDate 
                              ? `ğŸ“… ${data.meta.stockDate} (${Object.keys(data.inventory || {}).length} å“é …)` 
                              : 'â³ å°šæœªåŒ¯å…¥'}
                          </div>
                        </div>
                      </div>
                      <input type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={e => handleUpload(e, 'stock')} />
                    </label>
                    
                    {/* ä¸Šå‚³å ±åƒ¹è¡¨ */}
                    <label className="glass card-shadow p-5 rounded-2xl cursor-pointer hover:shadow-lg transition-all group">
                      <div className="flex items-center gap-4">
                        <div className="w-14 h-14 rounded-xl bg-green-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">
                          ğŸ’µ
                        </div>
                        <div className="flex-1">
                          <div className="font-bold text-lg text-green-700">ä¸Šå‚³å ±åƒ¹è¡¨</div>
                          <div className="text-sm text-gray-500">XLSX / XLS / CSV</div>
                          <div className="text-xs text-green-500 mt-1">
                            {data.meta?.quoteDate 
                              ? `ğŸ“… ${data.meta.quoteDate} (${Object.keys(data.products || {}).length} é¡)` 
                              : 'â³ å°šæœªåŒ¯å…¥'}
                          </div>
                        </div>
                      </div>
                      <input type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={e => handleUpload(e, 'quote')} />
                    </label>
                    
                    {/* ğŸ†• ä¸Šå‚³å®¢æˆ¶è³‡æ–™ */}
                    <label className="glass card-shadow p-5 rounded-2xl cursor-pointer hover:shadow-lg transition-all group">
                      <div className="flex items-center gap-4">
                        <div className="w-14 h-14 rounded-xl bg-cyan-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">
                          ğŸ‘¥
                        </div>
                        <div className="flex-1">
                          <div className="font-bold text-lg text-cyan-700">ä¸Šå‚³å®¢æˆ¶ä¸»æª”</div>
                          <div className="text-sm text-gray-500">XLSX / XLS / JSON</div>
                          <div className="text-xs text-cyan-500 mt-1">
                            {data.meta?.customerDate 
                              ? `ğŸ“… ${data.meta.customerDate} (${Object.keys(customerDB).length} ä½)` 
                              : 'â³ å°šæœªåŒ¯å…¥'}
                          </div>
                        </div>
                      </div>
                      <input type="file" className="hidden" accept=".xlsx,.xls,.json" onChange={handleCustomerUpload} />
                    </label>
                    
                    {/* ğŸ†• ä¸Šå‚³éŠ·è²¨æ˜ç´°ï¼ˆæ›´æ–°å®¢æˆ¶äº¤æ˜“çµ±è¨ˆï¼‰ */}
                    <label className="glass card-shadow p-5 rounded-2xl cursor-pointer hover:shadow-lg transition-all group">
                      <div className="flex items-center gap-4">
                        <div className="w-14 h-14 rounded-xl bg-orange-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">
                          ğŸ“Š
                        </div>
                        <div className="flex-1">
                          <div className="font-bold text-lg text-orange-700">ä¸Šå‚³éŠ·è²¨æ˜ç´°</div>
                          <div className="text-sm text-gray-500">æ›´æ–°å®¢æˆ¶äº¤æ˜“çµ±è¨ˆ</div>
                          <div className="text-xs text-orange-500 mt-1">
                            {data.meta?.salesDate 
                              ? `ğŸ“… ${data.meta.salesDate}` 
                              : 'â³ å°šæœªåŒ¯å…¥'}
                          </div>
                        </div>
                      </div>
                      <input type="file" className="hidden" accept=".xlsx,.xls" onChange={handleSalesUpload} />
                    </label>
                    
                    {/* ğŸ†• ä¸Šå‚³å¸³é½¡åˆ†æè¡¨ï¼ˆæ‡‰æ”¶å¸³æ¬¾/ä¿¡ç”¨ç®¡ç†ï¼‰ */}
                    <label className="glass card-shadow p-5 rounded-2xl cursor-pointer hover:shadow-lg transition-all group">
                      <div className="flex items-center gap-4">
                        <div className="w-14 h-14 rounded-xl bg-red-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">
                          ğŸ’°
                        </div>
                        <div className="flex-1">
                          <div className="font-bold text-lg text-red-700">ä¸Šå‚³å¸³é½¡åˆ†æè¡¨</div>
                          <div className="text-sm text-gray-500">æ‡‰æ”¶å¸³æ¬¾/ä¿¡ç”¨ç®¡ç†</div>
                          <div className="text-xs text-red-500 mt-1">
                            {data.meta?.arDate 
                              ? `ğŸ“… ${data.meta.arDate}${data.meta.totalAR ? ` ($${(data.meta.totalAR/10000).toFixed(0)}è¬)` : ''}` 
                              : 'â³ å°šæœªåŒ¯å…¥'}
                          </div>
                        </div>
                      </div>
                      <input type="file" className="hidden" accept=".xlsx,.xls" onChange={handleARUpload} />
                    </label>
                    
                    {/* åŒæ­¥ç‹€æ…‹å¡ç‰‡ */}
                    {(() => {
                      const logs = data.syncLogs || [];
                      const lastLog = logs.length > 0 ? logs[logs.length - 1] : null;
                      const lastSyncTime = lastLog ? new Date(lastLog.timestamp) : null;
                      const now = new Date();
                      const hoursSinceSync = lastSyncTime ? Math.floor((now - lastSyncTime) / (1000 * 60 * 60)) : null;
                      const isHealthy = hoursSinceSync !== null && hoursSinceSync < 2;
                      const isWarning = hoursSinceSync !== null && hoursSinceSync >= 2 && hoursSinceSync < 24;
                      
                      return (
                        <div className={`glass card-shadow p-5 rounded-2xl border-2 ${
                          isHealthy ? 'border-green-300 bg-green-50/50' :
                          isWarning ? 'border-yellow-300 bg-yellow-50/50' :
                          'border-gray-200'
                        }`}>
                          <div className="flex items-center gap-4">
                            <div className={`w-14 h-14 rounded-xl flex items-center justify-center text-3xl ${
                              isHealthy ? 'bg-green-100' : isWarning ? 'bg-yellow-100' : 'bg-gray-100'
                            }`}>
                              {isHealthy ? 'âœ…' : isWarning ? 'âš ï¸' : 'ğŸ”„'}
                            </div>
                            <div className="flex-1">
                              <div className={`font-bold text-lg ${
                                isHealthy ? 'text-green-700' : isWarning ? 'text-yellow-700' : 'text-gray-700'
                              }`}>
                                {isHealthy ? 'åŒæ­¥æ­£å¸¸' : isWarning ? 'åŒæ­¥å»¶é²' : 'è‡ªå‹•åŒæ­¥'}
                              </div>
                              <div className="text-sm text-gray-500">
                                {lastSyncTime 
                                  ? `${hoursSinceSync < 1 ? 'å‰›å‰›' : hoursSinceSync + ' å°æ™‚å‰'}åŒæ­¥`
                                  : 'å°šç„¡åŒæ­¥è¨˜éŒ„'
                                }
                              </div>
                              {lastLog && (
                                <div className="text-xs text-gray-400 mt-1">
                                  {lastSyncTime.toLocaleString('zh-TW')}
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* ç¬¬äºŒè¡Œï¼šè³‡æ–™çµ±è¨ˆ + åŒæ­¥è¨˜éŒ„ */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {/* å·¦å´ï¼šè³‡æ–™çµ±è¨ˆ + èªªæ˜ */}
                    <div className="space-y-4">
                      {/* è³‡æ–™çµ±è¨ˆ */}
                      <div className="glass card-shadow p-5 rounded-2xl">
                        <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                          ğŸ“Š è³‡æ–™çµ±è¨ˆ
                        </h3>
                        <div className="grid grid-cols-5 gap-3">
                          <div className="bg-purple-50 p-3 rounded-xl text-center">
                            <div className="text-2xl font-bold text-purple-600">{Object.keys(data.inventory || {}).length}</div>
                            <div className="text-xs text-purple-700">åº«å­˜å“é …</div>
                          </div>
                          <div className="bg-green-50 p-3 rounded-xl text-center">
                            <div className="text-2xl font-bold text-green-600">{Object.keys(data.products || {}).length}</div>
                            <div className="text-xs text-green-700">ç”¢å“å“å</div>
                          </div>
                          <div className="bg-cyan-50 p-3 rounded-xl text-center">
                            <div className="text-2xl font-bold text-cyan-600">{Object.keys(customerDB || {}).length}</div>
                            <div className="text-xs text-cyan-700">CRMå®¢æˆ¶</div>
                          </div>
                          <div className="bg-blue-50 p-3 rounded-xl text-center">
                            <div className="text-2xl font-bold text-blue-600">
                              {(data.syncLogs || []).filter(l => {
                                const d = new Date(l.timestamp);
                                const now = new Date();
                                return d.toDateString() === now.toDateString();
                              }).length}
                            </div>
                            <div className="text-xs text-blue-700">ä»Šæ—¥åŒæ­¥</div>
                          </div>
                          <div className="bg-gray-50 p-3 rounded-xl text-center">
                            <div className="text-2xl font-bold text-gray-600">
                              {Object.keys(data.discontinuedProducts || {}).length}
                            </div>
                            <div className="text-xs text-gray-600">åœå”®å“é …</div>
                          </div>
                        </div>
                      </div>
                      
                      {/* æª”æ¡ˆæ ¼å¼èªªæ˜ */}
                      <div className="glass card-shadow p-5 rounded-2xl">
                        <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                          ğŸ“‹ æª”æ¡ˆæ ¼å¼è¦æ±‚
                        </h3>
                        <div className="space-y-2 text-sm">
                          <div className="flex items-start gap-2">
                            <span className="text-purple-500 font-bold">åº«å­˜è¡¨ï¼š</span>
                            <span className="text-gray-600">å“è™Ÿã€å“åã€è¦æ ¼ã€åº«åˆ¥ã€åº«å­˜æ•¸é‡</span>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-green-500 font-bold">å ±åƒ¹è¡¨ï¼š</span>
                            <span className="text-gray-600">å“è™Ÿã€å“åã€è¦æ ¼ã€å„åƒ¹æ ¼ç­‰ç´š</span>
                          </div>
                        </div>
                        <div className="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400 text-center">
                          ç³»çµ±ç‰ˆæœ¬ï¼šV17.2 (åˆä½µæ¨¡å¼+åƒ¹æ ¼ä¿®æ­£)
                        </div>
                      </div>
                    </div>
                    
                    {/* å³å´ï¼šåŒæ­¥è¨˜éŒ„ */}
                    <div className="glass card-shadow p-5 rounded-2xl">
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="font-bold text-gray-700 flex items-center gap-2">
                          ğŸ”„ åŒæ­¥è¨˜éŒ„
                        </h3>
                        {(role === 'admin' || role === 'store') && (data.syncLogs || []).length > 0 && (
                          <button 
                            onClick={() => {
                              if (window.confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åŒæ­¥æ—¥èªŒå—ï¼Ÿ')) {
                                const { ref, update } = window.firebaseModules;
                                update(ref(db, 'seafoodData'), { syncLogs: [] })
                                  .then(() => alert('âœ… åŒæ­¥æ—¥èªŒå·²æ¸…é™¤'))
                                  .catch(e => alert('âŒ æ¸…é™¤å¤±æ•—ï¼š' + e.message));
                              }
                            }}
                            className="text-xs text-gray-400 hover:text-red-500 transition-colors"
                          >
                            æ¸…é™¤è¨˜éŒ„
                          </button>
                        )}
                      </div>
                      
                      <div className="space-y-2 max-h-64 overflow-y-auto">
                        {(data.syncLogs || []).length === 0 ? (
                          <div className="text-center py-8 text-gray-400">
                            <div className="text-3xl mb-2">ğŸ“­</div>
                            <p className="text-sm">å°šç„¡åŒæ­¥è¨˜éŒ„</p>
                          </div>
                        ) : (
                          [...(data.syncLogs || [])].reverse().slice(0, 10).map((log, idx) => {
                            // æ ¹æ“šä¾†æºé¡¯ç¤ºä¸åŒçš„æ¨™ç±¤
                            const sourceLabels = {
                              'auto': { icon: 'ğŸ”„', label: 'è‡ªå‹•åŒæ­¥' },
                              'manual': { icon: 'ğŸ“¦', label: 'åº«å­˜è¡¨' },
                              'å®¢æˆ¶ä¸»æª”': { icon: 'ğŸ‘¥', label: 'å®¢æˆ¶ä¸»æª”' },
                              'éŠ·è²¨æ˜ç´°': { icon: 'ğŸ“Š', label: 'éŠ·è²¨æ˜ç´°' },
                              'å¸³é½¡åˆ†æè¡¨': { icon: 'ğŸ’°', label: 'å¸³é½¡åˆ†æè¡¨' },
                              'quote': { icon: 'ğŸ“‹', label: 'å ±åƒ¹å–®' },
                            };
                            const sourceInfo = sourceLabels[log.source] || { icon: 'ğŸ“„', label: log.source || 'æ‰‹å‹•ä¸Šå‚³' };
                            
                            return (
                              <div 
                                key={idx}
                                className={`p-3 rounded-lg border flex items-center justify-between ${
                                  log.status === 'success' 
                                    ? 'bg-green-50 border-green-100' 
                                    : 'bg-red-50 border-red-100'
                                }`}
                              >
                                <div className="flex items-center gap-2">
                                  <span className="text-lg">
                                    {log.status === 'success' ? 'âœ…' : 'âŒ'}
                                  </span>
                                  <div>
                                    <p className="font-medium text-sm text-gray-700">
                                      {sourceInfo.icon} {sourceInfo.label}
                                      {log.status === 'success' && ` Â· ${log.itemCount || 0} ${log.source === 'å®¢æˆ¶ä¸»æª”' || log.source === 'å¸³é½¡åˆ†æè¡¨' ? 'å®¢æˆ¶' : 'ç­†'}`}
                                    </p>
                                    <p className="text-xs text-gray-400">
                                      {new Date(log.timestamp).toLocaleString('zh-TW')}
                                      {log.filename && ` Â· ${log.filename}`}
                                    </p>
                                  </div>
                                </div>
                                {log.status !== 'success' && (
                                  <span className="text-xs text-red-500 max-w-[100px] truncate">
                                    {log.error || 'éŒ¯èª¤'}
                                  </span>
                                )}
                              </div>
                            );
                          })
                        )}
                      </div>
                      
                      {(data.syncLogs || []).length > 10 && (
                        <div className="text-center mt-3 pt-3 border-t border-gray-100">
                          <span className="text-xs text-gray-400">
                            é¡¯ç¤ºæœ€è¿‘ 10 ç­†ï¼Œå…± {(data.syncLogs || []).length} ç­†è¨˜éŒ„
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* ==================== å®¢æˆ¶ç®¡ç† CRM Tab ==================== */}
              {settingsTab === 'crm' && (() => {
                // è¨ˆç®—è£œè²¨ç‹€æ…‹ï¼ˆæå‰å®šç¾©ï¼‰
                const getReplenishStatus = (customer) => {
                  if (!customer.avgCycle || !customer.lastOrder) return null;
                  const days = Math.floor((new Date() - new Date(customer.lastOrder)) / (1000 * 60 * 60 * 24));
                  const ratio = days / customer.avgCycle;
                  
                  if (ratio >= 1.2) return { status: 'overdue', label: 'ğŸ”´ é€¾æœŸæœªè£œ', priority: 3, days, cycle: customer.avgCycle };
                  if (ratio >= 1.0) return { status: 'due', label: 'ğŸŸ  è©²è£œè²¨äº†', priority: 2, days, cycle: customer.avgCycle };
                  if (ratio >= 0.8) return { status: 'soon', label: 'ğŸŸ¡ å³å°‡è£œè²¨', priority: 1, days, cycle: customer.avgCycle };
                  return { status: 'normal', label: 'ğŸŸ¢ æ­£å¸¸', priority: 0, days, cycle: customer.avgCycle };
                };
                
                // å®¢æˆ¶åˆ—è¡¨ï¼ˆæ ¹æ“šç¯©é¸å’Œæ’åºï¼‰
                const customerList = (() => {
                  let list = Object.entries(customerDB).map(([key, val]) => ({
                    ...val,
                    _key: key,
                    replenish: getReplenishStatus(val)  // é å…ˆè¨ˆç®—è£œè²¨ç‹€æ…‹
                  }));
                  
                  // æœå°‹ç¯©é¸
                  if (crmSearch) {
                    const s = crmSearch.toLowerCase();
                    list = list.filter(c => 
                      c.name?.toLowerCase().includes(s) ||
                      c.fullName?.toLowerCase().includes(s) ||
                      c.tel1?.includes(s) ||
                      c.address?.toLowerCase().includes(s)
                    );
                  }
                  
                  // ç‹€æ…‹ç¯©é¸
                  if (crmFilter !== 'all') {
                    if (['A', 'B', 'C', 'D'].includes(crmFilter)) {
                      list = list.filter(c => c.grade === crmFilter);
                    } else if (crmFilter === 'warning') {
                      // ğŸŸ¡ å¸³æ¬¾æ³¨æ„ï¼š35å¤©+ï¼Œä¸”æœ‰å¸³æ¬¾é¤˜é¡
                      list = list.filter(c => c.arStatus === 'warning' && c.arBalance > 0);
                    } else if (crmFilter === 'danger') {
                      // ğŸ”´ å¸³æ¬¾å±éšªï¼š50å¤©+ï¼Œä¸”æœ‰å¸³æ¬¾é¤˜é¡
                      list = list.filter(c => c.arStatus === 'danger' && c.arBalance > 0);
                    } else if (crmFilter === 'overdue') {
                      list = list.filter(c => c.replenish?.status === 'overdue');
                    } else if (crmFilter === 'due') {
                      list = list.filter(c => c.replenish?.status === 'due');
                    } else if (crmFilter === 'soon') {
                      list = list.filter(c => c.replenish?.status === 'soon');
                    } else if (crmFilter === 'needCall') {
                      list = list.filter(c => c.replenish && c.replenish.priority >= 1);
                    } else if (crmFilter === 'creditOver') {
                      list = list.filter(c => c.creditUsage > 90);
                    } else if (crmFilter === 'hasAR') {
                      list = list.filter(c => c.arBalance > 0);
                    }
                  }
                  
                  // æ¥­å‹™å“¡éæ¿¾
                  if (crmSalesRep) {
                    list = list.filter(c => c.salesRep === crmSalesRep);
                  }
                  
                  // æ’åº
                  if (crmSort === 'amount') {
                    list.sort((a, b) => (b.totalAmount || 0) - (a.totalAmount || 0));
                  } else if (crmSort === 'overdue') {
                    // é€¾æœŸé‡‘é¡æ’åºï¼ˆé«˜åˆ°ä½ï¼‰
                    list.sort((a, b) => (b.arOverdue || 0) - (a.arOverdue || 0));
                  } else if (crmSort === 'name') {
                    list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                  } else if (crmSort === 'lastOrder') {
                    list.sort((a, b) => (b.lastOrder || '').localeCompare(a.lastOrder || ''));
                  } else if (crmSort === 'replenish') {
                    // è£œè²¨å„ªå…ˆé †åºæ’åº
                    list.sort((a, b) => {
                      const pa = a.replenish?.priority || 0;
                      const pb = b.replenish?.priority || 0;
                      if (pb !== pa) return pb - pa;
                      return (b.totalAmount || 0) - (a.totalAmount || 0);
                    });
                  }
                  
                  return list;
                })();
                // ä»Šæ—¥å¿…æ’¥æ¸…å–®ï¼ˆé€¾æœŸ + è©²è£œè²¨ + å³å°‡è£œè²¨çš„é«˜åƒ¹å€¼å®¢æˆ¶ï¼‰
                const todayCallList = (() => {
                  return Object.entries(customerDB)
                    .map(([key, c]) => ({ ...c, _key: key, replenish: getReplenishStatus(c) }))
                    .filter(c => c.replenish && c.replenish.priority >= 1)  // å³å°‡è£œè²¨ä»¥ä¸Š
                    .sort((a, b) => {
                      // å…ˆæŒ‰å„ªå…ˆé †åºï¼Œå†æŒ‰é‡‘é¡
                      if (b.replenish.priority !== a.replenish.priority) {
                        return b.replenish.priority - a.replenish.priority;
                      }
                      return (b.totalAmount || 0) - (a.totalAmount || 0);
                    });
                })();
                
                // çµ±è¨ˆ
                const stats = (() => {
                  const all = Object.entries(customerDB).map(([key, c]) => ({ ...c, _key: key, replenish: getReplenishStatus(c) }));
                  return {
                    total: all.length,
                    gradeA: all.filter(c => c.grade === 'A').length,
                    gradeB: all.filter(c => c.grade === 'B').length,
                    gradeC: all.filter(c => c.grade === 'C').length,
                    gradeD: all.filter(c => c.grade === 'D').length,
                    // å¸³æ¬¾è­¦ç¤ºï¼ˆå¿…é ˆæœ‰å¸³æ¬¾é¤˜é¡ï¼‰
                    warning: all.filter(c => c.arStatus === 'warning' && c.arBalance > 0).length,
                    danger: all.filter(c => c.arStatus === 'danger' && c.arBalance > 0).length,
                    // è£œè²¨çµ±è¨ˆ
                    replenishOverdue: all.filter(c => c.replenish?.status === 'overdue').length,
                    replenishDue: all.filter(c => c.replenish?.status === 'due').length,
                    replenishSoon: all.filter(c => c.replenish?.status === 'soon').length,
                    todayCall: todayCallList.length,
                    // ä¿¡ç”¨é¡åº¦çµ±è¨ˆ
                    creditOver90: all.filter(c => c.creditUsage > 90).length,
                    creditOver70: all.filter(c => c.creditUsage > 70 && c.creditUsage <= 90).length,
                    totalAR: all.reduce((sum, c) => sum + (c.arBalance || 0), 0),
                    totalOverdue: all.reduce((sum, c) => sum + (c.arOverdue || 0), 0),
                  };
                })();
                
                // é¸æ“‡å®¢æˆ¶ä¸¦å¸¶å…¥å ±åƒ¹
                const selectCustomer = (customer) => {
                  setCustInfo({
                    ...custInfo,
                    name: customer.name,
                    phone: customer.tel1 || '',
                    mobile: customer.tel2 || '',
                    address: customer.address || '',
                    tier: customer.priceTier || 'ç”Ÿæ„åƒ¹',
                    paymentMethod: customer.paymentTerm || 'æœˆçµ30å¤©'
                  });
                  setPage('main');
                  setCurrentTab('quote');
                };
                
                // ç·¨è¼¯å®¢æˆ¶åƒ¹æ ¼ç­‰ç´š
                const updateCustomerPriceTier = (customerKey, newTier) => {
                  setCustomerDB(prev => ({
                    ...prev,
                    [customerKey]: {
                      ...prev[customerKey],
                      priceTier: newTier
                    }
                  }));
                  if (db) {
                    const { ref, update } = window.firebaseModules;
                    update(ref(db, `seafoodData/customerDB/${customerKey}`), { priceTier: newTier });
                  }
                };
                
                // æ›´æ–°å®¢æˆ¶ä¿¡ç”¨é¡åº¦
                const updateCustomerCreditLimit = (customerKey, newLimit) => {
                  const customer = customerDB[customerKey];
                  const arBalance = customer?.arBalance || 0;
                  const newUsage = newLimit > 0 ? Math.round(arBalance / newLimit * 100) : 0;
                  
                  setCustomerDB(prev => ({
                    ...prev,
                    [customerKey]: {
                      ...prev[customerKey],
                      creditLimit: newLimit,
                      creditUsage: newUsage
                    }
                  }));
                  if (db) {
                    const { ref, update } = window.firebaseModules;
                    update(ref(db, `seafoodData/customerDB/${customerKey}`), { 
                      creditLimit: newLimit,
                      creditUsage: newUsage
                    });
                  }
                };
                
                // æ›´æ–°å®¢æˆ¶æœˆçµå¤©æ•¸
                const updateCustomerPaymentDays = (customerKey, newDays) => {
                  setCustomerDB(prev => ({
                    ...prev,
                    [customerKey]: {
                      ...prev[customerKey],
                      paymentDays: newDays
                    }
                  }));
                  if (db) {
                    const { ref, update } = window.firebaseModules;
                    update(ref(db, `seafoodData/customerDB/${customerKey}`), { paymentDays: newDays });
                  }
                };
                
                // è¨ˆç®—è·ä»Šå¤©æ•¸
                const daysAgo = (dateStr) => {
                  if (!dateStr) return null;
                  const diff = new Date() - new Date(dateStr);
                  return Math.floor(diff / (1000 * 60 * 60 * 24));
                };
                
                return (
                  <div className="animate-slide-up space-y-3">
                    
                    {/* ç‹€æ…‹åˆ— - ç°¡æ½”ç‰ˆ */}
                    <div className="glass card-shadow rounded-2xl p-3">
                      <div className="flex flex-wrap gap-2">
                        {[
                          { key: 'all', label: 'å…¨éƒ¨', count: stats.total, color: 'bg-gray-100 text-gray-700' },
                          { key: 'A', label: 'Aç´š', count: stats.gradeA, color: 'bg-yellow-100 text-yellow-700' },
                          { key: 'B', label: 'Bç´š', count: stats.gradeB, color: 'bg-blue-100 text-blue-700' },
                          { key: 'needCall', label: 'ğŸ“å¾…è£œè²¨', count: stats.replenishOverdue + stats.replenishDue + stats.replenishSoon, color: 'bg-orange-100 text-orange-700' },
                          { key: 'warning', label: 'ğŸŸ¡å¸³æ¬¾', count: stats.warning, color: 'bg-yellow-100 text-yellow-700' },
                          { key: 'danger', label: 'ğŸ”´é€¾æœŸ', count: stats.danger, color: 'bg-red-100 text-red-700' },
                        ].map(item => (
                          <button
                            key={item.key}
                            onClick={() => { setCrmFilter(item.key); setCrmPage(1); }}
                            className={`px-3 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-1 ${
                              crmFilter === item.key 
                                ? 'bg-purple-500 text-white shadow-lg ring-2 ring-purple-300' 
                                : item.color + ' hover:opacity-80'
                            }`}
                          >
                            {item.label}
                            <span className={`px-1.5 py-0.5 rounded text-xs ${
                              crmFilter === item.key ? 'bg-white/30' : 'bg-black/10'
                            }`}>{item.count}</span>
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* æœå°‹åˆ— + æ¥­å‹™å“¡éæ¿¾ */}
                    <div className="glass card-shadow rounded-2xl p-3">
                      <div className="flex flex-wrap gap-2">
                        <div className="flex-1 min-w-[200px] relative">
                          <input
                            type="text"
                            value={crmSearch}
                            onChange={(e) => { setCrmSearch(e.target.value); setCrmPage(1); }}
                            placeholder="ğŸ” æœå°‹å®¢æˆ¶åç¨±ã€é›»è©±..."
                            className="w-full px-4 py-2 rounded-xl border border-gray-200 bg-white text-gray-800 placeholder-gray-400"
                          />
                        </div>
                        <select
                          value={crmSalesRep || ''}
                          onChange={(e) => { setCrmSalesRep(e.target.value); setCrmPage(1); }}
                          className="px-3 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 text-sm"
                        >
                          <option value="">ğŸ‘¤ å…¨éƒ¨æ¥­å‹™</option>
                          {(() => {
                            const reps = new Set();
                            Object.values(customerDB).forEach(c => { if (c.salesRep) reps.add(c.salesRep); });
                            return Array.from(reps).sort().map(rep => (
                              <option key={rep} value={rep}>{rep}</option>
                            ));
                          })()}
                        </select>
                        <select
                          value={crmSort}
                          onChange={(e) => { setCrmSort(e.target.value); setCrmPage(1); }}
                          className="px-3 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 text-sm"
                        >
                          <option value="amount">ç´¯è¨ˆé‡‘é¡â†“</option>
                          <option value="overdue">é€¾æœŸé‡‘é¡â†“</option>
                          <option value="replenish">è©²è£œè²¨</option>
                          <option value="lastOrder">æœ€è¿‘äº¤æ˜“</option>
                          <option value="name">åç¨±</option>
                        </select>
                      </div>
                    </div>
                    
                    {/* å®¢æˆ¶åˆ—è¡¨ - ç²¾ç°¡æ¨¡å¼ + åˆ†é  */}
                    <div className="glass card-shadow rounded-2xl p-4">
                      {/* åˆ†é è³‡è¨Š */}
                      {(() => {
                        const totalPages = Math.ceil(customerList.length / CRM_PAGE_SIZE);
                        const startIdx = (crmPage - 1) * CRM_PAGE_SIZE;
                        const endIdx = Math.min(startIdx + CRM_PAGE_SIZE, customerList.length);
                        const pageList = customerList.slice(startIdx, endIdx);
                        
                        return (
                          <>
                            <div className="flex items-center justify-between mb-3">
                              <span className="text-gray-500 text-sm">
                                å…± {customerList.length} ä½ï¼Œç¬¬ {crmPage}/{totalPages || 1} é 
                              </span>
                              {totalPages > 1 && (
                                <div className="flex items-center gap-1">
                                  <button 
                                    onClick={() => setCrmPage(1)}
                                    disabled={crmPage === 1}
                                    className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-sm disabled:opacity-30"
                                  >â®</button>
                                  <button 
                                    onClick={() => setCrmPage(p => Math.max(1, p - 1))}
                                    disabled={crmPage === 1}
                                    className="px-3 py-1 rounded bg-gray-100 text-gray-600 text-sm disabled:opacity-30"
                                  >â—€</button>
                                  <span className="px-3 py-1 text-sm font-bold text-purple-600">{crmPage}</span>
                                  <button 
                                    onClick={() => setCrmPage(p => Math.min(totalPages, p + 1))}
                                    disabled={crmPage === totalPages}
                                    className="px-3 py-1 rounded bg-gray-100 text-gray-600 text-sm disabled:opacity-30"
                                  >â–¶</button>
                                  <button 
                                    onClick={() => setCrmPage(totalPages)}
                                    disabled={crmPage === totalPages}
                                    className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-sm disabled:opacity-30"
                                  >â­</button>
                                </div>
                              )}
                            </div>
                      
                            <div className="space-y-2">
                              {pageList.map(customer => {
                                const days = daysAgo(customer.lastOrder);
                                const isOverdue = customer.avgCycle && days > customer.avgCycle;
                                const isExpanded = expandedCustomer === customer._key;
                                const overdueAmt = customer.arOverdue || 0;
                                const hasAlert = overdueAmt > 0 || isOverdue || customer.creditUsage >= 100;
                          
                          return (
                            <div 
                              key={customer._key}
                              className={`bg-white rounded-2xl overflow-hidden transition-all ${
                                isExpanded ? 'ring-2 ring-purple-400 shadow-lg' : 'shadow-sm'
                              }`}
                            >
                              {/* ä¸»åˆ— - Mobile-First å¡ç‰‡å¼ */}
                              <div 
                                className="p-3 cursor-pointer"
                                onClick={() => setExpandedCustomer(isExpanded ? null : customer._key)}
                              >
                                {/* ä¸Šæ’ï¼šç­‰ç´š + åç¨± + å¿«æ·æŒ‰éˆ• */}
                                <div className="flex items-center gap-2 mb-2">
                                  {/* ç­‰ç´š */}
                                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-black text-lg flex-shrink-0 ${
                                    customer.grade === 'A' ? 'bg-gradient-to-br from-amber-400 to-orange-500 text-white' :
                                    customer.grade === 'B' ? 'bg-gradient-to-br from-blue-400 to-indigo-500 text-white' :
                                    customer.grade === 'C' ? 'bg-gradient-to-br from-emerald-400 to-green-500 text-white' :
                                    'bg-gray-200 text-gray-400'
                                  }`}>{customer.grade}</div>
                                  
                                  {/* åç¨± */}
                                  <div className="flex-1 min-w-0">
                                    <div className="font-bold text-gray-800 truncate">{customer.name}</div>
                                    {customer.salesRep && <div className="text-xs text-gray-400 truncate">æ¥­å‹™: {customer.salesRep}</div>}
                                  </div>
                                  
                                  {/* å¿«æ·æŒ‰éˆ• */}
                                  <div className="flex gap-1 flex-shrink-0">
                                    <a
                                      href={customer.tel1 ? `tel:${customer.tel1.replace(/[^0-9]/g, '')}` : '#'}
                                      onClick={(e) => { e.stopPropagation(); if (!customer.tel1) { e.preventDefault(); alert('æ­¤å®¢æˆ¶æœªå¡«å¯«é›»è©±'); } }}
                                      className={`w-9 h-9 flex items-center justify-center rounded-lg text-base ${
                                        customer.tel1 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'
                                      }`}
                                    >ğŸ“</a>
                                    <a
                                      href={customer.tel1 ? `https://line.me/R/oaMessage/@yourlineoa/?${encodeURIComponent(`${customer.name} æ‚¨å¥½`)}` : '#'}
                                      onClick={(e) => { e.stopPropagation(); if (!customer.tel1) { e.preventDefault(); alert('æ­¤å®¢æˆ¶æœªå¡«å¯«é›»è©±'); } }}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className={`w-9 h-9 flex items-center justify-center rounded-lg text-base ${
                                        customer.tel1 ? 'bg-[#06C755] text-white' : 'bg-gray-200 text-gray-400'
                                      }`}
                                    >ğŸ’¬</a>
                                  </div>
                                </div>
                                
                                {/* ä¸‹æ’ï¼šæ¨™ç±¤ + æ•¸æ“š - å›ºå®šå¯¬åº¦é˜²æŠ˜è¡Œ */}
                                <div className="flex items-center justify-between gap-2">
                                  {/* å·¦å´ï¼šè­¦ç¤ºæ¨™ç±¤ */}
                                  <div className="flex items-center gap-1 flex-1 min-w-0 overflow-hidden">
                                    {overdueAmt > 0 && (
                                      <span className={`text-xs px-2 py-0.5 rounded-full font-bold whitespace-nowrap ${
                                        customer.arStatus === 'danger' ? 'bg-red-500 text-white' : 'bg-amber-400 text-amber-900'
                                      }`}>é€¾æœŸ{(overdueAmt/10000).toFixed(0)}è¬</span>
                                    )}
                                    {isOverdue && <span className="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 whitespace-nowrap">è©²è£œè²¨</span>}
                                    {customer.creditUsage >= 100 && <span className="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700 whitespace-nowrap">è¶…é¡</span>}
                                  </div>
                                  
                                  {/* å³å´ï¼šæ•¸æ“šæ‘˜è¦ - æœ‰æ¨™é¡Œ */}
                                  <div className="flex items-center gap-3 flex-shrink-0 text-sm">
                                    <div className="text-center">
                                      <div className="text-[10px] text-gray-400">ç´¯è¨ˆ</div>
                                      <div className="text-purple-600 font-bold">{((customer.totalAmount || 0) / 10000).toFixed(0)}è¬</div>
                                    </div>
                                    <div className="text-center">
                                      <div className="text-[10px] text-gray-400">æœ€å¾Œäº¤æ˜“</div>
                                      <div className={`font-bold ${days > 30 ? 'text-red-500' : 'text-gray-600'}`}>
                                        {customer.lastOrder ? customer.lastOrder.substring(5) : '-'}
                                      </div>
                                    </div>
                                    <span className={`text-gray-400 ${isExpanded ? 'rotate-180' : ''}`}>â–¼</span>
                                  </div>
                                </div>
                              </div>
                              
                              {/* å±•é–‹è©³æƒ… */}
                              {isExpanded && (
                                <div className="border-t border-gray-100 bg-gradient-to-b from-gray-50 to-white p-3 space-y-3">
                                  
                                  {/* è¯çµ¡è³‡è¨Š */}
                                  <div className="flex items-center gap-3 text-sm">
                                    <span className={customer.tel1 ? 'text-gray-600' : 'text-gray-300'}>ğŸ“ {customer.tel1 || 'æœªå¡«é›»è©±'}</span>
                                    {customer.address && <span className="text-gray-400 truncate">ğŸ“ {customer.address}</span>}
                                  </div>
                                  
                                  {/* è¨­å®šï¼šæœˆçµ + ä¿¡ç”¨é¡åº¦ï¼ˆç¨ç«‹ä¸€è¡Œï¼‰ */}
                                  <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                      <span className="text-sm text-gray-500">æœˆçµ</span>
                                      <select
                                        value={customer.paymentDays || 30}
                                        onChange={(e) => { e.stopPropagation(); updateCustomerPaymentDays(customer._key, parseInt(e.target.value)); }}
                                        onClick={(e) => e.stopPropagation()}
                                        className="px-2 py-1 rounded-lg bg-green-50 text-green-700 font-bold text-sm border border-green-200"
                                      >
                                        <option value={7}>7å¤©</option>
                                        <option value={15}>15å¤©</option>
                                        <option value={30}>30å¤©</option>
                                        <option value={45}>45å¤©</option>
                                        <option value={60}>60å¤©</option>
                                      </select>
                                    </div>
                                    <div className="flex items-center gap-2 flex-1">
                                      <span className="text-sm text-gray-500 whitespace-nowrap">ä¿¡ç”¨é¡åº¦</span>
                                      <input
                                        type="text"
                                        value={'$' + (customer.creditLimit || customer.suggestedCredit || 0).toLocaleString()}
                                        onChange={(e) => { 
                                          e.stopPropagation(); 
                                          const val = parseInt(e.target.value.replace(/[^0-9]/g, '')) || 0;
                                          updateCustomerCreditLimit(customer._key, val); 
                                        }}
                                        onClick={(e) => e.stopPropagation()}
                                        className="flex-1 min-w-0 px-2 py-1 text-right font-bold text-blue-600 bg-blue-50 rounded-lg border border-blue-200 text-sm"
                                      />
                                    </div>
                                  </div>
                                  
                                  {/* äº¤æ˜“çµ±è¨ˆ */}
                                  <div className="bg-white rounded-xl p-3 border border-gray-100">
                                    <div className="text-sm text-gray-500 font-bold mb-2">ğŸ“Š äº¤æ˜“çµ±è¨ˆ</div>
                                    <div className="grid grid-cols-3 gap-2 text-center">
                                      <div className="bg-purple-50 rounded-lg p-2">
                                        <div className="text-base font-black text-purple-600">{((customer.totalAmount || 0)/10000).toFixed(0)}è¬</div>
                                        <div className="text-[10px] text-gray-400">ç´¯è¨ˆ</div>
                                      </div>
                                      <div className="bg-blue-50 rounded-lg p-2">
                                        <div className="text-base font-black text-blue-600">{((customer.monthlyAvg || 0)/10000).toFixed(1)}è¬</div>
                                        <div className="text-[10px] text-gray-400">æœˆå‡</div>
                                      </div>
                                      <div className="bg-gray-50 rounded-lg p-2">
                                        <div className="text-base font-bold text-gray-600">{customer.avgCycle || '-'}å¤©</div>
                                        <div className="text-[10px] text-gray-400">æ¡è³¼é€±æœŸ</div>
                                      </div>
                                    </div>
                                  </div>
                                  
                                  {/* æ‡‰æ”¶å¸³æ¬¾ */}
                                  {customer.arBalance > 0 && (
                                    <div className="bg-white rounded-xl p-3 border border-gray-100">
                                      <div className="flex items-center justify-between mb-3">
                                        <span className="text-sm text-gray-500 font-bold">ğŸ’° æ‡‰æ”¶å¸³æ¬¾</span>
                                        <span className="text-lg font-black text-gray-700">${customer.arBalance.toLocaleString()}</span>
                                      </div>
                                      
                                      {/* å¸³é½¡åˆ†æè¡¨æ ¼ */}
                                      <div className="border border-gray-200 rounded-lg overflow-hidden">
                                        {/* è¡¨é ­ */}
                                        <div className="grid grid-cols-4 bg-gray-100 text-[10px] text-gray-500 text-center">
                                          <div className="p-1.5 border-r border-gray-200">30å¤©å…§</div>
                                          <div className="p-1.5 border-r border-gray-200">30-60å¤©</div>
                                          <div className="p-1.5 border-r border-gray-200">60-90å¤©</div>
                                          <div className="p-1.5">90å¤©ä»¥ä¸Š</div>
                                        </div>
                                        {/* é‡‘é¡ */}
                                        <div className="grid grid-cols-4 text-center">
                                          <div className="p-2 border-r border-gray-200 bg-green-50">
                                            <div className="text-sm font-bold text-green-600">{((customer.ar30 || 0)/10000).toFixed(1)}è¬</div>
                                          </div>
                                          <div className="p-2 border-r border-gray-200 bg-yellow-50">
                                            <div className="text-sm font-bold text-yellow-600">{((customer.ar3060 || 0)/10000).toFixed(1)}è¬</div>
                                          </div>
                                          <div className="p-2 border-r border-gray-200 bg-orange-50">
                                            <div className="text-sm font-bold text-orange-500">{((customer.ar6090 || 0)/10000).toFixed(1)}è¬</div>
                                          </div>
                                          <div className="p-2 bg-red-50">
                                            <div className="text-sm font-bold text-red-500">{((customer.ar90plus || 0)/10000).toFixed(1)}è¬</div>
                                          </div>
                                        </div>
                                        {/* ç‹€æ…‹èªªæ˜ */}
                                        <div className="grid grid-cols-4 text-[10px] text-center border-t border-gray-200">
                                          <div className="p-1 border-r border-gray-200 text-green-600 bg-green-50">æ­£å¸¸</div>
                                          <div className="p-1 border-r border-gray-200 text-yellow-600 bg-yellow-50">æ³¨æ„</div>
                                          <div className="p-1 border-r border-gray-200 text-orange-500 bg-orange-50">è­¦å‘Š</div>
                                          <div className="p-1 text-red-500 bg-red-50">å±éšª</div>
                                        </div>
                                      </div>
                                      
                                      {/* æ‘˜è¦ */}
                                      <div className="flex justify-between mt-2 text-xs">
                                        <span className="text-gray-500">
                                          æœ¬æœŸæ‡‰æ”¶: <b className="text-green-600">{((customer.ar30 || 0)/10000).toFixed(1)}è¬</b>
                                        </span>
                                        <span className="text-gray-500">
                                          é€¾æœŸç¸½é¡: <b className={customer.arOverdue > 0 ? 'text-red-500' : 'text-gray-400'}>{((customer.arOverdue || 0)/10000).toFixed(1)}è¬</b>
                                        </span>
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* å¸¸è³¼å“é … */}
                                  {customer.topProducts?.length > 0 && (
                                    <div className="bg-white rounded-xl p-3 border border-gray-100">
                                      <div className="text-sm text-gray-500 font-bold mb-2">ğŸ“¦ å¸¸è³¼å“é …</div>
                                      <div className="flex flex-wrap gap-1">
                                        {customer.topProducts.slice(0, 8).map((p, i) => (
                                          <span key={i} className={`px-2 py-1 rounded-full text-xs ${
                                            i < 3 ? 'bg-purple-500 text-white font-bold' : 'bg-gray-100 text-gray-600'
                                          }`}>{p.length > 5 ? p.substring(0, 5) + '..' : p}</span>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          );
                        })}
                        
                        {pageList.length === 0 && (
                          <div className="text-center text-gray-400 py-12">
                            <Icons.Users className="w-16 h-16 mx-auto mb-4 opacity-30" />
                            <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å®¢æˆ¶</p>
                            <p className="text-sm mt-2">è«‹å…ˆåœ¨ã€Œè³‡æ–™ç®¡ç†ã€ä¸Šå‚³å®¢æˆ¶ä¸»æª”æˆ–éŠ·è²¨æ˜ç´°</p>
                          </div>
                        )}
                      </div>
                      
                      {/* åº•éƒ¨åˆ†é  */}
                      {totalPages > 1 && (
                        <div className="flex items-center justify-center gap-2 mt-4 pt-4 border-t border-gray-100">
                          <button 
                            onClick={() => setCrmPage(p => Math.max(1, p - 1))}
                            disabled={crmPage === 1}
                            className="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-bold disabled:opacity-30"
                          >â—€ ä¸Šä¸€é </button>
                          <span className="px-4 py-2 text-sm text-gray-500">
                            ç¬¬ {crmPage} / {totalPages} é 
                          </span>
                          <button 
                            onClick={() => setCrmPage(p => Math.min(totalPages, p + 1))}
                            disabled={crmPage === totalPages}
                            className="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-bold disabled:opacity-30"
                          >ä¸‹ä¸€é  â–¶</button>
                        </div>
                      )}
                          </>
                        );
                      })()}
                    </div>
                  </div>
                );
              })()}
              
              {/* ==================== å®‰å…¨åº«å­˜ Tab ==================== */}
              {settingsTab === 'safety' && (
                <div className="animate-slide-up grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* å·¦æ¬„ï¼šè¨­å®šèˆ‡æ“ä½œ */}
                  <div className="glass card-shadow p-5 rounded-2xl">
                    <h2 className="text-l2 mb-4 flex items-center gap-2">
                      ğŸ“¦ {role === 'store' ? 'é–€å¸‚' : 'å·¥å» '}å®‰å…¨åº«å­˜è¨­å®š
                    </h2>
                    
                    {/* è§’è‰²æŒ‡ç¤º */}
                    <div className={`mb-4 p-2 rounded-lg text-center text-sm font-bold ${
                      role === 'store' ? 'bg-cyan-100 text-cyan-700' : 'bg-purple-100 text-purple-700'
                    }`}>
                      {role === 'store' ? 'ğŸª é–€å¸‚æ¨¡å¼ - ç›£æ§é–€å¸‚åº«å­˜' : 'ğŸ­ å·¥å» æ¨¡å¼ - ç›£æ§å·¥å» åº«å­˜'}
                    </div>
                    
                    <div className="mb-4 p-3 bg-orange-50 border-2 border-orange-200 rounded-xl">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-l3">é è¨­å®‰å…¨åº«å­˜é‡</p>
                          <p className="text-l6">æœªå€‹åˆ¥è¨­å®šä½¿ç”¨æ­¤å€¼</p>
                        </div>
                        <div className="flex items-center gap-1">
                          <span className="text-3xl font-bold text-orange-600">{DEFAULT_SAFETY_STOCK}</span>
                          <span className="text-l6">ä»¶</span>
                        </div>
                      </div>
                    </div>
                    
                    <div className="space-y-2">
                      <button 
                        onClick={() => {
                          localStorage.removeItem('lastLowStockAlert');
                          const items = checkLowStock(true);
                          if (items.length > 0) {
                            setLowStockItems(items);
                            setShowLowStockAlert(true);
                          } else {
                            alert('âœ… å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰ä½åº«å­˜çš„ç”¢å“');
                          }
                        }}
                        className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-3 rounded-xl text-l3 flex items-center justify-center gap-2"
                      >
                        âš ï¸ ç«‹å³æª¢æŸ¥ä½åº«å­˜
                      </button>
                      <button 
                        onClick={() => setShowSafetyStockModal(true)}
                        className="w-full bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-3 rounded-xl text-l3 flex items-center justify-center gap-2"
                      >
                        âš™ï¸ å€‹åˆ¥ç”¢å“è¨­å®š
                      </button>
                    </div>
                    
                    <div className="mt-4 text-l6">
                      <p>ğŸ“ ç›£æ§å€‰åº«ï¼š{role === 'store' ? STORE_WAREHOUSES.join('ã€') : FACTORY_WAREHOUSES.slice(0, 3).join('ã€') + '...'}</p>
                      <p>ğŸ“Š å·²è¨­å®šï¼š{Object.keys(role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {})).length} é …</p>
                    </div>
                    
                    {/* æ›´æ–°æ™‚é–“ */}
                    <div className="mt-4 p-3 bg-gray-50 rounded-xl border border-gray-200">
                      <p className="text-l5 text-gray-600">
                        ğŸ“… ä¸Šæ¬¡æ›´æ–°ï¼š{role === 'store' ? (data.meta?.storeSafetyStockDate || 'å°šæœªæ›´æ–°') : (data.meta?.safetyStockDate || 'å°šæœªæ›´æ–°')}
                      </p>
                    </div>
                  </div>
                  
                  {/* å³æ¬„ï¼šç³»çµ±è³‡è¨Š */}
                  <div className="glass card-shadow p-5 rounded-2xl">
                    <h2 className="text-l2 mb-4">ç³»çµ±è³‡è¨Š</h2>
                    <div className="space-y-2 text-l4">
                      <div className="flex justify-between py-2 border-b border-gray-100">
                        <span className="text-l5">è³‡æ–™åº«ç‹€æ…‹</span>
                        <span className={status.includes('å·²é€£ç·š') ? 'text-green-600 font-bold' : ''}>{status}</span>
                      </div>
                      <div className="flex justify-between py-2 border-b border-gray-100">
                        <span className="text-l5">ç”¢å“åˆ†é¡æ•¸</span>
                        <span className="font-bold">{Object.keys(data.products).length} é …</span>
                      </div>
                      <div className="flex justify-between py-2 border-b border-gray-100">
                        <span className="text-l5">åƒ¹æ ¼ç­‰ç´š</span>
                        <span>{data.tiers.length} å€‹</span>
                      </div>
                      {data.meta?.stockDate && (
                        <div className="flex justify-between py-2 border-b border-gray-100">
                          <span className="text-l5">åº«å­˜åŒ¯å…¥</span>
                          <span className="text-l6">{data.meta.stockDate}</span>
                        </div>
                      )}
                      {data.meta?.quoteDate && (
                        <div className="flex justify-between py-2 border-b border-gray-100">
                          <span className="text-l5">å ±åƒ¹åŒ¯å…¥</span>
                          <span className="text-l6">{data.meta.quoteDate}</span>
                        </div>
                      )}
                      {data.meta?.safetyStockDate && (
                        <div className="flex justify-between py-2 border-b border-gray-100">
                          <span className="text-l5">å®‰å…¨åº«å­˜æ›´æ–°</span>
                          <span className="text-l6">{data.meta.safetyStockDate}</span>
                        </div>
                      )}
                      {data.meta?.priceEditDate && (
                        <div className="flex justify-between py-2">
                          <span className="text-l5">æ”¹åƒ¹æ›´æ–°</span>
                          <span className="text-l6">{data.meta.priceEditDate}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* ==================== æ”¹åƒ¹ç™¼å¸ƒ Tab (Admin & Store) ==================== */}
              {settingsTab === 'publish' && (role === 'admin' || role === 'store') && (
                <div className="animate-slide-up">
                  {/* ===== æ‰‹æ©Ÿç‰ˆ UI ===== */}
                  <div className="lg:hidden flex flex-col" style={{minHeight: 'calc(100vh - 140px)'}}>
                    {/* é ‚éƒ¨ï¼šåˆ†é¡é¸æ“‡ - ä¸‹æ‹‰å¼é¸å–®ç‰ˆ */}
                    <div className="glass card-shadow p-3 rounded-2xl mb-3">
                      <div className="flex items-center gap-3">
                        {/* æ¨™é¡Œ */}
                        <h3 className="text-base font-bold whitespace-nowrap">é¡åˆ¥</h3>
                        
                        {/* åˆ†é¡ä¸‹æ‹‰é¸å–® */}
                        <div className="flex-1 flex gap-2">
                          {/* ä¸»åˆ†é¡ */}
                          <select
                            value={getCurrentMainCat()}
                            onChange={e => setPublishCategory(e.target.value)}
                            className="flex-1 min-w-0 px-3 py-2.5 rounded-xl bg-purple-100 text-purple-700 font-bold text-base border-2 border-purple-300 outline-none appearance-none cursor-pointer"
                            style={{backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%237c3aed'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'right 8px center', backgroundSize: '20px', paddingRight: '32px'}}
                          >
                            {mainCategories.map(cat => (
                              <option key={cat.key} value={cat.key}>{cat.label}</option>
                            ))}
                          </select>
                          
                          {/* ç´°åˆ†é¡ - åªåœ¨æœ‰ç´°åˆ†é¡æ™‚é¡¯ç¤º */}
                          {getCurrentMainCat() !== 'all' && CATEGORY_CONFIG[getCurrentMainCat()]?.subs?.length > 0 && (
                            <select
                              value={getCurrentSubCat() || ''}
                              onChange={e => {
                                const sub = e.target.value;
                                setPublishCategory(sub ? getCurrentMainCat() + ':' + sub : getCurrentMainCat());
                              }}
                              className="flex-1 min-w-0 px-3 py-2.5 rounded-xl bg-indigo-100 text-indigo-700 font-bold text-base border-2 border-indigo-300 outline-none appearance-none cursor-pointer"
                              style={{backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234f46e5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'right 8px center', backgroundSize: '20px', paddingRight: '32px'}}
                            >
                              <option value="">å…¨éƒ¨</option>
                              {CATEGORY_CONFIG[getCurrentMainCat()].subs.map(sub => (
                                <option key={sub} value={sub}>{sub}</option>
                              ))}
                            </select>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    {/* ç”¢å“åˆ—è¡¨å€åŸŸ - å¡ç‰‡å¼è¨­è¨ˆï¼Œæ›´å¤§å­—é«” */}
                    <div className="flex-1 overflow-hidden mb-3 flex flex-col">
                      {/* æ¨™é¡Œåˆ— */}
                      <div className="bg-gradient-to-r from-purple-600 via-indigo-600 to-purple-700 text-white px-4 py-2.5 rounded-t-2xl">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-lg font-bold">å…«æ–¹ç’°çƒ</span>
                            <span className="text-purple-200 text-sm">å…§éƒ¨å ±åƒ¹è¡¨</span>
                          </div>
                          <span className="bg-white/20 text-sm px-3 py-1 rounded-lg font-medium">{getCategoryDisplayName()}</span>
                        </div>
                      </div>
                      
                      {/* ç”¢å“åˆ—è¡¨ - å¡ç‰‡å¼ */}
                      <div className="flex-1 overflow-y-auto bg-gray-50 rounded-b-2xl">
                        {(() => {
                          const grouped = getGroupedProducts();
                          if (grouped.length === 0) {
                            return (
                              <div className="p-8 text-center text-gray-400">
                                <div className="text-5xl mb-3">ğŸ“¦</div>
                                <div className="text-base">æ­¤åˆ†é¡æ²’æœ‰ç”¢å“</div>
                              </div>
                            );
                          }
                          
                          return (
                            <div className="px-1.5 py-2 space-y-2">
                              {grouped.map((group, gIdx) => {
                                const hasGroupTitle = group.items.length > 1;
                                return (
                                <React.Fragment key={gIdx}>
                                  {/* åˆ†çµ„æ¨™é¡Œ - åªåœ¨å¤šè¦æ ¼æ™‚é¡¯ç¤º */}
                                  {hasGroupTitle && (
                                    <div className="bg-purple-100 px-3 py-2 rounded-xl text-sm font-bold text-purple-700 sticky top-0 z-10 shadow-sm mx-0.5">
                                      {group.brandName} ({group.items.length})
                                    </div>
                                  )}
                                  {group.items.map((p, idx) => {
                                    const statusEdit = productStatusEdits[p.id] || {};
                                    const isNew = p.isNew || statusEdit.isNew;
                                    const isPromo = p.isPromo || statusEdit.isPromo;
                                    const priceChange = p.priceChange || 0;
                                    const getPrice = (keys) => {
                                      const rawPrices = editedPrices[p.id] || p.prices || {};
                                      for (const k of keys) {
                                        if (rawPrices[k] !== undefined && rawPrices[k] !== null && rawPrices[k] !== '') return rawPrices[k];
                                      }
                                      return '-';
                                    };
                                    
                                    // æ±ºå®šé¡¯ç¤ºä»€éº¼ï¼šæœ‰åˆ†çµ„æ¨™é¡Œæ™‚é¡¯ç¤ºè¦æ ¼ï¼Œæ²’æœ‰æ™‚é¡¯ç¤ºå“å
                                    const displayTitle = hasGroupTitle 
                                      ? (p.specDetail || p.displayName || p.name)
                                      : (p.displayName || p.name);
                                    const displaySubtitle = hasGroupTitle ? null : p.specDetail;
                                    
                                    return (
                                      <div 
                                        key={p.id} 
                                        className={`bg-white rounded-xl border-2 px-3 py-2.5 active:scale-[0.98] transition-transform mx-0.5 ${
                                          isNew ? 'border-amber-400 bg-amber-50/50' : 
                                          isPromo ? 'border-purple-400 bg-purple-50/50' : 
                                          'border-gray-200'
                                        }`}
                                        onClick={() => openPriceEditor(p, 0)}
                                      >
                                        {/* ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œ + ç‹€æ…‹æ¨™ç±¤ */}
                                        <div className="flex items-center justify-between mb-1">
                                          <div className="font-black text-lg text-gray-900 truncate flex-1">{displayTitle}</div>
                                          <div className="flex items-center gap-1.5 flex-shrink-0 ml-2">
                                            {isNew && <span className="px-2 py-0.5 bg-amber-500 rounded text-white text-sm font-bold">æ–°</span>}
                                            {isPromo && <span className="px-2 py-0.5 bg-purple-500 rounded text-white text-sm font-bold">ä¿ƒ</span>}
                                            {priceChange > 0 && <span className="text-red-500 text-base font-bold">â–²</span>}
                                            {priceChange < 0 && <span className="text-green-500 text-base font-bold">â–¼</span>}
                                          </div>
                                        </div>
                                        
                                        {/* ç¬¬äºŒè¡Œï¼šè¦æ ¼ï¼ˆåƒ…å–®è¦æ ¼ç”¢å“é¡¯ç¤ºï¼‰ */}
                                        {displaySubtitle && (
                                          <div className="text-sm text-gray-500 mb-1 truncate">{displaySubtitle}</div>
                                        )}
                                        
                                        {/* åƒ¹æ ¼è³‡è¨Š - ä¸‰æ¬„ç­‰å¯¬å°é½Š */}
                                        <div className="grid grid-cols-3 gap-2 mt-1">
                                          {[
                                            { label: 'åº•åƒ¹', keys: ['æ¥­å‹™åº•åƒ¹'], color: 'gray' },
                                            { label: 'VIP', keys: ['VIPåƒ¹', 'VIP åƒ¹'], color: 'blue' },
                                            { label: 'æ•´ä»¶', keys: ['æ•´ä»¶åƒ¹'], color: 'purple', highlight: true },
                                          ].map(tier => {
                                            const val = getPrice(tier.keys);
                                            const isEmpty = val === '-' || val === 0 || val === '0';
                                            return (
                                              <div key={tier.label} className="text-center">
                                                <span className={`text-sm ${tier.color === 'purple' ? 'text-purple-600' : tier.color === 'blue' ? 'text-blue-600' : 'text-gray-500'}`}>{tier.label} </span>
                                                <span className={`font-bold ${tier.highlight ? 'text-xl' : 'text-lg'} ${
                                                  isEmpty ? 'text-red-400' : 
                                                  tier.color === 'purple' ? 'text-purple-700' : 
                                                  tier.color === 'blue' ? 'text-blue-700' : 'text-gray-700'
                                                }`}>{isEmpty ? 'æœªè¨­' : val}</span>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>
                                    );
                                  })}
                                </React.Fragment>
                              );
                              })}
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                    
                    {/* å„²å­˜æŒ‰éˆ• */}
                    {Object.keys(editedPrices).length > 0 && (
                      <button 
                        onClick={() => {
                          if (!confirm(`ç¢ºå®šè¦å„²å­˜ ${Object.keys(editedPrices).length} é …åƒ¹æ ¼ä¿®æ”¹å—ï¼Ÿ`)) return;
                          
                          const newProducts = { ...data.products };
                          Object.entries(editedPrices).forEach(([pid, prices]) => {
                            Object.entries(newProducts).forEach(([name, specs]) => {
                              if (Array.isArray(specs)) {
                                specs.forEach((spec, idx) => {
                                  if (spec.id === pid) {
                                    // è¨ˆç®—æ¼²è·Œåƒ¹ï¼ˆä»¥ VIPåƒ¹ ç‚ºåŸºæº–ï¼‰
                                    const oldVIP = spec.prices?.['VIPåƒ¹'] || spec.prices?.['VIP åƒ¹'] || 0;
                                    const newVIP = prices['VIPåƒ¹'] ?? prices['VIP åƒ¹'] ?? oldVIP;
                                    let priceChange = 0;
                                    if (newVIP > oldVIP) priceChange = 1;  // æ¼²åƒ¹
                                    if (newVIP < oldVIP) priceChange = -1; // é™åƒ¹
                                    
                                    // ä¿å­˜æ–°åƒ¹æ ¼å’Œæ¼²è·Œç‹€æ…‹
                                    newProducts[name][idx].prices = { ...spec.prices, ...prices };
                                    newProducts[name][idx].priceChange = priceChange;
                                    newProducts[name][idx].lastVIPPrice = oldVIP; // ä¿å­˜èˆŠåƒ¹æ ¼ä¾›åƒè€ƒ
                                    
                                    if (productStatusEdits[pid]) {
                                      if (productStatusEdits[pid].isNew) newProducts[name][idx].isNew = true;
                                      if (productStatusEdits[pid].isPromo) newProducts[name][idx].isPromo = true;
                                    }
                                  }
                                });
                              }
                            });
                          });
                          
                          uploadDB({ 
                            productDB: newProducts,
                            dbMeta: { 
                              ...(data.meta || {}), 
                              priceEditDate: new Date().toLocaleString('zh-TW'),
                              lastUpdate: new Date().toISOString()
                            }
                          });
                          
                          setEditedPrices({});
                          setProductStatusEdits({});
                        }}
                        className="w-full py-3 mb-3 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 text-white text-sm font-bold shadow-lg flex items-center justify-center gap-2"
                      >
                        ğŸ’¾ å„²å­˜ {Object.keys(editedPrices).length} é …åƒ¹æ ¼è®Šæ›´åˆ°é›²ç«¯
                      </button>
                    )}
                    
                    {/* åº•éƒ¨åŒ¯å‡ºæŒ‰éˆ• - å›ºå®š */}
                    <div className="grid grid-cols-3 gap-2">
                      <button 
                        onClick={async () => {
                          const products = getProductsByCategory();
                          if (products.length === 0) return alert('æ²’æœ‰ç”¢å“è³‡æ–™');
                          
                          // æ‰‹æ©Ÿç‰ˆç°¡æ˜“ PDF - ä½¿ç”¨ç³»çµ±åˆ—å°
                          const printContent = document.createElement('div');
                          printContent.innerHTML = `
                            <style>
                              @page { size: A4 landscape; margin: 10mm; }
                              body { font-family: sans-serif; font-size: 12px; }
                              table { width: 100%; border-collapse: collapse; }
                              th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
                              th { background: #f3f4f6; }
                              .left { text-align: left; }
                              .up { color: #dc2626; }
                              .down { color: #16a34a; }
                            </style>
                            <h2>å…«æ–¹ç’°çƒ å…§éƒ¨å ±åƒ¹è¡¨ - ${getCategoryDisplayName()}</h2>
                            <p>ç™¼å¸ƒæ—¥æœŸï¼š${new Date().toLocaleDateString('zh-TW')}</p>
                            <table>
                              <tr><th class="left">å“å</th><th class="left">è¦æ ¼</th><th>åº•åƒ¹</th><th>VIP</th><th>æ•´ä»¶</th><th>ç”Ÿæ„</th><th>é¤å»³</th><th>æœƒå“¡</th><th>é–€å¸‚</th><th>ç‹€æ…‹</th></tr>
                              ${getGroupedProducts().map(g => g.items.map(p => {
                                const prices = editedPrices[p.id] || p.prices || {};
                                const isNew = p.isNew || (productStatusEdits[p.id] && productStatusEdits[p.id].isNew);
                                const isPromo = p.isPromo || (productStatusEdits[p.id] && productStatusEdits[p.id].isPromo);
                                const priceChange = p.priceChange || 0;
                                let status = '';
                                if (isNew) status += 'æ–° ';
                                if (isPromo) status += 'ä¿ƒ ';
                                if (priceChange > 0) status += '<span class="up">â–²</span>';
                                if (priceChange < 0) status += '<span class="down">â–¼</span>';
                                return '<tr><td class="left">' + (p.displayName||p.name) + '</td><td class="left">' + (p.specDetail||'-') + '</td><td>' + (prices['æ¥­å‹™åº•åƒ¹']||'-') + '</td><td>' + (prices['VIPåƒ¹']||prices['VIP åƒ¹']||'-') + '</td><td>' + (prices['æ•´ä»¶åƒ¹']||'-') + '</td><td>' + (prices['ç”Ÿæ„åƒ¹']||'-') + '</td><td>' + (prices['é¤å»³90%']||'-') + '</td><td>' + (prices['æœƒå“¡95%']||'-') + '</td><td>' + (prices['é–€å¸‚å”®åƒ¹']||'-') + '</td><td>' + status + '</td></tr>';
                              }).join('')).join('')}
                            </table>
                          `;
                          const printWindow = window.open('', '_blank');
                          printWindow.document.write(printContent.innerHTML);
                          printWindow.document.close();
                          printWindow.print();
                        }}
                        className="py-2.5 rounded-xl bg-gradient-to-r from-red-500 to-rose-600 text-white text-xs font-bold shadow-md flex items-center justify-center gap-1"
                      >
                        <span>ğŸ“„</span> PDF
                      </button>
                      <button 
                        onClick={async () => {
                          const products = getProductsByCategory();
                          if (products.length === 0) return alert('æ²’æœ‰ç”¢å“è³‡æ–™');
                          
                          const btn = event.target.closest('button');
                          const originalText = btn.innerHTML;
                          btn.disabled = true;
                          btn.innerHTML = '<span>â³</span> ç”¢ç”Ÿä¸­...';
                          
                          try {
                            const categoryName = getCategoryDisplayName();
                            const dateStr = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
                            const zip = new JSZip();
                            const groupedProducts = getGroupedProducts();
                            const allItems = groupedProducts.flatMap(g => g.items);
                            const itemsPerPage = 15;
                            const totalPages = Math.ceil(allItems.length / itemsPerPage);
                            
                            for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                              const pageItems = allItems.slice(pageNum * itemsPerPage, (pageNum + 1) * itemsPerPage);
                              
                              const container = document.createElement('div');
                              container.style.cssText = 'position:fixed;left:-9999px;top:0;';
                              document.body.appendChild(container);
                              
                              let tableRows = '';
                              pageItems.forEach((p, idx) => {
                                const prices = editedPrices[p.id] || p.prices || {};
                                const isNew = p.isNew || (productStatusEdits[p.id]?.isNew);
                                const isPromo = p.isPromo || (productStatusEdits[p.id]?.isPromo);
                                const priceChange = p.priceChange || 0;
                                let status = '';
                                if (isNew) status += '<span style="background:#f59e0b;color:#fff;padding:1px 4px;border-radius:3px;font-size:10px;margin-right:2px;">æ–°</span>';
                                if (isPromo) status += '<span style="background:#22c55e;color:#fff;padding:1px 4px;border-radius:3px;font-size:10px;margin-right:2px;">ä¿ƒ</span>';
                                if (priceChange > 0) status += '<span style="color:#dc2626;font-weight:bold;">â–²</span>';
                                if (priceChange < 0) status += '<span style="color:#16a34a;font-weight:bold;">â–¼</span>';
                                
                                const bgColor = idx % 2 === 0 ? '#fff' : '#f9fafb';
                                tableRows += '<tr style="background:' + bgColor + ';">' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:left;font-weight:600;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (p.displayName||p.name) + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:left;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (p.specDetail||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:right;">' + (prices['æ¥­å‹™åº•åƒ¹']||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:right;">' + (prices['VIPåƒ¹']||prices['VIP åƒ¹']||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:right;font-weight:bold;color:#7c3aed;">' + (prices['æ•´ä»¶åƒ¹']||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:right;">' + (prices['ç”Ÿæ„åƒ¹']||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:right;">' + (prices['é¤å»³90%']||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:right;">' + (prices['æœƒå“¡95%']||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:right;font-weight:bold;color:#ea580c;">' + (prices['é–€å¸‚å”®åƒ¹']||'-') + '</td>' +
                                  '<td style="padding:6px 8px;border:1px solid #e5e7eb;text-align:center;">' + status + '</td>' +
                                '</tr>';
                              });
                              
                              container.innerHTML = '<div style="width:1200px;background:#fff;font-family:sans-serif;padding:20px;">' +
                                '<div style="background:linear-gradient(to right,#7c3aed,#4f46e5);color:#fff;padding:16px 20px;border-radius:12px 12px 0 0;">' +
                                  '<div style="font-size:24px;font-weight:bold;">å…«æ–¹ç’°çƒ</div>' +
                                  '<div style="font-size:14px;opacity:0.8;">å…§éƒ¨å ±åƒ¹è¡¨ Â· ' + categoryName + '</div>' +
                                '</div>' +
                                '<div style="background:#f3f4f6;padding:8px 20px;font-size:12px;color:#666;display:flex;justify-content:space-between;">' +
                                  '<span>ç™¼å¸ƒæ—¥æœŸï¼š' + new Date().toLocaleDateString('zh-TW') + '</span>' +
                                  '<span>ç¬¬ ' + (pageNum + 1) + ' / ' + totalPages + ' é </span>' +
                                '</div>' +
                                '<table style="width:100%;border-collapse:collapse;font-size:13px;">' +
                                  '<tr style="background:#e5e7eb;">' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:left;width:14%;">å“å</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:left;width:18%;">è¦æ ¼</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:right;width:7%;">åº•åƒ¹</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:right;width:7%;">VIP</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:right;width:8%;">æ•´ä»¶</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:right;width:7%;">ç”Ÿæ„</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:right;width:8%;">é¤å»³</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:right;width:8%;">æœƒå“¡</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:right;width:8%;">é–€å¸‚</th>' +
                                    '<th style="padding:8px;border:1px solid #d1d5db;text-align:center;width:8%;">ç‹€æ…‹</th>' +
                                  '</tr>' +
                                  tableRows +
                                '</table>' +
                              '</div>';
                              
                              await new Promise(r => setTimeout(r, 150));
                              
                              // æ›´æ–°é€²åº¦
                              btn.innerHTML = '<span>ğŸ–¼ï¸</span> ' + (pageNum + 1) + '/' + totalPages + ' å¼µ...';
                              
                              // æ‰‹æ©Ÿç‰ˆä½¿ç”¨è¼ƒä½çš„ scale (1.5) ä»¥ç¯€çœè¨˜æ†¶é«”
                              const canvas = await html2canvas(container.firstChild, { scale: 1.5, backgroundColor: '#ffffff', useCORS: true });
                              
                              // è½‰ç‚º JPG base64
                              const imgData = canvas.toDataURL('image/jpeg', 0.85).replace(/^data:image\/jpeg;base64,/, '');
                              const fileName = 'å ±åƒ¹è¡¨_' + categoryName + '_ç¬¬' + String(pageNum + 1).padStart(2, '0') + 'é .jpg';
                              zip.file(fileName, imgData, { base64: true });
                              
                              // é‡‹æ”¾è¨˜æ†¶é«”
                              document.body.removeChild(container);
                              canvas.width = 0;
                              canvas.height = 0;
                            }
                            
                            btn.innerHTML = '<span>â³</span> æ‰“åŒ…ä¸­...';
                            const content = await zip.generateAsync({ type: 'blob' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(content);
                            link.download = 'å…«æ–¹ç’°çƒå ±åƒ¹è¡¨_' + categoryName + '_' + dateStr + '.zip';
                            link.click();
                            URL.revokeObjectURL(link.href);
                            
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                          } catch (err) {
                            console.error(err);
                            alert('åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—ï¼š' + err.message);
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                          }
                        }}
                        className="py-2.5 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xs font-bold shadow-md flex items-center justify-center gap-1"
                      >
                        <span>ğŸ–¼ï¸</span> JPG
                      </button>
                      <button 
                        onClick={() => {
                          const products = getProductsByCategory();
                          if (products.length === 0) return alert('æ²’æœ‰ç”¢å“è³‡æ–™');
                          
                          const grouped = getGroupedProducts();
                          const categoryName = getCategoryDisplayName();
                          const dateStr = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
                          
                          const wsData = [
                            ['å…«æ–¹ç’°çƒ å…§éƒ¨å ±åƒ¹è¡¨'],
                            ['åˆ†é¡: ' + categoryName, 'æ—¥æœŸ: ' + new Date().toLocaleDateString('zh-TW')],
                            [],
                            ['å“å', 'è¦æ ¼', 'æ¥­å‹™åº•åƒ¹', 'VIPåƒ¹', 'æ•´ä»¶åƒ¹', 'ç”Ÿæ„åƒ¹', 'é¤å»³90%', 'æœƒå“¡95%', 'é–€å¸‚å”®åƒ¹', 'ç‹€æ…‹']
                          ];
                          
                          grouped.forEach(function(group) {
                            group.items.forEach(function(p) {
                              const rawPrices = editedPrices[p.id] || p.prices || {};
                              const prices = {};
                              Object.keys(rawPrices).forEach(function(k) {
                                let normalizedKey = k.replace(/\s+/g, '').replace(/\(.*\)/g, '');
                                if (normalizedKey.includes('VIP')) normalizedKey = 'VIPåƒ¹';
                                if (normalizedKey.includes('æ•´ä»¶')) normalizedKey = 'æ•´ä»¶åƒ¹';
                                prices[normalizedKey] = rawPrices[k];
                              });
                              const isNew = p.isNew || (productStatusEdits[p.id]?.isNew);
                              const isPromo = p.isPromo || (productStatusEdits[p.id]?.isPromo);
                              const priceChange = p.priceChange || 0;
                              let status = '';
                              if (isNew) status += 'æ–° ';
                              if (isPromo) status += 'ä¿ƒ ';
                              if (priceChange > 0) status += 'â–²';
                              if (priceChange < 0) status += 'â–¼';
                              wsData.push([
                                p.displayName || p.name || '',
                                p.specDetail || '',
                                prices['æ¥­å‹™åº•åƒ¹'] || '',
                                prices['VIPåƒ¹'] || '',
                                prices['æ•´ä»¶åƒ¹'] || '',
                                prices['ç”Ÿæ„åƒ¹'] || '',
                                prices['é¤å»³90%'] || '',
                                prices['æœƒå“¡95%'] || '',
                                prices['é–€å¸‚å”®åƒ¹'] || '',
                                status.trim()
                              ]);
                            });
                          });
                          
                          const wb = XLSX.utils.book_new();
                          const ws = XLSX.utils.aoa_to_sheet(wsData);
                          ws['!cols'] = [{wch:18},{wch:24},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:6}];
                          XLSX.utils.book_append_sheet(wb, ws, 'å ±åƒ¹è¡¨');
                          XLSX.writeFile(wb, 'å ±åƒ¹è¡¨_' + categoryName + '_' + dateStr + '.xlsx');
                        }}
                        className="py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-xs font-bold shadow-md flex items-center justify-center gap-1"
                      >
                        <span>ğŸ“Š</span> Excel
                      </button>
                    </div>
                  </div>
                  
                  {/* ===== é›»è…¦ç‰ˆ UI (åŸæœ‰è¨­è¨ˆ) ===== */}
                  <div className="hidden lg:flex flex-row gap-6 w-full">
                  {/* å·¦æ¬„ï¼šè¨­å®šé¸é … (30%) */}
                  <div className="w-full lg:w-[30%] space-y-4 flex-shrink-0">
                    <div className="glass card-shadow p-5 rounded-2xl">
                      <h3 className="text-xl font-bold mb-4 flex items-center gap-2">ğŸ’° æ”¹åƒ¹ç™¼å¸ƒ</h3>
                      
                      {/* å·²ä¿®æ”¹æ•¸é‡ */}
                      {Object.keys(editedPrices).length > 0 && (
                        <div className="mb-4 p-3 bg-orange-50 border-2 border-orange-200 rounded-xl">
                          <div className="flex items-center justify-between">
                            <span className="text-orange-700 font-bold">å¾…å„²å­˜è®Šæ›´</span>
                            <span className="bg-orange-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">{Object.keys(editedPrices).length} é …</span>
                          </div>
                        </div>
                      )}
                      
                      {/* ä¸»åˆ†é¡é¸æ“‡ */}
                      <div className="mb-4">
                        <label className="text-sm text-gray-600 mb-2 block font-bold">ç”¢å“åˆ†é¡</label>
                        <div className="flex gap-2 flex-wrap">
                          {mainCategories.map(cat => (
                            <button 
                              key={cat.key}
                              onClick={() => setPublishCategory(cat.key)}
                              className={`px-3 py-2 rounded-lg text-sm font-bold transition-all ${
                                getCurrentMainCat() === cat.key 
                                  ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-md' 
                                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                              }`}
                            >
                              {cat.icon} {cat.label}
                            </button>
                          ))}
                        </div>
                      </div>
                      
                      {/* ç´°åˆ†é¡é¸æ“‡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰ */}
                      {getCurrentMainCat() !== 'all' && CATEGORY_CONFIG[getCurrentMainCat()]?.subs?.length > 0 && (
                        <div className="mb-5 p-3 bg-purple-50 rounded-xl">
                          <label className="text-xs text-purple-600 mb-2 block font-bold">
                            {CATEGORY_CONFIG[getCurrentMainCat()].name} ç´°åˆ†é¡
                          </label>
                          <div className="flex gap-2 flex-wrap">
                            <button 
                              onClick={() => setPublishCategory(getCurrentMainCat())}
                              className={subTabStyle(!getCurrentSubCat())}
                            >
                              å…¨éƒ¨
                            </button>
                            {CATEGORY_CONFIG[getCurrentMainCat()].subs.map(sub => (
                              <button 
                                key={sub}
                                onClick={() => setPublishCategory(getCurrentMainCat() + ':' + sub)}
                                className={subTabStyle(getCurrentSubCat() === sub)}
                              >
                                {sub}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                          
                      {/* æ—¥æœŸè¨­å®š */}
                      <div className="grid grid-cols-2 gap-4 mb-5">
                        <div>
                          <label className="text-sm text-gray-600 mb-2 block font-bold">ç”Ÿæ•ˆæ—¥</label>
                          <input type="date" id="publish-start-date" defaultValue={new Date().toISOString().split('T')[0]} className="w-full px-3 py-2.5 rounded-xl border-2 border-gray-200 focus:border-purple-500 outline-none text-base" />
                        </div>
                        <div>
                          <label className="text-sm text-gray-600 mb-2 block font-bold">æˆªæ­¢æ—¥</label>
                          <input type="date" id="publish-end-date" className="w-full px-3 py-2.5 rounded-xl border-2 border-gray-200 focus:border-purple-500 outline-none text-base" />
                        </div>
                      </div>
                      
                      {/* å‚™è¨» */}
                      <div className="mb-5">
                        <label className="text-sm text-gray-600 mb-2 block font-bold">å‚™è¨»èªªæ˜</label>
                        <input type="text" id="publish-remark" placeholder="ä¾‹å¦‚ï¼šåŸç‰©æ–™æˆæœ¬èª¿æ•´ã€å­£ç¯€é™å®š..." className="w-full px-3 py-2.5 rounded-xl border-2 border-gray-200 focus:border-purple-500 outline-none text-base" />
                      </div>
                      
                      {/* åœ–ä¾‹èªªæ˜ */}
                      <div className="p-4 bg-gray-50 rounded-xl mb-5">
                        <p className="text-sm text-gray-500 mb-2 font-medium">ç‹€æ…‹æ¨™ç±¤èªªæ˜</p>
                        <div className="flex gap-4 text-sm">
                          <span className="flex items-center gap-2">
                            <span className="w-5 h-5 bg-amber-500 rounded flex items-center justify-center text-white text-xs font-bold">æ–°</span>
                            <span>æ–°è²¨åˆ°</span>
                          </span>
                          <span className="flex items-center gap-2">
                            <span className="w-5 h-5 bg-purple-500 rounded flex items-center justify-center text-white text-xs font-bold">ä¿ƒ</span>
                            <span>ä¿ƒéŠ·ä¸­</span>
                          </span>
                        </div>
                      </div>
                      
                      {/* åŒ¯å‡ºæŒ‰éˆ• */}
                      <div className="space-y-3">
                        <p className="text-sm text-gray-500 mb-2 font-medium">åŒ¯å‡ºå®Œæ•´å ±åƒ¹å–®</p>
                            
                            {/* PDF å ±åƒ¹å–® - ç›´æ¥æˆªåœ–é è¦½è¡¨æ ¼ */}
                            <button 
                              onClick={async () => {
                                const products = getProductsByCategory();
                                if (products.length === 0) return alert('æ²’æœ‰ç”¢å“è³‡æ–™');
                                
                                const btn = event.target;
                                const originalText = btn.innerText;
                                btn.disabled = true;
                                btn.innerText = 'â³ ç”¢ç”Ÿä¸­...';
                                
                                try {
                                  const { jsPDF } = window.jspdf;
                                  const pdf = new jsPDF('l', 'mm', 'a4');
                                  const itemsPerPage = 15;
                                  const groupedProducts = getGroupedProducts();
                                  // å°‡åˆ†çµ„å±•å¹³ç‚ºåˆ—è¡¨ï¼Œä¸¦è¨ˆç®—æ¯çµ„çš„èµ·å§‹ä½ç½®
                                  let flatProducts = [];
                                  groupedProducts.forEach(function(group) {
                                    group.items.forEach(function(item, idx) {
                                      flatProducts.push({
                                        ...item,
                                        groupName: group.brandName,
                                        packSpec: group.packSpec,
                                        isFirstInGroup: idx === 0,
                                        groupSize: group.items.length
                                      });
                                    });
                                  });
                                  
                                  const totalPages = Math.ceil(flatProducts.length / itemsPerPage);
                                  const categoryName = getCategoryDisplayName();
                                  const dateStr = new Date().toLocaleDateString('zh-TW');
                                  
                                  // è®€å–æ™‚é–“å€é–“å’Œå‚™è¨»
                                  const startDateEl = document.getElementById('publish-start-date');
                                  const endDateEl = document.getElementById('publish-end-date');
                                  const remarkEl = document.getElementById('publish-remark');
                                  const startDate = startDateEl?.value ? new Date(startDateEl.value).toLocaleDateString('zh-TW') : '';
                                  const endDate = endDateEl?.value ? new Date(endDateEl.value).toLocaleDateString('zh-TW') : '';
                                  const publishRemark = remarkEl?.value || '';
                                  const dateRange = startDate && endDate ? startDate + ' ~ ' + endDate : (startDate || dateStr);
                                  
                                  for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                                    btn.innerText = 'â³ ' + (pageNum + 1) + '/' + totalPages + ' é ...';
                                    
                                    if (pageNum > 0) pdf.addPage();
                                    
                                    const startIdx = pageNum * itemsPerPage;
                                    const pageProducts = flatProducts.slice(startIdx, startIdx + itemsPerPage);
                                    
                                    // å»ºç«‹éš±è—å®¹å™¨
                                    const container = document.createElement('div');
                                    container.style.cssText = 'position:absolute;left:-9999px;width:1100px;background:white;';
                                    document.body.appendChild(container);
                                    
                                    // å»ºç«‹è¡¨æ ¼ HTMLï¼ˆåˆ†çµ„é¡¯ç¤ºï¼‰
                                    let tableRows = '';
                                    let currentGroup = '';
                                    let groupRowCount = 0;
                                    let lastGroupName = '';
                                    
                                    pageProducts.forEach(function(p, i) {
                                      const isNew = p.isNew || (productStatusEdits[p.id] && productStatusEdits[p.id].isNew);
                                      const isPromo = p.isPromo || (productStatusEdits[p.id] && productStatusEdits[p.id].isPromo);
                                      const remarkText = productRemarks[p.id] || p.remark || '';
                                      const rawPrices = editedPrices[p.id] || p.prices || {};
                                      // æ¨™æº–åŒ–åƒ¹æ ¼ keyï¼ˆè™•ç†ç©ºæ ¼å’Œæ‹¬è™Ÿï¼‰
                                      const prices = {};
                                      Object.keys(rawPrices).forEach(function(k) {
                                        let normalizedKey = k.replace(/\s+/g, '').replace(/\(.*\)/g, '');
                                        if (normalizedKey.includes('VIP')) normalizedKey = 'VIPåƒ¹';
                                        if (normalizedKey.includes('æ•´ä»¶')) normalizedKey = 'æ•´ä»¶åƒ¹';
                                        prices[normalizedKey] = rawPrices[k];
                                      });
                                      const isNewGroup = p.groupName !== lastGroupName;
                                      
                                      if (isNewGroup) {
                                        lastGroupName = p.groupName;
                                        groupRowCount = 0;
                                      }
                                      const bgColor = groupRowCount % 2 ? '#f8f9fa' : 'white';
                                      groupRowCount++;
                                      
                                      const statusHtml = (isNew ? '<span style="background:#f59e0b;color:white;font-size:10px;padding:2px 5px;border-radius:3px;margin-right:2px;">æ–°</span>' : '') +
                                                        (isPromo ? '<span style="background:#10b981;color:white;font-size:10px;padding:2px 5px;border-radius:3px;">ä¿ƒ</span>' : '');
                                      
                                      // æ¯è¡Œé¡¯ç¤ºå“åå’Œè¦æ ¼ï¼ˆè¶…å‡ºæˆªæ–·ï¼‰
                                      tableRows += '<tr style="background:' + bgColor + ';border-bottom:1px solid #e5e7eb;height:36px;">' +
                                        '<td style="padding:6px 8px;font-size:13px;color:#000;font-weight:bold;vertical-align:middle;border-right:1px solid #eee;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0;">' + (p.displayName || p.groupName || '-') + '</td>' +
                                        '<td style="padding:6px 8px;text-align:left;font-size:12px;color:#444;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0;">' + (p.originalSpec || p.specDetail || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['æ¥­å‹™åº•åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['VIPåƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#7c3aed;font-weight:bold;">' + (prices['æ•´ä»¶åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['ç”Ÿæ„åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['é¤å»³90%'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['æœƒå“¡95%'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#ea580c;">' + (prices['é–€å¸‚å”®åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px;text-align:center;">' + statusHtml + '</td>' +
                                        '<td style="padding:4px 6px;text-align:left;font-size:11px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0;">' + remarkText + '</td>' +
                                        '</tr>';
                                    });
                                    
                                    // å›ºå®šæ¬„å¯¬è¨­å®šï¼ˆç™¾åˆ†æ¯”ï¼Œç¸½è¨ˆ100%ï¼‰- PDFç‰ˆ
                                    const colWidths = {
                                      name: '14%',      // å“å
                                      spec: '20%',      // è¦æ ¼ï¼ˆåŠ å¤§ï¼‰
                                      price1: '7%',     // æ¥­å‹™åº•åƒ¹
                                      price2: '7%',     // VIPåƒ¹
                                      price3: '8%',     // æ•´ä»¶åƒ¹
                                      price4: '7%',     // ç”Ÿæ„åƒ¹
                                      price5: '7%',     // é¤å»³90%
                                      price6: '7%',     // æœƒå“¡95%
                                      price7: '7%',     // é–€å¸‚å”®åƒ¹
                                      status: '5%',     // ç‹€æ…‹
                                      remark: '11%'     // å‚™è¨»
                                    };

                                    
                                    container.innerHTML = '<div style="padding:10px;font-family:-apple-system,Microsoft JhengHei,sans-serif;background:white;">' +
                                      '<div style="background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;padding:12px 20px;border-radius:8px 8px 0 0;">' +
                                        '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                                          '<div style="font-size:28px;font-weight:bold;letter-spacing:2px;">å…«æ–¹ç’°çƒ</div>' +
                                          '<div style="font-size:14px;opacity:0.9;">ç¬¬ ' + (pageNum+1) + ' / ' + totalPages + ' é </div>' +
                                        '</div>' +
                                        '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">' +
                                          '<div style="font-size:16px;font-weight:bold;">ğŸ“¦ ' + categoryName + '</div>' +
                                          '<div style="font-size:14px;background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:4px;">ğŸ“… ' + dateRange + '</div>' +
                                        '</div>' +
                                        (publishRemark ? '<div style="margin-top:8px;font-size:12px;opacity:0.85;">ğŸ“ ' + publishRemark + '</div>' : '') +
                                      '</div>' +
                                      '<table style="width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid #ddd;">' +
                                        '<colgroup>' +
                                          '<col style="width:' + colWidths.name + '">' +
                                          '<col style="width:' + colWidths.spec + '">' +
                                          '<col style="width:' + colWidths.price1 + '">' +
                                          '<col style="width:' + colWidths.price2 + '">' +
                                          '<col style="width:' + colWidths.price3 + '">' +
                                          '<col style="width:' + colWidths.price4 + '">' +
                                          '<col style="width:' + colWidths.price5 + '">' +
                                          '<col style="width:' + colWidths.price6 + '">' +
                                          '<col style="width:' + colWidths.price7 + '">' +
                                          '<col style="width:' + colWidths.status + '">' +
                                          '<col style="width:' + colWidths.remark + '">' +
                                        '</colgroup>' +
                                        '<thead><tr style="background:#f3f4f6;color:#000;height:40px;">' +
                                          '<th style="padding:8px;text-align:left;font-weight:bold;border-bottom:2px solid #ccc;font-size:13px;">å“å</th>' +
                                          '<th style="padding:8px;text-align:left;font-weight:bold;border-bottom:2px solid #ccc;font-size:13px;">è¦æ ¼</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">æ¥­å‹™åº•åƒ¹</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">VIP(ä¸­ç›¤)</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;color:#7c3aed;">æ•´ä»¶(10ä»¶â†“)</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">ç”Ÿæ„åƒ¹</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">é¤å»³90%</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">æœƒå“¡95%</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;color:#ea580c;">é–€å¸‚å”®åƒ¹</th>' +
                                          '<th style="padding:4px;text-align:center;font-weight:bold;border-bottom:2px solid #ccc;font-size:11px;">ç‹€æ…‹</th>' +
                                          '<th style="padding:6px;text-align:left;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">å‚™è¨»</th>' +
                                        '</tr></thead>' +
                                        '<tbody>' + tableRows + '</tbody>' +
                                      '</table>' +
                                      '<div style="background:#f9fafb;padding:8px 12px;border:1px solid #ddd;border-top:none;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#888;">' +
                                        '<div style="display:flex;gap:12px;"><span style="color:#f97316;">â— æ–°å“</span><span style="color:#22c55e;">â— ä¿ƒéŠ·</span></div>' +
                                        '<div>å…«æ–¹ç’°çƒæ°´ç”¢ Â· æ¥­å‹™å°ˆç”¨</div>' +
                                      '</div>' +
                                    '</div>';
                                    
                                    await new Promise(function(r) { setTimeout(r, 100); });
                                    const canvas = await html2canvas(container.firstChild, { scale: 2, backgroundColor: '#ffffff' });
                                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                                    const imgWidth = 297;
                                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, Math.min(imgHeight, 210));
                                    
                                    document.body.removeChild(container);
                                  }
                                  
                                  pdf.save('å…«æ–¹ç’°çƒå ±åƒ¹è¡¨_' + categoryName + '_' + dateStr.replace(/\//g, '-') + '.pdf');
                                  btn.innerText = originalText;
                                  btn.disabled = false;
                                } catch (err) {
                                  console.error(err);
                                  alert('PDF ç”¢ç”Ÿå¤±æ•—ï¼š' + err.message);
                                  btn.innerText = originalText;
                                  btn.disabled = false;
                                }
                              }}
                              className="w-full py-3 rounded-xl bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white text-l4 font-bold shadow-lg transition-colors flex items-center justify-center gap-2"
                            >ğŸ“„ PDF å ±åƒ¹å–®ï¼ˆå®Œæ•´å¤šé ï¼‰</button>
                            
                            {/* å¤šå¼µåœ–ç‰‡ ZIP */}
                            <button 
                              onClick={async () => {
                                const products = getProductsByCategory();
                                if (products.length === 0) return alert('æ²’æœ‰ç”¢å“è³‡æ–™');
                                
                                const btn = event.target;
                                const originalText = btn.innerText;
                                btn.disabled = true;
                                btn.innerText = 'â³ é–‹å§‹...';
                                
                                try {
                                  const zip = new JSZip();
                                  const itemsPerPage = 15;
                                  
                                  // ä½¿ç”¨åˆ†çµ„è³‡æ–™è¨ˆç®—ç¸½æ•¸
                                  const groupedProducts = getGroupedProducts();
                                  let allFlatProducts = [];
                                  groupedProducts.forEach(function(group) {
                                    group.items.forEach(function(item, idx) {
                                      allFlatProducts.push({
                                        ...item,
                                        groupName: group.brandName,
                                        packSpec: group.packSpec,
                                        isFirstInGroup: idx === 0,
                                        groupSize: group.items.length
                                      });
                                    });
                                  });
                                  
                                  const totalPages = Math.ceil(allFlatProducts.length / itemsPerPage);
                                  const categoryName = getCategoryDisplayName();
                                  const dateStr = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
                                  
                                  // è®€å–æ™‚é–“å€é–“å’Œå‚™è¨»
                                  const startDateEl = document.getElementById('publish-start-date');
                                  const endDateEl = document.getElementById('publish-end-date');
                                  const remarkEl = document.getElementById('publish-remark');
                                  const startDate = startDateEl?.value ? new Date(startDateEl.value).toLocaleDateString('zh-TW') : '';
                                  const endDate = endDateEl?.value ? new Date(endDateEl.value).toLocaleDateString('zh-TW') : '';
                                  const publishRemark = remarkEl?.value || '';
                                  const dateRange = startDate && endDate ? startDate + ' ~ ' + endDate : (startDate || new Date().toLocaleDateString('zh-TW'));
                                  
                                  for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                                    btn.innerText = 'â³ ' + (pageNum + 1) + '/' + totalPages + ' å¼µ...';
                                    
                                    const startIdx = pageNum * itemsPerPage;
                                    
                                    // å»ºç«‹éš±è—å®¹å™¨
                                    const container = document.createElement('div');
                                    container.style.cssText = 'position:absolute;left:-9999px;width:1100px;background:white;';
                                    document.body.appendChild(container);
                                    
                                    const pageProducts = allFlatProducts.slice(startIdx, startIdx + itemsPerPage);
                                    
                                    // å»ºç«‹è¡¨æ ¼ HTMLï¼ˆåˆ†çµ„é¡¯ç¤ºï¼‰
                                    let tableRows = '';
                                    let currentGroup = '';
                                    let groupRowCount = 0;
                                    
                                    pageProducts.forEach(function(p, i) {
                                      const isNew = p.isNew || (productStatusEdits[p.id] && productStatusEdits[p.id].isNew);
                                      const isPromo = p.isPromo || (productStatusEdits[p.id] && productStatusEdits[p.id].isPromo);
                                      const remarkText = productRemarks[p.id] || p.remark || '';
                                      const rawPrices = editedPrices[p.id] || p.prices || {};
                                      // æ¨™æº–åŒ–åƒ¹æ ¼ keyï¼ˆè™•ç†ç©ºæ ¼å’Œæ‹¬è™Ÿï¼‰
                                      const prices = {};
                                      Object.keys(rawPrices).forEach(function(k) {
                                        let normalizedKey = k.replace(/\s+/g, '').replace(/\(.*\)/g, '');
                                        if (normalizedKey.includes('VIP')) normalizedKey = 'VIPåƒ¹';
                                        if (normalizedKey.includes('æ•´ä»¶')) normalizedKey = 'æ•´ä»¶åƒ¹';
                                        prices[normalizedKey] = rawPrices[k];
                                      });
                                      const isNewGroup = p.groupName !== currentGroup;
                                      if (isNewGroup) {
                                        currentGroup = p.groupName;
                                        groupRowCount = 0;
                                      }
                                      const bgColor = groupRowCount % 2 ? '#f8f9fa' : 'white';
                                      groupRowCount++;
                                      
                                      const statusHtml = (isNew ? '<span style="background:#f59e0b;color:white;font-size:10px;padding:2px 5px;border-radius:3px;margin-right:2px;">æ–°</span>' : '') +
                                                        (isPromo ? '<span style="background:#10b981;color:white;font-size:10px;padding:2px 5px;border-radius:3px;">ä¿ƒ</span>' : '');
                                      
                                      // æ¯è¡Œé¡¯ç¤ºå“åå’Œè¦æ ¼ï¼ˆè¶…å‡ºæˆªæ–·ï¼‰- ZIPç‰ˆ
                                      tableRows += '<tr style="background:' + bgColor + ';border-bottom:1px solid #e5e7eb;height:36px;">' +
                                        '<td style="padding:6px 8px;font-size:13px;color:#000;font-weight:bold;vertical-align:middle;border-right:1px solid #eee;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0;">' + (p.displayName || p.groupName || '-') + '</td>' +
                                        '<td style="padding:6px 8px;text-align:left;font-size:12px;color:#444;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0;">' + (p.originalSpec || p.specDetail || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['æ¥­å‹™åº•åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['VIPåƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#7c3aed;font-weight:bold;">' + (prices['æ•´ä»¶åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['ç”Ÿæ„åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['é¤å»³90%'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#000;">' + (prices['æœƒå“¡95%'] || '-') + '</td>' +
                                        '<td style="padding:4px 6px;text-align:right;font-size:13px;color:#ea580c;">' + (prices['é–€å¸‚å”®åƒ¹'] || '-') + '</td>' +
                                        '<td style="padding:4px;text-align:center;">' + statusHtml + '</td>' +
                                        '<td style="padding:4px 6px;text-align:left;font-size:11px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0;">' + remarkText + '</td>' +
                                        '</tr>';
                                    });
                                    
                                    // å›ºå®šæ¬„å¯¬è¨­å®šï¼ˆç™¾åˆ†æ¯”ï¼Œç¸½è¨ˆ100%ï¼‰- ZIPç‰ˆ
                                    const colWidths = {
                                      name: '14%',      // å“å
                                      spec: '20%',      // è¦æ ¼ï¼ˆåŠ å¤§ï¼‰
                                      price1: '7%',     // æ¥­å‹™åº•åƒ¹
                                      price2: '7%',     // VIPåƒ¹
                                      price3: '8%',     // æ•´ä»¶åƒ¹
                                      price4: '7%',     // ç”Ÿæ„åƒ¹
                                      price5: '7%',     // é¤å»³90%
                                      price6: '7%',     // æœƒå“¡95%
                                      price7: '7%',     // é–€å¸‚å”®åƒ¹
                                      status: '5%',     // ç‹€æ…‹
                                      remark: '11%'     // å‚™è¨»
                                    };

                                    
                                    container.innerHTML = '<div style="padding:10px;font-family:-apple-system,Microsoft JhengHei,sans-serif;background:white;">' +
                                      '<div style="background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;padding:12px 20px;border-radius:8px 8px 0 0;">' +
                                        '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                                          '<div style="font-size:28px;font-weight:bold;letter-spacing:2px;">å…«æ–¹ç’°çƒ</div>' +
                                          '<div style="font-size:14px;opacity:0.9;">ç¬¬ ' + (pageNum+1) + ' / ' + totalPages + ' é </div>' +
                                        '</div>' +
                                        '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">' +
                                          '<div style="font-size:16px;font-weight:bold;">ğŸ“¦ ' + categoryName + '</div>' +
                                          '<div style="font-size:14px;background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:4px;">ğŸ“… ' + dateRange + '</div>' +
                                        '</div>' +
                                        (publishRemark ? '<div style="margin-top:8px;font-size:12px;opacity:0.85;">ğŸ“ ' + publishRemark + '</div>' : '') +
                                      '</div>' +
                                      '<table style="width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid #ddd;">' +
                                        '<colgroup>' +
                                          '<col style="width:' + colWidths.name + '">' +
                                          '<col style="width:' + colWidths.spec + '">' +
                                          '<col style="width:' + colWidths.price1 + '">' +
                                          '<col style="width:' + colWidths.price2 + '">' +
                                          '<col style="width:' + colWidths.price3 + '">' +
                                          '<col style="width:' + colWidths.price4 + '">' +
                                          '<col style="width:' + colWidths.price5 + '">' +
                                          '<col style="width:' + colWidths.price6 + '">' +
                                          '<col style="width:' + colWidths.price7 + '">' +
                                          '<col style="width:' + colWidths.status + '">' +
                                          '<col style="width:' + colWidths.remark + '">' +
                                        '</colgroup>' +
                                        '<thead><tr style="background:#f3f4f6;color:#000;height:40px;">' +
                                          '<th style="padding:8px;text-align:left;font-weight:bold;border-bottom:2px solid #ccc;font-size:13px;">å“å</th>' +
                                          '<th style="padding:8px;text-align:left;font-weight:bold;border-bottom:2px solid #ccc;font-size:13px;">è¦æ ¼</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">æ¥­å‹™åº•åƒ¹</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">VIP(ä¸­ç›¤)</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;color:#7c3aed;">æ•´ä»¶(10ä»¶â†“)</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">ç”Ÿæ„åƒ¹</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">é¤å»³90%</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">æœƒå“¡95%</th>' +
                                          '<th style="padding:6px;text-align:right;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;color:#ea580c;">é–€å¸‚å”®åƒ¹</th>' +
                                          '<th style="padding:4px;text-align:center;font-weight:bold;border-bottom:2px solid #ccc;font-size:11px;">ç‹€æ…‹</th>' +
                                          '<th style="padding:6px;text-align:left;font-weight:bold;border-bottom:2px solid #ccc;font-size:12px;">å‚™è¨»</th>' +
                                        '</tr></thead>' +
                                        '<tbody>' + tableRows + '</tbody>' +
                                      '</table>' +
                                      '<div style="background:#f9fafb;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#888;">' +
                                        '<div style="display:flex;gap:12px;"><span style="color:#f97316;">â— æ–°å“</span><span style="color:#22c55e;">â— ä¿ƒéŠ·</span></div>' +
                                        '<div>å…«æ–¹ç’°çƒæ°´ç”¢ Â· æ¥­å‹™å°ˆç”¨</div>' +
                                      '</div>' +
                                    '</div>';
                                    
                                    await new Promise(function(r) { setTimeout(r, 150); });
                                    
                                    // æ›´æ–°é€²åº¦
                                    btn.innerText = 'ğŸ–¼ï¸ ' + (pageNum + 1) + '/' + totalPages + ' å¼µ...';
                                    
                                    const canvas = await html2canvas(container.firstChild, { scale: 2, backgroundColor: '#ffffff' });
                                    
                                    // è½‰ç‚º JPG base64
                                    const imgData = canvas.toDataURL('image/jpeg', 0.92).replace(/^data:image\/jpeg;base64,/, '');
                                    const fileName = 'å ±åƒ¹è¡¨_' + categoryName + '_ç¬¬' + String(pageNum + 1).padStart(2, '0') + 'é .jpg';
                                    zip.file(fileName, imgData, { base64: true });
                                    
                                    // é‡‹æ”¾è¨˜æ†¶é«”
                                    document.body.removeChild(container);
                                    canvas.width = 0;
                                    canvas.height = 0;
                                  }
                                  
                                  btn.innerText = 'â³ æ‰“åŒ…ä¸­...';
                                  const content = await zip.generateAsync({ type: 'blob' });
                                  const link = document.createElement('a');
                                  link.href = URL.createObjectURL(content);
                                  link.download = 'å…«æ–¹ç’°çƒå ±åƒ¹è¡¨_' + categoryName + '_' + dateStr + '.zip';
                                  link.click();
                                  URL.revokeObjectURL(link.href);
                                  
                                  btn.innerText = originalText;
                                  btn.disabled = false;
                                } catch (err) {
                                  console.error(err);
                                  alert('åœ–ç‰‡æ‰“åŒ…å¤±æ•—ï¼š' + err.message);
                                  btn.innerText = originalText;
                                  btn.disabled = false;
                                }
                              }}
                              className="w-full py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white text-l4 font-bold shadow-lg transition-colors flex items-center justify-center gap-2"
                            >ğŸ–¼ï¸ JPG åœ–ç‰‡åŒ…ï¼ˆå¤šå¼µåˆ†é ï¼‰</button>
                            
                            {/* Excel åŒ¯å‡º */}
                            <button 
                              onClick={() => {
                                const grouped = getGroupedProducts();
                                if (grouped.length === 0) return alert('æ²’æœ‰ç”¢å“è³‡æ–™');
                                
                                const categoryName = getCategoryDisplayName();
                                const dateStr = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
                                
                                // è®€å–æ™‚é–“å€é–“å’Œå‚™è¨»
                                const startDateEl = document.getElementById('publish-start-date');
                                const endDateEl = document.getElementById('publish-end-date');
                                const remarkEl = document.getElementById('publish-remark');
                                const startDate = startDateEl?.value ? new Date(startDateEl.value).toLocaleDateString('zh-TW') : '';
                                const endDate = endDateEl?.value ? new Date(endDateEl.value).toLocaleDateString('zh-TW') : '';
                                const publishRemark = remarkEl?.value || '';
                                const dateRange = startDate && endDate ? startDate + ' ~ ' + endDate : (startDate || new Date().toLocaleDateString('zh-TW'));
                                
                                const wsData = [
                                  ['å…«æ–¹ç’°çƒ å…§éƒ¨å ±åƒ¹è¡¨'],
                                  ['åˆ†é¡: ' + categoryName, 'æœ‰æ•ˆæœŸé–“: ' + dateRange],
                                  publishRemark ? ['å‚™è¨»: ' + publishRemark] : [],
                                  [],
                                  ['å“å', 'è¦æ ¼', 'æ¥­å‹™åº•åƒ¹', 'VIPåƒ¹(ä¸­ç›¤)', 'æ•´ä»¶åƒ¹(10ä»¶ä»¥ä¸‹)', 'ç”Ÿæ„åƒ¹', 'é¤å»³90%', 'æœƒå“¡95%', 'é–€å¸‚å”®åƒ¹', 'ç‹€æ…‹', 'å‚™è¨»']
                                ].filter(row => row.length > 0);
                                
                                grouped.forEach(function(group) {
                                  group.items.forEach(function(p, idx) {
                                    const isNew = p.isNew || (productStatusEdits[p.id] && productStatusEdits[p.id].isNew);
                                    const isPromo = p.isPromo || (productStatusEdits[p.id] && productStatusEdits[p.id].isPromo);
                                    const rawPrices = editedPrices[p.id] || p.prices || {};
                                    // æ¨™æº–åŒ–åƒ¹æ ¼ keyï¼ˆè™•ç†ç©ºæ ¼å’Œæ‹¬è™Ÿï¼‰
                                    const prices = {};
                                    Object.keys(rawPrices).forEach(function(k) {
                                      let normalizedKey = k.replace(/\s+/g, '').replace(/\(.*\)/g, '');
                                      if (normalizedKey.includes('VIP')) normalizedKey = 'VIPåƒ¹';
                                      if (normalizedKey.includes('æ•´ä»¶')) normalizedKey = 'æ•´ä»¶åƒ¹';
                                      prices[normalizedKey] = rawPrices[k];
                                    });
                                    const remarkText = productRemarks[p.id] || p.remark || '';
                                    const priceChange = p.priceChange || 0;
                                    let status = '';
                                    if (isNew) status += 'æ–° ';
                                    if (isPromo) status += 'ä¿ƒ ';
                                    if (priceChange > 0) status += 'â–²';
                                    if (priceChange < 0) status += 'â–¼';
                                    
                                    // æ¯è¡Œé¡¯ç¤ºå®Œæ•´å“åå’Œè¦æ ¼
                                    wsData.push([
                                      p.displayName || p.name || '',
                                      p.specDetail || p.originalSpec || '',
                                      prices['æ¥­å‹™åº•åƒ¹'] || '',
                                      prices['VIPåƒ¹'] || '',
                                      prices['æ•´ä»¶åƒ¹'] || '',
                                      prices['ç”Ÿæ„åƒ¹'] || '',
                                      prices['é¤å»³90%'] || '',
                                      prices['æœƒå“¡95%'] || '',
                                      prices['é–€å¸‚å”®åƒ¹'] || '',
                                      status.trim(),
                                      remarkText
                                    ]);
                                  });
                                });
                                
                                const wb = XLSX.utils.book_new();
                                const ws = XLSX.utils.aoa_to_sheet(wsData);
                                ws['!cols'] = [
                                  { wch: 22 }, { wch: 28 }, { wch: 10 }, { wch: 12 }, { wch: 14 }, 
                                  { wch: 8 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 6 }, { wch: 20 }
                                ];
                                XLSX.utils.book_append_sheet(wb, ws, 'å ±åƒ¹è¡¨');
                                XLSX.writeFile(wb, 'å…«æ–¹ç’°çƒå ±åƒ¹è¡¨_' + categoryName + '_' + dateStr + '.xlsx');
                              }}
                              className="w-full py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-l4 font-bold shadow-lg transition-colors flex items-center justify-center gap-2"
                            >ğŸ“Š Excel å ±åƒ¹è¡¨ï¼ˆå®Œæ•´è³‡æ–™ï¼‰</button>
                            
                            {/* å„²å­˜è®Šæ›´æŒ‰éˆ• */}
                            {Object.keys(editedPrices).length > 0 && (
                              <button 
                                onClick={() => {
                                  if (!confirm(`ç¢ºå®šè¦å„²å­˜ ${Object.keys(editedPrices).length} é …åƒ¹æ ¼ä¿®æ”¹å—ï¼Ÿ`)) return;
                                  
                                  const newProducts = { ...data.products };
                                  Object.entries(editedPrices).forEach(([pid, prices]) => {
                                    Object.entries(newProducts).forEach(([name, specs]) => {
                                      if (Array.isArray(specs)) {
                                        specs.forEach((spec, idx) => {
                                          if (spec.id === pid) {
                                            // è¨ˆç®—æ¼²è·Œåƒ¹ï¼ˆä»¥ VIPåƒ¹ ç‚ºåŸºæº–ï¼‰
                                            const oldVIP = spec.prices?.['VIPåƒ¹'] || spec.prices?.['VIP åƒ¹'] || 0;
                                            const newVIP = prices['VIPåƒ¹'] ?? prices['VIP åƒ¹'] ?? oldVIP;
                                            let priceChange = 0;
                                            if (newVIP > oldVIP) priceChange = 1;  // æ¼²åƒ¹
                                            if (newVIP < oldVIP) priceChange = -1; // é™åƒ¹
                                            
                                            // ä¿å­˜æ–°åƒ¹æ ¼å’Œæ¼²è·Œç‹€æ…‹
                                            newProducts[name][idx].prices = { ...spec.prices, ...prices };
                                            newProducts[name][idx].priceChange = priceChange;
                                            newProducts[name][idx].lastVIPPrice = oldVIP; // ä¿å­˜èˆŠåƒ¹æ ¼ä¾›åƒè€ƒ
                                            
                                            if (productStatusEdits[pid]) {
                                              if (productStatusEdits[pid].isNew) newProducts[name][idx].isNew = true;
                                              if (productStatusEdits[pid].isPromo) newProducts[name][idx].isPromo = true;
                                            }
                                          }
                                        });
                                      }
                                    });
                                  });
                                  
                                  uploadDB({ 
                                    productDB: newProducts,
                                    dbMeta: { 
                                      ...(data.meta || {}), 
                                      priceEditDate: new Date().toLocaleString('zh-TW'),
                                      lastUpdate: new Date().toISOString()
                                    }
                                  });
                                  
                                  setEditedPrices({});
                                  setProductStatusEdits({});
                                }}
                                className="w-full py-4 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white text-l3 font-bold shadow-lg transition-colors flex items-center justify-center gap-2 mt-4"
                              >
                                ğŸ’¾ å„²å­˜ {Object.keys(editedPrices).length} é …è®Šæ›´åˆ°é›²ç«¯
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                      
                      {/* å³æ¬„ï¼šå ±åƒ¹è¡¨é è¦½ (70%) */}
                      <div className="w-full lg:w-[70%] glass card-shadow p-5 rounded-2xl">
                        <div id="priceTableCapture" className="bg-white rounded-xl overflow-hidden shadow-lg">
                          {/* å ±åƒ¹è¡¨é ­éƒ¨ */}
                          <div className="bg-gradient-to-r from-purple-600 via-indigo-600 to-purple-700 text-white p-4">
                            <div className="flex justify-between items-start">
                              <div>
                                <h2 className="text-2xl font-black tracking-wide">å…«æ–¹ç’°çƒ</h2>
                                <p className="text-purple-200 text-sm mt-1">å…§éƒ¨å ±åƒ¹è¡¨ Â· æ¥­å‹™å°ˆç”¨</p>
                              </div>
                              <div className="text-right">
                                <div className="bg-white/20 rounded-lg px-3 py-1.5 inline-block">
                                  <span className="text-xs text-purple-200">ç™¼å¸ƒæ—¥æœŸ</span>
                                  <div className="font-bold">{new Date().toLocaleDateString('zh-TW')}</div>
                                </div>
                              </div>
                            </div>
                            {/* åˆ†é¡æ¨™ç±¤ */}
                            <div className="mt-3 flex items-center gap-2">
                              <span className="bg-white/20 text-white text-xs px-2 py-1 rounded">
                                ğŸ“¦ {getCategoryDisplayName()}
                              </span>
                              <span className="bg-amber-400/80 text-white text-xs px-2 py-1 rounded">
                                å…± {getProductsByCategory().length} é …
                              </span>
                            </div>
                          </div>
                          
                          {/* è¡¨æ ¼å€åŸŸ */}
                          <div className="p-4">
                            <table className="w-full table-fixed" style={{borderCollapse: 'collapse'}}>
                              <thead>
                                <tr className="bg-gray-100 text-gray-800" style={{height: '44px'}}>
                                  <th className="p-2 text-left font-bold rounded-l-lg border-b-2 border-gray-300 text-sm" style={{width: '18%'}}>å“å</th>
                                  <th className="p-2 text-left font-bold border-b-2 border-gray-300 text-sm" style={{width: '14%'}}>è¦æ ¼</th>
                                  <th className="p-2 text-right font-bold border-b-2 border-gray-300 text-xs" style={{width: '8%'}}>æ¥­å‹™åº•åƒ¹</th>
                                  <th className="p-2 text-right font-bold border-b-2 border-gray-300 text-xs" style={{width: '9%'}}>VIP(ä¸­ç›¤)</th>
                                  <th className="p-2 text-right font-bold border-b-2 border-gray-300 text-xs text-purple-700" style={{width: '10%'}}>æ•´ä»¶(10ä»¶â†“)</th>
                                  <th className="p-2 text-right font-bold border-b-2 border-gray-300 text-xs" style={{width: '8%'}}>ç”Ÿæ„åƒ¹</th>
                                  <th className="p-2 text-right font-bold border-b-2 border-gray-300 text-xs" style={{width: '8%'}}>é¤å»³90%</th>
                                  <th className="p-2 text-right font-bold border-b-2 border-gray-300 text-xs" style={{width: '8%'}}>æœƒå“¡95%</th>
                                  <th className="p-2 text-right font-bold border-b-2 border-gray-300 text-xs" style={{width: '8%', color: '#ea580c'}}>é–€å¸‚å”®åƒ¹</th>
                                  <th className="p-2 text-center font-bold border-b-2 border-gray-300 text-xs" style={{width: '5%'}}>ç‹€æ…‹</th>
                                  <th className="p-2 text-left font-bold rounded-r-lg border-b-2 border-gray-300 text-xs" style={{width: '4%'}}>å‚™è¨»</th>
                                </tr>
                              </thead>
                              <tbody>
                                {(() => {
                                  const grouped = getGroupedProducts();
                                  if (grouped.length === 0) {
                                    return (
                                      <tr><td colSpan="11" className="p-8 text-center text-gray-400">
                                        <div className="text-3xl mb-2">ğŸ“¦</div>
                                        <div>æ­¤åˆ†é¡æ²’æœ‰ç”¢å“</div>
                                      </td></tr>
                                    );
                                  }
                                  
                                  let rows = [];
                                  
                                  grouped.forEach((group, gIdx) => {
                                    const itemsToShow = group.items.length;
                                    
                                    group.items.forEach((p, idx) => {
                                      const statusEdit = productStatusEdits[p.id] || {};
                                      const isNew = p.isNew || statusEdit.isNew;
                                      const isPromo = p.isPromo || statusEdit.isPromo;
                                      const priceChange = p.priceChange || 0;
                                      const isFirstInGroup = idx === 0;
                                      
                                      // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—åƒ¹æ ¼ï¼ˆæ”¯æ´å¤šç¨® key æ ¼å¼ï¼‰
                                      const getPrice = (keys) => {
                                        const rawPrices = editedPrices[p.id] || p.prices || {};
                                        for (const k of keys) {
                                          if (rawPrices[k] !== undefined && rawPrices[k] !== null && rawPrices[k] !== '') return rawPrices[k];
                                        }
                                        return '-';
                                      };
                                      
                                      rows.push(
                                        <tr key={p.id} style={{height: '40px'}} className={`border-b border-gray-200 hover:bg-purple-50 cursor-pointer ${isNew ? 'bg-amber-50' : isPromo ? 'bg-purple-50' : idx % 2 ? 'bg-gray-50/50' : ''}`} onClick={() => openPriceEditor(p, 0)}>
                                          <td className="p-2 align-middle border-r border-gray-200 text-sm font-bold text-gray-900 truncate" title={p.displayName || p.name}>{p.displayName || p.name}</td>
                                          <td className="p-2 text-left text-gray-600 text-sm truncate" title={p.specDetail}>{p.specDetail || '-'}</td>
                                          <td className="p-2 text-right text-gray-700 text-sm">{getPrice(['æ¥­å‹™åº•åƒ¹'])}</td>
                                          <td className="p-2 text-right text-gray-700 text-sm">{getPrice(['VIPåƒ¹', 'VIP åƒ¹', 'VIPåƒ¹(ä¸­ç›¤)', 'VIP åƒ¹(ä¸­ç›¤)'])}</td>
                                          <td className="p-2 text-right font-bold text-purple-700 text-sm">{getPrice(['æ•´ä»¶åƒ¹', 'æ•´ä»¶åƒ¹(10ä»¶ä»¥ä¸‹)'])}</td>
                                          <td className="p-2 text-right text-gray-700 text-sm">{getPrice(['ç”Ÿæ„åƒ¹'])}</td>
                                          <td className="p-2 text-right text-gray-700 text-sm">{getPrice(['é¤å»³90%'])}</td>
                                          <td className="p-2 text-right text-gray-700 text-sm">{getPrice(['æœƒå“¡95%'])}</td>
                                          <td className="p-2 text-right font-medium text-sm" style={{color: '#ea580c'}}>{getPrice(['é–€å¸‚å”®åƒ¹'])}</td>
                                          <td className="p-2 text-center">
                                            {isNew && <span className="inline-block bg-amber-500 text-white text-xs px-1 py-0.5 rounded font-bold">æ–°</span>}
                                            {isPromo && <span className="inline-block bg-purple-500 text-white text-xs px-1 py-0.5 rounded font-bold ml-0.5">ä¿ƒ</span>}
                                            {priceChange > 0 && <span className="text-red-600 text-xs font-bold ml-0.5">â–²</span>}
                                            {priceChange < 0 && <span className="text-green-600 text-xs font-bold ml-0.5">â–¼</span>}
                                          </td>
                                          <td className="p-2 text-left text-xs text-gray-500 truncate" title={productRemarks[p.id] || p.remark || ''}>{productRemarks[p.id] || p.remark || ''}</td>
                                        </tr>
                                      );
                                    });
                                  });
                                  
                                  return rows;
                                })()}
                              </tbody>
                            </table>
                          </div>
                          
                          {/* å ±åƒ¹è¡¨åº•éƒ¨ */}
                          <div className="bg-gray-50 px-4 py-3 border-t border-gray-200">
                            <div className="flex justify-between items-center text-xs text-gray-500">
                              <div className="flex items-center gap-3">
                                <span className="flex items-center gap-1">
                                  <span className="w-3 h-3 bg-amber-500 rounded"></span> æ–°å“
                                </span>
                                <span className="flex items-center gap-1">
                                  <span className="w-3 h-3 bg-purple-500 rounded"></span> ä¿ƒéŠ·
                                </span>
                              </div>
                              <div className="text-right">
                                <span>å…«æ–¹ç’°çƒæ°´ç”¢ Â· æ¥­å‹™å°ˆç·š</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
              )}
              
            </div>
          </div>
          
          {/* åƒ¹æ ¼ç·¨è¼¯å½ˆçª— - æ‰‹æ©Ÿä¸€é å®Œæ•´é¡¯ç¤ºç‰ˆï¼ˆå¤§å­—é«”ï¼‰ */}
          {editingProduct && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-end lg:items-center justify-center" onClick={closePriceEditor}>
              <div className="bg-white rounded-t-3xl lg:rounded-2xl w-full lg:max-w-md overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                
                {/* æ¨™é¡Œåˆ— */}
                <div className="px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                  <div className="flex justify-between items-center">
                    <div className="flex-1 min-w-0">
                      <div className="text-lg font-bold truncate">{editingProduct.displayName || editingProduct.name}</div>
                      <div className="text-sm text-white/80 truncate">{editingProduct.specDetail} Â· åº«å­˜:{Math.floor(editingProduct.totalStock || 0)}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-white/80 bg-white/20 px-2.5 py-1 rounded-lg font-medium">
                        {(() => {
                          const products = getProductsByCategory();
                          const idx = products.findIndex(p => p.id === editingProduct.id);
                          return `${idx + 1}/${products.length}`;
                        })()}
                      </span>
                      <button onClick={closePriceEditor} className="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 text-white text-xl font-bold">âœ•</button>
                    </div>
                  </div>
                </div>
                
                {/* å…§å®¹å€ */}
                <div className="p-4">
                  {/* ç‹€æ…‹åˆ‡æ› */}
                  <div className="flex gap-3 mb-4">
                    <button 
                      onClick={() => setEditingStatus(prev => ({...prev, isNew: !prev.isNew}))}
                      className={`flex-1 py-3 rounded-xl text-base font-bold transition-all ${
                        editingStatus.isNew ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-500'
                      }`}
                    >ğŸ†• æ–°è²¨åˆ°</button>
                    <button 
                      onClick={() => setEditingStatus(prev => ({...prev, isPromo: !prev.isPromo}))}
                      className={`flex-1 py-3 rounded-xl text-base font-bold transition-all ${
                        editingStatus.isPromo ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-500'
                      }`}
                    >ğŸ·ï¸ ä¿ƒéŠ·</button>
                  </div>
                  
                  {/* åƒ¹æ ¼ç·¨è¼¯ - 2x3 ç¶²æ ¼ï¼Œæ”¾å¤§ç‰ˆ */}
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    {[
                      { key: 'æ¥­å‹™åº•åƒ¹', label: 'åº•åƒ¹', color: 'gray' },
                      { key: 'VIPåƒ¹', label: 'VIP', color: 'blue' },
                      { key: 'æ•´ä»¶åƒ¹', label: 'æ•´ä»¶', color: 'purple', highlight: true },
                      { key: 'ç”Ÿæ„åƒ¹', label: 'ç”Ÿæ„', color: 'green' },
                      { key: 'èŠ±æ±åƒ¹', label: 'èŠ±æ±', color: 'orange' },
                    ].map((tier) => {
                      const currentPrice = editingPrices[tier.key] ?? (editingProduct.prices?.[tier.key] || 0);
                      return (
                        <div key={tier.key} className={`rounded-xl p-2.5 ${
                          tier.highlight ? 'bg-purple-100 border-2 border-purple-400' : 'bg-gray-50'
                        }`}>
                          <div className={`text-sm font-bold mb-1.5 text-center ${tier.highlight ? 'text-purple-700' : 'text-gray-600'}`}>{tier.label}</div>
                          <div className="flex items-center justify-center">
                            <button
                              type="button"
                              onClick={() => {
                                const current = editingPrices[tier.key] ?? (editingProduct.prices?.[tier.key] || 0);
                                const step = current >= 100 ? 10 : 5;
                                setEditingPrices(prev => ({...prev, [tier.key]: Math.max(0, current - step)}));
                              }}
                              className="w-11 h-11 rounded-l-xl bg-gray-200 text-gray-700 text-2xl font-bold flex items-center justify-center active:bg-gray-300"
                            >âˆ’</button>
                            <input
                              type="text"
                              inputMode="numeric"
                              pattern="[0-9]*"
                              value={currentPrice || ''}
                              placeholder="0"
                              onFocus={e => e.target.select()}
                              onChange={e => {
                                const val = e.target.value.replace(/[^0-9]/g, '');
                                setEditingPrices(prev => ({...prev, [tier.key]: val ? parseInt(val) : 0}));
                              }}
                              className={`w-20 h-11 text-center font-bold text-xl border-y-2 outline-none ${
                                tier.highlight ? 'border-purple-400 bg-white text-purple-700' : 'border-gray-200 bg-white text-gray-800'
                              }`}
                            />
                            <button
                              type="button"
                              onClick={() => {
                                const current = editingPrices[tier.key] ?? (editingProduct.prices?.[tier.key] || 0);
                                const step = current >= 100 ? 10 : 5;
                                setEditingPrices(prev => ({...prev, [tier.key]: current + step}));
                              }}
                              className="w-11 h-11 rounded-r-xl bg-gray-200 text-gray-700 text-2xl font-bold flex items-center justify-center active:bg-gray-300"
                            >+</button>
                          </div>
                        </div>
                      );
                    })}
                    {/* å‚™è¨»æ¬„ä½ */}
                    <div className="rounded-xl p-2.5 bg-gray-50">
                      <div className="text-sm font-bold text-gray-600 mb-1.5 text-center">å‚™è¨»</div>
                      <input 
                        type="text"
                        placeholder="é¸å¡«"
                        value={editingRemark}
                        onChange={e => setEditingRemark(e.target.value)}
                        className="w-full h-11 px-3 rounded-xl bg-white border-2 border-gray-200 focus:border-purple-500 text-base text-center outline-none"
                      />
                    </div>
                  </div>
                </div>
                
                {/* åº•éƒ¨æŒ‰éˆ• - å–®è¡Œè¨­è¨ˆ */}
                <div className="px-4 pb-5 pt-1 bg-white flex gap-2">
                  {/* ä¸Šä¸€é … */}
                  <button 
                    onClick={() => saveAndNavigate(-1)}
                    disabled={(() => {
                      const products = getProductsByCategory();
                      const currentIdx = products.findIndex(p => p.id === editingProduct.id);
                      return currentIdx <= 0;
                    })()}
                    className={`w-14 h-14 rounded-xl text-xl font-bold flex items-center justify-center ${
                      (() => {
                        const products = getProductsByCategory();
                        const currentIdx = products.findIndex(p => p.id === editingProduct.id);
                        return currentIdx <= 0;
                      })()
                        ? 'bg-gray-100 text-gray-300' 
                        : 'bg-gray-200 text-gray-600 active:bg-gray-300'
                    }`}
                  >â—€</button>
                  
                  {/* å–æ¶ˆ */}
                  <button 
                    onClick={closePriceEditor}
                    className="flex-1 h-14 rounded-xl bg-gray-100 text-gray-600 text-base font-bold active:bg-gray-200"
                  >âœ• å–æ¶ˆ</button>
                  
                  {/* æš«å­˜ */}
                  <button 
                    id="savePriceBtn"
                    onClick={savePriceEdit}
                    className="flex-[2] h-14 rounded-xl bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-base font-bold shadow-lg active:opacity-90"
                  >âœ“ æš«å­˜</button>
                  
                  {/* ä¸‹ä¸€é … */}
                  <button 
                    onClick={() => saveAndNavigate(1)}
                    disabled={(() => {
                      const products = getProductsByCategory();
                      const currentIdx = products.findIndex(p => p.id === editingProduct.id);
                      return currentIdx >= products.length - 1;
                    })()}
                    className={`w-14 h-14 rounded-xl text-xl font-bold flex items-center justify-center ${
                      (() => {
                        const products = getProductsByCategory();
                        const currentIdx = products.findIndex(p => p.id === editingProduct.id);
                        return currentIdx >= products.length - 1;
                      })()
                        ? 'bg-gray-100 text-gray-300' 
                        : 'bg-blue-500 text-white active:bg-blue-600'
                    }`}
                  >â–¶</button>
                </div>
              </div>
            </div>
          )}
          
          {/* åˆ†çµ„ç·¨è¼¯å½ˆçª— */}
          {editingGroup && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-2" onClick={closeGroupEditor}>
              <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                
                {/* æ¨™é¡Œåˆ— */}
                <div className="px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                  <div className="text-lg font-bold">{editingGroup.brandName}</div>
                  <div className="text-sm text-white/70">{editingGroup.packSpec} Â· {editingGroup.items.length} å€‹è¦æ ¼</div>
                </div>
                
                {/* å…§å®¹å€ - å¯æ»¾å‹•ï¼Œå¡ç‰‡å¼ä½ˆå±€ */}
                <div className="flex-1 overflow-y-auto p-3 space-y-4">
                  {/* ç”¢å“åˆ—è¡¨ - æ¯å€‹è¦æ ¼ä¸€å¼µå¡ç‰‡ */}
                  {editingGroup.items.map((item, idx) => {
                    const data = groupEditData[item.id] || { prices: {}, status: {}, remark: '' };
                    return (
                      <div key={item.id} className="bg-white rounded-2xl border-2 border-gray-200 overflow-hidden shadow-sm">
                        {/* è¦æ ¼æ¨™é¡Œ */}
                        <div className="bg-gradient-to-r from-gray-100 to-gray-50 px-4 py-3 border-b border-gray-200">
                          <div className="flex items-center justify-between">
                            <div className="font-bold text-lg text-gray-800">
                              {item.sizeSpec || 'è¦æ ¼ ' + (idx + 1)}
                            </div>
                            {/* ç‹€æ…‹æŒ‰éˆ• */}
                            <div className="flex gap-2">
                              <button 
                                onClick={() => {
                                  setGroupEditData(prev => ({
                                    ...prev,
                                    [item.id]: {
                                      ...prev[item.id],
                                      status: { ...prev[item.id]?.status, isNew: !prev[item.id]?.status?.isNew }
                                    }
                                  }));
                                }}
                                className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-colors ${data.status?.isNew ? 'bg-amber-500 text-white' : 'bg-gray-200 text-gray-500'}`}
                              >ğŸ†• æ–°å“</button>
                              <button 
                                onClick={() => {
                                  setGroupEditData(prev => ({
                                    ...prev,
                                    [item.id]: {
                                      ...prev[item.id],
                                      status: { ...prev[item.id]?.status, isPromo: !prev[item.id]?.status?.isPromo }
                                    }
                                  }));
                                }}
                                className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-colors ${data.status?.isPromo ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-500'}`}
                              >ğŸ·ï¸ ä¿ƒéŠ·</button>
                            </div>
                          </div>
                        </div>
                        
                        {/* åƒ¹æ ¼è¼¸å…¥å€ - 2x3 ç¶²æ ¼ */}
                        <div className="p-3">
                          <div className="grid grid-cols-2 gap-2 mb-3">
                            {[
                              { key: 'æ¥­å‹™åº•åƒ¹', label: 'åº•åƒ¹', color: 'gray' },
                              { key: 'VIPåƒ¹', label: 'VIP', color: 'blue' },
                              { key: 'æ•´ä»¶åƒ¹', label: 'æ•´ä»¶', color: 'indigo', highlight: true },
                              { key: 'ç”Ÿæ„åƒ¹', label: 'ç”Ÿæ„', color: 'green' },
                              { key: 'èŠ±æ±åƒ¹', label: 'èŠ±æ±', color: 'orange' },
                            ].map((tier) => (
                              <div key={tier.key} className={`flex items-center gap-2 p-2 rounded-xl ${tier.highlight ? 'bg-indigo-50 border border-indigo-200' : 'bg-gray-50'}`}>
                                <span className={`text-sm font-bold w-10 ${tier.color === 'orange' ? 'text-orange-600' : tier.highlight ? 'text-indigo-700' : 'text-gray-600'}`}>{tier.label}</span>
                                <input 
                                  type="text"
                                  inputMode="numeric"
                                  pattern="[0-9]*"
                                  value={data.prices[tier.key] || ''}
                                  placeholder="0"
                                  onFocus={e => e.target.select()}
                                  onChange={e => {
                                    const val = e.target.value.replace(/[^0-9]/g, '');
                                    setGroupEditData(prev => ({
                                      ...prev,
                                      [item.id]: {
                                        ...prev[item.id],
                                        prices: { ...prev[item.id]?.prices, [tier.key]: val ? parseInt(val) : 0 }
                                      }
                                    }));
                                  }}
                                  className={`flex-1 px-3 py-2.5 rounded-lg text-center font-bold text-base border-2 outline-none ${
                                    tier.highlight 
                                      ? 'border-indigo-300 bg-white text-indigo-700 focus:border-indigo-500' 
                                      : tier.color === 'orange'
                                        ? 'border-orange-200 bg-white text-orange-600 focus:border-orange-400'
                                        : 'border-gray-200 bg-white text-gray-700 focus:border-purple-500'
                                  }`}
                                />
                              </div>
                            ))}
                          </div>
                          
                          {/* å‚™è¨» */}
                          <input 
                            type="text"
                            value={data.remark || ''}
                            placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰"
                            onChange={e => {
                              setGroupEditData(prev => ({
                                ...prev,
                                [item.id]: { ...prev[item.id], remark: e.target.value }
                              }));
                            }}
                            className="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-gray-200 focus:border-purple-500 text-base outline-none"
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                {/* åº•éƒ¨æŒ‰éˆ• - æ›´å¤§çš„è§¸æ§å€åŸŸ */}
                <div className="px-4 py-4 border-t border-gray-100 flex gap-3 bg-white">
                  <button 
                    onClick={closeGroupEditor}
                    className="flex-1 py-4 rounded-xl bg-gray-100 text-gray-500 text-base font-bold active:bg-gray-200"
                  >âœ• é—œé–‰</button>
                  <button 
                    id="saveGroupBtn"
                    onClick={saveGroupEdit}
                    className="flex-1 py-4 rounded-xl bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-base font-bold shadow-lg active:opacity-90"
                  >âœ“ å„²å­˜å…¨éƒ¨</button>
                </div>
              </div>
            </div>
          )}
          
          {/* å…¨å±€å½ˆçª— */}
          <GlobalModals />
          </>
        );
      }

      // ğŸ  é¦–é é¡¯ç¤º
      if (page === 'main' && currentTab === 'home') {
        const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
        return (
          <>
            {/* é›»è…¦ç‰ˆé ‚éƒ¨å°èˆª */}
            {!isMobile && (
              <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-4 shadow-lg fixed top-0 left-0 right-0 z-50">
                <div className="max-w-7xl mx-auto flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <Icons.Package className="icon-svg-lg" />
                    <div>
                      <h1 className="text-xl font-black">å…«æ–¹ç’°çƒ ERP</h1>
                      <p className="text-xs opacity-90">{status}</p>
                    </div>
                  </div>
                  
                  {/* åŠŸèƒ½æŒ‰éˆ•å€ */}
                  <div className="flex items-center gap-2">
                    {/* é¦–é  */}
                    <button 
                      onClick={() => setCurrentTab('home')}
                      className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors ${
                        currentTab === 'home' 
                          ? 'bg-white text-indigo-600' 
                          : 'bg-white/20 hover:bg-white/30'
                      }`}>
                      <Icons.Home className="w-5 h-5" />
                      é¦–é 
                    </button>
                    
                    
                    {/* å„²å­˜ */}
                    <button 
                      onClick={saveQuote}
                      className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors relative"
                    >
                      <Icons.Save className="w-5 h-5" />
                      å„²å­˜
                      {cart.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                          {cart.length}
                        </span>
                      )}
                    </button>
                    
                    {/* æ­·å²å ±åƒ¹ */}
                    <button 
                      onClick={() => setCurrentTab('history')}
                      className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors relative ${
                        currentTab === 'history' 
                          ? 'bg-white text-indigo-600' 
                          : 'bg-white/20 hover:bg-white/30'
                      }`}
                    >
                      <Icons.History className="w-5 h-5" />
                      æ­·å²
                      {quotes.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                          {quotes.length}
                        </span>
                      )}
                    </button>
                    
                    {/* LINE */}
                    <button 
                      onClick={shareToLine}
                      className="bg-purple-500 hover:bg-green-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors"
                    >
                      <Icons.Send className="w-5 h-5" />
                      LINE
                    </button>
                    
                    {/* åˆ†éš”ç·š */}
                    <div className="w-px h-8 bg-white/30 mx-2"></div>
                    
                    
                    {/* ğŸ†• ä½åº«å­˜è­¦å ±éˆ´éº */}
                    <button 
                      onClick={() => {
                        const items = checkLowStock();
                        setLowStockItems(items);
                        setShowLowStockAlert(true);
                      }}
                      className="bg-white/20 hover:bg-white/30 p-2 rounded-lg relative transition-colors"
                      title="ä½åº«å­˜è­¦å ±"
                    >
                      <Icons.Bell className="w-5 h-5" />
                      {lowStockItems.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1 animate-pulse">
                          {lowStockItems.length > 99 ? '99+' : lowStockItems.length}
                        </span>
                      )}
                    </button>
                    {/* ç®¡ç† */}
                    {(role === 'admin' || role === 'store') && (
                      <button onClick={() => setPage('admin')} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                        <Icons.Settings className="icon-svg-sm" />
                        ç®¡ç†
                      </button>
                    )}
                    
                    {/* ç™»å‡º */}
                    <button onClick={handleLogout} className="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold">
                      ç™»å‡º
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* æ‰‹æ©Ÿç‰ˆé ‚éƒ¨å°èˆª */}
            {isMobile && (
              <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 shadow-lg sticky top-0 z-50">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <Icons.Package className="icon-svg" />
                    <div>
                      <h1 className="text-base font-black">å…«æ–¹ç’°çƒ ERP V14.0</h1>
                      <p className="text-xs opacity-90">{status}</p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    {/* ğŸ†• ä½åº«å­˜è­¦å ±éˆ´éºï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ */}
                    <button 
                      onClick={() => {
                        const items = checkLowStock();
                        setLowStockItems(items);
                        setShowLowStockAlert(true);
                      }}
                      className="bg-white/20 p-2 rounded-lg hover:bg-white/30 active:bg-white/40 transition-colors relative"
                    >
                      <Icons.Bell className="icon-svg-sm" />
                      {lowStockItems.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full min-w-[16px] h-[16px] flex items-center justify-center px-0.5 animate-pulse" style={{fontSize: '10px'}}>
                          {lowStockItems.length > 99 ? '99+' : lowStockItems.length}
                        </span>
                      )}
                    </button>
                    {(role === 'admin' || role === 'store') && (
                      <button onClick={() => setPage('admin')} className="bg-white/20 p-2 rounded-lg hover:bg-white/30 active:bg-white/40 transition-colors">
                        <Icons.Settings className="icon-svg-sm" />
                      </button>
                    )}
                    <button onClick={handleLogout} className="bg-red-500 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-red-600 active:bg-red-700 transition-colors">
                      ç™»å‡º
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            <div className={!isMobile ? 'pt-24' : ''}>
              <HomePage />
            </div>
            {/* åº•éƒ¨å°èˆª */}
            <BottomNav />
            {/* å…¨å±€å½ˆçª— */}
            <GlobalModals />
          </>
        );
      }

      // ğŸ“š æ­·å²é é¡¯ç¤º
      if (page === 'main' && currentTab === 'history') {
        const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
        return (
          <>
            {/* é›»è…¦ç‰ˆé ‚éƒ¨å°èˆª */}
            {!isMobile && (
              <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-4 shadow-lg fixed top-0 left-0 right-0 z-50">
                <div className="max-w-7xl mx-auto flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <Icons.Package className="icon-svg-lg" />
                    <div>
                      <h1 className="text-xl font-black">å…«æ–¹ç’°çƒ ERP</h1>
                      <p className="text-xs opacity-90">{status}</p>
                    </div>
                  </div>
                  
                  {/* åŠŸèƒ½æŒ‰éˆ•å€ */}
                  <div className="flex items-center gap-2">
                    {/* é¦–é  */}
                    <button 
                      onClick={() => setCurrentTab('home')}
                      className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors ${
                        currentTab === 'home' 
                          ? 'bg-white text-indigo-600' 
                          : 'bg-white/20 hover:bg-white/30'
                      }`}>
                      <Icons.Home className="w-5 h-5" />
                      é¦–é 
                    </button>
                    
                    {/* å„²å­˜ */}
                    <button 
                      onClick={saveQuote}
                      className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors relative"
                    >
                      <Icons.Save className="w-5 h-5" />
                      å„²å­˜
                      {cart.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                          {cart.length}
                        </span>
                      )}
                    </button>
                    
                    {/* æ­·å²å ±åƒ¹ */}
                    <button 
                      onClick={() => setCurrentTab('history')}
                      className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors relative ${
                        currentTab === 'history' 
                          ? 'bg-white text-indigo-600' 
                          : 'bg-white/20 hover:bg-white/30'
                      }`}
                    >
                      <Icons.History className="w-5 h-5" />
                      æ­·å²
                      {quotes.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                          {quotes.length}
                        </span>
                      )}
                    </button>
                    
                    {/* LINE */}
                    <button 
                      onClick={shareToLine}
                      className="bg-purple-500 hover:bg-green-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors"
                    >
                      <Icons.Send className="w-5 h-5" />
                      LINE
                    </button>
                    
                    {/* åˆ†éš”ç·š */}
                    <div className="w-px h-8 bg-white/30 mx-2"></div>
                    
                    {/* ğŸ†• ä½åº«å­˜è­¦å ±éˆ´éº */}
                    <button 
                      onClick={() => {
                        const items = checkLowStock();
                        setLowStockItems(items);
                        setShowLowStockAlert(true);
                      }}
                      className="bg-white/20 hover:bg-white/30 p-2 rounded-lg relative transition-colors"
                      title="ä½åº«å­˜è­¦å ±"
                    >
                      <Icons.Bell className="w-5 h-5" />
                      {lowStockItems.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1 animate-pulse">
                          {lowStockItems.length > 99 ? '99+' : lowStockItems.length}
                        </span>
                      )}
                    </button>
                    
                    {/* ç®¡ç† */}
                    {(role === 'admin' || role === 'store') && (
                      <button onClick={() => setPage('admin')} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                        <Icons.Settings className="icon-svg-sm" />
                        ç®¡ç†
                      </button>
                    )}
                    
                    {/* ç™»å‡º */}
                    <button onClick={handleLogout} className="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold">
                      ç™»å‡º
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* æ‰‹æ©Ÿç‰ˆé ‚éƒ¨å°èˆª */}
            {isMobile && (
              <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 shadow-lg sticky top-0 z-50">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <Icons.Package className="icon-svg" />
                    <div>
                      <h1 className="text-base font-black">å…«æ–¹ç’°çƒ ERP V14.0</h1>
                      <p className="text-xs opacity-90">{status}</p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    {/* ğŸ†• ä½åº«å­˜è­¦å ±éˆ´éºï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ */}
                    <button 
                      onClick={() => {
                        const items = checkLowStock();
                        setLowStockItems(items);
                        setShowLowStockAlert(true);
                      }}
                      className="bg-white/20 p-2 rounded-lg hover:bg-white/30 active:bg-white/40 transition-colors relative"
                    >
                      <Icons.Bell className="icon-svg-sm" />
                      {lowStockItems.length > 0 && (
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full min-w-[16px] h-[16px] flex items-center justify-center px-0.5 animate-pulse" style={{fontSize: '10px'}}>
                          {lowStockItems.length > 99 ? '99+' : lowStockItems.length}
                        </span>
                      )}
                    </button>
                    {(role === 'admin' || role === 'store') && (
                      <button onClick={() => setPage('admin')} className="bg-white/20 p-2 rounded-lg hover:bg-white/30 active:bg-white/40 transition-colors">
                        <Icons.Settings className="icon-svg-sm" />
                      </button>
                    )}
                    <button onClick={handleLogout} className="bg-red-500 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-red-600 active:bg-red-700 transition-colors">
                      ç™»å‡º
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            <div className={!isMobile ? 'pt-24' : ''}>
              <HistoryPage />
            </div>
            {/* åº•éƒ¨å°èˆª */}
            <BottomNav />
            {/* å…¨å±€å½ˆçª— */}
            <GlobalModals />
          </>
        );
      }

      // å ±åƒ¹é  - åªåœ¨ main é é¢ä¸” currentTab æ˜¯ quote æ™‚é¡¯ç¤º
      if (page !== 'main') {
        return null; // å…¶ä»–é é¢ï¼ˆadmin, loginï¼‰å·²åœ¨ä¸Šé¢è™•ç†
      }
      
      // å¦‚æœåˆ°é€™è£¡ï¼Œè¡¨ç¤º page === 'main' ä¸” currentTab === 'quote'
      const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
      const total = calculateTotal();

      return (
        <div className={`min-h-screen bg-gray-50 ${isMobile ? 'pb-24' : ''}`}>{/* æ‰‹æ©Ÿç‰ˆåŠ ä¸Š pb-24 é¿å…è¢«åº•éƒ¨å°èˆªé®æ“‹ */}
          {/* Header */}
          {!isMobile && (
            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-4 shadow-lg fixed top-0 left-0 right-0 z-50">
              <div className="max-w-7xl mx-auto flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <Icons.Package className="icon-svg-lg" />
                  <div>
                    <h1 className="text-xl font-black">å…«æ–¹ç’°çƒ ERP</h1>
                    <p className="text-xs opacity-90">{status}</p>
                  </div>
                </div>
                
                {/* åŠŸèƒ½æŒ‰éˆ•å€ */}
                <div className="flex items-center gap-2">
                  {/* é¦–é  */}
                  <button 
                    onClick={() => setCurrentTab('home')}
                    className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors ${
                      currentTab === 'home' 
                        ? 'bg-white text-indigo-600' 
                        : 'bg-white/20 hover:bg-white/30'
                    }`}>
                    <Icons.Home className="w-5 h-5" />
                    é¦–é 
                  </button>
                  
                  {/* å„²å­˜ */}
                  <button 
                    onClick={saveQuote}
                    className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors relative"
                  >
                    <Icons.Save className="w-5 h-5" />
                    å„²å­˜
                    {cart.length > 0 && (
                      <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                        {cart.length}
                      </span>
                    )}
                  </button>
                  
                  {/* æ­·å²å ±åƒ¹ */}
                  <button 
                    onClick={() => setCurrentTab('history')}
                    className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors relative ${
                      currentTab === 'history' 
                        ? 'bg-white text-indigo-600' 
                        : 'bg-white/20 hover:bg-white/30'
                    }`}
                  >
                    <Icons.History className="w-5 h-5" />
                    æ­·å²
                    {quotes.length > 0 && (
                      <span className="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                        {quotes.length}
                      </span>
                    )}
                  </button>
                  
                  {/* LINE */}
                  <button 
                    onClick={shareToLine}
                    className="bg-purple-500 hover:bg-green-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors"
                  >
                    <Icons.Send className="w-5 h-5" />
                    LINE
                  </button>
                  
                  {/* åˆ†éš”ç·š */}
                  <div className="w-px h-8 bg-white/30 mx-2"></div>
                  
                  {/* ğŸ†• ä½åº«å­˜è­¦å ±éˆ´éº */}
                  <button 
                    onClick={() => {
                      const items = checkLowStock();
                      setLowStockItems(items);
                      setShowLowStockAlert(true);
                    }}
                    className="bg-white/20 hover:bg-white/30 p-2 rounded-lg relative transition-colors"
                    title="ä½åº«å­˜è­¦å ±"
                  >
                    <Icons.Bell className="w-5 h-5" />
                    {lowStockItems.length > 0 && (
                      <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1 animate-pulse">
                        {lowStockItems.length > 99 ? '99+' : lowStockItems.length}
                      </span>
                    )}
                  </button>
                  
                  {/* ç®¡ç† */}
                  {(role === 'admin' || role === 'store') && (
                    <button onClick={() => setPage('admin')} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                      <Icons.Settings className="icon-svg-sm" />
                      ç®¡ç†
                    </button>
                  )}
                  
                  {/* ç™»å‡º */}
                  <button onClick={handleLogout} className="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold">
                    ç™»å‡º
                  </button>
                </div>
              </div>
            </div>
          )}

          {isMobile && (
            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 shadow-lg sticky top-0 z-50">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-2">
                  <Icons.Package className="icon-svg" />
                  <div>
                    <h1 className="text-base font-black">å…«æ–¹ç’°çƒ ERP V14.0</h1>
                    <p className="text-xs opacity-90">{status}</p>
                  </div>
                </div>
                <div className="flex gap-2">
                  {/* ğŸ†• ä½åº«å­˜è­¦å ±éˆ´éºï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ */}
                  <button 
                    onClick={() => {
                      const items = checkLowStock();
                      setLowStockItems(items);
                      setShowLowStockAlert(true);
                    }}
                    className="bg-white/20 p-2 rounded-lg hover:bg-white/30 active:bg-white/40 transition-colors relative"
                  >
                    <Icons.Bell className="icon-svg-sm" />
                    {lowStockItems.length > 0 && (
                      <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full min-w-[16px] h-[16px] flex items-center justify-center px-0.5 animate-pulse" style={{fontSize: '10px'}}>
                        {lowStockItems.length > 99 ? '99+' : lowStockItems.length}
                      </span>
                    )}
                  </button>
                  {(role === 'admin' || role === 'store') && (
                    <button onClick={() => setPage('admin')} className="bg-white/20 p-2 rounded-lg hover:bg-white/30 active:bg-white/40 transition-colors">
                      <Icons.Settings className="icon-svg-sm" />
                    </button>
                  )}
                  <button onClick={handleLogout} className="bg-red-500 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-red-600 active:bg-red-700 transition-colors">
                    ç™»å‡º
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* æ¡Œé¢ç‰ˆä½ˆå±€ - æ·»åŠ é ‚éƒ¨é–“è· */}
          {!isMobile && (
            <div className="max-w-7xl mx-auto p-6 pt-24">{/* æ·»åŠ  pt-24 é¿å…è¢«å›ºå®šé ‚æ¬„é®æ“‹ */}
              <div className="grid grid-cols-[280px_1fr] gap-6">
                {/* å·¦å´æ¬„ */}
                <div className="bg-gradient-to-b from-purple-500 to-indigo-600 text-white rounded-2xl p-6 shadow-xl h-fit sticky top-24">
                  <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                    <Icons.User />
                    å®¢æˆ¶è³‡è¨Š
                  </h2>
                  
                  <div className="space-y-3 mb-6">
                    <input type="text" placeholder="å®¢æˆ¶åç¨±" className="w-full p-2.5 rounded-lg text-gray-800 text-sm" 
                      value={custInfo.name} onChange={e => setCustInfo({...custInfo, name: e.target.value})} />
                    <select className="w-full p-2.5 rounded-lg text-gray-800 text-sm font-bold bg-yellow-100"
                      value={custInfo.tier} onChange={e => setCustInfo({...custInfo, tier: e.target.value})}>
                      <option value="é–€å¸‚å”®åƒ¹">é–€å¸‚å”®åƒ¹</option>
                      <option value="æœƒå“¡95%">æœƒå“¡95%</option>
                      <option value="é¤å»³90%">é¤å»³90%</option>
                      <option value="ç”Ÿæ„åƒ¹">ç”Ÿæ„åƒ¹</option>
                      <option value="æ•´ä»¶åƒ¹">æ•´ä»¶åƒ¹</option>
                      <option value="VIPåƒ¹">VIPåƒ¹</option>
                      <option value="æ¥­å‹™åº•åƒ¹">æ¥­å‹™åº•åƒ¹</option>
                    </select>
                    <select className="w-full p-2.5 rounded-lg text-gray-800 text-sm font-bold bg-green-100"
                      value={custInfo.paymentMethod} onChange={e => setCustInfo({...custInfo, paymentMethod: e.target.value})}>
                      <option value="æœˆçµ30å¤©">æœˆçµ30å¤©</option>
                      <option value="æœˆçµ60å¤©">æœˆçµ60å¤©</option>
                      <option value="ç¾é‡‘">ç¾é‡‘</option>
                      <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
                      <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                      <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                    </select>
                    <input type="tel" placeholder="é›»è©±" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.phone} onChange={e => setCustInfo({...custInfo, phone: e.target.value})} />
                    <input type="tel" placeholder="æ‰‹æ©Ÿ" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.mobile} onChange={e => setCustInfo({...custInfo, mobile: e.target.value})} />
                    <input type="text" placeholder="åœ°å€" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.address} onChange={e => setCustInfo({...custInfo, address: e.target.value})} />
                    <input type="date" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.date} onChange={e => setCustInfo({...custInfo, date: e.target.value})} />
                  </div>

                  <div className="space-y-2 mb-4 pt-6 border-t border-white/20">
                    <button 
                      onClick={() => {
                        const choice = window.confirm('è«‹é¸æ“‡é è¦½æ–¹å¼ï¼š\n\nç¢ºå®š = å®Œæ•´å ±åƒ¹å–®ï¼ˆå«é‡‘é¡ï¼‰\nå–æ¶ˆ = ç´”ç”¢å“æ¸…å–®ï¼ˆå«å–®åƒ¹ï¼‰');
                        if (choice) {
                          printQuote();
                        } else {
                          printQuoteNoPrice();
                        }
                      }}
                      className="w-full bg-white/20 hover:bg-white/30 p-3 rounded-lg font-bold flex items-center gap-2 transition-colors">
                      <Icons.Eye className="icon-svg-sm" />
                      ğŸ“„ é è¦½å ±åƒ¹å–®
                    </button>
                  </div>
                  
                  {/* ç¸½é‡‘é¡ */}
                  <div className="bg-white/20 rounded-xl p-4 text-center">
                    <div className="text-sm opacity-90 mb-1">ç¸½é‡‘é¡</div>
                    <div className="text-3xl font-black">${cart.reduce((sum, item) => sum + calculateSubtotal(item), 0).toLocaleString()}</div>
                    <div className="text-xs opacity-70 mt-1">å…± {cart.length} é …å•†å“</div>
                  </div>
                </div>

                {/* å³å´ç”¢å“å€ */}
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-black text-gray-800">ç”¢å“æ¸…å–®</h2>
                    <button onClick={() => setShowProductSearch(true)} className="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]">
                      <Icons.Plus />
                      æ–°å¢ç”¢å“
                    </button>
                  </div>

                  {/* ç©ºç‹€æ…‹å¼•å° */}
                  {cart.length === 0 ? (
                    <div 
                      onClick={() => setShowProductSearch(true)}
                      className="border-3 border-dashed border-purple-300 rounded-2xl p-12 text-center cursor-pointer hover:border-purple-500 hover:bg-purple-50 transition-all group"
                    >
                      <div className="w-20 h-20 mx-auto mb-4 rounded-full bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                        <Icons.Plus className="w-10 h-10 text-purple-500" />
                      </div>
                      <h3 className="text-xl font-bold text-gray-700 mb-2">é–‹å§‹å»ºç«‹å ±åƒ¹å–®</h3>
                      <p className="text-gray-500 mb-4">é»æ“Šæ­¤è™•æ–°å¢ç¬¬ä¸€å€‹ç”¢å“</p>
                      <div className="flex flex-wrap justify-center gap-2 text-sm">
                        <span className="px-3 py-1.5 bg-purple-100 text-purple-700 rounded-full font-medium">ğŸ” æœå°‹ç”¢å“</span>
                        <span className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full font-medium">ğŸ“¦ é¸æ“‡è¦æ ¼</span>
                        <span className="px-3 py-1.5 bg-green-100 text-green-700 rounded-full font-medium">ğŸ’° è‡ªå‹•å¸¶å…¥åƒ¹æ ¼</span>
                      </div>
                      <div className="mt-6 text-xs text-gray-400">
                        æ”¯æ´æœå°‹å“åã€å“è™Ÿã€è¦æ ¼
                      </div>
                    </div>
                  ) : (
                  <div className="space-y-2">
                    {cart.map((item, index) => {
                      // æª¢æŸ¥æ­¤ç”¢å“æ˜¯å¦ä½åº«å­˜ï¼ˆæ ¹æ“šè§’è‰²é¸æ“‡å€‰åº«å’Œå®‰å…¨åº«å­˜ï¼‰
                      const currentWarehouses = role === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
                      const currentSafetyStockData = role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
                      const stocks = data.inventory[item.id] || [];
                      const mainStocks = stocks.filter(s => currentWarehouses.includes(s.warehouse));
                      const mainTotal = mainStocks.reduce((s, x) => s + (x.stock || 0), 0);
                      const otherStocks = stocks.filter(s => !currentWarehouses.includes(s.warehouse) && s.stock > 0);
                      const otherTotal = otherStocks.reduce((s, x) => s + (x.stock || 0), 0);
                      const safetyLine = currentSafetyStockData?.[item.id] ?? DEFAULT_SAFETY_STOCK;
                      const isOutOfStock = mainTotal === 0;
                      const isLowStock = mainTotal > 0 && mainTotal < safetyLine;
                      
                      return (
                      <div key={item.cartId} className="border-2 rounded-xl p-4 hover:shadow-lg transition-all border-gray-200 hover:border-purple-400 bg-white">
                        {/* æ•´é«”ä½ˆå±€ï¼šåºè™Ÿ+åœ–ç‰‡ | å“åè¦æ ¼+è¼¸å…¥å€ | æ“ä½œæŒ‰éˆ• */}
                        <div className="flex items-start gap-4">
                          <div className="w-11 h-11 text-white rounded-xl flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md bg-gradient-to-br from-purple-500 to-indigo-600">
                            {index + 1}
                          </div>

                          <div className="w-28 h-28 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-gray-200 cursor-pointer hover:border-purple-400 transition-colors flex-shrink-0 overflow-hidden"
                            onClick={() => uploadImage(item.cartId)}>
                            {item.image ? (
                              <img src={item.image} alt="ç”¢å“" className="w-full h-full object-cover" />
                            ) : (
                              <Icons.Camera className="icon-svg-lg text-gray-400" />
                            )}
                          </div>

                          {/* ä¸­é–“å€åŸŸï¼šå“åã€è¦æ ¼ã€è¼¸å…¥åˆ— */}
                          <div className="flex-1 min-w-0">
                            <div className="font-bold text-lg text-gray-800 cursor-pointer hover:text-purple-600 transition-colors" onClick={() => reSelectProduct(item.cartId)} title="é»æ“Šé‡æ–°é¸æ“‡ç”¢å“">{item.name || 'æœªå‘½åç”¢å“'}</div>
                            <div className="text-lg text-purple-600 font-semibold cursor-pointer hover:text-blue-800 transition-colors mb-3" onClick={() => { setSearch(item.name || ''); setShowProductSearch(true); }} title="é»æ“Šæœå°‹åŒå“åç”¢å“">{item.specDetail || 'ç„¡è¦æ ¼èªªæ˜'}</div>
                            
                            {/* ç¬¬ä¸€è¡Œï¼šä»¶æ•¸ã€å–®åƒ¹ã€åƒ¹æ ¼ç­‰ç´šã€å°è¨ˆ */}
                            <div className="flex items-center gap-3 mb-2">
                              <div className="flex items-center gap-1">
                                {(() => {
                                  const packInfo = extractPackInfo(item.specDetail);
                                  if (packInfo) {
                                    return (
                                      <>
                                        <span className="text-xs text-gray-600 font-semibold">ä»¶æ•¸</span>
                                        <input type="text" inputMode="decimal" pattern="[0-9]*" className="w-16 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center font-bold focus:border-purple-500 outline-none"
                                          value={item.qty} onChange={e => updateCart(item.cartId, 'qty', parseFloat(e.target.value) || 0)} />
                                        <span className="text-sm font-bold text-gray-600">ä»¶</span>
                                      </>
                                    );
                                  } else {
                                    return (
                                      <>
                                        <span className="text-xs text-gray-600 font-semibold">æ•¸é‡</span>
                                        <input type="text" inputMode="decimal" pattern="[0-9]*" className="w-16 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center font-bold focus:border-purple-500 outline-none"
                                          value={item.qty} onChange={e => updateCart(item.cartId, 'qty', parseFloat(e.target.value) || 0)} />
                                        <span className="text-sm font-bold text-gray-600">{item.smallUnit}</span>
                                      </>
                                    );
                                  }
                                })()}
                              </div>

                              <div className="flex items-center gap-1">
                                <span className="text-xs text-gray-600 font-semibold">å–®åƒ¹ $</span>
                                <input type="text" inputMode="decimal" pattern="[0-9]*" className="w-20 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center font-bold focus:border-purple-500 outline-none"
                                  value={item.price} onChange={e => updateCart(item.cartId, 'price', parseFloat(e.target.value) || 0)} />
                                <button onClick={() => showPriceSelector(item.cartId)} className="bg-purple-500 text-white px-3 py-1.5 rounded-lg font-black text-sm flex items-center justify-center hover:shadow-lg transition-all min-w-[44px]">
                                  {(() => {
                                    const tier = item.selectedTier || custInfo.tier;
                                    if (tier.includes('é–€å¸‚')) return 'é–€';
                                    if (tier.includes('æœƒå“¡')) return 'æœƒ';
                                    if (tier.includes('é¤å»³')) return 'é¤';
                                    if (tier.includes('ç”Ÿæ„')) return 'ç”Ÿ';
                                    if (tier.includes('æ•´ä»¶')) return 'æ•´';
                                    if (tier.includes('VIP')) return 'VIP';
                                    if (tier.includes('åº•åƒ¹') || tier.includes('æ¥­å‹™')) return 'åº•';
                                    return tier.charAt(0);
                                  })()}
                                </button>
                              </div>

                              {/* ä»¶æ•¸è¨ˆç®— + å°è¨ˆ */}
                              <div className="flex items-center gap-2 ml-auto">
                                {(() => {
                                  const displayInfo = getPackDisplayInfo(item);
                                  if (displayInfo) {
                                    return (
                                      <span className="text-xs text-gray-600 bg-indigo-50 px-2 py-1.5 rounded-lg border border-indigo-200">
                                        {displayInfo.packQty}{displayInfo.packUnit}/ä»¶
                                      </span>
                                    );
                                  }
                                  return null;
                                })()}
                                <div className="bg-gray-50 rounded-lg px-3 py-1.5 flex items-center gap-2">
                                  <span className="text-xs text-gray-500">å°è¨ˆ</span>
                                  <span className="text-xl font-bold text-indigo-600">${calculateSubtotal(item).toLocaleString()}</span>
                                </div>
                              </div>
                            </div>

                            {/* ç¬¬äºŒè¡Œï¼šåº«å­˜ + å‚™è¨» */}
                            <div className="flex items-center gap-3">
                              {/* åº«å­˜ç‹€æ…‹ */}
                              <div className="flex items-center gap-1.5 flex-shrink-0">
                                <span className={`text-sm px-2 py-1.5 rounded font-bold ${
                                  isOutOfStock ? 'bg-red-100 text-red-600' : 
                                  isLowStock ? 'bg-orange-100 text-orange-600' : 
                                  'bg-green-100 text-green-700'
                                }`}>
                                  ä¸»å€‰ {Math.floor(mainTotal)}
                                </span>
                                <span className={`text-sm px-2 py-1.5 rounded font-bold ${
                                  otherTotal > 0 ? 'bg-cyan-100 text-cyan-700' : 'bg-gray-100 text-gray-400'
                                }`}>
                                  å¤–å€‰ {Math.floor(otherTotal)}
                                </span>
                                {isOutOfStock && (
                                  <span className="text-sm font-bold text-red-600">
                                    ç¼ºè²¨{otherTotal > 0 ? 'å¯èª¿' : ''}
                                  </span>
                                )}
                                {isLowStock && (
                                  <span className="text-sm font-bold text-orange-600">
                                    ä½åº«å­˜{otherTotal > 0 ? 'å¯èª¿' : ''}
                                  </span>
                                )}
                              </div>
                              {/* å‚™è¨» */}
                              <input type="text" placeholder="å‚™è¨»..." className="flex-1 px-3 py-1.5 border-2 border-yellow-300 bg-yellow-50 rounded-lg text-sm focus:border-yellow-500 outline-none"
                                value={item.note} onChange={e => updateCart(item.cartId, 'note', e.target.value)} />
                            </div>
                          </div>

                          {/* æ“ä½œæŒ‰éˆ• */}
                          <div className="flex gap-2 flex-shrink-0">
                            <button onClick={() => uploadImage(item.cartId)} className="w-9 h-9 bg-blue-50 border-2 border-blue-200 rounded-lg hover:bg-blue-100 hover:border-blue-400 transition-colors flex items-center justify-center" title="ä¸Šå‚³åœ–ç‰‡">
                              <Icons.Camera className="w-4 h-4 text-blue-600" />
                            </button>
                            <button onClick={() => copyCartItem(item.cartId)} className="w-9 h-9 bg-purple-50 border-2 border-purple-200 rounded-lg hover:bg-purple-100 hover:border-purple-400 transition-colors flex items-center justify-center" title="è¤‡è£½">
                              <Icons.Copy className="w-4 h-4 text-purple-600" />
                            </button>
                            <button onClick={() => deleteFromCart(item.cartId)} className="w-9 h-9 bg-red-50 border-2 border-red-200 rounded-lg hover:bg-red-100 hover:border-red-400 transition-colors flex items-center justify-center" title="åˆªé™¤">
                              <Icons.Trash className="w-4 h-4 text-red-600" />
                            </button>
                          </div>
                        </div>
                      </div>
                    )})}
                  </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* æ‰‹æ©Ÿç‰ˆä½ˆå±€ */}
          {isMobile && (
            <div className="pb-32">
              <div className="bg-white m-4 rounded-xl p-4 shadow-sm border border-gray-200">
                <div className="flex items-center gap-3">
                  <div className="flex-1">
                    <label className="text-xs text-gray-500 mb-1.5 block">å®¢æˆ¶åç¨±</label>
                    <input 
                      type="text" 
                      placeholder="é»æ“Šè¼¸å…¥å®¢æˆ¶åç¨±" 
                      className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-base text-gray-900 font-medium"
                      value={custInfo.name} 
                      onChange={e => setCustInfo({...custInfo, name: e.target.value})} 
                    />
                  </div>
                  <button 
                    onClick={() => setShowCustomerDetail(true)}
                    className="mt-6 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-sm text-gray-700 font-medium flex items-center gap-1.5 hover:bg-gray-100 active:bg-gray-200 transition-colors"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    è©³ç´°
                  </button>
                </div>
              </div>

              <div className="px-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-base font-bold text-gray-800 flex items-center gap-2">
                    <Icons.Package className="icon-svg-sm" />
                    ç”¢å“æ¸…å–®
                  </h2>
                </div>

                {/* ç©ºç‹€æ…‹å¼•å° */}
                {cart.length === 0 ? (
                  <div 
                    onClick={() => setShowProductSearch(true)}
                    className="border-2 border-dashed border-purple-300 rounded-2xl p-8 text-center active:bg-purple-50 transition-all"
                  >
                    <div className="w-16 h-16 mx-auto mb-3 rounded-full bg-purple-100 flex items-center justify-center">
                      <Icons.Plus className="w-8 h-8 text-purple-500" />
                    </div>
                    <h3 className="text-lg font-bold text-gray-700 mb-2">é–‹å§‹å»ºç«‹å ±åƒ¹å–®</h3>
                    <p className="text-sm text-gray-500 mb-4">é»æ“Šæ–°å¢ç¬¬ä¸€å€‹ç”¢å“</p>
                    <div className="flex flex-wrap justify-center gap-2 text-xs">
                      <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded-full">ğŸ” æœå°‹</span>
                      <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full">ğŸ“¦ é¸è¦æ ¼</span>
                      <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full">ğŸ’° å¸¶åƒ¹æ ¼</span>
                    </div>
                  </div>
                ) : (
                <div className="space-y-3">
                  {cart.map((item, index) => {
                    // æª¢æŸ¥æ­¤ç”¢å“æ˜¯å¦ä½åº«å­˜ï¼ˆæ ¹æ“šè§’è‰²é¸æ“‡å€‰åº«å’Œå®‰å…¨åº«å­˜ï¼‰
                    const currentWarehouses = role === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
                    const currentSafetyStockData = role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
                    const stocks = data.inventory[item.id] || [];
                    const mainStocks = stocks.filter(s => currentWarehouses.includes(s.warehouse));
                    const mainTotal = mainStocks.reduce((s, x) => s + (x.stock || 0), 0);
                    const otherStocks = stocks.filter(s => !currentWarehouses.includes(s.warehouse) && s.stock > 0);
                    const otherTotal = otherStocks.reduce((s, x) => s + (x.stock || 0), 0);
                    const safetyLine = currentSafetyStockData?.[item.id] ?? DEFAULT_SAFETY_STOCK;
                    const isOutOfStock = mainTotal === 0;
                    const isLowStock = mainTotal > 0 && mainTotal < safetyLine;
                    
                    return (
                    <div key={item.cartId} className="border rounded-xl p-4 shadow-sm bg-white border-gray-200">
                      {/* ç¬¬ä¸€åˆ—ï¼šåºè™Ÿ + æ“ä½œæŒ‰éˆ• */}
                      <div className="flex items-center justify-between mb-2">
                        <div className="w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm bg-purple-100 text-purple-600">
                          {index + 1}
                        </div>
                        <div className="flex gap-1.5">
                          <button onClick={() => uploadImage(item.cartId)} className="w-8 h-8 bg-gray-50 rounded-lg flex items-center justify-center text-gray-700">
                            <Icons.Camera className="w-4 h-4" />
                          </button>
                          <button onClick={() => copyCartItem(item.cartId)} className="w-8 h-8 bg-gray-50 rounded-lg flex items-center justify-center text-gray-700">
                            <Icons.Copy className="w-4 h-4" />
                          </button>
                          <button onClick={() => deleteFromCart(item.cartId)} className="w-8 h-8 bg-gray-50 rounded-lg flex items-center justify-center text-gray-700">
                            <Icons.Trash className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                      
                      {/* ç¬¬äºŒåˆ—ï¼šå“å */}
                      <div className={`font-bold text-lg mb-1 cursor-pointer active:text-indigo-600 ${isOutOfStock ? 'text-red-800' : isLowStock ? 'text-orange-800' : 'text-gray-900'}`} onClick={() => reSelectProduct(item.cartId)}>{item.name || 'æœªå‘½åç”¢å“'}</div>
                      
                      {/* ç¬¬ä¸‰åˆ—ï¼šè¦æ ¼ */}
                      <div className="text-lg text-gray-500 mb-3 cursor-pointer active:text-indigo-600" onClick={() => { setSearch(item.name || ''); setShowProductSearch(true); }}>{item.specDetail || 'ç„¡è¦æ ¼èªªæ˜'}</div>

                      {/* ç¬¬å››åˆ—ï¼šä»¶æ•¸ã€å–®åƒ¹ã€ç­‰ç´š */}
                      <div className="grid grid-cols-3 gap-2 mb-3">
                        <div>
                          <label className="text-xs font-medium text-gray-500 block mb-1.5">
                            {extractPackInfo(item.specDetail) ? 'ä»¶æ•¸' : 'æ•¸é‡'}
                          </label>
                          <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden bg-white">
                            <button 
                              type="button"
                              onMouseDown={e => e.preventDefault()}
                              onClick={() => updateCart(item.cartId, 'qty', Math.max(0, (item.qty || 1) - 1))} 
                              className="w-8 h-10 bg-gray-50 flex items-center justify-center text-gray-500 text-lg border-r border-gray-300 active:bg-gray-200 select-none"
                            >âˆ’</button>
                            <input 
                              type="text" 
                              inputMode="decimal"
                              pattern="[0-9]*"
                              className="w-12 h-10 text-center font-bold text-base text-gray-900 outline-none border-none bg-transparent"
                              value={item.qty} 
                              onChange={e => updateCart(item.cartId, 'qty', parseFloat(e.target.value) || 0)}
                              onFocus={e => e.target.select()}
                            />
                            <button 
                              type="button"
                              onMouseDown={e => e.preventDefault()}
                              onClick={() => updateCart(item.cartId, 'qty', (item.qty || 0) + 1)} 
                              className="w-8 h-10 bg-gray-50 flex items-center justify-center text-gray-500 text-lg border-l border-gray-300 active:bg-gray-200 select-none"
                            >+</button>
                          </div>
                        </div>

                        <div>
                          <label className="text-xs font-medium text-gray-500 block mb-1.5">å–®åƒ¹</label>
                          <div className="relative">
                            <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">$</span>
                            <input 
                              type="text" 
                              inputMode="decimal"
                              pattern="[0-9]*"
                              className="w-full h-10 pl-6 pr-2 border border-gray-300 rounded-lg text-center font-bold text-base text-gray-900 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
                              value={item.price} 
                              onChange={e => updateCart(item.cartId, 'price', parseFloat(e.target.value) || 0)}
                              onFocus={e => e.target.select()}
                            />
                          </div>
                        </div>

                        <div>
                          <label className="text-xs font-medium text-gray-500 block mb-1.5">ç­‰ç´š</label>
                          <button onClick={() => showPriceSelector(item.cartId)} className="w-full h-10 px-2 bg-white border border-gray-300 rounded-lg font-semibold text-xs text-gray-700 flex items-center justify-between">
                            <span>{(() => {
                              const tier = item.selectedTier || custInfo.tier;
                              if (tier.includes('é–€å¸‚')) return 'é–€å¸‚';
                              if (tier.includes('æœƒå“¡')) return 'æœƒå“¡';
                              if (tier.includes('é¤å»³')) return 'é¤å»³';
                              if (tier.includes('ç”Ÿæ„')) return 'ç”Ÿæ„';
                              if (tier.includes('æ•´ä»¶')) return 'æ•´ä»¶';
                              if (tier.includes('VIP')) return 'VIP';
                              if (tier.includes('åº•åƒ¹') || tier.includes('æ¥­å‹™')) return 'åº•åƒ¹';
                              return tier;
                            })()}</span>
                            <svg className="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7"></path>
                            </svg>
                          </button>
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        {/* åº«å­˜ç‹€æ…‹ */}
                        <div className="flex items-center gap-1 flex-shrink-0">
                          <span className={`text-xs px-1.5 py-1 rounded font-bold ${
                            isOutOfStock ? 'bg-red-100 text-red-600' : 
                            isLowStock ? 'bg-orange-100 text-orange-600' : 
                            'bg-green-100 text-green-700'
                          }`}>
                            ä¸»{Math.floor(mainTotal)}
                          </span>
                          <span className={`text-xs px-1.5 py-1 rounded font-bold ${
                            otherTotal > 0 ? 'bg-cyan-100 text-cyan-700' : 'bg-gray-100 text-gray-400'
                          }`}>
                            å¤–{Math.floor(otherTotal)}
                          </span>
                          {isOutOfStock && <span className="text-xs font-bold text-red-600">ç¼ºè²¨</span>}
                          {isLowStock && <span className="text-xs font-bold text-orange-600">ä½åº«å­˜</span>}
                        </div>
                        {/* å‚™è¨» */}
                        <input type="text" placeholder="å‚™è¨»" className="flex-1 px-3 py-2.5 border border-gray-200 rounded-lg text-sm text-gray-600 bg-gray-50 focus:bg-white focus:border-gray-300 outline-none min-w-0"
                          value={item.note} onChange={e => updateCart(item.cartId, 'note', e.target.value)} />
                        <div className="text-right flex-shrink-0">
                          <div className="text-xs text-gray-500 mb-0.5">å°è¨ˆ</div>
                          <div className="text-xl font-bold text-indigo-600 whitespace-nowrap">${calculateSubtotal(item).toLocaleString()}</div>
                          {(() => {
                            const displayInfo = getPackDisplayInfo(item);
                            if (displayInfo) {
                              return (
                                <div className="text-xs text-gray-600 mt-0.5 whitespace-nowrap">
                                  {displayInfo.packQty}{displayInfo.packUnit}/ä»¶
                                </div>
                              );
                            }
                            return null;
                          })()}
                        </div>
                      </div>
                    </div>
                  )})}
                </div>
                )}

                {/* åªæœ‰è³¼ç‰©è»Šæœ‰ç”¢å“æ™‚æ‰é¡¯ç¤ºç¶ è‰²æ–°å¢æŒ‰éˆ• */}
                {cart.length > 0 && (
                  <button onClick={() => setShowProductSearch(true)} className="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-base shadow-lg mt-4 flex items-center justify-center gap-2">
                    <Icons.Plus />
                    æ–°å¢ç”¢å“
                  </button>
                )}
              </div>

              <div className="fixed bottom-16 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
                <div className="px-4 py-3 max-w-2xl mx-auto">
                  <div className="flex items-center justify-between">
                    <div className="flex flex-col items-start">
                      <span className="text-xs text-gray-500">ç¸½é‡‘é¡</span>
                      <span className="text-2xl font-bold text-indigo-600">${cart.reduce((sum, item) => sum + calculateSubtotal(item), 0).toLocaleString()}</span>
                    </div>

                    <button onClick={() => setShowProductSearch(true)} className="flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold active:bg-indigo-700 shadow-md">
                      <Icons.Plus className="w-5 h-5" />
                      æ–°å¢ç”¢å“
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* å®¢æˆ¶è©³ç´°è³‡è¨Šå½ˆçª— */}
          {showCustomerDetail && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-end md:items-center justify-center" onClick={() => setShowCustomerDetail(false)}>
              <div className="bg-white w-full md:max-w-lg md:rounded-2xl rounded-t-2xl max-h-[85vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="px-5 py-4 border-b flex justify-between items-center bg-gradient-to-r from-indigo-600 to-indigo-700 text-white">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    å®¢æˆ¶è©³ç´°è³‡æ–™
                  </h3>
                  <button onClick={() => setShowCustomerDetail(false)} className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center text-xl font-bold">Ã—</button>
                </div>

                <div className="p-5 overflow-y-auto" style={{maxHeight: 'calc(85vh - 120px)'}}>
                  <div className="space-y-4">
                    <div>
                      <label className="text-sm font-medium text-gray-700 mb-1.5 block">å®¢æˆ¶åç¨±</label>
                      <input 
                        type="text" 
                        placeholder="è«‹è¼¸å…¥å®¢æˆ¶åç¨±" 
                        className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-gray-900"
                        value={custInfo.name} 
                        onChange={e => setCustInfo({...custInfo, name: e.target.value})} 
                      />
                    </div>

                    <div>
                      <label className="text-sm font-medium text-gray-700 mb-1.5 block">åƒ¹æ ¼ç­‰ç´š</label>
                      <select 
                        className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-gray-900"
                        value={custInfo.tier} 
                        onChange={e => setCustInfo({...custInfo, tier: e.target.value})}
                      >
                        <option value="é–€å¸‚å”®åƒ¹">é–€å¸‚å”®åƒ¹</option>
                        <option value="æœƒå“¡95%">æœƒå“¡95%</option>
                        <option value="é¤å»³90%">é¤å»³90%</option>
                        <option value="ç”Ÿæ„åƒ¹">ç”Ÿæ„åƒ¹</option>
                        <option value="æ•´ä»¶åƒ¹">æ•´ä»¶åƒ¹</option>
                        <option value="VIPåƒ¹">VIPåƒ¹</option>
                        <option value="æ¥­å‹™åº•åƒ¹">æ¥­å‹™åº•åƒ¹</option>
                      </select>
                    </div>

                    <div>
                      <label className="text-sm font-medium text-gray-700 mb-1.5 block">ä»˜æ¬¾æ–¹å¼</label>
                      <select 
                        className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-gray-900"
                        value={custInfo.paymentMethod} 
                        onChange={e => setCustInfo({...custInfo, paymentMethod: e.target.value})}
                      >
                        <option value="æœˆçµ30å¤©">æœˆçµ30å¤©</option>
                        <option value="æœˆçµ60å¤©">æœˆçµ60å¤©</option>
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
                        <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                        <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                      </select>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="text-sm font-medium text-gray-700 mb-1.5 block">é›»è©±</label>
                        <input 
                          type="tel" 
                          placeholder="é›»è©±" 
                          className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-gray-900"
                          value={custInfo.phone} 
                          onChange={e => setCustInfo({...custInfo, phone: e.target.value})} 
                        />
                      </div>
                      <div>
                        <label className="text-sm font-medium text-gray-700 mb-1.5 block">æ‰‹æ©Ÿ</label>
                        <input 
                          type="tel" 
                          placeholder="æ‰‹æ©Ÿ" 
                          className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-gray-900"
                          value={custInfo.mobile} 
                          onChange={e => setCustInfo({...custInfo, mobile: e.target.value})} 
                        />
                      </div>
                    </div>

                    <div>
                      <label className="text-sm font-medium text-gray-700 mb-1.5 block">åœ°å€</label>
                      <input 
                        type="text" 
                        placeholder="åœ°å€" 
                        className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-gray-900"
                        value={custInfo.address} 
                        onChange={e => setCustInfo({...custInfo, address: e.target.value})} 
                      />
                    </div>

                    <div>
                      <label className="text-sm font-medium text-gray-700 mb-1.5 block">æ—¥æœŸ</label>
                      <input 
                        type="date" 
                        className="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all text-gray-900"
                        value={custInfo.date} 
                        onChange={e => setCustInfo({...custInfo, date: e.target.value})} 
                      />
                    </div>
                  </div>
                </div>

                <div className="p-4 border-t bg-gray-50">
                  <button 
                    onClick={() => setShowCustomerDetail(false)}
                    className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 active:bg-indigo-800 transition-colors"
                  >
                    å®Œæˆ
                  </button>
                </div>
              </div>
            </div>
          )}


          {/* ç”¢å“æœå°‹å½ˆçª— */}
          {showProductSearch && (
            <div className="fixed inset-0 bg-black/60 z-[100] flex items-end sm:items-center justify-center">
              <div className="bg-gray-50 w-full sm:max-w-xl sm:rounded-2xl flex flex-col overflow-hidden shadow-2xl sm:m-4" style={{maxHeight: '92vh'}}>
                {/* æ¨™é¡Œèˆ‡æœå°‹ */}
                <div className="px-4 py-3 bg-purple-600">
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-white font-bold text-lg">{reSelectCartId ? 'ğŸ”„ é‡æ–°é¸æ“‡ç”¢å“' : 'â• æ–°å¢ç”¢å“'}</div>
                    <button onClick={() => { setShowProductSearch(false); setSearch(''); setReSelectCartId(null); }} className="text-white/90 hover:text-white font-bold text-base">è¿”å›</button>
                  </div>
                  <input 
                    autoFocus 
                    placeholder="æœå°‹ç”¢å“åç¨±æˆ–å“è™Ÿ..." 
                    className="w-full px-4 py-3 rounded-xl text-gray-800 text-base outline-none" 
                    value={search} 
                    onChange={e => setSearch(e.target.value)} 
                  />
                </div>

                {/* ç”¢å“åˆ—è¡¨ */}
                <div className="flex-1 overflow-auto p-3">
                  {!data.products || Object.keys(data.products).length === 0 ? (
                    <div className="text-center text-gray-500 py-16">
                      <div className="text-5xl mb-3">ğŸ“¦</div>
                      <p className="text-base font-medium">å°šç„¡ç”¢å“è³‡æ–™</p>
                    </div>
                  ) : filteredProds.length === 0 ? (
                    <div className="text-center text-gray-500 py-16">
                      <div className="text-5xl mb-3">ğŸ”</div>
                      <p className="text-base font-medium">æ‰¾ä¸åˆ°ã€Œ{search}ã€</p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {filteredProds.slice(0, 50).map(key => {
                        const group = data.products[key];
                        if (!group || !Array.isArray(group)) return null;
                        
                        // å…ˆéæ¿¾æ‰åœå”®å“ï¼Œè¨ˆç®—æœ‰æ•ˆè¦æ ¼æ•¸é‡
                        const activeSpecs = group.filter(spec => spec && !data.discontinuedProducts?.[spec.id]);
                        // å¦‚æœæ‰€æœ‰è¦æ ¼éƒ½åœå”®ï¼Œä¸é¡¯ç¤ºé€™å€‹ç”¢å“çµ„
                        if (activeSpecs.length === 0) return null;
                        
                        return (
                          <div key={key}>
                            {/* å“åæ¨™é¡Œ - ç´«è‰²æ¼¸å±¤ */}
                            <div className="px-4 py-2.5 bg-gradient-to-r from-purple-600 to-purple-500 text-white font-black text-lg rounded-xl flex items-center justify-between mb-2">
                              <span>{key}</span>
                              <span className="text-sm text-purple-200 font-medium">{activeSpecs.length} é …</span>
                            </div>
                            {/* è¦æ ¼åˆ—è¡¨ - ç¨ç«‹å¡ç‰‡å¼ */}
                            <div className="space-y-2">
                              {activeSpecs.map((spec, i) => {
                                
                                // æ ¹æ“šè§’è‰²é¸æ“‡å€‰åº«å’Œå®‰å…¨åº«å­˜
                                const currentWarehouses = role === 'store' ? STORE_WAREHOUSES : FACTORY_WAREHOUSES;
                                const currentSafetyStockData = role === 'store' ? (data.storeSafetyStock || {}) : (data.safetyStock || {});
                                
                                const stocks = data.inventory[spec.id] || [];
                                // ä¸»å€‰åº«å­˜
                                const mainStocks = stocks.filter(s => currentWarehouses.includes(s.warehouse));
                                const mainTotal = mainStocks.reduce((s, x) => s + (x.stock || 0), 0);
                                // å¤–å€‰åº«å­˜
                                const otherStocks = stocks.filter(s => !currentWarehouses.includes(s.warehouse) && s.stock > 0);
                                const otherTotal = otherStocks.reduce((s, x) => s + (x.stock || 0), 0);
                                
                                const price = (spec.prices && spec.prices[custInfo.tier]) || 0;
                                const isInCart = cart.some(item => item.id === spec.id && item.specDetail === spec.specDetail);
                                const isOutOfStock = mainTotal === 0;
                                // ä½¿ç”¨å®‰å…¨åº«å­˜å€¼åˆ¤æ–·ä½åº«å­˜
                                const safetyLine = currentSafetyStockData?.[spec.id] ?? DEFAULT_SAFETY_STOCK;
                                const isLowStock = mainTotal > 0 && mainTotal < safetyLine;
                                const isExpanded = expandedStockId === spec.id;
                                
                                return (
                                  <div 
                                    key={i} 
                                    className={`rounded-xl p-3 shadow-sm border flex flex-col ${
                                      isInCart ? 'border-purple-400 bg-purple-50' : 'border-gray-200 bg-white'
                                    }`}
                                  >
                                    <div className="flex items-center gap-3">
                                      {/* å·¦å´ï¼šç”¢å“è³‡è¨Š */}
                                      <div className="flex-1 min-w-0">
                                        {/* ç¬¬ä¸€è¡Œï¼šè¦æ ¼ */}
                                        <div className="flex items-center gap-2 flex-wrap">
                                          <span className="font-black text-lg text-gray-900">{spec.specDetail || '(ç„¡è¦æ ¼)'}</span>
                                        </div>
                                        {/* ç¬¬äºŒè¡Œï¼šå“è™Ÿ */}
                                        <div className="text-sm text-gray-500 mt-0.5">{spec.id}</div>
                                        {/* ç¬¬ä¸‰è¡Œï¼šåº«å­˜è³‡è¨Š - ä¸»å€‰+å¤–å€‰+è­¦ç¤ºåŒè¡Œ */}
                                        <div className="flex items-center gap-2 mt-1.5 flex-wrap">
                                          <span className={`text-sm px-2 py-0.5 rounded font-bold ${
                                            isOutOfStock ? 'bg-red-100 text-red-600' : 
                                            isLowStock ? 'bg-orange-100 text-orange-600' : 
                                            'bg-green-100 text-green-700'
                                          }`}>
                                            ä¸»å€‰ {Math.floor(mainTotal)}
                                          </span>
                                          {otherTotal > 0 && (
                                            <button 
                                              onClick={(e) => { e.stopPropagation(); setExpandedStockId(isExpanded ? null : spec.id); }}
                                              className="text-sm px-2 py-0.5 rounded font-bold bg-cyan-100 text-cyan-700 hover:bg-cyan-200 transition-colors flex items-center gap-1"
                                            >
                                              å¤–å€‰ {Math.floor(otherTotal)}
                                              <span className="text-xs">{isExpanded ? 'â–²' : 'â–¼'}</span>
                                            </button>
                                          )}
                                          {otherTotal === 0 && (
                                            <span className="text-sm px-2 py-0.5 rounded font-medium bg-gray-100 text-gray-400">
                                              å¤–å€‰ 0
                                            </span>
                                          )}
                                          {/* è­¦ç¤ºæ–‡å­— - åŒä¸€è¡Œ */}
                                          {isOutOfStock && (
                                            <span className="text-sm font-bold text-red-600">
                                              ç¼ºè²¨{otherTotal > 0 ? 'ï¼Œå¯å¾å¤–å€‰èª¿è²¨' : ''}
                                            </span>
                                          )}
                                          {isLowStock && (
                                            <span className="text-sm font-bold text-orange-600">
                                              ä½æ–¼å®‰å…¨å€¼({safetyLine}){otherTotal > 0 ? 'ï¼Œå¤–å€‰å¯èª¿è²¨' : ''}
                                            </span>
                                          )}
                                        </div>
                                      </div>
                                      
                                      {/* å³å´ï¼šåƒ¹æ ¼ */}
                                      <div className="text-right flex-shrink-0">
                                        <div className="font-black text-xl text-purple-600">${price}</div>
                                      </div>
                                      
                                      {/* æŒ‰éˆ•ï¼šå·²é¸æ“‡æ™‚å†æŒ‰å¯å–æ¶ˆ */}
                                      <button
                                        onClick={() => addProductFromDB(spec)}
                                        title={isInCart ? 'é»æ“Šå–æ¶ˆé¸æ“‡' : 'é»æ“ŠåŠ å…¥'}
                                        className={`w-12 h-12 rounded-xl font-bold text-2xl flex items-center justify-center flex-shrink-0 transition-all ${
                                          isInCart 
                                            ? 'bg-green-500 hover:bg-red-500 text-white shadow-md' 
                                            : 'bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white shadow-md'
                                        }`}
                                      >
                                        {isInCart ? 'âœ“' : '+'}
                                      </button>
                                    </div>
                                    
                                    {/* å¤–å€‰å±•é–‹æ˜ç´° */}
                                    {isExpanded && otherTotal > 0 && (
                                      <div className="mt-2 pt-2 border-t border-gray-100">
                                        <div className="text-xs text-gray-500 mb-1">å¤–å€‰æ˜ç´°ï¼š</div>
                                        <div className="flex flex-wrap gap-1">
                                          {otherStocks.map((s, k) => (
                                            <span key={k} className="text-xs px-2 py-1 rounded bg-cyan-50 text-cyan-700 font-medium">
                                              {s.warehouse}: {Math.floor(s.stock)}
                                            </span>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* åƒ¹æ ¼é¸æ“‡å½ˆçª— */}
          {showPriceModal && currentPriceItem && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setShowPriceModal(false)}>
              <div className="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="px-6 py-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <Icons.DollarSign />
                    é¸æ“‡åƒ¹æ ¼
                  </h3>
                  <button onClick={() => setShowPriceModal(false)} className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center text-xl font-bold">âœ•</button>
                </div>

                <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)]">
                  {(() => {
                    const item = cart.find(i => i.cartId === currentPriceItem);
                    if (!item || !item.prices) return null;
                    
                    // å›ºå®šçš„7å€‹åƒ¹æ ¼ç­‰ç´šé †åºï¼ˆç”±é«˜åˆ°ä½ï¼‰
                    const priceOrder = [
                      'é–€å¸‚å”®åƒ¹',
                      'æœƒå“¡95%',
                      'é¤å»³90%',
                      'ç”Ÿæ„åƒ¹',
                      'æ•´ä»¶åƒ¹',
                      'VIPåƒ¹',
                      'æ¥­å‹™åº•åƒ¹'
                    ];
                    
                    return (
                      <div className="space-y-3">
                        {priceOrder.map((tier) => {
                          const price = item.prices[tier];
                          // åªæœ‰ç•¶åƒ¹æ ¼æ˜¯ undefined æˆ– null æ™‚æ‰ä¸é¡¯ç¤ºï¼Œ0 è¦é¡¯ç¤º
                          if (price === undefined || price === null) return null;
                          
                          return (
                            <button 
                              key={tier}
                              onClick={() => selectPrice(tier, price)}
                              className="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-colors text-left"
                            >
                              <div className="flex justify-between items-center">
                                <div>
                                  <div className="text-sm text-gray-500">{tier}</div>
                                  <div className="text-2xl font-bold text-purple-600">${price.toLocaleString()}</div>
                                </div>
                                {(item.selectedTier || custInfo.tier) === tier && (
                                  <span className="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-bold">ç›®å‰ç­‰ç´š</span>
                                )}
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          )}

          {/* æ­·å²å ±åƒ¹å½ˆçª— */}
          {showHistory && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setShowHistory(false)}>
              <div className="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="px-6 py-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <Icons.Clock />
                    æ­·å²å ±åƒ¹
                  </h3>
                  <button onClick={() => setShowHistory(false)} className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center text-xl font-bold">âœ•</button>
                </div>

                <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)]">
                  {quotes.length === 0 ? (
                    <p className="text-center text-gray-400 py-10">å°šç„¡æ­·å²å ±åƒ¹</p>
                  ) : (
                    <div className="space-y-2">
                      {[...quotes].reverse().map(quote => {
                        const date = new Date(quote.date);
                        const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                        return (
                          <div key={quote.id} className="p-4 border-2 border-gray-200 rounded-xl">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <div className="font-bold">{quote.customer.name || 'æœªå‘½åå®¢æˆ¶'}</div>
                                <div className="text-xs text-gray-500">{dateStr} â€¢ {quote.customer.tier}</div>
                              </div>
                              <div className="text-right">
                                <div className="text-xl font-bold text-purple-600">${quote.total.toLocaleString()}</div>
                                <div className="text-xs text-gray-500">{quote.products.length} é …</div>
                              </div>
                            </div>
                            <div className="flex gap-2 mt-3">
                              <button onClick={() => loadQuote(quote.id)} className="flex-1 bg-purple-500 text-white py-2 rounded-lg font-bold">è¼‰å…¥</button>
                              <button onClick={() => deleteQuote(quote.id)} className="px-4 bg-red-100 text-red-600 py-2 rounded-lg font-bold">åˆªé™¤</button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* åº•éƒ¨å°èˆª */}
          <BottomNav />
          {/* å…¨å±€å½ˆçª— */}
          <GlobalModals />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>