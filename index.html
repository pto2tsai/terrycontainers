<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²¨æ«ƒç®¡ç†ç³»çµ± V79.0</title>
    
    <!-- V79.0: PDF.js for PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // V79.0: è¨­å®š PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        
        window.onerror = function(msg, url, line, col, error) {
            if (msg && msg.toLowerCase().indexOf("script error") > -1) return false;
            setTimeout(function() {
                var root = document.getElementById('root');
                if (root && root.innerHTML.trim().length > 0 && root.innerHTML.indexOf('ç³»çµ±å•Ÿå‹•ä¸­') === -1) return;
                var div = document.createElement("div");
                div.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:white; color:#333; padding:20px; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;";
                div.innerHTML = `<h2 style="color:#dc2626;font-size:20px;font-weight:bold;margin-bottom:10px">âš ï¸ ç³»çµ±è¼‰å…¥ç•°å¸¸</h2><div style="background:#f3f4f6;padding:15px;border:1px solid #ddd;border-radius:8px;font-size:12px;text-align:left;max-width:90%;overflow:auto;margin-bottom:20px">Line: ${line}<br>${msg}</div><button onclick="window.location.reload()" style="padding:12px 30px;background:#2563eb;color:white;border:none;border-radius:50px;font-weight:bold;cursor:pointer;">é‡æ–°æ•´ç†</button>`;
                document.body.appendChild(div);
                var loader = document.getElementById('loading-screen');
                if(loader) loader.style.display = 'none';
            }, 3000);
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- V79.3: xlsx-js-style for Excel with styles (borders, fonts) -->
    <script src="https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        /* ========================================
           V79.0 è¨­è¨ˆç³»çµ± - Design Tokens
           ======================================== */
        
        :root {
            /* === å­—é«”ç³»çµ± === */
            --font-family-base: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            --font-family-mono: "SF Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            
            /* å­—é«”å¤§å°éšå±¤ - ç³»çµ±åŒ–è¨­è¨ˆ V79.4 */
            --text-2xs: 10px;   /* æ¥µå°ï¼šå¾½ç« ã€æ¬¡è¦æ¨™ç±¤ */
            --text-xs: 12px;    /* å°ï¼šè¡¨é ­ã€æ¨™ç±¤ã€è¼”åŠ©æ–‡å­— */
            --text-sm: 14px;    /* æ¨™æº–ï¼šè¡¨æ ¼å…§å®¹ã€æŒ‰éˆ•ã€ä¸€èˆ¬æ–‡å­— */
            --text-base: 16px;  /* åŸºæº–ï¼šè¼¸å…¥æ¡†ã€ä¸»è¦å…§å®¹ */
            --text-lg: 18px;    /* å¤§ï¼šå¡ç‰‡æ¨™é¡Œã€é‡è¦æ•¸å­— */
            --text-xl: 20px;    /* ç‰¹å¤§ï¼šé é¢æ¨™é¡Œ */
            --text-2xl: 24px;   /* è¶…å¤§ï¼šçµ±è¨ˆæ•¸å­— */
            --text-3xl: 30px;   /* å·¨å¤§ï¼šå¤§å‹çµ±è¨ˆæ•¸å­— */
            
            /* èªæ„åŒ–å­—é«”å¤§å° - æ–¹ä¾¿ä½¿ç”¨ */
            --font-size-label: var(--text-xs);      /* æ¨™ç±¤æ–‡å­— */
            --font-size-body: var(--text-sm);       /* å…§æ–‡ */
            --font-size-input: var(--text-base);    /* è¼¸å…¥æ¡† */
            --font-size-title: var(--text-lg);      /* æ¨™é¡Œ */
            --font-size-heading: var(--text-xl);    /* å¤§æ¨™é¡Œ */
            --font-size-display: var(--text-2xl);   /* å±•ç¤ºæ•¸å­— */
            --font-size-table-head: var(--text-xs); /* è¡¨æ ¼æ¨™é¡Œ */
            --font-size-table-body: var(--text-sm); /* è¡¨æ ¼å…§å®¹ */
            
            /* å­—é‡ */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;
            
            /* è¡Œé«˜ */
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;
            
            /* === é–“è·ç³»çµ± (4px åŸºç¤) === */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            
            /* === åœ“è§’ç³»çµ± === */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
            --radius-full: 9999px;
            
            /* === è‰²å½©ç³»çµ± === */
            --color-primary: #2563eb;
            --color-primary-light: #3b82f6;
            --color-primary-dark: #1d4ed8;
            
            --color-success: #059669;
            --color-success-light: #10b981;
            --color-warning: #d97706;
            --color-warning-light: #f59e0b;
            --color-danger: #dc2626;
            --color-danger-light: #ef4444;
            
            /* èªç¾©åŒ–æ•¸æ“šè‰²å½© */
            --color-quantity: #2563eb;
            --color-weight: #ea580c;
            --color-amount: #059669;
            
            /* ä¸­æ€§è‰² */
            --color-bg: #f3f4f6;
            --color-bg-card: #ffffff;
            --color-bg-input: #f9fafb;
            --color-border: #e5e7eb;
            --color-border-focus: #3b82f6;
            
            --color-text-primary: #111827;
            --color-text-secondary: #4b5563;
            --color-text-tertiary: #6b7280;
            --color-text-placeholder: #9ca3af;
            
            /* === è§¸æ§ç›®æ¨™ === */
            --touch-target-min: 44px;
            --touch-target-comfortable: 48px;
            
            /* === é™°å½± === */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            
            /* === éæ¸¡å‹•ç•« === */
            --transition-fast: 150ms;
            --transition-normal: 200ms;
            --transition-slow: 300ms;
        }
        
        /* ========================================
           åŸºç¤æ¨£å¼
           ======================================== */
        
        body { background-color: var(--color-bg); font-family: var(--font-family-base); font-size: var(--text-base); line-height: var(--leading-normal); color: var(--color-text-primary); margin: 0; -webkit-font-smoothing: antialiased; }
        
        /* Loading */
        #loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--color-border); border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ========================================
           UI å…ƒä»¶
           ======================================== */
        
        .ios-card { background: var(--color-bg-card); border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); margin-bottom: var(--space-4); border: 1px solid var(--color-border); overflow: hidden; }
        .ios-card:active { transform: scale(0.995); transition: transform 0.1s; }
        
        .reconcile-table { width: 100%; border-collapse: collapse; background: white; }
        .reconcile-table th, .reconcile-table td { padding: 10px 6px; border-bottom: 1px solid var(--color-border); white-space: nowrap; text-align: left; }
        .reconcile-table th { background: var(--color-bg-input); color: var(--color-text-tertiary); font-weight: var(--font-semibold); font-size: var(--font-size-table-head); }
        .reconcile-table td { color: var(--color-text-secondary); vertical-align: middle; font-size: var(--font-size-table-body); }
        .reconcile-table tr:hover { background-color: var(--color-bg-input); cursor: pointer; }
        .reconcile-table th.col-right, .reconcile-table td.col-right { text-align: right !important; }
        .reconcile-table th.col-center, .reconcile-table td.col-center { text-align: center !important; }
        .reconcile-table .col-product { max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
        
        .amt-paid { color: var(--color-text-primary); font-weight: 700; font-family: var(--font-family-mono); font-size: var(--text-base); }
        .amt-unpaid { background-color: white; color: var(--color-danger); border: 1px solid var(--color-danger-light); border-radius: var(--radius-sm); padding: 2px 6px; font-weight: 700; font-family: var(--font-family-mono); font-size: var(--text-base); white-space: nowrap; display: inline-block; }

        .tag-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: var(--radius-sm); font-size: var(--text-xs); font-weight: var(--font-semibold); letter-spacing: 0.3px; white-space: nowrap; }
        .company-tag { font-size: var(--text-base); font-weight: 800; padding: var(--space-1) var(--space-3); border-radius: var(--radius-sm); display: inline-block; }
        
        /* è¡¨å–®è¼¸å…¥æ¡† - çµ±ä¸€ 48px é«˜åº¦ */
        .input-bg-style { background-color: var(--color-bg-card); border: 1.5px solid var(--color-border); color: var(--color-text-primary); transition: all var(--transition-fast); height: var(--touch-target-comfortable); padding: 0 var(--space-3); font-size: var(--text-base); border-radius: var(--radius-md); width: 100%; }
        .input-bg-style:focus { border-color: var(--color-border-focus); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); background: white; }
        .input-bg-style::placeholder { color: var(--color-text-placeholder); font-weight: var(--font-semibold); font-size: var(--text-base); }
        
        /* æ¨™ç±¤ - 14px */
        label { font-size: var(--text-sm); font-weight: var(--font-bold); color: var(--color-text-tertiary); margin-bottom: var(--space-1); display: block; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .product-grid-cols { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 2px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 400px; max-height: 80vh; border-radius: var(--radius-xl); padding: var(--space-5); overflow-y: auto; box-shadow: var(--shadow-lg); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { opacity: 1; transform: translateY(0); } }
        
        /* çµ±è¨ˆè¡¨æ ¼æ¨£å¼ */
        .stats-table { width: 100%; text-align: right; border-collapse: collapse; }
        .stats-table th { text-align: right; padding: var(--space-2); background: var(--color-bg-input); color: var(--color-text-tertiary); font-size: var(--text-xs); }
        .stats-table td { padding: var(--space-2); border-bottom: 1px solid var(--color-bg); font-family: var(--font-family-mono); font-size: var(--text-base); }
        .stats-table tr:last-child td { border-bottom: none; }
        
        /* è¡¨å–®é©—è­‰æ¨£å¼ */
        .input-error { border-color: var(--color-danger-light) !important; background-color: #fef2f2 !important; }
        .input-error:focus { outline: 2px solid #fecaca !important; }
        .label-required::after { content: ' *'; color: var(--color-danger); }
        .validation-toast { position: fixed; top: var(--space-5); left: 50%; transform: translateX(-50%); background: #fef2f2; border: 1px solid #fecaca; color: var(--color-danger); padding: var(--space-3) var(--space-5); border-radius: var(--radius-lg); font-size: var(--text-sm); font-weight: var(--font-semibold); z-index: 9999; animation: toastIn 0.3s ease-out; box-shadow: var(--shadow-md); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        /* å´é‚Šæ¬„å°èˆªæ¨£å¼ */
        .sidebar-link { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3) var(--space-4); border-radius: var(--radius-lg); font-weight: var(--font-semibold); font-size: var(--text-sm); color: var(--color-text-tertiary); background: transparent; border: none; text-align: left; cursor: pointer; transition: all var(--transition-fast); }
        .sidebar-link:hover { background: var(--color-bg); color: var(--color-text-secondary); }
        .sidebar-link.active { background: #eff6ff; color: var(--color-primary); }
        
        /* ========================================
           V79.0: æ‰‹æ©Ÿå‹å–„è¡¨å–®æ¨£å¼
           ======================================== */
        
        /* å¤§è¼¸å…¥æ¡† - çµ±ä¸€ 48px */
        .form-input-lg {
            width: 100%;
            max-width: 100%;
            height: var(--touch-target-comfortable);
            padding: 0 var(--space-4);
            background: var(--color-bg-input);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-lg);
            font-size: var(--text-base);
            color: var(--color-text-primary);
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: all var(--transition-fast);
        }
        .form-input-lg:focus {
            background: white;
            border-color: var(--color-border-focus);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
        }
        .form-input-lg::placeholder { color: var(--color-text-placeholder); }
        .form-input-lg:disabled { background: var(--color-bg); color: var(--color-text-tertiary); }
        .form-input-lg.num-input { text-align: right; font-family: var(--font-family-mono); font-weight: var(--font-semibold); }
        .form-input-lg.error { border-color: var(--color-danger-light); background: #fef2f2; }
        
        /* æ—¥æœŸè¼¸å…¥æ¡†ç‰¹æ®Šè™•ç† */
        input[type="date"].form-input-lg {
            min-width: 0;
            padding-right: var(--space-3);
        }
        
        /* ç¢ºä¿è¡¨å–®æ¬„ä½ä¸æº¢å‡º */
        .ios-card { overflow: hidden; }
        .ios-card form { max-width: 100%; overflow: hidden; }
        .ios-card form > div { max-width: 100%; }
        .ios-card input, .ios-card select { max-width: 100%; min-width: 0; }
        
        /* æ­¥é©Ÿè¡¨å–®å®¹å™¨ */
        .step-form-container { padding: 0 var(--space-1); }
        
        /* å¤§æ¨™ç±¤ - 14px */
        .form-label-lg {
            display: block;
            font-size: var(--text-sm);
            font-weight: var(--font-bold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }
        .form-label-lg .required { color: var(--color-danger); margin-left: var(--space-1); }
        
        /* ========================================
           V79.0: SVG ç·šæ¢åœ–ç¤ºç³»çµ±
           ======================================== */
        
        .icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            flex-shrink: 0;
            display: inline-block;
            vertical-align: middle;
        }
        
        .icon-sm { width: 20px; height: 20px; }
        .icon-lg { width: 28px; height: 28px; }
        .icon-xl { width: 32px; height: 32px; }
        
        /* ========================================
           V79.0: æ•¸æ“šè‰²å½©èªç¾©åŒ–
           ======================================== */
        
        .data-quantity { color: var(--color-quantity); }
        .data-weight { color: var(--color-weight); }
        .data-amount { color: var(--color-amount); }
        
        .data-value {
            font-family: var(--font-family-mono);
            font-weight: var(--font-bold);
            font-size: var(--text-lg);
        }
        
        /* ========================================
           V79.0: æ™ºèƒ½åŒ¯å…¥åŠŸèƒ½æ¨£å¼
           ======================================== */
        
        .import-method-selector {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-6);
        }
        
        .import-method-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding: var(--space-6) var(--space-4);
            background: var(--color-bg-input);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .import-method-card:hover {
            border-color: var(--color-primary-light);
            background: white;
        }
        
        .import-method-card:active {
            transform: scale(0.98);
        }
        
        .import-method-card.selected {
            border-color: var(--color-primary);
            background: #eff6ff;
        }
        
        .import-method-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-lg);
        }
        
        .import-method-icon .icon {
            width: 28px;
            height: 28px;
            stroke: white;
        }
        
        .import-method-title {
            font-size: var(--text-base);
            font-weight: var(--font-bold);
            color: var(--color-text-primary);
        }
        
        .import-method-desc {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            text-align: center;
        }
        
        /* PDF é è¦½å€åŸŸ */
        .pdf-preview-container {
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .pdf-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }
        
        .pdf-preview-title {
            font-size: var(--text-sm);
            font-weight: var(--font-bold);
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .pdf-preview-content {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            line-height: var(--leading-relaxed);
            white-space: pre-wrap;
            word-break: break-word;
            font-family: var(--font-family-mono);
        }
        
        /* æª”æ¡ˆä¸Šå‚³å€åŸŸ */
        .file-drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-8) var(--space-4);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--color-bg-input);
        }
        
        .file-drop-zone:hover {
            border-color: var(--color-primary-light);
            background: white;
        }
        
        .file-drop-zone.dragging {
            border-color: var(--color-primary);
            background: #eff6ff;
        }
        
        .file-drop-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--space-3);
            color: var(--color-text-tertiary);
        }
        
        .file-drop-text {
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-1);
        }
        
        .file-drop-hint {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }
        
        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s;
        }
        .step-dot.active { background: #2563eb; transform: scale(1.2); }
        .step-dot.done { background: #10b981; }
        
        /* æ­¥é©Ÿæ¨™é¡Œ */
        .step-title {
            text-align: center;
            margin-bottom: 24px;
        }
        .step-title .step-num { font-size: var(--text-sm); color: #6b7280; font-weight: 600; }
        .step-title .step-name { font-size: var(--text-xl); font-weight: bold; color: #111827; margin-top: 4px; }
        
        /* æŠ˜ç–Šå€å¡Š */
        .accordion-section {
            background: white;
            border: 1.5px solid #e5e7eb;
            border-radius: 14px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .accordion-section.active { border-color: #3b82f6; }
        .accordion-section.has-error { border-color: #ef4444; }
        
        .accordion-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .accordion-header:active { background: #f9fafb; }
        .accordion-section.active .accordion-header { background: #eff6ff; }
        
        .accordion-title { font-size: var(--text-lg); font-weight: bold; color: #374151; }
        .accordion-section.active .accordion-title { color: #1e40af; }
        .accordion-subtitle { font-size: var(--text-xs); color: #9ca3af; margin-top: 2px; }
        
        .accordion-arrow { font-size: var(--text-lg); color: #9ca3af; transition: transform 0.2s; }
        .accordion-section.active .accordion-arrow { transform: rotate(90deg); color: #3b82f6; }
        
        .accordion-content {
            padding: 0 16px 16px;
            display: none;
        }
        .accordion-section.active .accordion-content { display: block; }
        
        /* ç”¢å“å¡ç‰‡ï¼ˆå¤§ç‰ˆæœ¬ï¼‰ */
        .product-card-lg {
            background: #f9fafb;
            border: 1.5px solid #e5e7eb;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .product-card-lg.error { border-color: #fca5a5; background: #fef2f2; }
        
        /* ç”¢å“é¸æ“‡æŒ‰éˆ• */
        .product-picker-btn {
            width: 100%;
            height: 52px;
            padding: 0 16px;
            background: #f0f9ff;
            border: 1.5px solid #93c5fd;
            border-radius: 12px;
            font-size: var(--text-lg);
            color: #1e40af;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }
        .product-picker-btn:active { background: #dbeafe; }
        .product-picker-btn.empty { color: #9ca3af; background: #f9fafb; border-color: #e5e7eb; }
        
        /* Bottom Sheet */
        .bottom-sheet-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 60; opacity: 0; animation: fadeIn 0.2s ease-out forwards; 
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .bottom-sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; border-radius: 20px 20px 0 0; 
            z-index: 61; max-height: 80vh; 
            display: flex; flex-direction: column;
            transform: translateY(100%); 
            animation: slideUpSheet 0.3s ease-out forwards;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }
        /* é›»è…¦ç‰ˆï¼šæ”¹ç‚ºå±…ä¸­å½ˆçª— */
        @media (min-width: 768px) {
            .bottom-sheet {
                bottom: auto; left: 50%; right: auto;
                top: 50%; transform: translate(-50%, -50%);
                width: 480px; max-width: 90vw;
                border-radius: 20px;
                max-height: 70vh;
                animation: fadeInScale 0.2s ease-out forwards;
            }
        }
        @keyframes fadeInScale { 
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes slideUpSheet { to { transform: translateY(0); } }
        .bottom-sheet-handle { width: 40px; height: 5px; background: #d1d5db; border-radius: 3px; margin: 12px auto 8px; }
        /* é›»è…¦ç‰ˆéš±è—æ‹–æ›³æŠŠæ‰‹ */
        @media (min-width: 768px) {
            .bottom-sheet-handle { display: none; }
        }
        .bottom-sheet-header { padding: 0 20px 16px; border-bottom: 1px solid #e5e7eb; }
        @media (min-width: 768px) {
            .bottom-sheet-header { padding: 20px 20px 16px; }
        }
        .bottom-sheet-content { flex: 1; overflow-y: auto; padding: 12px 20px 24px; -webkit-overflow-scrolling: touch; }
        
        /* ç”¢å“åˆ—è¡¨é …ç›®ï¼ˆå¤§ç‰ˆæœ¬ï¼‰ */
        .product-item-lg { 
            padding: 16px; 
            margin: 0 -8px; 
            border-radius: 12px;
            cursor: pointer; 
            border-bottom: 1px solid #f3f4f6;
        }
        .product-item-lg:active { background: #eff6ff; }
        .product-item-lg .name { font-size: var(--text-lg); font-weight: 600; color: #111827; }
        .product-item-lg .spec { font-size: var(--text-sm); color: #3b82f6; margin-top: 4px; }
        .product-item-lg .code { font-size: var(--text-xs); color: #9ca3af; font-family: monospace; }
    </style>
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div><div style="margin-top:15px;color:#666;font-weight:bold">ç³»çµ±å•Ÿå‹•ä¸­...</div></div>
    <div id="root"></div>

    <script>
        setTimeout(function() {
            var loader = document.getElementById('loading-screen');
            if(loader) loader.remove();
        }, 3500);
    </script>

    <script type="text/babel">
        // --- 0. Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center"><h1 className="text-xl font-bold text-red-600">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h1><button onClick={()=>window.location.reload()} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded">é‡æ•´</button></div>;
                return this.props.children;
            }
        }

        // --- 1. Config ---
        const DOMESTIC_FLAG = 'åœ‹å…§æ¡è³¼';
        const IMPORT_COMPANIES = ['å´‡æ–‡å†·å‡', 'å…«æ–¹ç’°çƒ'];
        const CUSTOMS_BROKERS = ['åŸç¢©', 'å°šé´»', DOMESTIC_FLAG];
        const DEFAULT_ORIGINS = ['å„ç“œå¤š', 'å·´æ‹¿é¦¬', 'ç“œåœ°é¦¬æ‹‰', 'å®éƒ½æ‹‰æ–¯', 'æ³°åœ‹', 'å°å°¼', 'å°åº¦', 'ä¸­åœ‹', 'æ™ºåˆ©', 'æŒªå¨'];
        const PAYMENT_TERMS_DOMESTIC = ['ç¾é‡‘', 'æœˆçµ 30 å¤©', 'æœˆçµ 45 å¤©', 'æœˆçµ 60 å¤©', 'å…¶ä»–'];
        
        // V73.0: ç§»é™¤ç¡¬ç·¨ç¢¼çš„ ADMIN_EMAILSï¼Œæ”¹ç‚ºå®Œå…¨å¾ Firestore settings/config è®€å–
        // ç®¡ç†å“¡å’Œè§’è‰²è¨­å®šç¾åœ¨çµ±ä¸€åœ¨ Firestore ä¸­ç®¡ç†ï¼Œæå‡å®‰å…¨æ€§

        // V72.0: çµ±ä¸€ç®¡ç†æ–‡å­—å­—ä¸²ï¼Œä¾¿æ–¼ç¶­è­·å’Œæœªä¾†å¤šèªè¨€æ”¯æ´
        const TEXT = {
            // ç³»çµ±
            APP_NAME: 'è²¨æ«ƒç®¡ç†ç³»çµ±',
            LOADING: 'ç³»çµ±å•Ÿå‹•ä¸­...',
            LOADING_DATA: 'Loading...',
            
            // ç™»å…¥
            LOGIN_TITLE: 'è²¨æ«ƒç®¡ç†ç³»çµ±',
            LOGIN_STAFF: 'å“¡å·¥ç™»å…¥',
            LOGIN_GUEST: 'è¨ªå®¢ç™»å…¥',
            LOGIN_FAILED: 'ç™»å…¥å¤±æ•—',
            GUEST_LOGIN_FAILED: 'è¨ªå®¢ç™»å…¥å¤±æ•—',
            LOGOUT: 'ç™»å‡º',
            
            // æ¬Šé™èˆ‡éŒ¯èª¤
            PERMISSION_DENIED: 'æ¬Šé™ä¸è¶³',
            SAVE_FAILED: 'å„²å­˜å¤±æ•—',
            UPLOAD_FAILED: 'ä¸Šå‚³å¤±æ•—',
            
            // ç¢ºèªå°è©±æ¡†
            CONFIRM_DELETE: 'ç¢ºå®šåˆªé™¤?',
            CONFIRM_DELETE_FILE: 'ç¢ºå®šè¦åˆªé™¤æ­¤é™„ä»¶å—ï¼Ÿ',
            
            // è¡¨å–®é©—è­‰
            REQUIRED_FIELDS: 'è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼š',
            FIELD_CONTAINER: 'æ«ƒè™Ÿ',
            FIELD_ARRIVAL_DATE: 'åˆ°æ¸¯æ—¥',
            FIELD_SUPPLIER: 'å» å•†',
            FIELD_PRODUCT_NAME: 'è‡³å°‘ä¸€é …ç”¢å“åç¨±',
            
            // ç‹€æ…‹æ–‡å­—
            STATUS_ARRIVED: 'å·²åˆ°æ¸¯',
            STATUS_TODAY: 'ä»Šæ—¥åˆ°æ¸¯',
            STATUS_PENDING: 'æœªå®š',
            STATUS_DAYS_LATER: ' å¤©å¾Œ',
            
            // ä»˜æ¬¾ç‹€æ…‹
            PAYMENT_PAID: 'è²¨æ¬¾å·²ä»˜',
            PAYMENT_UNPAID: 'è²¨æ¬¾æœªä»˜',
            FLIGHT_FEE_PAID: 'æ—…è²»å·²ä»˜',
            FLIGHT_FEE_UNPAID: 'æ—…è²»æœªä»˜',
            
            // æŒ‰éˆ•èˆ‡æ“ä½œ
            BTN_SAVE: 'å„²å­˜',
            BTN_CANCEL: 'å–æ¶ˆ',
            BTN_ADD_PRODUCT: '+ æ–°å¢ç”¢å“',
            BTN_SELECT_FILE: 'é¸æ“‡æª”æ¡ˆ (å¯å¤šé¸)',
            BTN_UPLOADING: 'ä¸Šå‚³ä¸­...',
            
            // é ç±¤
            TAB_NOT_DEVANED: 'æœªæ‹†æ«ƒ',
            TAB_DEVANED: 'å·²æ‹†æ«ƒ',
            TAB_DOMESTIC: 'åœ‹å…§æ¡è³¼',
            
            // åˆ—è¡¨
            LIST_TITLE: 'è²¨æ«ƒåˆ—è¡¨',
            STATS_TITLE: 'çµ±è¨ˆåˆ†æ',
            NO_URGENT: 'ç›®å‰ç„¡æ€¥ä»¶',
            URGENT_TITLE: 'è¿‘æœŸåˆ°æ¸¯æ€¥ä»¶',
            FILE_LIST_TITLE: 'é™„ä»¶åˆ—è¡¨',
            
            // è¡¨å–®æ¨™ç±¤
            LABEL_IMPORT_COMPANY: 'é€²å£å…¬å¸',
            LABEL_CONTAINER_NO: 'æ«ƒè™Ÿ',
            LABEL_SHIPPING_COMPANY: 'èˆ¹å…¬å¸',
            LABEL_ARRIVAL_DATE: 'åˆ°æ¸¯æ—¥',
            LABEL_CUSTOMS_BROKER: 'å ±é—œè¡Œ',
            LABEL_DECLARATION_NO: 'å ±é—œå–®è™Ÿ',
            LABEL_PERMIT_NO: 'è¼¸å…¥è¨±å¯è­‰',
            LABEL_SUPPLIER: 'å» å•†',
            LABEL_ORIGIN: 'ç”¢åœ°',
            LABEL_DEVANNING_LOCATION: 'æ‹†æ«ƒåœ°',
            LABEL_DEVANNING_DATE: 'æ‹†æ«ƒæ—¥',
            LABEL_PAYMENT_TERM: 'ä»˜æ¬¾æ¢ä»¶',
            LABEL_FLIGHT_FEE: 'æ—…è²»',
            LABEL_ATTACHMENTS: 'é™„ä»¶',
            
            // ç”¢å“æ˜ç´°
            PRODUCT_SECTION: 'ç”¢å“æ˜ç´°',
            PRODUCT_NAME: 'å“å',
            PRODUCT_SPEC: 'è¦æ ¼',
            PRODUCT_QUANTITY: 'ä»¶æ•¸',
            PRODUCT_WEIGHT: 'é‡é‡',
            PRODUCT_UNIT_PRICE: 'å–®åƒ¹',
            PRODUCT_BATCH: 'æ‰¹è™Ÿ',
            PRODUCT_PRICING_QTY: 'è¨ˆä»¶',
            PRODUCT_PRICING_WEIGHT: 'è¨ˆé‡',
            PRODUCT_HINT: '(è«‹è‡³å°‘å¡«å¯«ä¸€é …å“å)',
            
            // å€‰åº«ç¢ºèª
            WAREHOUSE_CONFIRMED: 'å·²æ”¶è²¨',
            WAREHOUSE_CONFIRM: 'ç¢ºèªæ”¶è²¨',
            
            // çµ±è¨ˆ
            STATS_DASHBOARD: 'çµ±è¨ˆå„€è¡¨æ¿',
            STATS_ALL_MONTHS: 'å…¨éƒ¨æœˆä»½',
            STATS_TOTAL_COUNT: 'ç¸½ç­†æ•¸',
            STATS_TOTAL_ITEMS: 'ç¸½ä»¶æ•¸',
            STATS_TOTAL_WEIGHT: 'ç¸½é‡é‡ (kg)',
            STATS_USD_TOTAL: 'ç¾é‡‘ç¸½é¡ (USD)',
            STATS_TWD_TOTAL: 'å°å¹£ç¸½é¡ (TWD)',
            STATS_MONTHLY_TABLE: 'ğŸ“… æœˆåº¦æ¡è³¼çµ±è¨ˆè¡¨',
            STATS_TOP_SUPPLIERS: 'ğŸ† å‰äº”å¤§å» å•†',
            STATS_NO_DATA: 'ç„¡è¶³å¤ æ•¸æ“šå¯é¡¯ç¤º',
            
            // LINE åˆ†äº«
            LINE_NOTIFY_DOMESTIC: 'ğŸšš åˆ°è²¨é€šçŸ¥',
            LINE_NOTIFY_FOREIGN: 'ğŸš¢ åˆ°æ¸¯é€šçŸ¥',
            
            // V74.0: Excel åŒ¯å…¥
            IMPORT_EXCEL: 'ğŸ“¥ åŒ¯å…¥åœ‹å…§æ¡è³¼',
            IMPORT_TITLE: 'åŒ¯å…¥åœ‹å…§æ¡è³¼è³‡æ–™',
            IMPORT_SELECT_FILE: 'é¸æ“‡ Excel æª”æ¡ˆ',
            IMPORT_PREVIEW: 'è³‡æ–™é è¦½',
            IMPORT_CONFIRM: 'ç¢ºèªåŒ¯å…¥',
            IMPORT_CANCEL: 'å–æ¶ˆ',
            IMPORT_PROCESSING: 'åŒ¯å…¥ä¸­...',
            IMPORT_SUCCESS: 'åŒ¯å…¥æˆåŠŸ',
            IMPORT_FAILED: 'åŒ¯å…¥å¤±æ•—',
            IMPORT_NO_DATA: 'ç„¡æœ‰æ•ˆè³‡æ–™å¯åŒ¯å…¥',
            IMPORT_ROW_COUNT: 'å…± {count} ç­†è³‡æ–™',
            IMPORT_UPDATE_HINT: 'ï¼ˆç›¸åŒå» å•†+æ—¥æœŸ+å“åå°‡è¦†è“‹æ›´æ–°ï¼‰',
            IMPORT_COLUMN_MAPPING: 'æ¬„ä½å°æ‡‰',
            
            // V75.0: ç”¢å“ä¸»æª”
            PRODUCTS_TITLE: 'ç”¢å“ä¸»æª”',
            PRODUCTS_IMPORT: 'ğŸ“¥ åŒ¯å…¥åº«å­˜è¡¨',
            PRODUCTS_ADD: '+ æ–°å¢ç”¢å“',
            PRODUCTS_SEARCH_HINT: 'æœå°‹å“è™Ÿã€å“åã€è¦æ ¼...',
            PRODUCTS_EMPTY: 'å°šç„¡ç”¢å“è³‡æ–™',
            PRODUCTS_IMPORT_TITLE: 'åŒ¯å…¥ç”¢å“ä¸»æª”',
            PRODUCTS_IMPORT_HINT: 'ï¼ˆç›¸åŒå“è™Ÿå°‡è¦†è“‹æ›´æ–°ï¼‰',
            PRODUCTS_EDIT_TITLE: 'ç·¨è¼¯ç”¢å“',
            PRODUCTS_ADD_TITLE: 'æ–°å¢ç”¢å“',
            PRODUCT_ID: 'å“è™Ÿ',
            PRODUCT_DEFAULT_PRICE: 'é è¨­å–®åƒ¹',
            PRODUCT_DEFAULT_SUPPLIER: 'é è¨­ä¾›æ‡‰å•†',
            PRODUCT_UNIT: 'å–®ä½',
            PRODUCT_IS_ACTIVE: 'å•Ÿç”¨',
            PRODUCT_INACTIVE: 'å·²åœç”¨',
        };

        const initialFormState = { 
            importCompany: IMPORT_COMPANIES[0], 
            customsBroker: CUSTOMS_BROKERS[0], 
            origin: '', 
            supplier: '', 
            vendorSeqNo: '', // V79.0: å» å•†åºè™Ÿï¼ˆå¹´åº¦-åºè™Ÿï¼Œå¦‚ 26-01ï¼‰
            arrivalDate: new Date().toISOString().split('T')[0], 
            containerNumber: '', 
            shippingCompany: '', 
            products: [{ id: Date.now(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'weight' }], 
            totalQuantity: 0, 
            totalWeight: 0, 
            docUrl: '', 
            docName: '', 
            docRefPath: '', 
            devanningLocation: '', 
            devanningDate: '', 
            customsDeclarationNo: '', 
            importPermitNo: '', 
            warehouseConfirmed: false,
            attachments: [],
            isPaid: false,
            currency: 'USD',
            paymentTerm: 'åˆ°æ¸¯å‰ä»˜æ¬¾',
            prepayment: 0,
            flightFee: 0,         
            flightFeePaid: false 
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDvMBng2Zhbk6sVaZLSuER2KT6qqeoCdnw",
            authDomain: "containersystem-6342f.firebaseapp.com",
            projectId: "containersystem-6342f",
            storageBucket: "containersystem-6342f.firebasestorage.app",
            messagingSenderId: "27658303054",
            appId: "1:27658303054:web:d7a3710054ede268cdf51f"
        };

        let db, auth, storage;
        try {
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); }
            if (typeof firebase !== 'undefined') { db = firebase.firestore(); auth = firebase.auth(); storage = firebase.storage(); }
        } catch (e) { console.error("Firebase Init Failed:", e); }

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 2. Helpers ---
        const safeNum = (val) => { const n = parseFloat(val); return isNaN(n) ? 0 : n; };
        const round2 = (num) => Math.round(safeNum(num) * 100) / 100;
        const format2 = (num) => safeNum(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatInt = (num) => safeNum(num).toLocaleString();

        // V72.0: ä¿®æ­£æ—¥æœŸè™•ç†ï¼Œä½¿ç”¨ UTC é¿å…æ™‚å€å•é¡Œ
        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0);
            try {
                const p = dateStr.split('-');
                if (p.length !== 3) return new Date(0);
                const year = parseInt(p[0], 10);
                const month = parseInt(p[1], 10) - 1;
                const day = parseInt(p[2], 10);
                if (isNaN(year) || isNaN(month) || isNaN(day)) return new Date(0);
                return new Date(Date.UTC(year, month, day));
            } catch (e) {
                return new Date(0);
            }
        };
        
        // V72.0: è¨ˆç®—å…©å€‹æ—¥æœŸå­—ä¸²ä¹‹é–“çš„å¤©æ•¸å·®ï¼ˆæ­£æ•¸è¡¨ç¤º date1 åœ¨ date2 ä¹‹å¾Œï¼‰
        const dateDiffDays = (dateStr1, dateStr2) => {
            return Math.round((parseDate(dateStr1) - parseDate(dateStr2)) / 86400000);
        };
        
        const getStatusStyle = (date) => { 
            if (!date) return { bg: 'bg-gray-100', text: 'æœªå®š', color: 'text-gray-400' };
            const todayStr = new Date().toISOString().split('T')[0];
            const diff = dateDiffDays(date, todayStr);
            if (diff < 0) return { text: 'å·²åˆ°æ¸¯', color: 'bg-gray-100 text-gray-500' };
            if (diff === 0) return { text: 'ä»Šæ—¥åˆ°æ¸¯', color: 'bg-red-100 text-red-600 animate-pulse' };
            return { text: diff + ' å¤©å¾Œ', color: 'bg-blue-100 text-blue-600' };
        };
        const getCompanyColor = (n) => n === 'å´‡æ–‡å†·å‡' ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700';
        const isDomestic = (d) => d && d.customsBroker === DOMESTIC_FLAG;
        const isForeign = (d) => !isDomestic(d);

        // --- 3. Icons (V79.0: çµ±ä¸€ SVG ç·šæ¢é¢¨æ ¼) ---
        const Icons = {
            Ship: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.8 8"/><path d="M12 2v8"/></svg>,
            Anchor: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>,
            Plus: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Search: ()=><svg className="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Copy: ()=><svg className="icon" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            FileCheck: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            Globe: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Factory: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>,
            Paperclip: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            ArrowRight: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Download: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            LogOut: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Google: ()=><svg className="icon" fill="currentColor" stroke="none" viewBox="0 0 24 24"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"/></svg>,
            X: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Check: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
            Bell: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            MessageCircle: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            User: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            List: ()=><svg className="icon" viewBox="0 0 24 24"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Chart: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Grid: ()=><svg className="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Dollar: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Calendar: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Line: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9Z"/><path d="M8 12h8"/></svg>,
            Package: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m16.5 9.4-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/></svg>,
            ChevronLeft: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"/></svg>,
            Upload: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            // V79.0: æ–°å¢åœ–ç¤º
            FileText: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>,
            Wand: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>,
            FormInput: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>,
            FilePlus: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>,
            Eye: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Info: ()=><svg className="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            AlertCircle: ()=><svg className="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        };
        
        const I = Icons;

        // 4. MonthlySummaryTable (V68.0: Replace Chart with Table)
        const MonthlySummaryTable = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-gray-400 text-center py-4">ç„¡è¶³å¤ æ•¸æ“šå¯é¡¯ç¤º</div>;
            return (
                <div className="overflow-x-auto">
                    <table className="stats-table">
                        <thead>
                            <tr>
                                <th className="text-left">æœˆä»½</th>
                                <th>æ«ƒæ•¸</th>
                                <th>ç¸½é‡(kg)</th>
                                <th>ç¾é‡‘(USD)</th>
                                <th>å°å¹£(TWD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map(d => (
                                <tr key={d.name}>
                                    <td className="text-left font-bold text-gray-700">{d.name}</td>
                                    <td>{d.count}</td>
                                    <td className="text-orange-500">{format2(d.weight)}</td>
                                    <td className="text-emerald-600 font-bold">{d.USD > 0 ? `$${format2(d.USD)}` : '-'}</td>
                                    <td className="text-blue-600 font-bold">{d.TWD > 0 ? `$${format2(d.TWD)}` : '-'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // 5. Dashboard
        const Dashboard = ({ shipments, canSeePrice }) => {
            const availableMonths = useMemo(() => {
                const months = new Set();
                shipments.forEach(s => {
                    if(s.arrivalDate) months.add(s.arrivalDate.substring(0, 7));
                });
                return Array.from(months).sort().reverse();
            }, [shipments]);

            const [tf, setTf] = useState('YEAR');
            const [filterMonth, setFilterMonth] = useState('ALL');
            const [search, setSearch] = useState('');
            
            const stats = useMemo(() => {
                let list = Array.isArray(shipments) ? shipments : [];
                if (search) {
                    const t = search.toLowerCase();
                    list = list.filter(s => (s.supplier||'').toLowerCase().includes(t) || (s.products||[]).some(p=>p.name.toLowerCase().includes(t)));
                }
                
                if (filterMonth !== 'ALL') {
                     list = list.filter(s => s.arrivalDate && s.arrivalDate.startsWith(filterMonth));
                }

                const count = list.length;
                const items = list.reduce((s,i) => s + safeNum(i.totalQuantity), 0);
                const w = list.reduce((s,i) => s + safeNum(i.totalWeight), 0);
                const moneyUSD = list.reduce((s,i) => i.currency==='USD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                const moneyTWD = list.reduce((s,i) => i.currency==='TWD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                
                const supps = {}; list.forEach(s=>{ const n=s.supplier||'æœªå¡«'; supps[n]=(supps[n]||0)+1; });
                const top = Object.entries(supps).sort((a,b)=>b[1]-a[1]).slice(0,5);
                const maxVal = (top.length>0 && top[0][1]>0) ? top[0][1] : 1;

                // V68.0: Table Data Logic
                const chartMap = {};
                // Sort list by date for table
                const chartList = [...list].sort((a,b) => (b.arrivalDate||'').localeCompare(a.arrivalDate||'')); // Descending
                chartList.forEach(s => {
                    if(!s.arrivalDate) return;
                    const k = s.arrivalDate.substring(0, 7); // YYYY-MM
                    if(!chartMap[k]) chartMap[k] = {name:k, count:0, weight:0, TWD:0, USD:0};
                    
                    chartMap[k].count += 1;
                    chartMap[k].weight += safeNum(s.totalWeight);

                    const amt = (s.products||[]).reduce((a,p)=>a+safeNum(p.amount),0);
                    if(s.currency==='USD') chartMap[k].USD += amt; else chartMap[k].TWD += amt;
                });
                const chartData = Object.values(chartMap);

                return { count, items, w, moneyUSD, moneyTWD, top, chartData, maxVal };
            }, [shipments, filterMonth, search]);
            
            return (
                <div className="space-y-6 animate-[fade-in_0.3s_ease-out] pb-20">
                    <div className="flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">çµ±è¨ˆå„€è¡¨æ¿</h2>
                            <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="bg-white border border-gray-300 rounded-lg px-3 py-1 text-sm outline-none font-bold text-gray-700">
                                <option value="ALL">å…¨éƒ¨æœˆä»½</option>
                                {availableMonths.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                        <input placeholder="æœå°‹ç”¢å“ã€å» å•†..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full bg-white text-gray-900 rounded-xl py-2 px-4 outline-none shadow-sm text-sm border border-gray-100" />
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½ç­†æ•¸</div><div className="text-2xl font-black text-gray-800">{stats.count.toLocaleString()}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½ä»¶æ•¸</div><div className="text-2xl font-black text-blue-600">{stats.items.toLocaleString()}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¸½é‡é‡ (kg)</div><div className="text-2xl font-black text-orange-500">{Math.round(stats.w).toLocaleString()}</div></div>
                    </div>
                    {canSeePrice() && (
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ç¾é‡‘ç¸½é¡ (USD)</div><div className="text-xl font-black text-emerald-600">${Math.round(stats.moneyUSD).toLocaleString()}</div></div>
                            <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">å°å¹£ç¸½é¡ (TWD)</div><div className="text-xl font-black text-emerald-600">${Math.round(stats.moneyTWD).toLocaleString()}</div></div>
                        </div>
                    )}
                    {canSeePrice() && <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">ğŸ“… æœˆåº¦æ¡è³¼çµ±è¨ˆè¡¨</h3><MonthlySummaryTable data={stats.chartData} /></div>}
                     <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">ğŸ† å‰äº”å¤§å» å•†</h3><div className="space-y-3">{stats.top.map(([n,c],i)=><div key={n} className="flex items-center gap-3"><div className="w-6 text-xs font-bold text-gray-400">#{i+1}</div><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-gray-700">{n}</span><span className="text-gray-500">{c} ç­†</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width:`${(c/stats.maxVal)*100}%`}}></div></div></div></div>)}</div></div>
                </div>
            );
        };

        // 6. Main App
        function ContainerApp() {
            const [user, setUser] = useState(null);
            const [shipments, setShipments] = useState([]);
            const [view, setView] = useState('list'); 
            const [displayMode, setDisplayMode] = useState('card');
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [currentTab, setCurrentTab] = useState('NOT_DEVANED'); 
            const [userRole, setUserRole] = useState('GUEST');
            const [formData, setFormData] = useState(initialFormState);
            const [showNotifications, setShowNotifications] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [showFileModal, setShowFileModal] = useState(false);
            const [fileList, setFileList] = useState([]);
            const [validationErrors, setValidationErrors] = useState({});
            const [showValidationToast, setShowValidationToast] = useState(false);
            const [validationMessage, setValidationMessage] = useState('');
            
            // V74.0: Excel åŒ¯å…¥ç›¸é—œç‹€æ…‹
            const [showImportModal, setShowImportModal] = useState(false);
            const [importData, setImportData] = useState([]);
            const [importProcessing, setImportProcessing] = useState(false);
            const [importProgress, setImportProgress] = useState({ current: 0, total: 0 });
            
            // V75.0: ç”¢å“ä¸»æª”ç›¸é—œç‹€æ…‹
            const [products, setProducts] = useState([]);
            const [productSearchTerm, setProductSearchTerm] = useState('');
            const [showProductModal, setShowProductModal] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [showProductImportModal, setShowProductImportModal] = useState(false);
            const [productImportData, setProductImportData] = useState([]);
            
            // V76.0: ç”¢å“é¸æ“‡å™¨ç‹€æ…‹
            const [activeProductPicker, setActiveProductPicker] = useState(null); // ç›®å‰é–‹å•Ÿé¸æ“‡å™¨çš„ç”¢å“ç´¢å¼•
            const [productPickerSearch, setProductPickerSearch] = useState('');
            
            // V78.5: è¡¨å–®æ­¥é©Ÿ/æŠ˜ç–Šç‹€æ…‹
            const [formStep, setFormStep] = useState(1); // æ–°å¢æ™‚çš„æ­¥é©Ÿ (1-4)
            const [openSections, setOpenSections] = useState(['basic']); // ç·¨è¼¯æ™‚å±•é–‹çš„å€å¡Š
            
            // V79.0: æ™ºèƒ½åŒ¯å…¥åŠŸèƒ½ç‹€æ…‹
            const [showImportSelector, setShowImportSelector] = useState(false); // é¡¯ç¤ºåŒ¯å…¥æ–¹å¼é¸æ“‡å™¨
            const [parsedDocuments, setParsedDocuments] = useState([]); // å·²è§£æçš„æ–‡ä»¶ [{name, type, text}]
            const [isParsing, setIsParsing] = useState(false); // æ­£åœ¨è§£æ PDF
            const [parseProgress, setParseProgress] = useState(''); // è§£æé€²åº¦æç¤º
            
            // V79.0: AI è‡ªå‹•å¡«å…¥ç›¸é—œç‹€æ…‹
            const [aiExtractedData, setAiExtractedData] = useState(null); // AI æå–çš„çµæ§‹åŒ–è³‡æ–™
            const [showAiPreview, setShowAiPreview] = useState(false); // é¡¯ç¤º AI è§£æé è¦½ç¢ºèª
            const [isAiProcessing, setIsAiProcessing] = useState(false); // AI æ­£åœ¨è™•ç†
            const [fieldSources, setFieldSources] = useState({}); // å„æ¬„ä½çš„è³‡æ–™ä¾†æº
            const [fieldConflicts, setFieldConflicts] = useState({}); // æ¬„ä½è¡çª
            const [duplicateContainer, setDuplicateContainer] = useState(null); // é‡è¤‡çš„æ«ƒè™Ÿè³‡è¨Š
            
            // V79.0: Gemini API Key è¨­å®š
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);
            const [geminiApiKey, setGeminiApiKey] = useState(() => {
                try { return localStorage.getItem('gemini_api_key') || ''; } 
                catch { return ''; }
            });
            const [tempApiKey, setTempApiKey] = useState('');
            
            // V79.1: æ‰¹è™Ÿè™•ç†æ¨¡å¼è¨­å®š ('merge' = åˆä½µå–æœ€æ—©æ•ˆæœŸ, 'split' = å®Œå…¨æ‹†åˆ†)
            const [batchMergeMode, setBatchMergeMode] = useState(() => {
                try { return localStorage.getItem('batch_merge_mode') || 'merge'; } 
                catch { return 'merge'; }
            });
            
            // V79.3: å¤šé¸åŒ¯å‡ºç‹€æ…‹
            const [selectMode, setSelectMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            
            // V79.4: è¡¨æ ¼æ’åºç‹€æ…‹
            const [sortField, setSortField] = useState('arrivalDate');
            const [sortOrder, setSortOrder] = useState('desc'); // 'asc' or 'desc'
            
            // V79.4: é»æ“Šè¡¨é ­æ’åº
            const handleSort = (field) => {
                if (sortField === field) {
                    setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortOrder('asc');
                }
            };
            
            // å„²å­˜ API Key åˆ° localStorage
            const saveApiKey = (key) => {
                try {
                    localStorage.setItem('gemini_api_key', key);
                    setGeminiApiKey(key);
                    setShowApiKeyModal(false);
                    alert('API Key å·²å„²å­˜ï¼');
                } catch (e) {
                    alert('å„²å­˜å¤±æ•—: ' + e.message);
                }
            };
            
            // V79.1: å„²å­˜æ‰¹è™Ÿè™•ç†æ¨¡å¼
            const saveBatchMergeMode = (mode) => {
                try {
                    localStorage.setItem('batch_merge_mode', mode);
                    setBatchMergeMode(mode);
                } catch (e) {
                    console.error('å„²å­˜æ‰¹è™Ÿæ¨¡å¼å¤±æ•—:', e);
                }
            };

            // V72.0: ç§»é™¤é‡è¤‡çš„ Icons è³¦å€¼ï¼Œä½¿ç”¨å…¨åŸŸå®šç¾©çš„ I

            // Actions
            const handleLogout = useCallback(() => { if(auth) auth.signOut(); else window.location.reload(); }, []);
            const handleAdminLogin = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (error) { alert(TEXT.LOGIN_FAILED + ": " + error.message); } };
            const handleGuestLogin = async () => { try { await auth.signInAnonymously(); } catch (error) { alert(TEXT.GUEST_LOGIN_FAILED); } };
            const handleDelete = async (id) => { if(confirm(TEXT.CONFIRM_DELETE)) await db.collection('shipments').doc(id).delete(); };
            const handleWarehouseConfirm = async (e, item) => { e.stopPropagation(); if (!canEditWarehouseFields()) return alert(TEXT.PERMISSION_DENIED); try { await db.collection('shipments').doc(item.id).update({ warehouseConfirmed: !item.warehouseConfirmed }); } catch (err) { alert(err.message); } };
            
            const handleExport = () => { 
                if (userRole === 'GUEST') return alert(TEXT.PERMISSION_DENIED); 
                
                // V79.3: é€²å…¥å¤šé¸æ¨¡å¼
                setSelectMode(true);
                setSelectedIds(new Set());
            };
            
            // V79.3: åˆ‡æ›é¸å–
            const toggleSelect = (id) => {
                setSelectedIds(prev => {
                    const next = new Set(prev);
                    if (next.has(id)) next.delete(id);
                    else next.add(id);
                    return next;
                });
            };
            
            // V79.3: å…¨é¸/å–æ¶ˆå…¨é¸
            const toggleSelectAll = () => {
                if (selectedIds.size === filteredList.length) {
                    setSelectedIds(new Set());
                } else {
                    setSelectedIds(new Set(filteredList.map(s => s.id)));
                }
            };
            
            // V79.3: å–æ¶ˆå¤šé¸æ¨¡å¼
            const cancelSelectMode = () => {
                setSelectMode(false);
                setSelectedIds(new Set());
            };
            
            // V79.3: åŸ·è¡Œæ‰¹æ¬¡åŒ¯å‡º Excelï¼ˆä¸€æ«ƒä¸€å·¥ä½œè¡¨ï¼Œå¤§å­—é«”+é‚Šæ¡†æ ¼å¼ï¼‰
            const executeExport = () => {
                if (selectedIds.size === 0) return alert('è«‹å…ˆé¸æ“‡è¦åŒ¯å‡ºçš„è²¨æ«ƒ');
                
                const showPrice = canSeePrice();
                const selectedList = filteredList.filter(s => selectedIds.has(s.id));
                
                console.log('åŒ¯å‡ºè²¨æ«ƒæ•¸é‡:', selectedList.length);
                
                // æ¨£å¼å®šç¾©
                const thin = { style: 'thin', color: { rgb: '000000' } };
                const medium = { style: 'medium', color: { rgb: '000000' } };
                const borderAll = { top: thin, bottom: thin, left: thin, right: thin };
                const borderThick = { top: medium, bottom: medium, left: thin, right: thin };
                
                // å»ºç«‹å·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                selectedList.forEach((container, idx) => {
                    const info = container;
                    const products = container.products || [];
                    // æ¬„ä½ï¼šå“åã€è¦æ ¼ã€æ‰¹è™Ÿã€æ•ˆæœŸã€æ•¸é‡ã€é‡é‡ã€å–®åƒ¹ã€é‡‘é¡ï¼ˆç§»é™¤ç®±å®¹ï¼‰
                    const colCount = showPrice ? 8 : 6;
                    
                    console.log(`è™•ç†ç¬¬ ${idx + 1} å€‹: ${info.containerNumber}, ç”¢å“æ•¸: ${products.length}`);
                    
                    // å·¥ä½œè¡¨åç¨±
                    const sheetName = `${idx + 1}_${(info.containerNumber || 'NA').slice(-8)}`.substring(0, 31);
                    
                    // ç”¨ aoa å»ºç«‹åŸºæœ¬å·¥ä½œè¡¨
                    const aoa = [];
                    
                    // Row 0: æ¨™é¡Œ
                    aoa.push(['è²¨æ«ƒæ˜ç´°è¡¨']);
                    // Row 1: ç©ºè¡Œ
                    aoa.push([]);
                    // Row 2: è³‡è¨Šç¬¬ä¸€åˆ—ï¼ˆé€²å£ã€åºè™Ÿã€å» å•†ã€ç”¢åœ°ï¼‰
                    const infoRow1 = [`é€²å£ï¼š${info.importCompany || ''}`, `åºè™Ÿï¼š${info.vendorSeqNo || ''}`, `å» å•†ï¼š${info.supplier || ''}`, `ç”¢åœ°ï¼š${info.origin || ''}`];
                    while (infoRow1.length < colCount) infoRow1.push('');
                    aoa.push(infoRow1);
                    // Row 3: è³‡è¨Šç¬¬äºŒåˆ—ï¼ˆæ«ƒè™Ÿã€åˆ°æ¸¯æ—¥ã€å ±é—œï¼‰
                    const infoRow2 = [`æ«ƒè™Ÿï¼š${info.containerNumber || ''}`, `åˆ°æ¸¯æ—¥ï¼š${info.arrivalDate || ''}`, `å ±é—œï¼š${info.customsBroker || ''}`];
                    while (infoRow2.length < colCount) infoRow2.push('');
                    aoa.push(infoRow2);
                    // Row 4: ç©ºè¡Œ
                    aoa.push([]);
                    // Row 5: è¡¨é ­ï¼ˆå“åã€è¦æ ¼ã€æ‰¹è™Ÿã€æ•ˆæœŸã€æ•¸é‡ã€é‡é‡ã€å–®åƒ¹ã€é‡‘é¡ï¼‰
                    const headers = ['å“å', 'è¦æ ¼', 'æ‰¹è™Ÿ', 'æ•ˆæœŸ', 'æ•¸é‡', 'é‡é‡(kg)'];
                    if (showPrice) headers.push('å–®åƒ¹', 'é‡‘é¡');
                    aoa.push(headers);
                    
                    // ç”¢å“è³‡æ–™
                    let sumQty = 0, sumWeight = 0, sumAmount = 0;
                    products.forEach(p => {
                        const row = [
                            p.name || '',
                            p.spec || '',
                            p.batchNumber || '',
                            p.expiryDate || '',
                            safeNum(p.quantity),
                            safeNum(p.weight)
                        ];
                        if (showPrice) {
                            row.push(safeNum(p.unitPrice));
                            row.push(safeNum(p.amount));
                        }
                        aoa.push(row);
                        sumQty += safeNum(p.quantity);
                        sumWeight += safeNum(p.weight);
                        if (showPrice) sumAmount += safeNum(p.amount);
                    });
                    
                    // åˆè¨ˆåˆ—
                    const totalRow = ['åˆã€€è¨ˆ', '', '', '', sumQty, sumWeight];
                    if (showPrice) totalRow.push('', sumAmount);
                    aoa.push(totalRow);
                    
                    // å»ºç«‹å·¥ä½œè¡¨
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    
                    // å¥—ç”¨æ¨£å¼
                    const headerRowIdx = 5;
                    const dataStartIdx = 6;
                    const dataEndIdx = 5 + products.length;
                    const totalRowIdx = dataEndIdx + 1;
                    
                    // è³‡è¨Šå€æ¨£å¼ï¼ˆ14pt ç²—é«”ï¼‰- Row 2 å’Œ Row 3
                    for (let r = 2; r <= 3; r++) {
                        for (let c = 0; c < colCount; c++) {
                            const cellRef = XLSX.utils.encode_cell({ r, c });
                            if (ws[cellRef]) {
                                ws[cellRef].s = {
                                    font: { name: 'å¾®è»Ÿæ­£é»‘é«”', sz: 14, bold: true },
                                    alignment: { vertical: 'center' }
                                };
                            }
                        }
                    }
                    
                    // è¡¨é ­æ¨£å¼ï¼ˆç²—æ¡†ï¼‰
                    for (let c = 0; c < colCount; c++) {
                        const cell = ws[XLSX.utils.encode_cell({ r: headerRowIdx, c })];
                        if (cell) {
                            cell.s = {
                                font: { name: 'å¾®è»Ÿæ­£é»‘é«”', sz: 14, bold: true },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: borderThick
                            };
                        }
                    }
                    
                    // è³‡æ–™åˆ—æ¨£å¼ï¼ˆç´°æ¡†ï¼‰
                    for (let r = dataStartIdx; r <= dataEndIdx; r++) {
                        for (let c = 0; c < colCount; c++) {
                            const cellRef = XLSX.utils.encode_cell({ r, c });
                            if (!ws[cellRef]) ws[cellRef] = { v: '', t: 's' };
                            const cell = ws[cellRef];
                            
                            // å°é½Šï¼šå“åè¦æ ¼é å·¦ã€æ‰¹è™Ÿæ•ˆæœŸç½®ä¸­ã€æ•¸å­—é å³
                            let align = 'left';
                            if (c === 0 || c === 1) align = 'left';  // å“åã€è¦æ ¼
                            if (c === 2 || c === 3) align = 'center';  // æ‰¹è™Ÿã€æ•ˆæœŸ
                            if (c >= 4) align = 'right';  // æ•¸é‡ã€é‡é‡ã€å–®åƒ¹ã€é‡‘é¡
                            
                            cell.s = {
                                font: { name: 'å¾®è»Ÿæ­£é»‘é«”', sz: 14 },
                                alignment: { horizontal: align, vertical: 'center' },
                                border: borderAll
                            };
                            
                            // æ•¸å­—æ ¼å¼
                            if (c === 4 || c === 5) cell.z = '#,##0';  // æ•¸é‡ã€é‡é‡
                            if (c === 6 && showPrice) cell.z = '#,##0.00';  // å–®åƒ¹å…©ä½å°æ•¸
                            if (c === 7 && showPrice) cell.z = '#,##0.00';  // é‡‘é¡å…©ä½å°æ•¸
                        }
                    }
                    
                    // åˆè¨ˆåˆ—æ¨£å¼ï¼ˆç²—æ¡†ï¼‰
                    for (let c = 0; c < colCount; c++) {
                        const cellRef = XLSX.utils.encode_cell({ r: totalRowIdx, c });
                        if (!ws[cellRef]) ws[cellRef] = { v: '', t: 's' };
                        const cell = ws[cellRef];
                        
                        cell.s = {
                            font: { name: 'å¾®è»Ÿæ­£é»‘é«”', sz: 14, bold: true },
                            alignment: { horizontal: c === 0 ? 'center' : 'right', vertical: 'center' },
                            border: borderThick
                        };
                        
                        if (c === 4 || c === 5) cell.z = '#,##0';  // æ•¸é‡ã€é‡é‡
                        if (c === 7 && showPrice) cell.z = '#,##0.00';  // åˆè¨ˆé‡‘é¡å…©ä½å°æ•¸
                    }
                    
                    // æ¨™é¡Œæ¨£å¼
                    if (ws['A1']) {
                        ws['A1'].s = {
                            font: { name: 'å¾®è»Ÿæ­£é»‘é«”', sz: 20, bold: true },
                            alignment: { horizontal: 'center', vertical: 'center' }
                        };
                    }
                    
                    // åˆä½µæ¨™é¡Œ
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: colCount - 1 } }];
                    
                    // æ¬„å¯¬ï¼ˆèª¿æ•´ï¼‰
                    ws['!cols'] = [
                        { wch: 16 },  // å“å
                        { wch: 24 },  // è¦æ ¼
                        { wch: 14 },  // æ‰¹è™Ÿ
                        { wch: 12 },  // æ•ˆæœŸ
                        { wch: 10 },  // æ•¸é‡
                        { wch: 12 },  // é‡é‡
                        ...(showPrice ? [{ wch: 10 }, { wch: 14 }] : [])  // å–®åƒ¹ã€é‡‘é¡
                    ];
                    
                    // åˆ—é«˜
                    ws['!rows'] = [
                        { hpt: 32 }, { hpt: 18 }, { hpt: 26 }, { hpt: 26 },
                        { hpt: 18 }, { hpt: 28 }
                    ];
                    for (let i = 6; i <= totalRowIdx; i++) {
                        ws['!rows'][i] = { hpt: 26 };
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    console.log(`å·¥ä½œè¡¨ ${sheetName} å·²åŠ å…¥`);
                });
                
                console.log('å·¥ä½œç°¿å·¥ä½œè¡¨æ•¸:', wb.SheetNames.length);
                
                // åŒ¯å‡º
                const fileName = 'è²¨æ«ƒæ˜ç´°_' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '.xlsx';
                XLSX.writeFile(wb, fileName);
                
                cancelSelectMode();
                alert(`å·²åŒ¯å‡º ${selectedList.length} å€‹è²¨æ«ƒï¼\nåˆ—å°æ™‚è«‹é¸æ“‡ã€Œæ•´æœ¬æ´»é ç°¿ã€`);
            };

            // V79.0: PDF è§£æåŠŸèƒ½ - æ”¯æ´å¤šæª”æ¡ˆ
            const detectDocumentType = (text, fileName) => {
                const lowerText = text.toLowerCase();
                const lowerName = fileName.toLowerCase();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ•ˆæœŸæ¸…å–®ï¼ˆå„ªå…ˆåˆ¤æ–·ï¼Œå› ç‚ºå¯èƒ½åŒæ™‚åŒ…å«å…¶ä»–é—œéµå­—ï¼‰
                const hasExpiryList = lowerText.includes('expiration date') || 
                    lowerText.includes('expiry date') ||
                    lowerText.includes('fecha de vencimiento') ||  // è¥¿ç­ç‰™æ–‡ï¼šæ•ˆæœŸ
                    lowerText.includes('reporte de lotes') ||      // è¥¿ç­ç‰™æ–‡ï¼šæ‰¹æ¬¡å ±å‘Š
                    (lowerText.includes('production date') && lowerText.includes('lot s/n')) || // æ³°åœ‹ YEENIN æ ¼å¼
                    (lowerText.includes('lot #') && lowerText.includes('date')) ||
                    (lowerText.includes('lot s/n') && lowerText.includes('exp'));
                
                if (hasExpiryList || lowerName.includes('expir') || lowerName.includes('batch') || 
                    lowerName.includes('æ•ˆæœŸ') || lowerName.includes('lote') || lowerName.includes('code')) {
                    return { type: 'expiry', label: 'æ‰¹è™Ÿæ•ˆæœŸæ¸…å–®', icon: 'ğŸ“‹' };
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ™ºåˆ© Packing Listï¼ˆè¥¿ç­ç‰™æ–‡ï¼‰
                const isChilePL = lowerText.includes('nro de contenedo') ||  // æ«ƒè™Ÿ
                    lowerText.includes('mn vuelo') ||                          // èˆ¹åèˆªæ¬¡
                    lowerText.includes('cuenta de caja') ||                    // ä»¶æ•¸
                    lowerText.includes('suma de peso');                        // é‡é‡
                
                if (isChilePL) {
                    return { type: 'packing', label: 'Packing List (æ™ºåˆ©)', icon: 'ğŸ“¦' };
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºè¤‡åˆæ–‡ä»¶ï¼ˆåŒ…å«å¤šç¨®æ–‡ä»¶é¡å‹ï¼‰
                const hasInvoice = lowerText.includes('invoice') && (lowerText.includes('unit price') || lowerText.includes('amount'));
                const hasPacking = lowerText.includes('packing list') || (lowerText.includes('n. w.') && lowerText.includes('g. w.'));
                const hasBatchCode = lowerText.includes('bag code');
                
                // å¦‚æœæ˜¯è¤‡åˆæ–‡ä»¶
                if ((hasInvoice && hasPacking) || (hasInvoice && hasBatchCode) || (hasPacking && hasBatchCode)) {
                    return { type: 'combined', label: 'è¤‡åˆæ–‡ä»¶ (Invoice+PL+æ‰¹è™Ÿ)', icon: 'ğŸ“‘' };
                }
                
                // 1. å„ªå…ˆæ ¹æ“šæª”ååˆ¤æ–·ï¼ˆä½†æ’é™¤è¤‡åˆæª”åï¼‰
                if ((lowerName.includes('invoice') || lowerName.includes('inv')) && !lowerName.includes('packing')) {
                    return { type: 'invoice', label: 'Commercial Invoice', icon: 'ğŸ“„' };
                }
                if ((lowerName.includes('packing') || lowerName.includes('pkl') || lowerName.includes('pl')) && !lowerName.includes('inv')) {
                    return { type: 'packing', label: 'Packing List', icon: 'ğŸ“¦' };
                }
                if (lowerName.includes('bol') || lowerName.includes('b-l') || lowerName.includes('lading') || 
                    (lowerName === 'bl.pdf') || lowerName.match(/\bbl\b/)) {
                    return { type: 'bl', label: 'Bill of Lading', icon: 'ğŸš¢' };
                }
                if (lowerName.includes('notice') || lowerName.includes('arrival') || lowerName.includes('é€šçŸ¥')) {
                    return { type: 'arrival', label: 'åˆ°è²¨é€šçŸ¥', icon: 'ğŸ“¬' };
                }
                
                // 2. æ ¹æ“šå…§å®¹ç‰¹å¾µåˆ¤æ–·
                if (lowerText.includes('bill of lading') || lowerText.includes('b/l no') ||
                    lowerText.includes('container no') || lowerText.includes('container/seal') ||
                    lowerText.includes('cntr no') || lowerText.includes('seal no') ||
                    (lowerText.includes('shipper') && lowerText.includes('consignee') && lowerText.includes('vessel'))) {
                    return { type: 'bl', label: 'Bill of Lading', icon: 'ğŸš¢' };
                }
                
                if (hasInvoice) {
                    return { type: 'invoice', label: 'Commercial Invoice', icon: 'ğŸ“„' };
                }
                
                if (hasPacking) {
                    return { type: 'packing', label: 'Packing List', icon: 'ğŸ“¦' };
                }
                
                if (lowerText.includes('åˆ°è²¨é€šçŸ¥') || lowerText.includes('arrival notice') || 
                    lowerText.includes('èˆ¹åˆ°æ—¥') || lowerText.includes('æ‹†æ«ƒåœ°')) {
                    return { type: 'arrival', label: 'åˆ°è²¨é€šçŸ¥', icon: 'ğŸ“¬' };
                }
                
                return { type: 'other', label: 'å…¶ä»–æ–‡ä»¶', icon: 'ğŸ“' };
            };
            
            const handlePdfUpload = async (e) => {
                const files = Array.from(e.target.files || []);
                if (files.length === 0) return;
                
                // æ”¯æ´ PDF å’Œ Excel æª”æ¡ˆ
                const supportedFiles = files.filter(f => 
                    f.type === 'application/pdf' || 
                    f.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    f.type === 'application/vnd.ms-excel' ||
                    f.name.endsWith('.xlsx') ||
                    f.name.endsWith('.xls')
                );
                
                if (supportedFiles.length === 0) {
                    alert('è«‹ä¸Šå‚³ PDF æˆ– Excel æª”æ¡ˆ');
                    return;
                }
                
                setIsParsing(true);
                const newDocs = [];
                
                try {
                    for (let i = 0; i < supportedFiles.length; i++) {
                        const file = supportedFiles[i];
                        setParseProgress(`è§£ææ–‡ä»¶ (${i + 1}/${supportedFiles.length}): ${file.name}`);
                        
                        const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') ||
                            file.type.includes('spreadsheet') || file.type.includes('excel');
                        
                        if (isExcel) {
                            // Excel æª”æ¡ˆè™•ç†
                            const arrayBuffer = await file.arrayBuffer();
                            const workbook = XLSX.read(arrayBuffer);
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            
                            // è½‰æ›ç‚ºæ–‡å­—æ ¼å¼ä¾› AI è§£æ
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                            let excelText = `=== Excel æª”æ¡ˆ: ${file.name} ===\n`;
                            
                            // å°‡ Excel è³‡æ–™è½‰ç‚ºæ˜“è®€æ ¼å¼
                            jsonData.forEach((row, rowIdx) => {
                                if (row.some(cell => cell !== '')) {
                                    const rowText = row.map((cell, colIdx) => {
                                        if (cell === '') return '';
                                        // è™•ç†æ—¥æœŸ
                                        if (typeof cell === 'number' && cell > 40000 && cell < 60000) {
                                            const date = XLSX.SSF.parse_date_code(cell);
                                            if (date) {
                                                return `${date.y}-${String(date.m).padStart(2,'0')}-${String(date.d).padStart(2,'0')}`;
                                            }
                                        }
                                        return String(cell);
                                    }).filter(c => c !== '').join(' | ');
                                    if (rowText.trim()) {
                                        excelText += rowText + '\n';
                                    }
                                }
                            });
                            
                            const docType = detectDocumentType(excelText, file.name);
                            console.log(`ğŸ“Š Excel è­˜åˆ¥: ${file.name} â†’ ${docType.label}`);
                            console.log(`ğŸ“ Excel å…§å®¹å‰500å­—:`, excelText.substring(0, 500));
                            
                            newDocs.push({
                                id: Date.now() + '_' + i,
                                name: file.name,
                                text: excelText.trim(),
                                ...docType
                            });
                        } else {
                            // PDF æª”æ¡ˆè™•ç†ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
                            // è®€å–æª”æ¡ˆç‚º base64ï¼ˆå…ˆä¿å­˜ï¼Œå› ç‚º arrayBuffer æœƒè¢« PDF.js detachï¼‰
                            const fileBase64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = () => {
                                    const base64 = reader.result.split(',')[1];
                                    resolve(base64);
                                };
                                reader.readAsDataURL(file);
                            });
                            
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            let fullText = '';
                            
                            for (let p = 1; p <= pdf.numPages; p++) {
                                const page = await pdf.getPage(p);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n';
                            }
                            
                            // æª¢æŸ¥æ˜¯å¦æˆåŠŸæå–æ–‡å­—ï¼ˆæƒææª”å¯èƒ½ç„¡æ³•æå–ï¼‰
                            const cleanText = fullText.replace(/\s+/g, '').trim();
                            if (cleanText.length < 50) {
                                console.warn(`âš ï¸ ${file.name} æ–‡å­—å…§å®¹éå°‘ï¼Œå°‡ä½¿ç”¨ AI è¦–è¦ºè§£æ`);
                                const docType = detectDocumentType(file.name, file.name);
                                newDocs.push({
                                    id: Date.now() + '_' + i,
                                    name: file.name,
                                    text: '',
                                    base64: fileBase64,
                                    mimeType: 'application/pdf',
                                    isScanned: true,
                                    ...docType,
                                    label: docType.label + ' (æƒæ)',
                                    icon: 'ğŸ–¼ï¸'
                                });
                                continue;
                            }
                            
                            const docType = detectDocumentType(fullText, file.name);
                            console.log(`ğŸ“„ æ–‡ä»¶è­˜åˆ¥: ${file.name} â†’ ${docType.label} (${docType.type})`);
                            console.log(`ğŸ“ æ–‡ä»¶å…§å®¹å‰300å­—:`, fullText.substring(0, 300));
                            newDocs.push({
                                id: Date.now() + '_' + i,
                                name: file.name,
                                text: fullText.trim(),
                                ...docType
                            });
                        }
                    }
                    
                    // ä¿®æ­£ï¼šç§»é™¤åŒåçš„èˆŠæ–‡ä»¶ï¼Œé¿å…é‡è¤‡
                    const newFileNames = newDocs.map(d => d.name);
                    const filteredOldDocs = parsedDocuments.filter(d => !newFileNames.includes(d.name));
                    const allDocs = [...filteredOldDocs, ...newDocs];
                    
                    setParsedDocuments(allDocs);
                    setIsParsing(false);
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰æƒææª”
                    const scannedDocs = allDocs.filter(d => d.isScanned);
                    const textDocs = allDocs.filter(d => !d.isScanned && d.text);
                    
                    if (scannedDocs.length > 0) {
                        console.log(`ğŸ“· ${scannedDocs.length} ä»½æƒææª”å°‡ä½¿ç”¨ AI è¦–è¦ºè§£æ`);
                    }
                    
                    // æ ¹æ“šæ˜¯å¦æœ‰ API Key æ±ºå®šè™•ç†æ–¹å¼
                    if (geminiApiKey && allDocs.length > 0) {
                        // æœ‰ API Keyï¼Œå‘¼å« AI è™•ç†ï¼ˆåŒ…å«æƒææª”ï¼‰
                        await processWithAI(allDocs);
                    } else if (allDocs.length > 0) {
                        // ç„¡ API Keyï¼Œç›´æ¥é€²å…¥è¡¨å–®ï¼ˆæ‰‹å‹•æ¨¡å¼ï¼‰
                        setShowImportSelector(false);
                        setFormStep(1);
                        setView('form');
                    }
                    
                } catch (err) {
                    console.error('PDF è§£æéŒ¯èª¤:', err);
                    alert('PDF è§£æå¤±æ•—: ' + err.message);
                    setIsParsing(false);
                } finally {
                    setParseProgress('');
                    e.target.value = '';
                }
            };
            
            // V79.0: è£œå……ä¸Šå‚³ï¼ˆå„æ­¥é©Ÿä½¿ç”¨ï¼Œä¸è§¸ç™¼ AIï¼‰
            const handleSupplementUpload = async (e) => {
                const files = Array.from(e.target.files || []);
                if (files.length === 0) return;
                
                // æ”¯æ´ PDF å’Œ Excel æª”æ¡ˆ
                const supportedFiles = files.filter(f => 
                    f.type === 'application/pdf' || 
                    f.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    f.type === 'application/vnd.ms-excel' ||
                    f.name.endsWith('.xlsx') ||
                    f.name.endsWith('.xls')
                );
                if (supportedFiles.length === 0) return;
                
                setIsParsing(true);
                const newDocs = [];
                
                try {
                    for (let i = 0; i < supportedFiles.length; i++) {
                        const file = supportedFiles[i];
                        setParseProgress(`è§£æä¸­: ${file.name}`);
                        
                        const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') ||
                            file.type.includes('spreadsheet') || file.type.includes('excel');
                        
                        if (isExcel) {
                            // Excel æª”æ¡ˆè™•ç†
                            const arrayBuffer = await file.arrayBuffer();
                            const workbook = XLSX.read(arrayBuffer);
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                            
                            let excelText = `=== Excel æª”æ¡ˆ: ${file.name} ===\n`;
                            jsonData.forEach((row) => {
                                if (row.some(cell => cell !== '')) {
                                    const rowText = row.map((cell) => {
                                        if (cell === '') return '';
                                        if (typeof cell === 'number' && cell > 40000 && cell < 60000) {
                                            const date = XLSX.SSF.parse_date_code(cell);
                                            if (date) return `${date.y}-${String(date.m).padStart(2,'0')}-${String(date.d).padStart(2,'0')}`;
                                        }
                                        return String(cell);
                                    }).filter(c => c !== '').join(' | ');
                                    if (rowText.trim()) excelText += rowText + '\n';
                                }
                            });
                            
                            const docType = detectDocumentType(excelText, file.name);
                            newDocs.push({ id: Date.now() + '_' + i, name: file.name, text: excelText.trim(), ...docType });
                        } else {
                            // PDF æª”æ¡ˆè™•ç†
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            let fullText = '';
                            
                            for (let p = 1; p <= pdf.numPages; p++) {
                                const page = await pdf.getPage(p);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n';
                            }
                            
                            const docType = detectDocumentType(fullText, file.name);
                            newDocs.push({ id: Date.now() + '_' + i, name: file.name, text: fullText.trim(), ...docType });
                        }
                    }
                    
                    setParsedDocuments(prev => [...prev, ...newDocs]);
                } catch (err) {
                    console.error('æ–‡ä»¶è§£æéŒ¯èª¤:', err);
                    alert('æ–‡ä»¶è§£æå¤±æ•—: ' + err.message);
                } finally {
                    setIsParsing(false);
                    setParseProgress('');
                    e.target.value = '';
                }
            };
            
            // V79.0: é–‹å§‹æ–°å¢è²¨æ«ƒï¼ˆé¡¯ç¤ºé¸æ“‡å™¨ï¼‰
            const handleStartNewContainer = () => {
                setFormData(initialFormState);
                setEditingId(null);
                setParsedDocuments([]);
                setAiExtractedData(null);
                setFieldSources({});
                setFieldConflicts({});
                setDuplicateContainer(null);
                setShowImportSelector(true);
            };
            
            // V79.0: é¸æ“‡æ‰‹å‹•å¡«å¯«
            const handleManualEntry = () => {
                setShowImportSelector(false);
                setFormStep(1);
                setView('form');
            };
            
            // V79.0: é—œé–‰åŒ¯å…¥é¸æ“‡å™¨ï¼ˆæ¸…é™¤ç‹€æ…‹ï¼‰
            const handleCloseImportSelector = () => {
                setShowImportSelector(false);
                setParsedDocuments([]);
                setAiExtractedData(null);
                setFieldSources({});
                setFieldConflicts({});
                setDuplicateContainer(null);
                setShowAiPreview(false);
            };
            
            // V79.0: ç§»é™¤å·²è§£æçš„æ–‡ä»¶
            const handleRemoveDocument = (docId) => {
                setParsedDocuments(prev => prev.filter(d => d.id !== docId));
            };
            
            // V79.0: å–å¾—ç‰¹å®šé¡å‹çš„æ–‡ä»¶
            const getDocumentByType = (type) => {
                return parsedDocuments.find(d => d.type === type);
            };
            
            // V79.1: Gemini API è§£ææç¤ºè©ï¼ˆå‡½æ•¸å½¢å¼ï¼Œæ”¯æ´å‹•æ…‹è¨­å®šï¼‰
            const getGeminiPromptStart = (mergeMode) => {
                const batchRuleSection = mergeMode === 'split' 
                    ? `## åŒå“é …å¤šæ‰¹è™Ÿè™•ç†è¦å‰‡ï¼ˆé‡è¦ï¼‰ï¼š
æ¡ç”¨ã€Œæ‹†åˆ†æ¨¡å¼ã€ï¼šæ¯å€‹æ‰¹è™Ÿç¨ç«‹ä¸€ç­†
- æ¯å€‹ä¸åŒçš„æ‰¹è™Ÿéƒ½è¦å–®ç¨åˆ—å‡º
- ä¿ç•™åŸå§‹çš„ quantity å’Œ weight
- ä¿ç•™åŸå§‹çš„ batchNumber
- ä¿ç•™åŸå§‹çš„ expiryDate

ç¯„ä¾‹ï¼š
åŸå§‹è³‡æ–™æœ‰ 2 å€‹æ‰¹è™Ÿï¼š
  ç†Ÿç™½è¦ HOSO 41/50 | 100ä»¶ | BC11-TR2505 | 2028-11-21
  ç†Ÿç™½è¦ HOSO 41/50 |  63ä»¶ | BC11-TR2506 | 2028-11-30
è¼¸å‡º 2 ç­†ç”¢å“ï¼š
  {"name":"ç†Ÿç™½è¦ HOSO","spec":"41/50","quantity":100,"batchNumber":"BC11-TR2505","expiryDate":"2028-11-21"}
  {"name":"ç†Ÿç™½è¦ HOSO","spec":"41/50","quantity":63,"batchNumber":"BC11-TR2506","expiryDate":"2028-11-30"}`
                    : `## åŒå“é …å¤šæ‰¹è™Ÿè™•ç†è¦å‰‡ï¼ˆé‡è¦ï¼‰ï¼š
æ¡ç”¨ã€Œåˆä½µæ¨¡å¼ã€ï¼šåŒå“å + åŒè¦æ ¼ â†’ åˆä½µç‚ºä¸€ç­†
- quantityï¼šä»¶æ•¸åŠ ç¸½
- weightï¼šé‡é‡åŠ ç¸½
- batchNumberï¼šå¡«ã€Œå¤šæ‰¹è™Ÿã€
- expiryDateï¼šå–æœ€æ—©çš„æ•ˆæœŸæ—¥æœŸ

ç¯„ä¾‹ï¼š
åŸå§‹è³‡æ–™ï¼š
  ç†Ÿç™½è¦ HOSO 41/50 | 100ä»¶ | BC11-TR2505 | 2028-11-21
  ç†Ÿç™½è¦ HOSO 41/50 |  63ä»¶ | BC11-TR2506 | 2028-11-30
åˆä½µå¾Œï¼š
  ç†Ÿç™½è¦ HOSO 41/50 | 163ä»¶ | å¤šæ‰¹è™Ÿ | 2028-11-21ï¼ˆå–è¼ƒæ—©ï¼‰`;

                return `# ä»»å‹™ï¼šè§£æé€²å£è²¨æ«ƒå ±é—œæ–‡ä»¶ä¸¦è¼¸å‡º JSON

è«‹ä»”ç´°æª¢è¦–æ–‡ä»¶åœ–ç‰‡æˆ–æ–‡å­—ï¼Œæå–æ‰€æœ‰è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼å›å‚³ã€‚

## éœ€æå–çš„æ¬„ä½ï¼š
- containerNumber: æ«ƒè™Ÿï¼ˆæ ¼å¼ï¼š4è‹±æ–‡+7æ•¸å­—ï¼Œå¦‚ TEMU9322425ã€OTPU6492634ï¼‰
- importCompany: é€²å£å…¬å¸ï¼ˆWEN'S FROZEN=å´‡æ–‡å†·å‡, 8WAY=å…«æ–¹ç’°çƒ, STAR UNIVERSE=å´‡æ–‡å†·å‡, IOCEAN=å´‡æ–‡å†·å‡ï¼‰
- arrivalDate: åˆ°æ¸¯æ—¥ YYYY-MM-DD
- supplier: å» å•†ï¼ˆInvoice ç™¼ç¥¨äºº/SHIPPERï¼Œå¦‚ IOCEAN LLCã€OMARSAï¼‰
- origin: ç”¢åœ°ä¸­æ–‡ï¼ˆINDONESIA=å°å°¼, ECUADOR=å„ç“œå¤š, THAILAND=æ³°åœ‹, CHINA=ä¸­åœ‹, VIETNAM=è¶Šå—, CHILE=æ™ºåˆ©ï¼‰
- shippingLine: èˆ¹å…¬å¸åç¨±ï¼ˆæå–®æŠ¬é ­çš„å…¬å¸ï¼Œå¦‚ EVERGREENã€MSCã€COSCOã€MAERSKã€HAPAG-LLOYDã€ONEã€YANG MINGï¼‰
- vesselVoyage: èˆ¹åèˆªæ¬¡ï¼ˆå¦‚ EVER APEX 1367-012Eã€MSC VICTORIA FA550Rï¼‰
- billOfLading: æå–®è™Ÿç¢¼ï¼ˆB/L NO.ï¼‰
- products: ç”¢å“é™£åˆ—ï¼ˆè¦‹ä¸‹æ–¹æ ¼å¼ï¼‰
- totalQuantity: ç¸½ä»¶æ•¸
- totalWeight: ç¸½é‡é‡

## èˆ¹å…¬å¸ vs èˆ¹åèˆªæ¬¡ï¼ˆé‡è¦å€åˆ†ï¼‰ï¼š
- shippingLine èˆ¹å…¬å¸ï¼šæå–®æœ€ä¸Šæ–¹çš„å…¬å¸åç¨±/Logoï¼Œå¦‚ EVERGREEN LINEã€MSCã€COSCO SHIPPING
- vesselVoyage èˆ¹åèˆªæ¬¡ï¼šæ–‡ä»¶ä¸­ VESSEL NO. / VOYAGE æ¬„ä½çš„å…§å®¹ï¼Œå¦‚ EVER APEX 1367-012E
- æ³¨æ„ï¼šVESSEL NO. æ˜¯èˆ¹åï¼Œä¸æ˜¯èˆ¹å…¬å¸ï¼

## æ«ƒè™Ÿè­˜åˆ¥é‡é»ï¼š
1. Bill of Lading æå–®ä¸­ã€ŒCONTAINER NO. / SEAL NO.ã€æ¬„ä½
2. Packing List ä¸­ã€ŒCONTAINER NUMBERã€æˆ–ã€ŒNro de Contenedoã€(è¥¿ç­ç‰™æ–‡)
3. æ•ˆæœŸæ¸…å–® Excel ä¸­ã€ŒCONTAINER NUMBERã€æ¬„ä½
4. æ ¼å¼ï¼š4è‹±æ–‡+7æ•¸å­—ï¼ˆå¦‚ OTPU6492634ã€TRIU8615920ï¼‰

## æ‰¹è™Ÿè­˜åˆ¥é‡é»ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š
1. Invoice ä¸Šçš„ S/N æ¬„ä½å°±æ˜¯æ‰¹è™Ÿï¼ˆå¦‚ BW08-W2535ï¼‰
2. æ•ˆæœŸæ¸…å–®çš„ LOT S/N æ¬„ä½ä¹Ÿæ˜¯æ‰¹è™Ÿï¼ˆå¦‚ BC11-TR2505ã€BCTO-TR2504ï¼‰
3. Excel æ•ˆæœŸæ¸…å–®å¯èƒ½æœ‰å¤šå€‹ LOT #ï¼ˆå¦‚ 1407899, 1408097...ï¼‰ï¼Œé€™æ˜¯å·¥å» å…§éƒ¨æ‰¹è™Ÿ

## æ•ˆæœŸè­˜åˆ¥é‡é»ï¼š
1. è‹±æ–‡ï¼šEXPIRATION DATEã€EXPIRY DATEã€EXP DATEã€Exp.
2. è¥¿ç­ç‰™æ–‡ï¼šFecha de Vencimiento
3. æ•ˆæœŸæ¸…å–®æ ¼å¼ï¼šREPORTE DE LOTESï¼ˆæ‰¹æ¬¡å ±å‘Šï¼‰ã€PRODUCTION DATEï¼ˆæ³°åœ‹æ ¼å¼ï¼‰
4. æ—¥æœŸæ ¼å¼è½‰æ›ï¼š
   - DD.MM.YYYYï¼ˆå¦‚ 21.11.2028ï¼‰â†’ 2028-11-21
   - DD/MM/YYYYï¼ˆå¦‚ 21/11/2028ï¼‰â†’ 2028-11-21
   - YYYY-MM-DD ä¿æŒä¸è®Š
5. æ³¨æ„ï¼šDATE CODE æ˜¯ç”Ÿç”¢æ—¥æœŸï¼Œä¸æ˜¯æ•ˆæœŸï¼

## æ³°åœ‹ä¾›æ‡‰å•†ï¼ˆYEENIN FROZEN FOODSï¼‰ç‰¹æ®Šæ ¼å¼ï¼š
- æ–‡ä»¶æ¨™é¡Œå¯èƒ½æ˜¯ PRODUCTION DATE ä½†åŒ…å«æ•ˆæœŸè³‡è¨Š
- LOT S/N æ¬„ä½æ˜¯æ‰¹è™Ÿ
- Exp. æ¬„ä½æ˜¯æ•ˆæœŸï¼ˆDD.MM.YYYY æ ¼å¼ï¼‰
- DATE CODE æ˜¯ç”Ÿç”¢æ—¥æœŸï¼ˆä¸è¦èª¤èªç‚ºæ•ˆæœŸï¼‰
- VESSEL æ˜¯èˆ¹åï¼ŒAGENT æ˜¯èˆ¹å…¬å¸

${batchRuleSection}

## ç”¢å“æ¬„ä½ï¼š
- originalText: è‹±æ–‡å“ååŸæ–‡
- name: ä¸­æ–‡å“å
  - WHITE SHRIMP/VANNAMEI = ç™½è¦
  - HOSO (HEAD ON SHELL ON) = å¸¶é ­å¸¶æ®¼
  - HLSO (HEADLESS SHELL ON) = å»é ­å¸¶æ®¼
  - PTO (PEELED TAIL-ON) = å»æ®¼å¸¶å°¾
  - P&D (PEELED & DEVEINED) = å»æ®¼å»è…¸æ³¥
  - SEMI-BLOCK = åŠå¡Š
  - B GRADE = Bç´š
  - COOKED = ç†Ÿ
  - RAW = ç”Ÿ
  - SALMON COHO = éŠ€é®­
  - SQUID = é­·é­š
  - SNAIL = è¸ç‰›
- spec: è¦æ ¼ï¼ˆå¦‚ 20/30, 41/50, 61/70, 9-UP LB, HG IQFï¼‰
- quantity: ä»¶æ•¸ï¼ˆç´”æ•¸å­—ï¼‰
- weight: æ·¨é‡kgï¼ˆç´”æ•¸å­—ï¼‰
- unitPrice: å–®åƒ¹USDï¼ˆç´”æ•¸å­—ï¼Œæ­æ´²æ ¼å¼ 6,40 = 6.40ï¼‰
- batchNumber: æ‰¹è™Ÿ
- expiryDate: æ•ˆæœŸ YYYY-MM-DD

## æ–‡ä»¶å…§å®¹ï¼š
`;
            };

            const GEMINI_PARSE_PROMPT_END = `

## è¼¸å‡ºè¦æ±‚ï¼š
åªè¼¸å‡º JSONï¼Œä¸è¦è¼¸å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€èªªæ˜æˆ– markdown æ¨™è¨˜ã€‚

JSON ç¯„ä¾‹ï¼š
{"containerNumber":"OTPU6492634","importCompany":"å´‡æ–‡å†·å‡","arrivalDate":"2025-01-15","supplier":"IOCEAN LLC","origin":"å„ç“œå¤š","shippingLine":"EVERGREEN","vesselVoyage":"EVER APEX 1367-012E","billOfLading":"EGLV123456789","devanningLocation":"","products":[{"originalText":"LIVE FROZEN HOSO WHITE SHRIMPS 20/30","name":"ç™½è¦ HOSO","spec":"20/30 650GÃ—12B","quantity":1435,"weight":11193,"unitPrice":6.40,"batchNumber":"BW08-W2535","expiryDate":"2027-12-09","pricingMode":"weight"}],"totalQuantity":2050,"totalWeight":15990}`;
            
            // V79.0: AI è§£æ - ç›´æ¥å‘¼å« Gemini APIï¼ˆå«é‡è©¦æ©Ÿåˆ¶ï¼‰
            const processWithAI = async (documents) => {
                const MAX_RETRIES = 2; // æœ€å¤šé‡è©¦ 2 æ¬¡
                
                // æª¢æŸ¥ API Key
                if (!geminiApiKey) {
                    setShowImportSelector(false);
                    setTempApiKey('');
                    setShowApiKeyModal(true);
                    return;
                }
                
                setIsAiProcessing(true);
                
                let lastError = null;
                
                for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
                    try {
                        setParseProgress(attempt > 0 ? `AI é‡è©¦ä¸­ (${attempt}/${MAX_RETRIES})...` : 'AI æ­£åœ¨åˆ†ææ–‡ä»¶å…§å®¹...');
                        
                        // åˆ†é›¢æ–‡å­—å‹å’Œæƒæå‹æ–‡ä»¶
                        const textDocs = documents.filter(d => !d.isScanned && d.text);
                        const scannedDocs = documents.filter(d => d.isScanned && d.base64);
                        
                        // çµ„åˆæ–‡å­—å…§å®¹
                        const combinedTextContent = textDocs.map(doc => 
                            `=== ${doc.label} (${doc.name}) ===\n${doc.text}`
                        ).join('\n\n');
                        
                        // çµ„åˆå®Œæ•´ Promptï¼ˆæ ¹æ“šæ‰¹è™Ÿè™•ç†æ¨¡å¼å‹•æ…‹ç”Ÿæˆï¼‰
                        const fullPrompt = getGeminiPromptStart(batchMergeMode) + 
                            (combinedTextContent || 'ï¼ˆæ–‡å­—å…§å®¹è¦‹é™„ä»¶åœ–ç‰‡ï¼‰') + 
                            GEMINI_PARSE_PROMPT_END;
                        
                        // å»ºç«‹ parts é™£åˆ—ï¼ˆæ–‡å­— + æƒææª”åœ–ç‰‡ï¼‰
                        const parts = [{ text: fullPrompt }];
                        
                        // åŠ å…¥æƒææª”çš„ base64 è³‡æ–™
                        for (const doc of scannedDocs) {
                            console.log(`ğŸ“· åŠ å…¥æƒææª”: ${doc.name}`);
                            parts.push({
                                inlineData: {
                                    mimeType: doc.mimeType || 'application/pdf',
                                    data: doc.base64
                                }
                            });
                        }
                        
                        console.log('ğŸ“¤ å‘¼å« Gemini API...', attempt > 0 ? `(é‡è©¦ ${attempt})` : '', 
                            scannedDocs.length > 0 ? `(å« ${scannedDocs.length} ä»½æƒææª”)` : '');
                        
                        // å‘¼å« Gemini API
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: parts }],
                                generationConfig: { temperature: 0.1, maxOutputTokens: 4096 }
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            if (response.status === 400 && errorData.error?.message?.includes('API key')) {
                                throw { fatal: true, message: 'API Key ç„¡æ•ˆï¼Œè«‹é‡æ–°è¨­å®š' };
                            }
                            throw new Error(errorData.error?.message || `API éŒ¯èª¤ (${response.status})`);
                        }
                        
                        const result = await response.json();
                        const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (!responseText) {
                            throw new Error('AI å›æ‡‰ç‚ºç©º');
                        }
                        
                        console.log('ğŸ“¥ AI åŸå§‹å›æ‡‰:', responseText.substring(0, 300) + '...');
                        
                        // è§£æ JSON
                        let jsonStr = responseText
                            .replace(/```json\s*/gi, '')
                            .replace(/```\s*/g, '')
                            .replace(/[\r\n]+/g, ' ')
                            .trim();
                        
                        const startIdx = jsonStr.indexOf('{');
                        const endIdx = jsonStr.lastIndexOf('}');
                        if (startIdx === -1 || endIdx === -1 || endIdx <= startIdx) {
                            throw new Error('å›æ‡‰ä¸­æ‰¾ä¸åˆ° JSON');
                        }
                        
                        jsonStr = jsonStr.substring(startIdx, endIdx + 1)
                            .replace(/,\s*}/g, '}')
                            .replace(/,\s*]/g, ']');
                        
                        const parsedData = JSON.parse(jsonStr);
                        console.log('âœ… JSON è§£ææˆåŠŸ');
                        
                        // æˆåŠŸï¼è™•ç†çµæœä¸¦é€€å‡º
                        processAiResult(parsedData, documents);
                        setIsAiProcessing(false);
                        setParseProgress('');
                        return; // æˆåŠŸï¼ŒçµæŸå‡½æ•¸
                        
                    } catch (err) {
                        console.warn(`âŒ ç¬¬ ${attempt + 1} æ¬¡å˜—è©¦å¤±æ•—:`, err.message || err);
                        lastError = err;
                        
                        // å¦‚æœæ˜¯è‡´å‘½éŒ¯èª¤ï¼ˆAPI Key ç„¡æ•ˆï¼‰ï¼Œä¸é‡è©¦
                        if (err.fatal) {
                            break;
                        }
                        
                        // å¦‚æœé‚„æœ‰é‡è©¦æ©Ÿæœƒï¼Œç­‰å¾…å¾Œç¹¼çºŒ
                        if (attempt < MAX_RETRIES) {
                            await new Promise(r => setTimeout(r, 1500));
                        }
                    }
                }
                
                // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
                setIsAiProcessing(false);
                setParseProgress('');
                
                console.error('AI è§£ææœ€çµ‚å¤±æ•—:', lastError);
                
                if (lastError?.fatal || lastError?.message?.includes('API Key')) {
                    setGeminiApiKey('');
                    localStorage.removeItem('gemini_api_key');
                    setTempApiKey('');
                    setShowApiKeyModal(true);
                } else {
                    const useManual = confirm(
                        'AI è§£æå¤±æ•—: ' + (lastError?.message || 'æœªçŸ¥éŒ¯èª¤') + 
                        '\n\næ˜¯å¦æ”¹ç”¨æ‰‹å‹•å¡«å¯«æ¨¡å¼ï¼Ÿ'
                    );
                    if (useManual) {
                        setShowImportSelector(false);
                        setFormStep(1);
                        setView('form');
                    }
                }
            };
            
            // V79.0: è™•ç† AI å›å‚³çµæœï¼Œå»ºç«‹æ¬„ä½ä¾†æºå°ç…§
            const processAiResult = (data, documents) => {
                console.log('ğŸ“Š processAiResult é–‹å§‹è™•ç†...');
                console.log('ğŸ“Š æ”¶åˆ°çš„è³‡æ–™:', JSON.stringify(data, null, 2).substring(0, 500));
                
                // è™•ç†æ–°æ¬„ä½æ˜ å°„ï¼šshippingLine + vesselVoyage â†’ shippingCompany
                if (data.shippingLine || data.vesselVoyage) {
                    const parts = [];
                    if (data.shippingLine) parts.push(data.shippingLine);
                    if (data.vesselVoyage) parts.push(data.vesselVoyage);
                    data.shippingCompany = parts.join(' / ');
                    console.log(`ğŸš¢ èˆ¹å…¬å¸åˆä½µ: ${data.shippingCompany}`);
                }
                
                const sources = {};
                const conflicts = {};
                
                // å®šç¾©æ¬„ä½å°æ‡‰ï¼ˆB/L æ˜¯æ«ƒè™Ÿçš„ä¸»è¦ä¾†æºï¼‰
                const fieldMapping = {
                    containerNumber: { label: 'æ«ƒè™Ÿ', priority: ['bl', 'packing', 'arrival', 'invoice'] },
                    billOfLading: { label: 'æå–®è™Ÿç¢¼', priority: ['bl', 'arrival'] },
                    arrivalDate: { label: 'åˆ°æ¸¯æ—¥', priority: ['arrival', 'bl'] },
                    supplier: { label: 'å» å•†', priority: ['invoice', 'packing', 'bl'] },
                    origin: { label: 'ç”¢åœ°', priority: ['invoice', 'packing'] },
                    shippingCompany: { label: 'èˆ¹å…¬å¸', priority: ['bl', 'arrival'] },
                    devanningLocation: { label: 'æ‹†æ«ƒåœ°', priority: ['arrival'] },
                    importCompany: { label: 'é€²å£å…¬å¸', priority: ['invoice', 'bl', 'arrival'] }
                };
                
                // è™•ç†æ¯å€‹æ¬„ä½
                Object.keys(fieldMapping).forEach(field => {
                    if (data[field]) {
                        const value = data[field];
                        const sourceDoc = documents.find(d => fieldMapping[field].priority.includes(d.type));
                        sources[field] = {
                            value: value.value || value,
                            source: sourceDoc?.label || 'è‡ªå‹•è­˜åˆ¥',
                            confidence: value.confidence || 'high',
                            alternatives: value.alternatives || []
                        };
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰è¡çªï¼ˆåŒä¸€æ¬„ä½å¤šå€‹ä¸åŒå€¼ï¼‰
                        if (value.alternatives && value.alternatives.length > 0) {
                            conflicts[field] = [
                                { value: value.value || value, source: sourceDoc?.label },
                                ...value.alternatives.map(alt => ({ value: alt.value, source: alt.source }))
                            ];
                        }
                    }
                });
                
                // è™•ç†ç”¢å“æ˜ç´°
                if (data.products && Array.isArray(data.products)) {
                    sources.products = {
                        value: data.products,
                        source: 'Invoice / Packing List',
                        confidence: 'high'
                    };
                }
                
                // æª¢æŸ¥ç¼ºå°‘çš„é—œéµæ¬„ä½
                const missingFields = [];
                if (!data.containerNumber) missingFields.push('æ«ƒè™Ÿ');
                if (!data.arrivalDate) missingFields.push('åˆ°æ¸¯æ—¥');
                if (!data.supplier) missingFields.push('å» å•†');
                
                if (missingFields.length > 0) {
                    console.warn('âš ï¸ ä»¥ä¸‹æ¬„ä½æœªè§£æå‡ºä¾†ï¼Œè«‹æ‰‹å‹•è£œå……:', missingFields.join(', '));
                }
                
                setAiExtractedData(data);
                setFieldSources(sources);
                setFieldConflicts(conflicts);
                setDuplicateContainer(null); // é‡ç½®é‡è¤‡æª¢æŸ¥
                
                // æª¢æŸ¥æ«ƒè™Ÿæ˜¯å¦å·²å­˜åœ¨
                console.log(`ğŸ” é–‹å§‹æª¢æŸ¥æ«ƒè™Ÿé‡è¤‡...`);
                console.log(`ğŸ” è§£æå‡ºçš„æ«ƒè™Ÿ: "${data.containerNumber}"`);
                console.log(`ğŸ” ç¾æœ‰è¨˜éŒ„æ•¸: ${shipments.length}`);
                
                if (data.containerNumber) {
                    const existing = shipments.find(s => {
                        const match = s.containerNumber === data.containerNumber && !s.id?.startsWith('temp_');
                        if (s.containerNumber) {
                            console.log(`   æ¯”å°: ${s.containerNumber} === ${data.containerNumber} â†’ ${match}`);
                        }
                        return match;
                    });
                    
                    if (existing) {
                        console.warn(`âš ï¸ æ«ƒè™Ÿ ${data.containerNumber} å·²å­˜åœ¨ï¼`);
                        console.warn(`   åˆ°æ¸¯æ—¥: ${existing.arrivalDate}, å» å•†: ${existing.supplier}`);
                        setDuplicateContainer({
                            containerNo: data.containerNumber,
                            existingId: existing.id,
                            existingArrivalDate: existing.arrivalDate,
                            existingSupplier: existing.supplier
                        });
                    } else {
                        console.log(`âœ… æ«ƒè™Ÿ ${data.containerNumber} ç„¡é‡è¤‡`);
                    }
                } else {
                    console.log(`âš ï¸ æ²’æœ‰è§£æå‡ºæ«ƒè™Ÿï¼Œè·³éé‡è¤‡æª¢æŸ¥`);
                }
                
                setShowAiPreview(true);
                
                // å¦‚æœç¼ºå°‘æ«ƒè™Ÿï¼Œæç¤ºç”¨æˆ¶å¯èƒ½éœ€è¦ä¸Šå‚³ B/L æˆ– Packing List
                if (!data.containerNumber) {
                    console.log('ğŸ’¡ æç¤ºï¼šæ«ƒè™Ÿé€šå¸¸åœ¨ B/L æˆ– Packing List ä¸­ï¼Œå»ºè­°è£œå……ä¸Šå‚³é€™äº›æ–‡ä»¶');
                }
            };
            
            // V79.0: ç¢ºèª AI è§£æçµæœï¼Œå¡«å…¥è¡¨å–®
            const confirmAiExtraction = () => {
                if (!aiExtractedData) return;
                
                // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰ç”¢å“éƒ½å·²é¸æ“‡ ERP å“å
                const productsData = fieldSources.products?.value || [];
                const hasUnselected = productsData.some(p => !p.selectedName);
                if (hasUnselected && productsData.length > 0) {
                    alert('è«‹ç‚ºæ¯å€‹ç”¢å“é¸æ“‡å°æ‡‰çš„ ERP å“å');
                    return;
                }
                
                const newFormData = { ...initialFormState };
                
                // å¡«å…¥åŸºæœ¬æ¬„ä½
                const simpleFields = ['containerNumber', 'arrivalDate', 'supplier', 'origin', 
                    'shippingCompany', 'devanningLocation', 'importCompany', 'customsBroker'];
                
                simpleFields.forEach(field => {
                    if (fieldSources[field]) {
                        newFormData[field] = fieldSources[field].value;
                    }
                });
                
                // å¡«å…¥ç”¢å“æ˜ç´°ï¼ˆä½¿ç”¨é¸æ“‡çš„ ERP å“åï¼‰
                if (productsData.length > 0) {
                    newFormData.products = productsData.map((p, idx) => {
                        // åˆ†å‰²é¸æ“‡çš„å“åå’Œè¦æ ¼
                        const selectedName = p.selectedName || '';
                        const selectedSpec = p.selectedSpec || '';
                        
                        return {
                            id: Date.now() + idx,
                            name: selectedName.replace(selectedSpec, '').trim(), // ERP å“å
                            spec: selectedSpec, // ERP è¦æ ¼
                            quantity: p.quantity || 0,
                            weight: p.weight || 0,
                            unitPrice: p.unitPrice || 0,
                            batchNumber: p.batchNumber || '',
                            expiryDate: p.expiryDate || '',
                            pricingMode: p.pricingMode || 'weight',
                            amount: (p.pricingMode === 'quantity' ? p.quantity : p.weight) * (p.unitPrice || 0)
                        };
                    });
                }
                
                setFormData(newFormData);
                setShowAiPreview(false);
                setFormStep(1);
                setView('form');
            };
            
            // V79.0: ä¿®æ”¹å–®ä¸€æ¬„ä½çš„å€¼ï¼ˆå¾è¡çªä¸­é¸æ“‡ï¼‰
            const selectFieldValue = (field, value, source) => {
                setFieldSources(prev => ({
                    ...prev,
                    [field]: { ...prev[field], value, source }
                }));
                // æ¸…é™¤è©²æ¬„ä½çš„è¡çªæ¨™è¨˜
                setFieldConflicts(prev => {
                    const newConflicts = { ...prev };
                    delete newConflicts[field];
                    return newConflicts;
                });
            };
            
            // V79.0: å–æ¶ˆ AI é å¡«ï¼Œæ”¹ç”¨æ‰‹å‹•
            const cancelAiExtraction = () => {
                setShowAiPreview(false);
                setAiExtractedData(null);
                setFieldSources({});
                setFieldConflicts({});
                setFormStep(1);
                setView('form');
            };
            
            // V79.0: ä¿¡å¿ƒåº¦é¡è‰²
            const getConfidenceColor = (confidence) => {
                switch(confidence) {
                    case 'high': return 'text-green-600 bg-green-50 border-green-200';
                    case 'medium': return 'text-yellow-600 bg-yellow-50 border-yellow-200';
                    case 'low': return 'text-red-600 bg-red-50 border-red-200';
                    default: return 'text-gray-600 bg-gray-50 border-gray-200';
                }
            };
            
            // V79.0: ä¿¡å¿ƒåº¦æ–‡å­—
            const getConfidenceLabel = (confidence) => {
                switch(confidence) {
                    case 'high': return 'âœ“ é«˜ä¿¡å¿ƒ';
                    case 'medium': return '? ä¸­ç­‰';
                    case 'low': return '! éœ€ç¢ºèª';
                    default: return '';
                }
            };

            // V74.0: Excel åŒ¯å…¥åŠŸèƒ½
            const EXCEL_COLUMN_MAP = {
                'å» å•†': 'supplier',
                'ä¾›æ‡‰å•†': 'supplier',
                'å“å': 'productName',
                'ç”¢å“åç¨±': 'productName',
                'è¦æ ¼': 'spec',
                'å–®åƒ¹': 'unitPrice',
                'åƒ¹æ ¼': 'unitPrice',
                'æ•¸é‡': 'quantity',
                'ä»¶æ•¸': 'quantity',
                'é‡é‡': 'weight',
                'æ‰¹è™Ÿ': 'batchNumber',
                'æ•ˆæœŸ': 'expiryDate',
                'æœ‰æ•ˆæœŸé™': 'expiryDate',
                'æ¡è³¼æ—¥æœŸ': 'arrivalDate',
                'æ—¥æœŸ': 'arrivalDate',
                'é€²è²¨æ—¥æœŸ': 'arrivalDate',
            };

            const parseExcelDate = (value) => {
                if (!value) return '';
                // Excel æ—¥æœŸåºåˆ—å€¼
                if (typeof value === 'number') {
                    const date = XLSX.SSF.parse_date_code(value);
                    if (date) {
                        const y = date.y;
                        const m = String(date.m).padStart(2, '0');
                        const d = String(date.d).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    }
                }
                // å­—ä¸²æ—¥æœŸæ ¼å¼
                if (typeof value === 'string') {
                    // è™•ç† YYYY/MM/DD æˆ– YYYY-MM-DD
                    const match = value.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (match) {
                        return `${match[1]}-${match[2].padStart(2,'0')}-${match[3].padStart(2,'0')}`;
                    }
                    // è™•ç†æ°‘åœ‹å¹´ (113/01/15)
                    const rocMatch = value.match(/(\d{2,3})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (rocMatch && parseInt(rocMatch[1]) < 200) {
                        const year = parseInt(rocMatch[1]) + 1911;
                        return `${year}-${rocMatch[2].padStart(2,'0')}-${rocMatch[3].padStart(2,'0')}`;
                    }
                }
                return '';
            };

            const handleExcelImport = async (evt) => {
                const file = evt.target.files[0];
                if (!file) return;
                evt.target.value = '';
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    
                    if (jsonData.length === 0) {
                        alert(TEXT.IMPORT_NO_DATA);
                        return;
                    }
                    
                    // è§£æä¸¦è½‰æ›è³‡æ–™
                    const headers = Object.keys(jsonData[0]);
                    const columnMapping = {};
                    headers.forEach(h => {
                        const key = h.trim();
                        if (EXCEL_COLUMN_MAP[key]) {
                            columnMapping[key] = EXCEL_COLUMN_MAP[key];
                        }
                    });
                    
                    const parsedData = jsonData.map((row, idx) => {
                        const item = { _rowIndex: idx + 2 }; // Excel è¡Œè™Ÿï¼ˆå«æ¨™é¡Œåˆ—ï¼‰
                        
                        Object.entries(row).forEach(([key, value]) => {
                            const mappedKey = columnMapping[key.trim()];
                            if (mappedKey) {
                                if (mappedKey === 'arrivalDate' || mappedKey === 'expiryDate') {
                                    item[mappedKey] = parseExcelDate(value);
                                } else if (mappedKey === 'unitPrice' || mappedKey === 'quantity' || mappedKey === 'weight') {
                                    item[mappedKey] = safeNum(value);
                                } else {
                                    item[mappedKey] = String(value || '').trim();
                                }
                            }
                        });
                        
                        // ç”¢ç”Ÿå”¯ä¸€è­˜åˆ¥ç¢¼ç”¨æ–¼é‡è¤‡æª¢æŸ¥
                        item._uniqueKey = `${item.supplier || ''}_${item.arrivalDate || ''}_${item.productName || ''}`;
                        
                        return item;
                    }).filter(item => item.supplier || item.productName); // éæ¿¾ç©ºç™½åˆ—
                    
                    setImportData(parsedData);
                    setShowImportModal(true);
                    
                } catch (error) {
                    console.error('Excel è§£æéŒ¯èª¤:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                }
            };

            const handleConfirmImport = async () => {
                if (importData.length === 0) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                setImportProcessing(true);
                setImportProgress({ current: 0, total: importData.length });
                
                let successCount = 0;
                let errorCount = 0;
                
                try {
                    for (let i = 0; i < importData.length; i++) {
                        const item = importData[i];
                        setImportProgress({ current: i + 1, total: importData.length });
                        
                        // å»ºç«‹æ¡è³¼å–®è³‡æ–™çµæ§‹
                        const shipmentData = {
                            importCompany: IMPORT_COMPANIES[0],
                            customsBroker: DOMESTIC_FLAG, // åœ‹å…§æ¡è³¼
                            containerNumber: `DOM-${item.arrivalDate?.replace(/-/g, '') || Date.now()}`,
                            arrivalDate: item.arrivalDate || new Date().toISOString().split('T')[0],
                            supplier: item.supplier || '',
                            origin: 'å°ç£',
                            currency: 'TWD',
                            paymentTerm: PAYMENT_TERMS_DOMESTIC[0],
                            products: [{
                                id: Date.now() + i,
                                name: item.productName || '',
                                spec: item.spec || '',
                                unitPrice: item.unitPrice || 0,
                                quantity: item.quantity || 0,
                                weight: item.weight || 0,
                                batchNumber: item.batchNumber || '',
                                expiryDate: item.expiryDate || '',
                                pricingMode: 'weight',
                                boxCapacity: 1,
                                amount: round2((item.weight || 0) * (item.unitPrice || 0))
                            }],
                            totalQuantity: item.quantity || 0,
                            totalWeight: item.weight || 0,
                            isPaid: false,
                            warehouseConfirmed: false,
                            attachments: [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                        };
                        
                        try {
                            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡è³‡æ–™ï¼ˆç›¸åŒå» å•† + æ—¥æœŸ + å“åï¼‰
                            const existingQuery = await db.collection('shipments')
                                .where('customsBroker', '==', DOMESTIC_FLAG)
                                .where('supplier', '==', shipmentData.supplier)
                                .where('arrivalDate', '==', shipmentData.arrivalDate)
                                .get();
                            
                            let existingDoc = null;
                            existingQuery.forEach(doc => {
                                const data = doc.data();
                                const hasProduct = (data.products || []).some(p => p.name === item.productName);
                                if (hasProduct) existingDoc = doc;
                            });
                            
                            if (existingDoc) {
                                // è¦†è“‹æ›´æ–°
                                await db.collection('shipments').doc(existingDoc.id).update({
                                    ...shipmentData,
                                    createdAt: existingDoc.data().createdAt, // ä¿ç•™åŸå»ºç«‹æ™‚é–“
                                });
                            } else {
                                // æ–°å¢
                                await db.collection('shipments').add(shipmentData);
                            }
                            successCount++;
                        } catch (err) {
                            console.error('åŒ¯å…¥å–®ç­†å¤±æ•—:', err);
                            errorCount++;
                        }
                    }
                    
                    setShowImportModal(false);
                    setImportData([]);
                    showToast(`${TEXT.IMPORT_SUCCESS}ï¼š${successCount} ç­†æˆåŠŸ${errorCount > 0 ? `ï¼Œ${errorCount} ç­†å¤±æ•—` : ''}`);
                    
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                } finally {
                    setImportProcessing(false);
                }
            };

            // V75.0: ç”¢å“ä¸»æª”ç›¸é—œå‡½æ•¸
            const initialProductState = {
                productId: '',
                name: '',
                spec: '',
                unit: 'åŒ…',
                defaultPrice: 0,
                defaultSupplier: '',
                isActive: true
            };

            const PRODUCT_UNITS = ['åŒ…', 'ä»¶', 'KG', 'ç›’', 'ç‰‡', 'å°¾', 'æ–¤', 'æ¡¶', 'ç®±', 'å¡Š'];

            // V77.0: å…§å»ºç”¢å“ä¸»æª”åˆå§‹è³‡æ–™ (351ç­†)
            const INITIAL_PRODUCTS_DATA = [{"productId":"A09134S20P","name":"ç„¡è†¨ç™¼è¦ä»PD","spec":"36/40S*420G*20åŒ…(IQ10%)","unit":"ä»¶"},{"productId":"A0914510","name":"å–®å‡ç™½ä»åŸæ–™","spec":"40/50*10KG(IQ)","unit":"ä»¶"},{"productId":"A0915610","name":"å–®å‡ç™½ä»åŸæ–™","spec":"50/60*10KG(IQ)","unit":"ä»¶"},{"productId":"A0916710","name":"å–®å‡ç™½ä»åŸæ–™","spec":"60/70*10KG(IQ)","unit":"ä»¶"},{"productId":"A0916712","name":"å–®å‡ç™½ä»åŸæ–™","spec":"60/70*1K*12åŒ…(IQ20%)","unit":"ä»¶"},{"productId":"A0917910","name":"å–®å‡ç™½ä»åŸæ–™","spec":"70/90*10KG(IQ)","unit":"ä»¶"},{"productId":"A504BK16","name":"504ç™½ä»","spec":"BKNç¢è‚‰*2KG*8åŒ…","unit":"ä»¶"},{"productId":"AWE161010","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"16/20T(å–®å‡,IQ10%)*1K*10åŒ…","unit":"ä»¶"},{"productId":"AWE161012","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"16/20T(å–®å‡,IQ15%)*1K*15åŒ…","unit":"ä»¶"},{"productId":"AWE211010","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"21/25T(å–®å‡,IQ10%)*1K*10åŒ…","unit":"ä»¶"},{"productId":"AWE211012_1","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"21/25T(å–®å‡,IQ20%)*1K*12åŒ…","unit":"ä»¶"},{"productId":"AWE261012_1","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"26/30T(å–®å‡,IQ20%)*1K*12åŒ…","unit":"ä»¶"},{"productId":"AWE311012_1","name":"ç”Ÿç•™å°¾è¦(é–‹èƒŒ)PTO","spec":"31/35T(å–®å‡,IQ20%)*1K*12åŒ…","unit":"ä»¶"},{"productId":"AWE340012","name":"ç”Ÿç•™å°¾è¦(ä¸é–‹èƒŒ)","spec":"30/40(å–®å‡,IQ20%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"AWE450010_1","name":"ç”Ÿç•™å°¾è¦(ä¸é–‹èƒŒ)","spec":"40/50(å–®å‡,IQ15%)*1.15KG*10åŒ…","unit":"ä»¶"},{"productId":"AWE450010_3","name":"ç”Ÿç•™å°¾è¦(ä¸é–‹èƒŒ)","spec":"40/50(å–®å‡,IQ20%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"BC16118T","name":"ç†Ÿç™½è¦","spec":"16/20*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC21118T","name":"ç†Ÿç™½è¦","spec":"21/25*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC34118T","name":"ç†Ÿç™½è¦","spec":"30/40*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC45118T","name":"ç†Ÿç™½è¦","spec":"40/50*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC56118T","name":"ç†Ÿç™½è¦","spec":"50/60*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC67118T","name":"ç†Ÿç™½è¦","spec":"60/70*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC78118T","name":"ç†Ÿç™½è¦","spec":"70/80*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BC91118T","name":"ç†Ÿç™½è¦","spec":"90/110*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU16118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"16/20*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU21118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"21/25*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU34118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"30/40*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU45118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"40/50*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU56118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"50/60*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU67118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"60/70*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU78118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"70/80*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BCU91118T","name":"ç†Ÿç™½è¦(æœ‰è…¸æ³¥)","spec":"90/110*1.1KG*8ç›’*å‚³é®®","unit":"ä»¶"},{"productId":"BMA101008_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"8/12(æœ‰åµ,IQ10%)*700G*10ç›’","unit":"ä»¶"},{"productId":"BMA21100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(ç„¡åµ,IQ20%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMA26100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(ç„¡åµ,IQ20%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMA31100812_2","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(ç„¡åµ,IQ15%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMA31100812_3","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(ç„¡åµ,IQ20%)*650G*12ç›’","unit":"ä»¶"},{"productId":"BMC21100612_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(ç„¡åµ,IQ20%)*600G*12ç›’","unit":"ä»¶"},{"productId":"BMC26100612_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(ç„¡åµ,IQ20%)*600G*12ç›’","unit":"ä»¶"},{"productId":"BMC31100612_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(ç„¡åµ,IQ20%)*600G*12ç›’","unit":"ä»¶"},{"productId":"BMW14100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"13/15(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW21100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW21100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"21/25(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW26100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW26100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"26/30(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW31100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW31100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"31/40(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW41100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"41/50(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW41100812_1","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"41/50(æœ‰åµ,IQ15%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW51100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"51/60(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW61100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"61/70(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BMW71100812","name":"é‡‘é‘½è¦(è¶Šå—)","spec":"71/90(æœ‰åµ,IQ10%)*700G*12ç›’","unit":"ä»¶"},{"productId":"BS21110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"21/25*10KG(IQ)","unit":"ä»¶"},{"productId":"BS26110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"26/30*10KG(IQ)","unit":"ä»¶"},{"productId":"BS31110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"31/35*10KG(IQ)","unit":"ä»¶"},{"productId":"BS36110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"36/40*10KG(IQ)","unit":"ä»¶"},{"productId":"BS41110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"41/50*10KG(IQ)","unit":"ä»¶"},{"productId":"BS51110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"51/60*10KG(IQ)","unit":"ä»¶"},{"productId":"BS61110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"61/70*10KG(IQ)","unit":"ä»¶"},{"productId":"BS71110","name":"ç”Ÿç™½è¦(IQ)åŸæ–™","spec":"71/90*10KG(IQ)","unit":"ä»¶"},{"productId":"C14DG1008","name":"è‰è¦-é ‚ç´š","spec":"14(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C18DG1008","name":"è‰è¦-é ‚ç´š","spec":"18(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C22DG1008","name":"è‰è¦-é ‚ç´š","spec":"22(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C27DG1008","name":"è‰è¦-é ‚ç´š","spec":"27(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C32DG1008","name":"è‰è¦-é ‚ç´š","spec":"32(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"C37DG1008","name":"è‰è¦-é ‚ç´š","spec":"37(DG)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"CBI05FI06","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"500G*6åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CBI05FI12","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"500G*12åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CBI05SA12","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"500G*12åŒ…(æ²™æ‹‰)","unit":"ä»¶"},{"productId":"CBI27FI10","name":"èŸ¹å‘³æ£’(æ¾è‘‰)","spec":"270G*10åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CBK05CH12","name":"èŸ¹å‘³æ£’(éŸ“åœ‹)","spec":"500G*12åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"CF05120808","name":"ç†Ÿé³³å°¾è¦ä»","spec":"50/70*800G*8åŒ…","unit":"ä»¶"},{"productId":"CF07120806","name":"ç†Ÿé³³å°¾è¦ä»","spec":"70/90*800G*6åŒ…","unit":"ä»¶"},{"productId":"CF07120808","name":"ç†Ÿé³³å°¾è¦ä»","spec":"70/90*800G*8åŒ…","unit":"ä»¶"},{"productId":"EL8001206","name":"å‰æ®¼é³³èº(å»è†)","spec":"800G*6åŒ…","unit":"ä»¶"},{"productId":"EM04500310","name":"ä¸­æ²(æ°´ç…®)","spec":"4/6(å»ç›®)450G*10åŒ…","unit":"ä»¶"},{"productId":"EM04550310","name":"ä¸­æ²(æ°´ç…®)","spec":"4/6(ç•™ç›®)550G*10åŒ…","unit":"ä»¶"},{"productId":"EM06450310","name":"ä¸­æ²(æ°´ç…®)","spec":"6/8(å»ç›®)450G*10åŒ…","unit":"ä»¶"},{"productId":"EM08450306","name":"ä¸­æ²(æ°´ç…®)","spec":"8/10(å»ç›®)450G*6åŒ…","unit":"ä»¶"},{"productId":"EP04100010","name":"è»Ÿçµ²","spec":"4/6*1KG*10åŒ…","unit":"ä»¶"},{"productId":"EP06100010","name":"è»Ÿçµ²","spec":"6/8*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FC0010","name":"é­·é­šè†˜","spec":"*10KG","unit":"ä»¶"},{"productId":"FCP101010","name":"é­·é­šæ¸…è‚‰(åŒ…)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FCP201010","name":"é­·é­šæ¸…è‚‰(åŒ…)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FCS102010","name":"é­·é­šæ¸…è‚‰(æ•£)","spec":"10/20*20KG","unit":"ä»¶"},{"productId":"FCS201810","name":"é­·é­šæ¸…è‚‰(æ•£)","spec":"20/40*18KG","unit":"ä»¶"},{"productId":"FEG101010","name":"é­·é­šè€³(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FEG201010","name":"é­·é­šè€³(åˆ»èŠ±)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FH0020","name":"é­·é­šé ­","spec":"*20KG","unit":"ä»¶"},{"productId":"FH0508","name":"é­·é­šé ­","spec":"500G*8åŒ…","unit":"ä»¶"},{"productId":"FM101010","name":"ç†Ÿé­·é­šè‚‰(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FM201010","name":"ç†Ÿé­·é­šè‚‰(åˆ»èŠ±)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FR061010","name":"é­·é­šåœˆ(åˆ»èŠ±)","spec":"6UP*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FR101010","name":"é­·é­šåœˆ(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FR201010","name":"é­·é­šåœˆ(åˆ»èŠ±)","spec":"20/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FT0320","name":"é­·é­šé¬š","spec":"*20KG","unit":"ä»¶"},{"productId":"FT031010","name":"é­·é­šé¬š","spec":"300G*10åŒ…","unit":"ä»¶"},{"productId":"FT0420","name":"é­·é­šé¬š","spec":"*20KG(å°åº¦)","unit":"ä»¶"},{"productId":"FT1010","name":"é­·é­šé¬š","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"FT101010","name":"é­·é­šé¬š(åˆ»èŠ±)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"FTC051010","name":"é­·é­šé¬š(åˆ»èŠ±åˆ‡æ®µ)","spec":"500G*10åŒ…(ç‰›)","unit":"ä»¶"},{"productId":"FW0320","name":"é­·é­šç¿…","spec":"*20KG(åˆ»èŠ±)","unit":"ä»¶"},{"productId":"FW1010","name":"é­·é­šç¿…","spec":"1KG*10åŒ…(åˆ»èŠ±)","unit":"ä»¶"},{"productId":"GJ61100012","name":"è´è¶è¦","spec":"61/70(IQ10%)*1KG*12åŒ…(éŸ“å¼)","unit":"ä»¶"},{"productId":"GLB1010","name":"è´è¶è¦","spec":"*1KG*10åŒ…(éŸ“å¼)","unit":"ä»¶"},{"productId":"H9091008","name":"è‰è¦(SG)","spec":"90/110*1KG*8åŒ…","unit":"ä»¶"},{"productId":"H9101008","name":"è‰è¦(SG)","spec":"100/120*1KG*8åŒ…","unit":"ä»¶"},{"productId":"H9111008","name":"è‰è¦(SG)","spec":"110/130*1KG*8åŒ…","unit":"ä»¶"},{"productId":"HCG1010","name":"æ¯”ç›®é­šé°­é‚Šè‚‰(ç…®)","spec":"*1KG*10åŒ…(æ ¼é™µè˜­)","unit":"ä»¶"},{"productId":"JC04100010","name":"(å†°å·)é­·é­š","spec":"4/6*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC06100010","name":"(å†°å·)é­·é­š","spec":"6/8*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC08100010","name":"(å†°å·)é­·é­š","spec":"8/10*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC10100010","name":"(å†°å·)é­·é­š","spec":"10/15*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JC15100010","name":"(å†°å·)é­·é­š","spec":"15/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"JF04100010","name":"é­·é­š4/6","spec":"4/6*1KG*10åŒ…(æ—¥)","unit":"ä»¶"},{"productId":"JGFH020304T","name":"äººè”˜çƒéª¨é›","spec":"2~3KG/éš»*4åŒ…*å‚³é®®","unit":"ä»¶"},{"productId":"JQ04027010","name":"å°å·","spec":"4/6*270G*10åŒ…","unit":"ä»¶"},{"productId":"JQ04030010","name":"å°å·","spec":"4/6*300G*10åŒ…","unit":"ä»¶"},{"productId":"JQ06027010","name":"å°å·","spec":"6/8*270G*10åŒ…","unit":"ä»¶"},{"productId":"JQ06030010","name":"å°å·","spec":"6/8*300G*10åŒ…","unit":"ä»¶"},{"productId":"JQ08027010","name":"å°å·","spec":"8/12*270G*10åŒ…","unit":"ä»¶"},{"productId":"JQ08030010","name":"å°å·","spec":"8/12*300G*10åŒ…","unit":"ä»¶"},{"productId":"JQF08030010","name":"å°å·(åŒ…)","spec":"8/12*300G*10åŒ…","unit":"ä»¶"},{"productId":"K06500320","name":"èšµè‚‰","spec":"6/9*500G*20åŒ…","unit":"ä»¶"},{"productId":"K69150010","name":"ç‰¡è £è‚‰","spec":"6/9*1.5KG*10åŒ…","unit":"ä»¶"},{"productId":"M9L150008","name":"æ·¡èœ(åŠæ®¼)","spec":"9L(å¤§)*1.5KG*8åŒ…","unit":"ä»¶"},{"productId":"M9L200010","name":"æ·¡èœ(åŠæ®¼)","spec":"9L(å¤§)*2KG*10åŒ…","unit":"ä»¶"},{"productId":"ML150008","name":"æ·¡èœ(åŠæ®¼)","spec":"L(ä¸­)*1.5KG*8åŒ…","unit":"ä»¶"},{"productId":"ML200010","name":"æ·¡èœ(åŠæ®¼)","spec":"L(ä¸­)*2KG*10åŒ…","unit":"ä»¶"},{"productId":"MM200010","name":"æ·¡èœ(åŠæ®¼)","spec":"M(å°)*2KG*10åŒ…","unit":"ä»¶"},{"productId":"MN100010","name":"æ·¡èœè‚‰","spec":"100/200*1KG*10åŒ…","unit":"ä»¶"},{"productId":"MN200010","name":"æ·¡èœè‚‰","spec":"200/300*1KG*10åŒ…","unit":"ä»¶"},{"productId":"MSFL100010","name":"ç‡»é®­é­š(é•·ç‰‡)","spec":"1KG*10åŒ…(æ³•åœ‹æ´›æ–¯)","unit":"ä»¶"},{"productId":"MSFL050010_1","name":"ç‡»é®­é­š(é•·ç‰‡)","spec":"500G*10åŒ…(æ³•åœ‹æ´›æ–¯)","unit":"ä»¶"},{"productId":"MSFL050010_2","name":"ç‡»é®­é­š(é•·ç‰‡)","spec":"500G*10åŒ…(æ³•åœ‹é‡ç”Ÿ)","unit":"ä»¶"},{"productId":"MSS050005","name":"ç‡»é®­é­š(ç‰‡)","spec":"500G*5åŒ…(è˜‡æ ¼è˜­)","unit":"ä»¶"},{"productId":"MSS050010","name":"ç‡»é®­é­š(ç‰‡)","spec":"500G*10åŒ…(è˜‡æ ¼è˜­)","unit":"ä»¶"},{"productId":"MST100010","name":"ç‡»é®­é­š(ç¢)","spec":"1KG*10åŒ…(ç¾)","unit":"ä»¶"},{"productId":"N91090010_1","name":"ç”Ÿç™½è¦(åŸæ–™Block)","spec":"90/110*10KG(BLK)","unit":"ä»¶"},{"productId":"N91110","name":"ç”Ÿç™½è¦(åŸæ–™Block)","spec":"90/110*10KG(BLK)","unit":"ä»¶"},{"productId":"OA0318","name":"èµ¤å˜´è›¤(çœŸç©º)","spec":"300G*18åŒ…","unit":"ä»¶"},{"productId":"OA0510","name":"èµ¤å˜´è›¤(çœŸç©º)","spec":"500G*10åŒ…","unit":"ä»¶"},{"productId":"OB0320","name":"ç™½è›¤(çœŸç©º)","spec":"300G*20åŒ…","unit":"ä»¶"},{"productId":"OCA1010","name":"è›¤èœŠè‚‰(ç”Ÿ)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"OCC1010","name":"è›¤èœŠè‚‰(ç†Ÿ)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"OCD60201010","name":"å°è›¤èœŠ(çœŸç©º,ç†Ÿ,å»æ²™)","spec":"60/100*1KG*10åŒ…","unit":"ä»¶"},{"productId":"OW0510","name":"å¤§è›¤(çœŸç©º)","spec":"500G*10åŒ…","unit":"ä»¶"},{"productId":"OW0610","name":"å¤§è›¤(çœŸç©º)","spec":"600G*10åŒ…","unit":"ä»¶"},{"productId":"P01FI100110","name":"é­šæ¿(æ¾è‘‰)","spec":"10ç‰‡*1KG*10åŒ…(ç«é‹)","unit":"ä»¶"},{"productId":"P02SA100112","name":"é­šæ¿(æ¾è‘‰)","spec":"20ç‰‡*1KG*12æ¢(æ²™æ‹‰)","unit":"ä»¶"},{"productId":"P03GR100110","name":"é­šæ¿(æ¾è‘‰)","spec":"36ç‰‡*1KG*10åŒ…(ç‡’çƒ¤)","unit":"ä»¶"},{"productId":"R21W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"21/25(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R21W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"21/25(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R26W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"26/30(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R26W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"26/30(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R31W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"31/35(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R31W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"31/40(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R36W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"36/40(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R36W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"36/40(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R41W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"41/50(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R41W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"41/50(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R51W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"51/60(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R51W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"51/60(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R61W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"61/70(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R61W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"61/70(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R71W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"71/90(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R71W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"71/90(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R91W10B12","name":"ç”Ÿç™½è¦(å¤§)","spec":"90/110(IQ10%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"R91W10B12_1","name":"ç”Ÿç™½è¦(å¤§)","spec":"90/110(IQ15%)*1KG*12åŒ…","unit":"ä»¶"},{"productId":"S08M100010","name":"å¹²è²(æ—¥)","spec":"S(8M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S10M100010","name":"å¹²è²(æ—¥)","spec":"M(10M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S20M100010","name":"å¹²è²(æ—¥)","spec":"L(20M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S30M100010","name":"å¹²è²(æ—¥)","spec":"2L(30M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S40M100010","name":"å¹²è²(æ—¥)","spec":"3L(40M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S50M100010","name":"å¹²è²(æ—¥)","spec":"4L(50M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"S60M100010","name":"å¹²è²(æ—¥)","spec":"5L(60M)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SA02100010","name":"å¹²è²(æ¾³æ´²)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SA04100010","name":"å¹²è²(æ¾³æ´²)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SA06100010","name":"å¹²è²(æ¾³æ´²)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SAB1008","name":"ç†Ÿé®‘é­š(æ¾³æ´²)","spec":"12P*1KG*8åŒ…(å¸¶æ®¼)","unit":"ä»¶"},{"productId":"SC02100010","name":"å¹²è²(åŠ æ‹¿å¤§)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SC04100010","name":"å¹²è²(åŠ æ‹¿å¤§)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SC06100010","name":"å¹²è²(åŠ æ‹¿å¤§)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SCA06100010","name":"å¹²è²(åŠ æ‹¿å¤§é‡ç”Ÿ)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SCM100010","name":"é®­é­šä¸","spec":"1KG*10åŒ…(å°)","unit":"ä»¶"},{"productId":"SCM500020","name":"é®­é­šè…¹é°­","spec":"5KG*20KG","unit":"ä»¶"},{"productId":"SCS100010","name":"é®­é­šä¸(å¤§)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"SD02100010","name":"å¹²è²(ç¥•é­¯)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SD04100010","name":"å¹²è²(ç¥•é­¯)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SD06100010","name":"å¹²è²(ç¥•é­¯)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SFN015006","name":"åŠæ®¼æ‰‡è²","spec":"1#*500G*6åŒ…(ç´)","unit":"ä»¶"},{"productId":"SFN030006","name":"åŠæ®¼æ‰‡è²","spec":"3#*300G*6åŒ…(ç´)","unit":"ä»¶"},{"productId":"SGE0810","name":"ç¦æ°£é­šåµ(åŒ…)","spec":"800G*10åŒ…(å†°)","unit":"ä»¶"},{"productId":"SJ02100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"21/25*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJ03100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"26/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJ04100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"36/40*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJ06100010","name":"å¹²è²(æ—¥ç”Ÿé£Ÿ)","spec":"51/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJB02100010","name":"å¹²è²(æ—¥ç¢)","spec":"Sç¢*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJB04100010","name":"å¹²è²(æ—¥ç¢)","spec":"Mç¢*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SJB04100810","name":"å¹²è²(æ—¥ç¢)","spec":"Mç¢(100ç²’)800G*10åŒ…","unit":"ä»¶"},{"productId":"SN02100010","name":"å¹²è²(è¶Šå—)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SN04100010","name":"å¹²è²(è¶Šå—)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SN06100010","name":"å¹²è²(è¶Šå—)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SRTC1010","name":"é®­é­šç¢è‚‰","spec":"1KG*10åŒ…*å‚³é®®","unit":"ä»¶"},{"productId":"SS02100010","name":"å¹²è²(ç¾)","spec":"U-10*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS04100010","name":"å¹²è²(ç¾)","spec":"40/60*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS06100010","name":"å¹²è²(ç¾)","spec":"60/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS10100010","name":"å¹²è²(ç¾)","spec":"10/20*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SS20100010","name":"å¹²è²(ç¾)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SSF100010","name":"å¹²è²(å¢¨)","spec":"100/150*1KG*10åŒ…","unit":"ä»¶"},{"productId":"ST05100010","name":"å¹²è²(å°)","spec":"50/80*1KG*10åŒ…","unit":"ä»¶"},{"productId":"STCC1010","name":"é®­é­šè‚šæ¢*å‚³é®®","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"SU02100010","name":"å¹²è²(ç¾è²)","spec":"20/30*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SU04100010","name":"å¹²è²(ç¾è²)","spec":"40/50*1KG*10åŒ…","unit":"ä»¶"},{"productId":"SU06100010","name":"å¹²è²(ç¾è²)","spec":"50/70*1KG*10åŒ…","unit":"ä»¶"},{"productId":"T05030008","name":"é¯›é­šç‰‡(å°)","spec":"5/7oz*300G*8åŒ…","unit":"ä»¶"},{"productId":"T07030008","name":"é¯›é­šç‰‡(å°)","spec":"7/9oz*300G*8åŒ…","unit":"ä»¶"},{"productId":"TF0018","name":"è’²ç‡’é¯›(ç‰‡)","spec":"140G*18ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TF0112","name":"è’²ç‡’é¯›(ç‰‡)","spec":"1KG*12ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TO220018T","name":"é¯–é­šä¸€å¤œå¹²","spec":"220G*18ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TO260018T","name":"é¯–é­šä¸€å¤œå¹²","spec":"260G*18ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TP100008","name":"è–„é¹½åœŸé­ é­š","spec":"285G*8ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TP100010","name":"è–„é¹½åœŸé­ é­š","spec":"285G*10ç‰‡*å‚³é®®","unit":"ä»¶"},{"productId":"TT05100010","name":"ç« é­šè…³(ç†Ÿ)","spec":"T5*1KG*10åŒ…","unit":"ä»¶"},{"productId":"U11000010","name":"å‰æ®¼è¦ä»(ä»£å·¥)","spec":"1KG*10åŒ…(IQ)","unit":"ä»¶"},{"productId":"UA3611008","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ10%)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"UA41090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ10%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UA4111008","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ10%)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"UA5111008","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ10%)*1KG*8åŒ…","unit":"ä»¶"},{"productId":"UA5111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UA6111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UA7111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UA9111010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ10%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UB21040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"21/25(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB26040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"26/30(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB31040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"31/40(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB36040010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*400G*10åŒ…","unit":"ä»¶"},{"productId":"UB36040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB41040010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*400G*10åŒ…","unit":"ä»¶"},{"productId":"UB41040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB51040010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*400G*10åŒ…","unit":"ä»¶"},{"productId":"UB51040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB61040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB71040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UB91040012","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*400G*12åŒ…","unit":"ä»¶"},{"productId":"UC31050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"31/40(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC36050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC41050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC51050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC61050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC71050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UC91050010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*500G*10åŒ…","unit":"ä»¶"},{"productId":"UD36100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"36/40(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD41100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD51100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD61100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD71100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UD91100010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*1KG*10åŒ…","unit":"ä»¶"},{"productId":"UF21100010","name":"ç™½è¦ä»(å»è…¸)","spec":"21/25(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF26100010","name":"ç™½è¦ä»(å»è…¸)","spec":"26/30(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF31100010","name":"ç™½è¦ä»(å»è…¸)","spec":"31/40(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF41100010","name":"ç™½è¦ä»(å»è…¸)","spec":"41/50(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF51100010","name":"ç™½è¦ä»(å»è…¸)","spec":"51/60(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF61100010","name":"ç™½è¦ä»(å»è…¸)","spec":"61/70(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UF71100010","name":"ç™½è¦ä»(å»è…¸)","spec":"71/90(IQ15%)*1KG*10åŒ…(ä»£å·¥)","unit":"ä»¶"},{"productId":"UK41045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK51045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK61045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK71045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UK91045010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*450G*10åŒ…","unit":"ä»¶"},{"productId":"UL41090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"41/50(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL51090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"51/60(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL61090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"61/70(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL71090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"71/90(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UL91090010","name":"ç„¡è†¨ç™¼è¦ä»PD(ä»£å·¥)","spec":"91/110(IQ20%)*900G*10åŒ…","unit":"ä»¶"},{"productId":"UM36042020","name":"è¦ä»PD(å°è£)","spec":"36/40(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM41042020","name":"è¦ä»PD(å°è£)","spec":"41/50(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM51042020","name":"è¦ä»PD(å°è£)","spec":"51/60(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM61042020","name":"è¦ä»PD(å°è£)","spec":"61/70(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM71042020","name":"è¦ä»PD(å°è£)","spec":"71/90(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UM91042020","name":"è¦ä»PD(å°è£)","spec":"91/110(IQ20%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN36042020","name":"è¦ä»PD(å°è£)","spec":"36/40(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN41042020","name":"è¦ä»PD(å°è£)","spec":"41/50(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN51042020","name":"è¦ä»PD(å°è£)","spec":"51/60(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN61042020","name":"è¦ä»PD(å°è£)","spec":"61/70(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN71042020","name":"è¦ä»PD(å°è£)","spec":"71/90(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"UN91042020","name":"è¦ä»PD(å°è£)","spec":"91/110(IQ10%)*420G*20åŒ…","unit":"ä»¶"},{"productId":"W0206","name":"æ›¼æ³¢é­š(çš®)","spec":"200G*6åŒ…","unit":"ä»¶"},{"productId":"W0510","name":"æ›¼æ³¢é­š(çš®)","spec":"500G*10åŒ…","unit":"ä»¶"},{"productId":"WD41100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"41/50(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD41100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"41/50(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD51100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"51/60(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD51100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"51/60(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD61100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"61/70(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD61100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"61/70(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD71100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"71/90(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD71100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"71/90(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"WD91100015","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"91/110(IQ15%)*1KG*15åŒ…","unit":"ä»¶"},{"productId":"WD91100020","name":"ç”Ÿç™½è¦ä»PD(DV)","spec":"91/110(IQ15%)*1KG*20åŒ…","unit":"ä»¶"},{"productId":"X100010","name":"æµ·è†½(å†·)","spec":"100G*10ç›’(æ—¥)","unit":"ä»¶"},{"productId":"Y01050012","name":"èŸ¹ç®¡è‚‰","spec":"ç‰¹A(230G)*12ç“¶","unit":"ä»¶"},{"productId":"Y02050012","name":"èŸ¹ç®¡è‚‰","spec":"A(200G)*12ç“¶","unit":"ä»¶"},{"productId":"Y03050012","name":"èŸ¹ç®¡è‚‰","spec":"B(170G)*12ç“¶","unit":"ä»¶"},{"productId":"YT100006","name":"é›ªèŸ¹è…³(ç†Ÿ)","spec":"1KG*6åŒ…","unit":"ä»¶"},{"productId":"YT100010","name":"é›ªèŸ¹è…³(ç†Ÿ)","spec":"1KG*10åŒ…","unit":"ä»¶"},{"productId":"Z021004","name":"é¾è¦(æ´»å‡)","spec":"200/250*10KG*4ç›’","unit":"ä»¶"},{"productId":"Z023510","name":"é¾è¦(ç”Ÿ)","spec":"200/300*3.5KG*10ç›’","unit":"ä»¶"},{"productId":"Z043510","name":"é¾è¦(ç”Ÿ)","spec":"300/400*3.5KG*10ç›’","unit":"ä»¶"},{"productId":"Z101","name":"101","spec":"","unit":"åŒ…"}];

            const handleProductExcelImport = async (evt) => {
                const file = evt.target.files[0];
                if (!file) return;
                evt.target.value = '';
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '', header: 1 });
                    
                    // æ‰¾åˆ°æ¨™é¡Œåˆ—ï¼ˆå“è™Ÿã€å“åã€è¦æ ¼ï¼‰
                    let headerRowIndex = -1;
                    for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (row && row.some(cell => cell === 'å“è™Ÿ' || cell === 'å“å')) {
                            headerRowIndex = i;
                            break;
                        }
                    }
                    
                    if (headerRowIndex === -1) {
                        alert('æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—ï¼ˆå“è™Ÿã€å“åã€è¦æ ¼ï¼‰');
                        return;
                    }
                    
                    const headers = jsonData[headerRowIndex];
                    const colIndex = {
                        productId: headers.findIndex(h => h === 'å“è™Ÿ'),
                        name: headers.findIndex(h => h === 'å“å'),
                        spec: headers.findIndex(h => h === 'è¦æ ¼'),
                        unit: headers.findIndex(h => h === 'å–®ä½')
                    };
                    
                    // è§£æè³‡æ–™åˆ—
                    const parsedProducts = {};
                    for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const productId = row[colIndex.productId];
                        const name = row[colIndex.name];
                        const spec = row[colIndex.spec];
                        const unit = colIndex.unit >= 0 ? row[colIndex.unit] : '';
                        
                        // è·³éç©ºç™½åˆ—æˆ–å°è¨ˆåˆ—
                        if (!productId || !name || productId === 'å“è™Ÿ') continue;
                        
                        // ä½¿ç”¨å“è™Ÿ+è¦æ ¼ä½œç‚ºå”¯ä¸€éµ
                        const key = `${productId}_${spec || ''}`;
                        if (!parsedProducts[key]) {
                            parsedProducts[key] = {
                                productId: String(productId).trim(),
                                name: String(name).trim(),
                                spec: String(spec || '').trim(),
                                unit: PRODUCT_UNITS.includes(unit) ? unit : 'åŒ…',
                                defaultPrice: 0,
                                defaultSupplier: '',
                                isActive: true
                            };
                        }
                    }
                    
                    const productList = Object.values(parsedProducts);
                    if (productList.length === 0) {
                        alert(TEXT.IMPORT_NO_DATA);
                        return;
                    }
                    
                    setProductImportData(productList);
                    setShowProductImportModal(true);
                    
                } catch (error) {
                    console.error('Excel è§£æéŒ¯èª¤:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                }
            };

            const handleConfirmProductImport = async () => {
                if (productImportData.length === 0) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                setImportProcessing(true);
                setImportProgress({ current: 0, total: productImportData.length });
                
                let successCount = 0;
                let errorCount = 0;
                
                try {
                    // æ‰¹æ¬¡å¯«å…¥ï¼Œæ¯æ‰¹ 500 ç­†
                    const batchSize = 500;
                    for (let i = 0; i < productImportData.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = productImportData.slice(i, i + batchSize);
                        
                        for (const item of chunk) {
                            // ä½¿ç”¨å“è™Ÿ+è¦æ ¼ä½œç‚ºæ–‡ä»¶ ID
                            const docId = `${item.productId}_${item.spec}`.replace(/[\/\\*?\"<>|]/g, '_');
                            const docRef = db.collection('products').doc(docId);
                            batch.set(docRef, {
                                ...item,
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                        }
                        
                        await batch.commit();
                        successCount += chunk.length;
                        setImportProgress({ current: Math.min(i + batchSize, productImportData.length), total: productImportData.length });
                    }
                    
                    setShowProductImportModal(false);
                    setProductImportData([]);
                    showToast(`${TEXT.IMPORT_SUCCESS}ï¼š${successCount} ç­†ç”¢å“`);
                    
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                } finally {
                    setImportProcessing(false);
                }
            };

            const handleSaveProduct = async () => {
                if (!editingProduct) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                if (!editingProduct.productId || !editingProduct.name) {
                    alert('è«‹å¡«å¯«å“è™Ÿå’Œå“å');
                    return;
                }
                
                try {
                    const docId = `${editingProduct.productId}_${editingProduct.spec || ''}`.replace(/[\/\\*?\"<>|]/g, '_');
                    await db.collection('products').doc(docId).set({
                        ...editingProduct,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    setShowProductModal(false);
                    setEditingProduct(null);
                    showToast('å„²å­˜æˆåŠŸ');
                } catch (error) {
                    alert(TEXT.SAVE_FAILED + ': ' + error.message);
                }
            };

            const handleDeleteProduct = async (product) => {
                if (!canDelete()) return alert(TEXT.PERMISSION_DENIED);
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${product.name} (${product.spec}) å—ï¼Ÿ`)) return;
                
                try {
                    const docId = `${product.productId}_${product.spec || ''}`.replace(/[\/\\*?\"<>|]/g, '_');
                    await db.collection('products').doc(docId).delete();
                    showToast('å·²åˆªé™¤');
                } catch (error) {
                    alert(TEXT.SAVE_FAILED + ': ' + error.message);
                }
            };

            const filteredProducts = useMemo(() => {
                if (!productSearchTerm.trim()) return products;
                const term = productSearchTerm.toLowerCase();
                return products.filter(p => 
                    (p.productId || '').toLowerCase().includes(term) ||
                    (p.name || '').toLowerCase().includes(term) ||
                    (p.spec || '').toLowerCase().includes(term) ||
                    (p.defaultSupplier || '').toLowerCase().includes(term)
                );
            }, [products, productSearchTerm]);

            // V76.0: ç”¢å“é¸æ“‡å™¨ç¯©é¸çµæœ
            const pickerFilteredProducts = useMemo(() => {
                if (!productPickerSearch.trim()) return products.filter(p => p.isActive !== false).slice(0, 50);
                const term = productPickerSearch.toLowerCase();
                return products.filter(p => 
                    p.isActive !== false && (
                        (p.productId || '').toLowerCase().includes(term) ||
                        (p.name || '').toLowerCase().includes(term) ||
                        (p.spec || '').toLowerCase().includes(term)
                    )
                ).slice(0, 50);
            }, [products, productPickerSearch]);

            // V76.0: é¸æ“‡ç”¢å“å¾Œè‡ªå‹•å¸¶å…¥è¦æ ¼
            const handleSelectProduct = (pickerInfo, selectedProduct) => {
                // åˆ¤æ–·æ˜¯ AI é è¦½æ¨¡å¼é‚„æ˜¯ä¸€èˆ¬è¡¨å–®æ¨¡å¼
                if (pickerInfo && typeof pickerInfo === 'object' && pickerInfo.type === 'aiPreview') {
                    // AI é è¦½æ¨¡å¼ï¼šæ›´æ–° fieldSources.products
                    const idx = pickerInfo.index;
                    setFieldSources(prev => {
                        const newProducts = [...(prev.products?.value || [])];
                        newProducts[idx] = {
                            ...newProducts[idx],
                            selectedName: selectedProduct.name + (selectedProduct.spec ? ' ' + selectedProduct.spec : ''),
                            selectedSpec: selectedProduct.spec || '',
                            originalText: newProducts[idx].originalText || newProducts[idx].name // ä¿ç•™åŸå§‹è‹±æ–‡
                        };
                        return {
                            ...prev,
                            products: { ...prev.products, value: newProducts }
                        };
                    });
                } else {
                    // ä¸€èˆ¬è¡¨å–®æ¨¡å¼
                    const idx = pickerInfo;
                    const np = [...formData.products];
                    np[idx] = {
                        ...np[idx],
                        name: selectedProduct.name || '',
                        spec: selectedProduct.spec || '',
                    };
                    setFormData(prev => ({ ...prev, products: np }));
                    
                    // æ¸…é™¤é©—è­‰éŒ¯èª¤
                    if (validationErrors.products) {
                        setValidationErrors(prev => ({...prev, products: false}));
                    }
                }
                
                setActiveProductPicker(null);
                setProductPickerSearch('');
            };

            // V69.0 Update: Line message content
            const handleShareToLine = (s) => {
                const isDom = isDomestic(s);
                let text = `${isDom ? TEXT.LINE_NOTIFY_DOMESTIC : TEXT.LINE_NOTIFY_FOREIGN}\n`;
                text += `æ—¥æœŸï¼š${s.arrivalDate}\n`;
                text += `æ«ƒè™Ÿï¼š${s.containerNumber}\n`;
                text += `å» å•†ï¼š${s.supplier}\n`;
                // V69.0 Additions:
                text += `æ‹†æ«ƒæ—¥ï¼š${s.devanningDate || 'æœªå®š'}\n`;
                text += `æ‹†æ«ƒåœ°ï¼š${s.devanningLocation || 'æœªå®š'}\n\n`;
                
                (s.products || []).forEach((p, i) => {
                    // V69.0 Additions: Batch Number
                    text += `${i+1}. ${p.name} ${p.spec ? p.spec : ''} (æ‰¹:${p.batchNumber||'ç„¡'}) - ${p.quantity}ä»¶\n`; 
                });
                window.open("https://line.me/R/msg/text/?" + encodeURIComponent(text), '_blank');
            };

            const handleAttachmentClick = (e, item) => {
                e.stopPropagation();
                const files = item.attachments || [];
                if (files.length === 0 && item.docUrl) { window.open(item.docUrl, '_blank'); return; }
                if (files.length === 1) { window.open(files[0].url, '_blank'); return; }
                if (files.length > 1) { setFileList(files); setShowFileModal(true); }
            };

            const handleEdit = (item) => {
                if(!canEdit() && !canUpload()) return alert(TEXT.PERMISSION_DENIED); 
                let atts = item.attachments || [];
                if (item.docUrl && atts.length === 0) { atts.push({ name: item.docName || TEXT.LABEL_ATTACHMENTS, url: item.docUrl, path: item.docRefPath }); }
                setFormData({ 
                    ...initialFormState, ...item, attachments: atts,
                    currency: item.currency || (item.customsBroker === DOMESTIC_FLAG ? 'TWD' : 'USD'),
                    paymentTerm: item.paymentTerm || (item.customsBroker === DOMESTIC_FLAG ? PAYMENT_TERMS_DOMESTIC[0] : 'åˆ°æ¸¯å‰ä»˜æ¬¾'),
                    prepayment: item.prepayment || 0, flightFee: item.flightFee || 0, flightFeePaid: item.flightFeePaid || false,
                    customsDeclarationNo: item.customsDeclarationNo || '', importPermitNo: item.importPermitNo || '',
                    shippingCompany: item.shippingCompany || ''
                }); 
                setEditingId(item.id); setOpenSections(['basic']); setView('form'); 
            };

            const handleDuplicateShipment = (s) => { 
                if(!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                const {id, ...d} = s; const merged = { ...initialFormState, ...d };
                const np = (merged.products || []).map(p=>({...p,id:Date.now()+Math.random()})); 
                setFormData({...merged, containerNumber:'', products:np, attachments:[], isPaid: false, prepayment: 0, flightFee: 0, flightFeePaid: false}); 
                setEditingId(null); setFormStep(1); setView('form'); 
            };

            // V70.0: è¡¨å–®é©—è­‰å‡½æ•¸
            const validateForm = () => {
                const errors = {};
                const isDom = isDomestic(formData);
                
                // æ–°å¢æ™‚çš„å¿…å¡«é©—è­‰
                if (!editingId) {
                    if (!formData.containerNumber?.trim()) errors.containerNumber = true;
                    if (!formData.arrivalDate) errors.arrivalDate = true;
                    if (!formData.supplier?.trim()) errors.supplier = true;
                    
                    // ç”¢å“æ˜ç´°é©—è­‰ï¼šè‡³å°‘è¦æœ‰ä¸€å€‹ç”¢å“åç¨±
                    const hasValidProduct = (formData.products || []).some(p => p.name?.trim());
                    if (!hasValidProduct) errors.products = true;
                }
                
                return errors;
            };

            const showToast = (message) => {
                setValidationMessage(message);
                setShowValidationToast(true);
                setTimeout(() => setShowValidationToast(false), 3000);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!canEdit()) return alert(TEXT.PERMISSION_DENIED);
                
                // V70.0: åŸ·è¡Œè¡¨å–®é©—è­‰
                const errors = validateForm();
                setValidationErrors(errors);
                
                if (Object.keys(errors).length > 0) {
                    const errorMessages = [];
                    if (errors.containerNumber) errorMessages.push(TEXT.FIELD_CONTAINER);
                    if (errors.arrivalDate) errorMessages.push(TEXT.FIELD_ARRIVAL_DATE);
                    if (errors.supplier) errorMessages.push(TEXT.FIELD_SUPPLIER);
                    if (errors.products) errorMessages.push(TEXT.FIELD_PRODUCT_NAME);
                    showToast(TEXT.REQUIRED_FIELDS + errorMessages.join('ã€'));
                    return;
                }
                
                setIsSubmitting(true);
                try {
                    const d = {...formData, updatedAt: new Date().toISOString()};
                    
                    let dataToSend = d;
                    
                    if(editingId) {
                        if (userRole === 'QC') {
                            dataToSend = {
                                customsDeclarationNo: d.customsDeclarationNo,
                                importPermitNo: d.importPermitNo,
                                attachments: d.attachments,
                                docUrl: d.docUrl || '',
                                docName: d.docName || '',
                                docRefPath: d.docRefPath || '',
                                updatedAt: d.updatedAt
                            };
                        } else if (userRole === 'WAREHOUSE') {
                             dataToSend = {
                                warehouseConfirmed: d.warehouseConfirmed,
                                devanningLocation: d.devanningLocation,
                                devanningDate: d.devanningDate,
                                products: d.products, 
                                totalQuantity: d.totalQuantity,
                                totalWeight: d.totalWeight,
                                updatedAt: d.updatedAt
                             };
                        } 
                        
                        await db.collection('shipments').doc(editingId).update(dataToSend);
                    } else {
                        await db.collection('shipments').add({...d, createdAt: new Date().toISOString()});
                    }
                    setValidationErrors({});
                    setEditingId(null); setView('list');
                } catch(err){ 
                    console.error(err);
                    alert(TEXT.SAVE_FAILED + ": " + err.message); 
                } finally { 
                    setIsSubmitting(false); 
                }
            };

            // V79.0: è¨ˆç®—å» å•†åºè™Ÿï¼ˆå¹´åº¦-åºè™Ÿï¼Œå¦‚ 26-01ï¼‰
            const generateVendorSeqNo = (supplier, arrivalDate, excludeId = null) => {
                if (!supplier || !arrivalDate) return '';
                
                // å–å¹´ä»½å¾Œå…©ä½
                const year = arrivalDate.substring(2, 4); // "2026-01-05" â†’ "26"
                
                // æ‰¾å‡ºåŒå» å•†åŒå¹´åº¦çš„æ‰€æœ‰è¨˜éŒ„
                const sameVendorSameYear = shipments.filter(s => 
                    s.supplier === supplier && 
                    s.arrivalDate?.startsWith(`20${year}`) &&
                    s.id !== excludeId
                );
                
                // æ‰¾å‡ºæœ€å¤§åºè™Ÿ
                let maxSeq = 0;
                sameVendorSameYear.forEach(s => {
                    if (s.vendorSeqNo) {
                        const match = s.vendorSeqNo.match(/^\d{2}-(\d+)$/);
                        if (match) {
                            const seq = parseInt(match[1], 10);
                            if (seq > maxSeq) maxSeq = seq;
                        }
                    }
                });
                
                // ä¸‹ä¸€å€‹åºè™Ÿ
                const nextSeq = maxSeq + 1;
                return `${year}-${nextSeq.toString().padStart(2, '0')}`;
            };

            const handleInputChange = (e) => {
                const {name,value,type,checked}=e.target;
                setFormData(p => {
                    const newData = {...p, [name]: type==='checkbox'?checked:value};
                    
                    // V79.0: ç•¶å» å•†æˆ–åˆ°æ¸¯æ—¥æ”¹è®Šæ™‚ï¼Œè‡ªå‹•ç”¢ç”Ÿå» å•†åºè™Ÿ
                    if ((name === 'supplier' || name === 'arrivalDate') && !editingId) {
                        const supplier = name === 'supplier' ? value : newData.supplier;
                        const arrivalDate = name === 'arrivalDate' ? value : newData.arrivalDate;
                        if (supplier && arrivalDate) {
                            newData.vendorSeqNo = generateVendorSeqNo(supplier, arrivalDate);
                        }
                    }
                    
                    return newData;
                });
                // V70.0: æ¸…é™¤è©²æ¬„ä½çš„é©—è­‰éŒ¯èª¤
                if (validationErrors[name]) {
                    setValidationErrors(prev => ({...prev, [name]: false}));
                }
            };
            
            // V71.0: éœ€è¦é‡æ–°è¨ˆç®—é‡‘é¡çš„æ¬„ä½
            const AMOUNT_FIELDS = ['quantity', 'weight', 'unitPrice', 'pricingMode', 'boxCapacity'];
            // V71.0: éœ€è¦é‡æ–°è¨ˆç®—ç¸½å’Œçš„æ¬„ä½
            const TOTAL_FIELDS = ['quantity', 'weight'];

            const handleProductChange = (idx, f, v) => {
                const np = [...formData.products]; np[idx] = {...np[idx], [f]:v};
                const p = np[idx];

                if (f === 'spec') {
                    const match = v.match(/(\d+)\s*(?:ç›’|åŒ…|å¡Š|ç‰‡)/);
                    if (match) { p.boxCapacity = parseFloat(match[1]); }
                }

                // V71.0: åªåœ¨é‡‘é¡ç›¸é—œæ¬„ä½è®Šæ›´æ™‚æ‰é‡æ–°è¨ˆç®—
                if (AMOUNT_FIELDS.includes(f) || f === 'spec') {
                    const q = safeNum(p.quantity);
                    const b = safeNum(p.boxCapacity) || 1;
                    const w = safeNum(p.weight);
                    const u = safeNum(p.unitPrice);

                    if(p.pricingMode==='weight') { p.amount = round2(w * u); } 
                    else { p.amount = round2(q * b * u); }
                }

                // V71.0: åªåœ¨æ•¸é‡/é‡é‡æ¬„ä½è®Šæ›´æ™‚æ‰é‡æ–°è¨ˆç®—ç¸½å’Œ
                if (TOTAL_FIELDS.includes(f)) {
                    setFormData(prev => ({
                        ...prev, 
                        products: np, 
                        totalQuantity: np.reduce((s,i) => s + safeNum(i.quantity), 0), 
                        totalWeight: round2(np.reduce((s,i) => s + safeNum(i.weight), 0))
                    }));
                } else {
                    setFormData(prev => ({...prev, products: np}));
                }
                
                // V70.0: è‹¥ä¿®æ”¹å“åï¼Œæ¸…é™¤ç”¢å“é©—è­‰éŒ¯èª¤
                if (f === 'name' && v?.trim() && validationErrors.products) {
                    setValidationErrors(prev => ({...prev, products: false}));
                }
            };

            const addProductRow = (e) => {
                if(e) e.preventDefault();
                // V68.0: é è¨­ weight, boxCapacity=1
                setFormData(p => ({...p, products:[...(p.products||[]), {id:Date.now(), name:'', quantity:0, weight:0, unitPrice:0, amount:0, pricingMode:'weight', boxCapacity: 1}]}));
            };
            const duplicateProductRow = (idx) => { const p=formData.products[idx]; setFormData(prev=>({...prev, products:[...prev.products.slice(0,idx+1), {...p, id:Date.now()}, ...prev.products.slice(idx+1)]})); };
            const removeProductRow = (idx) => { const np=formData.products.filter((_,i)=>i!==idx); setFormData(prev=>({...prev, products:np})); };
            const handleFileUpload = async (evt) => {
                const files = Array.from(evt.target.files);
                if (files.length === 0) return;
                setUploading(true);
                if (!canUpload()) { alert(TEXT.PERMISSION_DENIED); setUploading(false); return; }

                try {
                    const newAttachments = [];
                    for (const file of files) {
                        const ref = storage.ref('docs/' + Date.now() + '_' + file.name);
                        await ref.put(file);
                        const url = await ref.getDownloadURL();
                        newAttachments.push({ name: file.name, url: url, path: ref.fullPath });
                    }
                    setFormData(prev => ({ ...prev, attachments: [...(prev.attachments||[]), ...newAttachments] }));
                } catch (error) { alert(TEXT.UPLOAD_FAILED + ": " + error.message); } finally { setUploading(false); evt.target.value = ''; }
            };
            const handleDeleteFile = async (index) => { 
                if(!confirm(TEXT.CONFIRM_DELETE_FILE)) return;
                if (!canUpload()) return alert(TEXT.PERMISSION_DENIED);
                const target = formData.attachments[index];
                if (target.path && storage) { try { await storage.ref(target.path).delete(); } catch (error) { console.warn(error); } }
                const newAttachments = formData.attachments.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, attachments: newAttachments }));
            };

            // Auth & DB Effects
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none', 300); }
                if (!auth) return;
                const unsub = auth.onAuthStateChanged(u => { setUser(u); if(!u) setLoading(false); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('shipments').onSnapshot(s => {
                    const cleanData = s.docs.map(d => {
                        const dat = d.data();
                        return { id:d.id, ...dat, products: Array.isArray(dat.products) ? dat.products : [] };
                    }).sort((a,b)=>b.arrivalDate>a.arrivalDate?1:-1);
                    setShipments(cleanData);
                    setLoading(false);
                });
                
                // V73.0: å®Œå…¨å¾ Firestore è®€å–è§’è‰²è¨­å®šï¼Œä¸å†ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ ADMIN_EMAILS
                db.collection('settings').doc('config').get().then(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        const email = user.email;
                        
                        // å„ªå…ˆæª¢æŸ¥ user_roles å°æ‡‰
                        if(d.user_roles && d.user_roles[email]) {
                            setUserRole(d.user_roles[email]);
                        }
                        // å…¶æ¬¡æª¢æŸ¥ admin_emails æ¸…å–®
                        else if(d.admin_emails && d.admin_emails.includes(email)) {
                            setUserRole('MANAGER');
                        }
                        // è‹¥éƒ½æ²’æœ‰è¨­å®šï¼Œä¿æŒ GUEST
                    }
                    // è‹¥ config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¿æŒ GUESTï¼ˆæ›´å®‰å…¨çš„é è¨­å€¼ï¼‰
                }).catch(err => {
                    console.warn('ç„¡æ³•è®€å–è¨­å®š:', err);
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¿æŒ GUEST è§’è‰²
                });
                
                return () => unsub();
            }, [user]);

            // V77.0: ç”¢å“ä¸»æª”ç›£è½ + è‡ªå‹•åˆå§‹åŒ–
            useEffect(() => {
                if (!user || !db) return;
                
                // V77.0: é¦–æ¬¡è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–
                const initializeIfEmpty = async () => {
                    try {
                        const snapshot = await db.collection('products').limit(1).get();
                        if (snapshot.empty && INITIAL_PRODUCTS_DATA.length > 0) {
                            console.log('ç”¢å“ä¸»æª”ç‚ºç©ºï¼Œé–‹å§‹åˆå§‹åŒ– ' + INITIAL_PRODUCTS_DATA.length + ' ç­†ç”¢å“...');
                            const batchSize = 500;
                            for (let i = 0; i < INITIAL_PRODUCTS_DATA.length; i += batchSize) {
                                const batch = db.batch();
                                const chunk = INITIAL_PRODUCTS_DATA.slice(i, i + batchSize);
                                for (const p of chunk) {
                                    const docId = (p.productId + '_' + (p.spec || '')).replace(/[\/\\*?"<>|]/g, '_');
                                    batch.set(db.collection('products').doc(docId), { 
                                        ...p, 
                                        defaultPrice: 0,
                                        defaultSupplier: '',
                                        isActive: true,
                                        updatedAt: new Date().toISOString() 
                                    });
                                }
                                await batch.commit();
                            }
                            console.log('ç”¢å“ä¸»æª”åˆå§‹åŒ–å®Œæˆï¼');
                        }
                    } catch (e) { 
                        console.warn('ç”¢å“ä¸»æª”åˆå§‹åŒ–æª¢æŸ¥å¤±æ•—:', e); 
                    }
                };
                
                initializeIfEmpty();
                
                const unsub = db.collection('products').orderBy('name').onSnapshot(s => {
                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    setProducts(data);
                }, err => {
                    console.warn('ç”¢å“ä¸»æª”è¼‰å…¥å¤±æ•—:', err);
                });
                return () => unsub();
            }, [user]);

            // Permissions
            const canManage = () => userRole === 'MANAGER';
            const canEdit = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole);
            const canCreate = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canDelete = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canUpload = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole); 
            const canSeePrice = () => ['MANAGER','PURCHASING','ACCOUNTING'].includes(userRole);
            const canEditFlightFee = () => userRole === 'MANAGER' || userRole === 'ACCOUNTING';
            const canEditDomesticFull = () => ['MANAGER','PURCHASING'].includes(userRole);
            const canEditForeignFinance = () => ['MANAGER', 'ACCOUNTING'].includes(userRole);
            const canEditWarehouseFields = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole);
            const canEditQCFields = () => ['MANAGER', 'QC'].includes(userRole);

            // Filter
            const todayStr = new Date().toISOString().split('T')[0];
            
            // V71.0: å„ªåŒ–æœå°‹æ•ˆèƒ½ - å»ºç«‹æœå°‹ç´¢å¼•
            const searchableShipments = useMemo(() => {
                return shipments.map(s => ({
                    ...s,
                    _searchText: [
                        s.containerNumber,
                        s.supplier,
                        s.importCompany,
                        s.customsBroker,
                        s.origin,
                        s.customsDeclarationNo,
                        s.importPermitNo,
                        ...(s.products || []).flatMap(p => [p.name, p.spec, p.batchNumber])
                    ].filter(Boolean).join(' ').toLowerCase()
                }));
            }, [shipments]);

            const filteredList = useMemo(() => {
                let list = Array.isArray(searchableShipments) ? searchableShipments : [];
                
                // V71.0: å„ªåŒ–æœå°‹ - ä½¿ç”¨é å»ºçš„æœå°‹ç´¢å¼•
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    list = list.filter(s => s._searchText.includes(term));
                }
                
                if(currentTab==='UNPAID') list=list.filter(s=>!s.isPaid);
                else if(currentTab==='DOMESTIC') list=list.filter(s=>isDomestic(s));
                else if(currentTab==='DEVANED') list=list.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr);
                else list=list.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr));
                
                return list.sort((a,b) => (currentTab==='DEVANED' ? (b.devanningDate>a.devanningDate?1:-1) : (a.arrivalDate>b.arrivalDate?1:-1)));
            }, [searchableShipments, searchTerm, currentTab]);
            
            // V79.4: æ’åºå¾Œçš„åˆ—è¡¨ï¼ˆç”¨æ–¼è²¡å‹™æ¸…å–®è¡¨æ ¼ï¼‰
            const sortedFilteredList = useMemo(() => {
                if (!filteredList || !Array.isArray(filteredList)) return [];
                const list = [...filteredList];
                list.sort((a, b) => {
                    let valA, valB;
                    switch (sortField) {
                        case 'arrivalDate':
                            valA = a.arrivalDate || '';
                            valB = b.arrivalDate || '';
                            break;
                        case 'importCompany':
                            valA = a.importCompany || '';
                            valB = b.importCompany || '';
                            break;
                        case 'vendorSeqNo':
                            valA = a.vendorSeqNo || '';
                            valB = b.vendorSeqNo || '';
                            break;
                        case 'containerNumber':
                            valA = a.containerNumber || '';
                            valB = b.containerNumber || '';
                            break;
                        case 'supplier':
                            valA = a.supplier || '';
                            valB = b.supplier || '';
                            break;
                        case 'totalQuantity':
                            valA = (a.products || []).reduce((s, p) => s + (Number(p.quantity)||0), 0);
                            valB = (b.products || []).reduce((s, p) => s + (Number(p.quantity)||0), 0);
                            break;
                        case 'totalWeight':
                            valA = (a.products || []).reduce((s, p) => s + (Number(p.weight)||0), 0);
                            valB = (b.products || []).reduce((s, p) => s + (Number(p.weight)||0), 0);
                            break;
                        case 'totalAmount':
                            valA = (a.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                            valB = (b.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                            break;
                        default:
                            valA = a[sortField] || '';
                            valB = b[sortField] || '';
                    }
                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                return list;
            }, [filteredList, sortField, sortOrder]);
            
            // V71.0: å„ªåŒ–æ€¥ä»¶è¨ˆç®— - åˆä½µ urgentCount å’Œ urgentListï¼Œé¿å…é‡è¤‡éæ­·
            const { urgentCount, urgentList } = useMemo(() => {
                const todayParsed = parseDate(todayStr);
                const list = shipments.filter(s => {
                    if (!s.arrivalDate) return false;
                    const diff = Math.round((parseDate(s.arrivalDate) - todayParsed) / 86400000);
                    return diff >= 0 && diff <= 3;
                }).sort((a, b) => a.arrivalDate > b.arrivalDate ? 1 : -1);
                return { urgentCount: list.length, urgentList: list };
            }, [shipments]);
            
            const unpaidCount = useMemo(() => shipments.filter(s => !s.isPaid).length, [shipments]);

            if(loading) return <div className="flex h-screen items-center justify-center text-gray-500">Loading...</div>;
            if(!user) return <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4"><div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full"><div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl"><I.Ship /></div><h1 className="text-2xl font-bold mb-8">{TEXT.LOGIN_TITLE}</h1><button onClick={handleAdminLogin} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow mb-3 flex justify-center gap-2"><I.Google /> {TEXT.LOGIN_STAFF}</button><button onClick={handleGuestLogin} className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold flex justify-center gap-2"><I.User /> {TEXT.LOGIN_GUEST}</button></div></div>;

            return (
                <ErrorBoundary>
                <div className="min-h-screen bg-slate-100 pb-20 md:pb-0 md:pl-64">
                    {/* V70.0: Validation Toast */}
                    {showValidationToast && <div className="validation-toast">{validationMessage}</div>}
                    
                    {/* V79.0: æ™ºèƒ½åŒ¯å…¥é¸æ“‡å™¨ Modal */}
                    {showImportSelector && (
                        <div className="modal-overlay" onClick={() => !isParsing && handleCloseImportSelector()}>
                            <div className="modal-content" style={{maxWidth: '480px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 className="font-bold text-xl text-gray-800">æ–°å¢è²¨æ«ƒ</h3>
                                    {!isParsing && <button onClick={handleCloseImportSelector} className="p-1 hover:bg-gray-100 rounded-full"><I.X /></button>}
                                </div>
                                
                                <p className="text-gray-500 text-sm mb-4">è«‹é¸æ“‡å»ºç«‹æ–¹å¼</p>
                                
                                {/* AI ç‹€æ…‹æç¤º */}
                                {geminiApiKey ? (
                                    <div className="mb-4 p-2 bg-green-50 rounded-lg border border-green-200 text-xs text-green-700 flex items-center gap-2">
                                        <I.Check /> AI æ™ºèƒ½è§£æå·²å•Ÿç”¨
                                    </div>
                                ) : (
                                    <div className="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 text-sm text-yellow-700">
                                        <div className="flex items-center gap-2 font-bold mb-1">
                                            <I.AlertCircle /> å°šæœªè¨­å®š AI åŠŸèƒ½
                                        </div>
                                        <div className="text-xs">
                                            ä¸Šå‚³æ–‡ä»¶å¾Œæœƒé¡¯ç¤ºæ–‡å­—å…§å®¹ä¾›åƒè€ƒï¼Œ
                                            <button onClick={() => {handleCloseImportSelector(); setTempApiKey(''); setShowApiKeyModal(true);}} className="text-blue-600 underline ml-1">è¨­å®š API Key</button> å¯å•Ÿç”¨è‡ªå‹•å¡«å…¥
                                        </div>
                                    </div>
                                )}
                                
                                <div className="space-y-3">
                                    {/* æ‰‹å‹•å¡«å¯« */}
                                    <div className="import-method-card" onClick={handleManualEntry} style={{flexDirection: 'row', padding: '16px 20px'}}>
                                        <div className="import-method-icon" style={{width: '44px', height: '44px', background: 'var(--color-primary)'}}>
                                            <I.FormInput />
                                        </div>
                                        <div style={{flex: 1, textAlign: 'left', marginLeft: '16px'}}>
                                            <div className="import-method-title">æ‰‹å‹•å¡«å¯«</div>
                                            <div className="import-method-desc" style={{textAlign: 'left'}}>é€æ­¥å¡«å¯«è²¨æ«ƒè³‡è¨Š</div>
                                        </div>
                                        <I.ChevronRight />
                                    </div>
                                    
                                    {/* ä¸Šå‚³æ–‡ä»¶ */}
                                    <label className="import-method-card" style={{flexDirection: 'row', padding: '16px 20px', cursor: isParsing ? 'wait' : 'pointer'}}>
                                        <div className="import-method-icon" style={{width: '44px', height: '44px', background: 'var(--color-success)'}}>
                                            {isParsing ? <div className="spinner" style={{width: '24px', height: '24px', borderWidth: '2px', borderTopColor: 'white'}}></div> : <I.FileText />}
                                        </div>
                                        <div style={{flex: 1, textAlign: 'left', marginLeft: '16px'}}>
                                            <div className="import-method-title">{isParsing ? 'è§£æä¸­...' : 'ä¸Šå‚³å ±é—œæ–‡ä»¶'}</div>
                                            <div className="import-method-desc" style={{textAlign: 'left'}}>
                                                {isParsing ? parseProgress : (geminiApiKey ? 'AI è‡ªå‹•è§£æä¸¦å¡«å…¥è¡¨å–®' : 'ä¸Šå‚³å¾Œå¯åƒè€ƒæ–‡å­—å…§å®¹å¡«å¯«')}
                                            </div>
                                        </div>
                                        {!isParsing && <I.ChevronRight />}
                                        <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handlePdfUpload} className="hidden" disabled={isParsing} />
                                    </label>
                                </div>
                                
                                <div className="mt-6 p-3 bg-gray-50 rounded-lg border">
                                    <div className="text-xs font-bold text-gray-500 mb-2">æ”¯æ´çš„æ–‡ä»¶é¡å‹ï¼ˆPDF / Excelï¼‰</div>
                                    <div className="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div className="flex items-center gap-2"><span>ğŸ“„</span> Commercial Invoice</div>
                                        <div className="flex items-center gap-2"><span>ğŸ“¦</span> Packing List</div>
                                        <div className="flex items-center gap-2"><span>ğŸš¢</span> Bill of Lading</div>
                                        <div className="flex items-center gap-2"><span>ğŸ“¬</span> åˆ°è²¨é€šçŸ¥</div>
                                        <div className="flex items-center gap-2"><span>ğŸ“‹</span> æ‰¹è™Ÿæ•ˆæœŸæ¸…å–®</div>
                                        <div className="flex items-center gap-2"><span>ğŸ“Š</span> Excel æ•ˆæœŸè¡¨</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* V79.0: AI è§£æé è¦½ç¢ºèª Modal */}
                    {showAiPreview && aiExtractedData && (
                        <div className="modal-overlay" onClick={() => {}}>
                            <div className="modal-content" style={{maxWidth: '600px', maxHeight: '90vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <div>
                                        <h3 className="font-bold text-xl text-gray-800">AI è§£æçµæœ</h3>
                                        <p className="text-sm text-gray-500 mt-1">è«‹ç¢ºèªä»¥ä¸‹è³‡æ–™æ˜¯å¦æ­£ç¢º</p>
                                    </div>
                                </div>
                                
                                {/* å·²è­˜åˆ¥çš„æ–‡ä»¶ */}
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {parsedDocuments.map(doc => (
                                        <span key={doc.id} className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs ${doc.isScanned ? 'bg-blue-100 text-blue-700' : 'bg-gray-100'}`}>
                                            {doc.icon} {doc.label}
                                        </span>
                                    ))}
                                </div>
                                
                                {/* è¡çªæç¤º */}
                                {Object.keys(fieldConflicts).length > 0 && (
                                    <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-xl">
                                        <div className="flex items-center gap-2 text-yellow-700 font-bold text-sm mb-2">
                                            <I.AlertCircle /> ç™¼ç¾è³‡æ–™è¡çªï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„å€¼
                                        </div>
                                        {Object.entries(fieldConflicts).map(([field, options]) => (
                                            <div key={field} className="mt-2 p-2 bg-white rounded border">
                                                <div className="text-xs text-gray-500 mb-2">{field === 'containerNumber' ? 'æ«ƒè™Ÿ' : field === 'arrivalDate' ? 'åˆ°æ¸¯æ—¥' : field}</div>
                                                <div className="flex flex-wrap gap-2">
                                                    {options.map((opt, idx) => (
                                                        <button key={idx} type="button" onClick={() => selectFieldValue(field, opt.value, opt.source)}
                                                            className={`px-3 py-1.5 rounded-lg text-sm border ${fieldSources[field]?.value === opt.value ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`}>
                                                            <span className="font-medium">{opt.value}</span>
                                                            <span className="text-xs text-gray-400 ml-1">({opt.source})</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* é‡è¤‡æ«ƒè™Ÿè­¦å‘Š */}
                                {duplicateContainer && (
                                    <div className="mb-4 p-3 bg-red-50 border border-red-300 rounded-xl">
                                        <div className="flex items-center gap-2 text-red-700 font-bold text-sm mb-1">
                                            <I.AlertCircle /> âš ï¸ æ«ƒè™Ÿå·²å­˜åœ¨ï¼
                                        </div>
                                        <div className="text-sm text-red-600">
                                            æ«ƒè™Ÿ <span className="font-bold">{duplicateContainer.containerNo}</span> å·²æœ‰è¨˜éŒ„
                                        </div>
                                        <div className="text-xs text-red-500 mt-1">
                                            åˆ°æ¸¯æ—¥: {duplicateContainer.existingArrivalDate || '-'}ï¼Œ
                                            å» å•†: {duplicateContainer.existingSupplier || '-'}
                                        </div>
                                        <div className="text-xs text-gray-600 mt-2 p-2 bg-white rounded border border-red-200">
                                            ğŸ’¡ å¦‚éœ€ç·¨è¼¯ç¾æœ‰è¨˜éŒ„ï¼Œè«‹å¾åˆ—è¡¨ä¸­æ‰¾åˆ°è©²è²¨æ«ƒé€²è¡Œä¿®æ”¹
                                        </div>
                                    </div>
                                )}
                                
                                {/* ç¼ºå°‘æ¬„ä½æç¤º */}
                                {(!aiExtractedData?.containerNumber || !aiExtractedData?.arrivalDate) && (
                                    <div className="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-xl">
                                        <div className="flex items-center gap-2 text-orange-700 font-bold text-sm mb-1">
                                            <I.AlertCircle /> éƒ¨åˆ†æ¬„ä½æœªè§£æ
                                        </div>
                                        <div className="text-xs text-orange-600">
                                            {!aiExtractedData?.containerNumber && <span className="mr-2">â€¢ æ«ƒè™Ÿï¼ˆå»ºè­°è£œå…… B/L æˆ– Packing Listï¼‰</span>}
                                            {!aiExtractedData?.arrivalDate && <span>â€¢ åˆ°æ¸¯æ—¥</span>}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">æ‚¨å¯ä»¥åœ¨ä¸‹ä¸€æ­¥æ‰‹å‹•å¡«å¯«é€™äº›æ¬„ä½</div>
                                    </div>
                                )}
                                
                                {/* è§£æçµæœé è¦½ */}
                                <div className="space-y-3 max-h-[45vh] overflow-y-auto pr-2">
                                    {/* åŸºæœ¬è³‡è¨Š */}
                                    <div className="p-3 bg-gray-50 rounded-xl">
                                        <div className="font-bold text-sm text-gray-700 mb-3">åŸºæœ¬è³‡è¨Š</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            {[
                                                { key: 'containerNumber', label: 'æ«ƒè™Ÿ' },
                                                { key: 'billOfLading', label: 'æå–®è™Ÿç¢¼' },
                                                { key: 'arrivalDate', label: 'åˆ°æ¸¯æ—¥' },
                                                { key: 'supplier', label: 'å» å•†' },
                                                { key: 'origin', label: 'ç”¢åœ°' },
                                                { key: 'importCompany', label: 'é€²å£å…¬å¸' },
                                                { key: 'shippingCompany', label: 'èˆ¹å…¬å¸' },
                                                { key: 'devanningLocation', label: 'æ‹†æ«ƒåœ°' }
                                            ].map(({ key, label }) => (
                                                <div key={key} className={`p-2 rounded-lg border ${fieldSources[key] ? getConfidenceColor(fieldSources[key].confidence) : 'bg-gray-100 border-dashed border-gray-300'}`}>
                                                    <div className="text-xs text-gray-500 flex justify-between">
                                                        <span>{label}</span>
                                                        {fieldSources[key] && <span className="text-[10px]">{fieldSources[key].source}</span>}
                                                    </div>
                                                    <div className={`font-bold text-sm mt-1 ${!fieldSources[key]?.value ? 'text-gray-400' : ''}`}>
                                                        {fieldSources[key]?.value || 'ï¼ˆå¾…å¡«å¯«ï¼‰'}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* ç”¢å“æ˜ç´° */}
                                    {fieldSources.products && fieldSources.products.value.length > 0 && (
                                        <div className="p-3 bg-gray-50 rounded-xl">
                                            <div className="font-bold text-sm text-gray-700 mb-3">
                                                ç”¢å“æ˜ç´° ({fieldSources.products.value.length} é …) 
                                                <span className="font-normal text-gray-400 ml-2">- è«‹é¸æ“‡å°æ‡‰çš„ ERP å“å</span>
                                            </div>
                                            <div className="space-y-3">
                                                {fieldSources.products.value.map((p, idx) => (
                                                    <div key={idx} className="p-3 bg-white rounded-lg border text-sm">
                                                        {/* åŸå§‹è³‡è¨Šï¼ˆå“å + è¦æ ¼ï¼‰ */}
                                                        <div className="mb-2 pb-2 border-b border-gray-100">
                                                            <div className="flex items-start justify-between gap-2">
                                                                <div className="flex-1">
                                                                    <div className="text-xs text-gray-400 mb-1">ğŸ“„ æ–‡ä»¶å“å</div>
                                                                    <div className="font-bold text-gray-800">{p.originalText || p.name || '-'}</div>
                                                                </div>
                                                                {p.spec && (
                                                                    <div className="text-right">
                                                                        <div className="text-xs text-gray-400 mb-1">è¦æ ¼</div>
                                                                        <div className="font-bold text-orange-600 text-base">{p.spec}</div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* å“åé¸æ“‡ */}
                                                        <div 
                                                            onClick={() => { 
                                                                if(products.length > 0) { 
                                                                    setActiveProductPicker({type: 'aiPreview', index: idx}); 
                                                                    // é å¡« AI è§£æçš„å“åä½œç‚ºæœå°‹é—œéµå­—
                                                                    const searchHint = p.name || p.originalText || '';
                                                                    // å–ä¸­æ–‡å“åçš„å‰å¹¾å€‹å­—ï¼Œæˆ–è‹±æ–‡çš„ç¬¬ä¸€å€‹å–®å­—
                                                                    const keyword = searchHint.includes(' ') 
                                                                        ? searchHint.split(' ')[0] 
                                                                        : searchHint.substring(0, 4);
                                                                    setProductPickerSearch(keyword);
                                                                } 
                                                            }} 
                                                            className="p-2 bg-blue-50 rounded-lg border-2 border-dashed border-blue-200 cursor-pointer hover:bg-blue-100 flex items-center justify-between"
                                                        >
                                                            <span className={p.selectedName ? 'font-bold text-gray-800' : 'text-blue-600'}>
                                                                {p.selectedName || 'é»æ“Šé¸æ“‡ ERP å“å â–¼'}
                                                            </span>
                                                            {p.selectedName && <span className="text-green-500 text-xs">âœ“ å·²é¸æ“‡</span>}
                                                        </div>
                                                        
                                                        {/* æ•¸æ“šé¡¯ç¤º */}
                                                        <div className="flex flex-wrap gap-3 mt-2 text-xs">
                                                            <span className="text-blue-600 font-bold">ä»¶æ•¸: {p.quantity?.toLocaleString()}</span>
                                                            <span className="text-orange-500 font-bold">é‡é‡: {p.weight?.toLocaleString()} kg</span>
                                                            {p.unitPrice > 0 && <span className="text-green-600 font-bold">å–®åƒ¹: ${p.unitPrice}</span>}
                                                            {p.batchNumber && <span className="text-purple-600">æ‰¹è™Ÿ: {p.batchNumber}</span>}
                                                            {p.expiryDate && <span className="text-red-500">æ•ˆæœŸ: {p.expiryDate}</span>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {/* æœªé¸æ“‡å“åæç¤º */}
                                            {fieldSources.products.value.some(p => !p.selectedName) && (
                                                <div className="mt-3 p-2 bg-yellow-50 rounded-lg border border-yellow-200 text-xs text-yellow-700 flex items-center gap-2">
                                                    <I.AlertCircle /> è«‹ç‚ºæ¯å€‹ç”¢å“é¸æ“‡å°æ‡‰çš„ ERP å“å
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* æ“ä½œæŒ‰éˆ• */}
                                <div className="flex gap-3 mt-4 pt-4 border-t">
                                    <button type="button" onClick={cancelAiExtraction} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">
                                        {duplicateContainer ? 'å–æ¶ˆ' : 'æ”¹ç”¨æ‰‹å‹•å¡«å¯«'}
                                    </button>
                                    {duplicateContainer ? (
                                        <button type="button" onClick={() => {
                                            if (confirm('æ­¤æ«ƒè™Ÿå·²å­˜åœ¨ï¼Œç¢ºå®šè¦å»ºç«‹æ–°è¨˜éŒ„å—ï¼Ÿ\n\né€™å¯èƒ½æœƒé€ æˆé‡è¤‡è³‡æ–™ã€‚')) {
                                                confirmAiExtraction();
                                            }
                                        }} className="flex-1 py-3 bg-orange-500 text-white rounded-xl font-bold shadow-lg">
                                            ä»è¦å»ºç«‹æ–°è¨˜éŒ„
                                        </button>
                                    ) : (
                                        <button type="button" onClick={confirmAiExtraction} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">
                                            ç¢ºèªä¸¦å¡«å…¥è¡¨å–®
                                        </button>
                                    )}
                                </div>
                                
                                <div className="mt-3 text-center text-xs text-gray-400">
                                    å¡«å…¥å¾Œæ‚¨ä»å¯åœ¨è¡¨å–®ä¸­ä¿®æ”¹ä»»ä½•æ¬„ä½
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* AI è™•ç†ä¸­æç¤º */}
                    {isAiProcessing && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '320px', textAlign: 'center'}}>
                                <div className="spinner mx-auto mb-4" style={{width: '48px', height: '48px'}}></div>
                                <div className="font-bold text-lg text-gray-800 mb-2">AI æ­£åœ¨åˆ†ææ–‡ä»¶</div>
                                <div className="text-sm text-gray-500">{parseProgress || 'è«‹ç¨å€™...'}</div>
                            </div>
                        </div>
                    )}
                    
                    {/* V79.0: Gemini API Key è¨­å®š Modal */}
                    {showApiKeyModal && (
                        <div className="modal-overlay" onClick={() => setShowApiKeyModal(false)}>
                            <div className="modal-content" style={{maxWidth: '450px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 className="font-bold text-xl text-gray-800">è¨­å®š AI è§£æåŠŸèƒ½</h3>
                                    <button onClick={() => setShowApiKeyModal(false)} className="p-1 hover:bg-gray-100 rounded-full"><I.X /></button>
                                </div>
                                
                                <div className="mb-4 p-3 bg-blue-50 rounded-xl border border-blue-200">
                                    <div className="text-sm text-blue-800">
                                        <strong>å¦‚ä½•å–å¾— API Keyï¼Ÿ</strong>
                                        <ol className="mt-2 ml-4 list-decimal space-y-1 text-blue-700">
                                            <li>å‰å¾€ <a href="https://aistudio.google.com/apikey" target="_blank" className="underline font-bold">Google AI Studio</a></li>
                                            <li>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</li>
                                            <li>é»æ“Šã€ŒCreate API Keyã€</li>
                                            <li>è¤‡è£½ç”¢ç”Ÿçš„ Key è²¼åˆ°ä¸‹æ–¹</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="form-label-lg">Gemini API Key</label>
                                    <input 
                                        type="password" 
                                        value={tempApiKey} 
                                        onChange={e => setTempApiKey(e.target.value)}
                                        className="form-input-lg font-mono"
                                        placeholder="AIzaSy..."
                                    />
                                    <div className="text-xs text-gray-400 mt-2">
                                        API Key æœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨
                                    </div>
                                </div>
                                
                                {geminiApiKey && (
                                    <div className="mb-4 p-2 bg-green-50 rounded-lg border border-green-200 text-sm text-green-700 flex items-center gap-2">
                                        <I.Check /> å·²è¨­å®š API Key
                                    </div>
                                )}
                                
                                {/* V79.1: æ‰¹è™Ÿè™•ç†æ¨¡å¼è¨­å®š */}
                                <div className="mb-4 p-3 bg-gray-50 rounded-xl border">
                                    <div className="text-sm font-bold text-gray-700 mb-2">æ‰¹è™Ÿè™•ç†æ¨¡å¼</div>
                                    <div className="space-y-2">
                                        <label className="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
                                            <input 
                                                type="radio" 
                                                name="batchMode" 
                                                checked={batchMergeMode === 'merge'} 
                                                onChange={() => saveBatchMergeMode('merge')}
                                                className="mt-1"
                                            />
                                            <div>
                                                <div className="font-medium text-gray-800">åˆä½µæ¨¡å¼ï¼ˆå»ºè­°ï¼‰</div>
                                                <div className="text-xs text-gray-500">åŒå“å+åŒè¦æ ¼åˆä½µï¼Œå–æœ€æ—©æ•ˆæœŸ</div>
                                            </div>
                                        </label>
                                        <label className="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
                                            <input 
                                                type="radio" 
                                                name="batchMode" 
                                                checked={batchMergeMode === 'split'} 
                                                onChange={() => saveBatchMergeMode('split')}
                                                className="mt-1"
                                            />
                                            <div>
                                                <div className="font-medium text-gray-800">æ‹†åˆ†æ¨¡å¼</div>
                                                <div className="text-xs text-gray-500">æ¯å€‹æ‰¹è™Ÿç¨ç«‹ä¸€ç­†è¨˜éŒ„</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3">
                                    <button 
                                        type="button" 
                                        onClick={() => setShowApiKeyModal(false)} 
                                        className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        type="button" 
                                        onClick={() => {
                                            if (tempApiKey.trim()) {
                                                saveApiKey(tempApiKey.trim());
                                                // å¦‚æœæœ‰å¾…è™•ç†çš„æ–‡ä»¶ï¼Œç¹¼çºŒè™•ç†
                                                if (parsedDocuments.length > 0) {
                                                    processWithAI(parsedDocuments).catch(e => console.error('AI è™•ç†éŒ¯èª¤:', e));
                                                }
                                            } else {
                                                alert('è«‹è¼¸å…¥ API Key');
                                            }
                                        }} 
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        å„²å­˜
                                    </button>
                                </div>
                                
                                {geminiApiKey && (
                                    <button 
                                        type="button" 
                                        onClick={() => {
                                            if (confirm('ç¢ºå®šè¦æ¸…é™¤ API Key å—ï¼Ÿ')) {
                                                localStorage.removeItem('gemini_api_key');
                                                setGeminiApiKey('');
                                                setTempApiKey('');
                                            }
                                        }}
                                        className="w-full mt-3 py-2 text-red-500 text-sm font-bold"
                                    >
                                        æ¸…é™¤å·²å„²å­˜çš„ API Key
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Notification Modal */}
                    {showNotifications && (
                        <div className="modal-overlay" onClick={()=>setShowNotifications(false)}>
                            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">{TEXT.URGENT_TITLE} ({urgentCount})</h3><button onClick={()=>setShowNotifications(false)}><I.X /></button></div>
                                {urgentList.length===0 ? <div className="text-center text-gray-400 py-4">{TEXT.NO_URGENT}</div> : urgentList.map(s=>(
                                    <div key={s.id} className="mb-3 p-3 bg-red-50 rounded-lg border border-red-100 cursor-pointer" onClick={()=>{
                                        setShowNotifications(false); 
                                        setSearchTerm(s.containerNumber); // æœå°‹è©²æ«ƒè™Ÿ
                                        setCurrentTab('NOT_DEVANED'); // åˆ‡åˆ°æœªæ‹†æ«ƒ
                                        setView('list'); // ç¢ºä¿åœ¨åˆ—è¡¨é 
                                    }}>
                                        <div className="flex justify-between font-bold text-sm text-gray-800"><span>{s.containerNumber}</span><span className="text-red-600">{s.arrivalDate}</span></div>
                                        <div className="text-xs text-gray-500 mt-1">{s.supplier}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* File List Modal */}
                    {showFileModal && (
                        <div className="modal-overlay" onClick={()=>setShowFileModal(false)}>
                            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">{TEXT.FILE_LIST_TITLE} ({fileList.length})</h3><button onClick={()=>setShowFileModal(false)}><I.X /></button></div>
                                <div className="space-y-2">
                                    {fileList.map((f, i) => (
                                        <a key={i} href={f.url} target="_blank" className="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-blue-50 border border-gray-200 text-blue-600 group">
                                            <span className="truncate font-bold text-sm mr-2">{f.name}</span>
                                            <span className="text-gray-400 group-hover:text-blue-600"><I.Download /></span>
                                        </a>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V74.0: Excel Import Modal */}
                    {showImportModal && (
                        <div className="modal-overlay" onClick={() => !importProcessing && setShowImportModal(false)}>
                            <div className="modal-content" style={{maxWidth: '600px', maxHeight: '85vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">{TEXT.IMPORT_TITLE}</h3>
                                    {!importProcessing && <button onClick={() => setShowImportModal(false)}><I.X /></button>}
                                </div>
                                
                                <div className="text-sm text-gray-500 mb-3">
                                    {TEXT.IMPORT_ROW_COUNT.replace('{count}', importData.length)}
                                    <span className="ml-2 text-orange-500">{TEXT.IMPORT_UPDATE_HINT}</span>
                                </div>
                                
                                {/* é è¦½è¡¨æ ¼ */}
                                <div className="overflow-x-auto mb-4 border rounded-lg" style={{maxHeight: '300px'}}>
                                    <table className="w-full text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-2 py-2 text-left">#</th>
                                                <th className="px-2 py-2 text-left">å» å•†</th>
                                                <th className="px-2 py-2 text-left">å“å</th>
                                                <th className="px-2 py-2 text-left">è¦æ ¼</th>
                                                <th className="px-2 py-2 text-right">å–®åƒ¹</th>
                                                <th className="px-2 py-2 text-right">æ•¸é‡</th>
                                                <th className="px-2 py-2 text-right">é‡é‡</th>
                                                <th className="px-2 py-2 text-left">æ—¥æœŸ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {importData.slice(0, 50).map((item, idx) => (
                                                <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="px-2 py-1.5 text-gray-400">{item._rowIndex}</td>
                                                    <td className="px-2 py-1.5 font-medium">{item.supplier || '-'}</td>
                                                    <td className="px-2 py-1.5">{item.productName || '-'}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.spec || '-'}</td>
                                                    <td className="px-2 py-1.5 text-right text-emerald-600">{item.unitPrice || 0}</td>
                                                    <td className="px-2 py-1.5 text-right text-blue-600">{item.quantity || 0}</td>
                                                    <td className="px-2 py-1.5 text-right text-orange-500">{item.weight || 0}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.arrivalDate || '-'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {importData.length > 50 && (
                                        <div className="text-center py-2 text-gray-400 text-xs bg-gray-50">
                                            ... é‚„æœ‰ {importData.length - 50} ç­†è³‡æ–™æœªé¡¯ç¤º
                                        </div>
                                    )}
                                </div>
                                
                                {/* é€²åº¦æ¢ */}
                                {importProcessing && (
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{TEXT.IMPORT_PROCESSING}</span>
                                            <span>{importProgress.current} / {importProgress.total}</span>
                                        </div>
                                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-300"
                                                style={{width: `${(importProgress.current / importProgress.total) * 100}%`}}
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {/* æŒ‰éˆ• */}
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowImportModal(false)} 
                                        disabled={importProcessing}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {TEXT.IMPORT_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleConfirmImport} 
                                        disabled={importProcessing || importData.length === 0}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {importProcessing ? TEXT.IMPORT_PROCESSING : TEXT.IMPORT_CONFIRM}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V75.0: ç”¢å“ç·¨è¼¯/æ–°å¢ Modal */}
                    {showProductModal && editingProduct && (
                        <div className="modal-overlay" onClick={() => setShowProductModal(false)}>
                            <div className="modal-content" style={{maxWidth: '500px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">
                                        {editingProduct.id ? TEXT.PRODUCTS_EDIT_TITLE : TEXT.PRODUCTS_ADD_TITLE}
                                    </h3>
                                    <button onClick={() => setShowProductModal(false)}><I.X /></button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_ID} *</label>
                                            <input 
                                                type="text"
                                                value={editingProduct.productId || ''}
                                                onChange={e => setEditingProduct(p => ({...p, productId: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5 font-mono"
                                                placeholder="A09134S20P"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_NAME} *</label>
                                            <input 
                                                type="text"
                                                value={editingProduct.name || ''}
                                                onChange={e => setEditingProduct(p => ({...p, name: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5"
                                                placeholder="å“å"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_SPEC}</label>
                                        <input 
                                            type="text"
                                            value={editingProduct.spec || ''}
                                            onChange={e => setEditingProduct(p => ({...p, spec: e.target.value}))}
                                            className="w-full border rounded-lg p-2.5"
                                            placeholder="36/40S*420G*20åŒ…(IQ10%)"
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_UNIT}</label>
                                            <select 
                                                value={editingProduct.unit || 'åŒ…'}
                                                onChange={e => setEditingProduct(p => ({...p, unit: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5"
                                            >
                                                {PRODUCT_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_DEFAULT_PRICE}</label>
                                            <input 
                                                type="number"
                                                value={editingProduct.defaultPrice || ''}
                                                onChange={e => setEditingProduct(p => ({...p, defaultPrice: safeNum(e.target.value)}))}
                                                className="w-full border rounded-lg p-2.5 text-right"
                                                placeholder="0"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_DEFAULT_SUPPLIER}</label>
                                        <input 
                                            type="text"
                                            value={editingProduct.defaultSupplier || ''}
                                            onChange={e => setEditingProduct(p => ({...p, defaultSupplier: e.target.value}))}
                                            className="w-full border rounded-lg p-2.5"
                                            placeholder="é è¨­ä¾›æ‡‰å•†"
                                        />
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                        <input 
                                            type="checkbox"
                                            id="productIsActive"
                                            checked={editingProduct.isActive !== false}
                                            onChange={e => setEditingProduct(p => ({...p, isActive: e.target.checked}))}
                                            className="w-4 h-4"
                                        />
                                        <label htmlFor="productIsActive" className="text-sm text-gray-600">{TEXT.PRODUCT_IS_ACTIVE}</label>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => setShowProductModal(false)}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold"
                                    >
                                        {TEXT.BTN_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleSaveProduct}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        {TEXT.BTN_SAVE}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V75.0: ç”¢å“åŒ¯å…¥ Modal */}
                    {showProductImportModal && (
                        <div className="modal-overlay" onClick={() => !importProcessing && setShowProductImportModal(false)}>
                            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '85vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">{TEXT.PRODUCTS_IMPORT_TITLE}</h3>
                                    {!importProcessing && <button onClick={() => setShowProductImportModal(false)}><I.X /></button>}
                                </div>
                                
                                <div className="text-sm text-gray-500 mb-3">
                                    {TEXT.IMPORT_ROW_COUNT.replace('{count}', productImportData.length)}
                                    <span className="ml-2 text-orange-500">{TEXT.PRODUCTS_IMPORT_HINT}</span>
                                </div>
                                
                                {/* é è¦½è¡¨æ ¼ */}
                                <div className="overflow-x-auto mb-4 border rounded-lg" style={{maxHeight: '350px'}}>
                                    <table className="w-full text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-2 py-2 text-left">å“è™Ÿ</th>
                                                <th className="px-2 py-2 text-left">å“å</th>
                                                <th className="px-2 py-2 text-left">è¦æ ¼</th>
                                                <th className="px-2 py-2 text-left">å–®ä½</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {productImportData.slice(0, 100).map((item, idx) => (
                                                <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="px-2 py-1.5 font-mono text-gray-500">{item.productId}</td>
                                                    <td className="px-2 py-1.5 font-medium">{item.name}</td>
                                                    <td className="px-2 py-1.5 text-gray-600">{item.spec || '-'}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.unit}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {productImportData.length > 100 && (
                                        <div className="text-center py-2 text-gray-400 text-xs bg-gray-50">
                                            ... é‚„æœ‰ {productImportData.length - 100} ç­†è³‡æ–™æœªé¡¯ç¤º
                                        </div>
                                    )}
                                </div>
                                
                                {/* é€²åº¦æ¢ */}
                                {importProcessing && (
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{TEXT.IMPORT_PROCESSING}</span>
                                            <span>{importProgress.current} / {importProgress.total}</span>
                                        </div>
                                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-300"
                                                style={{width: `${(importProgress.current / importProgress.total) * 100}%`}}
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {/* æŒ‰éˆ• */}
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowProductImportModal(false)} 
                                        disabled={importProcessing}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {TEXT.IMPORT_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleConfirmProductImport} 
                                        disabled={importProcessing || productImportData.length === 0}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {importProcessing ? TEXT.IMPORT_PROCESSING : TEXT.IMPORT_CONFIRM}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V78.5: ç”¢å“é¸æ“‡ Bottom Sheet */}
                    {activeProductPicker !== null && products.length > 0 && (
                        <>
                            <div className="bottom-sheet-overlay" onClick={() => setActiveProductPicker(null)} />
                            <div className="bottom-sheet">
                                <div className="bottom-sheet-handle" onClick={() => setActiveProductPicker(null)} />
                                <div className="bottom-sheet-header">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-xl text-gray-800">é¸æ“‡ ERP å“å</h3>
                                        <button onClick={() => setActiveProductPicker(null)} className="p-2 text-gray-400 bg-gray-100 rounded-full"><I.X /></button>
                                    </div>
                                    
                                    {/* AI é è¦½æ¨¡å¼ï¼šé¡¯ç¤ºåŸå§‹æ–‡ä»¶è³‡è¨Šä¾›åƒè€ƒ */}
                                    {activeProductPicker?.type === 'aiPreview' && fieldSources?.products?.value?.[activeProductPicker.index] && (
                                        <div className="mb-3 p-3 bg-blue-50 rounded-xl border border-blue-200">
                                            <div className="text-xs text-blue-600 font-bold mb-2">ğŸ“„ æ–‡ä»¶è³‡è¨Šï¼ˆä¾›åƒè€ƒï¼‰</div>
                                            <div className="space-y-1">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-gray-500 text-sm">å“å:</span>
                                                    <span className="font-bold text-gray-800">{fieldSources.products.value[activeProductPicker.index].originalText || fieldSources.products.value[activeProductPicker.index].name || '-'}</span>
                                                </div>
                                                {fieldSources.products.value[activeProductPicker.index].spec && (
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-gray-500 text-sm">è¦æ ¼:</span>
                                                        <span className="font-bold text-orange-600">{fieldSources.products.value[activeProductPicker.index].spec}</span>
                                                    </div>
                                                )}
                                                <div className="flex flex-wrap gap-3 text-sm mt-1">
                                                    <span className="text-blue-600">ä»¶æ•¸: <b>{fieldSources.products.value[activeProductPicker.index].quantity?.toLocaleString()}</b></span>
                                                    <span className="text-orange-500">é‡é‡: <b>{fieldSources.products.value[activeProductPicker.index].weight?.toLocaleString()} kg</b></span>
                                                    {fieldSources.products.value[activeProductPicker.index].unitPrice > 0 && (
                                                        <span className="text-green-600">å–®åƒ¹: <b>${fieldSources.products.value[activeProductPicker.index].unitPrice}</b></span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <input 
                                        type="text"
                                        value={productPickerSearch}
                                        onChange={e => setProductPickerSearch(e.target.value)}
                                        placeholder="æœå°‹å“è™Ÿã€å“åã€è¦æ ¼..."
                                        className="form-input-lg"
                                        autoFocus
                                    />
                                </div>
                                <div className="bottom-sheet-content">
                                    {pickerFilteredProducts.length === 0 ? (
                                        <div className="p-8 text-center text-gray-400 text-lg">ç„¡ç¬¦åˆçš„ç”¢å“</div>
                                    ) : (
                                        pickerFilteredProducts.map(prod => (
                                            <div 
                                                key={prod.id}
                                                onClick={() => handleSelectProduct(activeProductPicker, prod)}
                                                className="product-item-lg"
                                            >
                                                <div className="name">{prod.name}</div>
                                                <div className="flex justify-between items-center">
                                                    <span className="spec">{prod.spec || 'ç„¡è¦æ ¼'}</span>
                                                    <span className="code">{prod.productId}</span>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                    <div className="py-4 text-sm text-gray-400 text-center">
                                        é¡¯ç¤º {pickerFilteredProducts.length} ç­† / å…± {products.filter(p => p.isActive !== false).length} ç­†
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    <aside className="hidden md:flex flex-col w-64 bg-white border-r fixed inset-y-0 left-0 z-20"><div className="p-6 flex items-center gap-3 font-bold text-xl text-gray-800"><span className="text-blue-600"><I.Ship /></span>è²¨æ«ƒç®¡ç† V79.0</div><nav className="flex-1 px-4 space-y-2"><button onClick={()=>setView('list')} className={`sidebar-link w-full ${view==='list'?'active':''}`}><div className="w-8 text-center"><I.List /></div> {TEXT.LIST_TITLE}</button>{userRole !== 'GUEST' && <><button onClick={()=>setView('products')} className={`sidebar-link w-full ${view==='products'?'active':''}`}><div className="w-8 text-center"><I.Package /></div> {TEXT.PRODUCTS_TITLE}</button><button onClick={()=>setView('stats')} className={`sidebar-link w-full ${view==='stats'?'active':''}`}><div className="w-8 text-center"><I.Chart /></div> {TEXT.STATS_TITLE}</button></>}</nav><div className="p-4 border-t space-y-2"><button onClick={()=>{setTempApiKey(geminiApiKey);setShowApiKeyModal(true)}} className="w-full py-2 text-xs text-gray-500 hover:text-blue-600 flex items-center justify-center gap-1 bg-gray-50 rounded-lg"><I.Wand /> AI è¨­å®š {geminiApiKey ? 'âœ“' : ''}</button><button onClick={handleLogout} className="w-full py-2 text-xs text-gray-400 hover:text-red-500 flex items-center justify-center gap-1"><I.LogOut /> {TEXT.LOGOUT}</button></div></aside>

                    <div className="md:hidden sticky top-0 z-30 bg-white border-b px-4 h-14 flex items-center justify-between shadow-sm"><div className="flex items-center gap-2 font-bold text-gray-900"><span className="text-blue-600"><I.Ship /></span> {view==='list'?TEXT.LIST_TITLE:(view==='products'?TEXT.PRODUCTS_TITLE:TEXT.STATS_TITLE)}</div><div className="flex gap-3 items-center"><div className="relative" onClick={()=>setShowNotifications(true)}><span className="text-gray-500"><I.Bell /></span>{urgentCount>0&&<span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></span>}</div><button onClick={handleExport} className="text-gray-500"><I.Download /></button><button onClick={()=>{setTempApiKey(geminiApiKey);setShowApiKeyModal(true)}} className={geminiApiKey ? "text-green-500" : "text-gray-400"}><I.Wand /></button>{canCreate()&&view==='list'&&<button onClick={handleStartNewContainer} className="text-blue-600"><I.Plus /></button>}<button onClick={handleLogout} className="text-red-400"><I.LogOut /></button></div></div>

                    <main className="p-4 max-w-4xl mx-auto">
                        {view === 'list' && (
                            <div className="space-y-4">
                                <div className="sticky top-0 z-20 bg-[#F3F4F6] -mt-4 pt-4 pb-2 space-y-3">
                                    <div className="flex gap-2 items-center">
                                        <div className="relative flex-1"><span className="absolute left-3 top-3 text-gray-400"><I.Search /></span><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="æœå°‹..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border-none shadow-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                        {canSeePrice() && (
                                            <button onClick={()=>setCurrentTab(currentTab==='UNPAID'?'NOT_DEVANED':'UNPAID')} title="ç¯©é¸æœªä»˜æ¬¾è²¨æ«ƒ" className={`relative p-2.5 rounded-xl shadow-sm transition-colors ${currentTab==='UNPAID'?'bg-red-500 text-white':'bg-white text-gray-600'}`}>
                                                <div className="flex items-center gap-1 font-bold"><I.Dollar />{unpaidCount > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}</div>
                                            </button>
                                        )}
                                        <button onClick={()=>setDisplayMode(displayMode==='card'?'table':'card')} title={displayMode==='card'?'åˆ‡æ›è¡¨æ ¼æª¢è¦–':'åˆ‡æ›å¡ç‰‡æª¢è¦–'} className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600"><I.List /></button>
                                        
                                        {/* é›»è…¦ç‰ˆå››å¤§å¤©ç‹ */}
                                        <div className="hidden md:flex gap-2">
                                            <div onClick={()=>setShowNotifications(true)} title="åˆ°æ¸¯é€šçŸ¥" className="relative p-2.5 bg-white rounded-xl shadow-sm text-gray-600 cursor-pointer hover:bg-gray-50"><I.Bell />{urgentCount>0&&<span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>}</div>
                                            <button onClick={handleExport} title="æ‰¹æ¬¡åŒ¯å‡º Excel" className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600 hover:bg-gray-50"><I.Download /></button>
                                            {canCreate() && <button onClick={handleStartNewContainer} title="æ–°å¢è²¨æ«ƒ" className="p-2.5 bg-white rounded-xl shadow-sm text-blue-600 hover:bg-blue-50"><I.Plus /></button>}
                                        </div>
                                    </div>
                                    <div className="flex overflow-x-auto gap-2 pb-1">
                                        <button onClick={()=>setCurrentTab('NOT_DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='NOT_DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>æœªæ‹†æ«ƒ <span className={`ml-1 text-xs ${currentTab==='NOT_DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr)).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>å·²æ‹†æ«ƒ <span className={`ml-1 text-xs ${currentTab==='DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DOMESTIC')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DOMESTIC'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>åœ‹å…§æ¡è³¼ <span className={`ml-1 text-xs ${currentTab==='DOMESTIC'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isDomestic(s)).length}</span></button>
                                        
                                        {/* V74.0: Excel åŒ¯å…¥æŒ‰éˆ• */}
                                        {canCreate() && currentTab === 'DOMESTIC' && (
                                            <label className="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap bg-emerald-500 text-white shadow cursor-pointer hover:bg-emerald-600 transition-colors">
                                                {TEXT.IMPORT_EXCEL}
                                                <input type="file" accept=".xlsx,.xls" onChange={handleExcelImport} className="hidden" />
                                            </label>
                                        )}
                                    </div>
                                </div>

                                {displayMode === 'table' ? (
                                    <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                                        <table className="reconcile-table">
                                            <thead><tr>
                                                <th onClick={()=>handleSort('arrivalDate')} className="cursor-pointer hover:bg-gray-100 select-none">æ—¥æœŸ {sortField==='arrivalDate' && <span>{sortOrder==='asc'?'â†‘':'â†“'}</span>}</th>
                                                <th onClick={()=>handleSort('importCompany')} className="cursor-pointer hover:bg-gray-100 select-none">é€²å£å…¬å¸</th>
                                                <th onClick={()=>handleSort('vendorSeqNo')} className="cursor-pointer hover:bg-gray-100 select-none">å» å•†åºè™Ÿ</th>
                                                <th onClick={()=>handleSort('supplier')} className="cursor-pointer hover:bg-gray-100 select-none">å» å•†</th>
                                                <th className="col-product">å“åæ‘˜è¦</th>
                                                <th onClick={()=>handleSort('totalQuantity')} className="cursor-pointer hover:bg-gray-100 select-none col-right">ç¸½æ•¸</th>
                                                <th onClick={()=>handleSort('totalWeight')} className="cursor-pointer hover:bg-gray-100 select-none col-right">ç¸½é‡</th>
                                                {canSeePrice()&&<th onClick={()=>handleSort('totalAmount')} className="cursor-pointer hover:bg-gray-100 select-none col-right">è²¨æ¬¾(USD)</th>}
                                                {canEditFlightFee()&&<th className="col-right">æ—…è²»</th>}
                                                {canEdit()&&<th className="col-center">æ“ä½œ</th>}
                                            </tr></thead>
                                            <tbody>
                                                {sortedFilteredList.map(item => {
                                                    const totalAmt = (item.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                                                    const totalQty = (item.products || []).reduce((s, p) => s + (Number(p.quantity)||0), 0);
                                                    const totalWt = (item.products || []).reduce((s, p) => s + (Number(p.weight)||0), 0);
                                                    const showFlightFee = isForeign(item) || canManage();
                                                    const uniqueNames = [...new Set((item.products||[]).map(p=>p.name).filter(Boolean))].join(',');
                                                    return (
                                                    <tr key={item.id} className="hover:bg-gray-50">
                                                        <td>{item.arrivalDate}</td>
                                                        <td className={item.importCompany === 'å´‡æ–‡å†·å‡' ? 'text-blue-600' : 'text-orange-600'}>{item.importCompany || '-'}</td>
                                                        <td className="font-mono font-bold text-purple-600">{item.vendorSeqNo || '-'}</td>
                                                        <td>{item.supplier}</td>
                                                        <td className="col-product" title={uniqueNames}>{uniqueNames}</td>
                                                        <td className="col-right font-bold text-blue-600">{totalQty.toLocaleString()}</td>
                                                        <td className="col-right text-orange-500">{format2(totalWt)}</td>
                                                        {canSeePrice()&&<td className="col-right"><span className={item.isPaid?"amt-paid":"amt-unpaid"}>{format2(totalAmt)}</span></td>}
                                                        {canEditFlightFee()&&<td className="col-right">{showFlightFee?<span className={item.flightFeePaid?"amt-paid":"amt-unpaid"}>{format2(safeNum(item.flightFee))}</span>:'-'}</td>}
                                                        {canEdit()&&<td className="col-center"><button onClick={()=>handleEdit(item)} title="ç·¨è¼¯" className="text-gray-400 hover:text-blue-600 p-1"><I.Edit /></button></td>}
                                                    </tr>
                                                )})}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {filteredList.map(item => {
                                            const totalAmount = (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                                            const totalWeight = (item.products || []).reduce((sum, p) => sum + (Number(p.weight) || 0), 0);
                                            const totalQty = (item.products || []).reduce((sum, p) => sum + (Number(p.quantity) || 0), 0);
                                            const currSymbol = item.currency === 'USD' ? 'US$' : 'NT$';
                                            
                                            const isDevanned = item.devanningDate && item.devanningDate <= todayStr;
                                            const mainDate = parseDate(item.arrivalDate);
                                            const devanDate = item.devanningDate ? parseDate(item.devanningDate) : null;
                                            
                                            const hasAttachments = (item.attachments && item.attachments.length > 0) || item.docUrl;
                                            const attCount = item.attachments ? item.attachments.length : (item.docUrl ? 1 : 0);

                                            return (
                                            <div key={item.id} className={`ios-card overflow-hidden ${selectMode && selectedIds.has(item.id) ? 'ring-2 ring-blue-500' : ''}`} onClick={() => selectMode && toggleSelect(item.id)}>
                                                
                                                {/* ===== é›»è…¦ç‰ˆå¡ç‰‡ ===== */}
                                                <div className="hidden md:block p-4">
                                                    {/* é ­éƒ¨ï¼šä¸‰åˆ—é¡¯ç¤º */}
                                                    <div className="mb-3 pb-3 border-b border-gray-100">
                                                        {/* ç¬¬ä¸€åˆ—ï¼šé€²å£å…¬å¸ã€æ«ƒè™Ÿã€åˆ°æ¸¯æ—¥æœŸ + æ“ä½œæŒ‰éˆ• */}
                                                        <div className="flex items-center gap-3 mb-2">
                                                            {/* V79.3: å¤šé¸å‹¾é¸æ¡† */}
                                                            {selectMode && (
                                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer ${selectedIds.has(item.id) ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300'}`}>
                                                                    {selectedIds.has(item.id) && <I.Check />}
                                                                </div>
                                                            )}
                                                            <span className={`company-tag ${getCompanyColor(item.importCompany)} text-xs`}>{item.importCompany}</span>
                                                            <span className="text-xl font-black text-gray-900 tracking-tight">{item.containerNumber}</span>
                                                            {/* åˆ°æ¸¯æ—¥ - æ°¸é é¡¯ç¤º */}
                                                            <div className="flex items-center gap-1 px-2 py-1 rounded-lg text-sm font-bold bg-gray-50 text-gray-600">
                                                                <span>{mainDate.getMonth()+1}/{mainDate.getDate()}</span>
                                                                <span className="text-xs font-normal">åˆ°æ¸¯</span>
                                                            </div>
                                                            {/* æ‹†æ«ƒæ—¥ - æœ‰æ‹†æ«ƒæ—¥æ‰é¡¯ç¤º */}
                                                            {isDevanned && devanDate && (
                                                                <div className="flex items-center gap-1 px-2 py-1 rounded-lg text-sm font-bold bg-green-50 text-green-700">
                                                                    <span>{devanDate.getMonth()+1}/{devanDate.getDate()}</span>
                                                                    <span className="text-xs font-normal">å·²æ‹†æ«ƒ</span>
                                                                </div>
                                                            )}
                                                            <div className="flex-1"></div>
                                                            <div className="flex gap-1" onClick={e => e.stopPropagation()}>
                                                                {((item.attachments && item.attachments.length > 0) || item.docUrl) && (
                                                                    <button onClick={(e)=>handleAttachmentClick(e, item)} title="æª¢è¦–é™„ä»¶" className="text-blue-500 hover:bg-blue-50 p-1.5 rounded-full relative"><I.Paperclip />{(item.attachments?.length || (item.docUrl ? 1 : 0)) > 1 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-3.5 h-3.5 flex items-center justify-center rounded-full">{item.attachments?.length || 1}</span>}</button>
                                                                )}
                                                                {canEdit() && <button onClick={(e)=>{e.stopPropagation(); handleEdit(item)}} title="ç·¨è¼¯è²¨æ«ƒ" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Edit /></button>}
                                                                <button onClick={(e)=>{e.stopPropagation(); handleShareToLine(item)}} title="åˆ†äº«åˆ° LINE" className="text-green-500 hover:text-green-600 p-1.5"><I.MessageCircle /></button>
                                                                {canCreate() && <button onClick={(e)=>{e.stopPropagation(); handleDuplicateShipment(item)}} title="è¤‡è£½è²¨æ«ƒ" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Copy /></button>}
                                                                {canDelete() && <button onClick={(e)=>{e.stopPropagation(); handleDelete(item.id)}} title="åˆªé™¤è²¨æ«ƒ" className="text-gray-400 hover:text-red-600 p-1.5"><I.Trash2 /></button>}
                                                            </div>
                                                        </div>
                                                        {/* ç¬¬äºŒåˆ—ï¼šå» å•†ã€åºè™Ÿã€ç”¢åœ°ã€å ±é—œè¡Œã€èˆ¹å…¬å¸ */}
                                                        <div className="flex items-center gap-4 text-sm mb-1">
                                                            <span className="flex items-center gap-1"><span className="text-gray-400">å» å•†:</span><span className="font-bold text-gray-800">{item.supplier}</span>{item.vendorSeqNo && <span className="ml-1 px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-mono font-bold">{item.vendorSeqNo}</span>}</span>
                                                            {item.origin && <span className="flex items-center gap-1"><span className="text-gray-400">ç”¢åœ°:</span><span className="font-bold text-gray-800">{item.origin}</span></span>}
                                                            {item.customsBroker && <span className="flex items-center gap-1"><span className="text-gray-400">å ±é—œè¡Œ:</span><span className="font-bold text-gray-800">{item.customsBroker}</span></span>}
                                                            {item.shippingCompany && <span className="flex items-center gap-1"><span className="text-gray-400">èˆ¹å…¬å¸:</span><span className="font-bold text-gray-800">{item.shippingCompany}</span></span>}
                                                        </div>
                                                        {/* ç¬¬ä¸‰åˆ—ï¼šæ‹†æ«ƒåœ°é»ã€æ‹†æ«ƒæ—¥ï¼ˆå¦‚æœ‰ï¼‰ */}
                                                        {(item.devanningLocation || item.devanningDate) && (
                                                            <div className="flex items-center gap-4 text-sm">
                                                                {item.devanningLocation && <span className="flex items-center gap-1"><span className="text-gray-400">æ‹†æ«ƒåœ°:</span><span className="font-bold text-blue-600">{item.devanningLocation}</span></span>}
                                                                {item.devanningDate && <span className="flex items-center gap-1"><span className="text-gray-400">æ‹†æ«ƒæ—¥:</span><span className="font-bold text-blue-600">{item.devanningDate}</span></span>}
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* ç”¢å“æ˜ç´°ï¼šè¡¨æ ¼å¼ */}
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="text-gray-500 border-b border-gray-200">
                                                                <th className="text-left py-2 font-medium">å“å</th>
                                                                <th className="text-left py-2 font-medium">è¦æ ¼</th>
                                                                <th className="text-right py-2 font-medium w-20">ä»¶æ•¸</th>
                                                                {canSeePrice() && <th className="text-right py-2 font-medium w-28">é‡é‡</th>}
                                                                {canSeePrice() && <th className="text-right py-2 font-medium w-20">å–®åƒ¹</th>}
                                                                {canSeePrice() && <th className="text-right py-2 font-medium w-28">é‡‘é¡</th>}
                                                                <th className="text-left py-2 font-medium pl-4">æ‰¹è™Ÿ/æ•ˆæœŸ</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {(item.products || []).map((p,i)=>(
                                                                <tr key={i} className="border-b border-gray-50 last:border-0">
                                                                    <td className="py-2 font-bold text-gray-900">{p.name}</td>
                                                                    <td className="py-2 text-gray-600">{p.spec || '-'}</td>
                                                                    <td className="py-2 text-right font-mono text-base text-blue-600">{safeNum(p.quantity).toLocaleString()}</td>
                                                                    {canSeePrice() && <td className="py-2 text-right font-mono text-base text-orange-600">{format2(safeNum(p.weight))}kg</td>}
                                                                    {canSeePrice() && <td className="py-2 text-right font-mono text-base">${format2(safeNum(p.unitPrice))}</td>}
                                                                    {canSeePrice() && <td className="py-2 text-right font-mono text-base text-emerald-600">${format2(safeNum(p.amount))}</td>}
                                                                    <td className="py-2 text-gray-500 pl-4">{(p.batchNumber || p.expiryDate) ? <>{p.batchNumber && <span className="mr-2">{p.batchNumber}</span>}{p.expiryDate && <span>{p.expiryDate}</span>}</> : '-'}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                        <tfoot>
                                                            <tr className="border-t-2 border-gray-200 font-bold">
                                                                <td className="py-2" colSpan="2">åˆè¨ˆ</td>
                                                                <td className="py-2 text-right font-mono text-base text-blue-700">{totalQty.toLocaleString()}</td>
                                                                {canSeePrice() && <td className="py-2 text-right font-mono text-base text-orange-700">{format2(totalWeight)}kg</td>}
                                                                {canSeePrice() && <td className="py-2"></td>}
                                                                {canSeePrice() && <td className="py-2 text-right font-mono text-base text-emerald-700">{currSymbol}{format2(totalAmount)}</td>}
                                                                <td className="py-2"></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                    
                                                    {/* ç‹€æ…‹åˆ— */}
                                                    <div className="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                                                        <div className="flex gap-3">
                                                            {canSeePrice() && (
                                                                <>
                                                                    <span className={`text-sm font-medium ${item.isPaid ? 'text-green-600' : 'text-red-500'}`}>{item.isPaid ? 'âœ“ è²¨æ¬¾å·²ä»˜' : 'âœ— è²¨æ¬¾æœªä»˜'}</span>
                                                                    {item.flightFee > 0 && <span className={`text-sm font-medium ${item.flightFeePaid ? 'text-green-600' : 'text-red-500'}`}>{item.flightFeePaid ? 'âœ“ æ—…è²»å·²ä»˜' : 'âœ— æ—…è²»æœªä»˜'}</span>}
                                                                </>
                                                            )}
                                                        </div>
                                                        <label className={`flex items-center gap-1 text-sm cursor-pointer px-3 py-1.5 rounded-lg border ${item.warehouseConfirmed ? 'bg-green-100 border-green-200 text-green-700 font-bold' : 'bg-white border-gray-200 text-gray-400'}`} onClick={e => e.stopPropagation()}>
                                                            <input type="checkbox" className="w-4 h-4 rounded accent-green-600" checked={item.warehouseConfirmed || false} onChange={(e) => handleWarehouseConfirm(e, item)} disabled={!canEditWarehouseFields()} />
                                                            <span>{item.warehouseConfirmed ? 'å·²æ”¶è²¨' : 'ç¢ºèªæ”¶è²¨'}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                {/* ===== æ‰‹æ©Ÿç‰ˆå¡ç‰‡ ===== */}
                                                <div className="md:hidden">
                                                    {/* é ­éƒ¨ */}
                                                    <div className="p-3 pb-2">
                                                        {/* ç¬¬ä¸€è¡Œï¼šå…¬å¸ + æ“ä½œ */}
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div className="flex items-center gap-2">
                                                                {/* V79.3: å¤šé¸å‹¾é¸æ¡† */}
                                                                {selectMode && (
                                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${selectedIds.has(item.id) ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300'}`}>
                                                                        {selectedIds.has(item.id) && <I.Check />}
                                                                    </div>
                                                                )}
                                                                <span className={`company-tag ${getCompanyColor(item.importCompany)} text-xs`}>{item.importCompany}</span>
                                                            </div>
                                                            <div className="flex gap-0.5" onClick={e => e.stopPropagation()}>
                                                                {((item.attachments && item.attachments.length > 0) || item.docUrl) && (
                                                                    <button onClick={(e)=>handleAttachmentClick(e, item)} title="æª¢è¦–é™„ä»¶" className="text-blue-500 hover:bg-blue-50 p-1.5 rounded-full relative"><I.Paperclip />{(item.attachments?.length || (item.docUrl ? 1 : 0)) > 1 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-3.5 h-3.5 flex items-center justify-center rounded-full">{item.attachments?.length || 1}</span>}</button>
                                                                )}
                                                                {canEdit() && <button onClick={(e)=>{e.stopPropagation(); handleEdit(item)}} title="ç·¨è¼¯è²¨æ«ƒ" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Edit /></button>}
                                                                <button onClick={(e)=>{e.stopPropagation(); handleShareToLine(item)}} title="åˆ†äº«åˆ° LINE" className="text-green-500 hover:text-green-600 p-1.5"><I.MessageCircle /></button>
                                                                {canCreate() && <button onClick={(e)=>{e.stopPropagation(); handleDuplicateShipment(item)}} title="è¤‡è£½è²¨æ«ƒ" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Copy /></button>}
                                                                {canDelete() && <button onClick={(e)=>{e.stopPropagation(); handleDelete(item.id)}} title="åˆªé™¤è²¨æ«ƒ" className="text-gray-400 hover:text-red-600 p-1.5"><I.Trash2 /></button>}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* ç¬¬äºŒè¡Œï¼šæ«ƒè™Ÿ + æ—¥æœŸ */}
                                                        <div className="flex justify-between items-center mb-3">
                                                            <div className="text-xl font-black text-gray-900 tracking-tight">{item.containerNumber}</div>
                                                            <div className="flex items-center gap-2">
                                                                {/* åˆ°æ¸¯æ—¥ - æ°¸é é¡¯ç¤º */}
                                                                <div className="px-2 py-1 rounded-lg text-sm font-bold bg-gray-50 text-gray-600 border border-gray-200">
                                                                    <span className="text-xs font-normal mr-1">åˆ°æ¸¯</span>{mainDate.getMonth()+1}/{mainDate.getDate()}
                                                                </div>
                                                                {/* æ‹†æ«ƒæ—¥ - æœ‰æ‹†æ«ƒæ—¥æ‰é¡¯ç¤º */}
                                                                {isDevanned && devanDate && (
                                                                    <div className="px-2 py-1 rounded-lg text-sm font-bold bg-green-50 text-green-700 border border-green-200">
                                                                        <span className="text-xs font-normal mr-1">æ‹†æ«ƒ</span>{devanDate.getMonth()+1}/{devanDate.getDate()}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* å…©æ¬„å°ç¨±å¼è³‡è¨Š */}
                                                        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm border-t border-gray-100 pt-2">
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">å» å•†</span><span className="text-gray-700 font-medium truncate ml-2">{item.supplier}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">åºè™Ÿ</span><span className="text-purple-600 font-mono font-bold ml-2">{item.vendorSeqNo || '-'}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">ç”¢åœ°</span><span className="text-gray-700 font-medium truncate ml-2">{item.origin || '-'}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">èˆ¹å…¬å¸</span><span className="text-gray-700 font-medium truncate ml-2">{item.shippingCompany || '-'}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">å ±é—œè¡Œ</span><span className="text-gray-700 font-medium truncate ml-2">{item.customsBroker || '-'}</span></div>
                                                            {(item.devanningLocation || item.devanningDate) && (
                                                                <>
                                                                    <div className="flex justify-between"><span className="text-gray-400 shrink-0">æ‹†æ«ƒåœ°</span><span className="text-blue-600 font-medium truncate ml-2">{item.devanningLocation || '-'}</span></div>
                                                                    <div className="flex justify-between"><span className="text-gray-400 shrink-0">æ‹†æ«ƒæ—¥</span><span className="text-blue-600 font-medium truncate ml-2">{item.devanningDate || '-'}</span></div>
                                                                </>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* ç”¢å“æ˜ç´°ï¼šç²¾ç°¡æŠ˜ç–Šå¼ */}
                                                    <div className="border-t border-gray-100 px-3 py-2 space-y-1">
                                                        {(item.products || []).map((p,i)=>(
                                                            <details key={i} className="group border-b border-gray-50 last:border-0">
                                                                <summary className="flex items-center justify-between py-2 cursor-pointer list-none">
                                                                    <div className="flex-1 min-w-0">
                                                                        {/* ç¬¬ä¸€åˆ—ï¼šå“å */}
                                                                        <div className="font-bold text-gray-900 text-base truncate">{p.name}</div>
                                                                        {/* ç¬¬äºŒåˆ—ï¼šè¦æ ¼ + ä»¶æ•¸ */}
                                                                        <div className="flex items-center gap-2 text-base">
                                                                            {p.spec && <span className="text-gray-500 truncate">{p.spec}</span>}
                                                                            <span className="font-mono font-bold text-blue-600">{safeNum(p.quantity).toLocaleString()}ä»¶</span>
                                                                        </div>
                                                                    </div>
                                                                    {/* å³å´ï¼šå±•é–‹ç®­é ­ */}
                                                                    <span className="text-gray-400 text-sm group-open:rotate-90 transition-transform ml-2">â–¶</span>
                                                                </summary>
                                                                {/* ç¬¬ä¸‰åˆ—ï¼ˆæŠ˜ç–Šï¼‰ï¼šé‡é‡ã€å–®åƒ¹ã€é‡‘é¡ã€æ‰¹è™Ÿã€æ•ˆæœŸ */}
                                                                <div className="pb-2 pl-2 border-l-2 border-blue-100 ml-1 mb-2 text-base">
                                                                    <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                                                                        {canSeePrice() && <div className="flex justify-between"><span className="text-gray-400">é‡é‡</span><span className="font-mono text-orange-600">{format2(safeNum(p.weight))}kg</span></div>}
                                                                        {canSeePrice() && <div className="flex justify-between"><span className="text-gray-400">å–®åƒ¹</span><span className="font-mono">${format2(safeNum(p.unitPrice))}</span></div>}
                                                                        {canSeePrice() && <div className="flex justify-between"><span className="text-gray-400">é‡‘é¡</span><span className="font-mono font-bold text-emerald-600">${format2(safeNum(p.amount))}</span></div>}
                                                                        {p.batchNumber && <div className="flex justify-between"><span className="text-gray-400">æ‰¹è™Ÿ</span><span className="text-gray-700">{p.batchNumber}</span></div>}
                                                                        {p.expiryDate && <div className="flex justify-between"><span className="text-gray-400">æ•ˆæœŸ</span><span className="text-gray-700">{p.expiryDate}</span></div>}
                                                                    </div>
                                                                </div>
                                                            </details>
                                                        ))}
                                                    </div>
                                                    
                                                    {/* åˆè¨ˆå€ */}
                                                    <div className="bg-gray-50 px-3 py-2 border-t border-gray-200">
                                                        {/* åˆè¨ˆæ•¸å­— */}
                                                        <div className="flex items-center text-base font-mono font-bold mb-2">
                                                            <span className="text-blue-700">{totalQty.toLocaleString()}ä»¶</span>
                                                            {canSeePrice() && (
                                                                <>
                                                                    <span className="text-gray-300 mx-2">Â·</span>
                                                                    <span className="text-orange-600">{format2(totalWeight)}kg</span>
                                                                    <span className="flex-1"></span>
                                                                    <span className="text-emerald-700 text-base">{currSymbol}{format2(totalAmount)}</span>
                                                                </>
                                                            )}
                                                        </div>
                                                        {/* ç‹€æ…‹åˆ— */}
                                                        <div className="flex justify-between items-center pt-2 border-t border-gray-200">
                                                            <div className="flex gap-2">
                                                                {canSeePrice() && (
                                                                    <>
                                                                        <span className={`text-xs font-medium ${item.isPaid ? 'text-green-600' : 'text-red-500'}`}>{item.isPaid ? 'âœ“è²¨æ¬¾å·²ä»˜' : 'âœ—æœªä»˜æ¬¾'}</span>
                                                                        {item.flightFee > 0 && <span className={`text-xs font-medium ${item.flightFeePaid ? 'text-green-600' : 'text-red-500'}`}>{item.flightFeePaid ? 'âœ“æ—…è²»å·²ä»˜' : 'âœ—æ—…è²»æœªä»˜'}</span>}
                                                                    </>
                                                                )}
                                                            </div>
                                                            <label className={`flex items-center gap-1 text-xs cursor-pointer px-2 py-1 rounded-lg border ${item.warehouseConfirmed ? 'bg-green-100 border-green-200 text-green-700 font-bold' : 'bg-white border-gray-200 text-gray-400'}`} onClick={e => e.stopPropagation()}>
                                                                <input type="checkbox" className="w-3.5 h-3.5 rounded accent-green-600" checked={item.warehouseConfirmed || false} onChange={(e) => handleWarehouseConfirm(e, item)} disabled={!canEditWarehouseFields()} />
                                                                <span>{item.warehouseConfirmed ? 'å·²æ”¶è²¨' : 'ç¢ºèªæ”¶è²¨'}</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {view === 'stats' && <Dashboard shipments={shipments} canSeePrice={canSeePrice} />}

                        {/* V75.0: ç”¢å“ä¸»æª”é é¢ */}
                        {view === 'products' && (
                            <div className="space-y-4">
                                {/* é ‚éƒ¨æ“ä½œåˆ— */}
                                <div className="flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-between">
                                    <div className="relative flex-1">
                                        <input 
                                            type="text" 
                                            placeholder={TEXT.PRODUCTS_SEARCH_HINT}
                                            value={productSearchTerm}
                                            onChange={e => setProductSearchTerm(e.target.value)}
                                            className="w-full pl-10 pr-4 py-3 bg-white border rounded-xl text-base"
                                        />
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><I.Search /></span>
                                    </div>
                                    {canCreate() && (
                                        <div className="flex gap-2">
                                            <label className="flex-1 md:flex-none px-4 py-3 bg-emerald-500 text-white rounded-xl font-bold text-sm cursor-pointer hover:bg-emerald-600 transition-colors flex items-center justify-center gap-2">
                                                <I.Upload />{TEXT.PRODUCTS_IMPORT}
                                                <input type="file" accept=".xlsx,.xls" onChange={handleProductExcelImport} className="hidden" />
                                            </label>
                                            <button 
                                                onClick={() => { setEditingProduct({...initialProductState}); setShowProductModal(true); }}
                                                className="flex-1 md:flex-none px-4 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                                            >
                                                <I.Plus />{TEXT.PRODUCTS_ADD}
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* çµ±è¨ˆè³‡è¨Š */}
                                <div className="bg-white rounded-xl p-3 border shadow-sm">
                                    <div className="flex justify-around md:justify-start md:gap-6 text-sm">
                                        <div className="text-center md:text-left"><div className="text-gray-400 text-xs">ç¸½ç”¢å“</div><div className="font-bold text-blue-600 text-lg">{products.length}</div></div>
                                        <div className="text-center md:text-left"><div className="text-gray-400 text-xs">å•Ÿç”¨ä¸­</div><div className="font-bold text-emerald-600 text-lg">{products.filter(p => p.isActive !== false).length}</div></div>
                                        <div className="text-center md:text-left"><div className="text-gray-400 text-xs">æœå°‹çµæœ</div><div className="font-bold text-lg">{filteredProducts.length}</div></div>
                                    </div>
                                </div>

                                {/* ç”¢å“åˆ—è¡¨ */}
                                {filteredProducts.length === 0 ? (
                                    <div className="bg-white rounded-xl p-8 border shadow-sm text-center text-gray-400">
                                        {products.length === 0 ? TEXT.PRODUCTS_EMPTY : 'ç„¡ç¬¦åˆæœå°‹æ¢ä»¶çš„ç”¢å“'}
                                    </div>
                                ) : (
                                    <>
                                        {/* æ‰‹æ©Ÿç‰ˆï¼šå¡ç‰‡å¼ */}
                                        <div className="md:hidden space-y-3">
                                            {filteredProducts.slice(0, 100).map((p) => (
                                                <div key={p.id} className={`bg-white rounded-xl border shadow-sm p-4 ${p.isActive === false ? 'opacity-60 bg-gray-50' : ''}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-bold text-base text-gray-900 truncate">
                                                                {p.name}
                                                                {p.isActive === false && <span className="text-xs text-red-500 ml-2">({TEXT.PRODUCT_INACTIVE})</span>}
                                                            </div>
                                                            {p.spec && <div className="text-sm text-gray-500 truncate">{p.spec}</div>}
                                                        </div>
                                                        <div className="flex gap-1 ml-2">
                                                            <button onClick={() => { setEditingProduct({...p}); setShowProductModal(true); }} className="text-blue-500 p-2"><I.Edit /></button>
                                                            {canDelete() && <button onClick={() => handleDeleteProduct(p)} className="text-red-400 p-2"><I.Trash2 /></button>}
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">ç”¢å“ç·¨è™Ÿ</span>
                                                            <span className="font-mono text-gray-600">{p.productId || '-'}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">å–®ä½</span>
                                                            <span className="text-gray-700">{p.unit || '-'}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">é è¨­å–®åƒ¹</span>
                                                            <span className="font-bold text-emerald-600">{p.defaultPrice > 0 ? `$${p.defaultPrice.toLocaleString()}` : '-'}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">é è¨­å» å•†</span>
                                                            <span className="text-gray-700 truncate ml-2">{p.defaultSupplier || '-'}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredProducts.length > 100 && (
                                                <div className="text-center py-3 text-gray-400 text-sm">
                                                    é¡¯ç¤ºå‰ 100 ç­†ï¼Œå…± {filteredProducts.length} ç­†
                                                </div>
                                            )}
                                        </div>

                                        {/* é›»è…¦ç‰ˆï¼šè¡¨æ ¼å¼ */}
                                        <div className="hidden md:block bg-white rounded-xl border shadow-sm overflow-hidden">
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-gray-50 border-b">
                                                        <tr>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_ID}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_NAME}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_SPEC}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_UNIT}</th>
                                                            <th className="px-3 py-3 text-right font-bold text-gray-600">{TEXT.PRODUCT_DEFAULT_PRICE}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_DEFAULT_SUPPLIER}</th>
                                                            <th className="px-3 py-3 text-center font-bold text-gray-600">æ“ä½œ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {filteredProducts.slice(0, 100).map((p, idx) => (
                                                            <tr key={p.id} className={`border-b hover:bg-blue-50 cursor-pointer ${p.isActive === false ? 'opacity-50 bg-gray-50' : ''} ${idx % 2 === 0 ? '' : 'bg-gray-50/50'}`}
                                                                onClick={() => { setEditingProduct({...p}); setShowProductModal(true); }}>
                                                                <td className="px-3 py-2.5 font-mono text-xs text-gray-500">{p.productId}</td>
                                                                <td className="px-3 py-2.5 font-bold">{p.name} {p.isActive === false && <span className="text-xs text-red-500 ml-1">({TEXT.PRODUCT_INACTIVE})</span>}</td>
                                                                <td className="px-3 py-2.5 text-gray-600">{p.spec || '-'}</td>
                                                                <td className="px-3 py-2.5 text-gray-500">{p.unit || '-'}</td>
                                                                <td className="px-3 py-2.5 text-right text-emerald-600 font-bold">{p.defaultPrice > 0 ? p.defaultPrice.toLocaleString() : '-'}</td>
                                                                <td className="px-3 py-2.5 text-gray-500">{p.defaultSupplier || '-'}</td>
                                                                <td className="px-3 py-2.5 text-center">
                                                                    <button onClick={(e) => { e.stopPropagation(); setEditingProduct({...p}); setShowProductModal(true); }} className="text-blue-500 hover:text-blue-700 p-1"><I.Edit /></button>
                                                                    {canDelete() && <button onClick={(e) => { e.stopPropagation(); handleDeleteProduct(p); }} className="text-red-400 hover:text-red-600 p-1 ml-1"><I.Trash2 /></button>}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            {filteredProducts.length > 100 && (
                                                <div className="text-center py-3 text-gray-400 text-sm border-t">
                                                    é¡¯ç¤ºå‰ 100 ç­†ï¼Œå…± {filteredProducts.length} ç­†ï¼ˆè«‹ä½¿ç”¨æœå°‹ç¸®å°ç¯„åœï¼‰
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {view === 'form' && (
                            <div className="ios-card p-4 md:p-5 animate-[fade-in_0.3s_ease-out]">
                                {/* V78.5: æ··åˆæ¨¡å¼è¡¨å–® - æ–°å¢ç”¨åˆ†æ­¥é©Ÿï¼Œç·¨è¼¯ç”¨æŠ˜ç–Š */}
                                
                                {/* é ­éƒ¨ */}
                                <div className="flex justify-between items-center mb-4 pb-3 border-b">
                                    <div className="flex items-center gap-3">
                                        {!editingId && formStep > 1 && (
                                            <button type="button" onClick={() => setFormStep(formStep - 1)} className="text-gray-400 p-1">
                                                <I.ChevronLeft />
                                            </button>
                                        )}
                                        <h2 className="font-bold text-lg">{editingId ? 'ç·¨è¼¯è²¨æ«ƒ' : 'æ–°å¢è²¨æ«ƒ'}</h2>
                                    </div>
                                    {editingId ? (
                                        <button onClick={()=>setView('list')} className="text-gray-400 p-1"><I.X /></button>
                                    ) : (
                                        <div className="text-sm text-gray-500">{formStep}/4</div>
                                    )}
                                </div>
                                
                                {/* æ­¥é©ŸæŒ‡ç¤ºå™¨ (åƒ…æ–°å¢æ¨¡å¼ä¸”ç‚ºæ‰‹æ©Ÿç‰ˆ) */}
                                {!editingId && (
                                    <div className="step-indicator md:hidden">
                                        {[1,2,3,4].map(s => (
                                            <div key={s} className={`step-dot ${formStep === s ? 'active' : ''} ${formStep > s ? 'done' : ''}`} />
                                        ))}
                                    </div>
                                )}
                                
                                {/* V79.0: å·²è§£ææ–‡ä»¶é è¦½å€åŸŸ */}
                                {parsedDocuments.length > 0 && !editingId && (
                                    <div className="mb-4 p-3 bg-gradient-to-r from-emerald-50 to-blue-50 rounded-xl border border-emerald-200">
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="flex items-center gap-2 text-sm font-bold text-gray-700">
                                                <I.FileCheck />
                                                <span>å·²è¼‰å…¥ {parsedDocuments.length} ä»½æ–‡ä»¶</span>
                                            </div>
                                            <label className="text-xs text-blue-600 font-bold cursor-pointer hover:underline flex items-center gap-1">
                                                <I.FilePlus />
                                                <span>è£œå……ä¸Šå‚³</span>
                                                <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handleSupplementUpload} className="hidden" />
                                            </label>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {parsedDocuments.map(doc => (
                                                <div key={doc.id} className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm shadow-sm ${doc.isScanned ? 'bg-blue-50 border-blue-200' : 'bg-white'}`}>
                                                    <span>{doc.icon}</span>
                                                    <span className={`font-medium ${doc.isScanned ? 'text-blue-700' : 'text-gray-700'}`}>{doc.label}</span>
                                                    <button type="button" onClick={() => handleRemoveDocument(doc.id)} className="text-gray-400 hover:text-red-500 ml-1">
                                                        <I.X />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <form onSubmit={handleSubmit}>
                                    {/* ===== æ–°å¢æ¨¡å¼ï¼šæ‰‹æ©Ÿåˆ†æ­¥é©Ÿ / é›»è…¦å…¨é¡¯ç¤º ===== */}
                                    {!editingId && (
                                        <>
                                            {/* æ‰‹æ©Ÿç‰ˆï¼šåˆ†æ­¥é©Ÿ */}
                                            <div className="md:hidden">
                                                {/* æ­¥é©Ÿ 1: åŸºæœ¬è³‡è¨Š */}
                                                {formStep === 1 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">åŸºæœ¬è³‡è¨Š</div></div>
                                                        
                                                        {/* V79.0: ç›¸é—œæ–‡ä»¶åƒè€ƒ */}
                                                        {(getDocumentByType('invoice') || getDocumentByType('packing')) && (
                                                            <details className="bg-blue-50 rounded-xl border border-blue-200 overflow-hidden">
                                                                <summary className="px-4 py-3 cursor-pointer font-bold text-sm text-blue-700 flex items-center gap-2">
                                                                    <I.Eye /> åƒè€ƒæ–‡ä»¶å…§å®¹ï¼ˆInvoice / Packing Listï¼‰
                                                                </summary>
                                                                <div className="px-4 pb-4 max-h-48 overflow-y-auto">
                                                                    {getDocumentByType('invoice') && (
                                                                        <div className="mb-3">
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">ğŸ“„ {getDocumentByType('invoice').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('invoice').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                    {getDocumentByType('packing') && (
                                                                        <div>
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">ğŸ“¦ {getDocumentByType('packing').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('packing').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </details>
                                                        )}
                                                        
                                                        <div><label className="form-label-lg">é€²å£å…¬å¸</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} className="form-input-lg">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label className="form-label-lg">æ«ƒè™Ÿ <span className="required">*</span></label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} className={`form-input-lg font-mono uppercase ${validationErrors.containerNumber ? 'error' : ''}`} placeholder="è¼¸å…¥æ«ƒè™Ÿ" /></div>
                                                        <div><label className="form-label-lg">åˆ°æ¸¯æ—¥ <span className="required">*</span></label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} className={`form-input-lg ${validationErrors.arrivalDate ? 'error' : ''}`} /></div>
                                                        <div><label className="form-label-lg">å» å•† <span className="required">*</span></label><input name="supplier" value={formData.supplier} onChange={handleInputChange} className={`form-input-lg ${validationErrors.supplier ? 'error' : ''}`} placeholder="è¼¸å…¥å» å•†åç¨±" /></div>
                                                        <div><label className="form-label-lg">å» å•†åºè™Ÿ</label><div className="flex gap-2"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} className="form-input-lg font-mono flex-1" placeholder="å¦‚ 26-01" /><button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-3 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold whitespace-nowrap">è‡ªå‹•</button></div></div>
                                                        <div><label className="form-label-lg">ç”¢åœ°</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} className="form-input-lg" placeholder="è¼¸å…¥ç”¢åœ°" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        <button type="button" onClick={() => setFormStep(2)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg mt-4">ä¸‹ä¸€æ­¥ï¼šå ±é—œè³‡è¨Š â†’</button>
                                                        <button type="button" onClick={()=>setView('list')} className="w-full py-3 text-gray-500 font-bold">å–æ¶ˆ</button>
                                                    </div>
                                                )}
                                                
                                                {/* æ­¥é©Ÿ 2: å ±é—œè³‡è¨Š */}
                                                {formStep === 2 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">å ±é—œè³‡è¨Š</div></div>
                                                        
                                                        {/* V79.0: ç›¸é—œæ–‡ä»¶åƒè€ƒ */}
                                                        {(getDocumentByType('bl') || getDocumentByType('arrival')) && (
                                                            <details className="bg-blue-50 rounded-xl border border-blue-200 overflow-hidden">
                                                                <summary className="px-4 py-3 cursor-pointer font-bold text-sm text-blue-700 flex items-center gap-2">
                                                                    <I.Eye /> åƒè€ƒæ–‡ä»¶å…§å®¹ï¼ˆB/L / åˆ°è²¨é€šçŸ¥ï¼‰
                                                                </summary>
                                                                <div className="px-4 pb-4 max-h-48 overflow-y-auto">
                                                                    {getDocumentByType('bl') && (
                                                                        <div className="mb-3">
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">ğŸš¢ {getDocumentByType('bl').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('bl').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                    {getDocumentByType('arrival') && (
                                                                        <div>
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">ğŸ“¬ {getDocumentByType('arrival').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('arrival').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </details>
                                                        )}
                                                        
                                                        {/* è£œå……ä¸Šå‚³å€ */}
                                                        {parsedDocuments.length > 0 && !getDocumentByType('bl') && !getDocumentByType('arrival') && (
                                                            <label className="flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 text-sm text-gray-500">
                                                                <I.FilePlus /> è£œå……ä¸Šå‚³ B/L æˆ–åˆ°è²¨é€šçŸ¥
                                                                <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handleSupplementUpload} className="hidden" />
                                                            </label>
                                                        )}
                                                        
                                                        <div><label className="form-label-lg">èˆ¹å…¬å¸</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} className="form-input-lg" placeholder="è¼¸å…¥èˆ¹å…¬å¸" /></div>
                                                        <div><label className="form-label-lg">å ±é—œè¡Œ</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} className="form-input-lg">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label className="form-label-lg">å ±é—œå–®è™Ÿ</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} className="form-input-lg" placeholder="è¼¸å…¥å ±é—œå–®è™Ÿ" /></div>
                                                        <div><label className="form-label-lg">è¼¸å…¥è¨±å¯è­‰</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} className="form-input-lg" placeholder="è¼¸å…¥è¨±å¯è­‰è™Ÿ" /></div>
                                                        <div><label className="form-label-lg">æ‹†æ«ƒåœ°é»</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} className="form-input-lg" placeholder="è¼¸å…¥æ‹†æ«ƒåœ°é»" /></div>
                                                        <div><label className="form-label-lg">æ‹†æ«ƒæ—¥æœŸ</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} className="form-input-lg" /></div>
                                                        <button type="button" onClick={() => setFormStep(3)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg mt-4">ä¸‹ä¸€æ­¥ï¼šä»˜æ¬¾è³‡è¨Š â†’</button>
                                                    </div>
                                                )}
                                                
                                                {/* æ­¥é©Ÿ 3: ä»˜æ¬¾è³‡è¨Š */}
                                                {formStep === 3 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">ä»˜æ¬¾è³‡è¨Š</div></div>
                                                        {canSeePrice() ? (<>
                                                            <div><label className="form-label-lg">ä»˜æ¬¾æ¢ä»¶</label><input value={formData.paymentTerm} disabled className="form-input-lg" /></div>
                                                            {isForeign(formData) && (<div><label className="form-label-lg">æ—…è²»</label><input type="text" inputMode="decimal" name="flightFee" value={formData.flightFee} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleInputChange({target:{name:'flightFee',value:e.target.value.replace(/[^\d.-]/g,''),type:'text'}})} className="form-input-lg num-input" placeholder="0" /></div>)}
                                                            <div className="bg-gray-50 p-4 rounded-xl space-y-4">
                                                                <label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} className="w-6 h-6 accent-green-600"/><span className="font-bold text-green-700 text-lg">è²¨æ¬¾å·²ä»˜</span></label>
                                                                {isForeign(formData) && (<label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} className="w-6 h-6 accent-red-600"/><span className="font-bold text-red-700 text-lg">æ—…è²»å·²ä»˜</span></label>)}
                                                            </div>
                                                        </>) : (<div className="text-center text-gray-400 py-8">ç„¡æ¬Šé™æŸ¥çœ‹ä»˜æ¬¾è³‡è¨Š</div>)}
                                                        <button type="button" onClick={() => setFormStep(4)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg mt-4">ä¸‹ä¸€æ­¥ï¼šç”¢å“æ˜ç´° â†’</button>
                                                    </div>
                                                )}
                                                
                                                {/* æ­¥é©Ÿ 4: ç”¢å“æ˜ç´° */}
                                                {formStep === 4 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">ç”¢å“æ˜ç´°</div></div>
                                                        
                                                        {/* V79.0: ç›¸é—œæ–‡ä»¶åƒè€ƒ */}
                                                        {(getDocumentByType('invoice') || getDocumentByType('expiry')) && (
                                                            <details className="bg-blue-50 rounded-xl border border-blue-200 overflow-hidden">
                                                                <summary className="px-4 py-3 cursor-pointer font-bold text-sm text-blue-700 flex items-center gap-2">
                                                                    <I.Eye /> åƒè€ƒæ–‡ä»¶å…§å®¹ï¼ˆInvoice / æ‰¹è™Ÿæ•ˆæœŸï¼‰
                                                                </summary>
                                                                <div className="px-4 pb-4 max-h-48 overflow-y-auto">
                                                                    {getDocumentByType('invoice') && (
                                                                        <div className="mb-3">
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">ğŸ“„ {getDocumentByType('invoice').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('invoice').text.substring(0, 2000)}...</pre>
                                                                        </div>
                                                                    )}
                                                                    {getDocumentByType('expiry') && (
                                                                        <div>
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">ğŸ“‹ {getDocumentByType('expiry').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('expiry').text}</pre>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </details>
                                                        )}
                                                        
                                                        {/* è£œå……ä¸Šå‚³å€ */}
                                                        {parsedDocuments.length > 0 && !getDocumentByType('expiry') && (
                                                            <label className="flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 text-sm text-gray-500">
                                                                <I.FilePlus /> è£œå……ä¸Šå‚³æ‰¹è™Ÿæ•ˆæœŸæ¸…å–®
                                                                <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handleSupplementUpload} className="hidden" />
                                                            </label>
                                                        )}
                                                        
                                                        {validationErrors.products && <div className="text-red-500 text-sm bg-red-50 p-3 rounded-lg">è«‹è‡³å°‘å¡«å¯«ä¸€é …å“å</div>}
                                                        <div className="space-y-4">
                                                            {formData.products.map((p, idx) => (
                                                                <div key={p.id} className={`product-card-lg ${validationErrors.products && idx === 0 && !p.name?.trim() ? 'error' : ''}`}>
                                                                    {/* ç”¢å“ç·¨è™Ÿæ¨™é¡Œ */}
                                                                    <div className="flex items-center justify-between mb-4 pb-2 border-b border-gray-200">
                                                                        <span className="font-bold text-gray-600">ç”¢å“ #{idx + 1}</span>
                                                                        <div className="flex gap-2">
                                                                            <button type="button" onClick={()=>duplicateProductRow(idx)} className="p-2 bg-gray-100 rounded-lg text-gray-500"><I.Copy /></button>
                                                                            {formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="p-2 bg-red-50 rounded-lg text-red-500"><I.Trash2 /></button>}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* å“å */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">å“å <span className="required">*</span></label>
                                                                        <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`product-picker-btn ${!p.name ? 'empty' : ''}`}>
                                                                            <span>{p.name || 'é»æ“Šé¸æ“‡ç”¢å“'}</span>
                                                                            <span>â–¼</span>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* è¦æ ¼ */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">è¦æ ¼</label>
                                                                        <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="form-input-lg" placeholder="è¼¸å…¥è¦æ ¼" />
                                                                    </div>
                                                                    
                                                                    {/* ä»¶æ•¸ */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">ä»¶æ•¸</label>
                                                                        <input type="text" inputMode="decimal" value={p.quantity} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'quantity',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{color:'#2563eb'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* é‡é‡ */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">é‡é‡ (kg)</label>
                                                                        <input type="text" inputMode="decimal" value={p.weight} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'weight',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{color:'#f97316'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* å–®åƒ¹ */}
                                                                    {canSeePrice() && (
                                                                        <div className="mb-4">
                                                                            <label className="form-label-lg">å–®åƒ¹</label>
                                                                            <input type="text" inputMode="decimal" value={p.unitPrice} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" placeholder="0" />
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* è¨ˆåƒ¹æ–¹å¼ */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">è¨ˆåƒ¹æ–¹å¼</label>
                                                                        <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="form-input-lg">
                                                                            <option value="weight">è¨ˆé‡</option>
                                                                            <option value="quantity">è¨ˆä»¶</option>
                                                                        </select>
                                                                    </div>
                                                                    
                                                                    {/* æ‰¹è™Ÿ */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">æ‰¹è™Ÿ</label>
                                                                        <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="form-input-lg" placeholder="è¼¸å…¥æ‰¹è™Ÿ" />
                                                                    </div>
                                                                    
                                                                    {/* æ•ˆæœŸ */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">æ•ˆæœŸ</label>
                                                                        <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="form-input-lg" />
                                                                    </div>
                                                                    
                                                                    {/* é‡‘é¡ */}
                                                                    {canSeePrice() && (
                                                                        <div className="bg-emerald-50 p-4 rounded-xl text-center">
                                                                            <div className="text-sm text-emerald-600 mb-1">å°è¨ˆé‡‘é¡</div>
                                                                            <div className="font-bold text-emerald-700 text-2xl">${format2(safeNum(p.amount))}</div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <button type="button" onClick={addProductRow} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold border-2 border-dashed border-blue-200">+ æ–°å¢ç”¢å“</button>
                                                        <div className="bg-gray-50 p-4 rounded-xl">
                                                            <label className="form-label-lg mb-3">é™„ä»¶ ({formData.attachments?.length || 0})</label>
                                                            {(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-white p-3 rounded-lg border mb-2"><a href={file.url} target="_blank" className="text-blue-600 underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}
                                                            {canUpload() && (<div className="relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-3 bg-white border border-dashed border-gray-300 rounded-lg text-gray-500 font-bold">{uploading ? 'ä¸Šå‚³ä¸­...' : 'ğŸ“ é¸æ“‡æª”æ¡ˆ'}</button></div>)}
                                                        </div>
                                                        <button type="submit" disabled={isSubmitting} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold text-lg mt-4 shadow-lg">{isSubmitting ? 'å„²å­˜ä¸­...' : 'âœ“ å®Œæˆæ–°å¢'}</button>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* é›»è…¦ç‰ˆï¼šå‚³çµ±å…¨é¡¯ç¤º */}
                                            <div className="hidden md:block space-y-4">
                                                <div className="bg-white rounded-xl p-3 border border-gray-200 shadow-sm">
                                                    <div className="grid grid-cols-4 gap-2">
                                                        <div><label>é€²å£å…¬å¸</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label className="label-required">æ«ƒè™Ÿ</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} className={`w-full input-bg-style rounded-lg p-2 font-mono uppercase ${validationErrors.containerNumber ? 'input-error' : ''}`} placeholder="æ«ƒè™Ÿ" /></div>
                                                        <div><label>èˆ¹å…¬å¸</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="èˆ¹å…¬å¸" /></div>
                                                        <div><label className="label-required">åˆ°æ¸¯æ—¥</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} className={`w-full input-bg-style rounded-lg p-2 ${validationErrors.arrivalDate ? 'input-error' : ''}`} /></div>
                                                        <div><label>å ±é—œè¡Œ</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label>å ±é—œå–®è™Ÿ</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="å ±é—œå–®è™Ÿ" /></div>
                                                        <div><label>è¼¸å…¥è¨±å¯è­‰</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="è¨±å¯è­‰è™Ÿ" /></div>
                                                        <div><label className="label-required">å» å•†</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} className={`w-full input-bg-style rounded-lg p-2 ${validationErrors.supplier ? 'input-error' : ''}`} placeholder="å» å•†" /></div>
                                                        <div><label>å» å•†åºè™Ÿ</label><div className="flex gap-1"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} className="flex-1 input-bg-style rounded-lg p-2 font-mono" placeholder="å¦‚ 26-01" /><button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-2 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold">è‡ªå‹•</button></div></div>
                                                        <div><label>ç”¢åœ°</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="ç”¢åœ°" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        <div><label>æ‹†æ«ƒåœ°</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="åœ°é»" /></div>
                                                        <div><label>æ‹†æ«ƒæ—¥</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" /></div>
                                                    </div>
                                                </div>
                                                {canSeePrice() && (
                                                    <div className="bg-blue-50 rounded-xl p-3 border border-blue-100 flex flex-wrap items-end gap-3">
                                                        <div className="flex-1 min-w-[140px]"><label>ä»˜æ¬¾æ¢ä»¶</label><input value={formData.paymentTerm} disabled className="w-full bg-white border rounded input-bg-style text-xs" /></div>
                                                        {canEditFlightFee() && isForeign(formData) && (<div className="w-24"><label>æ—…è²»</label><input type="number" name="flightFee" value={formData.flightFee} onWheel={e=>e.target.blur()} onChange={handleInputChange} className="w-full bg-white border rounded input-bg-style" placeholder="0" /></div>)}
                                                        <div className="flex items-center gap-3 pb-2 ml-auto">
                                                            <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} className="w-5 h-5 accent-green-600"/><span className="font-bold text-green-700 text-xs">è²¨æ¬¾å·²ä»˜</span></label>
                                                            {canEditFlightFee() && isForeign(formData) && <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} className="w-5 h-5 accent-red-600"/><span className="font-bold text-red-700 text-xs">æ—…è²»å·²ä»˜</span></label>}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="pt-2">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h3 className={`font-bold text-lg ${validationErrors.products ? 'text-red-600' : 'text-gray-700'}`}>ç”¢å“æ˜ç´° <span className="text-red-500 text-sm">*</span>{validationErrors.products && <span className="text-red-500 text-xs ml-2">(è«‹è‡³å°‘å¡«å¯«ä¸€é …å“å)</span>}</h3>
                                                        <button type="button" onClick={addProductRow} className="text-blue-600 font-bold text-sm hover:underline cursor-pointer">+ æ–°å¢ç”¢å“</button>
                                                    </div>
                                                    <div className="space-y-3">{formData.products.map((p, idx) => (
                                                        <div key={p.id} className={`bg-white border rounded-xl p-3 shadow-sm ${validationErrors.products && idx === 0 ? 'border-red-300' : ''}`}>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`input-bg-style rounded p-1 font-bold cursor-pointer flex items-center justify-between ${validationErrors.products && idx === 0 && !p.name?.trim() ? 'input-error' : ''} ${products.length > 0 ? 'hover:bg-blue-50' : ''}`}><span className={p.name ? 'text-gray-800' : 'text-gray-400'}>{p.name || 'é»æ“Šé¸æ“‡å“å'}</span>{products.length > 0 && <span className="text-blue-500 text-xs">â–¼</span>}</div>
                                                                <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="è¦æ ¼" />
                                                                <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="input-bg-style rounded p-1 text-sm"><option value="weight">è¨ˆé‡</option><option value="quantity">è¨ˆä»¶</option></select>
                                                                <input type="number" value={p.quantity} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'quantity',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-blue-600" placeholder="ä»¶æ•¸" />
                                                                <input type="number" value={p.weight} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'weight',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-orange-500" placeholder="é‡é‡" />
                                                                {canSeePrice() ? (<input type="number" value={p.unitPrice} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value)} className="input-bg-style rounded p-1 text-right" placeholder="å–®åƒ¹" />) : (<div className="input-bg-style rounded p-1 text-right flex items-center justify-end text-gray-300">***</div>)}
                                                                <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="æ‰¹è™Ÿ" />
                                                                <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="input-bg-style rounded p-1 text-xs" />
                                                                <div className="flex items-center justify-between bg-gray-50 rounded px-2 border border-gray-200">{canSeePrice() ? <span className="font-bold text-emerald-600 text-sm">${format2(safeNum(p.amount))}</span> : <span>***</span>}<div className="flex gap-1"><button type="button" onClick={()=>duplicateProductRow(idx)} className="text-gray-400 hover:text-blue-600 p-1"><I.Copy /></button>{formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="text-gray-400 hover:text-red-600 p-1"><I.Trash2 /></button>}</div></div>
                                                            </div>
                                                        </div>
                                                    ))}</div>
                                                </div>
                                                <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                                    <label className="block text-xs font-bold text-gray-500 mb-2">é™„ä»¶ ({formData.attachments?.length || 0})</label>
                                                    <div className="space-y-2">{(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-white p-2 rounded border"><a href={file.url} target="_blank" className="text-blue-600 text-xs underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}</div>
                                                    {canUpload() && (<div className="mt-2 relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-2 bg-white border border-dashed border-gray-400 rounded text-gray-500 text-sm font-bold flex items-center justify-center gap-2">{uploading ? 'ä¸Šå‚³ä¸­...' : <><I.Paperclip /> é¸æ“‡æª”æ¡ˆ (å¯å¤šé¸)</>}</button></div>)}
                                                </div>
                                                <div className="flex gap-3 pt-2"><button type="button" onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button><button type="submit" disabled={isSubmitting} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">{isSubmitting?'...':'å„²å­˜'}</button></div>
                                            </div>
                                        </>
                                    )}
                                    
                                    {/* ===== ç·¨è¼¯æ¨¡å¼ï¼šæ‰‹æ©ŸæŠ˜ç–Š / é›»è…¦å…¨é¡¯ç¤º ===== */}
                                    {editingId && (
                                        <>
                                            {/* æ‰‹æ©Ÿç‰ˆï¼šæŠ˜ç–Šå€å¡Š */}
                                            <div className="md:hidden space-y-3">
                                                {/* åŸºæœ¬è³‡è¨Šå€å¡Š */}
                                                <div className={`accordion-section ${openSections.includes('basic') ? 'active' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('basic') ? prev.filter(s=>s!=='basic') : [...prev, 'basic'])}>
                                                        <div><div className="accordion-title">åŸºæœ¬è³‡è¨Š</div><div className="accordion-subtitle">{formData.containerNumber || 'æœªå¡«å¯«'} Â· {formData.supplier || 'æœªå¡«å¯«'}</div></div>
                                                        <span className="accordion-arrow">â–¶</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-3">
                                                            <div><label className="form-label-lg">é€²å£å…¬å¸</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                            <div><label className="form-label-lg">æ«ƒè™Ÿ</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg font-mono uppercase" placeholder="æ«ƒè™Ÿ" /></div>
                                                            <div><label className="form-label-lg">åˆ°æ¸¯æ—¥</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" /></div>
                                                            <div><label className="form-label-lg">å» å•†</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" placeholder="å» å•†" /></div>
                                                            <div><label className="form-label-lg">å» å•†åºè™Ÿ</label><div className="flex gap-2"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg font-mono flex-1" placeholder="å¦‚ 26-01" />{canCreate() && <button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-3 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold">è‡ªå‹•</button>}</div></div>
                                                            <div><label className="form-label-lg">ç”¢åœ°</label><input list="origins2" name="origin" value={formData.origin} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" placeholder="ç”¢åœ°" /><datalist id="origins2">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* å ±é—œè³‡è¨Šå€å¡Š */}
                                                <div className={`accordion-section ${openSections.includes('customs') ? 'active' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('customs') ? prev.filter(s=>s!=='customs') : [...prev, 'customs'])}>
                                                        <div><div className="accordion-title">å ±é—œè³‡è¨Š</div><div className="accordion-subtitle">{formData.customsBroker || 'æœªå¡«å¯«'}</div></div>
                                                        <span className="accordion-arrow">â–¶</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-3">
                                                            <div><label className="form-label-lg">èˆ¹å…¬å¸</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" placeholder="èˆ¹å…¬å¸" /></div>
                                                            <div><label className="form-label-lg">å ±é—œè¡Œ</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                            <div><label className="form-label-lg">å ±é—œå–®è™Ÿ</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="form-input-lg" placeholder="å ±é—œå–®è™Ÿ" /></div>
                                                            <div><label className="form-label-lg">è¼¸å…¥è¨±å¯è­‰</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="form-input-lg" placeholder="è¨±å¯è­‰è™Ÿ" /></div>
                                                            <div><label className="form-label-lg">æ‹†æ«ƒåœ°é»</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="form-input-lg" placeholder="åœ°é»" /></div>
                                                            <div><label className="form-label-lg">æ‹†æ«ƒæ—¥æœŸ</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="form-input-lg" /></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* ä»˜æ¬¾è³‡è¨Šå€å¡Š */}
                                                {canSeePrice() && (
                                                    <div className={`accordion-section ${openSections.includes('payment') ? 'active' : ''}`}>
                                                        <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('payment') ? prev.filter(s=>s!=='payment') : [...prev, 'payment'])}>
                                                            <div><div className="accordion-title">ä»˜æ¬¾è³‡è¨Š</div><div className="accordion-subtitle">{formData.isPaid ? 'âœ“ è²¨æ¬¾å·²ä»˜' : 'æœªä»˜æ¬¾'}</div></div>
                                                            <span className="accordion-arrow">â–¶</span>
                                                        </div>
                                                        <div className="accordion-content">
                                                            <div className="space-y-3">
                                                                <div><label className="form-label-lg">ä»˜æ¬¾æ¢ä»¶</label><input value={formData.paymentTerm} disabled className="form-input-lg" /></div>
                                                                {canEditFlightFee() && isForeign(formData) && (<div><label className="form-label-lg">æ—…è²»</label><input type="text" inputMode="decimal" name="flightFee" value={formData.flightFee} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleInputChange({target:{name:'flightFee',value:e.target.value.replace(/[^\d.-]/g,''),type:'text'}})} className="form-input-lg num-input" placeholder="0" /></div>)}
                                                                <div className="bg-gray-50 p-4 rounded-xl space-y-3">
                                                                    <label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-6 h-6 accent-green-600"/><span className="font-bold text-green-700 text-lg">è²¨æ¬¾å·²ä»˜</span></label>
                                                                    {canEditFlightFee() && isForeign(formData) && <label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-6 h-6 accent-red-600"/><span className="font-bold text-red-700 text-lg">æ—…è²»å·²ä»˜</span></label>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* ç”¢å“æ˜ç´°å€å¡Š */}
                                                <div className={`accordion-section ${openSections.includes('products') ? 'active' : ''} ${validationErrors.products ? 'has-error' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('products') ? prev.filter(s=>s!=='products') : [...prev, 'products'])}>
                                                        <div><div className="accordion-title">ç”¢å“æ˜ç´° ({formData.products?.length || 0})</div><div className="accordion-subtitle">{formData.products?.[0]?.name || 'æœªå¡«å¯«'}</div></div>
                                                        <span className="accordion-arrow">â–¶</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-4">
                                                            {formData.products.map((p, idx) => (
                                                                <div key={p.id} className="product-card-lg">
                                                                    {/* ç”¢å“ç·¨è™Ÿæ¨™é¡Œ */}
                                                                    <div className="flex items-center justify-between mb-3 pb-2 border-b border-gray-200">
                                                                        <span className="font-bold text-gray-600">ç”¢å“ #{idx + 1}</span>
                                                                        {(canEditDomesticFull() || canManage()) && (
                                                                            <div className="flex gap-1">
                                                                                <button type="button" onClick={()=>duplicateProductRow(idx)} className="p-2 text-gray-400"><I.Copy /></button>
                                                                                {formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="p-2 text-red-400"><I.Trash2 /></button>}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    
                                                                    {/* å“å */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">å“å</label>
                                                                        <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`product-picker-btn ${!p.name ? 'empty' : ''}`}>
                                                                            <span>{p.name || 'é»æ“Šé¸æ“‡ç”¢å“'}</span>
                                                                            <span>â–¼</span>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* è¦æ ¼ */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">è¦æ ¼</label>
                                                                        <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="form-input-lg" placeholder="è¼¸å…¥è¦æ ¼" style={{height:'48px'}} />
                                                                    </div>
                                                                    
                                                                    {/* ä»¶æ•¸ */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">ä»¶æ•¸</label>
                                                                        <input type="text" inputMode="decimal" value={p.quantity} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'quantity',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{height:'48px',color:'#2563eb'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* é‡é‡ */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">é‡é‡ (kg)</label>
                                                                        <input type="text" inputMode="decimal" value={p.weight} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'weight',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{height:'48px',color:'#f97316'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* å–®åƒ¹ */}
                                                                    {canSeePrice() && (
                                                                        <div className="mb-3">
                                                                            <label className="form-label-lg">å–®åƒ¹</label>
                                                                            <input type="text" inputMode="decimal" value={p.unitPrice} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{height:'48px'}} placeholder="0" />
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* è¨ˆåƒ¹æ–¹å¼ */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">è¨ˆåƒ¹æ–¹å¼</label>
                                                                        <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="form-input-lg" style={{height:'48px'}}>
                                                                            <option value="weight">è¨ˆé‡</option>
                                                                            <option value="quantity">è¨ˆä»¶</option>
                                                                        </select>
                                                                    </div>
                                                                    
                                                                    {/* æ‰¹è™Ÿ */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">æ‰¹è™Ÿ</label>
                                                                        <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="form-input-lg" style={{height:'48px'}} placeholder="è¼¸å…¥æ‰¹è™Ÿ" />
                                                                    </div>
                                                                    
                                                                    {/* æ•ˆæœŸ */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">æ•ˆæœŸ</label>
                                                                        <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="form-input-lg" style={{height:'48px'}} />
                                                                    </div>
                                                                    
                                                                    {/* é‡‘é¡ */}
                                                                    {canSeePrice() && (
                                                                        <div className="bg-emerald-50 p-3 rounded-xl text-center">
                                                                            <div className="text-sm text-emerald-600 mb-1">å°è¨ˆé‡‘é¡</div>
                                                                            <div className="font-bold text-emerald-700 text-xl">${format2(safeNum(p.amount))}</div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                            {(canEditDomesticFull() || canManage()) && <button type="button" onClick={addProductRow} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold border-2 border-dashed border-blue-200">+ æ–°å¢ç”¢å“</button>}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* é™„ä»¶å€å¡Š */}
                                                <div className={`accordion-section ${openSections.includes('attachments') ? 'active' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('attachments') ? prev.filter(s=>s!=='attachments') : [...prev, 'attachments'])}>
                                                        <div><div className="accordion-title">é™„ä»¶ ({formData.attachments?.length || 0})</div></div>
                                                        <span className="accordion-arrow">â–¶</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-2">
                                                            {(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg"><a href={file.url} target="_blank" className="text-blue-600 underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}
                                                            {canUpload() && (<div className="relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-3 bg-white border border-dashed border-gray-300 rounded-lg text-gray-500 font-bold">{uploading ? 'ä¸Šå‚³ä¸­...' : 'ğŸ“ é¸æ“‡æª”æ¡ˆ'}</button></div>)}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* ç·¨è¼¯æ¨¡å¼æŒ‰éˆ• */}
                                                <div className="flex gap-3 pt-4">
                                                    <button type="button" onClick={()=>setView('list')} className="flex-1 py-4 bg-gray-100 text-gray-600 rounded-xl font-bold text-lg">å–æ¶ˆ</button>
                                                    <button type="submit" disabled={isSubmitting} className="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg">{isSubmitting ? 'å„²å­˜ä¸­...' : 'å„²å­˜'}</button>
                                                </div>
                                            </div>
                                            
                                            {/* é›»è…¦ç‰ˆï¼šå‚³çµ±å…¨é¡¯ç¤º */}
                                            <div className="hidden md:block space-y-4">
                                                <div className="bg-white rounded-xl p-3 border border-gray-200 shadow-sm">
                                                    <div className="grid grid-cols-4 gap-2">
                                                        <div><label>é€²å£å…¬å¸</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label>æ«ƒè™Ÿ</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2 font-mono uppercase" placeholder="æ«ƒè™Ÿ" /></div>
                                                        <div><label>èˆ¹å…¬å¸</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="èˆ¹å…¬å¸" /></div>
                                                        <div><label>åˆ°æ¸¯æ—¥</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" /></div>
                                                        <div><label>å ±é—œè¡Œ</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label>å ±é—œå–®è™Ÿ</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="å ±é—œå–®è™Ÿ" /></div>
                                                        <div><label>è¼¸å…¥è¨±å¯è­‰</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="è¨±å¯è­‰è™Ÿ" /></div>
                                                        <div><label>å» å•†</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="å» å•†" /></div>
                                                        <div><label>å» å•†åºè™Ÿ</label><div className="flex gap-1"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} disabled={!canCreate()} className="flex-1 input-bg-style rounded-lg p-2 font-mono" placeholder="å¦‚ 26-01" />{canCreate() && <button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-2 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold">è‡ªå‹•</button>}</div></div>
                                                        <div><label>ç”¢åœ°</label><input list="origins3" name="origin" value={formData.origin} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="ç”¢åœ°" /><datalist id="origins3">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        <div><label>æ‹†æ«ƒåœ°</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="åœ°é»" /></div>
                                                        <div><label>æ‹†æ«ƒæ—¥</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" /></div>
                                                    </div>
                                                </div>
                                                {canSeePrice() && (
                                                    <div className="bg-blue-50 rounded-xl p-3 border border-blue-100 flex flex-wrap items-end gap-3">
                                                        <div className="flex-1 min-w-[140px]"><label>ä»˜æ¬¾æ¢ä»¶</label><input value={formData.paymentTerm} disabled className="w-full bg-white border rounded input-bg-style text-xs" /></div>
                                                        {canEditFlightFee() && isForeign(formData) && (<div className="w-24"><label>æ—…è²»</label><input type="number" name="flightFee" value={formData.flightFee} onWheel={e=>e.target.blur()} onChange={handleInputChange} className="w-full bg-white border rounded input-bg-style" placeholder="0" /></div>)}
                                                        <div className="flex items-center gap-3 pb-2 ml-auto">
                                                            <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-5 h-5 accent-green-600"/><span className="font-bold text-green-700 text-xs">è²¨æ¬¾å·²ä»˜</span></label>
                                                            {canEditFlightFee() && isForeign(formData) && <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-5 h-5 accent-red-600"/><span className="font-bold text-red-700 text-xs">æ—…è²»å·²ä»˜</span></label>}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="pt-2">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h3 className={`font-bold text-lg ${validationErrors.products ? 'text-red-600' : 'text-gray-700'}`}>ç”¢å“æ˜ç´°{validationErrors.products && <span className="text-red-500 text-xs ml-2">(è«‹è‡³å°‘å¡«å¯«ä¸€é …å“å)</span>}</h3>
                                                        {(canEditDomesticFull() || canManage()) && <button type="button" onClick={addProductRow} className="text-blue-600 font-bold text-sm hover:underline cursor-pointer">+ æ–°å¢ç”¢å“</button>}
                                                    </div>
                                                    <div className="space-y-3">{formData.products.map((p, idx) => (
                                                        <div key={p.id} className={`bg-white border rounded-xl p-3 shadow-sm ${validationErrors.products && idx === 0 ? 'border-red-300' : ''}`}>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`input-bg-style rounded p-1 font-bold cursor-pointer flex items-center justify-between ${products.length > 0 ? 'hover:bg-blue-50' : ''}`}><span className={p.name ? 'text-gray-800' : 'text-gray-400'}>{p.name || 'é»æ“Šé¸æ“‡å“å'}</span>{products.length > 0 && <span className="text-blue-500 text-xs">â–¼</span>}</div>
                                                                <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="è¦æ ¼" />
                                                                <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="input-bg-style rounded p-1 text-sm"><option value="weight">è¨ˆé‡</option><option value="quantity">è¨ˆä»¶</option></select>
                                                                <input type="number" value={p.quantity} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'quantity',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-blue-600" placeholder="ä»¶æ•¸" />
                                                                <input type="number" value={p.weight} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'weight',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-orange-500" placeholder="é‡é‡" />
                                                                {canSeePrice() ? (<input type="number" value={p.unitPrice} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value)} className="input-bg-style rounded p-1 text-right" placeholder="å–®åƒ¹" />) : (<div className="input-bg-style rounded p-1 text-right flex items-center justify-end text-gray-300">***</div>)}
                                                                <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="æ‰¹è™Ÿ" />
                                                                <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="input-bg-style rounded p-1 text-xs" />
                                                                <div className="flex items-center justify-between bg-gray-50 rounded px-2 border border-gray-200">{canSeePrice() ? <span className="font-bold text-emerald-600 text-sm">${format2(safeNum(p.amount))}</span> : <span>***</span>}{(canEditDomesticFull() || canManage()) && (<div className="flex gap-1"><button type="button" onClick={()=>duplicateProductRow(idx)} className="text-gray-400 hover:text-blue-600 p-1"><I.Copy /></button>{formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="text-gray-400 hover:text-red-600 p-1"><I.Trash2 /></button>}</div>)}</div>
                                                            </div>
                                                        </div>
                                                    ))}</div>
                                                </div>
                                                <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                                    <label className="block text-xs font-bold text-gray-500 mb-2">é™„ä»¶ ({formData.attachments?.length || 0})</label>
                                                    <div className="space-y-2">{(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-white p-2 rounded border"><a href={file.url} target="_blank" className="text-blue-600 text-xs underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}</div>
                                                    {canUpload() && (<div className="mt-2 relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-2 bg-white border border-dashed border-gray-400 rounded text-gray-500 text-sm font-bold flex items-center justify-center gap-2">{uploading ? 'ä¸Šå‚³ä¸­...' : <><I.Paperclip /> é¸æ“‡æª”æ¡ˆ (å¯å¤šé¸)</>}</button></div>)}
                                                </div>
                                                <div className="flex gap-3 pt-2"><button type="button" onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button><button type="submit" disabled={isSubmitting} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">{isSubmitting?'...':'å„²å­˜'}</button></div>
                                            </div>
                                        </>
                                    )}
                                </form>
                            </div>
                        )}
                    </main>
                    {/* V79.3: å¤šé¸æ¨¡å¼åº•éƒ¨æ“ä½œåˆ— */}
                    {selectMode && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-50 p-3 pb-safe">
                            <div className="flex items-center justify-between gap-3">
                                <div className="flex items-center gap-3">
                                    <button onClick={toggleSelectAll} className="px-3 py-2 bg-gray-100 rounded-lg text-sm font-bold text-gray-600">
                                        {selectedIds.size === filteredList.length ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸'}
                                    </button>
                                    <span className="text-sm text-gray-500">å·²é¸ <span className="font-bold text-blue-600">{selectedIds.size}</span> å€‹è²¨æ«ƒ</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={cancelSelectMode} className="px-4 py-2 bg-gray-200 rounded-lg font-bold text-gray-600">å–æ¶ˆ</button>
                                    <button onClick={executeExport} disabled={selectedIds.size === 0} className={`px-4 py-2 rounded-lg font-bold text-white ${selectedIds.size > 0 ? 'bg-blue-600' : 'bg-gray-300'}`}>
                                        åŒ¯å‡º Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* åŸåº•éƒ¨å°èˆªï¼ˆå¤šé¸æ¨¡å¼æ™‚éš±è—ï¼‰ */}
                    {!selectMode && <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex z-40 pb-safe h-14"><button onClick={()=>setView('list')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='list'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.List /></div><span className="text-xs font-bold">åˆ—è¡¨</span></button>{userRole !== 'GUEST' && <><button onClick={()=>setView('products')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='products'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.Package /></div><span className="text-xs font-bold">ç”¢å“</span></button><button onClick={()=>setView('stats')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='stats'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.Chart /></div><span className="text-xs font-bold">çµ±è¨ˆ</span></button></>}</div>}
                </div>
                </ErrorBoundary>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerApp />);
    </script>
</body>
</html>