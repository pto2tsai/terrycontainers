<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë≤®Ê´ÉÁÆ°ÁêÜÁ≥ªÁµ± V79.0</title>
    
    <!-- V79.0: PDF.js for PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // V79.0: Ë®≠ÂÆö PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        
        window.onerror = function(msg, url, line, col, error) {
            if (msg && msg.toLowerCase().indexOf("script error") > -1) return false;
            setTimeout(function() {
                var root = document.getElementById('root');
                if (root && root.innerHTML.trim().length > 0 && root.innerHTML.indexOf('Á≥ªÁµ±ÂïüÂãï‰∏≠') === -1) return;
                var div = document.createElement("div");
                div.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:white; color:#333; padding:20px; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;";
                div.innerHTML = `<h2 style="color:#dc2626;font-size:20px;font-weight:bold;margin-bottom:10px">‚ö†Ô∏è Á≥ªÁµ±ËºâÂÖ•Áï∞Â∏∏</h2><div style="background:#f3f4f6;padding:15px;border:1px solid #ddd;border-radius:8px;font-size:12px;text-align:left;max-width:90%;overflow:auto;margin-bottom:20px">Line: ${line}<br>${msg}</div><button onclick="window.location.reload()" style="padding:12px 30px;background:#2563eb;color:white;border:none;border-radius:50px;font-weight:bold;cursor:pointer;">ÈáçÊñ∞Êï¥ÁêÜ</button>`;
                document.body.appendChild(div);
                var loader = document.getElementById('loading-screen');
                if(loader) loader.style.display = 'none';
            }, 3000);
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- V79.3: xlsx-js-style for Excel with styles (borders, fonts) -->
    <script src="https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <style>
        /* ========================================
           V79.0 Ë®≠Ë®àÁ≥ªÁµ± - Design Tokens
           ======================================== */
        
        :root {
            /* === Â≠óÈ´îÁ≥ªÁµ± === */
            --font-family-base: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            --font-family-mono: "SF Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            
            /* Â≠óÈ´îÂ§ßÂ∞èÈöéÂ±§ */
            --text-xs: 12px;
            --text-sm: 14px;
            --text-base: 16px;
            --text-lg: 18px;
            --text-xl: 20px;
            --text-2xl: 24px;
            --text-3xl: 30px;
            
            /* Â≠óÈáç */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;
            
            /* Ë°åÈ´ò */
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;
            
            /* === ÈñìË∑ùÁ≥ªÁµ± (4px Âü∫Á§é) === */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            
            /* === ÂúìËßíÁ≥ªÁµ± === */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
            --radius-full: 9999px;
            
            /* === Ëâ≤ÂΩ©Á≥ªÁµ± === */
            --color-primary: #2563eb;
            --color-primary-light: #3b82f6;
            --color-primary-dark: #1d4ed8;
            
            --color-success: #059669;
            --color-success-light: #10b981;
            --color-warning: #d97706;
            --color-warning-light: #f59e0b;
            --color-danger: #dc2626;
            --color-danger-light: #ef4444;
            
            /* Ë™ûÁæ©ÂåñÊï∏ÊìöËâ≤ÂΩ© */
            --color-quantity: #2563eb;
            --color-weight: #ea580c;
            --color-amount: #059669;
            
            /* ‰∏≠ÊÄßËâ≤ */
            --color-bg: #f3f4f6;
            --color-bg-card: #ffffff;
            --color-bg-input: #f9fafb;
            --color-border: #e5e7eb;
            --color-border-focus: #3b82f6;
            
            --color-text-primary: #111827;
            --color-text-secondary: #4b5563;
            --color-text-tertiary: #6b7280;
            --color-text-placeholder: #9ca3af;
            
            /* === Ëß∏ÊéßÁõÆÊ®ô === */
            --touch-target-min: 44px;
            --touch-target-comfortable: 48px;
            
            /* === Èô∞ÂΩ± === */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            
            /* === ÈÅéÊ∏°ÂãïÁï´ === */
            --transition-fast: 150ms;
            --transition-normal: 200ms;
            --transition-slow: 300ms;
        }
        
        /* ========================================
           Âü∫Á§éÊ®£Âºè
           ======================================== */
        
        body { background-color: var(--color-bg); font-family: var(--font-family-base); font-size: var(--text-base); line-height: var(--leading-normal); color: var(--color-text-primary); margin: 0; -webkit-font-smoothing: antialiased; }
        
        /* Loading */
        #loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--color-border); border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ========================================
           UI ÂÖÉ‰ª∂
           ======================================== */
        
        .ios-card { background: var(--color-bg-card); border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); margin-bottom: var(--space-4); border: 1px solid var(--color-border); overflow: hidden; }
        .ios-card:active { transform: scale(0.995); transition: transform 0.1s; }
        
        .reconcile-table { width: 100%; border-collapse: collapse; background: white; }
        .reconcile-table th, .reconcile-table td { padding: 10px 6px; border-bottom: 1px solid var(--color-border); white-space: nowrap; text-align: left; }
        .reconcile-table th { background: var(--color-bg-input); color: var(--color-text-tertiary); font-weight: var(--font-semibold); font-size: var(--text-xs); }
        .reconcile-table td { color: var(--color-text-secondary); vertical-align: middle; font-size: 14px; }
        .reconcile-table tr:hover { background-color: var(--color-bg-input); cursor: pointer; }
        .reconcile-table th.col-right, .reconcile-table td.col-right { text-align: right !important; }
        .reconcile-table th.col-center, .reconcile-table td.col-center { text-align: center !important; }
        .reconcile-table .col-product { max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
        
        .amt-paid { color: var(--color-text-primary); font-weight: 700; font-family: var(--font-family-mono); font-size: var(--text-xs); }
        .amt-unpaid { background-color: white; color: var(--color-danger); border: 1px solid var(--color-danger-light); border-radius: var(--radius-sm); padding: 0 4px; font-weight: 700; font-family: var(--font-family-mono); font-size: var(--text-xs); white-space: nowrap; display: inline-block; }

        .tag-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: var(--radius-sm); font-size: var(--text-xs); font-weight: var(--font-semibold); letter-spacing: 0.3px; white-space: nowrap; }
        .company-tag { font-size: var(--text-base); font-weight: 800; padding: var(--space-1) var(--space-3); border-radius: var(--radius-sm); display: inline-block; }
        
        /* Ë°®ÂñÆËº∏ÂÖ•Ê°Ü - Áµ±‰∏Ä 48px È´òÂ∫¶ */
        .input-bg-style { background-color: var(--color-bg-card); border: 1.5px solid var(--color-border); color: var(--color-text-primary); transition: all var(--transition-fast); height: var(--touch-target-comfortable); padding: 0 var(--space-3); font-size: var(--text-base); border-radius: var(--radius-md); width: 100%; }
        .input-bg-style:focus { border-color: var(--color-border-focus); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); background: white; }
        .input-bg-style::placeholder { color: var(--color-text-placeholder); font-weight: var(--font-semibold); font-size: var(--text-base); }
        
        /* Ê®ôÁ±§ - 14px */
        label { font-size: var(--text-sm); font-weight: var(--font-bold); color: var(--color-text-tertiary); margin-bottom: var(--space-1); display: block; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .product-grid-cols { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 2px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 400px; max-height: 80vh; border-radius: var(--radius-xl); padding: var(--space-5); overflow-y: auto; box-shadow: var(--shadow-lg); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { opacity: 1; transform: translateY(0); } }
        
        /* Áµ±Ë®àË°®Ê†ºÊ®£Âºè */
        .stats-table { width: 100%; text-align: right; border-collapse: collapse; }
        .stats-table th { text-align: right; padding: var(--space-2); background: var(--color-bg-input); color: var(--color-text-tertiary); font-size: var(--text-xs); }
        .stats-table td { padding: var(--space-2); border-bottom: 1px solid var(--color-bg); font-family: var(--font-family-mono); font-size: var(--text-sm); }
        .stats-table tr:last-child td { border-bottom: none; }
        
        /* Ë°®ÂñÆÈ©óË≠âÊ®£Âºè */
        .input-error { border-color: var(--color-danger-light) !important; background-color: #fef2f2 !important; }
        .input-error:focus { outline: 2px solid #fecaca !important; }
        .label-required::after { content: ' *'; color: var(--color-danger); }
        .validation-toast { position: fixed; top: var(--space-5); left: 50%; transform: translateX(-50%); background: #fef2f2; border: 1px solid #fecaca; color: var(--color-danger); padding: var(--space-3) var(--space-5); border-radius: var(--radius-lg); font-size: var(--text-sm); font-weight: var(--font-semibold); z-index: 9999; animation: toastIn 0.3s ease-out; box-shadow: var(--shadow-md); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        /* ÂÅ¥ÈÇäÊ¨ÑÂ∞éËà™Ê®£Âºè */
        .sidebar-link { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3) var(--space-4); border-radius: var(--radius-lg); font-weight: var(--font-semibold); font-size: var(--text-sm); color: var(--color-text-tertiary); background: transparent; border: none; text-align: left; cursor: pointer; transition: all var(--transition-fast); }
        .sidebar-link:hover { background: var(--color-bg); color: var(--color-text-secondary); }
        .sidebar-link.active { background: #eff6ff; color: var(--color-primary); }
        
        /* ========================================
           V79.0: ÊâãÊ©üÂèãÂñÑË°®ÂñÆÊ®£Âºè
           ======================================== */
        
        /* Â§ßËº∏ÂÖ•Ê°Ü - Áµ±‰∏Ä 48px */
        .form-input-lg {
            width: 100%;
            max-width: 100%;
            height: var(--touch-target-comfortable);
            padding: 0 var(--space-4);
            background: var(--color-bg-input);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-lg);
            font-size: var(--text-base);
            color: var(--color-text-primary);
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: all var(--transition-fast);
        }
        .form-input-lg:focus {
            background: white;
            border-color: var(--color-border-focus);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
        }
        .form-input-lg::placeholder { color: var(--color-text-placeholder); }
        .form-input-lg:disabled { background: var(--color-bg); color: var(--color-text-tertiary); }
        .form-input-lg.num-input { text-align: right; font-family: var(--font-family-mono); font-weight: var(--font-semibold); }
        .form-input-lg.error { border-color: var(--color-danger-light); background: #fef2f2; }
        
        /* Êó•ÊúüËº∏ÂÖ•Ê°ÜÁâπÊÆäËôïÁêÜ */
        input[type="date"].form-input-lg {
            min-width: 0;
            padding-right: var(--space-3);
        }
        
        /* Á¢∫‰øùË°®ÂñÆÊ¨Ñ‰Ωç‰∏çÊ∫¢Âá∫ */
        .ios-card { overflow: hidden; }
        .ios-card form { max-width: 100%; overflow: hidden; }
        .ios-card form > div { max-width: 100%; }
        .ios-card input, .ios-card select { max-width: 100%; min-width: 0; }
        
        /* Ê≠•È©üË°®ÂñÆÂÆπÂô® */
        .step-form-container { padding: 0 var(--space-1); }
        
        /* Â§ßÊ®ôÁ±§ - 14px */
        .form-label-lg {
            display: block;
            font-size: var(--text-sm);
            font-weight: var(--font-bold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }
        .form-label-lg .required { color: var(--color-danger); margin-left: var(--space-1); }
        
        /* ========================================
           V79.0: SVG Á∑öÊ¢ùÂúñÁ§∫Á≥ªÁµ±
           ======================================== */
        
        .icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            flex-shrink: 0;
            display: inline-block;
            vertical-align: middle;
        }
        
        .icon-sm { width: 20px; height: 20px; }
        .icon-lg { width: 28px; height: 28px; }
        .icon-xl { width: 32px; height: 32px; }
        
        /* ========================================
           V79.0: Êï∏ÊìöËâ≤ÂΩ©Ë™ûÁæ©Âåñ
           ======================================== */
        
        .data-quantity { color: var(--color-quantity); }
        .data-weight { color: var(--color-weight); }
        .data-amount { color: var(--color-amount); }
        
        .data-value {
            font-family: var(--font-family-mono);
            font-weight: var(--font-bold);
            font-size: var(--text-lg);
        }
        
        /* ========================================
           V79.0: Êô∫ËÉΩÂåØÂÖ•ÂäüËÉΩÊ®£Âºè
           ======================================== */
        
        .import-method-selector {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-6);
        }
        
        .import-method-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding: var(--space-6) var(--space-4);
            background: var(--color-bg-input);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .import-method-card:hover {
            border-color: var(--color-primary-light);
            background: white;
        }
        
        .import-method-card:active {
            transform: scale(0.98);
        }
        
        .import-method-card.selected {
            border-color: var(--color-primary);
            background: #eff6ff;
        }
        
        .import-method-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-lg);
        }
        
        .import-method-icon .icon {
            width: 28px;
            height: 28px;
            stroke: white;
        }
        
        .import-method-title {
            font-size: var(--text-base);
            font-weight: var(--font-bold);
            color: var(--color-text-primary);
        }
        
        .import-method-desc {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            text-align: center;
        }
        
        /* PDF È†êË¶ΩÂçÄÂüü */
        .pdf-preview-container {
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .pdf-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }
        
        .pdf-preview-title {
            font-size: var(--text-sm);
            font-weight: var(--font-bold);
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .pdf-preview-content {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            line-height: var(--leading-relaxed);
            white-space: pre-wrap;
            word-break: break-word;
            font-family: var(--font-family-mono);
        }
        
        /* Ê™îÊ°à‰∏äÂÇ≥ÂçÄÂüü */
        .file-drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-8) var(--space-4);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--color-bg-input);
        }
        
        .file-drop-zone:hover {
            border-color: var(--color-primary-light);
            background: white;
        }
        
        .file-drop-zone.dragging {
            border-color: var(--color-primary);
            background: #eff6ff;
        }
        
        .file-drop-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--space-3);
            color: var(--color-text-tertiary);
        }
        
        .file-drop-text {
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-1);
        }
        
        .file-drop-hint {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }
        
        /* Ê≠•È©üÊåáÁ§∫Âô® */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s;
        }
        .step-dot.active { background: #2563eb; transform: scale(1.2); }
        .step-dot.done { background: #10b981; }
        
        /* Ê≠•È©üÊ®ôÈ°å */
        .step-title {
            text-align: center;
            margin-bottom: 24px;
        }
        .step-title .step-num { font-size: 14px; color: #6b7280; font-weight: 600; }
        .step-title .step-name { font-size: 22px; font-weight: bold; color: #111827; margin-top: 4px; }
        
        /* ÊäòÁñäÂçÄÂ°ä */
        .accordion-section {
            background: white;
            border: 1.5px solid #e5e7eb;
            border-radius: 14px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .accordion-section.active { border-color: #3b82f6; }
        .accordion-section.has-error { border-color: #ef4444; }
        
        .accordion-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .accordion-header:active { background: #f9fafb; }
        .accordion-section.active .accordion-header { background: #eff6ff; }
        
        .accordion-title { font-size: 17px; font-weight: bold; color: #374151; }
        .accordion-section.active .accordion-title { color: #1e40af; }
        .accordion-subtitle { font-size: 13px; color: #9ca3af; margin-top: 2px; }
        
        .accordion-arrow { font-size: 18px; color: #9ca3af; transition: transform 0.2s; }
        .accordion-section.active .accordion-arrow { transform: rotate(90deg); color: #3b82f6; }
        
        .accordion-content {
            padding: 0 16px 16px;
            display: none;
        }
        .accordion-section.active .accordion-content { display: block; }
        
        /* Áî¢ÂìÅÂç°ÁâáÔºàÂ§ßÁâàÊú¨Ôºâ */
        .product-card-lg {
            background: #f9fafb;
            border: 1.5px solid #e5e7eb;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .product-card-lg.error { border-color: #fca5a5; background: #fef2f2; }
        
        /* Áî¢ÂìÅÈÅ∏ÊìáÊåâÈàï */
        .product-picker-btn {
            width: 100%;
            height: 52px;
            padding: 0 16px;
            background: #f0f9ff;
            border: 1.5px solid #93c5fd;
            border-radius: 12px;
            font-size: 17px;
            color: #1e40af;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }
        .product-picker-btn:active { background: #dbeafe; }
        .product-picker-btn.empty { color: #9ca3af; background: #f9fafb; border-color: #e5e7eb; }
        
        /* Bottom Sheet */
        .bottom-sheet-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 60; opacity: 0; animation: fadeIn 0.2s ease-out forwards; 
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .bottom-sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; border-radius: 20px 20px 0 0; 
            z-index: 61; max-height: 80vh; 
            display: flex; flex-direction: column;
            transform: translateY(100%); 
            animation: slideUpSheet 0.3s ease-out forwards;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }
        /* ÈõªËÖ¶ÁâàÔºöÊîπÁÇ∫Â±Ö‰∏≠ÂΩàÁ™ó */
        @media (min-width: 768px) {
            .bottom-sheet {
                bottom: auto; left: 50%; right: auto;
                top: 50%; transform: translate(-50%, -50%);
                width: 480px; max-width: 90vw;
                border-radius: 20px;
                max-height: 70vh;
                animation: fadeInScale 0.2s ease-out forwards;
            }
        }
        @keyframes fadeInScale { 
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes slideUpSheet { to { transform: translateY(0); } }
        .bottom-sheet-handle { width: 40px; height: 5px; background: #d1d5db; border-radius: 3px; margin: 12px auto 8px; }
        /* ÈõªËÖ¶ÁâàÈö±ËóèÊãñÊõ≥ÊääÊâã */
        @media (min-width: 768px) {
            .bottom-sheet-handle { display: none; }
        }
        .bottom-sheet-header { padding: 0 20px 16px; border-bottom: 1px solid #e5e7eb; }
        @media (min-width: 768px) {
            .bottom-sheet-header { padding: 20px 20px 16px; }
        }
        .bottom-sheet-content { flex: 1; overflow-y: auto; padding: 12px 20px 24px; -webkit-overflow-scrolling: touch; }
        
        /* Áî¢ÂìÅÂàóË°®È†ÖÁõÆÔºàÂ§ßÁâàÊú¨Ôºâ */
        .product-item-lg { 
            padding: 16px; 
            margin: 0 -8px; 
            border-radius: 12px;
            cursor: pointer; 
            border-bottom: 1px solid #f3f4f6;
        }
        .product-item-lg:active { background: #eff6ff; }
        .product-item-lg .name { font-size: 17px; font-weight: 600; color: #111827; }
        .product-item-lg .spec { font-size: 15px; color: #3b82f6; margin-top: 4px; }
        .product-item-lg .code { font-size: 13px; color: #9ca3af; font-family: monospace; }
    </style>
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div><div style="margin-top:15px;color:#666;font-weight:bold">Á≥ªÁµ±ÂïüÂãï‰∏≠...</div></div>
    <div id="root"></div>

    <script>
        setTimeout(function() {
            var loader = document.getElementById('loading-screen');
            if(loader) loader.remove();
        }, 3500);
    </script>

    <script type="text/babel">
        // --- 0. Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center"><h1 className="text-xl font-bold text-red-600">‚ö†Ô∏è ÁôºÁîüÈåØË™§</h1><button onClick={()=>window.location.reload()} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded">ÈáçÊï¥</button></div>;
                return this.props.children;
            }
        }

        // --- 1. Config ---
        const DOMESTIC_FLAG = 'ÂúãÂÖßÊé°Ë≥º';
        const IMPORT_COMPANIES = ['Â¥áÊñáÂÜ∑Âáç', 'ÂÖ´ÊñπÁí∞ÁêÉ'];
        const CUSTOMS_BROKERS = ['ÂéüÁ¢©', 'Â∞öÈ¥ª', DOMESTIC_FLAG];
        const DEFAULT_ORIGINS = ['ÂéÑÁìúÂ§ö', 'Â∑¥ÊãøÈ¶¨', 'ÁìúÂú∞È¶¨Êãâ', 'ÂÆèÈÉΩÊãâÊñØ', 'Ê≥∞Âúã', 'Âç∞Â∞º', 'Âç∞Â∫¶', '‰∏≠Âúã', 'Êô∫Âà©', 'Êå™Â®Å'];
        const PAYMENT_TERMS_DOMESTIC = ['ÁèæÈáë', 'ÊúàÁµê 30 Â§©', 'ÊúàÁµê 45 Â§©', 'ÊúàÁµê 60 Â§©', 'ÂÖ∂‰ªñ'];
        
        // V73.0: ÁßªÈô§Á°¨Á∑®Á¢ºÁöÑ ADMIN_EMAILSÔºåÊîπÁÇ∫ÂÆåÂÖ®Âæû Firestore settings/config ËÆÄÂèñ
        // ÁÆ°ÁêÜÂì°ÂíåËßíËâ≤Ë®≠ÂÆöÁèæÂú®Áµ±‰∏ÄÂú® Firestore ‰∏≠ÁÆ°ÁêÜÔºåÊèêÂçáÂÆâÂÖ®ÊÄß

        // V72.0: Áµ±‰∏ÄÁÆ°ÁêÜÊñáÂ≠óÂ≠ó‰∏≤Ôºå‰æøÊñºÁ∂≠Ë≠∑ÂíåÊú™‰æÜÂ§öË™ûË®ÄÊîØÊè¥
        const TEXT = {
            // Á≥ªÁµ±
            APP_NAME: 'Ë≤®Ê´ÉÁÆ°ÁêÜÁ≥ªÁµ±',
            LOADING: 'Á≥ªÁµ±ÂïüÂãï‰∏≠...',
            LOADING_DATA: 'Loading...',
            
            // ÁôªÂÖ•
            LOGIN_TITLE: 'Ë≤®Ê´ÉÁÆ°ÁêÜÁ≥ªÁµ±',
            LOGIN_STAFF: 'Âì°Â∑•ÁôªÂÖ•',
            LOGIN_GUEST: 'Ë®™ÂÆ¢ÁôªÂÖ•',
            LOGIN_FAILED: 'ÁôªÂÖ•Â§±Êïó',
            GUEST_LOGIN_FAILED: 'Ë®™ÂÆ¢ÁôªÂÖ•Â§±Êïó',
            LOGOUT: 'ÁôªÂá∫',
            
            // Ê¨äÈôêËàáÈåØË™§
            PERMISSION_DENIED: 'Ê¨äÈôê‰∏çË∂≥',
            SAVE_FAILED: 'ÂÑ≤Â≠òÂ§±Êïó',
            UPLOAD_FAILED: '‰∏äÂÇ≥Â§±Êïó',
            
            // Á¢∫Ë™çÂ∞çË©±Ê°Ü
            CONFIRM_DELETE: 'Á¢∫ÂÆöÂà™Èô§?',
            CONFIRM_DELETE_FILE: 'Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÈôÑ‰ª∂ÂóéÔºü',
            
            // Ë°®ÂñÆÈ©óË≠â
            REQUIRED_FIELDS: 'Ë´ãÂ°´ÂØ´ÂøÖÂ°´Ê¨Ñ‰ΩçÔºö',
            FIELD_CONTAINER: 'Ê´ÉËôü',
            FIELD_ARRIVAL_DATE: 'Âà∞Ê∏ØÊó•',
            FIELD_SUPPLIER: 'Âª†ÂïÜ',
            FIELD_PRODUCT_NAME: 'Ëá≥Â∞ë‰∏ÄÈ†ÖÁî¢ÂìÅÂêçÁ®±',
            
            // ÁãÄÊÖãÊñáÂ≠ó
            STATUS_ARRIVED: 'Â∑≤Âà∞Ê∏Ø',
            STATUS_TODAY: '‰ªäÊó•Âà∞Ê∏Ø',
            STATUS_PENDING: 'Êú™ÂÆö',
            STATUS_DAYS_LATER: ' Â§©Âæå',
            
            // ‰ªòÊ¨æÁãÄÊÖã
            PAYMENT_PAID: 'Ë≤®Ê¨æÂ∑≤‰ªò',
            PAYMENT_UNPAID: 'Ë≤®Ê¨æÊú™‰ªò',
            FLIGHT_FEE_PAID: 'ÊóÖË≤ªÂ∑≤‰ªò',
            FLIGHT_FEE_UNPAID: 'ÊóÖË≤ªÊú™‰ªò',
            
            // ÊåâÈàïËàáÊìç‰Ωú
            BTN_SAVE: 'ÂÑ≤Â≠ò',
            BTN_CANCEL: 'ÂèñÊ∂à',
            BTN_ADD_PRODUCT: '+ Êñ∞Â¢ûÁî¢ÂìÅ',
            BTN_SELECT_FILE: 'ÈÅ∏ÊìáÊ™îÊ°à (ÂèØÂ§öÈÅ∏)',
            BTN_UPLOADING: '‰∏äÂÇ≥‰∏≠...',
            
            // È†ÅÁ±§
            TAB_NOT_DEVANED: 'Êú™ÊãÜÊ´É',
            TAB_DEVANED: 'Â∑≤ÊãÜÊ´É',
            TAB_DOMESTIC: 'ÂúãÂÖßÊé°Ë≥º',
            
            // ÂàóË°®
            LIST_TITLE: 'Ë≤®Ê´ÉÂàóË°®',
            STATS_TITLE: 'Áµ±Ë®àÂàÜÊûê',
            NO_URGENT: 'ÁõÆÂâçÁÑ°ÊÄ•‰ª∂',
            URGENT_TITLE: 'ËøëÊúüÂà∞Ê∏ØÊÄ•‰ª∂',
            FILE_LIST_TITLE: 'ÈôÑ‰ª∂ÂàóË°®',
            
            // Ë°®ÂñÆÊ®ôÁ±§
            LABEL_IMPORT_COMPANY: 'ÈÄ≤Âè£ÂÖ¨Âè∏',
            LABEL_CONTAINER_NO: 'Ê´ÉËôü',
            LABEL_SHIPPING_COMPANY: 'ËàπÂÖ¨Âè∏',
            LABEL_ARRIVAL_DATE: 'Âà∞Ê∏ØÊó•',
            LABEL_CUSTOMS_BROKER: 'Â†±ÈóúË°å',
            LABEL_DECLARATION_NO: 'Â†±ÈóúÂñÆËôü',
            LABEL_PERMIT_NO: 'Ëº∏ÂÖ•Ë®±ÂèØË≠â',
            LABEL_SUPPLIER: 'Âª†ÂïÜ',
            LABEL_ORIGIN: 'Áî¢Âú∞',
            LABEL_DEVANNING_LOCATION: 'ÊãÜÊ´ÉÂú∞',
            LABEL_DEVANNING_DATE: 'ÊãÜÊ´ÉÊó•',
            LABEL_PAYMENT_TERM: '‰ªòÊ¨æÊ¢ù‰ª∂',
            LABEL_FLIGHT_FEE: 'ÊóÖË≤ª',
            LABEL_ATTACHMENTS: 'ÈôÑ‰ª∂',
            
            // Áî¢ÂìÅÊòéÁ¥∞
            PRODUCT_SECTION: 'Áî¢ÂìÅÊòéÁ¥∞',
            PRODUCT_NAME: 'ÂìÅÂêç',
            PRODUCT_SPEC: 'Ë¶èÊ†º',
            PRODUCT_QUANTITY: '‰ª∂Êï∏',
            PRODUCT_WEIGHT: 'ÈáçÈáè',
            PRODUCT_UNIT_PRICE: 'ÂñÆÂÉπ',
            PRODUCT_BATCH: 'ÊâπËôü',
            PRODUCT_PRICING_QTY: 'Ë®à‰ª∂',
            PRODUCT_PRICING_WEIGHT: 'Ë®àÈáç',
            PRODUCT_HINT: '(Ë´ãËá≥Â∞ëÂ°´ÂØ´‰∏ÄÈ†ÖÂìÅÂêç)',
            
            // ÂÄâÂ∫´Á¢∫Ë™ç
            WAREHOUSE_CONFIRMED: 'Â∑≤Êî∂Ë≤®',
            WAREHOUSE_CONFIRM: 'Á¢∫Ë™çÊî∂Ë≤®',
            
            // Áµ±Ë®à
            STATS_DASHBOARD: 'Áµ±Ë®àÂÑÄË°®Êùø',
            STATS_ALL_MONTHS: 'ÂÖ®ÈÉ®Êúà‰ªΩ',
            STATS_TOTAL_COUNT: 'Á∏ΩÁ≠ÜÊï∏',
            STATS_TOTAL_ITEMS: 'Á∏Ω‰ª∂Êï∏',
            STATS_TOTAL_WEIGHT: 'Á∏ΩÈáçÈáè (kg)',
            STATS_USD_TOTAL: 'ÁæéÈáëÁ∏ΩÈ°ç (USD)',
            STATS_TWD_TOTAL: 'Âè∞Âπ£Á∏ΩÈ°ç (TWD)',
            STATS_MONTHLY_TABLE: 'üìÖ ÊúàÂ∫¶Êé°Ë≥ºÁµ±Ë®àË°®',
            STATS_TOP_SUPPLIERS: 'üèÜ Ââç‰∫îÂ§ßÂª†ÂïÜ',
            STATS_NO_DATA: 'ÁÑ°Ë∂≥Â§†Êï∏ÊìöÂèØÈ°ØÁ§∫',
            
            // LINE ÂàÜ‰∫´
            LINE_NOTIFY_DOMESTIC: 'üöö Âà∞Ë≤®ÈÄöÁü•',
            LINE_NOTIFY_FOREIGN: 'üö¢ Âà∞Ê∏ØÈÄöÁü•',
            
            // V74.0: Excel ÂåØÂÖ•
            IMPORT_EXCEL: 'üì• ÂåØÂÖ•ÂúãÂÖßÊé°Ë≥º',
            IMPORT_TITLE: 'ÂåØÂÖ•ÂúãÂÖßÊé°Ë≥ºË≥áÊñô',
            IMPORT_SELECT_FILE: 'ÈÅ∏Êìá Excel Ê™îÊ°à',
            IMPORT_PREVIEW: 'Ë≥áÊñôÈ†êË¶Ω',
            IMPORT_CONFIRM: 'Á¢∫Ë™çÂåØÂÖ•',
            IMPORT_CANCEL: 'ÂèñÊ∂à',
            IMPORT_PROCESSING: 'ÂåØÂÖ•‰∏≠...',
            IMPORT_SUCCESS: 'ÂåØÂÖ•ÊàêÂäü',
            IMPORT_FAILED: 'ÂåØÂÖ•Â§±Êïó',
            IMPORT_NO_DATA: 'ÁÑ°ÊúâÊïàË≥áÊñôÂèØÂåØÂÖ•',
            IMPORT_ROW_COUNT: 'ÂÖ± {count} Á≠ÜË≥áÊñô',
            IMPORT_UPDATE_HINT: 'ÔºàÁõ∏ÂêåÂª†ÂïÜ+Êó•Êúü+ÂìÅÂêçÂ∞áË¶ÜËìãÊõ¥Êñ∞Ôºâ',
            IMPORT_COLUMN_MAPPING: 'Ê¨Ñ‰ΩçÂ∞çÊáâ',
            
            // V75.0: Áî¢ÂìÅ‰∏ªÊ™î
            PRODUCTS_TITLE: 'Áî¢ÂìÅ‰∏ªÊ™î',
            PRODUCTS_IMPORT: 'üì• ÂåØÂÖ•Â∫´Â≠òË°®',
            PRODUCTS_ADD: '+ Êñ∞Â¢ûÁî¢ÂìÅ',
            PRODUCTS_SEARCH_HINT: 'ÊêúÂ∞ãÂìÅËôü„ÄÅÂìÅÂêç„ÄÅË¶èÊ†º...',
            PRODUCTS_EMPTY: 'Â∞öÁÑ°Áî¢ÂìÅË≥áÊñô',
            PRODUCTS_IMPORT_TITLE: 'ÂåØÂÖ•Áî¢ÂìÅ‰∏ªÊ™î',
            PRODUCTS_IMPORT_HINT: 'ÔºàÁõ∏ÂêåÂìÅËôüÂ∞áË¶ÜËìãÊõ¥Êñ∞Ôºâ',
            PRODUCTS_EDIT_TITLE: 'Á∑®ËºØÁî¢ÂìÅ',
            PRODUCTS_ADD_TITLE: 'Êñ∞Â¢ûÁî¢ÂìÅ',
            PRODUCT_ID: 'ÂìÅËôü',
            PRODUCT_DEFAULT_PRICE: 'È†êË®≠ÂñÆÂÉπ',
            PRODUCT_DEFAULT_SUPPLIER: 'È†êË®≠‰æõÊáâÂïÜ',
            PRODUCT_UNIT: 'ÂñÆ‰Ωç',
            PRODUCT_IS_ACTIVE: 'ÂïüÁî®',
            PRODUCT_INACTIVE: 'Â∑≤ÂÅúÁî®',
        };

        const initialFormState = { 
            importCompany: IMPORT_COMPANIES[0], 
            customsBroker: CUSTOMS_BROKERS[0], 
            origin: '', 
            supplier: '', 
            vendorSeqNo: '', // V79.0: Âª†ÂïÜÂ∫èËôüÔºàÂπ¥Â∫¶-Â∫èËôüÔºåÂ¶Ç 26-01Ôºâ
            arrivalDate: new Date().toISOString().split('T')[0], 
            containerNumber: '', 
            shippingCompany: '', 
            products: [{ id: Date.now(), name: '', batchNumber: '', expiryDate: '', spec: '', boxCapacity: 1, quantity: 0, weight: 0, unitPrice: 0, amount: 0, pricingMode: 'weight' }], 
            totalQuantity: 0, 
            totalWeight: 0, 
            docUrl: '', 
            docName: '', 
            docRefPath: '', 
            devanningLocation: '', 
            devanningDate: '', 
            customsDeclarationNo: '', 
            importPermitNo: '', 
            warehouseConfirmed: false,
            attachments: [],
            isPaid: false,
            currency: 'USD',
            paymentTerm: 'Âà∞Ê∏ØÂâç‰ªòÊ¨æ',
            prepayment: 0,
            flightFee: 0,         
            flightFeePaid: false 
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDvMBng2Zhbk6sVaZLSuER2KT6qqeoCdnw",
            authDomain: "containersystem-6342f.firebaseapp.com",
            projectId: "containersystem-6342f",
            storageBucket: "containersystem-6342f.firebasestorage.app",
            messagingSenderId: "27658303054",
            appId: "1:27658303054:web:d7a3710054ede268cdf51f"
        };

        let db, auth, storage;
        try {
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); }
            if (typeof firebase !== 'undefined') { db = firebase.firestore(); auth = firebase.auth(); storage = firebase.storage(); }
        } catch (e) { console.error("Firebase Init Failed:", e); }

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 2. Helpers ---
        const safeNum = (val) => { const n = parseFloat(val); return isNaN(n) ? 0 : n; };
        const round2 = (num) => Math.round(safeNum(num) * 100) / 100;
        const format2 = (num) => safeNum(num).toFixed(2);

        // V72.0: ‰øÆÊ≠£Êó•ÊúüËôïÁêÜÔºå‰ΩøÁî® UTC ÈÅøÂÖçÊôÇÂçÄÂïèÈ°å
        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0);
            try {
                const p = dateStr.split('-');
                if (p.length !== 3) return new Date(0);
                const year = parseInt(p[0], 10);
                const month = parseInt(p[1], 10) - 1;
                const day = parseInt(p[2], 10);
                if (isNaN(year) || isNaN(month) || isNaN(day)) return new Date(0);
                return new Date(Date.UTC(year, month, day));
            } catch (e) {
                return new Date(0);
            }
        };
        
        // V72.0: Ë®àÁÆóÂÖ©ÂÄãÊó•ÊúüÂ≠ó‰∏≤‰πãÈñìÁöÑÂ§©Êï∏Â∑ÆÔºàÊ≠£Êï∏Ë°®Á§∫ date1 Âú® date2 ‰πãÂæåÔºâ
        const dateDiffDays = (dateStr1, dateStr2) => {
            return Math.round((parseDate(dateStr1) - parseDate(dateStr2)) / 86400000);
        };
        
        const getStatusStyle = (date) => { 
            if (!date) return { bg: 'bg-gray-100', text: 'Êú™ÂÆö', color: 'text-gray-400' };
            const todayStr = new Date().toISOString().split('T')[0];
            const diff = dateDiffDays(date, todayStr);
            if (diff < 0) return { text: 'Â∑≤Âà∞Ê∏Ø', color: 'bg-gray-100 text-gray-500' };
            if (diff === 0) return { text: '‰ªäÊó•Âà∞Ê∏Ø', color: 'bg-red-100 text-red-600 animate-pulse' };
            return { text: diff + ' Â§©Âæå', color: 'bg-blue-100 text-blue-600' };
        };
        const getCompanyColor = (n) => n === 'Â¥áÊñáÂÜ∑Âáç' ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700';
        const isDomestic = (d) => d && d.customsBroker === DOMESTIC_FLAG;
        const isForeign = (d) => !isDomestic(d);

        // --- 3. Icons (V79.0: Áµ±‰∏Ä SVG Á∑öÊ¢ùÈ¢®Ê†º) ---
        const Icons = {
            Ship: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.8 8"/><path d="M12 2v8"/></svg>,
            Anchor: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>,
            Plus: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Search: ()=><svg className="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Copy: ()=><svg className="icon" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            FileCheck: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            Globe: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Factory: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>,
            Paperclip: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            ArrowRight: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Download: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            LogOut: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Google: ()=><svg className="icon" fill="currentColor" stroke="none" viewBox="0 0 24 24"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"/></svg>,
            X: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Check: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
            Bell: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            MessageCircle: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            User: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            List: ()=><svg className="icon" viewBox="0 0 24 24"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Chart: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Grid: ()=><svg className="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Dollar: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Calendar: ()=><svg className="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Line: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9Z"/><path d="M8 12h8"/></svg>,
            Package: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m16.5 9.4-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/></svg>,
            ChevronLeft: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ()=><svg className="icon" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"/></svg>,
            Upload: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            // V79.0: Êñ∞Â¢ûÂúñÁ§∫
            FileText: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>,
            Wand: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>,
            FormInput: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>,
            FilePlus: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>,
            Eye: ()=><svg className="icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Info: ()=><svg className="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            AlertCircle: ()=><svg className="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        };
        
        const I = Icons;

        // 4. MonthlySummaryTable (V68.0: Replace Chart with Table)
        const MonthlySummaryTable = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-gray-400 text-center py-4">ÁÑ°Ë∂≥Â§†Êï∏ÊìöÂèØÈ°ØÁ§∫</div>;
            return (
                <div className="overflow-x-auto">
                    <table className="stats-table">
                        <thead>
                            <tr>
                                <th className="text-left">Êúà‰ªΩ</th>
                                <th>Ê´ÉÊï∏</th>
                                <th>Á∏ΩÈáç(kg)</th>
                                <th>ÁæéÈáë(USD)</th>
                                <th>Âè∞Âπ£(TWD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map(d => (
                                <tr key={d.name}>
                                    <td className="text-left font-bold text-gray-700">{d.name}</td>
                                    <td>{d.count}</td>
                                    <td className="text-orange-500">{format2(d.weight)}</td>
                                    <td className="text-emerald-600 font-bold">{d.USD > 0 ? `$${format2(d.USD)}` : '-'}</td>
                                    <td className="text-blue-600 font-bold">{d.TWD > 0 ? `$${format2(d.TWD)}` : '-'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // 5. Dashboard
        const Dashboard = ({ shipments, canSeePrice }) => {
            const availableMonths = useMemo(() => {
                const months = new Set();
                shipments.forEach(s => {
                    if(s.arrivalDate) months.add(s.arrivalDate.substring(0, 7));
                });
                return Array.from(months).sort().reverse();
            }, [shipments]);

            const [tf, setTf] = useState('YEAR');
            const [filterMonth, setFilterMonth] = useState('ALL');
            const [search, setSearch] = useState('');
            
            const stats = useMemo(() => {
                let list = Array.isArray(shipments) ? shipments : [];
                if (search) {
                    const t = search.toLowerCase();
                    list = list.filter(s => (s.supplier||'').toLowerCase().includes(t) || (s.products||[]).some(p=>p.name.toLowerCase().includes(t)));
                }
                
                if (filterMonth !== 'ALL') {
                     list = list.filter(s => s.arrivalDate && s.arrivalDate.startsWith(filterMonth));
                }

                const count = list.length;
                const items = list.reduce((s,i) => s + safeNum(i.totalQuantity), 0);
                const w = list.reduce((s,i) => s + safeNum(i.totalWeight), 0);
                const moneyUSD = list.reduce((s,i) => i.currency==='USD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                const moneyTWD = list.reduce((s,i) => i.currency==='TWD' ? s + (i.products||[]).reduce((a,p)=>a+safeNum(p.amount),0) : s, 0);
                
                const supps = {}; list.forEach(s=>{ const n=s.supplier||'Êú™Â°´'; supps[n]=(supps[n]||0)+1; });
                const top = Object.entries(supps).sort((a,b)=>b[1]-a[1]).slice(0,5);
                const maxVal = (top.length>0 && top[0][1]>0) ? top[0][1] : 1;

                // V68.0: Table Data Logic
                const chartMap = {};
                // Sort list by date for table
                const chartList = [...list].sort((a,b) => (b.arrivalDate||'').localeCompare(a.arrivalDate||'')); // Descending
                chartList.forEach(s => {
                    if(!s.arrivalDate) return;
                    const k = s.arrivalDate.substring(0, 7); // YYYY-MM
                    if(!chartMap[k]) chartMap[k] = {name:k, count:0, weight:0, TWD:0, USD:0};
                    
                    chartMap[k].count += 1;
                    chartMap[k].weight += safeNum(s.totalWeight);

                    const amt = (s.products||[]).reduce((a,p)=>a+safeNum(p.amount),0);
                    if(s.currency==='USD') chartMap[k].USD += amt; else chartMap[k].TWD += amt;
                });
                const chartData = Object.values(chartMap);

                return { count, items, w, moneyUSD, moneyTWD, top, chartData, maxVal };
            }, [shipments, filterMonth, search]);
            
            return (
                <div className="space-y-6 animate-[fade-in_0.3s_ease-out] pb-20">
                    <div className="flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">Áµ±Ë®àÂÑÄË°®Êùø</h2>
                            <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="bg-white border border-gray-300 rounded-lg px-3 py-1 text-sm outline-none font-bold text-gray-700">
                                <option value="ALL">ÂÖ®ÈÉ®Êúà‰ªΩ</option>
                                {availableMonths.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                        <input placeholder="ÊêúÂ∞ãÁî¢ÂìÅ„ÄÅÂª†ÂïÜ..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full bg-white text-gray-900 rounded-xl py-2 px-4 outline-none shadow-sm text-sm border border-gray-100" />
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">Á∏ΩÁ≠ÜÊï∏</div><div className="text-2xl font-black text-gray-800">{stats.count}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">Á∏Ω‰ª∂Êï∏</div><div className="text-2xl font-black text-blue-600">{stats.items.toLocaleString()}</div></div>
                        <div className="bg-white p-4 rounded-2xl border shadow-sm col-span-2"><div className="text-gray-400 text-xs font-bold mb-1">Á∏ΩÈáçÈáè (kg)</div><div className="text-2xl font-black text-orange-500">{format2(stats.w)}</div></div>
                        {canSeePrice() && (
                            <>
                                <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">ÁæéÈáëÁ∏ΩÈ°ç (USD)</div><div className="text-xl font-black text-emerald-600">${format2(stats.moneyUSD)}</div></div>
                                <div className="bg-white p-4 rounded-2xl border shadow-sm"><div className="text-gray-400 text-xs font-bold mb-1">Âè∞Âπ£Á∏ΩÈ°ç (TWD)</div><div className="text-xl font-black text-emerald-600">${format2(stats.moneyTWD)}</div></div>
                            </>
                        )}
                    </div>
                    {canSeePrice() && <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">üìÖ ÊúàÂ∫¶Êé°Ë≥ºÁµ±Ë®àË°®</h3><MonthlySummaryTable data={stats.chartData} /></div>}
                     <div className="bg-white p-5 rounded-2xl border shadow-sm"><h3 className="text-sm font-bold text-gray-800 mb-4">üèÜ Ââç‰∫îÂ§ßÂª†ÂïÜ</h3><div className="space-y-3">{stats.top.map(([n,c],i)=><div key={n} className="flex items-center gap-3"><div className="w-6 text-xs font-bold text-gray-400">#{i+1}</div><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-gray-700">{n}</span><span className="text-gray-500">{c} Á≠Ü</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width:`${(c/stats.maxVal)*100}%`}}></div></div></div></div>)}</div></div>
                </div>
            );
        };

        // 6. Main App
        function ContainerApp() {
            const [user, setUser] = useState(null);
            const [shipments, setShipments] = useState([]);
            const [view, setView] = useState('list'); 
            const [displayMode, setDisplayMode] = useState('card');
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [currentTab, setCurrentTab] = useState('NOT_DEVANED'); 
            const [userRole, setUserRole] = useState('GUEST');
            const [formData, setFormData] = useState(initialFormState);
            const [showNotifications, setShowNotifications] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [showFileModal, setShowFileModal] = useState(false);
            const [fileList, setFileList] = useState([]);
            const [validationErrors, setValidationErrors] = useState({});
            const [showValidationToast, setShowValidationToast] = useState(false);
            const [validationMessage, setValidationMessage] = useState('');
            
            // V74.0: Excel ÂåØÂÖ•Áõ∏ÈóúÁãÄÊÖã
            const [showImportModal, setShowImportModal] = useState(false);
            const [importData, setImportData] = useState([]);
            const [importProcessing, setImportProcessing] = useState(false);
            const [importProgress, setImportProgress] = useState({ current: 0, total: 0 });
            
            // V75.0: Áî¢ÂìÅ‰∏ªÊ™îÁõ∏ÈóúÁãÄÊÖã
            const [products, setProducts] = useState([]);
            const [productSearchTerm, setProductSearchTerm] = useState('');
            const [showProductModal, setShowProductModal] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [showProductImportModal, setShowProductImportModal] = useState(false);
            const [productImportData, setProductImportData] = useState([]);
            
            // V76.0: Áî¢ÂìÅÈÅ∏ÊìáÂô®ÁãÄÊÖã
            const [activeProductPicker, setActiveProductPicker] = useState(null); // ÁõÆÂâçÈñãÂïüÈÅ∏ÊìáÂô®ÁöÑÁî¢ÂìÅÁ¥¢Âºï
            const [productPickerSearch, setProductPickerSearch] = useState('');
            
            // V78.5: Ë°®ÂñÆÊ≠•È©ü/ÊäòÁñäÁãÄÊÖã
            const [formStep, setFormStep] = useState(1); // Êñ∞Â¢ûÊôÇÁöÑÊ≠•È©ü (1-4)
            const [openSections, setOpenSections] = useState(['basic']); // Á∑®ËºØÊôÇÂ±ïÈñãÁöÑÂçÄÂ°ä
            
            // V79.0: Êô∫ËÉΩÂåØÂÖ•ÂäüËÉΩÁãÄÊÖã
            const [showImportSelector, setShowImportSelector] = useState(false); // È°ØÁ§∫ÂåØÂÖ•ÊñπÂºèÈÅ∏ÊìáÂô®
            const [parsedDocuments, setParsedDocuments] = useState([]); // Â∑≤Ëß£ÊûêÁöÑÊñá‰ª∂ [{name, type, text}]
            const [isParsing, setIsParsing] = useState(false); // Ê≠£Âú®Ëß£Êûê PDF
            const [parseProgress, setParseProgress] = useState(''); // Ëß£ÊûêÈÄ≤Â∫¶ÊèêÁ§∫
            
            // V79.0: AI Ëá™ÂãïÂ°´ÂÖ•Áõ∏ÈóúÁãÄÊÖã
            const [aiExtractedData, setAiExtractedData] = useState(null); // AI ÊèêÂèñÁöÑÁµêÊßãÂåñË≥áÊñô
            const [showAiPreview, setShowAiPreview] = useState(false); // È°ØÁ§∫ AI Ëß£ÊûêÈ†êË¶ΩÁ¢∫Ë™ç
            const [isAiProcessing, setIsAiProcessing] = useState(false); // AI Ê≠£Âú®ËôïÁêÜ
            const [fieldSources, setFieldSources] = useState({}); // ÂêÑÊ¨Ñ‰ΩçÁöÑË≥áÊñô‰æÜÊ∫ê
            const [fieldConflicts, setFieldConflicts] = useState({}); // Ê¨Ñ‰ΩçË°ùÁ™Å
            const [duplicateContainer, setDuplicateContainer] = useState(null); // ÈáçË§áÁöÑÊ´ÉËôüË≥áË®ä
            
            // V79.0: Gemini API Key Ë®≠ÂÆö
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);
            const [geminiApiKey, setGeminiApiKey] = useState(() => {
                try { return localStorage.getItem('gemini_api_key') || ''; } 
                catch { return ''; }
            });
            const [tempApiKey, setTempApiKey] = useState('');
            
            // V79.1: ÊâπËôüËôïÁêÜÊ®°ÂºèË®≠ÂÆö ('merge' = Âêà‰ΩµÂèñÊúÄÊó©ÊïàÊúü, 'split' = ÂÆåÂÖ®ÊãÜÂàÜ)
            const [batchMergeMode, setBatchMergeMode] = useState(() => {
                try { return localStorage.getItem('batch_merge_mode') || 'merge'; } 
                catch { return 'merge'; }
            });
            
            // V79.3: Â§öÈÅ∏ÂåØÂá∫ÁãÄÊÖã
            const [selectMode, setSelectMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            
            // V79.4: Ë°®Ê†ºÊéíÂ∫èÁãÄÊÖã
            const [sortField, setSortField] = useState('arrivalDate');
            const [sortOrder, setSortOrder] = useState('desc'); // 'asc' or 'desc'
            
            // V79.4: ÈªûÊìäË°®È†≠ÊéíÂ∫è
            const handleSort = (field) => {
                if (sortField === field) {
                    setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortOrder('asc');
                }
            };
            
            // ÂÑ≤Â≠ò API Key Âà∞ localStorage
            const saveApiKey = (key) => {
                try {
                    localStorage.setItem('gemini_api_key', key);
                    setGeminiApiKey(key);
                    setShowApiKeyModal(false);
                    alert('API Key Â∑≤ÂÑ≤Â≠òÔºÅ');
                } catch (e) {
                    alert('ÂÑ≤Â≠òÂ§±Êïó: ' + e.message);
                }
            };
            
            // V79.1: ÂÑ≤Â≠òÊâπËôüËôïÁêÜÊ®°Âºè
            const saveBatchMergeMode = (mode) => {
                try {
                    localStorage.setItem('batch_merge_mode', mode);
                    setBatchMergeMode(mode);
                } catch (e) {
                    console.error('ÂÑ≤Â≠òÊâπËôüÊ®°ÂºèÂ§±Êïó:', e);
                }
            };

            // V72.0: ÁßªÈô§ÈáçË§áÁöÑ Icons Ë≥¶ÂÄºÔºå‰ΩøÁî®ÂÖ®ÂüüÂÆöÁæ©ÁöÑ I

            // Actions
            const handleLogout = useCallback(() => { if(auth) auth.signOut(); else window.location.reload(); }, []);
            const handleAdminLogin = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (error) { alert(TEXT.LOGIN_FAILED + ": " + error.message); } };
            const handleGuestLogin = async () => { try { await auth.signInAnonymously(); } catch (error) { alert(TEXT.GUEST_LOGIN_FAILED); } };
            const handleDelete = async (id) => { if(confirm(TEXT.CONFIRM_DELETE)) await db.collection('shipments').doc(id).delete(); };
            const handleWarehouseConfirm = async (e, item) => { e.stopPropagation(); if (!canEditWarehouseFields()) return alert(TEXT.PERMISSION_DENIED); try { await db.collection('shipments').doc(item.id).update({ warehouseConfirmed: !item.warehouseConfirmed }); } catch (err) { alert(err.message); } };
            
            const handleExport = () => { 
                if (userRole === 'GUEST') return alert(TEXT.PERMISSION_DENIED); 
                
                // V79.3: ÈÄ≤ÂÖ•Â§öÈÅ∏Ê®°Âºè
                setSelectMode(true);
                setSelectedIds(new Set());
            };
            
            // V79.3: ÂàáÊèõÈÅ∏Âèñ
            const toggleSelect = (id) => {
                setSelectedIds(prev => {
                    const next = new Set(prev);
                    if (next.has(id)) next.delete(id);
                    else next.add(id);
                    return next;
                });
            };
            
            // V79.3: ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏
            const toggleSelectAll = () => {
                if (selectedIds.size === filteredList.length) {
                    setSelectedIds(new Set());
                } else {
                    setSelectedIds(new Set(filteredList.map(s => s.id)));
                }
            };
            
            // V79.3: ÂèñÊ∂àÂ§öÈÅ∏Ê®°Âºè
            const cancelSelectMode = () => {
                setSelectMode(false);
                setSelectedIds(new Set());
            };
            
            // V79.3: Âü∑Ë°åÊâπÊ¨°ÂåØÂá∫ ExcelÔºà‰∏ÄÊ´É‰∏ÄÂ∑•‰ΩúË°®ÔºåÂ§ßÂ≠óÈ´î+ÈÇäÊ°ÜÊ†ºÂºèÔºâ
            const executeExport = () => {
                if (selectedIds.size === 0) return alert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂåØÂá∫ÁöÑË≤®Ê´É');
                
                const showPrice = canSeePrice();
                const selectedList = filteredList.filter(s => selectedIds.has(s.id));
                
                console.log('ÂåØÂá∫Ë≤®Ê´ÉÊï∏Èáè:', selectedList.length);
                
                // Ê®£ÂºèÂÆöÁæ©
                const thin = { style: 'thin', color: { rgb: '000000' } };
                const medium = { style: 'medium', color: { rgb: '000000' } };
                const borderAll = { top: thin, bottom: thin, left: thin, right: thin };
                const borderThick = { top: medium, bottom: medium, left: thin, right: thin };
                
                // Âª∫Á´ãÂ∑•‰ΩúÁ∞ø
                const wb = XLSX.utils.book_new();
                
                selectedList.forEach((container, idx) => {
                    const info = container;
                    const products = container.products || [];
                    // Ê¨Ñ‰ΩçÔºöÂìÅÂêç„ÄÅË¶èÊ†º„ÄÅÊâπËôü„ÄÅÊïàÊúü„ÄÅÊï∏Èáè„ÄÅÈáçÈáè„ÄÅÂñÆÂÉπ„ÄÅÈáëÈ°çÔºàÁßªÈô§ÁÆ±ÂÆπÔºâ
                    const colCount = showPrice ? 8 : 6;
                    
                    console.log(`ËôïÁêÜÁ¨¨ ${idx + 1} ÂÄã: ${info.containerNumber}, Áî¢ÂìÅÊï∏: ${products.length}`);
                    
                    // Â∑•‰ΩúË°®ÂêçÁ®±
                    const sheetName = `${idx + 1}_${(info.containerNumber || 'NA').slice(-8)}`.substring(0, 31);
                    
                    // Áî® aoa Âª∫Á´ãÂü∫Êú¨Â∑•‰ΩúË°®
                    const aoa = [];
                    
                    // Row 0: Ê®ôÈ°å
                    aoa.push(['Ë≤®Ê´ÉÊòéÁ¥∞Ë°®']);
                    // Row 1: Á©∫Ë°å
                    aoa.push([]);
                    // Row 2: Ë≥áË®äÁ¨¨‰∏ÄÂàóÔºàÈÄ≤Âè£„ÄÅÂ∫èËôü„ÄÅÂª†ÂïÜ„ÄÅÁî¢Âú∞Ôºâ
                    const infoRow1 = [`ÈÄ≤Âè£Ôºö${info.importCompany || ''}`, `Â∫èËôüÔºö${info.vendorSeqNo || ''}`, `Âª†ÂïÜÔºö${info.supplier || ''}`, `Áî¢Âú∞Ôºö${info.origin || ''}`];
                    while (infoRow1.length < colCount) infoRow1.push('');
                    aoa.push(infoRow1);
                    // Row 3: Ë≥áË®äÁ¨¨‰∫åÂàóÔºàÊ´ÉËôü„ÄÅÂà∞Ê∏ØÊó•„ÄÅÂ†±ÈóúÔºâ
                    const infoRow2 = [`Ê´ÉËôüÔºö${info.containerNumber || ''}`, `Âà∞Ê∏ØÊó•Ôºö${info.arrivalDate || ''}`, `Â†±ÈóúÔºö${info.customsBroker || ''}`];
                    while (infoRow2.length < colCount) infoRow2.push('');
                    aoa.push(infoRow2);
                    // Row 4: Á©∫Ë°å
                    aoa.push([]);
                    // Row 5: Ë°®È†≠ÔºàÂìÅÂêç„ÄÅË¶èÊ†º„ÄÅÊâπËôü„ÄÅÊïàÊúü„ÄÅÊï∏Èáè„ÄÅÈáçÈáè„ÄÅÂñÆÂÉπ„ÄÅÈáëÈ°çÔºâ
                    const headers = ['ÂìÅÂêç', 'Ë¶èÊ†º', 'ÊâπËôü', 'ÊïàÊúü', 'Êï∏Èáè', 'ÈáçÈáè(kg)'];
                    if (showPrice) headers.push('ÂñÆÂÉπ', 'ÈáëÈ°ç');
                    aoa.push(headers);
                    
                    // Áî¢ÂìÅË≥áÊñô
                    let sumQty = 0, sumWeight = 0, sumAmount = 0;
                    products.forEach(p => {
                        const row = [
                            p.name || '',
                            p.spec || '',
                            p.batchNumber || '',
                            p.expiryDate || '',
                            safeNum(p.quantity),
                            safeNum(p.weight)
                        ];
                        if (showPrice) {
                            row.push(safeNum(p.unitPrice));
                            row.push(safeNum(p.amount));
                        }
                        aoa.push(row);
                        sumQty += safeNum(p.quantity);
                        sumWeight += safeNum(p.weight);
                        if (showPrice) sumAmount += safeNum(p.amount);
                    });
                    
                    // ÂêàË®àÂàó
                    const totalRow = ['Âêà„ÄÄË®à', '', '', '', sumQty, sumWeight];
                    if (showPrice) totalRow.push('', sumAmount);
                    aoa.push(totalRow);
                    
                    // Âª∫Á´ãÂ∑•‰ΩúË°®
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    
                    // Â•óÁî®Ê®£Âºè
                    const headerRowIdx = 5;
                    const dataStartIdx = 6;
                    const dataEndIdx = 5 + products.length;
                    const totalRowIdx = dataEndIdx + 1;
                    
                    // Ë≥áË®äÂçÄÊ®£ÂºèÔºà14pt Á≤óÈ´îÔºâ- Row 2 Âíå Row 3
                    for (let r = 2; r <= 3; r++) {
                        for (let c = 0; c < colCount; c++) {
                            const cellRef = XLSX.utils.encode_cell({ r, c });
                            if (ws[cellRef]) {
                                ws[cellRef].s = {
                                    font: { name: 'ÂæÆËªüÊ≠£ÈªëÈ´î', sz: 14, bold: true },
                                    alignment: { vertical: 'center' }
                                };
                            }
                        }
                    }
                    
                    // Ë°®È†≠Ê®£ÂºèÔºàÁ≤óÊ°ÜÔºâ
                    for (let c = 0; c < colCount; c++) {
                        const cell = ws[XLSX.utils.encode_cell({ r: headerRowIdx, c })];
                        if (cell) {
                            cell.s = {
                                font: { name: 'ÂæÆËªüÊ≠£ÈªëÈ´î', sz: 14, bold: true },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: borderThick
                            };
                        }
                    }
                    
                    // Ë≥áÊñôÂàóÊ®£ÂºèÔºàÁ¥∞Ê°ÜÔºâ
                    for (let r = dataStartIdx; r <= dataEndIdx; r++) {
                        for (let c = 0; c < colCount; c++) {
                            const cellRef = XLSX.utils.encode_cell({ r, c });
                            if (!ws[cellRef]) ws[cellRef] = { v: '', t: 's' };
                            const cell = ws[cellRef];
                            
                            // Â∞çÈΩäÔºöÂìÅÂêçË¶èÊ†ºÈù†Â∑¶„ÄÅÊâπËôüÊïàÊúüÁΩÆ‰∏≠„ÄÅÊï∏Â≠óÈù†Âè≥
                            let align = 'left';
                            if (c === 0 || c === 1) align = 'left';  // ÂìÅÂêç„ÄÅË¶èÊ†º
                            if (c === 2 || c === 3) align = 'center';  // ÊâπËôü„ÄÅÊïàÊúü
                            if (c >= 4) align = 'right';  // Êï∏Èáè„ÄÅÈáçÈáè„ÄÅÂñÆÂÉπ„ÄÅÈáëÈ°ç
                            
                            cell.s = {
                                font: { name: 'ÂæÆËªüÊ≠£ÈªëÈ´î', sz: 14 },
                                alignment: { horizontal: align, vertical: 'center' },
                                border: borderAll
                            };
                            
                            // Êï∏Â≠óÊ†ºÂºè
                            if (c === 4 || c === 5) cell.z = '#,##0';  // Êï∏Èáè„ÄÅÈáçÈáè
                            if (c === 6 && showPrice) cell.z = '#,##0.00';  // ÂñÆÂÉπÂÖ©‰ΩçÂ∞èÊï∏
                            if (c === 7 && showPrice) cell.z = '#,##0.00';  // ÈáëÈ°çÂÖ©‰ΩçÂ∞èÊï∏
                        }
                    }
                    
                    // ÂêàË®àÂàóÊ®£ÂºèÔºàÁ≤óÊ°ÜÔºâ
                    for (let c = 0; c < colCount; c++) {
                        const cellRef = XLSX.utils.encode_cell({ r: totalRowIdx, c });
                        if (!ws[cellRef]) ws[cellRef] = { v: '', t: 's' };
                        const cell = ws[cellRef];
                        
                        cell.s = {
                            font: { name: 'ÂæÆËªüÊ≠£ÈªëÈ´î', sz: 14, bold: true },
                            alignment: { horizontal: c === 0 ? 'center' : 'right', vertical: 'center' },
                            border: borderThick
                        };
                        
                        if (c === 4 || c === 5) cell.z = '#,##0';  // Êï∏Èáè„ÄÅÈáçÈáè
                        if (c === 7 && showPrice) cell.z = '#,##0.00';  // ÂêàË®àÈáëÈ°çÂÖ©‰ΩçÂ∞èÊï∏
                    }
                    
                    // Ê®ôÈ°åÊ®£Âºè
                    if (ws['A1']) {
                        ws['A1'].s = {
                            font: { name: 'ÂæÆËªüÊ≠£ÈªëÈ´î', sz: 20, bold: true },
                            alignment: { horizontal: 'center', vertical: 'center' }
                        };
                    }
                    
                    // Âêà‰ΩµÊ®ôÈ°å
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: colCount - 1 } }];
                    
                    // Ê¨ÑÂØ¨ÔºàË™øÊï¥Ôºâ
                    ws['!cols'] = [
                        { wch: 16 },  // ÂìÅÂêç
                        { wch: 24 },  // Ë¶èÊ†º
                        { wch: 14 },  // ÊâπËôü
                        { wch: 12 },  // ÊïàÊúü
                        { wch: 10 },  // Êï∏Èáè
                        { wch: 12 },  // ÈáçÈáè
                        ...(showPrice ? [{ wch: 10 }, { wch: 14 }] : [])  // ÂñÆÂÉπ„ÄÅÈáëÈ°ç
                    ];
                    
                    // ÂàóÈ´ò
                    ws['!rows'] = [
                        { hpt: 32 }, { hpt: 18 }, { hpt: 26 }, { hpt: 26 },
                        { hpt: 18 }, { hpt: 28 }
                    ];
                    for (let i = 6; i <= totalRowIdx; i++) {
                        ws['!rows'][i] = { hpt: 26 };
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    console.log(`Â∑•‰ΩúË°® ${sheetName} Â∑≤Âä†ÂÖ•`);
                });
                
                console.log('Â∑•‰ΩúÁ∞øÂ∑•‰ΩúË°®Êï∏:', wb.SheetNames.length);
                
                // ÂåØÂá∫
                const fileName = 'Ë≤®Ê´ÉÊòéÁ¥∞_' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '.xlsx';
                XLSX.writeFile(wb, fileName);
                
                cancelSelectMode();
                alert(`Â∑≤ÂåØÂá∫ ${selectedList.length} ÂÄãË≤®Ê´ÉÔºÅ\nÂàóÂç∞ÊôÇË´ãÈÅ∏Êìá„ÄåÊï¥Êú¨Ê¥ªÈ†ÅÁ∞ø„Äç`);
            };

            // V79.0: PDF Ëß£ÊûêÂäüËÉΩ - ÊîØÊè¥Â§öÊ™îÊ°à
            const detectDocumentType = (text, fileName) => {
                const lowerText = text.toLowerCase();
                const lowerName = fileName.toLowerCase();
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊïàÊúüÊ∏ÖÂñÆÔºàÂÑ™ÂÖàÂà§Êñ∑ÔºåÂõ†ÁÇ∫ÂèØËÉΩÂêåÊôÇÂåÖÂê´ÂÖ∂‰ªñÈóúÈçµÂ≠óÔºâ
                const hasExpiryList = lowerText.includes('expiration date') || 
                    lowerText.includes('expiry date') ||
                    lowerText.includes('fecha de vencimiento') ||  // Ë•øÁè≠ÁâôÊñáÔºöÊïàÊúü
                    lowerText.includes('reporte de lotes') ||      // Ë•øÁè≠ÁâôÊñáÔºöÊâπÊ¨°Â†±Âëä
                    (lowerText.includes('production date') && lowerText.includes('lot s/n')) || // Ê≥∞Âúã YEENIN Ê†ºÂºè
                    (lowerText.includes('lot #') && lowerText.includes('date')) ||
                    (lowerText.includes('lot s/n') && lowerText.includes('exp'));
                
                if (hasExpiryList || lowerName.includes('expir') || lowerName.includes('batch') || 
                    lowerName.includes('ÊïàÊúü') || lowerName.includes('lote') || lowerName.includes('code')) {
                    return { type: 'expiry', label: 'ÊâπËôüÊïàÊúüÊ∏ÖÂñÆ', icon: 'üìã' };
                }
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Êô∫Âà© Packing ListÔºàË•øÁè≠ÁâôÊñáÔºâ
                const isChilePL = lowerText.includes('nro de contenedo') ||  // Ê´ÉËôü
                    lowerText.includes('mn vuelo') ||                          // ËàπÂêçËà™Ê¨°
                    lowerText.includes('cuenta de caja') ||                    // ‰ª∂Êï∏
                    lowerText.includes('suma de peso');                        // ÈáçÈáè
                
                if (isChilePL) {
                    return { type: 'packing', label: 'Packing List (Êô∫Âà©)', icon: 'üì¶' };
                }
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë§áÂêàÊñá‰ª∂ÔºàÂåÖÂê´Â§öÁ®ÆÊñá‰ª∂È°ûÂûãÔºâ
                const hasInvoice = lowerText.includes('invoice') && (lowerText.includes('unit price') || lowerText.includes('amount'));
                const hasPacking = lowerText.includes('packing list') || (lowerText.includes('n. w.') && lowerText.includes('g. w.'));
                const hasBatchCode = lowerText.includes('bag code');
                
                // Â¶ÇÊûúÊòØË§áÂêàÊñá‰ª∂
                if ((hasInvoice && hasPacking) || (hasInvoice && hasBatchCode) || (hasPacking && hasBatchCode)) {
                    return { type: 'combined', label: 'Ë§áÂêàÊñá‰ª∂ (Invoice+PL+ÊâπËôü)', icon: 'üìë' };
                }
                
                // 1. ÂÑ™ÂÖàÊ†πÊìöÊ™îÂêçÂà§Êñ∑Ôºà‰ΩÜÊéíÈô§Ë§áÂêàÊ™îÂêçÔºâ
                if ((lowerName.includes('invoice') || lowerName.includes('inv')) && !lowerName.includes('packing')) {
                    return { type: 'invoice', label: 'Commercial Invoice', icon: 'üìÑ' };
                }
                if ((lowerName.includes('packing') || lowerName.includes('pkl') || lowerName.includes('pl')) && !lowerName.includes('inv')) {
                    return { type: 'packing', label: 'Packing List', icon: 'üì¶' };
                }
                if (lowerName.includes('bol') || lowerName.includes('b-l') || lowerName.includes('lading') || 
                    (lowerName === 'bl.pdf') || lowerName.match(/\bbl\b/)) {
                    return { type: 'bl', label: 'Bill of Lading', icon: 'üö¢' };
                }
                if (lowerName.includes('notice') || lowerName.includes('arrival') || lowerName.includes('ÈÄöÁü•')) {
                    return { type: 'arrival', label: 'Âà∞Ë≤®ÈÄöÁü•', icon: 'üì¨' };
                }
                
                // 2. Ê†πÊìöÂÖßÂÆπÁâπÂæµÂà§Êñ∑
                if (lowerText.includes('bill of lading') || lowerText.includes('b/l no') ||
                    lowerText.includes('container no') || lowerText.includes('container/seal') ||
                    lowerText.includes('cntr no') || lowerText.includes('seal no') ||
                    (lowerText.includes('shipper') && lowerText.includes('consignee') && lowerText.includes('vessel'))) {
                    return { type: 'bl', label: 'Bill of Lading', icon: 'üö¢' };
                }
                
                if (hasInvoice) {
                    return { type: 'invoice', label: 'Commercial Invoice', icon: 'üìÑ' };
                }
                
                if (hasPacking) {
                    return { type: 'packing', label: 'Packing List', icon: 'üì¶' };
                }
                
                if (lowerText.includes('Âà∞Ë≤®ÈÄöÁü•') || lowerText.includes('arrival notice') || 
                    lowerText.includes('ËàπÂà∞Êó•') || lowerText.includes('ÊãÜÊ´ÉÂú∞')) {
                    return { type: 'arrival', label: 'Âà∞Ë≤®ÈÄöÁü•', icon: 'üì¨' };
                }
                
                return { type: 'other', label: 'ÂÖ∂‰ªñÊñá‰ª∂', icon: 'üìé' };
            };
            
            const handlePdfUpload = async (e) => {
                const files = Array.from(e.target.files || []);
                if (files.length === 0) return;
                
                // ÊîØÊè¥ PDF Âíå Excel Ê™îÊ°à
                const supportedFiles = files.filter(f => 
                    f.type === 'application/pdf' || 
                    f.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    f.type === 'application/vnd.ms-excel' ||
                    f.name.endsWith('.xlsx') ||
                    f.name.endsWith('.xls')
                );
                
                if (supportedFiles.length === 0) {
                    alert('Ë´ã‰∏äÂÇ≥ PDF Êàñ Excel Ê™îÊ°à');
                    return;
                }
                
                setIsParsing(true);
                const newDocs = [];
                
                try {
                    for (let i = 0; i < supportedFiles.length; i++) {
                        const file = supportedFiles[i];
                        setParseProgress(`Ëß£ÊûêÊñá‰ª∂ (${i + 1}/${supportedFiles.length}): ${file.name}`);
                        
                        const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') ||
                            file.type.includes('spreadsheet') || file.type.includes('excel');
                        
                        if (isExcel) {
                            // Excel Ê™îÊ°àËôïÁêÜ
                            const arrayBuffer = await file.arrayBuffer();
                            const workbook = XLSX.read(arrayBuffer);
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            
                            // ËΩâÊèõÁÇ∫ÊñáÂ≠óÊ†ºÂºè‰æõ AI Ëß£Êûê
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                            let excelText = `=== Excel Ê™îÊ°à: ${file.name} ===\n`;
                            
                            // Â∞á Excel Ë≥áÊñôËΩâÁÇ∫ÊòìËÆÄÊ†ºÂºè
                            jsonData.forEach((row, rowIdx) => {
                                if (row.some(cell => cell !== '')) {
                                    const rowText = row.map((cell, colIdx) => {
                                        if (cell === '') return '';
                                        // ËôïÁêÜÊó•Êúü
                                        if (typeof cell === 'number' && cell > 40000 && cell < 60000) {
                                            const date = XLSX.SSF.parse_date_code(cell);
                                            if (date) {
                                                return `${date.y}-${String(date.m).padStart(2,'0')}-${String(date.d).padStart(2,'0')}`;
                                            }
                                        }
                                        return String(cell);
                                    }).filter(c => c !== '').join(' | ');
                                    if (rowText.trim()) {
                                        excelText += rowText + '\n';
                                    }
                                }
                            });
                            
                            const docType = detectDocumentType(excelText, file.name);
                            console.log(`üìä Excel Ë≠òÂà•: ${file.name} ‚Üí ${docType.label}`);
                            console.log(`üìù Excel ÂÖßÂÆπÂâç500Â≠ó:`, excelText.substring(0, 500));
                            
                            newDocs.push({
                                id: Date.now() + '_' + i,
                                name: file.name,
                                text: excelText.trim(),
                                ...docType
                            });
                        } else {
                            // PDF Ê™îÊ°àËôïÁêÜÔºàÂéüÊúâÈÇèËºØÔºâ
                            // ËÆÄÂèñÊ™îÊ°àÁÇ∫ base64ÔºàÂÖà‰øùÂ≠òÔºåÂõ†ÁÇ∫ arrayBuffer ÊúÉË¢´ PDF.js detachÔºâ
                            const fileBase64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = () => {
                                    const base64 = reader.result.split(',')[1];
                                    resolve(base64);
                                };
                                reader.readAsDataURL(file);
                            });
                            
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            let fullText = '';
                            
                            for (let p = 1; p <= pdf.numPages; p++) {
                                const page = await pdf.getPage(p);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n';
                            }
                            
                            // Ê™¢Êü•ÊòØÂê¶ÊàêÂäüÊèêÂèñÊñáÂ≠óÔºàÊéÉÊèèÊ™îÂèØËÉΩÁÑ°Ê≥ïÊèêÂèñÔºâ
                            const cleanText = fullText.replace(/\s+/g, '').trim();
                            if (cleanText.length < 50) {
                                console.warn(`‚ö†Ô∏è ${file.name} ÊñáÂ≠óÂÖßÂÆπÈÅéÂ∞ëÔºåÂ∞á‰ΩøÁî® AI Ë¶ñË¶∫Ëß£Êûê`);
                                const docType = detectDocumentType(file.name, file.name);
                                newDocs.push({
                                    id: Date.now() + '_' + i,
                                    name: file.name,
                                    text: '',
                                    base64: fileBase64,
                                    mimeType: 'application/pdf',
                                    isScanned: true,
                                    ...docType,
                                    label: docType.label + ' (ÊéÉÊèè)',
                                    icon: 'üñºÔ∏è'
                                });
                                continue;
                            }
                            
                            const docType = detectDocumentType(fullText, file.name);
                            console.log(`üìÑ Êñá‰ª∂Ë≠òÂà•: ${file.name} ‚Üí ${docType.label} (${docType.type})`);
                            console.log(`üìù Êñá‰ª∂ÂÖßÂÆπÂâç300Â≠ó:`, fullText.substring(0, 300));
                            newDocs.push({
                                id: Date.now() + '_' + i,
                                name: file.name,
                                text: fullText.trim(),
                                ...docType
                            });
                        }
                    }
                    
                    // ‰øÆÊ≠£ÔºöÁßªÈô§ÂêåÂêçÁöÑËàäÊñá‰ª∂ÔºåÈÅøÂÖçÈáçË§á
                    const newFileNames = newDocs.map(d => d.name);
                    const filteredOldDocs = parsedDocuments.filter(d => !newFileNames.includes(d.name));
                    const allDocs = [...filteredOldDocs, ...newDocs];
                    
                    setParsedDocuments(allDocs);
                    setIsParsing(false);
                    
                    // Ê™¢Êü•ÊòØÂê¶ÊúâÊéÉÊèèÊ™î
                    const scannedDocs = allDocs.filter(d => d.isScanned);
                    const textDocs = allDocs.filter(d => !d.isScanned && d.text);
                    
                    if (scannedDocs.length > 0) {
                        console.log(`üì∑ ${scannedDocs.length} ‰ªΩÊéÉÊèèÊ™îÂ∞á‰ΩøÁî® AI Ë¶ñË¶∫Ëß£Êûê`);
                    }
                    
                    // Ê†πÊìöÊòØÂê¶Êúâ API Key Ê±∫ÂÆöËôïÁêÜÊñπÂºè
                    if (geminiApiKey && allDocs.length > 0) {
                        // Êúâ API KeyÔºåÂëºÂè´ AI ËôïÁêÜÔºàÂåÖÂê´ÊéÉÊèèÊ™îÔºâ
                        await processWithAI(allDocs);
                    } else if (allDocs.length > 0) {
                        // ÁÑ° API KeyÔºåÁõ¥Êé•ÈÄ≤ÂÖ•Ë°®ÂñÆÔºàÊâãÂãïÊ®°ÂºèÔºâ
                        setShowImportSelector(false);
                        setFormStep(1);
                        setView('form');
                    }
                    
                } catch (err) {
                    console.error('PDF Ëß£ÊûêÈåØË™§:', err);
                    alert('PDF Ëß£ÊûêÂ§±Êïó: ' + err.message);
                    setIsParsing(false);
                } finally {
                    setParseProgress('');
                    e.target.value = '';
                }
            };
            
            // V79.0: Ë£úÂÖÖ‰∏äÂÇ≥ÔºàÂêÑÊ≠•È©ü‰ΩøÁî®Ôºå‰∏çËß∏Áôº AIÔºâ
            const handleSupplementUpload = async (e) => {
                const files = Array.from(e.target.files || []);
                if (files.length === 0) return;
                
                // ÊîØÊè¥ PDF Âíå Excel Ê™îÊ°à
                const supportedFiles = files.filter(f => 
                    f.type === 'application/pdf' || 
                    f.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    f.type === 'application/vnd.ms-excel' ||
                    f.name.endsWith('.xlsx') ||
                    f.name.endsWith('.xls')
                );
                if (supportedFiles.length === 0) return;
                
                setIsParsing(true);
                const newDocs = [];
                
                try {
                    for (let i = 0; i < supportedFiles.length; i++) {
                        const file = supportedFiles[i];
                        setParseProgress(`Ëß£Êûê‰∏≠: ${file.name}`);
                        
                        const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') ||
                            file.type.includes('spreadsheet') || file.type.includes('excel');
                        
                        if (isExcel) {
                            // Excel Ê™îÊ°àËôïÁêÜ
                            const arrayBuffer = await file.arrayBuffer();
                            const workbook = XLSX.read(arrayBuffer);
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                            
                            let excelText = `=== Excel Ê™îÊ°à: ${file.name} ===\n`;
                            jsonData.forEach((row) => {
                                if (row.some(cell => cell !== '')) {
                                    const rowText = row.map((cell) => {
                                        if (cell === '') return '';
                                        if (typeof cell === 'number' && cell > 40000 && cell < 60000) {
                                            const date = XLSX.SSF.parse_date_code(cell);
                                            if (date) return `${date.y}-${String(date.m).padStart(2,'0')}-${String(date.d).padStart(2,'0')}`;
                                        }
                                        return String(cell);
                                    }).filter(c => c !== '').join(' | ');
                                    if (rowText.trim()) excelText += rowText + '\n';
                                }
                            });
                            
                            const docType = detectDocumentType(excelText, file.name);
                            newDocs.push({ id: Date.now() + '_' + i, name: file.name, text: excelText.trim(), ...docType });
                        } else {
                            // PDF Ê™îÊ°àËôïÁêÜ
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            let fullText = '';
                            
                            for (let p = 1; p <= pdf.numPages; p++) {
                                const page = await pdf.getPage(p);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n';
                            }
                            
                            const docType = detectDocumentType(fullText, file.name);
                            newDocs.push({ id: Date.now() + '_' + i, name: file.name, text: fullText.trim(), ...docType });
                        }
                    }
                    
                    setParsedDocuments(prev => [...prev, ...newDocs]);
                } catch (err) {
                    console.error('Êñá‰ª∂Ëß£ÊûêÈåØË™§:', err);
                    alert('Êñá‰ª∂Ëß£ÊûêÂ§±Êïó: ' + err.message);
                } finally {
                    setIsParsing(false);
                    setParseProgress('');
                    e.target.value = '';
                }
            };
            
            // V79.0: ÈñãÂßãÊñ∞Â¢ûË≤®Ê´ÉÔºàÈ°ØÁ§∫ÈÅ∏ÊìáÂô®Ôºâ
            const handleStartNewContainer = () => {
                setFormData(initialFormState);
                setEditingId(null);
                setParsedDocuments([]);
                setAiExtractedData(null);
                setFieldSources({});
                setFieldConflicts({});
                setDuplicateContainer(null);
                setShowImportSelector(true);
            };
            
            // V79.0: ÈÅ∏ÊìáÊâãÂãïÂ°´ÂØ´
            const handleManualEntry = () => {
                setShowImportSelector(false);
                setFormStep(1);
                setView('form');
            };
            
            // V79.0: ÈóúÈñâÂåØÂÖ•ÈÅ∏ÊìáÂô®ÔºàÊ∏ÖÈô§ÁãÄÊÖãÔºâ
            const handleCloseImportSelector = () => {
                setShowImportSelector(false);
                setParsedDocuments([]);
                setAiExtractedData(null);
                setFieldSources({});
                setFieldConflicts({});
                setDuplicateContainer(null);
                setShowAiPreview(false);
            };
            
            // V79.0: ÁßªÈô§Â∑≤Ëß£ÊûêÁöÑÊñá‰ª∂
            const handleRemoveDocument = (docId) => {
                setParsedDocuments(prev => prev.filter(d => d.id !== docId));
            };
            
            // V79.0: ÂèñÂæóÁâπÂÆöÈ°ûÂûãÁöÑÊñá‰ª∂
            const getDocumentByType = (type) => {
                return parsedDocuments.find(d => d.type === type);
            };
            
            // V79.1: Gemini API Ëß£ÊûêÊèêÁ§∫Ë©ûÔºàÂáΩÊï∏ÂΩ¢ÂºèÔºåÊîØÊè¥ÂãïÊÖãË®≠ÂÆöÔºâ
            const getGeminiPromptStart = (mergeMode) => {
                const batchRuleSection = mergeMode === 'split' 
                    ? `## ÂêåÂìÅÈ†ÖÂ§öÊâπËôüËôïÁêÜË¶èÂâáÔºàÈáçË¶ÅÔºâÔºö
Êé°Áî®„ÄåÊãÜÂàÜÊ®°Âºè„ÄçÔºöÊØèÂÄãÊâπËôüÁç®Á´ã‰∏ÄÁ≠Ü
- ÊØèÂÄã‰∏çÂêåÁöÑÊâπËôüÈÉΩË¶ÅÂñÆÁç®ÂàóÂá∫
- ‰øùÁïôÂéüÂßãÁöÑ quantity Âíå weight
- ‰øùÁïôÂéüÂßãÁöÑ batchNumber
- ‰øùÁïôÂéüÂßãÁöÑ expiryDate

ÁØÑ‰æãÔºö
ÂéüÂßãË≥áÊñôÊúâ 2 ÂÄãÊâπËôüÔºö
  ÁÜüÁôΩËù¶ HOSO 41/50 | 100‰ª∂ | BC11-TR2505 | 2028-11-21
  ÁÜüÁôΩËù¶ HOSO 41/50 |  63‰ª∂ | BC11-TR2506 | 2028-11-30
Ëº∏Âá∫ 2 Á≠ÜÁî¢ÂìÅÔºö
  {"name":"ÁÜüÁôΩËù¶ HOSO","spec":"41/50","quantity":100,"batchNumber":"BC11-TR2505","expiryDate":"2028-11-21"}
  {"name":"ÁÜüÁôΩËù¶ HOSO","spec":"41/50","quantity":63,"batchNumber":"BC11-TR2506","expiryDate":"2028-11-30"}`
                    : `## ÂêåÂìÅÈ†ÖÂ§öÊâπËôüËôïÁêÜË¶èÂâáÔºàÈáçË¶ÅÔºâÔºö
Êé°Áî®„ÄåÂêà‰ΩµÊ®°Âºè„ÄçÔºöÂêåÂìÅÂêç + ÂêåË¶èÊ†º ‚Üí Âêà‰ΩµÁÇ∫‰∏ÄÁ≠Ü
- quantityÔºö‰ª∂Êï∏Âä†Á∏Ω
- weightÔºöÈáçÈáèÂä†Á∏Ω
- batchNumberÔºöÂ°´„ÄåÂ§öÊâπËôü„Äç
- expiryDateÔºöÂèñÊúÄÊó©ÁöÑÊïàÊúüÊó•Êúü

ÁØÑ‰æãÔºö
ÂéüÂßãË≥áÊñôÔºö
  ÁÜüÁôΩËù¶ HOSO 41/50 | 100‰ª∂ | BC11-TR2505 | 2028-11-21
  ÁÜüÁôΩËù¶ HOSO 41/50 |  63‰ª∂ | BC11-TR2506 | 2028-11-30
Âêà‰ΩµÂæåÔºö
  ÁÜüÁôΩËù¶ HOSO 41/50 | 163‰ª∂ | Â§öÊâπËôü | 2028-11-21ÔºàÂèñËºÉÊó©Ôºâ`;

                return `# ‰ªªÂãôÔºöËß£ÊûêÈÄ≤Âè£Ë≤®Ê´ÉÂ†±ÈóúÊñá‰ª∂‰∏¶Ëº∏Âá∫ JSON

Ë´ã‰ªîÁ¥∞Ê™¢Ë¶ñÊñá‰ª∂ÂúñÁâáÊàñÊñáÂ≠óÔºåÊèêÂèñÊâÄÊúâË≥áË®äÔºå‰∏¶‰ª• JSON Ê†ºÂºèÂõûÂÇ≥„ÄÇ

## ÈúÄÊèêÂèñÁöÑÊ¨Ñ‰ΩçÔºö
- containerNumber: Ê´ÉËôüÔºàÊ†ºÂºèÔºö4Ëã±Êñá+7Êï∏Â≠óÔºåÂ¶Ç TEMU9322425„ÄÅOTPU6492634Ôºâ
- importCompany: ÈÄ≤Âè£ÂÖ¨Âè∏ÔºàWEN'S FROZEN=Â¥áÊñáÂÜ∑Âáç, 8WAY=ÂÖ´ÊñπÁí∞ÁêÉ, STAR UNIVERSE=Â¥áÊñáÂÜ∑Âáç, IOCEAN=Â¥áÊñáÂÜ∑ÂáçÔºâ
- arrivalDate: Âà∞Ê∏ØÊó• YYYY-MM-DD
- supplier: Âª†ÂïÜÔºàInvoice ÁôºÁ•®‰∫∫/SHIPPERÔºåÂ¶Ç IOCEAN LLC„ÄÅOMARSAÔºâ
- origin: Áî¢Âú∞‰∏≠ÊñáÔºàINDONESIA=Âç∞Â∞º, ECUADOR=ÂéÑÁìúÂ§ö, THAILAND=Ê≥∞Âúã, CHINA=‰∏≠Âúã, VIETNAM=Ë∂äÂçó, CHILE=Êô∫Âà©Ôºâ
- shippingLine: ËàπÂÖ¨Âè∏ÂêçÁ®±ÔºàÊèêÂñÆÊä¨È†≠ÁöÑÂÖ¨Âè∏ÔºåÂ¶Ç EVERGREEN„ÄÅMSC„ÄÅCOSCO„ÄÅMAERSK„ÄÅHAPAG-LLOYD„ÄÅONE„ÄÅYANG MINGÔºâ
- vesselVoyage: ËàπÂêçËà™Ê¨°ÔºàÂ¶Ç EVER APEX 1367-012E„ÄÅMSC VICTORIA FA550RÔºâ
- billOfLading: ÊèêÂñÆËôüÁ¢ºÔºàB/L NO.Ôºâ
- products: Áî¢ÂìÅÈô£ÂàóÔºàË¶ã‰∏ãÊñπÊ†ºÂºèÔºâ
- totalQuantity: Á∏Ω‰ª∂Êï∏
- totalWeight: Á∏ΩÈáçÈáè

## ËàπÂÖ¨Âè∏ vs ËàπÂêçËà™Ê¨°ÔºàÈáçË¶ÅÂçÄÂàÜÔºâÔºö
- shippingLine ËàπÂÖ¨Âè∏ÔºöÊèêÂñÆÊúÄ‰∏äÊñπÁöÑÂÖ¨Âè∏ÂêçÁ®±/LogoÔºåÂ¶Ç EVERGREEN LINE„ÄÅMSC„ÄÅCOSCO SHIPPING
- vesselVoyage ËàπÂêçËà™Ê¨°ÔºöÊñá‰ª∂‰∏≠ VESSEL NO. / VOYAGE Ê¨Ñ‰ΩçÁöÑÂÖßÂÆπÔºåÂ¶Ç EVER APEX 1367-012E
- Ê≥®ÊÑèÔºöVESSEL NO. ÊòØËàπÂêçÔºå‰∏çÊòØËàπÂÖ¨Âè∏ÔºÅ

## Ê´ÉËôüË≠òÂà•ÈáçÈªûÔºö
1. Bill of Lading ÊèêÂñÆ‰∏≠„ÄåCONTAINER NO. / SEAL NO.„ÄçÊ¨Ñ‰Ωç
2. Packing List ‰∏≠„ÄåCONTAINER NUMBER„ÄçÊàñ„ÄåNro de Contenedo„Äç(Ë•øÁè≠ÁâôÊñá)
3. ÊïàÊúüÊ∏ÖÂñÆ Excel ‰∏≠„ÄåCONTAINER NUMBER„ÄçÊ¨Ñ‰Ωç
4. Ê†ºÂºèÔºö4Ëã±Êñá+7Êï∏Â≠óÔºàÂ¶Ç OTPU6492634„ÄÅTRIU8615920Ôºâ

## ÊâπËôüË≠òÂà•ÈáçÈªûÔºàÈùûÂ∏∏ÈáçË¶ÅÔºâÔºö
1. Invoice ‰∏äÁöÑ S/N Ê¨Ñ‰ΩçÂ∞±ÊòØÊâπËôüÔºàÂ¶Ç BW08-W2535Ôºâ
2. ÊïàÊúüÊ∏ÖÂñÆÁöÑ LOT S/N Ê¨Ñ‰Ωç‰πüÊòØÊâπËôüÔºàÂ¶Ç BC11-TR2505„ÄÅBCTO-TR2504Ôºâ
3. Excel ÊïàÊúüÊ∏ÖÂñÆÂèØËÉΩÊúâÂ§öÂÄã LOT #ÔºàÂ¶Ç 1407899, 1408097...ÔºâÔºåÈÄôÊòØÂ∑•Âª†ÂÖßÈÉ®ÊâπËôü

## ÊïàÊúüË≠òÂà•ÈáçÈªûÔºö
1. Ëã±ÊñáÔºöEXPIRATION DATE„ÄÅEXPIRY DATE„ÄÅEXP DATE„ÄÅExp.
2. Ë•øÁè≠ÁâôÊñáÔºöFecha de Vencimiento
3. ÊïàÊúüÊ∏ÖÂñÆÊ†ºÂºèÔºöREPORTE DE LOTESÔºàÊâπÊ¨°Â†±ÂëäÔºâ„ÄÅPRODUCTION DATEÔºàÊ≥∞ÂúãÊ†ºÂºèÔºâ
4. Êó•ÊúüÊ†ºÂºèËΩâÊèõÔºö
   - DD.MM.YYYYÔºàÂ¶Ç 21.11.2028Ôºâ‚Üí 2028-11-21
   - DD/MM/YYYYÔºàÂ¶Ç 21/11/2028Ôºâ‚Üí 2028-11-21
   - YYYY-MM-DD ‰øùÊåÅ‰∏çËÆä
5. Ê≥®ÊÑèÔºöDATE CODE ÊòØÁîüÁî¢Êó•ÊúüÔºå‰∏çÊòØÊïàÊúüÔºÅ

## Ê≥∞Âúã‰æõÊáâÂïÜÔºàYEENIN FROZEN FOODSÔºâÁâπÊÆäÊ†ºÂºèÔºö
- Êñá‰ª∂Ê®ôÈ°åÂèØËÉΩÊòØ PRODUCTION DATE ‰ΩÜÂåÖÂê´ÊïàÊúüË≥áË®ä
- LOT S/N Ê¨Ñ‰ΩçÊòØÊâπËôü
- Exp. Ê¨Ñ‰ΩçÊòØÊïàÊúüÔºàDD.MM.YYYY Ê†ºÂºèÔºâ
- DATE CODE ÊòØÁîüÁî¢Êó•ÊúüÔºà‰∏çË¶ÅË™§Ë™çÁÇ∫ÊïàÊúüÔºâ
- VESSEL ÊòØËàπÂêçÔºåAGENT ÊòØËàπÂÖ¨Âè∏

${batchRuleSection}

## Áî¢ÂìÅÊ¨Ñ‰ΩçÔºö
- originalText: Ëã±ÊñáÂìÅÂêçÂéüÊñá
- name: ‰∏≠ÊñáÂìÅÂêç
  - WHITE SHRIMP/VANNAMEI = ÁôΩËù¶
  - HOSO (HEAD ON SHELL ON) = Â∏∂È†≠Â∏∂ÊÆº
  - HLSO (HEADLESS SHELL ON) = ÂéªÈ†≠Â∏∂ÊÆº
  - PTO (PEELED TAIL-ON) = ÂéªÊÆºÂ∏∂Â∞æ
  - P&D (PEELED & DEVEINED) = ÂéªÊÆºÂéªËÖ∏Ê≥•
  - SEMI-BLOCK = ÂçäÂ°ä
  - B GRADE = BÁ¥ö
  - COOKED = ÁÜü
  - RAW = Áîü
  - SALMON COHO = ÈäÄÈÆ≠
  - SQUID = È≠∑È≠ö
  - SNAIL = Ëù∏Áâõ
- spec: Ë¶èÊ†ºÔºàÂ¶Ç 20/30, 41/50, 61/70, 9-UP LB, HG IQFÔºâ
- quantity: ‰ª∂Êï∏ÔºàÁ¥îÊï∏Â≠óÔºâ
- weight: Ê∑®ÈáçkgÔºàÁ¥îÊï∏Â≠óÔºâ
- unitPrice: ÂñÆÂÉπUSDÔºàÁ¥îÊï∏Â≠óÔºåÊ≠êÊ¥≤Ê†ºÂºè 6,40 = 6.40Ôºâ
- batchNumber: ÊâπËôü
- expiryDate: ÊïàÊúü YYYY-MM-DD

## Êñá‰ª∂ÂÖßÂÆπÔºö
`;
            };

            const GEMINI_PARSE_PROMPT_END = `

## Ëº∏Âá∫Ë¶ÅÊ±ÇÔºö
Âè™Ëº∏Âá∫ JSONÔºå‰∏çË¶ÅËº∏Âá∫‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠ó„ÄÅË™™ÊòéÊàñ markdown Ê®ôË®ò„ÄÇ

JSON ÁØÑ‰æãÔºö
{"containerNumber":"OTPU6492634","importCompany":"Â¥áÊñáÂÜ∑Âáç","arrivalDate":"2025-01-15","supplier":"IOCEAN LLC","origin":"ÂéÑÁìúÂ§ö","shippingLine":"EVERGREEN","vesselVoyage":"EVER APEX 1367-012E","billOfLading":"EGLV123456789","devanningLocation":"","products":[{"originalText":"LIVE FROZEN HOSO WHITE SHRIMPS 20/30","name":"ÁôΩËù¶ HOSO","spec":"20/30 650G√ó12B","quantity":1435,"weight":11193,"unitPrice":6.40,"batchNumber":"BW08-W2535","expiryDate":"2027-12-09","pricingMode":"weight"}],"totalQuantity":2050,"totalWeight":15990}`;
            
            // V79.0: AI Ëß£Êûê - Áõ¥Êé•ÂëºÂè´ Gemini APIÔºàÂê´ÈáçË©¶Ê©üÂà∂Ôºâ
            const processWithAI = async (documents) => {
                const MAX_RETRIES = 2; // ÊúÄÂ§öÈáçË©¶ 2 Ê¨°
                
                // Ê™¢Êü• API Key
                if (!geminiApiKey) {
                    setShowImportSelector(false);
                    setTempApiKey('');
                    setShowApiKeyModal(true);
                    return;
                }
                
                setIsAiProcessing(true);
                
                let lastError = null;
                
                for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
                    try {
                        setParseProgress(attempt > 0 ? `AI ÈáçË©¶‰∏≠ (${attempt}/${MAX_RETRIES})...` : 'AI Ê≠£Âú®ÂàÜÊûêÊñá‰ª∂ÂÖßÂÆπ...');
                        
                        // ÂàÜÈõ¢ÊñáÂ≠óÂûãÂíåÊéÉÊèèÂûãÊñá‰ª∂
                        const textDocs = documents.filter(d => !d.isScanned && d.text);
                        const scannedDocs = documents.filter(d => d.isScanned && d.base64);
                        
                        // ÁµÑÂêàÊñáÂ≠óÂÖßÂÆπ
                        const combinedTextContent = textDocs.map(doc => 
                            `=== ${doc.label} (${doc.name}) ===\n${doc.text}`
                        ).join('\n\n');
                        
                        // ÁµÑÂêàÂÆåÊï¥ PromptÔºàÊ†πÊìöÊâπËôüËôïÁêÜÊ®°ÂºèÂãïÊÖãÁîüÊàêÔºâ
                        const fullPrompt = getGeminiPromptStart(batchMergeMode) + 
                            (combinedTextContent || 'ÔºàÊñáÂ≠óÂÖßÂÆπË¶ãÈôÑ‰ª∂ÂúñÁâáÔºâ') + 
                            GEMINI_PARSE_PROMPT_END;
                        
                        // Âª∫Á´ã parts Èô£ÂàóÔºàÊñáÂ≠ó + ÊéÉÊèèÊ™îÂúñÁâáÔºâ
                        const parts = [{ text: fullPrompt }];
                        
                        // Âä†ÂÖ•ÊéÉÊèèÊ™îÁöÑ base64 Ë≥áÊñô
                        for (const doc of scannedDocs) {
                            console.log(`üì∑ Âä†ÂÖ•ÊéÉÊèèÊ™î: ${doc.name}`);
                            parts.push({
                                inlineData: {
                                    mimeType: doc.mimeType || 'application/pdf',
                                    data: doc.base64
                                }
                            });
                        }
                        
                        console.log('üì§ ÂëºÂè´ Gemini API...', attempt > 0 ? `(ÈáçË©¶ ${attempt})` : '', 
                            scannedDocs.length > 0 ? `(Âê´ ${scannedDocs.length} ‰ªΩÊéÉÊèèÊ™î)` : '');
                        
                        // ÂëºÂè´ Gemini API
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: parts }],
                                generationConfig: { temperature: 0.1, maxOutputTokens: 4096 }
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            if (response.status === 400 && errorData.error?.message?.includes('API key')) {
                                throw { fatal: true, message: 'API Key ÁÑ°ÊïàÔºåË´ãÈáçÊñ∞Ë®≠ÂÆö' };
                            }
                            throw new Error(errorData.error?.message || `API ÈåØË™§ (${response.status})`);
                        }
                        
                        const result = await response.json();
                        const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (!responseText) {
                            throw new Error('AI ÂõûÊáâÁÇ∫Á©∫');
                        }
                        
                        console.log('üì• AI ÂéüÂßãÂõûÊáâ:', responseText.substring(0, 300) + '...');
                        
                        // Ëß£Êûê JSON
                        let jsonStr = responseText
                            .replace(/```json\s*/gi, '')
                            .replace(/```\s*/g, '')
                            .replace(/[\r\n]+/g, ' ')
                            .trim();
                        
                        const startIdx = jsonStr.indexOf('{');
                        const endIdx = jsonStr.lastIndexOf('}');
                        if (startIdx === -1 || endIdx === -1 || endIdx <= startIdx) {
                            throw new Error('ÂõûÊáâ‰∏≠Êâæ‰∏çÂà∞ JSON');
                        }
                        
                        jsonStr = jsonStr.substring(startIdx, endIdx + 1)
                            .replace(/,\s*}/g, '}')
                            .replace(/,\s*]/g, ']');
                        
                        const parsedData = JSON.parse(jsonStr);
                        console.log('‚úÖ JSON Ëß£ÊûêÊàêÂäü');
                        
                        // ÊàêÂäüÔºÅËôïÁêÜÁµêÊûú‰∏¶ÈÄÄÂá∫
                        processAiResult(parsedData, documents);
                        setIsAiProcessing(false);
                        setParseProgress('');
                        return; // ÊàêÂäüÔºåÁµêÊùüÂáΩÊï∏
                        
                    } catch (err) {
                        console.warn(`‚ùå Á¨¨ ${attempt + 1} Ê¨°ÂòóË©¶Â§±Êïó:`, err.message || err);
                        lastError = err;
                        
                        // Â¶ÇÊûúÊòØËá¥ÂëΩÈåØË™§ÔºàAPI Key ÁÑ°ÊïàÔºâÔºå‰∏çÈáçË©¶
                        if (err.fatal) {
                            break;
                        }
                        
                        // Â¶ÇÊûúÈÇÑÊúâÈáçË©¶Ê©üÊúÉÔºåÁ≠âÂæÖÂæåÁπºÁ∫å
                        if (attempt < MAX_RETRIES) {
                            await new Promise(r => setTimeout(r, 1500));
                        }
                    }
                }
                
                // ÊâÄÊúâÈáçË©¶ÈÉΩÂ§±Êïó
                setIsAiProcessing(false);
                setParseProgress('');
                
                console.error('AI Ëß£ÊûêÊúÄÁµÇÂ§±Êïó:', lastError);
                
                if (lastError?.fatal || lastError?.message?.includes('API Key')) {
                    setGeminiApiKey('');
                    localStorage.removeItem('gemini_api_key');
                    setTempApiKey('');
                    setShowApiKeyModal(true);
                } else {
                    const useManual = confirm(
                        'AI Ëß£ÊûêÂ§±Êïó: ' + (lastError?.message || 'Êú™Áü•ÈåØË™§') + 
                        '\n\nÊòØÂê¶ÊîπÁî®ÊâãÂãïÂ°´ÂØ´Ê®°ÂºèÔºü'
                    );
                    if (useManual) {
                        setShowImportSelector(false);
                        setFormStep(1);
                        setView('form');
                    }
                }
            };
            
            // V79.0: ËôïÁêÜ AI ÂõûÂÇ≥ÁµêÊûúÔºåÂª∫Á´ãÊ¨Ñ‰Ωç‰æÜÊ∫êÂ∞çÁÖß
            const processAiResult = (data, documents) => {
                console.log('üìä processAiResult ÈñãÂßãËôïÁêÜ...');
                console.log('üìä Êî∂Âà∞ÁöÑË≥áÊñô:', JSON.stringify(data, null, 2).substring(0, 500));
                
                // ËôïÁêÜÊñ∞Ê¨Ñ‰ΩçÊò†Â∞ÑÔºöshippingLine + vesselVoyage ‚Üí shippingCompany
                if (data.shippingLine || data.vesselVoyage) {
                    const parts = [];
                    if (data.shippingLine) parts.push(data.shippingLine);
                    if (data.vesselVoyage) parts.push(data.vesselVoyage);
                    data.shippingCompany = parts.join(' / ');
                    console.log(`üö¢ ËàπÂÖ¨Âè∏Âêà‰Ωµ: ${data.shippingCompany}`);
                }
                
                const sources = {};
                const conflicts = {};
                
                // ÂÆöÁæ©Ê¨Ñ‰ΩçÂ∞çÊáâÔºàB/L ÊòØÊ´ÉËôüÁöÑ‰∏ªË¶Å‰æÜÊ∫êÔºâ
                const fieldMapping = {
                    containerNumber: { label: 'Ê´ÉËôü', priority: ['bl', 'packing', 'arrival', 'invoice'] },
                    billOfLading: { label: 'ÊèêÂñÆËôüÁ¢º', priority: ['bl', 'arrival'] },
                    arrivalDate: { label: 'Âà∞Ê∏ØÊó•', priority: ['arrival', 'bl'] },
                    supplier: { label: 'Âª†ÂïÜ', priority: ['invoice', 'packing', 'bl'] },
                    origin: { label: 'Áî¢Âú∞', priority: ['invoice', 'packing'] },
                    shippingCompany: { label: 'ËàπÂÖ¨Âè∏', priority: ['bl', 'arrival'] },
                    devanningLocation: { label: 'ÊãÜÊ´ÉÂú∞', priority: ['arrival'] },
                    importCompany: { label: 'ÈÄ≤Âè£ÂÖ¨Âè∏', priority: ['invoice', 'bl', 'arrival'] }
                };
                
                // ËôïÁêÜÊØèÂÄãÊ¨Ñ‰Ωç
                Object.keys(fieldMapping).forEach(field => {
                    if (data[field]) {
                        const value = data[field];
                        const sourceDoc = documents.find(d => fieldMapping[field].priority.includes(d.type));
                        sources[field] = {
                            value: value.value || value,
                            source: sourceDoc?.label || 'Ëá™ÂãïË≠òÂà•',
                            confidence: value.confidence || 'high',
                            alternatives: value.alternatives || []
                        };
                        
                        // Ê™¢Êü•ÊòØÂê¶ÊúâË°ùÁ™ÅÔºàÂêå‰∏ÄÊ¨Ñ‰ΩçÂ§öÂÄã‰∏çÂêåÂÄºÔºâ
                        if (value.alternatives && value.alternatives.length > 0) {
                            conflicts[field] = [
                                { value: value.value || value, source: sourceDoc?.label },
                                ...value.alternatives.map(alt => ({ value: alt.value, source: alt.source }))
                            ];
                        }
                    }
                });
                
                // ËôïÁêÜÁî¢ÂìÅÊòéÁ¥∞
                if (data.products && Array.isArray(data.products)) {
                    sources.products = {
                        value: data.products,
                        source: 'Invoice / Packing List',
                        confidence: 'high'
                    };
                }
                
                // Ê™¢Êü•Áº∫Â∞ëÁöÑÈóúÈçµÊ¨Ñ‰Ωç
                const missingFields = [];
                if (!data.containerNumber) missingFields.push('Ê´ÉËôü');
                if (!data.arrivalDate) missingFields.push('Âà∞Ê∏ØÊó•');
                if (!data.supplier) missingFields.push('Âª†ÂïÜ');
                
                if (missingFields.length > 0) {
                    console.warn('‚ö†Ô∏è ‰ª•‰∏ãÊ¨Ñ‰ΩçÊú™Ëß£ÊûêÂá∫‰æÜÔºåË´ãÊâãÂãïË£úÂÖÖ:', missingFields.join(', '));
                }
                
                setAiExtractedData(data);
                setFieldSources(sources);
                setFieldConflicts(conflicts);
                setDuplicateContainer(null); // ÈáçÁΩÆÈáçË§áÊ™¢Êü•
                
                // Ê™¢Êü•Ê´ÉËôüÊòØÂê¶Â∑≤Â≠òÂú®
                console.log(`üîç ÈñãÂßãÊ™¢Êü•Ê´ÉËôüÈáçË§á...`);
                console.log(`üîç Ëß£ÊûêÂá∫ÁöÑÊ´ÉËôü: "${data.containerNumber}"`);
                console.log(`üîç ÁèæÊúâË®òÈåÑÊï∏: ${shipments.length}`);
                
                if (data.containerNumber) {
                    const existing = shipments.find(s => {
                        const match = s.containerNumber === data.containerNumber && !s.id?.startsWith('temp_');
                        if (s.containerNumber) {
                            console.log(`   ÊØîÂ∞ç: ${s.containerNumber} === ${data.containerNumber} ‚Üí ${match}`);
                        }
                        return match;
                    });
                    
                    if (existing) {
                        console.warn(`‚ö†Ô∏è Ê´ÉËôü ${data.containerNumber} Â∑≤Â≠òÂú®ÔºÅ`);
                        console.warn(`   Âà∞Ê∏ØÊó•: ${existing.arrivalDate}, Âª†ÂïÜ: ${existing.supplier}`);
                        setDuplicateContainer({
                            containerNo: data.containerNumber,
                            existingId: existing.id,
                            existingArrivalDate: existing.arrivalDate,
                            existingSupplier: existing.supplier
                        });
                    } else {
                        console.log(`‚úÖ Ê´ÉËôü ${data.containerNumber} ÁÑ°ÈáçË§á`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è Ê≤íÊúâËß£ÊûêÂá∫Ê´ÉËôüÔºåË∑≥ÈÅéÈáçË§áÊ™¢Êü•`);
                }
                
                setShowAiPreview(true);
                
                // Â¶ÇÊûúÁº∫Â∞ëÊ´ÉËôüÔºåÊèêÁ§∫Áî®Êà∂ÂèØËÉΩÈúÄË¶Å‰∏äÂÇ≥ B/L Êàñ Packing List
                if (!data.containerNumber) {
                    console.log('üí° ÊèêÁ§∫ÔºöÊ´ÉËôüÈÄöÂ∏∏Âú® B/L Êàñ Packing List ‰∏≠ÔºåÂª∫Ë≠∞Ë£úÂÖÖ‰∏äÂÇ≥ÈÄô‰∫õÊñá‰ª∂');
                }
            };
            
            // V79.0: Á¢∫Ë™ç AI Ëß£ÊûêÁµêÊûúÔºåÂ°´ÂÖ•Ë°®ÂñÆ
            const confirmAiExtraction = () => {
                if (!aiExtractedData) return;
                
                // Ê™¢Êü•ÊòØÂê¶ÊâÄÊúâÁî¢ÂìÅÈÉΩÂ∑≤ÈÅ∏Êìá ERP ÂìÅÂêç
                const productsData = fieldSources.products?.value || [];
                const hasUnselected = productsData.some(p => !p.selectedName);
                if (hasUnselected && productsData.length > 0) {
                    alert('Ë´ãÁÇ∫ÊØèÂÄãÁî¢ÂìÅÈÅ∏ÊìáÂ∞çÊáâÁöÑ ERP ÂìÅÂêç');
                    return;
                }
                
                const newFormData = { ...initialFormState };
                
                // Â°´ÂÖ•Âü∫Êú¨Ê¨Ñ‰Ωç
                const simpleFields = ['containerNumber', 'arrivalDate', 'supplier', 'origin', 
                    'shippingCompany', 'devanningLocation', 'importCompany', 'customsBroker'];
                
                simpleFields.forEach(field => {
                    if (fieldSources[field]) {
                        newFormData[field] = fieldSources[field].value;
                    }
                });
                
                // Â°´ÂÖ•Áî¢ÂìÅÊòéÁ¥∞Ôºà‰ΩøÁî®ÈÅ∏ÊìáÁöÑ ERP ÂìÅÂêçÔºâ
                if (productsData.length > 0) {
                    newFormData.products = productsData.map((p, idx) => {
                        // ÂàÜÂâ≤ÈÅ∏ÊìáÁöÑÂìÅÂêçÂíåË¶èÊ†º
                        const selectedName = p.selectedName || '';
                        const selectedSpec = p.selectedSpec || '';
                        
                        return {
                            id: Date.now() + idx,
                            name: selectedName.replace(selectedSpec, '').trim(), // ERP ÂìÅÂêç
                            spec: selectedSpec, // ERP Ë¶èÊ†º
                            quantity: p.quantity || 0,
                            weight: p.weight || 0,
                            unitPrice: p.unitPrice || 0,
                            batchNumber: p.batchNumber || '',
                            expiryDate: p.expiryDate || '',
                            pricingMode: p.pricingMode || 'weight',
                            amount: (p.pricingMode === 'quantity' ? p.quantity : p.weight) * (p.unitPrice || 0)
                        };
                    });
                }
                
                setFormData(newFormData);
                setShowAiPreview(false);
                setFormStep(1);
                setView('form');
            };
            
            // V79.0: ‰øÆÊîπÂñÆ‰∏ÄÊ¨Ñ‰ΩçÁöÑÂÄºÔºàÂæûË°ùÁ™Å‰∏≠ÈÅ∏ÊìáÔºâ
            const selectFieldValue = (field, value, source) => {
                setFieldSources(prev => ({
                    ...prev,
                    [field]: { ...prev[field], value, source }
                }));
                // Ê∏ÖÈô§Ë©≤Ê¨Ñ‰ΩçÁöÑË°ùÁ™ÅÊ®ôË®ò
                setFieldConflicts(prev => {
                    const newConflicts = { ...prev };
                    delete newConflicts[field];
                    return newConflicts;
                });
            };
            
            // V79.0: ÂèñÊ∂à AI È†êÂ°´ÔºåÊîπÁî®ÊâãÂãï
            const cancelAiExtraction = () => {
                setShowAiPreview(false);
                setAiExtractedData(null);
                setFieldSources({});
                setFieldConflicts({});
                setFormStep(1);
                setView('form');
            };
            
            // V79.0: ‰ø°ÂøÉÂ∫¶È°èËâ≤
            const getConfidenceColor = (confidence) => {
                switch(confidence) {
                    case 'high': return 'text-green-600 bg-green-50 border-green-200';
                    case 'medium': return 'text-yellow-600 bg-yellow-50 border-yellow-200';
                    case 'low': return 'text-red-600 bg-red-50 border-red-200';
                    default: return 'text-gray-600 bg-gray-50 border-gray-200';
                }
            };
            
            // V79.0: ‰ø°ÂøÉÂ∫¶ÊñáÂ≠ó
            const getConfidenceLabel = (confidence) => {
                switch(confidence) {
                    case 'high': return '‚úì È´ò‰ø°ÂøÉ';
                    case 'medium': return '? ‰∏≠Á≠â';
                    case 'low': return '! ÈúÄÁ¢∫Ë™ç';
                    default: return '';
                }
            };

            // V74.0: Excel ÂåØÂÖ•ÂäüËÉΩ
            const EXCEL_COLUMN_MAP = {
                'Âª†ÂïÜ': 'supplier',
                '‰æõÊáâÂïÜ': 'supplier',
                'ÂìÅÂêç': 'productName',
                'Áî¢ÂìÅÂêçÁ®±': 'productName',
                'Ë¶èÊ†º': 'spec',
                'ÂñÆÂÉπ': 'unitPrice',
                'ÂÉπÊ†º': 'unitPrice',
                'Êï∏Èáè': 'quantity',
                '‰ª∂Êï∏': 'quantity',
                'ÈáçÈáè': 'weight',
                'ÊâπËôü': 'batchNumber',
                'ÊïàÊúü': 'expiryDate',
                'ÊúâÊïàÊúüÈôê': 'expiryDate',
                'Êé°Ë≥ºÊó•Êúü': 'arrivalDate',
                'Êó•Êúü': 'arrivalDate',
                'ÈÄ≤Ë≤®Êó•Êúü': 'arrivalDate',
            };

            const parseExcelDate = (value) => {
                if (!value) return '';
                // Excel Êó•ÊúüÂ∫èÂàóÂÄº
                if (typeof value === 'number') {
                    const date = XLSX.SSF.parse_date_code(value);
                    if (date) {
                        const y = date.y;
                        const m = String(date.m).padStart(2, '0');
                        const d = String(date.d).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    }
                }
                // Â≠ó‰∏≤Êó•ÊúüÊ†ºÂºè
                if (typeof value === 'string') {
                    // ËôïÁêÜ YYYY/MM/DD Êàñ YYYY-MM-DD
                    const match = value.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (match) {
                        return `${match[1]}-${match[2].padStart(2,'0')}-${match[3].padStart(2,'0')}`;
                    }
                    // ËôïÁêÜÊ∞ëÂúãÂπ¥ (113/01/15)
                    const rocMatch = value.match(/(\d{2,3})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (rocMatch && parseInt(rocMatch[1]) < 200) {
                        const year = parseInt(rocMatch[1]) + 1911;
                        return `${year}-${rocMatch[2].padStart(2,'0')}-${rocMatch[3].padStart(2,'0')}`;
                    }
                }
                return '';
            };

            const handleExcelImport = async (evt) => {
                const file = evt.target.files[0];
                if (!file) return;
                evt.target.value = '';
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    
                    if (jsonData.length === 0) {
                        alert(TEXT.IMPORT_NO_DATA);
                        return;
                    }
                    
                    // Ëß£Êûê‰∏¶ËΩâÊèõË≥áÊñô
                    const headers = Object.keys(jsonData[0]);
                    const columnMapping = {};
                    headers.forEach(h => {
                        const key = h.trim();
                        if (EXCEL_COLUMN_MAP[key]) {
                            columnMapping[key] = EXCEL_COLUMN_MAP[key];
                        }
                    });
                    
                    const parsedData = jsonData.map((row, idx) => {
                        const item = { _rowIndex: idx + 2 }; // Excel Ë°åËôüÔºàÂê´Ê®ôÈ°åÂàóÔºâ
                        
                        Object.entries(row).forEach(([key, value]) => {
                            const mappedKey = columnMapping[key.trim()];
                            if (mappedKey) {
                                if (mappedKey === 'arrivalDate' || mappedKey === 'expiryDate') {
                                    item[mappedKey] = parseExcelDate(value);
                                } else if (mappedKey === 'unitPrice' || mappedKey === 'quantity' || mappedKey === 'weight') {
                                    item[mappedKey] = safeNum(value);
                                } else {
                                    item[mappedKey] = String(value || '').trim();
                                }
                            }
                        });
                        
                        // Áî¢ÁîüÂîØ‰∏ÄË≠òÂà•Á¢ºÁî®ÊñºÈáçË§áÊ™¢Êü•
                        item._uniqueKey = `${item.supplier || ''}_${item.arrivalDate || ''}_${item.productName || ''}`;
                        
                        return item;
                    }).filter(item => item.supplier || item.productName); // ÈÅéÊøæÁ©∫ÁôΩÂàó
                    
                    setImportData(parsedData);
                    setShowImportModal(true);
                    
                } catch (error) {
                    console.error('Excel Ëß£ÊûêÈåØË™§:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                }
            };

            const handleConfirmImport = async () => {
                if (importData.length === 0) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                setImportProcessing(true);
                setImportProgress({ current: 0, total: importData.length });
                
                let successCount = 0;
                let errorCount = 0;
                
                try {
                    for (let i = 0; i < importData.length; i++) {
                        const item = importData[i];
                        setImportProgress({ current: i + 1, total: importData.length });
                        
                        // Âª∫Á´ãÊé°Ë≥ºÂñÆË≥áÊñôÁµêÊßã
                        const shipmentData = {
                            importCompany: IMPORT_COMPANIES[0],
                            customsBroker: DOMESTIC_FLAG, // ÂúãÂÖßÊé°Ë≥º
                            containerNumber: `DOM-${item.arrivalDate?.replace(/-/g, '') || Date.now()}`,
                            arrivalDate: item.arrivalDate || new Date().toISOString().split('T')[0],
                            supplier: item.supplier || '',
                            origin: 'Âè∞ÁÅ£',
                            currency: 'TWD',
                            paymentTerm: PAYMENT_TERMS_DOMESTIC[0],
                            products: [{
                                id: Date.now() + i,
                                name: item.productName || '',
                                spec: item.spec || '',
                                unitPrice: item.unitPrice || 0,
                                quantity: item.quantity || 0,
                                weight: item.weight || 0,
                                batchNumber: item.batchNumber || '',
                                expiryDate: item.expiryDate || '',
                                pricingMode: 'weight',
                                boxCapacity: 1,
                                amount: round2((item.weight || 0) * (item.unitPrice || 0))
                            }],
                            totalQuantity: item.quantity || 0,
                            totalWeight: item.weight || 0,
                            isPaid: false,
                            warehouseConfirmed: false,
                            attachments: [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                        };
                        
                        try {
                            // Ê™¢Êü•ÊòØÂê¶ÊúâÈáçË§áË≥áÊñôÔºàÁõ∏ÂêåÂª†ÂïÜ + Êó•Êúü + ÂìÅÂêçÔºâ
                            const existingQuery = await db.collection('shipments')
                                .where('customsBroker', '==', DOMESTIC_FLAG)
                                .where('supplier', '==', shipmentData.supplier)
                                .where('arrivalDate', '==', shipmentData.arrivalDate)
                                .get();
                            
                            let existingDoc = null;
                            existingQuery.forEach(doc => {
                                const data = doc.data();
                                const hasProduct = (data.products || []).some(p => p.name === item.productName);
                                if (hasProduct) existingDoc = doc;
                            });
                            
                            if (existingDoc) {
                                // Ë¶ÜËìãÊõ¥Êñ∞
                                await db.collection('shipments').doc(existingDoc.id).update({
                                    ...shipmentData,
                                    createdAt: existingDoc.data().createdAt, // ‰øùÁïôÂéüÂª∫Á´ãÊôÇÈñì
                                });
                            } else {
                                // Êñ∞Â¢û
                                await db.collection('shipments').add(shipmentData);
                            }
                            successCount++;
                        } catch (err) {
                            console.error('ÂåØÂÖ•ÂñÆÁ≠ÜÂ§±Êïó:', err);
                            errorCount++;
                        }
                    }
                    
                    setShowImportModal(false);
                    setImportData([]);
                    showToast(`${TEXT.IMPORT_SUCCESS}Ôºö${successCount} Á≠ÜÊàêÂäü${errorCount > 0 ? `Ôºå${errorCount} Á≠ÜÂ§±Êïó` : ''}`);
                    
                } catch (error) {
                    console.error('ÂåØÂÖ•Â§±Êïó:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                } finally {
                    setImportProcessing(false);
                }
            };

            // V75.0: Áî¢ÂìÅ‰∏ªÊ™îÁõ∏ÈóúÂáΩÊï∏
            const initialProductState = {
                productId: '',
                name: '',
                spec: '',
                unit: 'ÂåÖ',
                defaultPrice: 0,
                defaultSupplier: '',
                isActive: true
            };

            const PRODUCT_UNITS = ['ÂåÖ', '‰ª∂', 'KG', 'Áõí', 'Áâá', 'Â∞æ', 'Êñ§', 'Ê°∂', 'ÁÆ±', 'Â°ä'];

            // V77.0: ÂÖßÂª∫Áî¢ÂìÅ‰∏ªÊ™îÂàùÂßãË≥áÊñô (351Á≠Ü)
            const INITIAL_PRODUCTS_DATA = [{"productId":"A09134S20P","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD","spec":"36/40S*420G*20ÂåÖ(IQ10%)","unit":"‰ª∂"},{"productId":"A0914510","name":"ÂñÆÂáçÁôΩ‰ªÅÂéüÊñô","spec":"40/50*10KG(IQ)","unit":"‰ª∂"},{"productId":"A0915610","name":"ÂñÆÂáçÁôΩ‰ªÅÂéüÊñô","spec":"50/60*10KG(IQ)","unit":"‰ª∂"},{"productId":"A0916710","name":"ÂñÆÂáçÁôΩ‰ªÅÂéüÊñô","spec":"60/70*10KG(IQ)","unit":"‰ª∂"},{"productId":"A0916712","name":"ÂñÆÂáçÁôΩ‰ªÅÂéüÊñô","spec":"60/70*1K*12ÂåÖ(IQ20%)","unit":"‰ª∂"},{"productId":"A0917910","name":"ÂñÆÂáçÁôΩ‰ªÅÂéüÊñô","spec":"70/90*10KG(IQ)","unit":"‰ª∂"},{"productId":"A504BK16","name":"504ÁôΩ‰ªÅ","spec":"BKNÁ¢éËÇâ*2KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"AWE161010","name":"ÁîüÁïôÂ∞æËù¶(ÈñãËÉå)PTO","spec":"16/20T(ÂñÆÂáç,IQ10%)*1K*10ÂåÖ","unit":"‰ª∂"},{"productId":"AWE161012","name":"ÁîüÁïôÂ∞æËù¶(ÈñãËÉå)PTO","spec":"16/20T(ÂñÆÂáç,IQ15%)*1K*15ÂåÖ","unit":"‰ª∂"},{"productId":"AWE211010","name":"ÁîüÁïôÂ∞æËù¶(ÈñãËÉå)PTO","spec":"21/25T(ÂñÆÂáç,IQ10%)*1K*10ÂåÖ","unit":"‰ª∂"},{"productId":"AWE211012_1","name":"ÁîüÁïôÂ∞æËù¶(ÈñãËÉå)PTO","spec":"21/25T(ÂñÆÂáç,IQ20%)*1K*12ÂåÖ","unit":"‰ª∂"},{"productId":"AWE261012_1","name":"ÁîüÁïôÂ∞æËù¶(ÈñãËÉå)PTO","spec":"26/30T(ÂñÆÂáç,IQ20%)*1K*12ÂåÖ","unit":"‰ª∂"},{"productId":"AWE311012_1","name":"ÁîüÁïôÂ∞æËù¶(ÈñãËÉå)PTO","spec":"31/35T(ÂñÆÂáç,IQ20%)*1K*12ÂåÖ","unit":"‰ª∂"},{"productId":"AWE340012","name":"ÁîüÁïôÂ∞æËù¶(‰∏çÈñãËÉå)","spec":"30/40(ÂñÆÂáç,IQ20%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"AWE450010_1","name":"ÁîüÁïôÂ∞æËù¶(‰∏çÈñãËÉå)","spec":"40/50(ÂñÆÂáç,IQ15%)*1.15KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"AWE450010_3","name":"ÁîüÁïôÂ∞æËù¶(‰∏çÈñãËÉå)","spec":"40/50(ÂñÆÂáç,IQ20%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"BC16118T","name":"ÁÜüÁôΩËù¶","spec":"16/20*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BC21118T","name":"ÁÜüÁôΩËù¶","spec":"21/25*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BC34118T","name":"ÁÜüÁôΩËù¶","spec":"30/40*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BC45118T","name":"ÁÜüÁôΩËù¶","spec":"40/50*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BC56118T","name":"ÁÜüÁôΩËù¶","spec":"50/60*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BC67118T","name":"ÁÜüÁôΩËù¶","spec":"60/70*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BC78118T","name":"ÁÜüÁôΩËù¶","spec":"70/80*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BC91118T","name":"ÁÜüÁôΩËù¶","spec":"90/110*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU16118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"16/20*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU21118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"21/25*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU34118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"30/40*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU45118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"40/50*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU56118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"50/60*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU67118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"60/70*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU78118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"70/80*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BCU91118T","name":"ÁÜüÁôΩËù¶(ÊúâËÖ∏Ê≥•)","spec":"90/110*1.1KG*8Áõí*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"BMA101008_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"8/12(ÊúâÂçµ,IQ10%)*700G*10Áõí","unit":"‰ª∂"},{"productId":"BMA21100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"21/25(ÁÑ°Âçµ,IQ20%)*650G*12Áõí","unit":"‰ª∂"},{"productId":"BMA26100812_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"26/30(ÁÑ°Âçµ,IQ20%)*650G*12Áõí","unit":"‰ª∂"},{"productId":"BMA31100812_2","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"31/40(ÁÑ°Âçµ,IQ15%)*650G*12Áõí","unit":"‰ª∂"},{"productId":"BMA31100812_3","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"31/40(ÁÑ°Âçµ,IQ20%)*650G*12Áõí","unit":"‰ª∂"},{"productId":"BMC21100612_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"21/25(ÁÑ°Âçµ,IQ20%)*600G*12Áõí","unit":"‰ª∂"},{"productId":"BMC26100612_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"26/30(ÁÑ°Âçµ,IQ20%)*600G*12Áõí","unit":"‰ª∂"},{"productId":"BMC31100612_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"31/40(ÁÑ°Âçµ,IQ20%)*600G*12Áõí","unit":"‰ª∂"},{"productId":"BMW14100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"13/15(ÊúâÂçµ,IQ15%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW21100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"21/25(ÊúâÂçµ,IQ10%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW21100812_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"21/25(ÊúâÂçµ,IQ15%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW26100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"26/30(ÊúâÂçµ,IQ10%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW26100812_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"26/30(ÊúâÂçµ,IQ15%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW31100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"31/40(ÊúâÂçµ,IQ10%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW31100812_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"31/40(ÊúâÂçµ,IQ15%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW41100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"41/50(ÊúâÂçµ,IQ10%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW41100812_1","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"41/50(ÊúâÂçµ,IQ15%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW51100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"51/60(ÊúâÂçµ,IQ10%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW61100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"61/70(ÊúâÂçµ,IQ10%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BMW71100812","name":"ÈáëÈëΩËù¶(Ë∂äÂçó)","spec":"71/90(ÊúâÂçµ,IQ10%)*700G*12Áõí","unit":"‰ª∂"},{"productId":"BS21110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"21/25*10KG(IQ)","unit":"‰ª∂"},{"productId":"BS26110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"26/30*10KG(IQ)","unit":"‰ª∂"},{"productId":"BS31110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"31/35*10KG(IQ)","unit":"‰ª∂"},{"productId":"BS36110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"36/40*10KG(IQ)","unit":"‰ª∂"},{"productId":"BS41110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"41/50*10KG(IQ)","unit":"‰ª∂"},{"productId":"BS51110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"51/60*10KG(IQ)","unit":"‰ª∂"},{"productId":"BS61110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"61/70*10KG(IQ)","unit":"‰ª∂"},{"productId":"BS71110","name":"ÁîüÁôΩËù¶(IQ)ÂéüÊñô","spec":"71/90*10KG(IQ)","unit":"‰ª∂"},{"productId":"C14DG1008","name":"ËçâËù¶-È†ÇÁ¥ö","spec":"14(DG)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"C18DG1008","name":"ËçâËù¶-È†ÇÁ¥ö","spec":"18(DG)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"C22DG1008","name":"ËçâËù¶-È†ÇÁ¥ö","spec":"22(DG)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"C27DG1008","name":"ËçâËù¶-È†ÇÁ¥ö","spec":"27(DG)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"C32DG1008","name":"ËçâËù¶-È†ÇÁ¥ö","spec":"32(DG)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"C37DG1008","name":"ËçâËù¶-È†ÇÁ¥ö","spec":"37(DG)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"CBI05FI06","name":"ËüπÂë≥Ê£í(ÊùæËëâ)","spec":"500G*6ÂåÖ(ÁÅ´Èçã)","unit":"‰ª∂"},{"productId":"CBI05FI12","name":"ËüπÂë≥Ê£í(ÊùæËëâ)","spec":"500G*12ÂåÖ(ÁÅ´Èçã)","unit":"‰ª∂"},{"productId":"CBI05SA12","name":"ËüπÂë≥Ê£í(ÊùæËëâ)","spec":"500G*12ÂåÖ(Ê≤ôÊãâ)","unit":"‰ª∂"},{"productId":"CBI27FI10","name":"ËüπÂë≥Ê£í(ÊùæËëâ)","spec":"270G*10ÂåÖ(ÁÅ´Èçã)","unit":"‰ª∂"},{"productId":"CBK05CH12","name":"ËüπÂë≥Ê£í(ÈüìÂúã)","spec":"500G*12ÂåÖ(ÁÅ´Èçã)","unit":"‰ª∂"},{"productId":"CF05120808","name":"ÁÜüÈ≥≥Â∞æËù¶‰ªÅ","spec":"50/70*800G*8ÂåÖ","unit":"‰ª∂"},{"productId":"CF07120806","name":"ÁÜüÈ≥≥Â∞æËù¶‰ªÅ","spec":"70/90*800G*6ÂåÖ","unit":"‰ª∂"},{"productId":"CF07120808","name":"ÁÜüÈ≥≥Â∞æËù¶‰ªÅ","spec":"70/90*800G*8ÂåÖ","unit":"‰ª∂"},{"productId":"EL8001206","name":"ÂâùÊÆºÈ≥≥Ëû∫(ÂéªËÜè)","spec":"800G*6ÂåÖ","unit":"‰ª∂"},{"productId":"EM04500310","name":"‰∏≠Êç≤(Ê∞¥ÁÖÆ)","spec":"4/6(ÂéªÁõÆ)450G*10ÂåÖ","unit":"‰ª∂"},{"productId":"EM04550310","name":"‰∏≠Êç≤(Ê∞¥ÁÖÆ)","spec":"4/6(ÁïôÁõÆ)550G*10ÂåÖ","unit":"‰ª∂"},{"productId":"EM06450310","name":"‰∏≠Êç≤(Ê∞¥ÁÖÆ)","spec":"6/8(ÂéªÁõÆ)450G*10ÂåÖ","unit":"‰ª∂"},{"productId":"EM08450306","name":"‰∏≠Êç≤(Ê∞¥ÁÖÆ)","spec":"8/10(ÂéªÁõÆ)450G*6ÂåÖ","unit":"‰ª∂"},{"productId":"EP04100010","name":"ËªüÁµ≤","spec":"4/6*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"EP06100010","name":"ËªüÁµ≤","spec":"6/8*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FC0010","name":"È≠∑È≠öËÜò","spec":"*10KG","unit":"‰ª∂"},{"productId":"FCP101010","name":"È≠∑È≠öÊ∏ÖËÇâ(ÂåÖ)","spec":"10/20*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FCP201010","name":"È≠∑È≠öÊ∏ÖËÇâ(ÂåÖ)","spec":"20/40*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FCS102010","name":"È≠∑È≠öÊ∏ÖËÇâ(Êï£)","spec":"10/20*20KG","unit":"‰ª∂"},{"productId":"FCS201810","name":"È≠∑È≠öÊ∏ÖËÇâ(Êï£)","spec":"20/40*18KG","unit":"‰ª∂"},{"productId":"FEG101010","name":"È≠∑È≠öËÄ≥(ÂàªËä±)","spec":"10/20*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FEG201010","name":"È≠∑È≠öËÄ≥(ÂàªËä±)","spec":"20/40*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FH0020","name":"È≠∑È≠öÈ†≠","spec":"*20KG","unit":"‰ª∂"},{"productId":"FH0508","name":"È≠∑È≠öÈ†≠","spec":"500G*8ÂåÖ","unit":"‰ª∂"},{"productId":"FM101010","name":"ÁÜüÈ≠∑È≠öËÇâ(ÂàªËä±)","spec":"10/20*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FM201010","name":"ÁÜüÈ≠∑È≠öËÇâ(ÂàªËä±)","spec":"20/40*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FR061010","name":"È≠∑È≠öÂúà(ÂàªËä±)","spec":"6UP*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FR101010","name":"È≠∑È≠öÂúà(ÂàªËä±)","spec":"10/20*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FR201010","name":"È≠∑È≠öÂúà(ÂàªËä±)","spec":"20/40*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FT0320","name":"È≠∑È≠öÈ¨ö","spec":"*20KG","unit":"‰ª∂"},{"productId":"FT031010","name":"È≠∑È≠öÈ¨ö","spec":"300G*10ÂåÖ","unit":"‰ª∂"},{"productId":"FT0420","name":"È≠∑È≠öÈ¨ö","spec":"*20KG(Âç∞Â∫¶)","unit":"‰ª∂"},{"productId":"FT1010","name":"È≠∑È≠öÈ¨ö","spec":"1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FT101010","name":"È≠∑È≠öÈ¨ö(ÂàªËä±)","spec":"10/20*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"FTC051010","name":"È≠∑È≠öÈ¨ö(ÂàªËä±ÂàáÊÆµ)","spec":"500G*10ÂåÖ(Áâõ)","unit":"‰ª∂"},{"productId":"FW0320","name":"È≠∑È≠öÁøÖ","spec":"*20KG(ÂàªËä±)","unit":"‰ª∂"},{"productId":"FW1010","name":"È≠∑È≠öÁøÖ","spec":"1KG*10ÂåÖ(ÂàªËä±)","unit":"‰ª∂"},{"productId":"GJ61100012","name":"Ëù¥Ëù∂Ëù¶","spec":"61/70(IQ10%)*1KG*12ÂåÖ(ÈüìÂºè)","unit":"‰ª∂"},{"productId":"GLB1010","name":"Ëù¥Ëù∂Ëù¶","spec":"*1KG*10ÂåÖ(ÈüìÂºè)","unit":"‰ª∂"},{"productId":"H9091008","name":"ËçâËù¶(SG)","spec":"90/110*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"H9101008","name":"ËçâËù¶(SG)","spec":"100/120*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"H9111008","name":"ËçâËù¶(SG)","spec":"110/130*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"HCG1010","name":"ÊØîÁõÆÈ≠öÈ∞≠ÈÇäËÇâ(ÁÖÆ)","spec":"*1KG*10ÂåÖ(Ê†ºÈôµËò≠)","unit":"‰ª∂"},{"productId":"JC04100010","name":"(ÂÜ∞Âç∑)È≠∑È≠ö","spec":"4/6*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"JC06100010","name":"(ÂÜ∞Âç∑)È≠∑È≠ö","spec":"6/8*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"JC08100010","name":"(ÂÜ∞Âç∑)È≠∑È≠ö","spec":"8/10*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"JC10100010","name":"(ÂÜ∞Âç∑)È≠∑È≠ö","spec":"10/15*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"JC15100010","name":"(ÂÜ∞Âç∑)È≠∑È≠ö","spec":"15/20*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"JF04100010","name":"È≠∑È≠ö4/6","spec":"4/6*1KG*10ÂåÖ(Êó•)","unit":"‰ª∂"},{"productId":"JGFH020304T","name":"‰∫∫ËîòÁÉèÈ™®Èõû","spec":"2~3KG/Èöª*4ÂåÖ*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"JQ04027010","name":"Â∞èÂç∑","spec":"4/6*270G*10ÂåÖ","unit":"‰ª∂"},{"productId":"JQ04030010","name":"Â∞èÂç∑","spec":"4/6*300G*10ÂåÖ","unit":"‰ª∂"},{"productId":"JQ06027010","name":"Â∞èÂç∑","spec":"6/8*270G*10ÂåÖ","unit":"‰ª∂"},{"productId":"JQ06030010","name":"Â∞èÂç∑","spec":"6/8*300G*10ÂåÖ","unit":"‰ª∂"},{"productId":"JQ08027010","name":"Â∞èÂç∑","spec":"8/12*270G*10ÂåÖ","unit":"‰ª∂"},{"productId":"JQ08030010","name":"Â∞èÂç∑","spec":"8/12*300G*10ÂåÖ","unit":"‰ª∂"},{"productId":"JQF08030010","name":"Â∞èÂç∑(ÂåÖ)","spec":"8/12*300G*10ÂåÖ","unit":"‰ª∂"},{"productId":"K06500320","name":"ËöµËÇâ","spec":"6/9*500G*20ÂåÖ","unit":"‰ª∂"},{"productId":"K69150010","name":"Áâ°Ë†£ËÇâ","spec":"6/9*1.5KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"M9L150008","name":"Ê∑°Ëèú(ÂçäÊÆº)","spec":"9L(Â§ß)*1.5KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"M9L200010","name":"Ê∑°Ëèú(ÂçäÊÆº)","spec":"9L(Â§ß)*2KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"ML150008","name":"Ê∑°Ëèú(ÂçäÊÆº)","spec":"L(‰∏≠)*1.5KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"ML200010","name":"Ê∑°Ëèú(ÂçäÊÆº)","spec":"L(‰∏≠)*2KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"MM200010","name":"Ê∑°Ëèú(ÂçäÊÆº)","spec":"M(Â∞è)*2KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"MN100010","name":"Ê∑°ËèúËÇâ","spec":"100/200*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"MN200010","name":"Ê∑°ËèúËÇâ","spec":"200/300*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"MSFL100010","name":"ÁáªÈÆ≠È≠ö(Èï∑Áâá)","spec":"1KG*10ÂåÖ(Ê≥ïÂúãÊ¥õÊñØ)","unit":"‰ª∂"},{"productId":"MSFL050010_1","name":"ÁáªÈÆ≠È≠ö(Èï∑Áâá)","spec":"500G*10ÂåÖ(Ê≥ïÂúãÊ¥õÊñØ)","unit":"‰ª∂"},{"productId":"MSFL050010_2","name":"ÁáªÈÆ≠È≠ö(Èï∑Áâá)","spec":"500G*10ÂåÖ(Ê≥ïÂúãÈáéÁîü)","unit":"‰ª∂"},{"productId":"MSS050005","name":"ÁáªÈÆ≠È≠ö(Áâá)","spec":"500G*5ÂåÖ(ËòáÊ†ºËò≠)","unit":"‰ª∂"},{"productId":"MSS050010","name":"ÁáªÈÆ≠È≠ö(Áâá)","spec":"500G*10ÂåÖ(ËòáÊ†ºËò≠)","unit":"‰ª∂"},{"productId":"MST100010","name":"ÁáªÈÆ≠È≠ö(Á¢é)","spec":"1KG*10ÂåÖ(Áæé)","unit":"‰ª∂"},{"productId":"N91090010_1","name":"ÁîüÁôΩËù¶(ÂéüÊñôBlock)","spec":"90/110*10KG(BLK)","unit":"‰ª∂"},{"productId":"N91110","name":"ÁîüÁôΩËù¶(ÂéüÊñôBlock)","spec":"90/110*10KG(BLK)","unit":"‰ª∂"},{"productId":"OA0318","name":"Ëµ§Âò¥Ëõ§(ÁúüÁ©∫)","spec":"300G*18ÂåÖ","unit":"‰ª∂"},{"productId":"OA0510","name":"Ëµ§Âò¥Ëõ§(ÁúüÁ©∫)","spec":"500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"OB0320","name":"ÁôΩËõ§(ÁúüÁ©∫)","spec":"300G*20ÂåÖ","unit":"‰ª∂"},{"productId":"OCA1010","name":"Ëõ§ËúäËÇâ(Áîü)","spec":"1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"OCC1010","name":"Ëõ§ËúäËÇâ(ÁÜü)","spec":"1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"OCD60201010","name":"Â∞èËõ§Ëúä(ÁúüÁ©∫,ÁÜü,ÂéªÊ≤ô)","spec":"60/100*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"OW0510","name":"Â§ßËõ§(ÁúüÁ©∫)","spec":"500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"OW0610","name":"Â§ßËõ§(ÁúüÁ©∫)","spec":"600G*10ÂåÖ","unit":"‰ª∂"},{"productId":"P01FI100110","name":"È≠öÊùø(ÊùæËëâ)","spec":"10Áâá*1KG*10ÂåÖ(ÁÅ´Èçã)","unit":"‰ª∂"},{"productId":"P02SA100112","name":"È≠öÊùø(ÊùæËëâ)","spec":"20Áâá*1KG*12Ê¢ù(Ê≤ôÊãâ)","unit":"‰ª∂"},{"productId":"P03GR100110","name":"È≠öÊùø(ÊùæËëâ)","spec":"36Áâá*1KG*10ÂåÖ(ÁáíÁÉ§)","unit":"‰ª∂"},{"productId":"R21W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"21/25(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R21W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"21/25(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R26W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"26/30(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R26W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"26/30(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R31W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"31/35(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R31W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"31/40(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R36W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"36/40(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R36W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"36/40(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R41W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"41/50(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R41W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"41/50(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R51W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"51/60(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R51W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"51/60(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R61W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"61/70(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R61W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"61/70(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R71W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"71/90(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R71W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"71/90(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R91W10B12","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"90/110(IQ10%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"R91W10B12_1","name":"ÁîüÁôΩËù¶(Â§ß)","spec":"90/110(IQ15%)*1KG*12ÂåÖ","unit":"‰ª∂"},{"productId":"S08M100010","name":"Âπ≤Ë≤ù(Êó•)","spec":"S(8M)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"S10M100010","name":"Âπ≤Ë≤ù(Êó•)","spec":"M(10M)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"S20M100010","name":"Âπ≤Ë≤ù(Êó•)","spec":"L(20M)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"S30M100010","name":"Âπ≤Ë≤ù(Êó•)","spec":"2L(30M)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"S40M100010","name":"Âπ≤Ë≤ù(Êó•)","spec":"3L(40M)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"S50M100010","name":"Âπ≤Ë≤ù(Êó•)","spec":"4L(50M)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"S60M100010","name":"Âπ≤Ë≤ù(Êó•)","spec":"5L(60M)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SA02100010","name":"Âπ≤Ë≤ù(Êæ≥Ê¥≤)","spec":"20/30*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SA04100010","name":"Âπ≤Ë≤ù(Êæ≥Ê¥≤)","spec":"40/60*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SA06100010","name":"Âπ≤Ë≤ù(Êæ≥Ê¥≤)","spec":"60/80*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SAB1008","name":"ÁÜüÈÆëÈ≠ö(Êæ≥Ê¥≤)","spec":"12P*1KG*8ÂåÖ(Â∏∂ÊÆº)","unit":"‰ª∂"},{"productId":"SC02100010","name":"Âπ≤Ë≤ù(Âä†ÊãøÂ§ß)","spec":"20/30*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SC04100010","name":"Âπ≤Ë≤ù(Âä†ÊãøÂ§ß)","spec":"40/60*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SC06100010","name":"Âπ≤Ë≤ù(Âä†ÊãøÂ§ß)","spec":"60/80*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SCA06100010","name":"Âπ≤Ë≤ù(Âä†ÊãøÂ§ßÈáéÁîü)","spec":"60/80*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SCM100010","name":"ÈÆ≠È≠ö‰∏Å","spec":"1KG*10ÂåÖ(Â∞è)","unit":"‰ª∂"},{"productId":"SCM500020","name":"ÈÆ≠È≠öËÖπÈ∞≠","spec":"5KG*20KG","unit":"‰ª∂"},{"productId":"SCS100010","name":"ÈÆ≠È≠ö‰∏Å(Â§ß)","spec":"1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SD02100010","name":"Âπ≤Ë≤ù(Á•ïÈ≠Ø)","spec":"20/30*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SD04100010","name":"Âπ≤Ë≤ù(Á•ïÈ≠Ø)","spec":"40/60*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SD06100010","name":"Âπ≤Ë≤ù(Á•ïÈ≠Ø)","spec":"60/80*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SFN015006","name":"ÂçäÊÆºÊâáË≤ù","spec":"1#*500G*6ÂåÖ(Á¥ê)","unit":"‰ª∂"},{"productId":"SFN030006","name":"ÂçäÊÆºÊâáË≤ù","spec":"3#*300G*6ÂåÖ(Á¥ê)","unit":"‰ª∂"},{"productId":"SGE0810","name":"Á¶èÊ∞£È≠öÂçµ(ÂåÖ)","spec":"800G*10ÂåÖ(ÂÜ∞)","unit":"‰ª∂"},{"productId":"SJ02100010","name":"Âπ≤Ë≤ù(Êó•ÁîüÈ£ü)","spec":"21/25*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SJ03100010","name":"Âπ≤Ë≤ù(Êó•ÁîüÈ£ü)","spec":"26/30*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SJ04100010","name":"Âπ≤Ë≤ù(Êó•ÁîüÈ£ü)","spec":"36/40*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SJ06100010","name":"Âπ≤Ë≤ù(Êó•ÁîüÈ£ü)","spec":"51/60*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SJB02100010","name":"Âπ≤Ë≤ù(Êó•Á¢é)","spec":"SÁ¢é*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SJB04100010","name":"Âπ≤Ë≤ù(Êó•Á¢é)","spec":"MÁ¢é*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SJB04100810","name":"Âπ≤Ë≤ù(Êó•Á¢é)","spec":"MÁ¢é(100Á≤í)800G*10ÂåÖ","unit":"‰ª∂"},{"productId":"SN02100010","name":"Âπ≤Ë≤ù(Ë∂äÂçó)","spec":"20/30*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SN04100010","name":"Âπ≤Ë≤ù(Ë∂äÂçó)","spec":"40/60*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SN06100010","name":"Âπ≤Ë≤ù(Ë∂äÂçó)","spec":"60/80*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SRTC1010","name":"ÈÆ≠È≠öÁ¢éËÇâ","spec":"1KG*10ÂåÖ*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"SS02100010","name":"Âπ≤Ë≤ù(Áæé)","spec":"U-10*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SS04100010","name":"Âπ≤Ë≤ù(Áæé)","spec":"40/60*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SS06100010","name":"Âπ≤Ë≤ù(Áæé)","spec":"60/80*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SS10100010","name":"Âπ≤Ë≤ù(Áæé)","spec":"10/20*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SS20100010","name":"Âπ≤Ë≤ù(Áæé)","spec":"20/30*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SSF100010","name":"Âπ≤Ë≤ù(Â¢®)","spec":"100/150*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"ST05100010","name":"Âπ≤Ë≤ù(Âè∞)","spec":"50/80*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"STCC1010","name":"ÈÆ≠È≠öËÇöÊ¢ù*ÂÇ≥ÈÆÆ","spec":"1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SU02100010","name":"Âπ≤Ë≤ù(ÁæéË≤ù)","spec":"20/30*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SU04100010","name":"Âπ≤Ë≤ù(ÁæéË≤ù)","spec":"40/50*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"SU06100010","name":"Âπ≤Ë≤ù(ÁæéË≤ù)","spec":"50/70*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"T05030008","name":"ÈØõÈ≠öÁâá(Âè∞)","spec":"5/7oz*300G*8ÂåÖ","unit":"‰ª∂"},{"productId":"T07030008","name":"ÈØõÈ≠öÁâá(Âè∞)","spec":"7/9oz*300G*8ÂåÖ","unit":"‰ª∂"},{"productId":"TF0018","name":"Ëí≤ÁáíÈØõ(Áâá)","spec":"140G*18Áâá*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"TF0112","name":"Ëí≤ÁáíÈØõ(Áâá)","spec":"1KG*12Áâá*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"TO220018T","name":"ÈØñÈ≠ö‰∏ÄÂ§úÂπ≤","spec":"220G*18Áâá*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"TO260018T","name":"ÈØñÈ≠ö‰∏ÄÂ§úÂπ≤","spec":"260G*18Áâá*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"TP100008","name":"ËñÑÈπΩÂúüÈ≠†È≠ö","spec":"285G*8Áâá*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"TP100010","name":"ËñÑÈπΩÂúüÈ≠†È≠ö","spec":"285G*10Áâá*ÂÇ≥ÈÆÆ","unit":"‰ª∂"},{"productId":"TT05100010","name":"Á´†È≠öËÖ≥(ÁÜü)","spec":"T5*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"U11000010","name":"ÂâùÊÆºËù¶‰ªÅ(‰ª£Â∑•)","spec":"1KG*10ÂåÖ(IQ)","unit":"‰ª∂"},{"productId":"UA3611008","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"36/40(IQ10%)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"UA41090010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ10%)*900G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UA4111008","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ10%)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"UA5111008","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ10%)*1KG*8ÂåÖ","unit":"‰ª∂"},{"productId":"UA5111010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ10%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UA6111010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"61/70(IQ10%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UA7111010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"71/90(IQ10%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UA9111010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"91/110(IQ10%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UB21040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"21/25(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB26040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"26/30(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB31040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"31/40(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB36040010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"36/40(IQ20%)*400G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UB36040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"36/40(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB41040010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ20%)*400G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UB41040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB51040010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ20%)*400G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UB51040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB61040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"61/70(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB71040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"71/90(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UB91040012","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"91/110(IQ20%)*400G*12ÂåÖ","unit":"‰ª∂"},{"productId":"UC31050010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"31/40(IQ20%)*500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UC36050010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"36/40(IQ20%)*500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UC41050010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ20%)*500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UC51050010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ20%)*500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UC61050010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"61/70(IQ20%)*500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UC71050010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"71/90(IQ20%)*500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UC91050010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"91/110(IQ20%)*500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UD36100010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"36/40(IQ20%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UD41100010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ20%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UD51100010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ20%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UD61100010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"61/70(IQ20%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UD71100010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"71/90(IQ20%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UD91100010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"91/110(IQ20%)*1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"UF21100010","name":"ÁôΩËù¶‰ªÅ(ÂéªËÖ∏)","spec":"21/25(IQ15%)*1KG*10ÂåÖ(‰ª£Â∑•)","unit":"‰ª∂"},{"productId":"UF26100010","name":"ÁôΩËù¶‰ªÅ(ÂéªËÖ∏)","spec":"26/30(IQ15%)*1KG*10ÂåÖ(‰ª£Â∑•)","unit":"‰ª∂"},{"productId":"UF31100010","name":"ÁôΩËù¶‰ªÅ(ÂéªËÖ∏)","spec":"31/40(IQ15%)*1KG*10ÂåÖ(‰ª£Â∑•)","unit":"‰ª∂"},{"productId":"UF41100010","name":"ÁôΩËù¶‰ªÅ(ÂéªËÖ∏)","spec":"41/50(IQ15%)*1KG*10ÂåÖ(‰ª£Â∑•)","unit":"‰ª∂"},{"productId":"UF51100010","name":"ÁôΩËù¶‰ªÅ(ÂéªËÖ∏)","spec":"51/60(IQ15%)*1KG*10ÂåÖ(‰ª£Â∑•)","unit":"‰ª∂"},{"productId":"UF61100010","name":"ÁôΩËù¶‰ªÅ(ÂéªËÖ∏)","spec":"61/70(IQ15%)*1KG*10ÂåÖ(‰ª£Â∑•)","unit":"‰ª∂"},{"productId":"UF71100010","name":"ÁôΩËù¶‰ªÅ(ÂéªËÖ∏)","spec":"71/90(IQ15%)*1KG*10ÂåÖ(‰ª£Â∑•)","unit":"‰ª∂"},{"productId":"UK41045010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ20%)*450G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UK51045010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ20%)*450G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UK61045010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"61/70(IQ20%)*450G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UK71045010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"71/90(IQ20%)*450G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UK91045010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"91/110(IQ20%)*450G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UL41090010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"41/50(IQ20%)*900G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UL51090010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"51/60(IQ20%)*900G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UL61090010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"61/70(IQ20%)*900G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UL71090010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"71/90(IQ20%)*900G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UL91090010","name":"ÁÑ°ËÜ®ÁôºËù¶‰ªÅPD(‰ª£Â∑•)","spec":"91/110(IQ20%)*900G*10ÂåÖ","unit":"‰ª∂"},{"productId":"UM36042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"36/40(IQ20%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UM41042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"41/50(IQ20%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UM51042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"51/60(IQ20%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UM61042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"61/70(IQ20%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UM71042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"71/90(IQ20%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UM91042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"91/110(IQ20%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UN36042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"36/40(IQ10%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UN41042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"41/50(IQ10%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UN51042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"51/60(IQ10%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UN61042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"61/70(IQ10%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UN71042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"71/90(IQ10%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"UN91042020","name":"Ëù¶‰ªÅPD(Â∞èË£ù)","spec":"91/110(IQ10%)*420G*20ÂåÖ","unit":"‰ª∂"},{"productId":"W0206","name":"ÊõºÊ≥¢È≠ö(ÁöÆ)","spec":"200G*6ÂåÖ","unit":"‰ª∂"},{"productId":"W0510","name":"ÊõºÊ≥¢È≠ö(ÁöÆ)","spec":"500G*10ÂåÖ","unit":"‰ª∂"},{"productId":"WD41100015","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"41/50(IQ15%)*1KG*15ÂåÖ","unit":"‰ª∂"},{"productId":"WD41100020","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"41/50(IQ15%)*1KG*20ÂåÖ","unit":"‰ª∂"},{"productId":"WD51100015","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"51/60(IQ15%)*1KG*15ÂåÖ","unit":"‰ª∂"},{"productId":"WD51100020","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"51/60(IQ15%)*1KG*20ÂåÖ","unit":"‰ª∂"},{"productId":"WD61100015","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"61/70(IQ15%)*1KG*15ÂåÖ","unit":"‰ª∂"},{"productId":"WD61100020","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"61/70(IQ15%)*1KG*20ÂåÖ","unit":"‰ª∂"},{"productId":"WD71100015","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"71/90(IQ15%)*1KG*15ÂåÖ","unit":"‰ª∂"},{"productId":"WD71100020","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"71/90(IQ15%)*1KG*20ÂåÖ","unit":"‰ª∂"},{"productId":"WD91100015","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"91/110(IQ15%)*1KG*15ÂåÖ","unit":"‰ª∂"},{"productId":"WD91100020","name":"ÁîüÁôΩËù¶‰ªÅPD(DV)","spec":"91/110(IQ15%)*1KG*20ÂåÖ","unit":"‰ª∂"},{"productId":"X100010","name":"Êµ∑ËÜΩ(ÂÜ∑)","spec":"100G*10Áõí(Êó•)","unit":"‰ª∂"},{"productId":"Y01050012","name":"ËüπÁÆ°ËÇâ","spec":"ÁâπA(230G)*12Áì∂","unit":"‰ª∂"},{"productId":"Y02050012","name":"ËüπÁÆ°ËÇâ","spec":"A(200G)*12Áì∂","unit":"‰ª∂"},{"productId":"Y03050012","name":"ËüπÁÆ°ËÇâ","spec":"B(170G)*12Áì∂","unit":"‰ª∂"},{"productId":"YT100006","name":"Èõ™ËüπËÖ≥(ÁÜü)","spec":"1KG*6ÂåÖ","unit":"‰ª∂"},{"productId":"YT100010","name":"Èõ™ËüπËÖ≥(ÁÜü)","spec":"1KG*10ÂåÖ","unit":"‰ª∂"},{"productId":"Z021004","name":"ÈæçËù¶(Ê¥ªÂáç)","spec":"200/250*10KG*4Áõí","unit":"‰ª∂"},{"productId":"Z023510","name":"ÈæçËù¶(Áîü)","spec":"200/300*3.5KG*10Áõí","unit":"‰ª∂"},{"productId":"Z043510","name":"ÈæçËù¶(Áîü)","spec":"300/400*3.5KG*10Áõí","unit":"‰ª∂"},{"productId":"Z101","name":"101","spec":"","unit":"ÂåÖ"}];

            const handleProductExcelImport = async (evt) => {
                const file = evt.target.files[0];
                if (!file) return;
                evt.target.value = '';
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '', header: 1 });
                    
                    // ÊâæÂà∞Ê®ôÈ°åÂàóÔºàÂìÅËôü„ÄÅÂìÅÂêç„ÄÅË¶èÊ†ºÔºâ
                    let headerRowIndex = -1;
                    for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (row && row.some(cell => cell === 'ÂìÅËôü' || cell === 'ÂìÅÂêç')) {
                            headerRowIndex = i;
                            break;
                        }
                    }
                    
                    if (headerRowIndex === -1) {
                        alert('Êâæ‰∏çÂà∞Ê®ôÈ°åÂàóÔºàÂìÅËôü„ÄÅÂìÅÂêç„ÄÅË¶èÊ†ºÔºâ');
                        return;
                    }
                    
                    const headers = jsonData[headerRowIndex];
                    const colIndex = {
                        productId: headers.findIndex(h => h === 'ÂìÅËôü'),
                        name: headers.findIndex(h => h === 'ÂìÅÂêç'),
                        spec: headers.findIndex(h => h === 'Ë¶èÊ†º'),
                        unit: headers.findIndex(h => h === 'ÂñÆ‰Ωç')
                    };
                    
                    // Ëß£ÊûêË≥áÊñôÂàó
                    const parsedProducts = {};
                    for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const productId = row[colIndex.productId];
                        const name = row[colIndex.name];
                        const spec = row[colIndex.spec];
                        const unit = colIndex.unit >= 0 ? row[colIndex.unit] : '';
                        
                        // Ë∑≥ÈÅéÁ©∫ÁôΩÂàóÊàñÂ∞èË®àÂàó
                        if (!productId || !name || productId === 'ÂìÅËôü') continue;
                        
                        // ‰ΩøÁî®ÂìÅËôü+Ë¶èÊ†º‰ΩúÁÇ∫ÂîØ‰∏ÄÈçµ
                        const key = `${productId}_${spec || ''}`;
                        if (!parsedProducts[key]) {
                            parsedProducts[key] = {
                                productId: String(productId).trim(),
                                name: String(name).trim(),
                                spec: String(spec || '').trim(),
                                unit: PRODUCT_UNITS.includes(unit) ? unit : 'ÂåÖ',
                                defaultPrice: 0,
                                defaultSupplier: '',
                                isActive: true
                            };
                        }
                    }
                    
                    const productList = Object.values(parsedProducts);
                    if (productList.length === 0) {
                        alert(TEXT.IMPORT_NO_DATA);
                        return;
                    }
                    
                    setProductImportData(productList);
                    setShowProductImportModal(true);
                    
                } catch (error) {
                    console.error('Excel Ëß£ÊûêÈåØË™§:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                }
            };

            const handleConfirmProductImport = async () => {
                if (productImportData.length === 0) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                setImportProcessing(true);
                setImportProgress({ current: 0, total: productImportData.length });
                
                let successCount = 0;
                let errorCount = 0;
                
                try {
                    // ÊâπÊ¨°ÂØ´ÂÖ•ÔºåÊØèÊâπ 500 Á≠Ü
                    const batchSize = 500;
                    for (let i = 0; i < productImportData.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = productImportData.slice(i, i + batchSize);
                        
                        for (const item of chunk) {
                            // ‰ΩøÁî®ÂìÅËôü+Ë¶èÊ†º‰ΩúÁÇ∫Êñá‰ª∂ ID
                            const docId = `${item.productId}_${item.spec}`.replace(/[\/\\*?\"<>|]/g, '_');
                            const docRef = db.collection('products').doc(docId);
                            batch.set(docRef, {
                                ...item,
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                        }
                        
                        await batch.commit();
                        successCount += chunk.length;
                        setImportProgress({ current: Math.min(i + batchSize, productImportData.length), total: productImportData.length });
                    }
                    
                    setShowProductImportModal(false);
                    setProductImportData([]);
                    showToast(`${TEXT.IMPORT_SUCCESS}Ôºö${successCount} Á≠ÜÁî¢ÂìÅ`);
                    
                } catch (error) {
                    console.error('ÂåØÂÖ•Â§±Êïó:', error);
                    alert(TEXT.IMPORT_FAILED + ': ' + error.message);
                } finally {
                    setImportProcessing(false);
                }
            };

            const handleSaveProduct = async () => {
                if (!editingProduct) return;
                if (!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                
                if (!editingProduct.productId || !editingProduct.name) {
                    alert('Ë´ãÂ°´ÂØ´ÂìÅËôüÂíåÂìÅÂêç');
                    return;
                }
                
                try {
                    const docId = `${editingProduct.productId}_${editingProduct.spec || ''}`.replace(/[\/\\*?\"<>|]/g, '_');
                    await db.collection('products').doc(docId).set({
                        ...editingProduct,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    setShowProductModal(false);
                    setEditingProduct(null);
                    showToast('ÂÑ≤Â≠òÊàêÂäü');
                } catch (error) {
                    alert(TEXT.SAVE_FAILED + ': ' + error.message);
                }
            };

            const handleDeleteProduct = async (product) => {
                if (!canDelete()) return alert(TEXT.PERMISSION_DENIED);
                if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${product.name} (${product.spec}) ÂóéÔºü`)) return;
                
                try {
                    const docId = `${product.productId}_${product.spec || ''}`.replace(/[\/\\*?\"<>|]/g, '_');
                    await db.collection('products').doc(docId).delete();
                    showToast('Â∑≤Âà™Èô§');
                } catch (error) {
                    alert(TEXT.SAVE_FAILED + ': ' + error.message);
                }
            };

            const filteredProducts = useMemo(() => {
                if (!productSearchTerm.trim()) return products;
                const term = productSearchTerm.toLowerCase();
                return products.filter(p => 
                    (p.productId || '').toLowerCase().includes(term) ||
                    (p.name || '').toLowerCase().includes(term) ||
                    (p.spec || '').toLowerCase().includes(term) ||
                    (p.defaultSupplier || '').toLowerCase().includes(term)
                );
            }, [products, productSearchTerm]);

            // V76.0: Áî¢ÂìÅÈÅ∏ÊìáÂô®ÁØ©ÈÅ∏ÁµêÊûú
            const pickerFilteredProducts = useMemo(() => {
                if (!productPickerSearch.trim()) return products.filter(p => p.isActive !== false).slice(0, 50);
                const term = productPickerSearch.toLowerCase();
                return products.filter(p => 
                    p.isActive !== false && (
                        (p.productId || '').toLowerCase().includes(term) ||
                        (p.name || '').toLowerCase().includes(term) ||
                        (p.spec || '').toLowerCase().includes(term)
                    )
                ).slice(0, 50);
            }, [products, productPickerSearch]);

            // V76.0: ÈÅ∏ÊìáÁî¢ÂìÅÂæåËá™ÂãïÂ∏∂ÂÖ•Ë¶èÊ†º
            const handleSelectProduct = (pickerInfo, selectedProduct) => {
                // Âà§Êñ∑ÊòØ AI È†êË¶ΩÊ®°ÂºèÈÇÑÊòØ‰∏ÄËà¨Ë°®ÂñÆÊ®°Âºè
                if (pickerInfo && typeof pickerInfo === 'object' && pickerInfo.type === 'aiPreview') {
                    // AI È†êË¶ΩÊ®°ÂºèÔºöÊõ¥Êñ∞ fieldSources.products
                    const idx = pickerInfo.index;
                    setFieldSources(prev => {
                        const newProducts = [...(prev.products?.value || [])];
                        newProducts[idx] = {
                            ...newProducts[idx],
                            selectedName: selectedProduct.name + (selectedProduct.spec ? ' ' + selectedProduct.spec : ''),
                            selectedSpec: selectedProduct.spec || '',
                            originalText: newProducts[idx].originalText || newProducts[idx].name // ‰øùÁïôÂéüÂßãËã±Êñá
                        };
                        return {
                            ...prev,
                            products: { ...prev.products, value: newProducts }
                        };
                    });
                } else {
                    // ‰∏ÄËà¨Ë°®ÂñÆÊ®°Âºè
                    const idx = pickerInfo;
                    const np = [...formData.products];
                    np[idx] = {
                        ...np[idx],
                        name: selectedProduct.name || '',
                        spec: selectedProduct.spec || '',
                    };
                    setFormData(prev => ({ ...prev, products: np }));
                    
                    // Ê∏ÖÈô§È©óË≠âÈåØË™§
                    if (validationErrors.products) {
                        setValidationErrors(prev => ({...prev, products: false}));
                    }
                }
                
                setActiveProductPicker(null);
                setProductPickerSearch('');
            };

            // V69.0 Update: Line message content
            const handleShareToLine = (s) => {
                const isDom = isDomestic(s);
                let text = `${isDom ? TEXT.LINE_NOTIFY_DOMESTIC : TEXT.LINE_NOTIFY_FOREIGN}\n`;
                text += `Êó•ÊúüÔºö${s.arrivalDate}\n`;
                text += `Ê´ÉËôüÔºö${s.containerNumber}\n`;
                text += `Âª†ÂïÜÔºö${s.supplier}\n`;
                // V69.0 Additions:
                text += `ÊãÜÊ´ÉÊó•Ôºö${s.devanningDate || 'Êú™ÂÆö'}\n`;
                text += `ÊãÜÊ´ÉÂú∞Ôºö${s.devanningLocation || 'Êú™ÂÆö'}\n\n`;
                
                (s.products || []).forEach((p, i) => {
                    // V69.0 Additions: Batch Number
                    text += `${i+1}. ${p.name} ${p.spec ? p.spec : ''} (Êâπ:${p.batchNumber||'ÁÑ°'}) - ${p.quantity}‰ª∂\n`; 
                });
                window.open("https://line.me/R/msg/text/?" + encodeURIComponent(text), '_blank');
            };

            const handleAttachmentClick = (e, item) => {
                e.stopPropagation();
                const files = item.attachments || [];
                if (files.length === 0 && item.docUrl) { window.open(item.docUrl, '_blank'); return; }
                if (files.length === 1) { window.open(files[0].url, '_blank'); return; }
                if (files.length > 1) { setFileList(files); setShowFileModal(true); }
            };

            const handleEdit = (item) => {
                if(!canEdit() && !canUpload()) return alert(TEXT.PERMISSION_DENIED); 
                let atts = item.attachments || [];
                if (item.docUrl && atts.length === 0) { atts.push({ name: item.docName || TEXT.LABEL_ATTACHMENTS, url: item.docUrl, path: item.docRefPath }); }
                setFormData({ 
                    ...initialFormState, ...item, attachments: atts,
                    currency: item.currency || (item.customsBroker === DOMESTIC_FLAG ? 'TWD' : 'USD'),
                    paymentTerm: item.paymentTerm || (item.customsBroker === DOMESTIC_FLAG ? PAYMENT_TERMS_DOMESTIC[0] : 'Âà∞Ê∏ØÂâç‰ªòÊ¨æ'),
                    prepayment: item.prepayment || 0, flightFee: item.flightFee || 0, flightFeePaid: item.flightFeePaid || false,
                    customsDeclarationNo: item.customsDeclarationNo || '', importPermitNo: item.importPermitNo || '',
                    shippingCompany: item.shippingCompany || ''
                }); 
                setEditingId(item.id); setOpenSections(['basic']); setView('form'); 
            };

            const handleDuplicateShipment = (s) => { 
                if(!canCreate()) return alert(TEXT.PERMISSION_DENIED);
                const {id, ...d} = s; const merged = { ...initialFormState, ...d };
                const np = (merged.products || []).map(p=>({...p,id:Date.now()+Math.random()})); 
                setFormData({...merged, containerNumber:'', products:np, attachments:[], isPaid: false, prepayment: 0, flightFee: 0, flightFeePaid: false}); 
                setEditingId(null); setFormStep(1); setView('form'); 
            };

            // V70.0: Ë°®ÂñÆÈ©óË≠âÂáΩÊï∏
            const validateForm = () => {
                const errors = {};
                const isDom = isDomestic(formData);
                
                // Êñ∞Â¢ûÊôÇÁöÑÂøÖÂ°´È©óË≠â
                if (!editingId) {
                    if (!formData.containerNumber?.trim()) errors.containerNumber = true;
                    if (!formData.arrivalDate) errors.arrivalDate = true;
                    if (!formData.supplier?.trim()) errors.supplier = true;
                    
                    // Áî¢ÂìÅÊòéÁ¥∞È©óË≠âÔºöËá≥Â∞ëË¶ÅÊúâ‰∏ÄÂÄãÁî¢ÂìÅÂêçÁ®±
                    const hasValidProduct = (formData.products || []).some(p => p.name?.trim());
                    if (!hasValidProduct) errors.products = true;
                }
                
                return errors;
            };

            const showToast = (message) => {
                setValidationMessage(message);
                setShowValidationToast(true);
                setTimeout(() => setShowValidationToast(false), 3000);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!canEdit()) return alert(TEXT.PERMISSION_DENIED);
                
                // V70.0: Âü∑Ë°åË°®ÂñÆÈ©óË≠â
                const errors = validateForm();
                setValidationErrors(errors);
                
                if (Object.keys(errors).length > 0) {
                    const errorMessages = [];
                    if (errors.containerNumber) errorMessages.push(TEXT.FIELD_CONTAINER);
                    if (errors.arrivalDate) errorMessages.push(TEXT.FIELD_ARRIVAL_DATE);
                    if (errors.supplier) errorMessages.push(TEXT.FIELD_SUPPLIER);
                    if (errors.products) errorMessages.push(TEXT.FIELD_PRODUCT_NAME);
                    showToast(TEXT.REQUIRED_FIELDS + errorMessages.join('„ÄÅ'));
                    return;
                }
                
                setIsSubmitting(true);
                try {
                    const d = {...formData, updatedAt: new Date().toISOString()};
                    
                    let dataToSend = d;
                    
                    if(editingId) {
                        if (userRole === 'QC') {
                            dataToSend = {
                                customsDeclarationNo: d.customsDeclarationNo,
                                importPermitNo: d.importPermitNo,
                                attachments: d.attachments,
                                docUrl: d.docUrl || '',
                                docName: d.docName || '',
                                docRefPath: d.docRefPath || '',
                                updatedAt: d.updatedAt
                            };
                        } else if (userRole === 'WAREHOUSE') {
                             dataToSend = {
                                warehouseConfirmed: d.warehouseConfirmed,
                                devanningLocation: d.devanningLocation,
                                devanningDate: d.devanningDate,
                                products: d.products, 
                                totalQuantity: d.totalQuantity,
                                totalWeight: d.totalWeight,
                                updatedAt: d.updatedAt
                             };
                        } 
                        
                        await db.collection('shipments').doc(editingId).update(dataToSend);
                    } else {
                        await db.collection('shipments').add({...d, createdAt: new Date().toISOString()});
                    }
                    setValidationErrors({});
                    setEditingId(null); setView('list');
                } catch(err){ 
                    console.error(err);
                    alert(TEXT.SAVE_FAILED + ": " + err.message); 
                } finally { 
                    setIsSubmitting(false); 
                }
            };

            // V79.0: Ë®àÁÆóÂª†ÂïÜÂ∫èËôüÔºàÂπ¥Â∫¶-Â∫èËôüÔºåÂ¶Ç 26-01Ôºâ
            const generateVendorSeqNo = (supplier, arrivalDate, excludeId = null) => {
                if (!supplier || !arrivalDate) return '';
                
                // ÂèñÂπ¥‰ªΩÂæåÂÖ©‰Ωç
                const year = arrivalDate.substring(2, 4); // "2026-01-05" ‚Üí "26"
                
                // ÊâæÂá∫ÂêåÂª†ÂïÜÂêåÂπ¥Â∫¶ÁöÑÊâÄÊúâË®òÈåÑ
                const sameVendorSameYear = shipments.filter(s => 
                    s.supplier === supplier && 
                    s.arrivalDate?.startsWith(`20${year}`) &&
                    s.id !== excludeId
                );
                
                // ÊâæÂá∫ÊúÄÂ§ßÂ∫èËôü
                let maxSeq = 0;
                sameVendorSameYear.forEach(s => {
                    if (s.vendorSeqNo) {
                        const match = s.vendorSeqNo.match(/^\d{2}-(\d+)$/);
                        if (match) {
                            const seq = parseInt(match[1], 10);
                            if (seq > maxSeq) maxSeq = seq;
                        }
                    }
                });
                
                // ‰∏ã‰∏ÄÂÄãÂ∫èËôü
                const nextSeq = maxSeq + 1;
                return `${year}-${nextSeq.toString().padStart(2, '0')}`;
            };

            const handleInputChange = (e) => {
                const {name,value,type,checked}=e.target;
                setFormData(p => {
                    const newData = {...p, [name]: type==='checkbox'?checked:value};
                    
                    // V79.0: Áï∂Âª†ÂïÜÊàñÂà∞Ê∏ØÊó•ÊîπËÆäÊôÇÔºåËá™ÂãïÁî¢ÁîüÂª†ÂïÜÂ∫èËôü
                    if ((name === 'supplier' || name === 'arrivalDate') && !editingId) {
                        const supplier = name === 'supplier' ? value : newData.supplier;
                        const arrivalDate = name === 'arrivalDate' ? value : newData.arrivalDate;
                        if (supplier && arrivalDate) {
                            newData.vendorSeqNo = generateVendorSeqNo(supplier, arrivalDate);
                        }
                    }
                    
                    return newData;
                });
                // V70.0: Ê∏ÖÈô§Ë©≤Ê¨Ñ‰ΩçÁöÑÈ©óË≠âÈåØË™§
                if (validationErrors[name]) {
                    setValidationErrors(prev => ({...prev, [name]: false}));
                }
            };
            
            // V71.0: ÈúÄË¶ÅÈáçÊñ∞Ë®àÁÆóÈáëÈ°çÁöÑÊ¨Ñ‰Ωç
            const AMOUNT_FIELDS = ['quantity', 'weight', 'unitPrice', 'pricingMode', 'boxCapacity'];
            // V71.0: ÈúÄË¶ÅÈáçÊñ∞Ë®àÁÆóÁ∏ΩÂíåÁöÑÊ¨Ñ‰Ωç
            const TOTAL_FIELDS = ['quantity', 'weight'];

            const handleProductChange = (idx, f, v) => {
                const np = [...formData.products]; np[idx] = {...np[idx], [f]:v};
                const p = np[idx];

                if (f === 'spec') {
                    const match = v.match(/(\d+)\s*(?:Áõí|ÂåÖ|Â°ä|Áâá)/);
                    if (match) { p.boxCapacity = parseFloat(match[1]); }
                }

                // V71.0: Âè™Âú®ÈáëÈ°çÁõ∏ÈóúÊ¨Ñ‰ΩçËÆäÊõ¥ÊôÇÊâçÈáçÊñ∞Ë®àÁÆó
                if (AMOUNT_FIELDS.includes(f) || f === 'spec') {
                    const q = safeNum(p.quantity);
                    const b = safeNum(p.boxCapacity) || 1;
                    const w = safeNum(p.weight);
                    const u = safeNum(p.unitPrice);

                    if(p.pricingMode==='weight') { p.amount = round2(w * u); } 
                    else { p.amount = round2(q * b * u); }
                }

                // V71.0: Âè™Âú®Êï∏Èáè/ÈáçÈáèÊ¨Ñ‰ΩçËÆäÊõ¥ÊôÇÊâçÈáçÊñ∞Ë®àÁÆóÁ∏ΩÂíå
                if (TOTAL_FIELDS.includes(f)) {
                    setFormData(prev => ({
                        ...prev, 
                        products: np, 
                        totalQuantity: np.reduce((s,i) => s + safeNum(i.quantity), 0), 
                        totalWeight: round2(np.reduce((s,i) => s + safeNum(i.weight), 0))
                    }));
                } else {
                    setFormData(prev => ({...prev, products: np}));
                }
                
                // V70.0: Ëã•‰øÆÊîπÂìÅÂêçÔºåÊ∏ÖÈô§Áî¢ÂìÅÈ©óË≠âÈåØË™§
                if (f === 'name' && v?.trim() && validationErrors.products) {
                    setValidationErrors(prev => ({...prev, products: false}));
                }
            };

            const addProductRow = (e) => {
                if(e) e.preventDefault();
                // V68.0: È†êË®≠ weight, boxCapacity=1
                setFormData(p => ({...p, products:[...(p.products||[]), {id:Date.now(), name:'', quantity:0, weight:0, unitPrice:0, amount:0, pricingMode:'weight', boxCapacity: 1}]}));
            };
            const duplicateProductRow = (idx) => { const p=formData.products[idx]; setFormData(prev=>({...prev, products:[...prev.products.slice(0,idx+1), {...p, id:Date.now()}, ...prev.products.slice(idx+1)]})); };
            const removeProductRow = (idx) => { const np=formData.products.filter((_,i)=>i!==idx); setFormData(prev=>({...prev, products:np})); };
            const handleFileUpload = async (evt) => {
                const files = Array.from(evt.target.files);
                if (files.length === 0) return;
                setUploading(true);
                if (!canUpload()) { alert(TEXT.PERMISSION_DENIED); setUploading(false); return; }

                try {
                    const newAttachments = [];
                    for (const file of files) {
                        const ref = storage.ref('docs/' + Date.now() + '_' + file.name);
                        await ref.put(file);
                        const url = await ref.getDownloadURL();
                        newAttachments.push({ name: file.name, url: url, path: ref.fullPath });
                    }
                    setFormData(prev => ({ ...prev, attachments: [...(prev.attachments||[]), ...newAttachments] }));
                } catch (error) { alert(TEXT.UPLOAD_FAILED + ": " + error.message); } finally { setUploading(false); evt.target.value = ''; }
            };
            const handleDeleteFile = async (index) => { 
                if(!confirm(TEXT.CONFIRM_DELETE_FILE)) return;
                if (!canUpload()) return alert(TEXT.PERMISSION_DENIED);
                const target = formData.attachments[index];
                if (target.path && storage) { try { await storage.ref(target.path).delete(); } catch (error) { console.warn(error); } }
                const newAttachments = formData.attachments.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, attachments: newAttachments }));
            };

            // Auth & DB Effects
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none', 300); }
                if (!auth) return;
                const unsub = auth.onAuthStateChanged(u => { setUser(u); if(!u) setLoading(false); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('shipments').onSnapshot(s => {
                    const cleanData = s.docs.map(d => {
                        const dat = d.data();
                        return { id:d.id, ...dat, products: Array.isArray(dat.products) ? dat.products : [] };
                    }).sort((a,b)=>b.arrivalDate>a.arrivalDate?1:-1);
                    setShipments(cleanData);
                    setLoading(false);
                });
                
                // V73.0: ÂÆåÂÖ®Âæû Firestore ËÆÄÂèñËßíËâ≤Ë®≠ÂÆöÔºå‰∏çÂÜç‰ΩøÁî®Á°¨Á∑®Á¢ºÁöÑ ADMIN_EMAILS
                db.collection('settings').doc('config').get().then(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        const email = user.email;
                        
                        // ÂÑ™ÂÖàÊ™¢Êü• user_roles Â∞çÊáâ
                        if(d.user_roles && d.user_roles[email]) {
                            setUserRole(d.user_roles[email]);
                        }
                        // ÂÖ∂Ê¨°Ê™¢Êü• admin_emails Ê∏ÖÂñÆ
                        else if(d.admin_emails && d.admin_emails.includes(email)) {
                            setUserRole('MANAGER');
                        }
                        // Ëã•ÈÉΩÊ≤íÊúâË®≠ÂÆöÔºå‰øùÊåÅ GUEST
                    }
                    // Ëã• config Êñá‰ª∂‰∏çÂ≠òÂú®Ôºå‰øùÊåÅ GUESTÔºàÊõ¥ÂÆâÂÖ®ÁöÑÈ†êË®≠ÂÄºÔºâ
                }).catch(err => {
                    console.warn('ÁÑ°Ê≥ïËÆÄÂèñË®≠ÂÆö:', err);
                    // ÁôºÁîüÈåØË™§ÊôÇ‰øùÊåÅ GUEST ËßíËâ≤
                });
                
                return () => unsub();
            }, [user]);

            // V77.0: Áî¢ÂìÅ‰∏ªÊ™îÁõ£ËÅΩ + Ëá™ÂãïÂàùÂßãÂåñ
            useEffect(() => {
                if (!user || !db) return;
                
                // V77.0: È¶ñÊ¨°ËºâÂÖ•ÊôÇÊ™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂàùÂßãÂåñ
                const initializeIfEmpty = async () => {
                    try {
                        const snapshot = await db.collection('products').limit(1).get();
                        if (snapshot.empty && INITIAL_PRODUCTS_DATA.length > 0) {
                            console.log('Áî¢ÂìÅ‰∏ªÊ™îÁÇ∫Á©∫ÔºåÈñãÂßãÂàùÂßãÂåñ ' + INITIAL_PRODUCTS_DATA.length + ' Á≠ÜÁî¢ÂìÅ...');
                            const batchSize = 500;
                            for (let i = 0; i < INITIAL_PRODUCTS_DATA.length; i += batchSize) {
                                const batch = db.batch();
                                const chunk = INITIAL_PRODUCTS_DATA.slice(i, i + batchSize);
                                for (const p of chunk) {
                                    const docId = (p.productId + '_' + (p.spec || '')).replace(/[\/\\*?"<>|]/g, '_');
                                    batch.set(db.collection('products').doc(docId), { 
                                        ...p, 
                                        defaultPrice: 0,
                                        defaultSupplier: '',
                                        isActive: true,
                                        updatedAt: new Date().toISOString() 
                                    });
                                }
                                await batch.commit();
                            }
                            console.log('Áî¢ÂìÅ‰∏ªÊ™îÂàùÂßãÂåñÂÆåÊàêÔºÅ');
                        }
                    } catch (e) { 
                        console.warn('Áî¢ÂìÅ‰∏ªÊ™îÂàùÂßãÂåñÊ™¢Êü•Â§±Êïó:', e); 
                    }
                };
                
                initializeIfEmpty();
                
                const unsub = db.collection('products').orderBy('name').onSnapshot(s => {
                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    setProducts(data);
                }, err => {
                    console.warn('Áî¢ÂìÅ‰∏ªÊ™îËºâÂÖ•Â§±Êïó:', err);
                });
                return () => unsub();
            }, [user]);

            // Permissions
            const canManage = () => userRole === 'MANAGER';
            const canEdit = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole);
            const canCreate = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canDelete = () => ['MANAGER','PURCHASING'].includes(userRole); 
            const canUpload = () => ['MANAGER','PURCHASING','WAREHOUSE','QC'].includes(userRole); 
            const canSeePrice = () => ['MANAGER','PURCHASING','ACCOUNTING'].includes(userRole);
            const canEditFlightFee = () => userRole === 'MANAGER' || userRole === 'ACCOUNTING';
            const canEditDomesticFull = () => ['MANAGER','PURCHASING'].includes(userRole);
            const canEditForeignFinance = () => ['MANAGER', 'ACCOUNTING'].includes(userRole);
            const canEditWarehouseFields = () => ['MANAGER', 'PURCHASING', 'WAREHOUSE', 'QC'].includes(userRole);
            const canEditQCFields = () => ['MANAGER', 'QC'].includes(userRole);

            // Filter
            const todayStr = new Date().toISOString().split('T')[0];
            
            // V71.0: ÂÑ™ÂåñÊêúÂ∞ãÊïàËÉΩ - Âª∫Á´ãÊêúÂ∞ãÁ¥¢Âºï
            const searchableShipments = useMemo(() => {
                return shipments.map(s => ({
                    ...s,
                    _searchText: [
                        s.containerNumber,
                        s.supplier,
                        s.importCompany,
                        s.customsBroker,
                        s.origin,
                        s.customsDeclarationNo,
                        s.importPermitNo,
                        ...(s.products || []).flatMap(p => [p.name, p.spec, p.batchNumber])
                    ].filter(Boolean).join(' ').toLowerCase()
                }));
            }, [shipments]);

            const filteredList = useMemo(() => {
                let list = Array.isArray(searchableShipments) ? searchableShipments : [];
                
                // V71.0: ÂÑ™ÂåñÊêúÂ∞ã - ‰ΩøÁî®È†êÂª∫ÁöÑÊêúÂ∞ãÁ¥¢Âºï
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    list = list.filter(s => s._searchText.includes(term));
                }
                
                if(currentTab==='UNPAID') list=list.filter(s=>!s.isPaid);
                else if(currentTab==='DOMESTIC') list=list.filter(s=>isDomestic(s));
                else if(currentTab==='DEVANED') list=list.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr);
                else list=list.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr));
                
                return list.sort((a,b) => (currentTab==='DEVANED' ? (b.devanningDate>a.devanningDate?1:-1) : (a.arrivalDate>b.arrivalDate?1:-1)));
            }, [searchableShipments, searchTerm, currentTab]);
            
            // V79.4: ÊéíÂ∫èÂæåÁöÑÂàóË°®ÔºàÁî®ÊñºË≤°ÂãôÊ∏ÖÂñÆË°®Ê†ºÔºâ
            const sortedFilteredList = useMemo(() => {
                if (!filteredList || !Array.isArray(filteredList)) return [];
                const list = [...filteredList];
                list.sort((a, b) => {
                    let valA, valB;
                    switch (sortField) {
                        case 'arrivalDate':
                            valA = a.arrivalDate || '';
                            valB = b.arrivalDate || '';
                            break;
                        case 'importCompany':
                            valA = a.importCompany || '';
                            valB = b.importCompany || '';
                            break;
                        case 'vendorSeqNo':
                            valA = a.vendorSeqNo || '';
                            valB = b.vendorSeqNo || '';
                            break;
                        case 'containerNumber':
                            valA = a.containerNumber || '';
                            valB = b.containerNumber || '';
                            break;
                        case 'supplier':
                            valA = a.supplier || '';
                            valB = b.supplier || '';
                            break;
                        case 'totalQuantity':
                            valA = (a.products || []).reduce((s, p) => s + (Number(p.quantity)||0), 0);
                            valB = (b.products || []).reduce((s, p) => s + (Number(p.quantity)||0), 0);
                            break;
                        case 'totalWeight':
                            valA = (a.products || []).reduce((s, p) => s + (Number(p.weight)||0), 0);
                            valB = (b.products || []).reduce((s, p) => s + (Number(p.weight)||0), 0);
                            break;
                        case 'totalAmount':
                            valA = (a.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                            valB = (b.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                            break;
                        default:
                            valA = a[sortField] || '';
                            valB = b[sortField] || '';
                    }
                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                return list;
            }, [filteredList, sortField, sortOrder]);
            
            // V71.0: ÂÑ™ÂåñÊÄ•‰ª∂Ë®àÁÆó - Âêà‰Ωµ urgentCount Âíå urgentListÔºåÈÅøÂÖçÈáçË§áÈÅçÊ≠∑
            const { urgentCount, urgentList } = useMemo(() => {
                const todayParsed = parseDate(todayStr);
                const list = shipments.filter(s => {
                    if (!s.arrivalDate) return false;
                    const diff = Math.round((parseDate(s.arrivalDate) - todayParsed) / 86400000);
                    return diff >= 0 && diff <= 3;
                }).sort((a, b) => a.arrivalDate > b.arrivalDate ? 1 : -1);
                return { urgentCount: list.length, urgentList: list };
            }, [shipments]);
            
            const unpaidCount = useMemo(() => shipments.filter(s => !s.isPaid).length, [shipments]);

            if(loading) return <div className="flex h-screen items-center justify-center text-gray-500">Loading...</div>;
            if(!user) return <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4"><div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full"><div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl"><I.Ship /></div><h1 className="text-2xl font-bold mb-8">{TEXT.LOGIN_TITLE}</h1><button onClick={handleAdminLogin} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow mb-3 flex justify-center gap-2"><I.Google /> {TEXT.LOGIN_STAFF}</button><button onClick={handleGuestLogin} className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold flex justify-center gap-2"><I.User /> {TEXT.LOGIN_GUEST}</button></div></div>;

            return (
                <ErrorBoundary>
                <div className="min-h-screen bg-slate-100 pb-20 md:pb-0 md:pl-64">
                    {/* V70.0: Validation Toast */}
                    {showValidationToast && <div className="validation-toast">{validationMessage}</div>}
                    
                    {/* V79.0: Êô∫ËÉΩÂåØÂÖ•ÈÅ∏ÊìáÂô® Modal */}
                    {showImportSelector && (
                        <div className="modal-overlay" onClick={() => !isParsing && handleCloseImportSelector()}>
                            <div className="modal-content" style={{maxWidth: '480px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 className="font-bold text-xl text-gray-800">Êñ∞Â¢ûË≤®Ê´É</h3>
                                    {!isParsing && <button onClick={handleCloseImportSelector} className="p-1 hover:bg-gray-100 rounded-full"><I.X /></button>}
                                </div>
                                
                                <p className="text-gray-500 text-sm mb-4">Ë´ãÈÅ∏ÊìáÂª∫Á´ãÊñπÂºè</p>
                                
                                {/* AI ÁãÄÊÖãÊèêÁ§∫ */}
                                {geminiApiKey ? (
                                    <div className="mb-4 p-2 bg-green-50 rounded-lg border border-green-200 text-xs text-green-700 flex items-center gap-2">
                                        <I.Check /> AI Êô∫ËÉΩËß£ÊûêÂ∑≤ÂïüÁî®
                                    </div>
                                ) : (
                                    <div className="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 text-sm text-yellow-700">
                                        <div className="flex items-center gap-2 font-bold mb-1">
                                            <I.AlertCircle /> Â∞öÊú™Ë®≠ÂÆö AI ÂäüËÉΩ
                                        </div>
                                        <div className="text-xs">
                                            ‰∏äÂÇ≥Êñá‰ª∂ÂæåÊúÉÈ°ØÁ§∫ÊñáÂ≠óÂÖßÂÆπ‰æõÂèÉËÄÉÔºå
                                            <button onClick={() => {handleCloseImportSelector(); setTempApiKey(''); setShowApiKeyModal(true);}} className="text-blue-600 underline ml-1">Ë®≠ÂÆö API Key</button> ÂèØÂïüÁî®Ëá™ÂãïÂ°´ÂÖ•
                                        </div>
                                    </div>
                                )}
                                
                                <div className="space-y-3">
                                    {/* ÊâãÂãïÂ°´ÂØ´ */}
                                    <div className="import-method-card" onClick={handleManualEntry} style={{flexDirection: 'row', padding: '16px 20px'}}>
                                        <div className="import-method-icon" style={{width: '44px', height: '44px', background: 'var(--color-primary)'}}>
                                            <I.FormInput />
                                        </div>
                                        <div style={{flex: 1, textAlign: 'left', marginLeft: '16px'}}>
                                            <div className="import-method-title">ÊâãÂãïÂ°´ÂØ´</div>
                                            <div className="import-method-desc" style={{textAlign: 'left'}}>ÈÄêÊ≠•Â°´ÂØ´Ë≤®Ê´ÉË≥áË®ä</div>
                                        </div>
                                        <I.ChevronRight />
                                    </div>
                                    
                                    {/* ‰∏äÂÇ≥Êñá‰ª∂ */}
                                    <label className="import-method-card" style={{flexDirection: 'row', padding: '16px 20px', cursor: isParsing ? 'wait' : 'pointer'}}>
                                        <div className="import-method-icon" style={{width: '44px', height: '44px', background: 'var(--color-success)'}}>
                                            {isParsing ? <div className="spinner" style={{width: '24px', height: '24px', borderWidth: '2px', borderTopColor: 'white'}}></div> : <I.FileText />}
                                        </div>
                                        <div style={{flex: 1, textAlign: 'left', marginLeft: '16px'}}>
                                            <div className="import-method-title">{isParsing ? 'Ëß£Êûê‰∏≠...' : '‰∏äÂÇ≥Â†±ÈóúÊñá‰ª∂'}</div>
                                            <div className="import-method-desc" style={{textAlign: 'left'}}>
                                                {isParsing ? parseProgress : (geminiApiKey ? 'AI Ëá™ÂãïËß£Êûê‰∏¶Â°´ÂÖ•Ë°®ÂñÆ' : '‰∏äÂÇ≥ÂæåÂèØÂèÉËÄÉÊñáÂ≠óÂÖßÂÆπÂ°´ÂØ´')}
                                            </div>
                                        </div>
                                        {!isParsing && <I.ChevronRight />}
                                        <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handlePdfUpload} className="hidden" disabled={isParsing} />
                                    </label>
                                </div>
                                
                                <div className="mt-6 p-3 bg-gray-50 rounded-lg border">
                                    <div className="text-xs font-bold text-gray-500 mb-2">ÊîØÊè¥ÁöÑÊñá‰ª∂È°ûÂûãÔºàPDF / ExcelÔºâ</div>
                                    <div className="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div className="flex items-center gap-2"><span>üìÑ</span> Commercial Invoice</div>
                                        <div className="flex items-center gap-2"><span>üì¶</span> Packing List</div>
                                        <div className="flex items-center gap-2"><span>üö¢</span> Bill of Lading</div>
                                        <div className="flex items-center gap-2"><span>üì¨</span> Âà∞Ë≤®ÈÄöÁü•</div>
                                        <div className="flex items-center gap-2"><span>üìã</span> ÊâπËôüÊïàÊúüÊ∏ÖÂñÆ</div>
                                        <div className="flex items-center gap-2"><span>üìä</span> Excel ÊïàÊúüË°®</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* V79.0: AI Ëß£ÊûêÈ†êË¶ΩÁ¢∫Ë™ç Modal */}
                    {showAiPreview && aiExtractedData && (
                        <div className="modal-overlay" onClick={() => {}}>
                            <div className="modal-content" style={{maxWidth: '600px', maxHeight: '90vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <div>
                                        <h3 className="font-bold text-xl text-gray-800">AI Ëß£ÊûêÁµêÊûú</h3>
                                        <p className="text-sm text-gray-500 mt-1">Ë´ãÁ¢∫Ë™ç‰ª•‰∏ãË≥áÊñôÊòØÂê¶Ê≠£Á¢∫</p>
                                    </div>
                                </div>
                                
                                {/* Â∑≤Ë≠òÂà•ÁöÑÊñá‰ª∂ */}
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {parsedDocuments.map(doc => (
                                        <span key={doc.id} className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs ${doc.isScanned ? 'bg-blue-100 text-blue-700' : 'bg-gray-100'}`}>
                                            {doc.icon} {doc.label}
                                        </span>
                                    ))}
                                </div>
                                
                                {/* Ë°ùÁ™ÅÊèêÁ§∫ */}
                                {Object.keys(fieldConflicts).length > 0 && (
                                    <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-xl">
                                        <div className="flex items-center gap-2 text-yellow-700 font-bold text-sm mb-2">
                                            <I.AlertCircle /> ÁôºÁèæË≥áÊñôË°ùÁ™ÅÔºåË´ãÈÅ∏ÊìáÊ≠£Á¢∫ÁöÑÂÄº
                                        </div>
                                        {Object.entries(fieldConflicts).map(([field, options]) => (
                                            <div key={field} className="mt-2 p-2 bg-white rounded border">
                                                <div className="text-xs text-gray-500 mb-2">{field === 'containerNumber' ? 'Ê´ÉËôü' : field === 'arrivalDate' ? 'Âà∞Ê∏ØÊó•' : field}</div>
                                                <div className="flex flex-wrap gap-2">
                                                    {options.map((opt, idx) => (
                                                        <button key={idx} type="button" onClick={() => selectFieldValue(field, opt.value, opt.source)}
                                                            className={`px-3 py-1.5 rounded-lg text-sm border ${fieldSources[field]?.value === opt.value ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`}>
                                                            <span className="font-medium">{opt.value}</span>
                                                            <span className="text-xs text-gray-400 ml-1">({opt.source})</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* ÈáçË§áÊ´ÉËôüË≠¶Âëä */}
                                {duplicateContainer && (
                                    <div className="mb-4 p-3 bg-red-50 border border-red-300 rounded-xl">
                                        <div className="flex items-center gap-2 text-red-700 font-bold text-sm mb-1">
                                            <I.AlertCircle /> ‚ö†Ô∏è Ê´ÉËôüÂ∑≤Â≠òÂú®ÔºÅ
                                        </div>
                                        <div className="text-sm text-red-600">
                                            Ê´ÉËôü <span className="font-bold">{duplicateContainer.containerNo}</span> Â∑≤ÊúâË®òÈåÑ
                                        </div>
                                        <div className="text-xs text-red-500 mt-1">
                                            Âà∞Ê∏ØÊó•: {duplicateContainer.existingArrivalDate || '-'}Ôºå
                                            Âª†ÂïÜ: {duplicateContainer.existingSupplier || '-'}
                                        </div>
                                        <div className="text-xs text-gray-600 mt-2 p-2 bg-white rounded border border-red-200">
                                            üí° Â¶ÇÈúÄÁ∑®ËºØÁèæÊúâË®òÈåÑÔºåË´ãÂæûÂàóË°®‰∏≠ÊâæÂà∞Ë©≤Ë≤®Ê´ÉÈÄ≤Ë°å‰øÆÊîπ
                                        </div>
                                    </div>
                                )}
                                
                                {/* Áº∫Â∞ëÊ¨Ñ‰ΩçÊèêÁ§∫ */}
                                {(!aiExtractedData?.containerNumber || !aiExtractedData?.arrivalDate) && (
                                    <div className="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-xl">
                                        <div className="flex items-center gap-2 text-orange-700 font-bold text-sm mb-1">
                                            <I.AlertCircle /> ÈÉ®ÂàÜÊ¨Ñ‰ΩçÊú™Ëß£Êûê
                                        </div>
                                        <div className="text-xs text-orange-600">
                                            {!aiExtractedData?.containerNumber && <span className="mr-2">‚Ä¢ Ê´ÉËôüÔºàÂª∫Ë≠∞Ë£úÂÖÖ B/L Êàñ Packing ListÔºâ</span>}
                                            {!aiExtractedData?.arrivalDate && <span>‚Ä¢ Âà∞Ê∏ØÊó•</span>}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">ÊÇ®ÂèØ‰ª•Âú®‰∏ã‰∏ÄÊ≠•ÊâãÂãïÂ°´ÂØ´ÈÄô‰∫õÊ¨Ñ‰Ωç</div>
                                    </div>
                                )}
                                
                                {/* Ëß£ÊûêÁµêÊûúÈ†êË¶Ω */}
                                <div className="space-y-3 max-h-[45vh] overflow-y-auto pr-2">
                                    {/* Âü∫Êú¨Ë≥áË®ä */}
                                    <div className="p-3 bg-gray-50 rounded-xl">
                                        <div className="font-bold text-sm text-gray-700 mb-3">Âü∫Êú¨Ë≥áË®ä</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            {[
                                                { key: 'containerNumber', label: 'Ê´ÉËôü' },
                                                { key: 'billOfLading', label: 'ÊèêÂñÆËôüÁ¢º' },
                                                { key: 'arrivalDate', label: 'Âà∞Ê∏ØÊó•' },
                                                { key: 'supplier', label: 'Âª†ÂïÜ' },
                                                { key: 'origin', label: 'Áî¢Âú∞' },
                                                { key: 'importCompany', label: 'ÈÄ≤Âè£ÂÖ¨Âè∏' },
                                                { key: 'shippingCompany', label: 'ËàπÂÖ¨Âè∏' },
                                                { key: 'devanningLocation', label: 'ÊãÜÊ´ÉÂú∞' }
                                            ].map(({ key, label }) => (
                                                <div key={key} className={`p-2 rounded-lg border ${fieldSources[key] ? getConfidenceColor(fieldSources[key].confidence) : 'bg-gray-100 border-dashed border-gray-300'}`}>
                                                    <div className="text-xs text-gray-500 flex justify-between">
                                                        <span>{label}</span>
                                                        {fieldSources[key] && <span className="text-[10px]">{fieldSources[key].source}</span>}
                                                    </div>
                                                    <div className={`font-bold text-sm mt-1 ${!fieldSources[key]?.value ? 'text-gray-400' : ''}`}>
                                                        {fieldSources[key]?.value || 'ÔºàÂæÖÂ°´ÂØ´Ôºâ'}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Áî¢ÂìÅÊòéÁ¥∞ */}
                                    {fieldSources.products && fieldSources.products.value.length > 0 && (
                                        <div className="p-3 bg-gray-50 rounded-xl">
                                            <div className="font-bold text-sm text-gray-700 mb-3">
                                                Áî¢ÂìÅÊòéÁ¥∞ ({fieldSources.products.value.length} È†Ö) 
                                                <span className="font-normal text-gray-400 ml-2">- Ë´ãÈÅ∏ÊìáÂ∞çÊáâÁöÑ ERP ÂìÅÂêç</span>
                                            </div>
                                            <div className="space-y-3">
                                                {fieldSources.products.value.map((p, idx) => (
                                                    <div key={idx} className="p-3 bg-white rounded-lg border text-sm">
                                                        {/* ÂéüÂßãË≥áË®äÔºàÂìÅÂêç + Ë¶èÊ†ºÔºâ */}
                                                        <div className="mb-2 pb-2 border-b border-gray-100">
                                                            <div className="flex items-start justify-between gap-2">
                                                                <div className="flex-1">
                                                                    <div className="text-xs text-gray-400 mb-1">üìÑ Êñá‰ª∂ÂìÅÂêç</div>
                                                                    <div className="font-bold text-gray-800">{p.originalText || p.name || '-'}</div>
                                                                </div>
                                                                {p.spec && (
                                                                    <div className="text-right">
                                                                        <div className="text-xs text-gray-400 mb-1">Ë¶èÊ†º</div>
                                                                        <div className="font-bold text-orange-600 text-base">{p.spec}</div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* ÂìÅÂêçÈÅ∏Êìá */}
                                                        <div 
                                                            onClick={() => { 
                                                                if(products.length > 0) { 
                                                                    setActiveProductPicker({type: 'aiPreview', index: idx}); 
                                                                    // È†êÂ°´ AI Ëß£ÊûêÁöÑÂìÅÂêç‰ΩúÁÇ∫ÊêúÂ∞ãÈóúÈçµÂ≠ó
                                                                    const searchHint = p.name || p.originalText || '';
                                                                    // Âèñ‰∏≠ÊñáÂìÅÂêçÁöÑÂâçÂπæÂÄãÂ≠óÔºåÊàñËã±ÊñáÁöÑÁ¨¨‰∏ÄÂÄãÂñÆÂ≠ó
                                                                    const keyword = searchHint.includes(' ') 
                                                                        ? searchHint.split(' ')[0] 
                                                                        : searchHint.substring(0, 4);
                                                                    setProductPickerSearch(keyword);
                                                                } 
                                                            }} 
                                                            className="p-2 bg-blue-50 rounded-lg border-2 border-dashed border-blue-200 cursor-pointer hover:bg-blue-100 flex items-center justify-between"
                                                        >
                                                            <span className={p.selectedName ? 'font-bold text-gray-800' : 'text-blue-600'}>
                                                                {p.selectedName || 'ÈªûÊìäÈÅ∏Êìá ERP ÂìÅÂêç ‚ñº'}
                                                            </span>
                                                            {p.selectedName && <span className="text-green-500 text-xs">‚úì Â∑≤ÈÅ∏Êìá</span>}
                                                        </div>
                                                        
                                                        {/* Êï∏ÊìöÈ°ØÁ§∫ */}
                                                        <div className="flex flex-wrap gap-3 mt-2 text-xs">
                                                            <span className="text-blue-600 font-bold">‰ª∂Êï∏: {p.quantity?.toLocaleString()}</span>
                                                            <span className="text-orange-500 font-bold">ÈáçÈáè: {p.weight?.toLocaleString()} kg</span>
                                                            {p.unitPrice > 0 && <span className="text-green-600 font-bold">ÂñÆÂÉπ: ${p.unitPrice}</span>}
                                                            {p.batchNumber && <span className="text-purple-600">ÊâπËôü: {p.batchNumber}</span>}
                                                            {p.expiryDate && <span className="text-red-500">ÊïàÊúü: {p.expiryDate}</span>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {/* Êú™ÈÅ∏ÊìáÂìÅÂêçÊèêÁ§∫ */}
                                            {fieldSources.products.value.some(p => !p.selectedName) && (
                                                <div className="mt-3 p-2 bg-yellow-50 rounded-lg border border-yellow-200 text-xs text-yellow-700 flex items-center gap-2">
                                                    <I.AlertCircle /> Ë´ãÁÇ∫ÊØèÂÄãÁî¢ÂìÅÈÅ∏ÊìáÂ∞çÊáâÁöÑ ERP ÂìÅÂêç
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Êìç‰ΩúÊåâÈàï */}
                                <div className="flex gap-3 mt-4 pt-4 border-t">
                                    <button type="button" onClick={cancelAiExtraction} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">
                                        {duplicateContainer ? 'ÂèñÊ∂à' : 'ÊîπÁî®ÊâãÂãïÂ°´ÂØ´'}
                                    </button>
                                    {duplicateContainer ? (
                                        <button type="button" onClick={() => {
                                            if (confirm('Ê≠§Ê´ÉËôüÂ∑≤Â≠òÂú®ÔºåÁ¢∫ÂÆöË¶ÅÂª∫Á´ãÊñ∞Ë®òÈåÑÂóéÔºü\n\nÈÄôÂèØËÉΩÊúÉÈÄ†ÊàêÈáçË§áË≥áÊñô„ÄÇ')) {
                                                confirmAiExtraction();
                                            }
                                        }} className="flex-1 py-3 bg-orange-500 text-white rounded-xl font-bold shadow-lg">
                                            ‰ªçË¶ÅÂª∫Á´ãÊñ∞Ë®òÈåÑ
                                        </button>
                                    ) : (
                                        <button type="button" onClick={confirmAiExtraction} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">
                                            Á¢∫Ë™ç‰∏¶Â°´ÂÖ•Ë°®ÂñÆ
                                        </button>
                                    )}
                                </div>
                                
                                <div className="mt-3 text-center text-xs text-gray-400">
                                    Â°´ÂÖ•ÂæåÊÇ®‰ªçÂèØÂú®Ë°®ÂñÆ‰∏≠‰øÆÊîπ‰ªª‰ΩïÊ¨Ñ‰Ωç
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* AI ËôïÁêÜ‰∏≠ÊèêÁ§∫ */}
                    {isAiProcessing && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '320px', textAlign: 'center'}}>
                                <div className="spinner mx-auto mb-4" style={{width: '48px', height: '48px'}}></div>
                                <div className="font-bold text-lg text-gray-800 mb-2">AI Ê≠£Âú®ÂàÜÊûêÊñá‰ª∂</div>
                                <div className="text-sm text-gray-500">{parseProgress || 'Ë´ãÁ®çÂÄô...'}</div>
                            </div>
                        </div>
                    )}
                    
                    {/* V79.0: Gemini API Key Ë®≠ÂÆö Modal */}
                    {showApiKeyModal && (
                        <div className="modal-overlay" onClick={() => setShowApiKeyModal(false)}>
                            <div className="modal-content" style={{maxWidth: '450px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 className="font-bold text-xl text-gray-800">Ë®≠ÂÆö AI Ëß£ÊûêÂäüËÉΩ</h3>
                                    <button onClick={() => setShowApiKeyModal(false)} className="p-1 hover:bg-gray-100 rounded-full"><I.X /></button>
                                </div>
                                
                                <div className="mb-4 p-3 bg-blue-50 rounded-xl border border-blue-200">
                                    <div className="text-sm text-blue-800">
                                        <strong>Â¶Ç‰ΩïÂèñÂæó API KeyÔºü</strong>
                                        <ol className="mt-2 ml-4 list-decimal space-y-1 text-blue-700">
                                            <li>ÂâçÂæÄ <a href="https://aistudio.google.com/apikey" target="_blank" className="underline font-bold">Google AI Studio</a></li>
                                            <li>‰ΩøÁî® Google Â∏≥ËôüÁôªÂÖ•</li>
                                            <li>ÈªûÊìä„ÄåCreate API Key„Äç</li>
                                            <li>Ë§áË£ΩÁî¢ÁîüÁöÑ Key Ë≤ºÂà∞‰∏ãÊñπ</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="form-label-lg">Gemini API Key</label>
                                    <input 
                                        type="password" 
                                        value={tempApiKey} 
                                        onChange={e => setTempApiKey(e.target.value)}
                                        className="form-input-lg font-mono"
                                        placeholder="AIzaSy..."
                                    />
                                    <div className="text-xs text-gray-400 mt-2">
                                        API Key ÊúÉÂÑ≤Â≠òÂú®ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏≠Ôºå‰∏çÊúÉ‰∏äÂÇ≥Âà∞‰º∫ÊúçÂô®
                                    </div>
                                </div>
                                
                                {geminiApiKey && (
                                    <div className="mb-4 p-2 bg-green-50 rounded-lg border border-green-200 text-sm text-green-700 flex items-center gap-2">
                                        <I.Check /> Â∑≤Ë®≠ÂÆö API Key
                                    </div>
                                )}
                                
                                {/* V79.1: ÊâπËôüËôïÁêÜÊ®°ÂºèË®≠ÂÆö */}
                                <div className="mb-4 p-3 bg-gray-50 rounded-xl border">
                                    <div className="text-sm font-bold text-gray-700 mb-2">ÊâπËôüËôïÁêÜÊ®°Âºè</div>
                                    <div className="space-y-2">
                                        <label className="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
                                            <input 
                                                type="radio" 
                                                name="batchMode" 
                                                checked={batchMergeMode === 'merge'} 
                                                onChange={() => saveBatchMergeMode('merge')}
                                                className="mt-1"
                                            />
                                            <div>
                                                <div className="font-medium text-gray-800">Âêà‰ΩµÊ®°ÂºèÔºàÂª∫Ë≠∞Ôºâ</div>
                                                <div className="text-xs text-gray-500">ÂêåÂìÅÂêç+ÂêåË¶èÊ†ºÂêà‰ΩµÔºåÂèñÊúÄÊó©ÊïàÊúü</div>
                                            </div>
                                        </label>
                                        <label className="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
                                            <input 
                                                type="radio" 
                                                name="batchMode" 
                                                checked={batchMergeMode === 'split'} 
                                                onChange={() => saveBatchMergeMode('split')}
                                                className="mt-1"
                                            />
                                            <div>
                                                <div className="font-medium text-gray-800">ÊãÜÂàÜÊ®°Âºè</div>
                                                <div className="text-xs text-gray-500">ÊØèÂÄãÊâπËôüÁç®Á´ã‰∏ÄÁ≠ÜË®òÈåÑ</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3">
                                    <button 
                                        type="button" 
                                        onClick={() => setShowApiKeyModal(false)} 
                                        className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold"
                                    >
                                        ÂèñÊ∂à
                                    </button>
                                    <button 
                                        type="button" 
                                        onClick={() => {
                                            if (tempApiKey.trim()) {
                                                saveApiKey(tempApiKey.trim());
                                                // Â¶ÇÊûúÊúâÂæÖËôïÁêÜÁöÑÊñá‰ª∂ÔºåÁπºÁ∫åËôïÁêÜ
                                                if (parsedDocuments.length > 0) {
                                                    processWithAI(parsedDocuments).catch(e => console.error('AI ËôïÁêÜÈåØË™§:', e));
                                                }
                                            } else {
                                                alert('Ë´ãËº∏ÂÖ• API Key');
                                            }
                                        }} 
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        ÂÑ≤Â≠ò
                                    </button>
                                </div>
                                
                                {geminiApiKey && (
                                    <button 
                                        type="button" 
                                        onClick={() => {
                                            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ API Key ÂóéÔºü')) {
                                                localStorage.removeItem('gemini_api_key');
                                                setGeminiApiKey('');
                                                setTempApiKey('');
                                            }
                                        }}
                                        className="w-full mt-3 py-2 text-red-500 text-sm font-bold"
                                    >
                                        Ê∏ÖÈô§Â∑≤ÂÑ≤Â≠òÁöÑ API Key
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Notification Modal */}
                    {showNotifications && (
                        <div className="modal-overlay" onClick={()=>setShowNotifications(false)}>
                            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">{TEXT.URGENT_TITLE} ({urgentCount})</h3><button onClick={()=>setShowNotifications(false)}><I.X /></button></div>
                                {urgentList.length===0 ? <div className="text-center text-gray-400 py-4">{TEXT.NO_URGENT}</div> : urgentList.map(s=>(
                                    <div key={s.id} className="mb-3 p-3 bg-red-50 rounded-lg border border-red-100 cursor-pointer" onClick={()=>{
                                        setShowNotifications(false); 
                                        setSearchTerm(s.containerNumber); // ÊêúÂ∞ãË©≤Ê´ÉËôü
                                        setCurrentTab('NOT_DEVANED'); // ÂàáÂà∞Êú™ÊãÜÊ´É
                                        setView('list'); // Á¢∫‰øùÂú®ÂàóË°®È†Å
                                    }}>
                                        <div className="flex justify-between font-bold text-sm text-gray-800"><span>{s.containerNumber}</span><span className="text-red-600">{s.arrivalDate}</span></div>
                                        <div className="text-xs text-gray-500 mt-1">{s.supplier}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* File List Modal */}
                    {showFileModal && (
                        <div className="modal-overlay" onClick={()=>setShowFileModal(false)}>
                            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">{TEXT.FILE_LIST_TITLE} ({fileList.length})</h3><button onClick={()=>setShowFileModal(false)}><I.X /></button></div>
                                <div className="space-y-2">
                                    {fileList.map((f, i) => (
                                        <a key={i} href={f.url} target="_blank" className="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-blue-50 border border-gray-200 text-blue-600 group">
                                            <span className="truncate font-bold text-sm mr-2">{f.name}</span>
                                            <span className="text-gray-400 group-hover:text-blue-600"><I.Download /></span>
                                        </a>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V74.0: Excel Import Modal */}
                    {showImportModal && (
                        <div className="modal-overlay" onClick={() => !importProcessing && setShowImportModal(false)}>
                            <div className="modal-content" style={{maxWidth: '600px', maxHeight: '85vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">{TEXT.IMPORT_TITLE}</h3>
                                    {!importProcessing && <button onClick={() => setShowImportModal(false)}><I.X /></button>}
                                </div>
                                
                                <div className="text-sm text-gray-500 mb-3">
                                    {TEXT.IMPORT_ROW_COUNT.replace('{count}', importData.length)}
                                    <span className="ml-2 text-orange-500">{TEXT.IMPORT_UPDATE_HINT}</span>
                                </div>
                                
                                {/* È†êË¶ΩË°®Ê†º */}
                                <div className="overflow-x-auto mb-4 border rounded-lg" style={{maxHeight: '300px'}}>
                                    <table className="w-full text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-2 py-2 text-left">#</th>
                                                <th className="px-2 py-2 text-left">Âª†ÂïÜ</th>
                                                <th className="px-2 py-2 text-left">ÂìÅÂêç</th>
                                                <th className="px-2 py-2 text-left">Ë¶èÊ†º</th>
                                                <th className="px-2 py-2 text-right">ÂñÆÂÉπ</th>
                                                <th className="px-2 py-2 text-right">Êï∏Èáè</th>
                                                <th className="px-2 py-2 text-right">ÈáçÈáè</th>
                                                <th className="px-2 py-2 text-left">Êó•Êúü</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {importData.slice(0, 50).map((item, idx) => (
                                                <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="px-2 py-1.5 text-gray-400">{item._rowIndex}</td>
                                                    <td className="px-2 py-1.5 font-medium">{item.supplier || '-'}</td>
                                                    <td className="px-2 py-1.5">{item.productName || '-'}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.spec || '-'}</td>
                                                    <td className="px-2 py-1.5 text-right text-emerald-600">{item.unitPrice || 0}</td>
                                                    <td className="px-2 py-1.5 text-right text-blue-600">{item.quantity || 0}</td>
                                                    <td className="px-2 py-1.5 text-right text-orange-500">{item.weight || 0}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.arrivalDate || '-'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {importData.length > 50 && (
                                        <div className="text-center py-2 text-gray-400 text-xs bg-gray-50">
                                            ... ÈÇÑÊúâ {importData.length - 50} Á≠ÜË≥áÊñôÊú™È°ØÁ§∫
                                        </div>
                                    )}
                                </div>
                                
                                {/* ÈÄ≤Â∫¶Ê¢ù */}
                                {importProcessing && (
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{TEXT.IMPORT_PROCESSING}</span>
                                            <span>{importProgress.current} / {importProgress.total}</span>
                                        </div>
                                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-300"
                                                style={{width: `${(importProgress.current / importProgress.total) * 100}%`}}
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {/* ÊåâÈàï */}
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowImportModal(false)} 
                                        disabled={importProcessing}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {TEXT.IMPORT_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleConfirmImport} 
                                        disabled={importProcessing || importData.length === 0}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {importProcessing ? TEXT.IMPORT_PROCESSING : TEXT.IMPORT_CONFIRM}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V75.0: Áî¢ÂìÅÁ∑®ËºØ/Êñ∞Â¢û Modal */}
                    {showProductModal && editingProduct && (
                        <div className="modal-overlay" onClick={() => setShowProductModal(false)}>
                            <div className="modal-content" style={{maxWidth: '500px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">
                                        {editingProduct.id ? TEXT.PRODUCTS_EDIT_TITLE : TEXT.PRODUCTS_ADD_TITLE}
                                    </h3>
                                    <button onClick={() => setShowProductModal(false)}><I.X /></button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_ID} *</label>
                                            <input 
                                                type="text"
                                                value={editingProduct.productId || ''}
                                                onChange={e => setEditingProduct(p => ({...p, productId: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5 font-mono"
                                                placeholder="A09134S20P"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_NAME} *</label>
                                            <input 
                                                type="text"
                                                value={editingProduct.name || ''}
                                                onChange={e => setEditingProduct(p => ({...p, name: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5"
                                                placeholder="ÂìÅÂêç"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_SPEC}</label>
                                        <input 
                                            type="text"
                                            value={editingProduct.spec || ''}
                                            onChange={e => setEditingProduct(p => ({...p, spec: e.target.value}))}
                                            className="w-full border rounded-lg p-2.5"
                                            placeholder="36/40S*420G*20ÂåÖ(IQ10%)"
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_UNIT}</label>
                                            <select 
                                                value={editingProduct.unit || 'ÂåÖ'}
                                                onChange={e => setEditingProduct(p => ({...p, unit: e.target.value}))}
                                                className="w-full border rounded-lg p-2.5"
                                            >
                                                {PRODUCT_UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_DEFAULT_PRICE}</label>
                                            <input 
                                                type="number"
                                                value={editingProduct.defaultPrice || ''}
                                                onChange={e => setEditingProduct(p => ({...p, defaultPrice: safeNum(e.target.value)}))}
                                                className="w-full border rounded-lg p-2.5 text-right"
                                                placeholder="0"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">{TEXT.PRODUCT_DEFAULT_SUPPLIER}</label>
                                        <input 
                                            type="text"
                                            value={editingProduct.defaultSupplier || ''}
                                            onChange={e => setEditingProduct(p => ({...p, defaultSupplier: e.target.value}))}
                                            className="w-full border rounded-lg p-2.5"
                                            placeholder="È†êË®≠‰æõÊáâÂïÜ"
                                        />
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                        <input 
                                            type="checkbox"
                                            id="productIsActive"
                                            checked={editingProduct.isActive !== false}
                                            onChange={e => setEditingProduct(p => ({...p, isActive: e.target.checked}))}
                                            className="w-4 h-4"
                                        />
                                        <label htmlFor="productIsActive" className="text-sm text-gray-600">{TEXT.PRODUCT_IS_ACTIVE}</label>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => setShowProductModal(false)}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold"
                                    >
                                        {TEXT.BTN_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleSaveProduct}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        {TEXT.BTN_SAVE}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V75.0: Áî¢ÂìÅÂåØÂÖ• Modal */}
                    {showProductImportModal && (
                        <div className="modal-overlay" onClick={() => !importProcessing && setShowProductImportModal(false)}>
                            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '85vh'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-gray-800">{TEXT.PRODUCTS_IMPORT_TITLE}</h3>
                                    {!importProcessing && <button onClick={() => setShowProductImportModal(false)}><I.X /></button>}
                                </div>
                                
                                <div className="text-sm text-gray-500 mb-3">
                                    {TEXT.IMPORT_ROW_COUNT.replace('{count}', productImportData.length)}
                                    <span className="ml-2 text-orange-500">{TEXT.PRODUCTS_IMPORT_HINT}</span>
                                </div>
                                
                                {/* È†êË¶ΩË°®Ê†º */}
                                <div className="overflow-x-auto mb-4 border rounded-lg" style={{maxHeight: '350px'}}>
                                    <table className="w-full text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-2 py-2 text-left">ÂìÅËôü</th>
                                                <th className="px-2 py-2 text-left">ÂìÅÂêç</th>
                                                <th className="px-2 py-2 text-left">Ë¶èÊ†º</th>
                                                <th className="px-2 py-2 text-left">ÂñÆ‰Ωç</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {productImportData.slice(0, 100).map((item, idx) => (
                                                <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="px-2 py-1.5 font-mono text-gray-500">{item.productId}</td>
                                                    <td className="px-2 py-1.5 font-medium">{item.name}</td>
                                                    <td className="px-2 py-1.5 text-gray-600">{item.spec || '-'}</td>
                                                    <td className="px-2 py-1.5 text-gray-500">{item.unit}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {productImportData.length > 100 && (
                                        <div className="text-center py-2 text-gray-400 text-xs bg-gray-50">
                                            ... ÈÇÑÊúâ {productImportData.length - 100} Á≠ÜË≥áÊñôÊú™È°ØÁ§∫
                                        </div>
                                    )}
                                </div>
                                
                                {/* ÈÄ≤Â∫¶Ê¢ù */}
                                {importProcessing && (
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{TEXT.IMPORT_PROCESSING}</span>
                                            <span>{importProgress.current} / {importProgress.total}</span>
                                        </div>
                                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-300"
                                                style={{width: `${(importProgress.current / importProgress.total) * 100}%`}}
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {/* ÊåâÈàï */}
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowProductImportModal(false)} 
                                        disabled={importProcessing}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {TEXT.IMPORT_CANCEL}
                                    </button>
                                    <button 
                                        onClick={handleConfirmProductImport} 
                                        disabled={importProcessing || productImportData.length === 0}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {importProcessing ? TEXT.IMPORT_PROCESSING : TEXT.IMPORT_CONFIRM}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* V78.5: Áî¢ÂìÅÈÅ∏Êìá Bottom Sheet */}
                    {activeProductPicker !== null && products.length > 0 && (
                        <>
                            <div className="bottom-sheet-overlay" onClick={() => setActiveProductPicker(null)} />
                            <div className="bottom-sheet">
                                <div className="bottom-sheet-handle" onClick={() => setActiveProductPicker(null)} />
                                <div className="bottom-sheet-header">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-xl text-gray-800">ÈÅ∏Êìá ERP ÂìÅÂêç</h3>
                                        <button onClick={() => setActiveProductPicker(null)} className="p-2 text-gray-400 bg-gray-100 rounded-full"><I.X /></button>
                                    </div>
                                    
                                    {/* AI È†êË¶ΩÊ®°ÂºèÔºöÈ°ØÁ§∫ÂéüÂßãÊñá‰ª∂Ë≥áË®ä‰æõÂèÉËÄÉ */}
                                    {activeProductPicker?.type === 'aiPreview' && fieldSources?.products?.value?.[activeProductPicker.index] && (
                                        <div className="mb-3 p-3 bg-blue-50 rounded-xl border border-blue-200">
                                            <div className="text-xs text-blue-600 font-bold mb-2">üìÑ Êñá‰ª∂Ë≥áË®äÔºà‰æõÂèÉËÄÉÔºâ</div>
                                            <div className="space-y-1">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-gray-500 text-sm">ÂìÅÂêç:</span>
                                                    <span className="font-bold text-gray-800">{fieldSources.products.value[activeProductPicker.index].originalText || fieldSources.products.value[activeProductPicker.index].name || '-'}</span>
                                                </div>
                                                {fieldSources.products.value[activeProductPicker.index].spec && (
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-gray-500 text-sm">Ë¶èÊ†º:</span>
                                                        <span className="font-bold text-orange-600">{fieldSources.products.value[activeProductPicker.index].spec}</span>
                                                    </div>
                                                )}
                                                <div className="flex flex-wrap gap-3 text-sm mt-1">
                                                    <span className="text-blue-600">‰ª∂Êï∏: <b>{fieldSources.products.value[activeProductPicker.index].quantity?.toLocaleString()}</b></span>
                                                    <span className="text-orange-500">ÈáçÈáè: <b>{fieldSources.products.value[activeProductPicker.index].weight?.toLocaleString()} kg</b></span>
                                                    {fieldSources.products.value[activeProductPicker.index].unitPrice > 0 && (
                                                        <span className="text-green-600">ÂñÆÂÉπ: <b>${fieldSources.products.value[activeProductPicker.index].unitPrice}</b></span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <input 
                                        type="text"
                                        value={productPickerSearch}
                                        onChange={e => setProductPickerSearch(e.target.value)}
                                        placeholder="ÊêúÂ∞ãÂìÅËôü„ÄÅÂìÅÂêç„ÄÅË¶èÊ†º..."
                                        className="form-input-lg"
                                        autoFocus
                                    />
                                </div>
                                <div className="bottom-sheet-content">
                                    {pickerFilteredProducts.length === 0 ? (
                                        <div className="p-8 text-center text-gray-400 text-lg">ÁÑ°Á¨¶ÂêàÁöÑÁî¢ÂìÅ</div>
                                    ) : (
                                        pickerFilteredProducts.map(prod => (
                                            <div 
                                                key={prod.id}
                                                onClick={() => handleSelectProduct(activeProductPicker, prod)}
                                                className="product-item-lg"
                                            >
                                                <div className="name">{prod.name}</div>
                                                <div className="flex justify-between items-center">
                                                    <span className="spec">{prod.spec || 'ÁÑ°Ë¶èÊ†º'}</span>
                                                    <span className="code">{prod.productId}</span>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                    <div className="py-4 text-sm text-gray-400 text-center">
                                        È°ØÁ§∫ {pickerFilteredProducts.length} Á≠Ü / ÂÖ± {products.filter(p => p.isActive !== false).length} Á≠Ü
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    <aside className="hidden md:flex flex-col w-64 bg-white border-r fixed inset-y-0 left-0 z-20"><div className="p-6 flex items-center gap-3 font-bold text-xl text-gray-800"><span className="text-blue-600"><I.Ship /></span>Ë≤®Ê´ÉÁÆ°ÁêÜ V79.0</div><nav className="flex-1 px-4 space-y-2"><button onClick={()=>setView('list')} className={`sidebar-link w-full ${view==='list'?'active':''}`}><div className="w-8 text-center"><I.List /></div> {TEXT.LIST_TITLE}</button>{userRole !== 'GUEST' && <><button onClick={()=>setView('products')} className={`sidebar-link w-full ${view==='products'?'active':''}`}><div className="w-8 text-center"><I.Package /></div> {TEXT.PRODUCTS_TITLE}</button><button onClick={()=>setView('stats')} className={`sidebar-link w-full ${view==='stats'?'active':''}`}><div className="w-8 text-center"><I.Chart /></div> {TEXT.STATS_TITLE}</button></>}</nav><div className="p-4 border-t space-y-2"><button onClick={()=>{setTempApiKey(geminiApiKey);setShowApiKeyModal(true)}} className="w-full py-2 text-xs text-gray-500 hover:text-blue-600 flex items-center justify-center gap-1 bg-gray-50 rounded-lg"><I.Wand /> AI Ë®≠ÂÆö {geminiApiKey ? '‚úì' : ''}</button><button onClick={handleLogout} className="w-full py-2 text-xs text-gray-400 hover:text-red-500 flex items-center justify-center gap-1"><I.LogOut /> {TEXT.LOGOUT}</button></div></aside>

                    <div className="md:hidden sticky top-0 z-30 bg-white border-b px-4 h-14 flex items-center justify-between shadow-sm"><div className="flex items-center gap-2 font-bold text-gray-900"><span className="text-blue-600"><I.Ship /></span> {view==='list'?TEXT.LIST_TITLE:(view==='products'?TEXT.PRODUCTS_TITLE:TEXT.STATS_TITLE)}</div><div className="flex gap-3 items-center"><div className="relative" onClick={()=>setShowNotifications(true)}><span className="text-gray-500"><I.Bell /></span>{urgentCount>0&&<span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></span>}</div><button onClick={handleExport} className="text-gray-500"><I.Download /></button><button onClick={()=>{setTempApiKey(geminiApiKey);setShowApiKeyModal(true)}} className={geminiApiKey ? "text-green-500" : "text-gray-400"}><I.Wand /></button>{canCreate()&&view==='list'&&<button onClick={handleStartNewContainer} className="text-blue-600"><I.Plus /></button>}<button onClick={handleLogout} className="text-red-400"><I.LogOut /></button></div></div>

                    <main className="p-4 max-w-4xl mx-auto">
                        {view === 'list' && (
                            <div className="space-y-4">
                                <div className="sticky top-0 z-20 bg-[#F3F4F6] -mt-4 pt-4 pb-2 space-y-3">
                                    <div className="flex gap-2 items-center">
                                        <div className="relative flex-1"><span className="absolute left-3 top-3 text-gray-400"><I.Search /></span><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="ÊêúÂ∞ã..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border-none shadow-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                        {canSeePrice() && (
                                            <button onClick={()=>setCurrentTab(currentTab==='UNPAID'?'NOT_DEVANED':'UNPAID')} title="ÁØ©ÈÅ∏Êú™‰ªòÊ¨æË≤®Ê´É" className={`relative p-2.5 rounded-xl shadow-sm transition-colors ${currentTab==='UNPAID'?'bg-red-500 text-white':'bg-white text-gray-600'}`}>
                                                <div className="flex items-center gap-1 font-bold"><I.Dollar />{unpaidCount > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}</div>
                                            </button>
                                        )}
                                        <button onClick={()=>setDisplayMode(displayMode==='card'?'table':'card')} title={displayMode==='card'?'ÂàáÊèõË°®Ê†ºÊ™¢Ë¶ñ':'ÂàáÊèõÂç°ÁâáÊ™¢Ë¶ñ'} className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600"><I.List /></button>
                                        
                                        {/* ÈõªËÖ¶ÁâàÂõõÂ§ßÂ§©Áéã */}
                                        <div className="hidden md:flex gap-2">
                                            <div onClick={()=>setShowNotifications(true)} title="Âà∞Ê∏ØÈÄöÁü•" className="relative p-2.5 bg-white rounded-xl shadow-sm text-gray-600 cursor-pointer hover:bg-gray-50"><I.Bell />{urgentCount>0&&<span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>}</div>
                                            <button onClick={handleExport} title="ÊâπÊ¨°ÂåØÂá∫ Excel" className="p-2.5 bg-white rounded-xl shadow-sm text-gray-600 hover:bg-gray-50"><I.Download /></button>
                                            {canCreate() && <button onClick={handleStartNewContainer} title="Êñ∞Â¢ûË≤®Ê´É" className="p-2.5 bg-white rounded-xl shadow-sm text-blue-600 hover:bg-blue-50"><I.Plus /></button>}
                                        </div>
                                    </div>
                                    <div className="flex overflow-x-auto gap-2 pb-1">
                                        <button onClick={()=>setCurrentTab('NOT_DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='NOT_DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>Êú™ÊãÜÊ´É <span className={`ml-1 text-xs ${currentTab==='NOT_DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&(!s.devanningDate||s.devanningDate>todayStr)).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DEVANED')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DEVANED'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>Â∑≤ÊãÜÊ´É <span className={`ml-1 text-xs ${currentTab==='DEVANED'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isForeign(s)&&s.devanningDate&&s.devanningDate<=todayStr).length}</span></button>
                                        <button onClick={()=>setCurrentTab('DOMESTIC')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${currentTab==='DOMESTIC'?'bg-blue-600 text-white shadow':'bg-white text-gray-600 border'}`}>ÂúãÂÖßÊé°Ë≥º <span className={`ml-1 text-xs ${currentTab==='DOMESTIC'?'text-blue-100':'text-gray-400'}`}>{shipments.filter(s=>isDomestic(s)).length}</span></button>
                                        
                                        {/* V74.0: Excel ÂåØÂÖ•ÊåâÈàï */}
                                        {canCreate() && currentTab === 'DOMESTIC' && (
                                            <label className="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap bg-emerald-500 text-white shadow cursor-pointer hover:bg-emerald-600 transition-colors">
                                                {TEXT.IMPORT_EXCEL}
                                                <input type="file" accept=".xlsx,.xls" onChange={handleExcelImport} className="hidden" />
                                            </label>
                                        )}
                                    </div>
                                </div>

                                {displayMode === 'table' ? (
                                    <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                                        <table className="reconcile-table">
                                            <thead><tr>
                                                <th onClick={()=>handleSort('arrivalDate')} className="cursor-pointer hover:bg-gray-100 select-none">Êó•Êúü {sortField==='arrivalDate' && <span>{sortOrder==='asc'?'‚Üë':'‚Üì'}</span>}</th>
                                                <th onClick={()=>handleSort('importCompany')} className="cursor-pointer hover:bg-gray-100 select-none">ÈÄ≤Âè£ÂÖ¨Âè∏</th>
                                                <th onClick={()=>handleSort('vendorSeqNo')} className="cursor-pointer hover:bg-gray-100 select-none">Âª†ÂïÜÂ∫èËôü</th>
                                                <th onClick={()=>handleSort('supplier')} className="cursor-pointer hover:bg-gray-100 select-none">Âª†ÂïÜ</th>
                                                <th className="col-product">ÂìÅÂêçÊëòË¶Å</th>
                                                <th onClick={()=>handleSort('totalQuantity')} className="cursor-pointer hover:bg-gray-100 select-none col-right">Á∏ΩÊï∏</th>
                                                <th onClick={()=>handleSort('totalWeight')} className="cursor-pointer hover:bg-gray-100 select-none col-right">Á∏ΩÈáç</th>
                                                {canSeePrice()&&<th onClick={()=>handleSort('totalAmount')} className="cursor-pointer hover:bg-gray-100 select-none col-right">Ë≤®Ê¨æ(USD)</th>}
                                                {canEditFlightFee()&&<th className="col-right">ÊóÖË≤ª</th>}
                                                {canEdit()&&<th className="col-center">Êìç‰Ωú</th>}
                                            </tr></thead>
                                            <tbody>
                                                {sortedFilteredList.map(item => {
                                                    const totalAmt = (item.products || []).reduce((s, p) => s + (Number(p.amount)||0), 0);
                                                    const totalQty = (item.products || []).reduce((s, p) => s + (Number(p.quantity)||0), 0);
                                                    const totalWt = (item.products || []).reduce((s, p) => s + (Number(p.weight)||0), 0);
                                                    const showFlightFee = isForeign(item) || canManage();
                                                    const uniqueNames = [...new Set((item.products||[]).map(p=>p.name).filter(Boolean))].join(',');
                                                    return (
                                                    <tr key={item.id} className="hover:bg-gray-50">
                                                        <td>{item.arrivalDate}</td>
                                                        <td className={item.importCompany === 'Â¥áÊñáÂÜ∑Âáç' ? 'text-blue-600' : 'text-orange-600'}>{item.importCompany || '-'}</td>
                                                        <td className="font-mono font-bold text-purple-600">{item.vendorSeqNo || '-'}</td>
                                                        <td>{item.supplier}</td>
                                                        <td className="col-product" title={uniqueNames}>{uniqueNames}</td>
                                                        <td className="col-right font-bold text-blue-600">{totalQty.toLocaleString()}</td>
                                                        <td className="col-right text-orange-500">{format2(totalWt)}</td>
                                                        {canSeePrice()&&<td className="col-right"><span className={item.isPaid?"amt-paid":"amt-unpaid"}>{format2(totalAmt)}</span></td>}
                                                        {canEditFlightFee()&&<td className="col-right">{showFlightFee?<span className={item.flightFeePaid?"amt-paid":"amt-unpaid"}>{format2(safeNum(item.flightFee))}</span>:'-'}</td>}
                                                        {canEdit()&&<td className="col-center"><button onClick={()=>handleEdit(item)} title="Á∑®ËºØ" className="text-gray-400 hover:text-blue-600 p-1"><I.Edit /></button></td>}
                                                    </tr>
                                                )})}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {filteredList.map(item => {
                                            const totalAmount = (item.products || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                                            const totalWeight = (item.products || []).reduce((sum, p) => sum + (Number(p.weight) || 0), 0);
                                            const totalQty = (item.products || []).reduce((sum, p) => sum + (Number(p.quantity) || 0), 0);
                                            const currSymbol = item.currency === 'USD' ? 'US$' : 'NT$';
                                            
                                            const isDevanned = item.devanningDate && item.devanningDate <= todayStr;
                                            const mainDate = parseDate(item.arrivalDate);
                                            const devanDate = item.devanningDate ? parseDate(item.devanningDate) : null;
                                            
                                            const hasAttachments = (item.attachments && item.attachments.length > 0) || item.docUrl;
                                            const attCount = item.attachments ? item.attachments.length : (item.docUrl ? 1 : 0);

                                            return (
                                            <div key={item.id} className={`ios-card overflow-hidden ${selectMode && selectedIds.has(item.id) ? 'ring-2 ring-blue-500' : ''}`} onClick={() => selectMode && toggleSelect(item.id)}>
                                                
                                                {/* ===== ÈõªËÖ¶ÁâàÂç°Áâá ===== */}
                                                <div className="hidden md:block p-4">
                                                    {/* È†≠ÈÉ®Ôºö‰∏âÂàóÈ°ØÁ§∫ */}
                                                    <div className="mb-3 pb-3 border-b border-gray-100">
                                                        {/* Á¨¨‰∏ÄÂàóÔºöÈÄ≤Âè£ÂÖ¨Âè∏„ÄÅÊ´ÉËôü„ÄÅÂà∞Ê∏ØÊó•Êúü + Êìç‰ΩúÊåâÈàï */}
                                                        <div className="flex items-center gap-3 mb-2">
                                                            {/* V79.3: Â§öÈÅ∏ÂãæÈÅ∏Ê°Ü */}
                                                            {selectMode && (
                                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer ${selectedIds.has(item.id) ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300'}`}>
                                                                    {selectedIds.has(item.id) && <I.Check />}
                                                                </div>
                                                            )}
                                                            <span className={`company-tag ${getCompanyColor(item.importCompany)} text-xs`}>{item.importCompany}</span>
                                                            <span className="text-xl font-black text-gray-900 tracking-tight">{item.containerNumber}</span>
                                                            {/* Âà∞Ê∏ØÊó• - Ê∞∏ÈÅ†È°ØÁ§∫ */}
                                                            <div className="flex items-center gap-1 px-2 py-1 rounded-lg text-sm font-bold bg-gray-50 text-gray-600">
                                                                <span>{mainDate.getMonth()+1}/{mainDate.getDate()}</span>
                                                                <span className="text-xs font-normal">Âà∞Ê∏Ø</span>
                                                            </div>
                                                            {/* ÊãÜÊ´ÉÊó• - ÊúâÊãÜÊ´ÉÊó•ÊâçÈ°ØÁ§∫ */}
                                                            {isDevanned && devanDate && (
                                                                <div className="flex items-center gap-1 px-2 py-1 rounded-lg text-sm font-bold bg-green-50 text-green-700">
                                                                    <span>{devanDate.getMonth()+1}/{devanDate.getDate()}</span>
                                                                    <span className="text-xs font-normal">Â∑≤ÊãÜÊ´É</span>
                                                                </div>
                                                            )}
                                                            <div className="flex-1"></div>
                                                            <div className="flex gap-1" onClick={e => e.stopPropagation()}>
                                                                {((item.attachments && item.attachments.length > 0) || item.docUrl) && (
                                                                    <button onClick={(e)=>handleAttachmentClick(e, item)} title="Ê™¢Ë¶ñÈôÑ‰ª∂" className="text-blue-500 hover:bg-blue-50 p-1.5 rounded-full relative"><I.Paperclip />{(item.attachments?.length || (item.docUrl ? 1 : 0)) > 1 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-3.5 h-3.5 flex items-center justify-center rounded-full">{item.attachments?.length || 1}</span>}</button>
                                                                )}
                                                                {canEdit() && <button onClick={(e)=>{e.stopPropagation(); handleEdit(item)}} title="Á∑®ËºØË≤®Ê´É" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Edit /></button>}
                                                                <button onClick={(e)=>{e.stopPropagation(); handleShareToLine(item)}} title="ÂàÜ‰∫´Âà∞ LINE" className="text-green-500 hover:text-green-600 p-1.5"><I.MessageCircle /></button>
                                                                {canCreate() && <button onClick={(e)=>{e.stopPropagation(); handleDuplicateShipment(item)}} title="Ë§áË£ΩË≤®Ê´É" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Copy /></button>}
                                                                {canDelete() && <button onClick={(e)=>{e.stopPropagation(); handleDelete(item.id)}} title="Âà™Èô§Ë≤®Ê´É" className="text-gray-400 hover:text-red-600 p-1.5"><I.Trash2 /></button>}
                                                            </div>
                                                        </div>
                                                        {/* Á¨¨‰∫åÂàóÔºöÂª†ÂïÜ„ÄÅÂ∫èËôü„ÄÅÁî¢Âú∞„ÄÅÂ†±ÈóúË°å„ÄÅËàπÂÖ¨Âè∏ */}
                                                        <div className="flex items-center gap-4 text-sm mb-1">
                                                            <span className="flex items-center gap-1"><span className="text-gray-400">Âª†ÂïÜ:</span><span className="font-bold text-gray-800">{item.supplier}</span>{item.vendorSeqNo && <span className="ml-1 px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-mono font-bold">{item.vendorSeqNo}</span>}</span>
                                                            {item.origin && <span className="flex items-center gap-1"><span className="text-gray-400">Áî¢Âú∞:</span><span className="font-bold text-gray-800">{item.origin}</span></span>}
                                                            {item.customsBroker && <span className="flex items-center gap-1"><span className="text-gray-400">Â†±ÈóúË°å:</span><span className="font-bold text-gray-800">{item.customsBroker}</span></span>}
                                                            {item.shippingCompany && <span className="flex items-center gap-1"><span className="text-gray-400">ËàπÂÖ¨Âè∏:</span><span className="font-bold text-gray-800">{item.shippingCompany}</span></span>}
                                                        </div>
                                                        {/* Á¨¨‰∏âÂàóÔºöÊãÜÊ´ÉÂú∞Èªû„ÄÅÊãÜÊ´ÉÊó•ÔºàÂ¶ÇÊúâÔºâ */}
                                                        {(item.devanningLocation || item.devanningDate) && (
                                                            <div className="flex items-center gap-4 text-sm">
                                                                {item.devanningLocation && <span className="flex items-center gap-1"><span className="text-gray-400">ÊãÜÊ´ÉÂú∞:</span><span className="font-bold text-blue-600">{item.devanningLocation}</span></span>}
                                                                {item.devanningDate && <span className="flex items-center gap-1"><span className="text-gray-400">ÊãÜÊ´ÉÊó•:</span><span className="font-bold text-blue-600">{item.devanningDate}</span></span>}
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Áî¢ÂìÅÊòéÁ¥∞ÔºöË°®Ê†ºÂºè */}
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="text-gray-500 border-b border-gray-200">
                                                                <th className="text-left py-2 font-medium">ÂìÅÂêç</th>
                                                                <th className="text-left py-2 font-medium">Ë¶èÊ†º</th>
                                                                <th className="text-right py-2 font-medium w-20">‰ª∂Êï∏</th>
                                                                {canSeePrice() && <th className="text-right py-2 font-medium w-28">ÈáçÈáè</th>}
                                                                {canSeePrice() && <th className="text-right py-2 font-medium w-20">ÂñÆÂÉπ</th>}
                                                                {canSeePrice() && <th className="text-right py-2 font-medium w-28">ÈáëÈ°ç</th>}
                                                                <th className="text-left py-2 font-medium pl-4">ÊâπËôü/ÊïàÊúü</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {(item.products || []).map((p,i)=>(
                                                                <tr key={i} className="border-b border-gray-50 last:border-0">
                                                                    <td className="py-2 font-bold text-gray-900">{p.name}</td>
                                                                    <td className="py-2 text-gray-600">{p.spec || '-'}</td>
                                                                    <td className="py-2 text-right font-mono text-base text-blue-600">{safeNum(p.quantity).toLocaleString()}</td>
                                                                    {canSeePrice() && <td className="py-2 text-right font-mono text-base text-orange-600">{format2(safeNum(p.weight))}kg</td>}
                                                                    {canSeePrice() && <td className="py-2 text-right font-mono text-base">${format2(safeNum(p.unitPrice))}</td>}
                                                                    {canSeePrice() && <td className="py-2 text-right font-mono text-base text-emerald-600">${format2(safeNum(p.amount))}</td>}
                                                                    <td className="py-2 text-gray-500 pl-4">{(p.batchNumber || p.expiryDate) ? <>{p.batchNumber && <span className="mr-2">{p.batchNumber}</span>}{p.expiryDate && <span>{p.expiryDate}</span>}</> : '-'}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                        <tfoot>
                                                            <tr className="border-t-2 border-gray-200 font-bold">
                                                                <td className="py-2" colSpan="2">ÂêàË®à</td>
                                                                <td className="py-2 text-right font-mono text-base text-blue-700">{totalQty.toLocaleString()}</td>
                                                                {canSeePrice() && <td className="py-2 text-right font-mono text-base text-orange-700">{format2(totalWeight)}kg</td>}
                                                                {canSeePrice() && <td className="py-2"></td>}
                                                                {canSeePrice() && <td className="py-2 text-right font-mono text-base text-emerald-700">{currSymbol}{format2(totalAmount)}</td>}
                                                                <td className="py-2"></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                    
                                                    {/* ÁãÄÊÖãÂàó */}
                                                    <div className="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                                                        <div className="flex gap-3">
                                                            {canSeePrice() && (
                                                                <>
                                                                    <span className={`text-sm font-medium ${item.isPaid ? 'text-green-600' : 'text-red-500'}`}>{item.isPaid ? '‚úì Ë≤®Ê¨æÂ∑≤‰ªò' : '‚úó Ë≤®Ê¨æÊú™‰ªò'}</span>
                                                                    {item.flightFee > 0 && <span className={`text-sm font-medium ${item.flightFeePaid ? 'text-green-600' : 'text-red-500'}`}>{item.flightFeePaid ? '‚úì ÊóÖË≤ªÂ∑≤‰ªò' : '‚úó ÊóÖË≤ªÊú™‰ªò'}</span>}
                                                                </>
                                                            )}
                                                        </div>
                                                        <label className={`flex items-center gap-1 text-sm cursor-pointer px-3 py-1.5 rounded-lg border ${item.warehouseConfirmed ? 'bg-green-100 border-green-200 text-green-700 font-bold' : 'bg-white border-gray-200 text-gray-400'}`} onClick={e => e.stopPropagation()}>
                                                            <input type="checkbox" className="w-4 h-4 rounded accent-green-600" checked={item.warehouseConfirmed || false} onChange={(e) => handleWarehouseConfirm(e, item)} disabled={!canEditWarehouseFields()} />
                                                            <span>{item.warehouseConfirmed ? 'Â∑≤Êî∂Ë≤®' : 'Á¢∫Ë™çÊî∂Ë≤®'}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                {/* ===== ÊâãÊ©üÁâàÂç°Áâá ===== */}
                                                <div className="md:hidden">
                                                    {/* È†≠ÈÉ® */}
                                                    <div className="p-3 pb-2">
                                                        {/* Á¨¨‰∏ÄË°åÔºöÂÖ¨Âè∏ + Êìç‰Ωú */}
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div className="flex items-center gap-2">
                                                                {/* V79.3: Â§öÈÅ∏ÂãæÈÅ∏Ê°Ü */}
                                                                {selectMode && (
                                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${selectedIds.has(item.id) ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300'}`}>
                                                                        {selectedIds.has(item.id) && <I.Check />}
                                                                    </div>
                                                                )}
                                                                <span className={`company-tag ${getCompanyColor(item.importCompany)} text-xs`}>{item.importCompany}</span>
                                                            </div>
                                                            <div className="flex gap-0.5" onClick={e => e.stopPropagation()}>
                                                                {((item.attachments && item.attachments.length > 0) || item.docUrl) && (
                                                                    <button onClick={(e)=>handleAttachmentClick(e, item)} title="Ê™¢Ë¶ñÈôÑ‰ª∂" className="text-blue-500 hover:bg-blue-50 p-1.5 rounded-full relative"><I.Paperclip />{(item.attachments?.length || (item.docUrl ? 1 : 0)) > 1 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-3.5 h-3.5 flex items-center justify-center rounded-full">{item.attachments?.length || 1}</span>}</button>
                                                                )}
                                                                {canEdit() && <button onClick={(e)=>{e.stopPropagation(); handleEdit(item)}} title="Á∑®ËºØË≤®Ê´É" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Edit /></button>}
                                                                <button onClick={(e)=>{e.stopPropagation(); handleShareToLine(item)}} title="ÂàÜ‰∫´Âà∞ LINE" className="text-green-500 hover:text-green-600 p-1.5"><I.MessageCircle /></button>
                                                                {canCreate() && <button onClick={(e)=>{e.stopPropagation(); handleDuplicateShipment(item)}} title="Ë§áË£ΩË≤®Ê´É" className="text-gray-400 hover:text-blue-600 p-1.5"><I.Copy /></button>}
                                                                {canDelete() && <button onClick={(e)=>{e.stopPropagation(); handleDelete(item.id)}} title="Âà™Èô§Ë≤®Ê´É" className="text-gray-400 hover:text-red-600 p-1.5"><I.Trash2 /></button>}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Á¨¨‰∫åË°åÔºöÊ´ÉËôü + Êó•Êúü */}
                                                        <div className="flex justify-between items-center mb-3">
                                                            <div className="text-xl font-black text-gray-900 tracking-tight">{item.containerNumber}</div>
                                                            <div className="flex items-center gap-2">
                                                                {/* Âà∞Ê∏ØÊó• - Ê∞∏ÈÅ†È°ØÁ§∫ */}
                                                                <div className="px-2 py-1 rounded-lg text-sm font-bold bg-gray-50 text-gray-600 border border-gray-200">
                                                                    <span className="text-xs font-normal mr-1">Âà∞Ê∏Ø</span>{mainDate.getMonth()+1}/{mainDate.getDate()}
                                                                </div>
                                                                {/* ÊãÜÊ´ÉÊó• - ÊúâÊãÜÊ´ÉÊó•ÊâçÈ°ØÁ§∫ */}
                                                                {isDevanned && devanDate && (
                                                                    <div className="px-2 py-1 rounded-lg text-sm font-bold bg-green-50 text-green-700 border border-green-200">
                                                                        <span className="text-xs font-normal mr-1">ÊãÜÊ´É</span>{devanDate.getMonth()+1}/{devanDate.getDate()}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* ÂÖ©Ê¨ÑÂ∞çÁ®±ÂºèË≥áË®ä */}
                                                        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm border-t border-gray-100 pt-2">
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">Âª†ÂïÜ</span><span className="text-gray-700 font-medium truncate ml-2">{item.supplier}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">Â∫èËôü</span><span className="text-purple-600 font-mono font-bold ml-2">{item.vendorSeqNo || '-'}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">Áî¢Âú∞</span><span className="text-gray-700 font-medium truncate ml-2">{item.origin || '-'}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">ËàπÂÖ¨Âè∏</span><span className="text-gray-700 font-medium truncate ml-2">{item.shippingCompany || '-'}</span></div>
                                                            <div className="flex justify-between"><span className="text-gray-400 shrink-0">Â†±ÈóúË°å</span><span className="text-gray-700 font-medium truncate ml-2">{item.customsBroker || '-'}</span></div>
                                                            {(item.devanningLocation || item.devanningDate) && (
                                                                <>
                                                                    <div className="flex justify-between"><span className="text-gray-400 shrink-0">ÊãÜÊ´ÉÂú∞</span><span className="text-blue-600 font-medium truncate ml-2">{item.devanningLocation || '-'}</span></div>
                                                                    <div className="flex justify-between"><span className="text-gray-400 shrink-0">ÊãÜÊ´ÉÊó•</span><span className="text-blue-600 font-medium truncate ml-2">{item.devanningDate || '-'}</span></div>
                                                                </>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Áî¢ÂìÅÊòéÁ¥∞ÔºöÁ≤æÁ∞°ÊäòÁñäÂºè */}
                                                    <div className="border-t border-gray-100 px-3 py-2 space-y-1">
                                                        {(item.products || []).map((p,i)=>(
                                                            <details key={i} className="group border-b border-gray-50 last:border-0">
                                                                <summary className="flex items-center justify-between py-2 cursor-pointer list-none">
                                                                    <div className="flex-1 min-w-0">
                                                                        {/* Á¨¨‰∏ÄÂàóÔºöÂìÅÂêç */}
                                                                        <div className="font-bold text-gray-900 text-base truncate">{p.name}</div>
                                                                        {/* Á¨¨‰∫åÂàóÔºöË¶èÊ†º + ‰ª∂Êï∏ */}
                                                                        <div className="flex items-center gap-2 text-base">
                                                                            {p.spec && <span className="text-gray-500 truncate">{p.spec}</span>}
                                                                            <span className="font-mono font-bold text-blue-600">{safeNum(p.quantity).toLocaleString()}‰ª∂</span>
                                                                        </div>
                                                                    </div>
                                                                    {/* Âè≥ÂÅ¥ÔºöÂ±ïÈñãÁÆ≠È†≠ */}
                                                                    <span className="text-gray-400 text-sm group-open:rotate-90 transition-transform ml-2">‚ñ∂</span>
                                                                </summary>
                                                                {/* Á¨¨‰∏âÂàóÔºàÊäòÁñäÔºâÔºöÈáçÈáè„ÄÅÂñÆÂÉπ„ÄÅÈáëÈ°ç„ÄÅÊâπËôü„ÄÅÊïàÊúü */}
                                                                <div className="pb-2 pl-2 border-l-2 border-blue-100 ml-1 mb-2 text-base">
                                                                    <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                                                                        {canSeePrice() && <div className="flex justify-between"><span className="text-gray-400">ÈáçÈáè</span><span className="font-mono text-orange-600">{format2(safeNum(p.weight))}kg</span></div>}
                                                                        {canSeePrice() && <div className="flex justify-between"><span className="text-gray-400">ÂñÆÂÉπ</span><span className="font-mono">${format2(safeNum(p.unitPrice))}</span></div>}
                                                                        {canSeePrice() && <div className="flex justify-between"><span className="text-gray-400">ÈáëÈ°ç</span><span className="font-mono font-bold text-emerald-600">${format2(safeNum(p.amount))}</span></div>}
                                                                        {p.batchNumber && <div className="flex justify-between"><span className="text-gray-400">ÊâπËôü</span><span className="text-gray-700">{p.batchNumber}</span></div>}
                                                                        {p.expiryDate && <div className="flex justify-between"><span className="text-gray-400">ÊïàÊúü</span><span className="text-gray-700">{p.expiryDate}</span></div>}
                                                                    </div>
                                                                </div>
                                                            </details>
                                                        ))}
                                                    </div>
                                                    
                                                    {/* ÂêàË®àÂçÄ */}
                                                    <div className="bg-gray-50 px-3 py-2 border-t border-gray-200">
                                                        {/* ÂêàË®àÊï∏Â≠ó */}
                                                        <div className="flex items-center text-base font-mono font-bold mb-2">
                                                            <span className="text-blue-700">{totalQty.toLocaleString()}‰ª∂</span>
                                                            {canSeePrice() && (
                                                                <>
                                                                    <span className="text-gray-300 mx-2">¬∑</span>
                                                                    <span className="text-orange-600">{format2(totalWeight)}kg</span>
                                                                    <span className="flex-1"></span>
                                                                    <span className="text-emerald-700 text-base">{currSymbol}{format2(totalAmount)}</span>
                                                                </>
                                                            )}
                                                        </div>
                                                        {/* ÁãÄÊÖãÂàó */}
                                                        <div className="flex justify-between items-center pt-2 border-t border-gray-200">
                                                            <div className="flex gap-2">
                                                                {canSeePrice() && (
                                                                    <>
                                                                        <span className={`text-xs font-medium ${item.isPaid ? 'text-green-600' : 'text-red-500'}`}>{item.isPaid ? '‚úìË≤®Ê¨æÂ∑≤‰ªò' : '‚úóÊú™‰ªòÊ¨æ'}</span>
                                                                        {item.flightFee > 0 && <span className={`text-xs font-medium ${item.flightFeePaid ? 'text-green-600' : 'text-red-500'}`}>{item.flightFeePaid ? '‚úìÊóÖË≤ªÂ∑≤‰ªò' : '‚úóÊóÖË≤ªÊú™‰ªò'}</span>}
                                                                    </>
                                                                )}
                                                            </div>
                                                            <label className={`flex items-center gap-1 text-xs cursor-pointer px-2 py-1 rounded-lg border ${item.warehouseConfirmed ? 'bg-green-100 border-green-200 text-green-700 font-bold' : 'bg-white border-gray-200 text-gray-400'}`} onClick={e => e.stopPropagation()}>
                                                                <input type="checkbox" className="w-3.5 h-3.5 rounded accent-green-600" checked={item.warehouseConfirmed || false} onChange={(e) => handleWarehouseConfirm(e, item)} disabled={!canEditWarehouseFields()} />
                                                                <span>{item.warehouseConfirmed ? 'Â∑≤Êî∂Ë≤®' : 'Á¢∫Ë™çÊî∂Ë≤®'}</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {view === 'stats' && <Dashboard shipments={shipments} canSeePrice={canSeePrice} />}

                        {/* V75.0: Áî¢ÂìÅ‰∏ªÊ™îÈ†ÅÈù¢ */}
                        {view === 'products' && (
                            <div className="space-y-4">
                                {/* È†ÇÈÉ®Êìç‰ΩúÂàó */}
                                <div className="flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-between">
                                    <div className="relative flex-1">
                                        <input 
                                            type="text" 
                                            placeholder={TEXT.PRODUCTS_SEARCH_HINT}
                                            value={productSearchTerm}
                                            onChange={e => setProductSearchTerm(e.target.value)}
                                            className="w-full pl-10 pr-4 py-3 bg-white border rounded-xl text-base"
                                        />
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><I.Search /></span>
                                    </div>
                                    {canCreate() && (
                                        <div className="flex gap-2">
                                            <label className="flex-1 md:flex-none px-4 py-3 bg-emerald-500 text-white rounded-xl font-bold text-sm cursor-pointer hover:bg-emerald-600 transition-colors flex items-center justify-center gap-2">
                                                <I.Upload />{TEXT.PRODUCTS_IMPORT}
                                                <input type="file" accept=".xlsx,.xls" onChange={handleProductExcelImport} className="hidden" />
                                            </label>
                                            <button 
                                                onClick={() => { setEditingProduct({...initialProductState}); setShowProductModal(true); }}
                                                className="flex-1 md:flex-none px-4 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                                            >
                                                <I.Plus />{TEXT.PRODUCTS_ADD}
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Áµ±Ë®àË≥áË®ä */}
                                <div className="bg-white rounded-xl p-3 border shadow-sm">
                                    <div className="flex justify-around md:justify-start md:gap-6 text-sm">
                                        <div className="text-center md:text-left"><div className="text-gray-400 text-xs">Á∏ΩÁî¢ÂìÅ</div><div className="font-bold text-blue-600 text-lg">{products.length}</div></div>
                                        <div className="text-center md:text-left"><div className="text-gray-400 text-xs">ÂïüÁî®‰∏≠</div><div className="font-bold text-emerald-600 text-lg">{products.filter(p => p.isActive !== false).length}</div></div>
                                        <div className="text-center md:text-left"><div className="text-gray-400 text-xs">ÊêúÂ∞ãÁµêÊûú</div><div className="font-bold text-lg">{filteredProducts.length}</div></div>
                                    </div>
                                </div>

                                {/* Áî¢ÂìÅÂàóË°® */}
                                {filteredProducts.length === 0 ? (
                                    <div className="bg-white rounded-xl p-8 border shadow-sm text-center text-gray-400">
                                        {products.length === 0 ? TEXT.PRODUCTS_EMPTY : 'ÁÑ°Á¨¶ÂêàÊêúÂ∞ãÊ¢ù‰ª∂ÁöÑÁî¢ÂìÅ'}
                                    </div>
                                ) : (
                                    <>
                                        {/* ÊâãÊ©üÁâàÔºöÂç°ÁâáÂºè */}
                                        <div className="md:hidden space-y-3">
                                            {filteredProducts.slice(0, 100).map((p) => (
                                                <div key={p.id} className={`bg-white rounded-xl border shadow-sm p-4 ${p.isActive === false ? 'opacity-60 bg-gray-50' : ''}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-bold text-base text-gray-900 truncate">
                                                                {p.name}
                                                                {p.isActive === false && <span className="text-xs text-red-500 ml-2">({TEXT.PRODUCT_INACTIVE})</span>}
                                                            </div>
                                                            {p.spec && <div className="text-sm text-gray-500 truncate">{p.spec}</div>}
                                                        </div>
                                                        <div className="flex gap-1 ml-2">
                                                            <button onClick={() => { setEditingProduct({...p}); setShowProductModal(true); }} className="text-blue-500 p-2"><I.Edit /></button>
                                                            {canDelete() && <button onClick={() => handleDeleteProduct(p)} className="text-red-400 p-2"><I.Trash2 /></button>}
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">Áî¢ÂìÅÁ∑®Ëôü</span>
                                                            <span className="font-mono text-gray-600">{p.productId || '-'}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">ÂñÆ‰Ωç</span>
                                                            <span className="text-gray-700">{p.unit || '-'}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">È†êË®≠ÂñÆÂÉπ</span>
                                                            <span className="font-bold text-emerald-600">{p.defaultPrice > 0 ? `$${p.defaultPrice.toLocaleString()}` : '-'}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">È†êË®≠Âª†ÂïÜ</span>
                                                            <span className="text-gray-700 truncate ml-2">{p.defaultSupplier || '-'}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredProducts.length > 100 && (
                                                <div className="text-center py-3 text-gray-400 text-sm">
                                                    È°ØÁ§∫Ââç 100 Á≠ÜÔºåÂÖ± {filteredProducts.length} Á≠Ü
                                                </div>
                                            )}
                                        </div>

                                        {/* ÈõªËÖ¶ÁâàÔºöË°®Ê†ºÂºè */}
                                        <div className="hidden md:block bg-white rounded-xl border shadow-sm overflow-hidden">
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-gray-50 border-b">
                                                        <tr>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_ID}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_NAME}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_SPEC}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_UNIT}</th>
                                                            <th className="px-3 py-3 text-right font-bold text-gray-600">{TEXT.PRODUCT_DEFAULT_PRICE}</th>
                                                            <th className="px-3 py-3 text-left font-bold text-gray-600">{TEXT.PRODUCT_DEFAULT_SUPPLIER}</th>
                                                            <th className="px-3 py-3 text-center font-bold text-gray-600">Êìç‰Ωú</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {filteredProducts.slice(0, 100).map((p, idx) => (
                                                            <tr key={p.id} className={`border-b hover:bg-blue-50 cursor-pointer ${p.isActive === false ? 'opacity-50 bg-gray-50' : ''} ${idx % 2 === 0 ? '' : 'bg-gray-50/50'}`}
                                                                onClick={() => { setEditingProduct({...p}); setShowProductModal(true); }}>
                                                                <td className="px-3 py-2.5 font-mono text-xs text-gray-500">{p.productId}</td>
                                                                <td className="px-3 py-2.5 font-bold">{p.name} {p.isActive === false && <span className="text-xs text-red-500 ml-1">({TEXT.PRODUCT_INACTIVE})</span>}</td>
                                                                <td className="px-3 py-2.5 text-gray-600">{p.spec || '-'}</td>
                                                                <td className="px-3 py-2.5 text-gray-500">{p.unit || '-'}</td>
                                                                <td className="px-3 py-2.5 text-right text-emerald-600 font-bold">{p.defaultPrice > 0 ? p.defaultPrice.toLocaleString() : '-'}</td>
                                                                <td className="px-3 py-2.5 text-gray-500">{p.defaultSupplier || '-'}</td>
                                                                <td className="px-3 py-2.5 text-center">
                                                                    <button onClick={(e) => { e.stopPropagation(); setEditingProduct({...p}); setShowProductModal(true); }} className="text-blue-500 hover:text-blue-700 p-1"><I.Edit /></button>
                                                                    {canDelete() && <button onClick={(e) => { e.stopPropagation(); handleDeleteProduct(p); }} className="text-red-400 hover:text-red-600 p-1 ml-1"><I.Trash2 /></button>}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            {filteredProducts.length > 100 && (
                                                <div className="text-center py-3 text-gray-400 text-sm border-t">
                                                    È°ØÁ§∫Ââç 100 Á≠ÜÔºåÂÖ± {filteredProducts.length} Á≠ÜÔºàË´ã‰ΩøÁî®ÊêúÂ∞ãÁ∏ÆÂ∞èÁØÑÂúçÔºâ
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {view === 'form' && (
                            <div className="ios-card p-4 md:p-5 animate-[fade-in_0.3s_ease-out]">
                                {/* V78.5: Ê∑∑ÂêàÊ®°ÂºèË°®ÂñÆ - Êñ∞Â¢ûÁî®ÂàÜÊ≠•È©üÔºåÁ∑®ËºØÁî®ÊäòÁñä */}
                                
                                {/* È†≠ÈÉ® */}
                                <div className="flex justify-between items-center mb-4 pb-3 border-b">
                                    <div className="flex items-center gap-3">
                                        {!editingId && formStep > 1 && (
                                            <button type="button" onClick={() => setFormStep(formStep - 1)} className="text-gray-400 p-1">
                                                <I.ChevronLeft />
                                            </button>
                                        )}
                                        <h2 className="font-bold text-lg">{editingId ? 'Á∑®ËºØË≤®Ê´É' : 'Êñ∞Â¢ûË≤®Ê´É'}</h2>
                                    </div>
                                    {editingId ? (
                                        <button onClick={()=>setView('list')} className="text-gray-400 p-1"><I.X /></button>
                                    ) : (
                                        <div className="text-sm text-gray-500">{formStep}/4</div>
                                    )}
                                </div>
                                
                                {/* Ê≠•È©üÊåáÁ§∫Âô® (ÂÉÖÊñ∞Â¢ûÊ®°Âºè‰∏îÁÇ∫ÊâãÊ©üÁâà) */}
                                {!editingId && (
                                    <div className="step-indicator md:hidden">
                                        {[1,2,3,4].map(s => (
                                            <div key={s} className={`step-dot ${formStep === s ? 'active' : ''} ${formStep > s ? 'done' : ''}`} />
                                        ))}
                                    </div>
                                )}
                                
                                {/* V79.0: Â∑≤Ëß£ÊûêÊñá‰ª∂È†êË¶ΩÂçÄÂüü */}
                                {parsedDocuments.length > 0 && !editingId && (
                                    <div className="mb-4 p-3 bg-gradient-to-r from-emerald-50 to-blue-50 rounded-xl border border-emerald-200">
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="flex items-center gap-2 text-sm font-bold text-gray-700">
                                                <I.FileCheck />
                                                <span>Â∑≤ËºâÂÖ• {parsedDocuments.length} ‰ªΩÊñá‰ª∂</span>
                                            </div>
                                            <label className="text-xs text-blue-600 font-bold cursor-pointer hover:underline flex items-center gap-1">
                                                <I.FilePlus />
                                                <span>Ë£úÂÖÖ‰∏äÂÇ≥</span>
                                                <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handleSupplementUpload} className="hidden" />
                                            </label>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {parsedDocuments.map(doc => (
                                                <div key={doc.id} className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm shadow-sm ${doc.isScanned ? 'bg-blue-50 border-blue-200' : 'bg-white'}`}>
                                                    <span>{doc.icon}</span>
                                                    <span className={`font-medium ${doc.isScanned ? 'text-blue-700' : 'text-gray-700'}`}>{doc.label}</span>
                                                    <button type="button" onClick={() => handleRemoveDocument(doc.id)} className="text-gray-400 hover:text-red-500 ml-1">
                                                        <I.X />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <form onSubmit={handleSubmit}>
                                    {/* ===== Êñ∞Â¢ûÊ®°ÂºèÔºöÊâãÊ©üÂàÜÊ≠•È©ü / ÈõªËÖ¶ÂÖ®È°ØÁ§∫ ===== */}
                                    {!editingId && (
                                        <>
                                            {/* ÊâãÊ©üÁâàÔºöÂàÜÊ≠•È©ü */}
                                            <div className="md:hidden">
                                                {/* Ê≠•È©ü 1: Âü∫Êú¨Ë≥áË®ä */}
                                                {formStep === 1 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">Âü∫Êú¨Ë≥áË®ä</div></div>
                                                        
                                                        {/* V79.0: Áõ∏ÈóúÊñá‰ª∂ÂèÉËÄÉ */}
                                                        {(getDocumentByType('invoice') || getDocumentByType('packing')) && (
                                                            <details className="bg-blue-50 rounded-xl border border-blue-200 overflow-hidden">
                                                                <summary className="px-4 py-3 cursor-pointer font-bold text-sm text-blue-700 flex items-center gap-2">
                                                                    <I.Eye /> ÂèÉËÄÉÊñá‰ª∂ÂÖßÂÆπÔºàInvoice / Packing ListÔºâ
                                                                </summary>
                                                                <div className="px-4 pb-4 max-h-48 overflow-y-auto">
                                                                    {getDocumentByType('invoice') && (
                                                                        <div className="mb-3">
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">üìÑ {getDocumentByType('invoice').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('invoice').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                    {getDocumentByType('packing') && (
                                                                        <div>
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">üì¶ {getDocumentByType('packing').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('packing').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </details>
                                                        )}
                                                        
                                                        <div><label className="form-label-lg">ÈÄ≤Âè£ÂÖ¨Âè∏</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} className="form-input-lg">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label className="form-label-lg">Ê´ÉËôü <span className="required">*</span></label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} className={`form-input-lg font-mono uppercase ${validationErrors.containerNumber ? 'error' : ''}`} placeholder="Ëº∏ÂÖ•Ê´ÉËôü" /></div>
                                                        <div><label className="form-label-lg">Âà∞Ê∏ØÊó• <span className="required">*</span></label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} className={`form-input-lg ${validationErrors.arrivalDate ? 'error' : ''}`} /></div>
                                                        <div><label className="form-label-lg">Âª†ÂïÜ <span className="required">*</span></label><input name="supplier" value={formData.supplier} onChange={handleInputChange} className={`form-input-lg ${validationErrors.supplier ? 'error' : ''}`} placeholder="Ëº∏ÂÖ•Âª†ÂïÜÂêçÁ®±" /></div>
                                                        <div><label className="form-label-lg">Âª†ÂïÜÂ∫èËôü</label><div className="flex gap-2"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} className="form-input-lg font-mono flex-1" placeholder="Â¶Ç 26-01" /><button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-3 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold whitespace-nowrap">Ëá™Âãï</button></div></div>
                                                        <div><label className="form-label-lg">Áî¢Âú∞</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} className="form-input-lg" placeholder="Ëº∏ÂÖ•Áî¢Âú∞" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        <button type="button" onClick={() => setFormStep(2)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg mt-4">‰∏ã‰∏ÄÊ≠•ÔºöÂ†±ÈóúË≥áË®ä ‚Üí</button>
                                                        <button type="button" onClick={()=>setView('list')} className="w-full py-3 text-gray-500 font-bold">ÂèñÊ∂à</button>
                                                    </div>
                                                )}
                                                
                                                {/* Ê≠•È©ü 2: Â†±ÈóúË≥áË®ä */}
                                                {formStep === 2 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">Â†±ÈóúË≥áË®ä</div></div>
                                                        
                                                        {/* V79.0: Áõ∏ÈóúÊñá‰ª∂ÂèÉËÄÉ */}
                                                        {(getDocumentByType('bl') || getDocumentByType('arrival')) && (
                                                            <details className="bg-blue-50 rounded-xl border border-blue-200 overflow-hidden">
                                                                <summary className="px-4 py-3 cursor-pointer font-bold text-sm text-blue-700 flex items-center gap-2">
                                                                    <I.Eye /> ÂèÉËÄÉÊñá‰ª∂ÂÖßÂÆπÔºàB/L / Âà∞Ë≤®ÈÄöÁü•Ôºâ
                                                                </summary>
                                                                <div className="px-4 pb-4 max-h-48 overflow-y-auto">
                                                                    {getDocumentByType('bl') && (
                                                                        <div className="mb-3">
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">üö¢ {getDocumentByType('bl').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('bl').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                    {getDocumentByType('arrival') && (
                                                                        <div>
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">üì¨ {getDocumentByType('arrival').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('arrival').text.substring(0, 1500)}...</pre>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </details>
                                                        )}
                                                        
                                                        {/* Ë£úÂÖÖ‰∏äÂÇ≥ÂçÄ */}
                                                        {parsedDocuments.length > 0 && !getDocumentByType('bl') && !getDocumentByType('arrival') && (
                                                            <label className="flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 text-sm text-gray-500">
                                                                <I.FilePlus /> Ë£úÂÖÖ‰∏äÂÇ≥ B/L ÊàñÂà∞Ë≤®ÈÄöÁü•
                                                                <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handleSupplementUpload} className="hidden" />
                                                            </label>
                                                        )}
                                                        
                                                        <div><label className="form-label-lg">ËàπÂÖ¨Âè∏</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} className="form-input-lg" placeholder="Ëº∏ÂÖ•ËàπÂÖ¨Âè∏" /></div>
                                                        <div><label className="form-label-lg">Â†±ÈóúË°å</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} className="form-input-lg">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label className="form-label-lg">Â†±ÈóúÂñÆËôü</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} className="form-input-lg" placeholder="Ëº∏ÂÖ•Â†±ÈóúÂñÆËôü" /></div>
                                                        <div><label className="form-label-lg">Ëº∏ÂÖ•Ë®±ÂèØË≠â</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} className="form-input-lg" placeholder="Ëº∏ÂÖ•Ë®±ÂèØË≠âËôü" /></div>
                                                        <div><label className="form-label-lg">ÊãÜÊ´ÉÂú∞Èªû</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} className="form-input-lg" placeholder="Ëº∏ÂÖ•ÊãÜÊ´ÉÂú∞Èªû" /></div>
                                                        <div><label className="form-label-lg">ÊãÜÊ´ÉÊó•Êúü</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} className="form-input-lg" /></div>
                                                        <button type="button" onClick={() => setFormStep(3)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg mt-4">‰∏ã‰∏ÄÊ≠•Ôºö‰ªòÊ¨æË≥áË®ä ‚Üí</button>
                                                    </div>
                                                )}
                                                
                                                {/* Ê≠•È©ü 3: ‰ªòÊ¨æË≥áË®ä */}
                                                {formStep === 3 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">‰ªòÊ¨æË≥áË®ä</div></div>
                                                        {canSeePrice() ? (<>
                                                            <div><label className="form-label-lg">‰ªòÊ¨æÊ¢ù‰ª∂</label><input value={formData.paymentTerm} disabled className="form-input-lg" /></div>
                                                            {isForeign(formData) && (<div><label className="form-label-lg">ÊóÖË≤ª</label><input type="text" inputMode="decimal" name="flightFee" value={formData.flightFee} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleInputChange({target:{name:'flightFee',value:e.target.value.replace(/[^\d.-]/g,''),type:'text'}})} className="form-input-lg num-input" placeholder="0" /></div>)}
                                                            <div className="bg-gray-50 p-4 rounded-xl space-y-4">
                                                                <label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} className="w-6 h-6 accent-green-600"/><span className="font-bold text-green-700 text-lg">Ë≤®Ê¨æÂ∑≤‰ªò</span></label>
                                                                {isForeign(formData) && (<label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} className="w-6 h-6 accent-red-600"/><span className="font-bold text-red-700 text-lg">ÊóÖË≤ªÂ∑≤‰ªò</span></label>)}
                                                            </div>
                                                        </>) : (<div className="text-center text-gray-400 py-8">ÁÑ°Ê¨äÈôêÊü•Áúã‰ªòÊ¨æË≥áË®ä</div>)}
                                                        <button type="button" onClick={() => setFormStep(4)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg mt-4">‰∏ã‰∏ÄÊ≠•ÔºöÁî¢ÂìÅÊòéÁ¥∞ ‚Üí</button>
                                                    </div>
                                                )}
                                                
                                                {/* Ê≠•È©ü 4: Áî¢ÂìÅÊòéÁ¥∞ */}
                                                {formStep === 4 && (
                                                    <div className="space-y-4">
                                                        <div className="step-title"><div className="step-name">Áî¢ÂìÅÊòéÁ¥∞</div></div>
                                                        
                                                        {/* V79.0: Áõ∏ÈóúÊñá‰ª∂ÂèÉËÄÉ */}
                                                        {(getDocumentByType('invoice') || getDocumentByType('expiry')) && (
                                                            <details className="bg-blue-50 rounded-xl border border-blue-200 overflow-hidden">
                                                                <summary className="px-4 py-3 cursor-pointer font-bold text-sm text-blue-700 flex items-center gap-2">
                                                                    <I.Eye /> ÂèÉËÄÉÊñá‰ª∂ÂÖßÂÆπÔºàInvoice / ÊâπËôüÊïàÊúüÔºâ
                                                                </summary>
                                                                <div className="px-4 pb-4 max-h-48 overflow-y-auto">
                                                                    {getDocumentByType('invoice') && (
                                                                        <div className="mb-3">
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">üìÑ {getDocumentByType('invoice').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('invoice').text.substring(0, 2000)}...</pre>
                                                                        </div>
                                                                    )}
                                                                    {getDocumentByType('expiry') && (
                                                                        <div>
                                                                            <div className="text-xs font-bold text-gray-500 mb-1">üìã {getDocumentByType('expiry').name}</div>
                                                                            <pre className="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-2 rounded border">{getDocumentByType('expiry').text}</pre>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </details>
                                                        )}
                                                        
                                                        {/* Ë£úÂÖÖ‰∏äÂÇ≥ÂçÄ */}
                                                        {parsedDocuments.length > 0 && !getDocumentByType('expiry') && (
                                                            <label className="flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 text-sm text-gray-500">
                                                                <I.FilePlus /> Ë£úÂÖÖ‰∏äÂÇ≥ÊâπËôüÊïàÊúüÊ∏ÖÂñÆ
                                                                <input type="file" accept=".pdf,.xlsx,.xls" multiple onChange={handleSupplementUpload} className="hidden" />
                                                            </label>
                                                        )}
                                                        
                                                        {validationErrors.products && <div className="text-red-500 text-sm bg-red-50 p-3 rounded-lg">Ë´ãËá≥Â∞ëÂ°´ÂØ´‰∏ÄÈ†ÖÂìÅÂêç</div>}
                                                        <div className="space-y-4">
                                                            {formData.products.map((p, idx) => (
                                                                <div key={p.id} className={`product-card-lg ${validationErrors.products && idx === 0 && !p.name?.trim() ? 'error' : ''}`}>
                                                                    {/* Áî¢ÂìÅÁ∑®ËôüÊ®ôÈ°å */}
                                                                    <div className="flex items-center justify-between mb-4 pb-2 border-b border-gray-200">
                                                                        <span className="font-bold text-gray-600">Áî¢ÂìÅ #{idx + 1}</span>
                                                                        <div className="flex gap-2">
                                                                            <button type="button" onClick={()=>duplicateProductRow(idx)} className="p-2 bg-gray-100 rounded-lg text-gray-500"><I.Copy /></button>
                                                                            {formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="p-2 bg-red-50 rounded-lg text-red-500"><I.Trash2 /></button>}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* ÂìÅÂêç */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">ÂìÅÂêç <span className="required">*</span></label>
                                                                        <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`product-picker-btn ${!p.name ? 'empty' : ''}`}>
                                                                            <span>{p.name || 'ÈªûÊìäÈÅ∏ÊìáÁî¢ÂìÅ'}</span>
                                                                            <span>‚ñº</span>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Ë¶èÊ†º */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">Ë¶èÊ†º</label>
                                                                        <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="form-input-lg" placeholder="Ëº∏ÂÖ•Ë¶èÊ†º" />
                                                                    </div>
                                                                    
                                                                    {/* ‰ª∂Êï∏ */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">‰ª∂Êï∏</label>
                                                                        <input type="text" inputMode="decimal" value={p.quantity} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'quantity',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{color:'#2563eb'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* ÈáçÈáè */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">ÈáçÈáè (kg)</label>
                                                                        <input type="text" inputMode="decimal" value={p.weight} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'weight',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{color:'#f97316'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* ÂñÆÂÉπ */}
                                                                    {canSeePrice() && (
                                                                        <div className="mb-4">
                                                                            <label className="form-label-lg">ÂñÆÂÉπ</label>
                                                                            <input type="text" inputMode="decimal" value={p.unitPrice} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" placeholder="0" />
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* Ë®àÂÉπÊñπÂºè */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">Ë®àÂÉπÊñπÂºè</label>
                                                                        <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="form-input-lg">
                                                                            <option value="weight">Ë®àÈáç</option>
                                                                            <option value="quantity">Ë®à‰ª∂</option>
                                                                        </select>
                                                                    </div>
                                                                    
                                                                    {/* ÊâπËôü */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">ÊâπËôü</label>
                                                                        <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="form-input-lg" placeholder="Ëº∏ÂÖ•ÊâπËôü" />
                                                                    </div>
                                                                    
                                                                    {/* ÊïàÊúü */}
                                                                    <div className="mb-4">
                                                                        <label className="form-label-lg">ÊïàÊúü</label>
                                                                        <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="form-input-lg" />
                                                                    </div>
                                                                    
                                                                    {/* ÈáëÈ°ç */}
                                                                    {canSeePrice() && (
                                                                        <div className="bg-emerald-50 p-4 rounded-xl text-center">
                                                                            <div className="text-sm text-emerald-600 mb-1">Â∞èË®àÈáëÈ°ç</div>
                                                                            <div className="font-bold text-emerald-700 text-2xl">${format2(safeNum(p.amount))}</div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <button type="button" onClick={addProductRow} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold border-2 border-dashed border-blue-200">+ Êñ∞Â¢ûÁî¢ÂìÅ</button>
                                                        <div className="bg-gray-50 p-4 rounded-xl">
                                                            <label className="form-label-lg mb-3">ÈôÑ‰ª∂ ({formData.attachments?.length || 0})</label>
                                                            {(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-white p-3 rounded-lg border mb-2"><a href={file.url} target="_blank" className="text-blue-600 underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}
                                                            {canUpload() && (<div className="relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-3 bg-white border border-dashed border-gray-300 rounded-lg text-gray-500 font-bold">{uploading ? '‰∏äÂÇ≥‰∏≠...' : 'üìé ÈÅ∏ÊìáÊ™îÊ°à'}</button></div>)}
                                                        </div>
                                                        <button type="submit" disabled={isSubmitting} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold text-lg mt-4 shadow-lg">{isSubmitting ? 'ÂÑ≤Â≠ò‰∏≠...' : '‚úì ÂÆåÊàêÊñ∞Â¢û'}</button>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* ÈõªËÖ¶ÁâàÔºöÂÇ≥Áµ±ÂÖ®È°ØÁ§∫ */}
                                            <div className="hidden md:block space-y-4">
                                                <div className="bg-white rounded-xl p-3 border border-gray-200 shadow-sm">
                                                    <div className="grid grid-cols-4 gap-2">
                                                        <div><label>ÈÄ≤Âè£ÂÖ¨Âè∏</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label className="label-required">Ê´ÉËôü</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} className={`w-full input-bg-style rounded-lg p-2 font-mono uppercase ${validationErrors.containerNumber ? 'input-error' : ''}`} placeholder="Ê´ÉËôü" /></div>
                                                        <div><label>ËàπÂÖ¨Âè∏</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="ËàπÂÖ¨Âè∏" /></div>
                                                        <div><label className="label-required">Âà∞Ê∏ØÊó•</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} className={`w-full input-bg-style rounded-lg p-2 ${validationErrors.arrivalDate ? 'input-error' : ''}`} /></div>
                                                        <div><label>Â†±ÈóúË°å</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label>Â†±ÈóúÂñÆËôü</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="Â†±ÈóúÂñÆËôü" /></div>
                                                        <div><label>Ëº∏ÂÖ•Ë®±ÂèØË≠â</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="Ë®±ÂèØË≠âËôü" /></div>
                                                        <div><label className="label-required">Âª†ÂïÜ</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} className={`w-full input-bg-style rounded-lg p-2 ${validationErrors.supplier ? 'input-error' : ''}`} placeholder="Âª†ÂïÜ" /></div>
                                                        <div><label>Âª†ÂïÜÂ∫èËôü</label><div className="flex gap-1"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} className="flex-1 input-bg-style rounded-lg p-2 font-mono" placeholder="Â¶Ç 26-01" /><button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-2 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold">Ëá™Âãï</button></div></div>
                                                        <div><label>Áî¢Âú∞</label><input list="origins" name="origin" value={formData.origin} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="Áî¢Âú∞" /><datalist id="origins">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        <div><label>ÊãÜÊ´ÉÂú∞</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" placeholder="Âú∞Èªû" /></div>
                                                        <div><label>ÊãÜÊ´ÉÊó•</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} className="w-full input-bg-style rounded-lg p-2" /></div>
                                                    </div>
                                                </div>
                                                {canSeePrice() && (
                                                    <div className="bg-blue-50 rounded-xl p-3 border border-blue-100 flex flex-wrap items-end gap-3">
                                                        <div className="flex-1 min-w-[140px]"><label>‰ªòÊ¨æÊ¢ù‰ª∂</label><input value={formData.paymentTerm} disabled className="w-full bg-white border rounded input-bg-style text-xs" /></div>
                                                        {canEditFlightFee() && isForeign(formData) && (<div className="w-24"><label>ÊóÖË≤ª</label><input type="number" name="flightFee" value={formData.flightFee} onWheel={e=>e.target.blur()} onChange={handleInputChange} className="w-full bg-white border rounded input-bg-style" placeholder="0" /></div>)}
                                                        <div className="flex items-center gap-3 pb-2 ml-auto">
                                                            <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} className="w-5 h-5 accent-green-600"/><span className="font-bold text-green-700 text-xs">Ë≤®Ê¨æÂ∑≤‰ªò</span></label>
                                                            {canEditFlightFee() && isForeign(formData) && <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} className="w-5 h-5 accent-red-600"/><span className="font-bold text-red-700 text-xs">ÊóÖË≤ªÂ∑≤‰ªò</span></label>}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="pt-2">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h3 className={`font-bold text-lg ${validationErrors.products ? 'text-red-600' : 'text-gray-700'}`}>Áî¢ÂìÅÊòéÁ¥∞ <span className="text-red-500 text-sm">*</span>{validationErrors.products && <span className="text-red-500 text-xs ml-2">(Ë´ãËá≥Â∞ëÂ°´ÂØ´‰∏ÄÈ†ÖÂìÅÂêç)</span>}</h3>
                                                        <button type="button" onClick={addProductRow} className="text-blue-600 font-bold text-sm hover:underline cursor-pointer">+ Êñ∞Â¢ûÁî¢ÂìÅ</button>
                                                    </div>
                                                    <div className="space-y-3">{formData.products.map((p, idx) => (
                                                        <div key={p.id} className={`bg-white border rounded-xl p-3 shadow-sm ${validationErrors.products && idx === 0 ? 'border-red-300' : ''}`}>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`input-bg-style rounded p-1 font-bold cursor-pointer flex items-center justify-between ${validationErrors.products && idx === 0 && !p.name?.trim() ? 'input-error' : ''} ${products.length > 0 ? 'hover:bg-blue-50' : ''}`}><span className={p.name ? 'text-gray-800' : 'text-gray-400'}>{p.name || 'ÈªûÊìäÈÅ∏ÊìáÂìÅÂêç'}</span>{products.length > 0 && <span className="text-blue-500 text-xs">‚ñº</span>}</div>
                                                                <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="Ë¶èÊ†º" />
                                                                <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="input-bg-style rounded p-1 text-sm"><option value="weight">Ë®àÈáç</option><option value="quantity">Ë®à‰ª∂</option></select>
                                                                <input type="number" value={p.quantity} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'quantity',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-blue-600" placeholder="‰ª∂Êï∏" />
                                                                <input type="number" value={p.weight} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'weight',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-orange-500" placeholder="ÈáçÈáè" />
                                                                {canSeePrice() ? (<input type="number" value={p.unitPrice} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value)} className="input-bg-style rounded p-1 text-right" placeholder="ÂñÆÂÉπ" />) : (<div className="input-bg-style rounded p-1 text-right flex items-center justify-end text-gray-300">***</div>)}
                                                                <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="ÊâπËôü" />
                                                                <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="input-bg-style rounded p-1 text-xs" />
                                                                <div className="flex items-center justify-between bg-gray-50 rounded px-2 border border-gray-200">{canSeePrice() ? <span className="font-bold text-emerald-600 text-sm">${format2(safeNum(p.amount))}</span> : <span>***</span>}<div className="flex gap-1"><button type="button" onClick={()=>duplicateProductRow(idx)} className="text-gray-400 hover:text-blue-600 p-1"><I.Copy /></button>{formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="text-gray-400 hover:text-red-600 p-1"><I.Trash2 /></button>}</div></div>
                                                            </div>
                                                        </div>
                                                    ))}</div>
                                                </div>
                                                <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                                    <label className="block text-xs font-bold text-gray-500 mb-2">ÈôÑ‰ª∂ ({formData.attachments?.length || 0})</label>
                                                    <div className="space-y-2">{(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-white p-2 rounded border"><a href={file.url} target="_blank" className="text-blue-600 text-xs underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}</div>
                                                    {canUpload() && (<div className="mt-2 relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-2 bg-white border border-dashed border-gray-400 rounded text-gray-500 text-sm font-bold flex items-center justify-center gap-2">{uploading ? '‰∏äÂÇ≥‰∏≠...' : <><I.Paperclip /> ÈÅ∏ÊìáÊ™îÊ°à (ÂèØÂ§öÈÅ∏)</>}</button></div>)}
                                                </div>
                                                <div className="flex gap-3 pt-2"><button type="button" onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ÂèñÊ∂à</button><button type="submit" disabled={isSubmitting} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">{isSubmitting?'...':'ÂÑ≤Â≠ò'}</button></div>
                                            </div>
                                        </>
                                    )}
                                    
                                    {/* ===== Á∑®ËºØÊ®°ÂºèÔºöÊâãÊ©üÊäòÁñä / ÈõªËÖ¶ÂÖ®È°ØÁ§∫ ===== */}
                                    {editingId && (
                                        <>
                                            {/* ÊâãÊ©üÁâàÔºöÊäòÁñäÂçÄÂ°ä */}
                                            <div className="md:hidden space-y-3">
                                                {/* Âü∫Êú¨Ë≥áË®äÂçÄÂ°ä */}
                                                <div className={`accordion-section ${openSections.includes('basic') ? 'active' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('basic') ? prev.filter(s=>s!=='basic') : [...prev, 'basic'])}>
                                                        <div><div className="accordion-title">Âü∫Êú¨Ë≥áË®ä</div><div className="accordion-subtitle">{formData.containerNumber || 'Êú™Â°´ÂØ´'} ¬∑ {formData.supplier || 'Êú™Â°´ÂØ´'}</div></div>
                                                        <span className="accordion-arrow">‚ñ∂</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-3">
                                                            <div><label className="form-label-lg">ÈÄ≤Âè£ÂÖ¨Âè∏</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                            <div><label className="form-label-lg">Ê´ÉËôü</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg font-mono uppercase" placeholder="Ê´ÉËôü" /></div>
                                                            <div><label className="form-label-lg">Âà∞Ê∏ØÊó•</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" /></div>
                                                            <div><label className="form-label-lg">Âª†ÂïÜ</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" placeholder="Âª†ÂïÜ" /></div>
                                                            <div><label className="form-label-lg">Âª†ÂïÜÂ∫èËôü</label><div className="flex gap-2"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg font-mono flex-1" placeholder="Â¶Ç 26-01" />{canCreate() && <button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-3 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold">Ëá™Âãï</button>}</div></div>
                                                            <div><label className="form-label-lg">Áî¢Âú∞</label><input list="origins2" name="origin" value={formData.origin} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" placeholder="Áî¢Âú∞" /><datalist id="origins2">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Â†±ÈóúË≥áË®äÂçÄÂ°ä */}
                                                <div className={`accordion-section ${openSections.includes('customs') ? 'active' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('customs') ? prev.filter(s=>s!=='customs') : [...prev, 'customs'])}>
                                                        <div><div className="accordion-title">Â†±ÈóúË≥áË®ä</div><div className="accordion-subtitle">{formData.customsBroker || 'Êú™Â°´ÂØ´'}</div></div>
                                                        <span className="accordion-arrow">‚ñ∂</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-3">
                                                            <div><label className="form-label-lg">ËàπÂÖ¨Âè∏</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg" placeholder="ËàπÂÖ¨Âè∏" /></div>
                                                            <div><label className="form-label-lg">Â†±ÈóúË°å</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={!canCreate()} className="form-input-lg">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                            <div><label className="form-label-lg">Â†±ÈóúÂñÆËôü</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="form-input-lg" placeholder="Â†±ÈóúÂñÆËôü" /></div>
                                                            <div><label className="form-label-lg">Ëº∏ÂÖ•Ë®±ÂèØË≠â</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="form-input-lg" placeholder="Ë®±ÂèØË≠âËôü" /></div>
                                                            <div><label className="form-label-lg">ÊãÜÊ´ÉÂú∞Èªû</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="form-input-lg" placeholder="Âú∞Èªû" /></div>
                                                            <div><label className="form-label-lg">ÊãÜÊ´ÉÊó•Êúü</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="form-input-lg" /></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* ‰ªòÊ¨æË≥áË®äÂçÄÂ°ä */}
                                                {canSeePrice() && (
                                                    <div className={`accordion-section ${openSections.includes('payment') ? 'active' : ''}`}>
                                                        <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('payment') ? prev.filter(s=>s!=='payment') : [...prev, 'payment'])}>
                                                            <div><div className="accordion-title">‰ªòÊ¨æË≥áË®ä</div><div className="accordion-subtitle">{formData.isPaid ? '‚úì Ë≤®Ê¨æÂ∑≤‰ªò' : 'Êú™‰ªòÊ¨æ'}</div></div>
                                                            <span className="accordion-arrow">‚ñ∂</span>
                                                        </div>
                                                        <div className="accordion-content">
                                                            <div className="space-y-3">
                                                                <div><label className="form-label-lg">‰ªòÊ¨æÊ¢ù‰ª∂</label><input value={formData.paymentTerm} disabled className="form-input-lg" /></div>
                                                                {canEditFlightFee() && isForeign(formData) && (<div><label className="form-label-lg">ÊóÖË≤ª</label><input type="text" inputMode="decimal" name="flightFee" value={formData.flightFee} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleInputChange({target:{name:'flightFee',value:e.target.value.replace(/[^\d.-]/g,''),type:'text'}})} className="form-input-lg num-input" placeholder="0" /></div>)}
                                                                <div className="bg-gray-50 p-4 rounded-xl space-y-3">
                                                                    <label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-6 h-6 accent-green-600"/><span className="font-bold text-green-700 text-lg">Ë≤®Ê¨æÂ∑≤‰ªò</span></label>
                                                                    {canEditFlightFee() && isForeign(formData) && <label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-6 h-6 accent-red-600"/><span className="font-bold text-red-700 text-lg">ÊóÖË≤ªÂ∑≤‰ªò</span></label>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Áî¢ÂìÅÊòéÁ¥∞ÂçÄÂ°ä */}
                                                <div className={`accordion-section ${openSections.includes('products') ? 'active' : ''} ${validationErrors.products ? 'has-error' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('products') ? prev.filter(s=>s!=='products') : [...prev, 'products'])}>
                                                        <div><div className="accordion-title">Áî¢ÂìÅÊòéÁ¥∞ ({formData.products?.length || 0})</div><div className="accordion-subtitle">{formData.products?.[0]?.name || 'Êú™Â°´ÂØ´'}</div></div>
                                                        <span className="accordion-arrow">‚ñ∂</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-4">
                                                            {formData.products.map((p, idx) => (
                                                                <div key={p.id} className="product-card-lg">
                                                                    {/* Áî¢ÂìÅÁ∑®ËôüÊ®ôÈ°å */}
                                                                    <div className="flex items-center justify-between mb-3 pb-2 border-b border-gray-200">
                                                                        <span className="font-bold text-gray-600">Áî¢ÂìÅ #{idx + 1}</span>
                                                                        {(canEditDomesticFull() || canManage()) && (
                                                                            <div className="flex gap-1">
                                                                                <button type="button" onClick={()=>duplicateProductRow(idx)} className="p-2 text-gray-400"><I.Copy /></button>
                                                                                {formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="p-2 text-red-400"><I.Trash2 /></button>}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    
                                                                    {/* ÂìÅÂêç */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">ÂìÅÂêç</label>
                                                                        <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`product-picker-btn ${!p.name ? 'empty' : ''}`}>
                                                                            <span>{p.name || 'ÈªûÊìäÈÅ∏ÊìáÁî¢ÂìÅ'}</span>
                                                                            <span>‚ñº</span>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Ë¶èÊ†º */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">Ë¶èÊ†º</label>
                                                                        <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="form-input-lg" placeholder="Ëº∏ÂÖ•Ë¶èÊ†º" style={{height:'48px'}} />
                                                                    </div>
                                                                    
                                                                    {/* ‰ª∂Êï∏ */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">‰ª∂Êï∏</label>
                                                                        <input type="text" inputMode="decimal" value={p.quantity} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'quantity',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{height:'48px',color:'#2563eb'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* ÈáçÈáè */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">ÈáçÈáè (kg)</label>
                                                                        <input type="text" inputMode="decimal" value={p.weight} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'weight',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{height:'48px',color:'#f97316'}} placeholder="0" />
                                                                    </div>
                                                                    
                                                                    {/* ÂñÆÂÉπ */}
                                                                    {canSeePrice() && (
                                                                        <div className="mb-3">
                                                                            <label className="form-label-lg">ÂñÆÂÉπ</label>
                                                                            <input type="text" inputMode="decimal" value={p.unitPrice} onFocus={e=>{if(parseFloat(e.target.value)===0)e.target.select()}} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value.replace(/[^\d.-]/g,''))} className="form-input-lg num-input" style={{height:'48px'}} placeholder="0" />
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* Ë®àÂÉπÊñπÂºè */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">Ë®àÂÉπÊñπÂºè</label>
                                                                        <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="form-input-lg" style={{height:'48px'}}>
                                                                            <option value="weight">Ë®àÈáç</option>
                                                                            <option value="quantity">Ë®à‰ª∂</option>
                                                                        </select>
                                                                    </div>
                                                                    
                                                                    {/* ÊâπËôü */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">ÊâπËôü</label>
                                                                        <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="form-input-lg" style={{height:'48px'}} placeholder="Ëº∏ÂÖ•ÊâπËôü" />
                                                                    </div>
                                                                    
                                                                    {/* ÊïàÊúü */}
                                                                    <div className="mb-3">
                                                                        <label className="form-label-lg">ÊïàÊúü</label>
                                                                        <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="form-input-lg" style={{height:'48px'}} />
                                                                    </div>
                                                                    
                                                                    {/* ÈáëÈ°ç */}
                                                                    {canSeePrice() && (
                                                                        <div className="bg-emerald-50 p-3 rounded-xl text-center">
                                                                            <div className="text-sm text-emerald-600 mb-1">Â∞èË®àÈáëÈ°ç</div>
                                                                            <div className="font-bold text-emerald-700 text-xl">${format2(safeNum(p.amount))}</div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                            {(canEditDomesticFull() || canManage()) && <button type="button" onClick={addProductRow} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold border-2 border-dashed border-blue-200">+ Êñ∞Â¢ûÁî¢ÂìÅ</button>}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* ÈôÑ‰ª∂ÂçÄÂ°ä */}
                                                <div className={`accordion-section ${openSections.includes('attachments') ? 'active' : ''}`}>
                                                    <div className="accordion-header" onClick={() => setOpenSections(prev => prev.includes('attachments') ? prev.filter(s=>s!=='attachments') : [...prev, 'attachments'])}>
                                                        <div><div className="accordion-title">ÈôÑ‰ª∂ ({formData.attachments?.length || 0})</div></div>
                                                        <span className="accordion-arrow">‚ñ∂</span>
                                                    </div>
                                                    <div className="accordion-content">
                                                        <div className="space-y-2">
                                                            {(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg"><a href={file.url} target="_blank" className="text-blue-600 underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}
                                                            {canUpload() && (<div className="relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-3 bg-white border border-dashed border-gray-300 rounded-lg text-gray-500 font-bold">{uploading ? '‰∏äÂÇ≥‰∏≠...' : 'üìé ÈÅ∏ÊìáÊ™îÊ°à'}</button></div>)}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Á∑®ËºØÊ®°ÂºèÊåâÈàï */}
                                                <div className="flex gap-3 pt-4">
                                                    <button type="button" onClick={()=>setView('list')} className="flex-1 py-4 bg-gray-100 text-gray-600 rounded-xl font-bold text-lg">ÂèñÊ∂à</button>
                                                    <button type="submit" disabled={isSubmitting} className="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg">{isSubmitting ? 'ÂÑ≤Â≠ò‰∏≠...' : 'ÂÑ≤Â≠ò'}</button>
                                                </div>
                                            </div>
                                            
                                            {/* ÈõªËÖ¶ÁâàÔºöÂÇ≥Áµ±ÂÖ®È°ØÁ§∫ */}
                                            <div className="hidden md:block space-y-4">
                                                <div className="bg-white rounded-xl p-3 border border-gray-200 shadow-sm">
                                                    <div className="grid grid-cols-4 gap-2">
                                                        <div><label>ÈÄ≤Âè£ÂÖ¨Âè∏</label><select name="importCompany" value={formData.importCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{IMPORT_COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label>Ê´ÉËôü</label><input name="containerNumber" value={formData.containerNumber} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2 font-mono uppercase" placeholder="Ê´ÉËôü" /></div>
                                                        <div><label>ËàπÂÖ¨Âè∏</label><input name="shippingCompany" value={formData.shippingCompany} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="ËàπÂÖ¨Âè∏" /></div>
                                                        <div><label>Âà∞Ê∏ØÊó•</label><input type="date" name="arrivalDate" value={formData.arrivalDate} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" /></div>
                                                        <div><label>Â†±ÈóúË°å</label><select name="customsBroker" value={formData.customsBroker} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2">{CUSTOMS_BROKERS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                                        <div><label>Â†±ÈóúÂñÆËôü</label><input name="customsDeclarationNo" value={formData.customsDeclarationNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="Â†±ÈóúÂñÆËôü" /></div>
                                                        <div><label>Ëº∏ÂÖ•Ë®±ÂèØË≠â</label><input name="importPermitNo" value={formData.importPermitNo} onChange={handleInputChange} disabled={!canEditQCFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="Ë®±ÂèØË≠âËôü" /></div>
                                                        <div><label>Âª†ÂïÜ</label><input name="supplier" value={formData.supplier} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="Âª†ÂïÜ" /></div>
                                                        <div><label>Âª†ÂïÜÂ∫èËôü</label><div className="flex gap-1"><input name="vendorSeqNo" value={formData.vendorSeqNo} onChange={handleInputChange} disabled={!canCreate()} className="flex-1 input-bg-style rounded-lg p-2 font-mono" placeholder="Â¶Ç 26-01" />{canCreate() && <button type="button" onClick={() => setFormData(p => ({...p, vendorSeqNo: generateVendorSeqNo(p.supplier, p.arrivalDate, editingId)}))} className="px-2 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold">Ëá™Âãï</button>}</div></div>
                                                        <div><label>Áî¢Âú∞</label><input list="origins3" name="origin" value={formData.origin} onChange={handleInputChange} disabled={!canCreate()} className="w-full input-bg-style rounded-lg p-2" placeholder="Áî¢Âú∞" /><datalist id="origins3">{DEFAULT_ORIGINS.map(o=><option key={o} value={o} />)}</datalist></div>
                                                        <div><label>ÊãÜÊ´ÉÂú∞</label><input name="devanningLocation" value={formData.devanningLocation} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" placeholder="Âú∞Èªû" /></div>
                                                        <div><label>ÊãÜÊ´ÉÊó•</label><input type="date" name="devanningDate" value={formData.devanningDate} onChange={handleInputChange} disabled={!canEditWarehouseFields()} className="w-full input-bg-style rounded-lg p-2" /></div>
                                                    </div>
                                                </div>
                                                {canSeePrice() && (
                                                    <div className="bg-blue-50 rounded-xl p-3 border border-blue-100 flex flex-wrap items-end gap-3">
                                                        <div className="flex-1 min-w-[140px]"><label>‰ªòÊ¨æÊ¢ù‰ª∂</label><input value={formData.paymentTerm} disabled className="w-full bg-white border rounded input-bg-style text-xs" /></div>
                                                        {canEditFlightFee() && isForeign(formData) && (<div className="w-24"><label>ÊóÖË≤ª</label><input type="number" name="flightFee" value={formData.flightFee} onWheel={e=>e.target.blur()} onChange={handleInputChange} className="w-full bg-white border rounded input-bg-style" placeholder="0" /></div>)}
                                                        <div className="flex items-center gap-3 pb-2 ml-auto">
                                                            <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="isPaid" checked={formData.isPaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-5 h-5 accent-green-600"/><span className="font-bold text-green-700 text-xs">Ë≤®Ê¨æÂ∑≤‰ªò</span></label>
                                                            {canEditFlightFee() && isForeign(formData) && <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="flightFeePaid" checked={formData.flightFeePaid} onChange={handleInputChange} disabled={!canEditForeignFinance()} className="w-5 h-5 accent-red-600"/><span className="font-bold text-red-700 text-xs">ÊóÖË≤ªÂ∑≤‰ªò</span></label>}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="pt-2">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h3 className={`font-bold text-lg ${validationErrors.products ? 'text-red-600' : 'text-gray-700'}`}>Áî¢ÂìÅÊòéÁ¥∞{validationErrors.products && <span className="text-red-500 text-xs ml-2">(Ë´ãËá≥Â∞ëÂ°´ÂØ´‰∏ÄÈ†ÖÂìÅÂêç)</span>}</h3>
                                                        {(canEditDomesticFull() || canManage()) && <button type="button" onClick={addProductRow} className="text-blue-600 font-bold text-sm hover:underline cursor-pointer">+ Êñ∞Â¢ûÁî¢ÂìÅ</button>}
                                                    </div>
                                                    <div className="space-y-3">{formData.products.map((p, idx) => (
                                                        <div key={p.id} className={`bg-white border rounded-xl p-3 shadow-sm ${validationErrors.products && idx === 0 ? 'border-red-300' : ''}`}>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                <div onClick={() => { if(products.length > 0) { setActiveProductPicker(idx); setProductPickerSearch(''); } }} className={`input-bg-style rounded p-1 font-bold cursor-pointer flex items-center justify-between ${products.length > 0 ? 'hover:bg-blue-50' : ''}`}><span className={p.name ? 'text-gray-800' : 'text-gray-400'}>{p.name || 'ÈªûÊìäÈÅ∏ÊìáÂìÅÂêç'}</span>{products.length > 0 && <span className="text-blue-500 text-xs">‚ñº</span>}</div>
                                                                <input value={p.spec} onChange={e=>handleProductChange(idx,'spec',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="Ë¶èÊ†º" />
                                                                <select value={p.pricingMode} onChange={e=>handleProductChange(idx,'pricingMode',e.target.value)} className="input-bg-style rounded p-1 text-sm"><option value="weight">Ë®àÈáç</option><option value="quantity">Ë®à‰ª∂</option></select>
                                                                <input type="number" value={p.quantity} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'quantity',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-blue-600" placeholder="‰ª∂Êï∏" />
                                                                <input type="number" value={p.weight} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'weight',e.target.value)} className="input-bg-style rounded p-1 text-right font-bold text-orange-500" placeholder="ÈáçÈáè" />
                                                                {canSeePrice() ? (<input type="number" value={p.unitPrice} onWheel={e=>e.target.blur()} onChange={e=>handleProductChange(idx,'unitPrice',e.target.value)} className="input-bg-style rounded p-1 text-right" placeholder="ÂñÆÂÉπ" />) : (<div className="input-bg-style rounded p-1 text-right flex items-center justify-end text-gray-300">***</div>)}
                                                                <input value={p.batchNumber} onChange={e=>handleProductChange(idx,'batchNumber',e.target.value)} className="input-bg-style rounded p-1 text-sm" placeholder="ÊâπËôü" />
                                                                <input type="date" value={p.expiryDate} onChange={e=>handleProductChange(idx,'expiryDate',e.target.value)} className="input-bg-style rounded p-1 text-xs" />
                                                                <div className="flex items-center justify-between bg-gray-50 rounded px-2 border border-gray-200">{canSeePrice() ? <span className="font-bold text-emerald-600 text-sm">${format2(safeNum(p.amount))}</span> : <span>***</span>}{(canEditDomesticFull() || canManage()) && (<div className="flex gap-1"><button type="button" onClick={()=>duplicateProductRow(idx)} className="text-gray-400 hover:text-blue-600 p-1"><I.Copy /></button>{formData.products.length > 1 && <button type="button" onClick={()=>removeProductRow(idx)} className="text-gray-400 hover:text-red-600 p-1"><I.Trash2 /></button>}</div>)}</div>
                                                            </div>
                                                        </div>
                                                    ))}</div>
                                                </div>
                                                <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                                    <label className="block text-xs font-bold text-gray-500 mb-2">ÈôÑ‰ª∂ ({formData.attachments?.length || 0})</label>
                                                    <div className="space-y-2">{(formData.attachments || []).map((file, idx) => (<div key={idx} className="flex items-center justify-between bg-white p-2 rounded border"><a href={file.url} target="_blank" className="text-blue-600 text-xs underline truncate flex-1 mr-2">{file.name}</a>{canUpload() && <button type="button" onClick={() => handleDeleteFile(idx)} className="text-red-500 p-1"><I.Trash2 /></button>}</div>))}</div>
                                                    {canUpload() && (<div className="mt-2 relative"><input type="file" multiple onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full py-2 bg-white border border-dashed border-gray-400 rounded text-gray-500 text-sm font-bold flex items-center justify-center gap-2">{uploading ? '‰∏äÂÇ≥‰∏≠...' : <><I.Paperclip /> ÈÅ∏ÊìáÊ™îÊ°à (ÂèØÂ§öÈÅ∏)</>}</button></div>)}
                                                </div>
                                                <div className="flex gap-3 pt-2"><button type="button" onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ÂèñÊ∂à</button><button type="submit" disabled={isSubmitting} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">{isSubmitting?'...':'ÂÑ≤Â≠ò'}</button></div>
                                            </div>
                                        </>
                                    )}
                                </form>
                            </div>
                        )}
                    </main>
                    {/* V79.3: Â§öÈÅ∏Ê®°ÂºèÂ∫ïÈÉ®Êìç‰ΩúÂàó */}
                    {selectMode && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-50 p-3 pb-safe">
                            <div className="flex items-center justify-between gap-3">
                                <div className="flex items-center gap-3">
                                    <button onClick={toggleSelectAll} className="px-3 py-2 bg-gray-100 rounded-lg text-sm font-bold text-gray-600">
                                        {selectedIds.size === filteredList.length ? 'ÂèñÊ∂àÂÖ®ÈÅ∏' : 'ÂÖ®ÈÅ∏'}
                                    </button>
                                    <span className="text-sm text-gray-500">Â∑≤ÈÅ∏ <span className="font-bold text-blue-600">{selectedIds.size}</span> ÂÄãË≤®Ê´É</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={cancelSelectMode} className="px-4 py-2 bg-gray-200 rounded-lg font-bold text-gray-600">ÂèñÊ∂à</button>
                                    <button onClick={executeExport} disabled={selectedIds.size === 0} className={`px-4 py-2 rounded-lg font-bold text-white ${selectedIds.size > 0 ? 'bg-blue-600' : 'bg-gray-300'}`}>
                                        ÂåØÂá∫ Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* ÂéüÂ∫ïÈÉ®Â∞éËà™ÔºàÂ§öÈÅ∏Ê®°ÂºèÊôÇÈö±ËóèÔºâ */}
                    {!selectMode && <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex z-40 pb-safe h-14"><button onClick={()=>setView('list')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='list'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.List /></div><span className="text-xs font-bold">ÂàóË°®</span></button>{userRole !== 'GUEST' && <><button onClick={()=>setView('products')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='products'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.Package /></div><span className="text-xs font-bold">Áî¢ÂìÅ</span></button><button onClick={()=>setView('stats')} className={`flex-1 flex flex-row items-center justify-center gap-2 ${view==='stats'?'text-blue-600':'text-gray-400'}`}><div className="w-6"><I.Chart /></div><span className="text-xs font-bold">Áµ±Ë®à</span></button></>}</div>}
                </div>
                </ErrorBoundary>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContainerApp />);
    </script>
</body>
</html>